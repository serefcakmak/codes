	<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Estetik Decor - Intranet</title>
    
    <!-- Handsontable CSS -->
	 <link href="https://unpkg.com/tabulator-tables@5.4.4/dist/css/tabulator.min.css" rel="stylesheet">
	
	<!-- Bootstrap CSS -->
	
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-select/1.13.18/css/bootstrap-select.min.css">

    <!-- Font Awesome -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css" rel="stylesheet">
    
    <!-- Diƒüer CSS -->
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500&display=swap" rel="stylesheet">
	<link rel="stylesheet" href="/css/style.css">
	<!--  jstree K√ºt√ºphanesi -->
	<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/jstree/3.3.12/themes/default/style.min.css" />
	
  
		
	</head>
	<body>
		<div id="initialImageContainer" style="display: flex; flex-direction: column; justify-content: center; align-items: center; height: calc(100vh - 50px); width: 100%;">
			<img src="/resim/EDLogo.jpg" alt="Logo" id="initialImage">
			<p style="margin-top: 15px; font-size: 14px; color: #727476;">¬© Copyright Kadir √áakmak 2025</p>
		</div>
		<div class="filter-container">
			<div class="form-group filter-dropdowns">
				<select id="basamak2" class="filter selectpicker" data-live-search="true">
					<option value="">BASAMAK2</option>
				</select>
				<select id="basamak4" class="filter selectpicker" data-live-search="true">
					<option value="">BASAMAK4</option>
				</select>
				<select id="anamodel" class="filter selectpicker" data-live-search="true">
					<option value="">ANAMODEL</option>
				</select>
				<select id="model" class="filter selectpicker" data-live-search="true">
					<option value="">MODEL</option>
				</select>
				<select id="ebat" class="filter selectpicker" data-live-search="true">
					<option value="">EBAT</option>
				</select>
				<select id="kod" class="filter selectpicker" data-live-search="true">
					<option value="">KOD</option>
				</select>
			</div>

					<!-- Yeni fiyat aralƒ±ƒüƒ± filtreleme alanƒ± -->
			<div class="price-filter">
				<label>
					Min Fiyat: <span id="minPriceLabel">0</span>
					<input type="range" id="minPrice" min="0" max="600000" step="1000" value="0">
				</label>
				<label>
					Max Fiyat: <span id="maxPriceLabel">600000</span>
					<input type="range" id="maxPrice" min="0" max="600000" step="1000" value="600000">
				</label>
			</div>
			<!-- Diƒüer filtrelerden ayƒ±rmak i√ßin √ßizgi 
			<hr style="border-top: 2px solid #ddd; margin: 10px 0;">-->
			<!-- Arama alanƒ± ekleniyor -->
				<input type="text" id="searchInput" placeholder="√úr√ºn Ara..." class="filter" style="margin-top: 5px; width: 100%;">
			<!-- Fotoƒüraf Filtreleri i√ßin Ba≈ülƒ±k -->
			<div class="filter-section">

				<span class="filter-title">üì∑ G√∂rsel Filtreleri</span>
				<label class="filter">
					<input type="checkbox" id="toggleNoImage"> Fotoƒüraflƒ±
				</label>
				<label>  </label>
				<label class="filter">
					<input type="checkbox" id="onlyNoImage"> Fotoƒürafsƒ±z
				</label>
			</div>
			
			
			<!-- Stok Filtreleri B√∂l√ºm√º -->
			<div class="filter-section">
				<span class="filter-title">üì¶ Stok Filtreleri</span>
				<label class="filter">
					<input type="checkbox" id="hideNoStockToggle"> Stoklular
				</label>

				<label class="filter">
					<input type="checkbox" id="showStockAbove5"> Stok >=5
				</label>

				<label class="filter">
					<input type="checkbox" id="showHmStock"> HM > 0
				</label>

				<label class="filter">
					<input type="checkbox" id="showHmZeroStock"> HM = 0
				</label>
			</div>
			<!-- Diƒüer filtrelerden ayƒ±rmak i√ßin √ßizgi -->
			<div class="collection-filter-container">
				<span class="filter-title">üîñ Koleksiyon</span>
				<div class="collection-checkboxes">
					<label class="custom-checkbox">
						<input type="checkbox" id="koleksiyon25">
						<span class="checkmark"></span>
						<span class="label-text">G√ºncel Koleksiyon ‚úÖ</span>
					</label>
					<label class="custom-checkbox">
						<input type="checkbox" id="excludeKoleksiyon25">
						<span class="checkmark"></span>
						<span class="label-text">G√ºncel Koleksiyon ‚ùå</span>
					</label>
				</div>
			</div>
			<!-- Diƒüer filtrelerden ayƒ±rmak i√ßin √ßizgi -->
			<div class="collection-filter-container">
				<span class="filter-title">üîñ Proje</span>
				<div class="collection-checkboxes">
					<label class="custom-checkbox">
						<input type="checkbox" id="kurumsalListeToggle">
						<span class="checkmark"></span>
						<span class="label-text">Proje ‚úÖ</span>
					</label>
					<label class="custom-checkbox">
						<input type="checkbox" id="excludekurumsalListeToggle">
						<span class="checkmark"></span>
						<span class="label-text">Proje ‚ùå</span>
					</label>
				</div>
			</div>
			<!-- Diƒüer filtrelerden ayƒ±rmak i√ßin √ßizgi -->
			<div class="collection-filter-container">
				<span class="filter-title">üîñ Koleksiyon & Proje</span>
				<div class="collection-checkboxes">
					<label class="custom-checkbox">
						<input type="checkbox" id="excludeListeToggle">
						<span class="checkmark"></span>
						<span class="label-text">Koleksiyon & Proje ‚ùå</span>
					</label>
				</div>
			</div>

			<div class="filter-section">
				<span class="filter-title">üìå Diƒüer Filtreler</span>
				<label class="filter">
					<input type="checkbox" id="indirimListeToggle"> ƒ∞ndirim
				</label>
			<label class="filter">
				<input type="checkbox" id="fuar2025Toggle"> Fuar 2025
			</label>
			<label>  </label>
			<label class="filter">
				<input type="checkbox" id="fkontrolToggle"> Fiyat Kontrol
			</label>
			</div>
			
			<div class="filter-buttons">
				<button id="applyFilters" class="filter">üõ†Ô∏è Filtrele</button>
				<button id="clearFilters" class="filter">‚ùå Temizle</button>
				<button id="exportExcelButton">üìä Excel'e Aktar</button>
			</div>
			
		</div>
		<div id="loadingMessage" style="display: none;">
			<div class="spinner-border text-light" role="status" style="width: 3rem; height: 3rem;">
				<span class="sr-only">Loading...</span>
			</div>
			<p id="loadingText">√úr√ºnler Y√ºkleniyor...</p>
		</div>
		<!-- **ƒ∞√ßerik Alanlarƒ± (Sekmeler ƒ∞√ßin Container)** -->
		<div class="tab-content">
			<!-- üè† Ana Sayfa - Mevcut √úr√ºn Listesi -->
			<div class="tab-pane fade show active" id="home">
				<div class="product-container" id="product-container">
					<!-- √úr√ºnler burada y√ºklenecek -->
				</div>
				<div id="concept-products-container" style="display: none;">
					<h3>Se√ßili Konseptin √úr√ºnleri</h3>
					<div class="product-grid">
						<!-- √úr√ºnler buraya y√ºklenecek -->
					</div>
				</div>

			</div>
			<!-- üîß Admin Paneli -->
			<div class="tab-pane fade" id="adminPanel">
				<div class="product-container" id="admin-product-container">
					<!-- √úr√ºnler burada y√ºklenecek -->
				</div>
			</div>
			<!-- üìä Raporlar -->
			<div class="tab-pane fade" id="reports">
				<h3 style="text-align: center; font-size: 22px; color: #333;">üìä Sipari≈ü ve Teklif Raporlarƒ±</h3>
				
				<table class="charts-table">
					<tr>
						<td>
							<h4>üìà G√ºnl√ºk Sƒ∞PARƒ∞≈ûLER </h4>
							<canvas id="dailyOrdersChart"></canvas>
						</td>
						<td>
							<h4>üìä G√ºnl√ºk TEKLƒ∞FLER </h4>
							<canvas id="dailyOffersChart"></canvas>
						</td>
					</tr>
				</table>

				<!-- üìå 3 S√ºtunlu Yapƒ± -->
				<table class="summary-container">
					<tr>
						
						<td class="summary-wrapper">
							<!-- üìå √ñzet Tablo -->
							<h4 class="summary-title">üìä Haftalƒ±k √ñzet Sipari≈ü/Teklif</h4>
							<table class="summary-table">
								<thead>
									<tr>
										<th>G√úN</th>
										<th>Sƒ∞PARƒ∞≈û (USD)</th>
										<th>TEKLƒ∞F (USD)</th>
									</tr>
								</thead>
								<tbody id="summaryTableBody">
									<!-- JavaScript ile doldurulacak -->
								</tbody>
								<tfoot>
									<tr>
										<th>Toplam</th>
										<th id="totalSiparis">0</th>
										<th id="totalTeklif">0</th>
									</tr>
								</tfoot>
							</table>
						</td>
						 <!-- Yeni Aylƒ±k √ñzet Tablosu -->
						<td class="summary-wrapper">
							<h4 class="summary-title">Aylƒ±k Sipari≈ü Performans √ñzeti</h4>
							<table class="summary-table" id="monthlySummaryTable">
							  <thead>
								<tr>
								  <th>AY</th>
								  <th>DEKOR</th>
								  <th>DERI</th>
								  <th>DIGER</th>
								  <th>TOPLAM</th>
								  <th>Deƒüi≈üim</th>
								</tr>
							  </thead>
							  <tbody id="monthlySummaryTableBody">
								<!-- JavaScript ile doldurulacak -->
							  </tbody>
        
							</table>
						</td>

					</tr>
				</table>
				<table class="summary-container">
					<tr>
					
					<td class="topsummary-wrapper">
						  <h3>Top 10 M√º≈üteri Performansƒ± - Sipari≈ü</h3>
						  <table id="top10CustomerPerformanceTable" class="montlysummary-table">
							<!-- <thead>
							  <tr>
								<th>Satƒ±≈ü Grubu</th>
								<th> M√º≈üteri Adƒ±</th>
								<th>√ñnceki Yƒ±l Toplam</th>
								<th>√ñnceki Yƒ±l Ortalama</th>
								<th>Bu Yƒ±l Toplam</th>
								<th>Bu Yƒ±l Ortalama</th>
								<th>Oran</th>
							  </tr>
							</thead>-->
							<tbody id="top10CustomerPerformanceTableBody">
							  <!-- Veriler JS ile buraya eklenecek -->
							</tbody>
						  </table>
						</td>
						
					</tr>
				</table>	
			</div>
			
		<div class="modal fade" id="imageModal" tabindex="-1" role="dialog" aria-labelledby="imageModalLabel" aria-hidden="true">
			<div class="modal-dialog modal-lg modal-dialog-centered" role="document">
				<div class="modal-content">
					<div class="modal-header">
						<h5 class="modal-title" id="imageModalLabel">B√ºy√ºk G√∂rsel</h5>
						
						<button type="button" class="close" data-dismiss="modal" aria-label="Close">
							<span aria-hidden="true">&times;</span>
						</button>
					</div>
					<div class="modal-body">
						<div id="modalCarousel" class="carousel slide" data-ride="carousel">
							<!-- Fotoƒüraf Sayƒ±sƒ±nƒ± G√∂steren Noktalar -->
							<ol class="carousel-indicators" id="modalCarouselIndicators">
								<!-- Dinamik olarak buraya eklenecek -->
							</ol>
							<div class="carousel-inner" id="modalCarouselInner">
								<!-- G√∂rseller buraya eklenecek -->
							</div>
							<a class="carousel-control-prev" href="#modalCarousel" role="button" data-slide="prev">
								<span class="carousel-control-prev-icon" aria-hidden="true"></span>
								<span class="sr-only">Previous</span>
							</a>
							<a class="carousel-control-next" href="#modalCarousel" role="button" data-slide="next">
								<span class="carousel-control-next-icon" aria-hidden="true"></span>
								<span class="sr-only">Next</span>
							</a>
						</div>
					</div>
				</div>
			</div>
		</div>
 
<!-- Stok Depo Durum Raporu -->
<div id="stockInventoryContainer" style="display:none; padding:15px; margin-left:15%">
<h4>Stok Depo Durum</h4>
  <div class="form-row">
    <div class="col-md-3">
      <label for="dateInput">Tarih</label>
      <input type="date" id="dateInput" class="form-control"/>
    </div>
    <div class="col-md-3">
      <label for="depoDropdown">Depo</label>
      <select id="depoDropdown" class="form-control"></select>
    </div>
    <div class="col-md-3 align-self-end">
      <button id="loadStockBtn" class="btn btn-primary">Getir</button>
	  <button id="exportStockBtn" class="btn btn-success ml-2">Excele Aktar</button>
    </div>
  </div>
  <hr>
</div>
<!-- **YENƒ∞**: Rapor bu alanda g√∂sterilecek -->
<div id="stockReportContainer" style="display:none;  padding:0 5px; margin-left: 15%; margin-right: 5%; font-size: 10px; height: 75vh; overflow-y: auto; ">
  <!-- loadStockInventoryReport() ile doldurulacak -->
</div>		
<!-- Kampanya -->
<!-- Kampanya Y√∂netim Paneli Sekmesi (Admin Paneli) -->
<div class="tab-pane fade" id="campaignPanel">
  <div class="container mt-4">
    <h3 class="mb-3">Kampanya Y√∂netimi</h3>
    <!-- Kampanya Olu≈üturma Formu -->
    <form id="campaignForm">
	  <!-- Gizli kampanya ID alanƒ±: Eƒüer dolu ise, d√ºzenleme yapƒ±lacak -->
	  <input type="hidden" id="campaignId" name="campaignId" value="">
	  <div class="form-row">
		<div class="form-group col-md-6">
		  <label for="campaignName">Kampanya Adƒ±</label>
		  <input type="text" class="form-control" id="campaignName" placeholder="Kampanya adƒ±nƒ± giriniz" required>
		</div>
		<div class="form-group col-md-3">
		  <label for="campaignType">Kampanya T√ºr√º</label>
		  <select class="form-control" id="campaignType" required>
			<!-- Varsayƒ±lan se√ßenek: bo≈ü ve disabled -->
			<option value="" disabled selected>Kampanya T√ºr√º Se√ßiniz</option>
			<option value="PRODUCT">√úr√ºn ƒ∞ndirimi</option>
			<!-- <option value="CART">Sepet ƒ∞ndirimi</option>
			<option value="BUY_X_GET_Y">X Al Y √ñde / Bedava</option>
			<option value="Nth_Product_Discount">X. √úr√ºne ƒ∞ndirim</option> -->
			<option value="CATEGORY_CART">Kategori Bazlƒ± ƒ∞ndirim</option>
		  </select>
		</div>
	  </div>
	  
	  <div class="form-group col-md-9">
		<label for="campaignDescription">A√ßƒ±klama</label>
		<textarea class="form-control" id="campaignDescription" rows="2" placeholder="Kampanyanƒ±n a√ßƒ±klamasƒ±nƒ± giriniz"></textarea>
	  </div>
	  
	  <div class="form-row">
		<div class="form-group col-md-3">
		  <label for="startDate">Ba≈ülangƒ±√ß Tarihi</label>
		  <input type="datetime-local" class="form-control" id="startDate" required>
		</div>
		<div class="form-group col-md-3">
		  <label for="endDate">Biti≈ü Tarihi</label>
		  <input type="datetime-local" class="form-control" id="endDate" required>
		</div>
		<div class="form-group col-md-3 align-self-end">
		  <div class="form-check">
			<input class="form-check-input" type="checkbox" id="includeSubCategories">
			<label class="form-check-label" for="includeSubCategories">
			  Alt Kategorileri Dahil Et
			</label>
		  </div>
		</div>
	  </div>
	  
	  <!-- ƒ∞ndirim Deƒüeri ve T√ºr√º -->
	  <div class="form-row">
		<div class="form-group col-md-2">
		  <label for="discountType">ƒ∞ndirim Tipi</label>
		  <select class="form-control" id="discountType">
			<option value="PERCENT">Y√ºzde (%)</option>
			<option value="FIXED">Sabit Tutar (TL)</option>
		  </select>
		</div>
		<div class="form-group col-md-4">
		  <label for="discountValue">ƒ∞ndirim Deƒüeri</label>
		  <input type="number" class="form-control" id="discountValue" step="any" placeholder="L√ºtfen bir sayƒ± giriniz (% i≈üareti kullanmayƒ±nƒ±z.)" required>
		</div>
	  </div>
	  
	  <!-- Diƒüer Kampanyalarla Birle≈ütirilebilirlik -->
	  <div class="form-group">
		<label>Diƒüer Kampanyalarla Birle≈ütirilebilir Mi?</label>
		<div class="form-check">
		  <input class="form-check-input" type="radio" name="isCombinable" id="combinableYes" value="true" checked>
		  <label class="form-check-label" for="combinableYes">Evet</label>
		</div>
		<div class="form-check">
		  <input class="form-check-input" type="radio" name="isCombinable" id="combinableNo" value="false">
		  <label class="form-check-label" for="combinableNo">Hayƒ±r</label>
		</div>
	  </div>
	  
	  <!-- Kampanya T√ºr√ºne G√∂re Se√ßim Alanlarƒ± -->
	  <!-- Kategori Se√ßimi Alanƒ±: Sadece Kategori Bazlƒ± ƒ∞ndirim i√ßin g√∂sterilecek -->
	  <div class="form-group" id="categorySelectionSection" style="display: none;">
		<label for="campaignCategories">Kategori Se√ßimi</label>
		<div id="campaignCategoriesTree"></div>
		<input type="hidden" id="selectedCategories" name="selectedCategories">
	  </div>
	  
	  <!-- √úr√ºn Bazƒ±nda Kampanya Alanƒ±: Sadece √úr√ºn ƒ∞ndirimi i√ßin g√∂sterilecek -->
	  <div id="productSelectionSection" style="display: none;">
		<div class="form-group">
		  <label for="discountedProducts">ƒ∞ndirimli √úr√ºn Se√ßimi</label>
		  <select id="discountedProducts" class="selectpicker" data-live-search="true" data-size="10">
			<option value="">√úr√ºn Se√ßiniz...</option>
		  </select>
		</div>
		<!-- "√úr√ºn√º Ekle" butonu -->
		<button type="button" id="addProductBtn" class="btn btn-secondary mb-3" onclick="addProductToCampaign()">√úr√ºn√º Ekle</button>
		<!-- Se√ßilen √úr√ºnler Listesi -->
		<div class="mt-3">
		  <h5>Se√ßilen √úr√ºnler</h5>
		  <table class="table table-bordered" id="selectedProductsTable">
			<thead>
			  <tr>
				<th>Fotoƒüraf</th>
				<th>KOD</th>
				<th>ADI</th>
				<th>EBAT</th>
				<th>MODEL</th>
				<th>ƒ∞≈ülem</th>
			  </tr>
			</thead>
			<tbody>
			  <!-- Se√ßilen √ºr√ºnler buraya eklenecek -->
			</tbody>
		  </table>
		</div>
	  </div>
	  
	  <button type="submit" class="btn btn-primary">Kampanyayƒ± Kaydet</button>
	</form>

    
    <hr>
    <!-- Mevcut Kampanyalarƒ±n Listelendiƒüi B√∂l√ºm -->
    <h4>Mevcut Kampanyalar</h4>
    <table class="table table-bordered" id="campaignsTable">
      <thead>
        <tr>
          <th>ID</th>
          <th>Ad</th>
          <th>T√ºr</th>
          <th>Ba≈ülangƒ±√ß Tarihi</th>
          <th>Biti≈ü Tarihi</th>
          <th>Alt Kategoriler</th>
          <th>ƒ∞≈ülemler</th>
        </tr>
      </thead>
      <tbody>
        <!-- Kampanya kayƒ±tlarƒ± JavaScript ile y√ºklenecek -->
      </tbody>
    </table>
  </div>

</div>

<!-- Kampanya D√ºzenleme Modalƒ± -->
<div class="modal fade" id="editCampaignModal" tabindex="-1" aria-labelledby="editCampaignModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="editCampaignModalLabel">Kampanya D√ºzenle</h5>
        <button type="button" class="close" data-dismiss="modal" aria-label="Kapat">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body">
        <form id="editCampaignForm">
          <!-- Gizli ID alanƒ± -->
          <input type="hidden" id="editCampaignId">
          <!-- Diƒüer form alanlarƒ±nƒ±, d√ºzenleme formunun kampanya formu ile benzer ≈üekilde ekleyin -->
          <div class="form-group">
            <label for="campaignNameEdit">Kampanya Adƒ±</label>
            <input type="text" class="form-control" id="campaignNameEdit" required>
          </div>
          <!-- √ñrnek: Kampanya T√ºr√º, A√ßƒ±klama, Tarihler, ƒ∞ndirim bilgileri... -->
          <!-- ... -->
          <button type="submit" class="btn btn-primary">G√ºncelle</button>
        </form>
      </div>
    </div>
  </div>
</div>

<!-- üìå Fiyat G√ºncelleme Onay Modali -->
<div class="modal fade" id="priceUpdateModal" tabindex="-1" aria-labelledby="priceUpdateModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="priceUpdateModalLabel">üìä Sepet Fiyat G√ºncellemesi</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Kapat">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <p><strong>‚ö†Ô∏è Yeni fiyatlar ile eski fiyatlar arasƒ±nda fark tespit edildi!</strong></p>
                <table class="table table-bordered">
                    <thead>
                        <tr>
                            <th>√úr√ºn ID</th>
                            <th>Eski Fiyat</th>
                            <th>Yeni Fiyat</th>
                            <th>Fark</th>
                        </tr>
                    </thead>
                    <tbody id="priceUpdateTableBody">
                        <!-- üìå JavaScript ile doldurulacak -->
                    </tbody>
                    <tfoot>
                        <tr>
                            <th colspan="3">Toplam Deƒüi≈üim:</th>
                            <th id="totalPriceDifference">0</th>
                        </tr>
                    </tfoot>
                </table>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">ƒ∞ptal</button>
                <button type="button" class="btn btn-primary" id="confirmPriceUpdate">Fiyatlarƒ± G√ºncelle</button>
            </div>
        </div>
    </div>
</div>
<!-- √ñneri Modalƒ± -->
<div class="modal fade" id="suggestionModal" tabindex="-1" role="dialog" aria-labelledby="suggestionModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg modal-dialog-centered modal-dialog-scrollable" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="suggestionModalLabel">√ñnerilen √úr√ºnler</h5>
        <button type="button" class="close" data-dismiss="modal" aria-label="Kapat">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body" id="suggestionModalBody">
        <!-- √ñneri listesi buraya y√ºklenecek -->
      </div>
    </div>
  </div>
</div>

<!-- Kar≈üƒ±la≈ütƒ±rma Modalƒ± -->
<div id="compareModal" class="modal fade" tabindex="-1" role="dialog">
    <div class="modal-dialog modal-lg" role="document">
        <div class="modal-content">
            <div class="modal-header d-flex justify-content-between align-items-center">
                <h5 class="modal-title">√úr√ºn Kar≈üƒ±la≈ütƒ±rma</h5>
                <div>
                    <button class="btn btn-danger btn-sm me-2" onclick="clearCompareList()">
                        <i class="fas fa-trash-alt"></i> T√ºm√ºn√º Kaldƒ±r
                    </button>
                    <button class="btn btn-secondary btn-sm" data-dismiss="modal">
                        <i class="fas fa-times"></i> Kapat
                    </button>
                </div>
            </div>
            <div class="modal-body">
                <div class="row" id="compareProductsContainer">
                    <!-- √úr√ºnler buraya gelecek -->
                </div>
            </div>
        </div>
    </div>
</div>


<!-- Kar≈üƒ±la≈ütƒ±rma Butonu (Footer) -->
<div id="compareFooter" style="display: none; position: fixed; bottom: 0; width: 100%; background: #333; color: white; padding: 10px; text-align: center;">
    <button class="btn btn-secondary" onclick="openCompareModal()">
        <i class="fas fa-exchange-alt"></i> √úr√ºnleri Kar≈üƒ±la≈ütƒ±r
    </button>
</div>

<!-- Konfig√ºrasyon Modalƒ± -->
<div class="modal fade" id="configureModal" tabindex="-1" aria-labelledby="configureModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="configureModalLabel">√úr√ºn √ñzelle≈ütirme</h5>
        <button type="button" class="close" data-dismiss="modal" aria-label="Kapat">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body">
        <form id="configForm">
          <!-- Hidden Field for Cart Item ID -->
          <input type="hidden" id="configCartItemId" />

          <!-- Reference Code (Read-Only) -->
          
			<div class="form-row">
				<div class="form-group col-md-2">
					<label for="referenceCodeInput" style="font-weight: bold;">Referans Kod</label>
					<input type="text" class="form-control" id="referenceCodeInput" placeholder="Referans kod" readonly />
			  </div>
			  <!-- Custom Code -->
			  <div class="form-group col-md-2">
				<label for="customCodeInput" style="font-weight: bold;">√ñzel Kod</label>
				<input type="text" class="form-control" id="customCodeInput" placeholder="√ñrneƒüin √∂zel kod girin" />
			  </div>

			  <!-- Custom Name -->
			  <div class="form-group col-md-6">
				<label for="customNameInput" style="font-weight: bold;">√úr√ºn Adƒ±</label>
				<input type="text" class="form-control" id="customNameInput" placeholder="Serbest yazƒ±labilir √ºr√ºn adƒ±" />
			  </div>
			</div>
          <div class="form-row">
            <!-- MODEL -->
            <div class="form-group col-md-2">
              <label for="modelSelect" style="font-weight: bold;">MODEL</label>
              <select id="modelSelect" class="form-control selectpicker" data-live-search="true">
                <option value="">Se√ßiniz</option>
                <!-- Model se√ßenekleri dinamik olarak doldurulacak -->
              </select>
            </div>
			<!-- EBAT -->
            <div class="form-group col-md-2">
              <label for="ebatSelect" style="font-weight: bold;">EBAT</label>
			  <select id="ebatSelect" class="form-control selectpicker" data-live-search="true">
                <option value="">Se√ßiniz</option>
                <!-- Ebat se√ßenekleri dinamik olarak doldurulacak -->
              </select>
            </div>

            <!-- RENK -->
            <div class="form-group col-md-2">
              <label for="renkSelect" style="font-weight: bold;">RENK</label>
			  <select id="renkSelect" class="form-control selectpicker" data-live-search="true">
                <option value="">Se√ßiniz</option>
                <!-- Renk se√ßenekleri dinamik olarak doldurulacak -->
              </select>
            </div>
            <!-- MATERYAL -->
            <div class="form-group col-md-2">
              <label for="materyalSelect" style="font-weight: bold;">MATERYAL</label>
			  <select id="materyalSelect" class="form-control selectpicker" data-live-search="true">            
                <option value="">Se√ßiniz</option>
                <!-- Materyal se√ßenekleri dinamik olarak doldurulacak -->
              </select>
            </div>
                   
            <!-- DESEN -->
            <div class="form-group col-md-2">
              <label for="desenSelect" style="font-weight: bold;">DESEN</label>
			  <select id="desenSelect" class="form-control selectpicker" data-live-search="true">
                <option value="">Se√ßiniz</option>
                <!-- Desen se√ßenekleri dinamik olarak doldurulacak -->
              </select>
            </div>

            <!-- LAMINE -->
            <div class="form-group col-md-2">
              <label for="lamineSelect" style="font-weight: bold;">LAMINE</label>
			  <select id="lamineSelect" class="form-control selectpicker" data-live-search="true">
                <option value="">Se√ßiniz</option>
                <!-- Lamine se√ßenekleri dinamik olarak doldurulacak -->
              </select>
            </div>
          </div>

          <div class="form-row">
            <!-- AKSESUAR1 -->
            <div class="form-group col-md-2">
              <label for="aksesuar1Select" style="font-weight: bold;">AKSESUAR 1</label>
			  <select id="aksesuar1Select" class="form-control selectpicker" data-live-search="true">
                <option value="">Se√ßiniz</option>
                <!-- Aksesuar1 se√ßenekleri dinamik olarak doldurulacak -->
              </select>
            </div>

            <!-- AKSESUAR2 -->
            <div class="form-group col-md-2">
              <label for="aksesuar2Select" style="font-weight: bold;">AKSESUAR 2</label>
			  <select id="aksesuar2Select" class="form-control selectpicker" data-live-search="true">
                <option value="">Se√ßiniz</option>
                <!-- Aksesuar2 se√ßenekleri dinamik olarak doldurulacak -->
              </select>
            </div>

            <!-- AKSESUAR3 -->
            <div class="form-group col-md-2">
              <label for="aksesuar3Select" style="font-weight: bold;">AKSESUAR 3</label>
			  <select id="aksesuar3Select" class="form-control selectpicker" data-live-search="true">
                <option value="">Se√ßiniz</option>
                <!-- Aksesuar3 se√ßenekleri dinamik olarak doldurulacak -->
              </select>
            </div>
			<!-- AYAK -->
            <div class="form-group col-md-2">
              <label for="aksesuar3Select"  style="font-weight: bold;">AYAK</label>
			  <select id="ayakSelect" class="form-control selectpicker" data-live-search="true">
                <option value="">Se√ßiniz</option>
                <!-- Aksesuar3 se√ßenekleri dinamik olarak doldurulacak -->
              </select>
            </div>
          </div>
        

          <!-- Diƒüer Alanlar (Gerekirse Ekleyebilirsiniz) -->
          <!-- √ñrneƒüin: AKSESUAR4, AKSESUAR5 vb. -->
        </form>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-dismiss="modal">Kapat</button>
        <button type="button" class="btn btn-primary" onclick="saveConfig()">Kaydet</button>
      </div>
    </div>
  </div>
</div>



	<!-- Sepet Olu≈üturma Modalƒ± -->
<div class="modal fade" id="cartFormModal" tabindex="-1" role="dialog" aria-labelledby="cartFormModalLabel" aria-hidden="true">
  <div class="modal-dialog" role="document">
    <div class="modal-content">
      <!-- Modal Ba≈ülƒ±ƒüƒ± -->
      <div class="modal-header">
        <h5 class="modal-title" id="cartFormModalLabel">Yeni Sepet Olu≈ütur</h5>
        <button type="button" class="close" onclick="closeCartFormModal()" aria-label="Kapat">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <!-- Modal ƒ∞√ßeriƒüi -->
      <div class="modal-body">
        <form id="cartForm">
          <!-- M√º≈üteri Tipi ve Satƒ±≈ü B√∂lgesi (aynƒ± satƒ±rda) -->
          <div class="form-row">
            <!-- M√º≈üteri Tipi -->
            <div class="form-group col-md-6">
              <label for="customerType">M√º≈üteri Tipi</label>
              <select id="customerType" class="form-control" onchange="updatePriceTypeOptions()">
                <option value="perakende">Perakende</option>
                <option value="kurumsal">Kurumsal</option>
                <option value="toptan">Toptan</option>
              </select>
            </div>
            <!-- Satƒ±≈ü B√∂lgesi -->
            <div class="form-group col-md-6">
              <label for="salesArea">Satƒ±≈ü B√∂lgesi</label>
              <select id="salesArea" class="form-control">
                <option value="yurtici">Yurti√ßi</option>
                <option value="yurtdisi">Yurtdƒ±≈üƒ±</option>
              </select>
            </div>
          </div>
          <!-- M√º≈üteri Adƒ± -->
          <div class="form-group">
            <label for="cartName">M√º≈üteri Adƒ±</label>
            <input type="text" id="cartName" class="form-control" placeholder="Sepet Adƒ±" required>
          </div>
          <!-- Fiyat Tipi ve KDV Dahil/Hari√ß aynƒ± satƒ±rda -->
          <div class="form-row">
            <!-- Fiyat Tipi -->
            <div class="form-group col-md-6">
              <label for="priceType">Fiyat Tipi</label>
              <select id="priceType" class="form-control">
                <!-- Varsayƒ±lan olarak Perakende/Kurumsal se√ßenekleri -->
                <option value="1">PRK TL</option>
                <option value="4">PRK USD</option>
                <option value="5">PRK EUR</option>
              </select>
            </div>
            <!-- KDV Dahil/Hari√ß -->
            <div class="form-group col-md-6">
              <label for="vatIncluded">KDV Dahil/Hari√ß</label>
              <select id="vatIncluded" class="form-control">
                <option value="1">Dahil</option>
                <option value="0">Hari√ß</option>
              </select>
            </div>
          </div>
          <!-- ƒ∞ndirim Oranƒ± -->
          <div class="form-group">
            <label for="discountRate">ƒ∞ndirim Oranƒ±</label>
            <input type="number" id="discountRate" class="form-control" placeholder="ƒ∞ndirim Oranƒ±" min="0" max="100" step="1">
          </div>
        </form>
      </div>
      <!-- Modal Alt Bilgi -->
      <div class="modal-footer">
        <button type="button" class="btn btn-primary" onclick="closeCartFormModal()">Kapat</button>
        <button type="button" class="btn btn-primary" onclick="createCart()">Sepet Olu≈ütur</button>
      </div>
    </div>
  </div>
</div>

<!-- Sepet Modalƒ± -->
<div class="modal fade" id="cartModal" tabindex="-1" role="dialog" aria-labelledby="cartModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg modal-dialog-scrollable" role="document">
    <div class="modal-content">
      <!-- Modal Ba≈ülƒ±ƒüƒ± -->
      <div class="modal-header">
        <h5 class="modal-title" id="cartModalLabel">Sepet ƒ∞√ßeriƒüi</h5>
        <button type="button" class="close" onclick="closeCartModal()" aria-label="Kapat">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>

      <!-- Modal ƒ∞√ßeriƒüi -->
      <div class="modal-body">
        <!-- Sepet Detaylarƒ± -->
        <div id="cartDetails" class="mb-3">
          <!-- 1. Satƒ±r: M√º≈üteri Adƒ± (Sol 50%) ve M√º≈üteri Tipi + Satƒ±≈ü B√∂lgesi (Saƒü 50%) -->
          <div class="row">
		

			<div class="col-md-2">
			  <strong>Cari Kodu:</strong>
			  <select id="ckartSelect" class="form-control" data-live-search="true">
				<option value="">Se√ßiniz</option>
			  </select>
			</div>

            <!-- M√º≈üteri Adƒ± -->
            <div class="col-md-2">
              <strong>M√º≈üteri Adƒ±:</strong> <span id="cartNameDisplay"></span>
            </div>
            <!-- M√º≈üteri Tipi ve Satƒ±≈ü B√∂lgesi -->
            <div class="col-md-8">
              <div class="row">
				<div class="col-md-2">
                  <strong>Konsept Alanƒ±:</strong> <span id="conceptarea"></span>
                </div>
                <div class="col-md-2">
                  <strong>M√º≈üteri Tipi:</strong> <span id="customerTypeDisplay"></span>
                </div>
                <div class="col-md-2">
                  <strong>Satƒ±≈ü B√∂lgesi:</strong> <span id="salesAreaDisplay"></span>
                </div>
				<div class="col-md-4">
                  <strong>√ñdeme ≈ûartlarƒ±:</strong> <span id="paymentTermsDisplay"></span>
                </div>
				<div class="col-md-2">
                  <strong>Termin S√ºresi:</strong> <span id="deliveryTimeDisplay"></span>
                </div>              
			  
            </div>
            </div>
          </div>
          <!-- 2. Satƒ±r: Fiyat Tipi, KDV Dahil/Hari√ß ve ƒ∞ndirim Oranƒ± -->
          <div class="row mt-2">
            <div class="col-md-2">
              <strong>Fiyat Tipi:</strong> <span id="priceTypeDisplay"></span>
            </div>
            <div class="col-md-2">
              <strong>KDV Dahil/Hari√ß:</strong> <span id="vatIncludedDisplay"></span>
            </div>
            <div class="col-md-1">
              <strong>ƒ∞ndirim Oranƒ±:</strong><br>
              <span id="discountRateDisplay"></span>
            </div>
			<div class="col-md-2">
				<strong>Banka:</strong> <span id="bankDisplay"></span>
			</div>
          </div>
          <!-- Konsept Banner Alanƒ± -->
          <div id="conceptBannerContainer" style="display: none; text-align: center;">
            <img id="conceptBannerImg" src="/resim/banner/default-banner.jpg" style="max-width: 100%; height: auto;">
            <div id="selectBannerButtonContainer"></div>
          </div>
        </div>

        <!-- Sepet √úr√ºnleri ƒ∞√ßeriƒüi -->
        <div id="modalCartContent">
          <!-- Sepet √ºr√ºnleri dinamik olarak buraya y√ºklenecek -->
          <p class="text-center text-muted">Sepetiniz bo≈ü.</p>
        </div>
		 
			  
		</div>

      <!-- Modal Alt Bilgi -->
      <div class="modal-footer d-flex justify-content-between">
	  <!-- Yeni eklenen Navlun ve Sigorta giri≈ü satƒ±rƒ± -->
	 
        <div>
          <button type="button" class="btn btn-secondary" onclick="$('#cartListModal').modal('show')">Sepetleri G√∂r√ºnt√ºle</button>
          <button type="button" class="btn btn-success" onclick="$('#cartFormModal').modal('show')">Sepet Olu≈ütur</button>
		  
        </div>
		<div>
		<button type="button" class="btn btn-danger" onclick="clearCart()">Sepeti Temizle</button>
        </div>
		<div>
          <button class="btn btn-warning" onclick="checkCartPriceChanges(activeCartId)">üîÑ Fiyatlarƒ± G√ºncelle</button>
        </div>
        <div>
          <button type="button" class="btn btn-primary" onclick="closeCartModal()">Kapat</button>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- üìå Detay Raporda A√ßƒ±lan KOD popup - Hangi Konseptlerde var -->
<div id="kodPopup" class="kod-popup"></div>

	<!-- üìå Banner Se√ßim Modalƒ± -->
<div class="modal fade" id="bannerSelectionModal" tabindex="-1" aria-labelledby="bannerSelectionModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Konsept Banner Se√ß</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Kapat">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <div id="bannerImagesContainer" class="d-flex flex-wrap justify-content-center">
                    <!-- Fotoƒüraflar buraya y√ºklenecek -->
                </div>
            </div>
        </div>
    </div>
</div>


	
	<!-- Sepetler Listesi Modal -->
	<div class="modal fade" id="cartListModal" tabindex="-1" role="dialog" aria-labelledby="cartListModalLabel" aria-hidden="true">
		<div class="modal-dialog modal-dialog-centered" style="max-width: 70%;" role="document">
			<div class="modal-content">
				<div class="modal-header">
					<h5 class="modal-title" id="cartListModalLabel">Sepetler</h5>
					<button type="button" class="close" onclick="closeCartListModal()" aria-label="Kapat">
						<span aria-hidden="true">&times;</span>
					</button>
				</div>
				<div class="modal-body" id="cartListModalBody">
					<!-- Sepetler burada listelenecek -->
				</div>
				<div class="modal-footer">
				  <!-- Yenileme butonu -->
				  <button class="btn btn-secondary" onclick="showCartList()">
					<i class="fas fa-sync-alt"></i> Yenile
				  </button>
				  <!-- Konsept sepetlerini g√∂ster/gizle butonu -->
				  <button class="btn btn-info" id="toggleConceptCartsBtn" onclick="toggleConceptCarts()">
					<i class="fas fa-eye"></i> Konseptleri G√∂ster
				  </button>
				  <button type="button" class="btn btn-success" onclick="$('#cartFormModal').modal('show')">
					Sepet Olu≈ütur
				  </button>
				  <button type="button" class="btn btn-primary" onclick="closeCartListModal()">
					Kapat
				  </button>
				</div>

				
			</div>
		</div>
		

	</div>
<!-- Excel Dosyasƒ± Se√ßimi ve G√ºncelleme Modalƒ± -->
	<div id="priceUpdateContainer" style="display: none; margin: 15px; border: 1px solid #ccc; padding: 15px; background: #f9f9f9;">
	  <h5>Fiyat G√ºncelleme</h5>
	  <div class="form-group">
		<label for="excelFileInput">Excel Dosyasƒ± Se√ßiniz:</label>
		<input type="file" id="excelFileInput" accept=".xlsx, .xls" class="form-control">
	  </div>
	  <button class="btn btn-primary" onclick="updatePrices()">Uygula</button>
	</div>

	
<!-- **NAVBAR** -->
<nav class="navbar navbar-expand-lg navbar-light bg-light">
    <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
        <span class="navbar-toggler-icon"></span>
    </button>
    <div class="collapse navbar-collapse" id="navbarNav">
        <!-- **Sol Men√º** -->
        <ul class="navbar-nav mr-auto">
            <li class="nav-item dropdown">
                <a class="nav-link dropdown-toggle" href="#" id="urunlerMenu" role="button" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                    √úr√ºnler
                </a>
                <ul class="dropdown-menu" aria-labelledby="urunlerMenu" id="urunlerDropdown"></ul>
            </li>
			<!-- Konseptler Men√ºs√º -->
            <li class="nav-item dropdown">
				<a class="nav-link dropdown-toggle" href="#" id="conceptsDropdownToggle" role="button" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
					Konseptler
				</a>
				<div class="dropdown-menu" id="conceptsDropdown" aria-labelledby="conceptsDropdownToggle">
					<!-- Konseptler buraya dinamik olarak eklenecek -->
				</div>
			
			<li class="nav-item dropdown">
			  <a class="nav-link dropdown-toggle" href="#" id="islevlerMenu" role="button" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
				ƒ∞≈ülevler
			  </a>
			  <div class="dropdown-menu" aria-labelledby="islevlerMenu">
			  <div class="dropdown-submenu">
				  <a class="dropdown-item dropdown-toggle" href="#">Stok</a>
				  <ul class="dropdown-menu">
					<li>
					  <a class="dropdown-item" href="#" id="stokKartiMenuItem" onclick="showStokKartiContainer()">Stok Kartƒ±</a>
					</li>
					<li>
						<a class="dropdown-item" href="#" id="stock-depo-status">Stok Depo Durum</a>
					  </li>
					<li>
					  <a class="dropdown-item" href="#" id="priceUpdateMenuItem" onclick="showPriceUpdateContainer()">Fiyat G√ºncelleme</a>
					</li>
				  </ul>
				  
				</div>
			  
				<!-- Etiket Alt Men√ºs√º -->
				<div class="dropdown-submenu">
				  <a class="dropdown-item dropdown-toggle" href="#">Etiket</a>
				  <ul class="dropdown-menu">
					<li>
					  <a class="dropdown-item" href="#" onclick="showBarcodeContainer()">Barkod Basƒ±mƒ±</a>
					</li>
					<li>
					  <a class="dropdown-item" href="#" onclick="showconceptLabelContainer()">Konsept Etiketi</a>
					</li>
				  </ul>
				  
				</div>
				 <!-- Yeni: Kampanya √ñƒüesi -->
					<div class="dropdown-submenu" id="campaignMenu">
					  <a class="dropdown-item" href="#" onclick="showCampaignPanel()">Kampanya Y√∂netim Paneli</a>
					</div>
			  </div>
			</li>


        </ul>
       

        <!-- **Ortalanmƒ±≈ü veya Admin'e G√∂re Yerle≈ütirilen Logo** -->
        <div id="logoContainer" class="navbar-center">
            <img src="/resim/EDLogo.png" alt="EDLOGO" class="navbar-logo">
        </div>

        <!-- **Admin Sekmeleri (Sadece Adminler G√∂r√ºr)** -->
        <ul class="nav nav-tabs custom-tabs admin-tabs" id="adminTabs" style="display: none;">
            <li class="nav-item">
                <a class="nav-link active" id="tab-home" data-toggle="tab" href="#home">
                    <i class="fas fa-home"></i> Ana Sayfa
                </a>
            </li>
            <li class="nav-item">
                <a class="nav-link" id="tab-admin" data-toggle="tab" href="#adminPanel">
                    <i class="fas fa-user-shield"></i> Admin Panel
                </a>
            </li>
            <li class="nav-item">
                <a class="nav-link" id="tab-reports" data-toggle="tab" href="#reports">
                    <i class="fas fa-chart-line"></i> Raporlar
                </a>
            </li>
        </ul>

        <!-- **Saƒü Taraf: Kullanƒ±cƒ± ve Sepet Butonlarƒ±** -->
        <ul class="navbar-nav ml-auto">
            <li class="nav-item" id="welcomeMessage" style="display: none; margin-right: 10px; margin-top: 3px; font-size: 14px; font-weight: bold; color: #727476;">
                Ho≈ü geldin, <span id="usernameDisplay"></span>
            </li>
            <li class="nav-item">
                <button class="btn nav-link" id="threeProdBtn" title="Satƒ±rda Daha Az √úr√ºn">
                    <i class="fas fa-th-large"></i>
                </button>
            </li>
            <li class="nav-item">
                <button class="btn nav-link active" id="fourProdBtn" title="Satƒ±rda Daha √áok √úr√ºn">
                    <i class="fas fa-th"></i>
                </button>
            </li>
            <li class="nav-item">
                <button id="authButton" class="btn btn-primary">
                    <i id="authIcon" class="fa fa-sign-in"></i>
                </button>
            </li>
            <li class="nav-item ml-2">
                <button class="btn nav-link" onclick="loadCart()">
                    <i class="fas fa-shopping-cart"></i>
                </button>
            </li>
        </ul>
    </div>
</nav>

<!-- Admin Paneli i√ßerisinde Stok Kartƒ± container'ƒ± -->
<div id="stokKartiContainer" style="display:none; padding:2px; max-width:87%; margin-left:2%; margin-top:2%">
  <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
    <h3 style="margin:0 0 0 10%;">Stok Kartƒ± Y√∂netimi</h3>
		<div style="display:flex; align-items:center; gap:10px;">
	   <button class="btn btn-secondary" id="refreshTable" style="height: 35px;"><i class="fas fa-sync-alt"></i>Yenile</button>
	   <!-- Yeni Export Butonu -->
       <button id="exportFilteredButton" onclick="exportFilteredDataToExcel()" class="btn btn-secondary" style="height: 35px;">
		  <i class="fas fa-file-excel"></i> Excele Aktar
		</button>
	</div>
  </div>
  <!-- Tabulator grid i√ßin container -->
  <div id="hotContainer"></div>
</div>


	<!-- Kullanƒ±cƒ± Giri≈üi Modal -->
	
	<div class="modal fade" id="loginModal" tabindex="-1" role="dialog" aria-labelledby="loginModalLabel" aria-hidden="true">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="loginModalLabel">Kullanƒ±cƒ± Giri≈üi</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Kapat"></button>
            </div>
            <div class="modal-body">
                <form id="loginForm">
                    <div class="form-group">
                        <label for="username">Kullanƒ±cƒ± Adƒ±</label>
                        <input type="text" id="username" class="form-control" placeholder="Kullanƒ±cƒ± Adƒ±" required>
                    </div>
                    <div class="form-group">
                        <label for="password">≈ûifre</label>
                        <input type="password" id="password" class="form-control" placeholder="≈ûifre" required>
                    </div>
                    <button type="submit" class="btn btn-primary btn-block">Giri≈ü Yap</button>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- Stok Kartƒ± Detayƒ± -->
<!-- Modal -->
<div class="modal fade" id="stockCardModal" tabindex="-1" role="dialog" aria-hidden="true">
  <div class="modal-dialog modal-lg" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">
          Stok Kartƒ± ‚Äî <span id="modalStockCode"></span>
        </h5>
        <button type="button" class="close" data-dismiss="modal">&times;</button>
      </div>
      <div class="modal-body">
        <div id="stockCardAccordion">
          <!-- Genel b√∂l√ºm√º -->
          <div class="card">
            <div class="card-header" id="headingGenel">
              <h5 class="mb-0">
                <button class="btn btn-link" data-toggle="collapse" data-target="#collapseGenel"
                        aria-expanded="true" aria-controls="collapseGenel">
                  Genel
                </button>
              </h5>
            </div>
            <div id="collapseGenel" class="collapse show" aria-labelledby="headingGenel"
                 data-parent="#stockCardAccordion">
              <div class="card-body">
                <form>
                  <div class="form-row">
                    <div class="form-group col-md-4">
                      <label>KOD</label>
                      <input type="text" class="form-control" id="stockCode" disabled>
                    </div>
                    <div class="form-group col-md-4">
                      <label>ADI</label>
                      <input type="text" class="form-control" id="stockName" disabled>
                    </div>
                    <div class="form-group col-md-4">
                      <label>GRUP</label>
                      <input type="text" class="form-control" id="stockGroup" disabled>
                    </div>
                    <div class="form-group col-md-4">
                      <label>Bƒ∞Rƒ∞M</label>
                      <select id="stockUnit" class="form-control">
                        <option>Adet</option>
                        <option>Ft2</option>
                        <option>Dsm2</option>
                        <option>M2</option>
                        <option>Metre Kg</option>
                        <option>Set</option>
                      </select>
                    </div>
                    <div class="form-group col-md-4">
                      <label>BARKOD</label>
                      <input type="text" class="form-control" id="stockBarcode" disabled>
                    </div>
                    <div class="form-group col-md-4">
                      <label>KDV</label>
                      <input type="text" class="form-control" id="stockKDV" disabled>
                    </div>
                  </div>
                </form>
              </div>
            </div>
          </div>
          <!-- Diƒüer kart b√∂l√ºmleri burada -->
        </div>
      </div>
    </div>
  </div>
</div>


<!-- 3d Modal yapƒ±nƒ±zda bir canvas ekleyin, √∂rneƒüin: -->
<div id="threeModal" class="modal fade" tabindex="-1" role="dialog">
  <div class="modal-dialog modal-lg modal-dialog-centered" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">3D Fotoƒüraf G√∂r√ºnt√ºleme</h5>
        <button type="button" class="close" data-dismiss="modal" aria-label="Kapat">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body">
        <canvas id="threeCanvas" style="width: 100%; height: 500px;"></canvas>
      </div>
    </div>
  </div>
</div>

<!-- Barkod Basƒ±mƒ± Konteynerƒ± -->
<div id="barcodeContainer" style="display:none; padding:15px;">
  <h4>Barkod Basƒ±mƒ±</h4>
  <div class="filter-container">
    <div class="form-group">
      <label for="barcodeBasamak2">Basamak 2:</label>
      <select id="barcodeBasamak2" class="form-control selectpicker" data-live-search="true">
        <!-- Dinamik doldurulacak -->
      </select>
    </div>
    <div class="form-group">
      <label for="barcodeBasamak4">Basamak 4:</label>
      <select id="barcodeBasamak4" class="form-control selectpicker" data-live-search="true">
        <!-- Basamak2 se√ßimine g√∂re doldurulacak -->
      </select>
    </div>
	<div class="form-group">
      <label for="barcodeKod">Kod</label>
      <select id="barcodeKod" class="form-control selectpicker" data-live-search="true">
        <!-- Basamak2 se√ßimine g√∂re doldurulacak -->
      </select>
    </div>
    <div class="form-group">
      <label>
        <input type="checkbox" id="filterStoklu"> Stoklu (HM > 0)
      </label>
    </div>
    <div class="form-group">
      <label>Fiyat G√∂sterimi:</label>
      <label>
        <input type="radio" name="priceOption" value="with" checked> Fiyatlƒ±
      </label>
      <label>
        <input type="radio" name="priceOption" value="without"> Fiyatsƒ±z
      </label>
    </div>
    <div class="form-group">
      <label>Etiket Tipi:</label>
      <label>
        <input type="radio" name="labelType" value="large" checked> B√ºy√ºk Etiket
      </label>
      <label>
        <input type="radio" name="labelType" value="small"> K√º√ß√ºk Etiket
      </label>
    </div class="form-group">
    <button class="btn btn-primary" onclick="loadBarcodeProducts()">Barkod Olu≈ütur</button>
	<!-- Yazdƒ±r butonu, √úr√ºnleri Getir butonunun hemen altƒ±nda -->
    
	<button style="margin-top: 5px" class="btn btn-success" onclick="printBarcodes()">Yazdƒ±r</button>
	
	<button style="margin-top: 5px" class="btn btn-danger" onclick="showfiltercontainer()">√áƒ±kƒ±≈ü</button>
	
  </div>
  <hr>
  <div id="barcodeLabelsContainer">
    <!-- Barkod etiketleri burada olu≈üturulacak -->
  </div>
  
</div>

<!-- Konsept Etiket Basƒ±mƒ± -->
<div id="conceptLabelContainer" style="display:none; padding:15px;">
  <h4>Barkod Basƒ±mƒ±</h4>
  <div class="filter-container">
    <!-- Mevcut filtre alanlarƒ± ve dropdown‚Äôlar -->
    <!-- ‚Ä¶ -->

    <!-- Yeni: Konsept T√ºr√º Se√ßimi -->
    <div class="form-group">
      <label for="conceptTypeFilter">√úr√ºn Tipi</label>
      <select id="conceptTypeFilter" class="form-control">
        <option value="ANA" selected>Ana √úr√ºnler</option>
        <option value="EK">Ek √úr√ºnler</option>
      </select>
    </div>

    <!-- Yeni: Konsept Etiketi dropdown -->
    <div class="form-group">
      <label for="conceptLabelDropdown">Konsept Etiketi Se√ßiniz</label>
      <select id="conceptLabelDropdown" class="form-control selectpicker" data-live-search="true">
        <option value="">Se√ßiniz</option>
        <!-- Burayƒ± API‚Äôden dolduruyorsunuz -->
      </select>
    </div>

    <!-- Yeni: Etiket Dili Se√ßimi -->
    <div class="form-group">
      <label>Etiket Dili:</label><br>
      <label class="custom-checkbox-inline">
        <input type="checkbox" id="turkceEtiket" checked> T√ºrk√ße
      </label>
      <label class="custom-checkbox-inline" style="margin-left:10px;">
        <input type="checkbox" id="ingilizceEtiket"> ƒ∞ngilizce
      </label>
    </div>

    <!-- Butonlar -->
    <button class="btn btn-primary" onclick="loadConceptLabelPrint()">Etiket Olu≈ütur</button>
    <button style="margin-top: 5px" class="btn btn-success" onclick="printConceptLabels()">Yazdƒ±r</button>
    <button style="margin-top: 5px" class="btn btn-danger" onclick="showfiltercontainer()">√áƒ±kƒ±≈ü</button>
  </div>
  <hr>
  <div id="conceptLabelsContainer">
    <!-- Barkod etiketleri burada olu≈üturulacak -->
  </div>
</div>



<!-- Ho≈ü Geldiniz Modal -->
<div class="modal fade" id="welcomeModal" tabindex="-1" role="dialog" aria-labelledby="welcomeModalLabel" aria-hidden="true">
    <div class="modal-dialog welcome-modal" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="welcomeModalLabel">Ho≈ü Geldiniz</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Kapat"></button>
            </div>
            <div class="modal-body text-center">
                <p>Giri≈ü ba≈üarƒ±lƒ±! Ho≈ü geldiniz.</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-primary" id="closeWelcomeModal">Tamam</button>
            </div>
        </div>
    </div>
</div>

<!-- jQuery -->
    <script src="https://code.jquery.com/jquery-3.6.0.js"></script>
	<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
    
	<!-- Popper.js -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.16.1/umd/popper.min.js"></script>
	
    <!-- Bootstrap JS -->
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>
	
	<!-- Select2 CSS -->
	<link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />

	<!-- Select2 JS -->
	<script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
  
    <!-- Diƒüer JS Dosyalarƒ± -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.17.0/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/exceljs@4.3.0/dist/exceljs.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.4.0/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>
	  <!-- Bootstrap Select JS -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-select/1.13.18/js/bootstrap-select.min.js"></script>
	<!-- üìä Chart.js K√ºt√ºphanesi -->
	<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
	<script src="https://cdn.jsdelivr.net/npm/jsbarcode@3.11.5/dist/JsBarcode.all.min.js"></script>
	
	  <!-- Tabulator JS -->
	 <script src="https://unpkg.com/tabulator-tables@5.4.4/dist/js/tabulator.min.js"></script>
	 <!-- jstree K√ºt√ºphanesi -->
	 <script src="https://cdnjs.cloudflare.com/ajax/libs/jstree/3.3.12/jstree.min.js"></script>
	
	<script>
		
		let currentPage = 1;
		const pageSize = 24; 
		let isFetching = false;
		let columns = 4; 
		let hasMoreProducts = true; 
		const loadedProductCodes = new Set();
		let abortController = new AbortController(); 
	    window.selectedCurrency = "TL"; // Varsayƒ±lan deƒüer
		
		const container = document.getElementById('product-container');
		const admincontainer = document.getElementById('admin-product-container');
		const basamak2Select = document.getElementById('basamak2');
		const basamak4Select = document.getElementById('basamak4');
		const anamodelSelect = document.getElementById('anamodel');
		const modelSelect = document.getElementById('model');
		const ebatSelect = document.getElementById('ebat');
		const kodSelect = document.getElementById('kod');
		const applyFiltersButton = document.getElementById('applyFilters');
		const clearFiltersButton = document.getElementById('clearFilters');
		const threeProdBtn = document.getElementById('threeProdBtn');
		const fourProdBtn = document.getElementById('fourProdBtn');

		const updateColumns = (colCount) => {
			columns = colCount;
			document.documentElement.style.setProperty('--column-count', colCount);
			document.querySelectorAll('.product').forEach(product => {
				product.style.flex = `1 1 calc(100% / ${columns} - 20px)`;
			});
			threeProdBtn.classList.toggle('active', columns === 3);
			fourProdBtn.classList.toggle('active', columns === 4);
		};

		// Para birimi formatlama
	const formatCurrency = (value, priceType) => {
		// Para birimi t√ºr√ºn√º belirleme
		let currency;
		switch (priceType) {
			case 1:
				currency = 'TRY'; // T√ºrk Lirasƒ±
				break;
			case 2:
				currency = 'TRY'; // T√ºrk Lirasƒ±
				break;
			case 3:
				currency = 'USD'; // Amerikan Dolarƒ±
				break;
			case 4:
				currency = 'USD'; // Amerikan Dolarƒ±
				break;
			case 5:
				currency = 'EUR'; // Euro
				break;
			case 6:
				currency = 'EUR'; // Euro
				break;
			default:
				currency = 'TRY'; // Varsayƒ±lan olarak T√ºrk Lirasƒ±
		}

		// Para birimini formatlama
		return new Intl.NumberFormat('tr-TR', {
			style: 'currency',
			currency: currency
		}).format(value);
	};

		// üìå **Varsayƒ±lan container belirle**
            let targetContainerId = "product-container"; // üåü Varsayƒ±lan olarak ana sayfaya y√ºkle
            const activeTab = document.querySelector(".nav-tabs .nav-link.active");
            if (activeTab) {
                const targetTab = activeTab.getAttribute("href").substring(1);
                if (targetTab === "adminPanel") {
                    targetContainerId = "admin-product-container";
                } else if (targetTab === "reports") {
                    targetContainerId = "report-product-container";
                }
            }
		const clearFilters = async () => {

			// üìå **Dropdownlarƒ± sƒ±fƒ±rla**
			basamak2Select.value = '';
			basamak4Select.value = '';
			anamodelSelect.value = '';
			modelSelect.value = '';
			ebatSelect.value = '';
			kodSelect.value = '';

			// üìå **Sayfa numarasƒ±nƒ± sƒ±fƒ±rla**
			currentPage = 1;

			// üìå **Bo≈ü filtre deƒüerleri ile y√ºkleme**
			await loadFilters({
				basamak2: '',
				basamak4: '',
				anamodel: '',
				model: '',
				ebat: ''
			});

			// üìå **Selectpicker'ƒ± g√ºncelle**
			$(".selectpicker").selectpicker("refresh");

		};

		
		
		//filtreleri doldurma fonksiyonu.
		
		const loadFilters = async (selectedValues = {}) => {
			const response = await fetch(`http://192.168.30.4:3000/filter-options`);
			if (!response.ok) {
				console.error("Filtre API hatasƒ±:", response.status, response.statusText);
				return;
			}

			const filters = await response.json();
			
			const allBasamak2Set = new Set();
			const allBasamak4Set = new Set();
			const allAnamodelSet = new Set();
			const allModelSet = new Set();
			const allEbatSet = new Set();
			const allKodSet = new Set();

			const basamak4FilteredSet = new Set();
			const anamodelFilteredSet = new Set();
			const modelFilteredSet = new Set();
			const ebatFilteredSet = new Set();
			const kodFilteredSet = new Set();

			filters.forEach(filter => {
				if (filter.BASAMAK2) allBasamak2Set.add(filter.BASAMAK2);
				if (filter.BASAMAK4) allBasamak4Set.add(filter.BASAMAK4);
				if (filter.ANAMODEL) allAnamodelSet.add(filter.ANAMODEL);
				if (filter.MODEL) allModelSet.add(filter.MODEL);
				if (filter.EBAT) allEbatSet.add(filter.EBAT);
				if (filter.KOD) allKodSet.add(filter.KOD);

				if (filter.BASAMAK2 === selectedValues.basamak2) {
					if (filter.BASAMAK4) basamak4FilteredSet.add(filter.BASAMAK4);
					if (filter.ANAMODEL) anamodelFilteredSet.add(filter.ANAMODEL);
					if (filter.MODEL) modelFilteredSet.add(filter.MODEL);
					if (filter.EBAT) ebatFilteredSet.add(filter.EBAT);
					if (filter.KOD) kodFilteredSet.add(filter.KOD);
				}
				if (filter.BASAMAK4 === selectedValues.basamak4) {
					if (filter.ANAMODEL) anamodelFilteredSet.add(filter.ANAMODEL);
					if (filter.MODEL) modelFilteredSet.add(filter.MODEL);
					if (filter.EBAT) ebatFilteredSet.add(filter.EBAT);
					if (filter.KOD) kodFilteredSet.add(filter.KOD);
				}

				// üîπ ANAMODEL se√ßildiƒüinde MODEL ve EBAT deƒüerlerini filtrele
				if (selectedValues.anamodel) {
					modelFilteredSet.clear(); // üîπ MODEL listesini sƒ±fƒ±rla
					ebatFilteredSet.clear();  // üîπ EBAT listesini sƒ±fƒ±rla
					kodFilteredSet.clear();  // üîπ KOD listesini sƒ±fƒ±rla

					filters.forEach(filter => {
						const anamodelTrimmed = filter.ANAMODEL ? filter.ANAMODEL.trim().toLowerCase() : "";
						const selectedAnamodelTrimmed = selectedValues.anamodel.trim().toLowerCase();

						if (anamodelTrimmed === selectedAnamodelTrimmed) {
							if (filter.MODEL) modelFilteredSet.add(filter.MODEL.trim());
							if (filter.EBAT) ebatFilteredSet.add(filter.EBAT.trim());
							if (filter.KOD) kodFilteredSet.add(filter.KOD.trim());
						}
					});

					// üîπ Eƒüer hi√ß MODEL veya EBAT bulunamadƒ±ysa tamamen temizle
					if (modelFilteredSet.size === 0) {
						modelFilteredSet.add("Model bulunamadƒ±");
					}
					if (ebatFilteredSet.size === 0) {
						ebatFilteredSet.add("Ebat bulunamadƒ±");
					}
					if (kodFilteredSet.size === 0) {
						kodFilteredSet.add("Kod bulunamadƒ±");
					}

				}


				// üîπ MODEL se√ßildiƒüinde EBAT deƒüerlerini filtrele
				if (selectedValues.model) {
					filters.forEach(filter => {
						if (filter.MODEL === selectedValues.model) {
							if (filter.EBAT) ebatFilteredSet.add(filter.EBAT);
							if (filter.KOD) kodFilteredSet.add(filter.KOD);
						}
					});
				}

			});

			updateDropdown(basamak2Select, Array.from(allBasamak2Set), selectedValues.basamak2, "BASAMAK2");
			updateDropdown(
				basamak4Select,
				selectedValues.basamak2 ? Array.from(basamak4FilteredSet) : Array.from(allBasamak4Set),
				selectedValues.basamak4,
				"BASAMAK4"
			);
			updateDropdown(
				anamodelSelect,
				selectedValues.basamak4 || selectedValues.basamak2
					? Array.from(anamodelFilteredSet)
					: Array.from(allAnamodelSet),
				selectedValues.anamodel,
				"ANAMODEL"
			);
			updateDropdown(
				modelSelect,
				selectedValues.anamodel || selectedValues.basamak4
					? Array.from(modelFilteredSet)
					: Array.from(allModelSet),
				selectedValues.model,
				"MODEL"
			);
			updateDropdown(
				ebatSelect,
				selectedValues.model ? Array.from(ebatFilteredSet) : Array.from(allEbatSet),
				selectedValues.ebat,
				"EBAT"
			);
			updateDropdown(
				kodSelect,
				selectedValues.ebat ? Array.from(kodFilteredSet) : Array.from(allKodSet),
				selectedValues.kod,
				"KOD"
			);


			// üìå **T√ºm Selectpicker Elemanlarƒ±nƒ± Yenile**
			$(".selectpicker").selectpicker("refresh");
		};



		// Dropdown g√ºncelleme fonksiyonu
		const updateDropdown = (dropdown, items, selectedValue, placeholder) => {
			dropdown.innerHTML = `<option value="">${placeholder}</option>`;

			// üìå **Alfabetik sƒ±ralama**
			const sortedItems = items.sort((a, b) => a.localeCompare(b, 'tr', { sensitivity: 'base' }));

			sortedItems.forEach(item => {
				const option = document.createElement('option');
				option.value = item;
				option.textContent = item;
				if (item === selectedValue) {
					option.selected = true;
				}
				dropdown.appendChild(option);
			});

			// üìå **Selectpicker'ƒ± G√ºncelle**
			$(dropdown).selectpicker("refresh");
			
		};
		// Her dropdown deƒüi≈üikliƒüinde filtreleri yeniden y√ºkle
		const selectElements = [
			{ element: basamak2Select, key: 'basamak2' },
			{ element: basamak4Select, key: 'basamak4' },
			{ element: anamodelSelect, key: 'anamodel' },
			{ element: modelSelect, key: 'model' },
			{ element: ebatSelect, key: 'ebat' },
			{ element: kodSelect, key: 'kod' }
		];

		const handleFilterChange = () => {
			const selectedValues = {
				basamak2: basamak2Select.value,
				basamak4: basamak4Select.value,
				anamodel: anamodelSelect.value,
				model: modelSelect.value,
				ebat: ebatSelect.value,
				kod: kodSelect.value
			};

			loadFilters(selectedValues);

			// üîπ **ANAMODEL deƒüi≈üirse MODEL dropdown'unu sƒ±fƒ±rla ve yeniden y√ºkle**
		if (event.target.id === "anamodelSelect") {
			updateDropdown(modelSelect, [], "", "MODEL");
			loadFilters(selectedValues);
		}

		// üîπ **MODEL deƒüi≈üirse EBAT dropdown'unu sƒ±fƒ±rla ve yeniden y√ºkle**
		if (event.target.id === "modelSelect") {
			updateDropdown(ebatSelect, [], "", "EBAT");
			updateDropdown(kodSelect, [], "", "KOD");
			loadFilters(selectedValues);
		}
		};


		// T√ºm dropdown'lara olay dinleyicileri ekle
		selectElements.forEach(({ element }) => {
			element.addEventListener('change', handleFilterChange);
		});

		// Sayfa y√ºklendiƒüinde t√ºm filtreleri y√ºkle
		document.addEventListener('DOMContentLoaded', () => {
			loadFilters();
			//Sayfa Yenilendiƒüinde Kullanƒ±cƒ± Adƒ±nƒ± G√∂ster
			const username = localStorage.getItem('username');
			const isCampaignAdmin = localStorage.getItem('isCampaignAdmin');
	        document.getElementById('usernameDisplay').textContent = localStorage.getItem('username');
			document.getElementById('welcomeMessage').style.display = 'inline';
			// Oturum a√ßma sonrasƒ±, backend'den alƒ±nan kullanƒ±cƒ± bilgisine g√∂re:
			

		});

		
		$(document).ready(function () {
            // T√ºm dropdown'larƒ± selectpicker ile ba≈ülat
            $('.selectpicker').selectpicker();

            
        });


	// M√º≈üteri Tipine g√∂re Fiyat Tipi se√ßeneklerini g√ºncelleyen fonksiyon
	function updatePriceTypeOptions() {
	  var customerType = document.getElementById('customerType').value;
	  var priceTypeSelect = document.getElementById('priceType');
	  var vatSelect = document.getElementById('vatIncluded');

	  // Fiyat Tipi se√ßeneklerini g√ºncelle
	  priceTypeSelect.innerHTML = '';
	  if (customerType === 'toptan') {
		priceTypeSelect.add(new Option('TOP TL', '2'));
		priceTypeSelect.add(new Option('TOP USD', '3'));
		priceTypeSelect.add(new Option('TOP EUR', '6'));
	  } else {
		priceTypeSelect.add(new Option('PRK TL', '1'));
		priceTypeSelect.add(new Option('PRK USD', '4'));
		priceTypeSelect.add(new Option('PRK EUR', '5'));
	  }

	  // KDV Dahil/Hari√ß alanƒ±nƒ± m√º≈üteri tipine g√∂re g√ºncelle
	  if (customerType === 'perakende') {
		// Perakende: her zaman Dahil, deƒüi≈ütirilemez
		vatSelect.innerHTML = '';
		vatSelect.add(new Option('Dahil', '1'));
		vatSelect.value = '1';
		vatSelect.disabled = true;
	  } else if (customerType === 'toptan') {
		// Toptan: her zaman Hari√ß, deƒüi≈ütirilemez
		vatSelect.innerHTML = '';
		vatSelect.add(new Option('Hari√ß', '0'));
		vatSelect.value = '0';
		vatSelect.disabled = true;
	  } else {
		// Kurumsal: Kullanƒ±cƒ± deƒüi≈ütirebilir
		vatSelect.innerHTML = '';
		vatSelect.add(new Option('Dahil', '1'));
		vatSelect.add(new Option('Hari√ß', '0'));
		vatSelect.disabled = false;
		// Varsayƒ±lan deƒüeri istediƒüiniz ≈üekilde ayarlayabilirsiniz (√∂rneƒüin 'Dahil')
		vatSelect.value = '1';
	  }
	}





// üìå **Global filterProducts Fonksiyonu**
function filterProducts() {
    const excludeListeCheckbox = document.getElementById("excludeListeToggle");
	const excludekurumsalCheckbox = document.getElementById("excludekurumsalListeToggle");
	const kurumsalCheckbox = document.getElementById("kurumsalListeToggle");
    const indirimCheckbox = document.getElementById("indirimListeToggle");
    const hideStockCheckbox = document.getElementById("hideNoStockToggle");
    const showStockAbove5Checkbox = document.getElementById("showStockAbove5");
    const showHmStockCheckbox = document.getElementById("showHmStock");
    const showHmZeroStockCheckbox = document.getElementById("showHmZeroStock");
    const koleksiyon25Checkbox = document.getElementById("koleksiyon25");
    const excludeKoleksiyon25Checkbox = document.getElementById("excludeKoleksiyon25");
    const toggleNoImageCheckbox = document.getElementById("toggleNoImage");
    const onlyNoImageCheckbox = document.getElementById("onlyNoImage");
    const fuar25Checkbox = document.getElementById("fuar2025Toggle");
    const fkontrolCheckbox = document.getElementById("fkontrolToggle");

    // **Fiyat Aralƒ±ƒüƒ±nƒ± Al**
    const minPrice = parseFloat(document.getElementById("minPrice").value) || 0;
    const maxPrice = parseFloat(document.getElementById("maxPrice").value) || Infinity;

    // **Se√ßili Filtreleri Al**
    const showexcludeliste = excludeListeCheckbox.checked;
	const showexcludeKurumsal = excludekurumsalCheckbox.checked;
	const showKurumsal = kurumsalCheckbox.checked;
    const showIndirim = indirimCheckbox.checked;
    const hideNoStock = hideStockCheckbox.checked;
    const showStockAbove5 = showStockAbove5Checkbox.checked;
    const showHmStock = showHmStockCheckbox.checked;
    const showHmZeroStock = showHmZeroStockCheckbox.checked;
    const showKoleksiyon25 = koleksiyon25Checkbox.checked;
    const excludeKoleksiyon25 = excludeKoleksiyon25Checkbox.checked;
    const hideNoImage = toggleNoImageCheckbox.checked;
    const showOnlyNoImage = onlyNoImageCheckbox.checked;
    const showFuar2025 = fuar25Checkbox.checked;
    const showFkontrol = fkontrolCheckbox.checked;

    // **Arama giri≈üini al ve ayrƒ±≈ütƒ±r**
    const rawInput = document.getElementById("searchInput").value.trim();
    const { operator, terms } = parseSearchInput(rawInput); // Arama mantƒ±ƒüƒ±nƒ± √ß√∂z√ºmle

    document.querySelectorAll(".product").forEach(productDiv => {
        const isKurumsal = productDiv.getAttribute("data-kurumsal") === "1";
        const isIndirim = productDiv.getAttribute("data-indirim") === "1";
        const stock = parseInt(productDiv.getAttribute("data-stock") || "0");
        const hmStock = parseInt(productDiv.getAttribute("data-hm-stock") || "0");
        const isKoleksiyon25 = productDiv.getAttribute("data-koleksiyon25") === "1";
        const isFuar2025 = productDiv.getAttribute("data-fuar25") === "1";
        const isFkontrol = productDiv.getAttribute("data-fkontrol") === "1";
        const productPrice = parseFloat(productDiv.getAttribute("data-price") || "0");

        // **Fotoƒüraf kontrol√º**
        const image = productDiv.querySelector("img");
        const imageUrl = image ? image.getAttribute("src") : "";
        const isNoImage = imageUrl.includes('/resim/YOK.jpg');

        // **√úr√ºn√ºn metinsel bilgilerini al (Arama ƒ∞√ßin)**
        const productCategory = (productDiv.querySelector('tr:nth-child(1) td:nth-child(2)')?.textContent || '').toLowerCase();
        const productSubCategory = (productDiv.querySelector('tr:nth-child(2) td:nth-child(2)')?.textContent || '').toLowerCase();
        const productCode = (productDiv.querySelector('tr:nth-child(3) td:nth-child(2)')?.textContent || '').toLowerCase();
        const productModel = (productDiv.querySelector('tr:nth-child(4) td:nth-child(2)')?.textContent || '').toLowerCase();
        const productEbat = (productDiv.querySelector('tr:nth-child(5) td:nth-child(2)')?.textContent || '').toLowerCase();
        const productColor = (productDiv.querySelector('tr:nth-child(6) td:nth-child(2)')?.textContent || '').toLowerCase();
        const productDesenLamine = (productDiv.querySelector('tr:nth-child(7) td:nth-child(2)')?.textContent || '').toLowerCase();
        const productMateryal = (productDiv.querySelector('tr:nth-child(8) td:nth-child(2)')?.textContent || '').toLowerCase();
        const productAyak = (productDiv.querySelector('tr:nth-child(9) td:nth-child(2)')?.textContent || '').toLowerCase();

        // **Filtreleme mantƒ±ƒüƒ±**
        let shouldShow = true;
		// üîπ Eƒüer hiddenGroups bo≈üsa, grup kontrol√º yapƒ±lmasƒ±n


        // **Fotoƒüraf Filtreleri**
        if (showOnlyNoImage) {
            shouldShow = isNoImage; // Sadece fotoƒürafsƒ±z √ºr√ºnleri g√∂ster
        } else if (hideNoImage) {
            shouldShow = !isNoImage; // Fotoƒürafsƒ±zlarƒ± gizle
        }

        // **ƒ∞ndirim Liste Filtresi**
        if (showIndirim && !isIndirim) shouldShow = false;

        // **Stok Filtreleri**
        if (hideNoStock && stock <= 0) shouldShow = false;
        if (showStockAbove5 && stock < 5) shouldShow = false;
        if (showHmStock && hmStock <= 0) shouldShow = false;
        if (showHmZeroStock && hmStock > 0) shouldShow = false;

        // **Koleksiyon Filtreleri**
        if (showKoleksiyon25 && !isKoleksiyon25) shouldShow = false;
        if (excludeKoleksiyon25 && isKoleksiyon25) shouldShow = false;
		
		// **Proje Liste Filtresi**
        if (showKurumsal && !isKurumsal) shouldShow = false;
		if (showexcludeKurumsal && isKurumsal) shouldShow = false;
		
		// **G√ºncel Koleksiyon ve Projede Olmayan Liste Filtresi**
        if (showexcludeliste && (isKurumsal || isKoleksiyon25)) shouldShow = false;
		
        // **Fuar 2025 Filtre**
        if (showFuar2025 && !isFuar2025) shouldShow = false;

        // **Fiyat Kontrol Filtre**
        if (showFkontrol && !isFkontrol) shouldShow = false;

        // **Fiyat Filtresi**
        if (productPrice < minPrice || productPrice > maxPrice) shouldShow = false;

        // **Arama Filtresi (Eƒüer giri≈ü yapƒ±lmƒ±≈üsa)**
        if (rawInput) {
            const fields = [
                productCategory, productSubCategory, productCode, productModel,
                productEbat, productColor, productDesenLamine, productMateryal, productAyak
            ];
            shouldShow = checkProductMatches({ operator, terms, fields }) && shouldShow;
        }
		 // üìå **√úr√ºn gizli bir gruba ait mi? Kontrol edelim**
        if (productDiv.getAttribute("data-hidden-group") === "true") {
            shouldShow = false; // Ne olursa olsun, gizlenmi≈ü gruptaki √ºr√ºnler g√∂r√ºnmeyecek.
        }

        // **Sonu√ß olarak √ºr√ºn√º g√∂ster/gizle**
        productDiv.style.display = shouldShow ? "inline-block" : "none";
    });

    // **Bo≈ü grup ba≈ülƒ±klarƒ±nƒ± kontrol et**
    hideEmptyGroupTitles();

    // **Satƒ±rdaki eksik √ºr√ºnleri placeholder ile tamamla**
    removeAllPlaceholders();
    fixRowsWithPlaceholders();
}

//Fiyat Sliderlarƒ±
document.addEventListener("DOMContentLoaded", function () {
    const minPrice = document.getElementById("minPrice");
    const maxPrice = document.getElementById("maxPrice");

    function updateSliderBackground(slider) {
        const value = ((slider.value - slider.min) / (slider.max - slider.min)) * 100;
        slider.style.background = `linear-gradient(to right, #747576 ${value}%, #ffffff ${value}%)`;
    }

    // Ba≈ülangƒ±√ßta g√ºncelle
    updateSliderBackground(minPrice);
    updateSliderBackground(maxPrice);

    // Kullanƒ±cƒ± kaydƒ±rdƒ±ƒüƒ±nda g√ºncelle
    minPrice.addEventListener("input", function () {
        updateSliderBackground(this);
    });

    maxPrice.addEventListener("input", function () {
        updateSliderBackground(this);
    });
});


// üìå **DOMContentLoaded ƒ∞√ßinde Event Listener'larƒ± Tanƒ±mla**
document.addEventListener("DOMContentLoaded", function () {
    const filterCheckboxes = [
        document.getElementById("excludeListeToggle"),
		document.getElementById("excludekurumsalListeToggle"),
		document.getElementById("kurumsalListeToggle"),
        document.getElementById("indirimListeToggle"),
        document.getElementById("hideNoStockToggle"),
        document.getElementById("showStockAbove5"),
        document.getElementById("showHmStock"),
        document.getElementById("showHmZeroStock"),
        document.getElementById("koleksiyon25"),
        document.getElementById("excludeKoleksiyon25"),
        document.getElementById("toggleNoImage"),
        document.getElementById("onlyNoImage"),
		document.getElementById("fkontrolToggle"),
		document.getElementById("fuar2025Toggle"),
		
    ];

    // **Filtre Deƒüi≈ütik√ße filterProducts'ƒ± √áalƒ±≈ütƒ±r**
    filterCheckboxes.forEach(checkbox => {
        if (checkbox) checkbox.addEventListener("change", filterProducts);
    });
	// üìå **√áakƒ±≈üan Filtre Se√ßeneklerini Engelle**
    document.getElementById("toggleNoImage").addEventListener("change", function () {
        if (this.checked) {
            document.getElementById("onlyNoImage").checked = false; // Fotoƒürafsƒ±zlarƒ± g√∂ster se√ßeneƒüini kaldƒ±r
        }
        filterProducts(); // ‚úÖ Deƒüi≈üiklik sonrasƒ± filtreleri uygula
    });

    document.getElementById("onlyNoImage").addEventListener("change", function () {
        if (this.checked) {
            document.getElementById("toggleNoImage").checked = false; // Fotoƒüraflƒ± se√ßeneƒüini kaldƒ±r
        }
        filterProducts(); // ‚úÖ Deƒüi≈üiklik sonrasƒ± filtreleri uygula
    });

    document.getElementById("koleksiyon25").addEventListener("change", function () {
        if (this.checked) {
            document.getElementById("excludeKoleksiyon25").checked = false; // 25 Se√ßilmeyenler se√ßeneƒüini kaldƒ±r
        }
        filterProducts(); // ‚úÖ Deƒüi≈üiklik sonrasƒ± filtreleri uygula
    });

    document.getElementById("excludeKoleksiyon25").addEventListener("change", function () {
        if (this.checked) {
            document.getElementById("koleksiyon25").checked = false; // Koleksiyon 25 se√ßeneƒüini kaldƒ±r
        }
        filterProducts(); // ‚úÖ Deƒüi≈üiklik sonrasƒ± filtreleri uygula
    });
	document.getElementById("kurumsalListeToggle").addEventListener("change", function () {
        if (this.checked) {
            document.getElementById("excludekurumsalListeToggle").checked = false; // Kurumsal Se√ßilmeyenler se√ßeneƒüini kaldƒ±r
        }
        filterProducts(); // ‚úÖ Deƒüi≈üiklik sonrasƒ± filtreleri uygula
    });

    document.getElementById("excludekurumsalListeToggle").addEventListener("change", function () {
        if (this.checked) {
            document.getElementById("kurumsalListeToggle").checked = false; // Kurumsal se√ßeneƒüini kaldƒ±r
        }
        filterProducts(); // ‚úÖ Deƒüi≈üiklik sonrasƒ± filtreleri uygula
    });
	
	document.getElementById("excludeListeToggle").addEventListener("change", function () {
        if (this.checked) {
			document.getElementById("koleksiyon25").checked = false; // Koleksiyon 25 se√ßeneƒüini kaldƒ±r
            document.getElementById("kurumsalListeToggle").checked = false; // Kurumsal se√ßeneƒüini kaldƒ±r
			
        }
        filterProducts(); // ‚úÖ Deƒüi≈üiklik sonrasƒ± filtreleri uygula
    });
	// **Fiyat Slider'larƒ± Deƒüi≈ütik√ße filterProducts'ƒ± √áalƒ±≈ütƒ±r**
    const minPriceSlider = document.getElementById("minPrice");
    const maxPriceSlider = document.getElementById("maxPrice");
	
	const minPriceLabel = document.getElementById('minPriceLabel');
	const maxPriceLabel = document.getElementById('maxPriceLabel');

	// Min slider i√ßin olay dinleyici
	minPriceSlider.addEventListener('input', () => {
		minPriceLabel.textContent = minPriceSlider.value;
		if (parseInt(minPriceSlider.value) > parseInt(maxPriceSlider.value)) {
			maxPriceSlider.value = minPriceSlider.value;
			maxPriceLabel.textContent = maxPriceSlider.value;
		}
	});

	// Max slider i√ßin olay dinleyici
	maxPriceSlider.addEventListener('input', () => {
		maxPriceLabel.textContent = maxPriceSlider.value;
		if (parseInt(maxPriceSlider.value) < parseInt(minPriceSlider.value)) {
			minPriceSlider.value = maxPriceSlider.value;
			minPriceLabel.textContent = minPriceSlider.value;
		}
	});
	

    if (minPriceSlider && maxPriceSlider) {
        minPriceSlider.addEventListener("input", filterProducts);
        maxPriceSlider.addEventListener("input", filterProducts);
    }

    // **Arama Kutusu ƒ∞√ßin filterProducts √áalƒ±≈ütƒ±r**
    const searchInput = document.getElementById("searchInput");
    if (searchInput) {
        searchInput.addEventListener("input", filterProducts);
    }
});




function fixRowsWithPlaceholders() {
    const columns = 4; // Satƒ±r ba≈üƒ±na ka√ß √ºr√ºn olmasƒ± gerektiƒüi
    let productRows = [];
    let currentRow = [];

    document.querySelectorAll(".product").forEach(productDiv => {
        if (productDiv.style.display !== "none") {
            currentRow.push(productDiv);
            if (currentRow.length === columns) {
                productRows.push(currentRow);
                currentRow = [];
            }
        }
    });

    // Eƒüer satƒ±r tamamlanmadƒ±ysa eksik olanlarƒ± doldur
    if (currentRow.length > 0 && currentRow.length < columns) {
        const missingCount = columns - currentRow.length;
        for (let i = 0; i < missingCount; i++) {
            let placeholder = document.createElement("div");
            placeholder.className = "product-placeholder";
            currentRow.push(placeholder);
        }
        productRows.push(currentRow);
    }

    // Eski placeholderlarƒ± temizle
    removeAllPlaceholders();

    // Yeni satƒ±r d√ºzenini uygula
    productRows.forEach(row => {
        row.forEach(item => {
            item.parentElement.appendChild(item);
        });
    });
}





//Girdi Ayrƒ±≈ütƒ±rma (parse) Fonksiyonu
function parseSearchInput(input) {
    // Hem & hem | varsa geli≈ümi≈ü bir mantƒ±k kurmak gerekir;
    // basit yakla≈üƒ±m: √∂nce & kontrol√º, yoksa | kontrol√º
    // ya da sadece bir tanesi varsa o kullanƒ±lƒ±r
    if (input.includes('&')) {
        // "AND" durumu
        const terms = input.split('&').map(t => t.trim().toLowerCase()).filter(Boolean);
        return { operator: 'AND', terms };
    } else if (input.includes('|')) {
        // "OR" durumu
        const terms = input.split('|').map(t => t.trim().toLowerCase()).filter(Boolean);
        return { operator: 'OR', terms };
    } else {
        // Tek terim: Varsayƒ±lan olarak OR gibi davranabilirsiniz.
        // Veya "NONE" diyebilirsiniz.
        return { operator: 'SINGLE', terms: [input.toLowerCase()] };
    }
}

//Tek √úr√ºnde E≈üle≈üme Kontrol Fonksiyonu
function checkProductMatches({ operator, terms, fields }) {
    if (operator === 'AND') {
        // T√ºm terms ifadesi E≈ûZAMANLI olarak fields i√ßinde bulunmalƒ±
        // Her terimin en az 1 field‚Äôda ge√ßmesi yeterlidir ama hepsi bulunmalƒ± => every
        return terms.every(term => 
            fields.some(field => field.includes(term))
        );
    } else if (operator === 'OR') {
        // Terimlerden herhangi biri fields i√ßinde bulunsa yeter => some
        return terms.some(term => 
            fields.some(field => field.includes(term))
        );
    } else if (operator === 'SINGLE') {
        // Tek terim => OR gibi davranabilirsiniz
        const singleTerm = terms[0];
        return fields.some(field => field.includes(singleTerm));
    }
    return false;
}


//Placeholder Temizleme Fonksiyonu
function removeAllPlaceholders() {
    const placeholders = document.querySelectorAll('.product-placeholder');
    placeholders.forEach(ph => ph.remove());
}

//Satƒ±rlarƒ± Placeholder‚Äôlarla Tamamlama Fonksiyonu
function fixRowsWithPlaceholders() {
    const groupTitles = document.querySelectorAll('.group-title');
    const totalProductsInRow = columns; // columns globalden geliyor

    groupTitles.forEach(title => {
        let productCountInGroup = 0;

        let currentElem = title.nextElementSibling;
        // Bir sonraki group-title veya null gelene kadar d√∂ng√º
        while (currentElem && !currentElem.classList.contains('group-title')) {
            if (currentElem.classList.contains('product') && currentElem.style.display !== 'none') {
                productCountInGroup++;
            }
            currentElem = currentElem.nextElementSibling;
        }

        // Eƒüer grupta eksik varsa placeholder ekleyelim
        if (productCountInGroup > 0) {
            const remainder = productCountInGroup % totalProductsInRow;
            if (remainder !== 0) {
                const needed = totalProductsInRow - remainder;
                // Son √ºr√ºn√ºn hemen sonrasƒ±na placeholder'larƒ± ekleyeceƒüiz
                let insertionPoint = title.nextElementSibling; 
                // insertionPoint'i gruptaki son "g√∂r√ºn√ºr product"un sonrasƒ±na g√∂t√ºrelim
                while (insertionPoint && !insertionPoint.classList.contains('group-title')) {
                    if (insertionPoint.classList.contains('product') && insertionPoint.style.display !== 'none') {
                        // muhtemel "son g√∂r√ºn√ºr product"
                    }
                    // Yine de en sona gelene kadar ilerleyelim
                    insertionPoint = insertionPoint.nextElementSibling;
                    // insertionPoint null veya next group-title olabilir
                    if (insertionPoint && insertionPoint.classList.contains('group-title')) {
                        // Bir sonraki grup ba≈ülƒ±ƒüƒ±na ula≈ütƒ±k, dur
                        break;
                    }
                }
                
                // insertionPoint ≈üimdi bir sonraki group-title veya null
                // placeholder'ƒ± eklememiz gereken yer tam "insertionPoint" √∂ncesi
                // Tabi bu biraz karma≈üƒ±k, isterseniz "insertionParent" mantƒ±ƒüƒ±yla ekleyebilirsiniz.

                for (let i = 0; i < needed; i++) {
                    const placeholderDiv = document.createElement('div');
                    placeholderDiv.className = 'product-placeholder';
                    placeholderDiv.style.flex = `1 1 calc(100% / ${columns} - 20px)`;
                    // Ekleyeceƒüimiz yeri bulmak i√ßin "title" ile "insertionPoint" arasƒ±na ekleyebiliriz
                    // √ñrneƒüin insertionPoint yoksa, title.parentNode.appendChild() ile ekleriz
                    if (insertionPoint && insertionPoint.parentNode) {
                        insertionPoint.parentNode.insertBefore(placeholderDiv, insertionPoint);
                    } else {
                        // Sonraki group-title yoksa sayfa sonuna ekle
                        title.parentNode.appendChild(placeholderDiv);
                    }
                }
            }
        }
    });
}

//Bo≈ü Grup Ba≈ülƒ±klarƒ±nƒ± Gizleme Fonksiyonu
function hideEmptyGroupTitles() {
    const groupTitles = document.querySelectorAll('.group-title');

    groupTitles.forEach(title => {
        let nextElem = title.nextElementSibling;
        let visibleProductCount = 0;

        while (nextElem && !nextElem.classList.contains('group-title')) {
            // "product-placeholder" da bir product deƒüil. Bu sayƒ±mƒ± bozmamasƒ± gerekir
            // O y√ºzden 'product' sƒ±nƒ±fƒ±nƒ± arƒ±yoruz
            if (nextElem.classList.contains('product') && nextElem.style.display !== 'none') {
                visibleProductCount++;
            }
            nextElem = nextElem.nextElementSibling;
        }
        if (visibleProductCount === 0) {
            title.style.display = "none";
        } else {
            title.style.display = "block";
        }
    });
}



// √úr√ºn resimlerini sunucudan √ßekmek i√ßin fonksiyon
async function fetchProductImages(productKod) {
    try {
        const response = await fetch(`/api/intrafoto/${productKod}`);
        if (response.ok) {
            const data = await response.json();
            return data.imageUrls;
        }
    } catch (error) {
        console.error("Error fetching images:", error);
    }
    // Hata durumunda varsayƒ±lan resim
    return ['/resim/YOK.jpg'];
}

// √úr√ºn √áaƒüƒ±rma Fonksiyonu
const loadProducts = async (page = 1, targetContainerId) => {
    if (!targetContainerId) {
        console.warn("Hedef container tanƒ±mlƒ± deƒüil! Varsayƒ±lan olarak 'product-container' kullanƒ±lƒ±yor.");
        targetContainerId = "product-container"; // **Varsayƒ±lan container**
    }

    let container = document.getElementById(targetContainerId);
    if (!container) {
        console.warn(`Hedef container (${targetContainerId}) bulunamadƒ±. Varsayƒ±lan olarak 'product-container' kullanƒ±lƒ±yor.`);
        targetContainerId = "product-container"; // **Varsayƒ±lan container**
        container = document.getElementById(targetContainerId);
        
        // Eƒüer hala container yoksa i≈ülemi iptal et
        if (!container) {
            console.error("Varsayƒ±lan container olan 'product-container' da bulunamadƒ±! ƒ∞≈ülem iptal edildi.");
            return;
        }
    }
	
	// üîΩ Kampanya mappingleri y√ºkl√º deƒüilse y√ºkle
	if (Object.keys(categoryCampaignMap).length === 0) {
		await loadCategoryCampaignMapping();
	}
	if (Object.keys(productCampaignMap).length === 0) {
		await loadProductCampaignMapping();
	}


    const basamak2 = basamak2Select.value;
    const basamak4 = basamak4Select.value;
    const anamodel = anamodelSelect.value;
    const model = modelSelect.value;
    const ebat = ebatSelect.value;
    const kod = kodSelect.value;
    
    // Y√ºkleme mesajƒ±nƒ± g√ºncelleme i√ßin deƒüi≈ükenler
    let totalProducts = 0;
    let loadedProducts = 0;
    const updateLoadingMessage = () => {
        loadingMessage.innerText = `Y√ºklenen: ${loadedProducts} / ${totalProducts}`;
    };

    // Devam eden y√ºklemeyi iptal et ve yeni bir abortController ba≈ülat
    if (abortController) abortController.abort();
    abortController = new AbortController();

    // Toplam √ºr√ºn sayƒ±sƒ±nƒ± almak i√ßin API isteƒüi
    try {
        const queryParams = new URLSearchParams({
            basamak2,
            basamak4,
            anamodel,
            model,
            ebat,
            kod,
        });

        const countResponse = await fetch(`http://192.168.30.4:3000/products/count?${queryParams.toString()}`, { signal: abortController.signal });
        if (countResponse.ok) {
            const countData = await countResponse.json();
            totalProducts = countData.total;
        }
    } catch (error) {
        console.error("Toplam √ºr√ºn sayƒ±sƒ± alƒ±namadƒ±:", error);
    }

    let url = `http://192.168.30.4:3000/products?page=${page}&pageSize=${pageSize}`;
    const params = [];
    if (basamak2) params.push(`basamak2=${basamak2}`);
    if (basamak4) params.push(`basamak4=${basamak4}`);
    if (anamodel) params.push(`anamodel=${anamodel}`);
    if (model) params.push(`model=${model}`);
    if (ebat) params.push(`ebat=${ebat}`);
    if (kod) params.push(`kod=${kod}`);
    if (params.length > 0) url += `&${params.join('&')}`;

    try {
        const response = await fetch(url, { signal: abortController.signal });
        const products = await response.json(); // products dizisini global deƒüi≈ükene atƒ±yoruz.

        if (!response.ok) {
            console.error("API Hatasƒ±:", response.status, response.statusText);
            return;
        }

        if (products.length === 0) {
            hasMoreProducts = false;
            alert('Filtrene uygun √ºr√ºn bulunamadƒ±.');
            return;
        }

        // ƒ∞lk sayfa ise √ºr√ºnleri temizle
        if (page === 1) {
            container.innerHTML = '';
            loadedProductCodes.clear(); // Y√ºklenen √ºr√ºnleri sƒ±fƒ±rla
        }

        let currentGroup = '';
        let productCountInGroup = 0;

        for (const product of products) {
            if (loadedProductCodes.has(product.KOD)) continue;

            loadedProductCodes.add(product.KOD);
            loadedProducts++;
            updateLoadingMessage();

            const group = `${product.BASAMAK2 || ''} - ${product.BASAMAK4 || ''}`;
            if (group !== currentGroup) {
                if (currentGroup !== '') {
                    const totalProductsInRow = columns;
                    if (productCountInGroup % totalProductsInRow !== 0) {
                        const placeholdersNeeded = totalProductsInRow - (productCountInGroup % totalProductsInRow);
                        for (let i = 0; i < placeholdersNeeded; i++) {
                            let placeholderDiv = document.createElement('div');
                            placeholderDiv.className = 'product-placeholder';
                            container.appendChild(placeholderDiv);
                        }
                    }
                }
                currentGroup = group;
                productCountInGroup = 0;
                
                // **Grup ba≈ülƒ±ƒüƒ± i√ßin √∂zel bir div olu≈ütur**
                let groupDiv = document.createElement('div');
                groupDiv.className = 'group-title';
				const [catMain, catSub] = group.split(" - ");
				const categoryBadge = getCategoryCampaignLabel(catSub);
                groupDiv.innerHTML = `
                    <span>${group}</span>
					${categoryBadge}
                    <button class="hide-group-btn" onclick="toggleGroupVisibility('${group}')">Grubu Gizle</button>
                `;
                container.appendChild(groupDiv);
            }

            productCountInGroup++;
            let productDiv = document.createElement('div');
            productDiv.className = 'product';
            productDiv.style.flex = `1 1 calc(100% / ${columns} - 20px)`;
            
            // **Filtre ƒ∞√ßin √úr√ºn Bilgilerini Attribute Olarak Ekle**
            productDiv.setAttribute("data-kurumsal", product.KURUMSALLIST ? "1" : "0");
            productDiv.setAttribute("data-indirim", product.INDIRIMLIST ? "1" : "0");
            productDiv.setAttribute("data-stock", product.STOK);
            productDiv.setAttribute("data-kod", product.KOD);
            productDiv.setAttribute("data-hm-stock", product.HOM);
            productDiv.setAttribute("data-koleksiyon25", product.KOLEKSIYON25 ? "1" : "0");
            productDiv.setAttribute("data-price", product.SFIYAT1);
            productDiv.setAttribute("data-fkontrol", product.FKONTROL ? "1" : "0");
            productDiv.setAttribute("data-fuar25", product.FUAR25 ? "1" : "0");

            // Yeni: Resimleri sunucudaki /api/intrafoto endpoint'inden √ßekiyoruz.
            const imageUrls = await fetchProductImages(product.KOD);
			const imageUrl = (imageUrls && imageUrls.length > 0) ? imageUrls[0] : '/resim/YOK.jpg';

            // **Indicators (Noktalar)**
            const indicators = imageUrls.map((_, index) => `
                <li data-target="#carousel-${product.KOD}" data-slide-to="${index}" ${index === 0 ? 'class="active"' : ''}></li>
            `).join('');

            // **Carousel Items (Resimler)**
            const carouselItems = imageUrls.map((url, index) => `
                <div class="carousel-item ${index === 0 ? 'active' : ''}" style="position: relative;">
				${getProductCampaignLabel(product.KOD)}
                    <img src="${url}" alt="${product.ADI}" class="d-block w-100" 
                        data-urls='${JSON.stringify(imageUrls)}' onclick="openImageModal('${product.KOD}')">
                </div>
            `).join('');

            const formatNumber = (value) => {
                value = parseFloat(value) || 0;
                return value.toFixed(2).replace(/\B(?=(\d{3})+(?!\d))/g, ".").replace(".", ",");
            };

            // **Body'deki √úr√ºn Carousel Yapƒ±sƒ±**
            if (targetContainerId === "product-container") {
                productDiv.innerHTML = `
                    <div id="carousel${product.KOD}" class="carousel slide" data-ride="carousel">
                        <!-- Fotoƒüraf Sayƒ±sƒ±nƒ± G√∂steren Noktalar -->
                        <ol class="carousel-indicators">
                            ${indicators}
                        </ol>
                        <div class="carousel-inner">
                            ${carouselItems}
                        </div>
                        <a class="carousel-control-prev" href="#carousel${product.KOD}" role="button" data-slide="prev">
                            <span class="carousel-control-prev-icon" aria-hidden="true"></span>
                            <span class="sr-only">Previous</span>
                        </a>
                        <a class="carousel-control-next" href="#carousel${product.KOD}" role="button" data-slide="next">
                            <span class="carousel-control-next-icon" aria-hidden="true"></span>
                            <span class="sr-only">Next</span>
                        </a>
                    </div>
                    <div style="cursor: pointer;" onclick="openImageModal('${product.KOD}')"></div>
                    <table style="width: 100%; text-align: left;">
                        <tbody>
                            <tr>
                                <td><strong>KATEGORƒ∞:</strong></td>
                                <td><strong>${product.BASAMAK2}</strong></td>
                            </tr>
                            <tr>
                                <td><strong>ALT KATEGORI:</strong></td>
                                <td><strong>${product.BASAMAK4}</strong></td>
                            </tr>
                            <tr>
                                <td><strong>KOD:</strong></td>
                                <td><strong>${product.KOD}</strong></td>
                            </tr>
                            <tr>
                                <td><strong>MODEL:</strong></td>
                                <td><strong>${product.MODEL}</strong></td>
                            </tr>
                            <tr>
                                <td>EBAT:</td>
                                <td>${product.EBAT}</td>
                            </tr>
                            <tr>
                                <td>RENK:</td>
                                <td>${product.RENK}</td>
                            </tr>
                            <tr>
                                <td>DESEN & LAMINE:</td>
                                <td>${product.DESEN ? product.DESEN : '-'} / ${product.LAMINE ? product.LAMINE : '-'}</td>
                            </tr>
                            <tr>
                                <td>MATERYAL:</td>
                                <td>${product.MATERYAL}</td>
                            </tr>
                            <tr>
                                <td>AYAK:</td>
                                <td>${product.LEG ? product.LEG : '-'}</td>
                            </tr>
                            <tr>
                                <td>PRK TL & USD:</td>
                                <td>${formatCurrency(product.SFIYAT1, 1)} / ${formatCurrency(product.SFIYAT4, 4)}</td>
                            </tr>
                            <tr>
                                <td>STOK / HM:</td>
                                <td>${product.STOK} / ${product.HOM}</td>
                            </tr>
                            <tr>
							<td>G√úNCEL KOLEKSƒ∞YON:</td>
                                <td>
                                     <input type="checkbox" ${product.KOLEKSIYON25 ? 'checked' : ''} onchange="updateKoleksiyon('${product.KOD}', 'KOLEKSIYON25', this.checked)">
								</td>
							</tr>
							<tr>
							<td>PROJE:</td>
								<td>
                                  <input type="checkbox" ${product.KURUMSALLIST ? 'checked' : ''} onchange="updateKoleksiyon('${product.KOD}', 'KURUMSALLIST', this.checked)"></label>  
                                </td>
                            </tr>
                            <tr>
                                <td>Fiyat Kontrol:</td>
                                <td>
                                    <input
                                        type="checkbox"
                                        id="fkontrol-${product.KOD}"
                                        ${product.FKONTROL ? 'checked' : ''}
                                        onchange="updateFkontrol('${product.KOD}', this.checked)"
                                    >
                                    <input
                                        type="text"
                                        id="fkontrolnotes-${product.KOD}"
                                        value="${product.FKONTROLNOTES || ''}"
                                        style="display: ${product.FKONTROL ? 'inline-block' : 'none'};"
                                        onblur="updateFkontrolNotes('${product.KOD}', this.value)"
                                    >
                                </td>
                            </tr>
                            <tr>
                                <td>Fuar 2025:</td>
                                <td>${product.FUAR25 ? '‚úÖ Evet' : '‚ùå Hayƒ±r'}</td>
                            </tr>
                            <tr>
                                <td>Kar≈üƒ±la≈ütƒ±r:</td>
                                <td>
                                    <label class="compare-checkbox">
                                        <input type="checkbox" data-product-code="${product.KOD}" onclick="toggleCompare('${product.KOD}', this)"> 
                                    </label>
                                </td>
                            </tr>
                            <tr style="padding: 0;">
                                <td>NOTLAR:</td>
                                <td><textarea onblur="updateNotes('${product.KOD}', this.value)">${product.NOTES || ''}</textarea></td>
                            </tr>
                            <tr>
								<td style="text-align: center;">
									${ imageUrl !== '/resim/YOK.jpg' ? `<button class="btn btn-sm" style="background-color: #d8f0f2; color: black; border: none;" onclick="openSuggestionModal('${product.KOD}')">√ñneriler</button>` : '' }
								</td>
                                <td  style="text-align: center;">
                                    <button class="btn btn-sm" style="background-color: #727476; color: white; border: none;" onclick="addToCart('${product.KOD}')">Teklif Sepetine Ekle</button>
                                </td>
								
								
								</td>
                            </tr>
                        </tbody>
                    </table>
                `;
            } else if (targetContainerId === "admin-product-container") {
                // Admin paneli i√ßin benzer yapƒ±, farklƒ± ID'ler ve i√ßerik d√ºzeni uygulanƒ±yor.
                productDiv.innerHTML = `
                    <div id="carousel${product.KOD}-admin" class="carousel slide" data-ride="carousel">
                        <ol class="carousel-indicators">
                            ${indicators}
                        </ol>
                        <div class="carousel-inner">
                            ${carouselItems}
                        </div>
                        <a class="carousel-control-prev" href="#carousel${product.KOD}-admin" role="button" data-slide="prev">
                            <span class="carousel-control-prev-icon" aria-hidden="true"></span>
                            <span class="sr-only">Previous</span>
                        </a>
                        <a class="carousel-control-next" href="#carousel${product.KOD}-admin" role="button" data-slide="next">
                            <span class="carousel-control-next-icon" aria-hidden="true"></span>
                            <span class="sr-only">Next</span>
                        </a>
                    </div>
                    <div style="cursor: pointer;" onclick="openImageModal('${product.KOD}')"></div>
                    <table style="width: 100%; text-align: left;">
                        <tbody>
                            <tr>
                                <td><strong>KATEGORƒ∞:</strong></td>
                                <td><strong>${product.BASAMAK2}</strong></td>
                            </tr>
                            <tr>
                                <td><strong>ALT KATEGORI:</strong></td>
                                <td><strong>${product.BASAMAK4}</strong></td>
                            </tr>
                            <tr>
                                <td><strong>KOD:</strong></td>
                                <td><strong>${product.KOD}</strong></td>
                            </tr>
                            <tr>
                                <td><strong>MODEL:</strong></td>
                                <td><strong>${product.MODEL}</strong></td>
                            </tr>
                            <tr>
                                <td>EBAT:</td>
                                <td>${product.EBAT}</td>
                            </tr>
                            <tr>
                                <td>RENK:</td>
                                <td>${product.RENK}</td>
                            </tr>
                            <tr>
                                <td>DESEN & LAMINE:</td>
                                <td>${product.DESEN ? product.DESEN : '-'} / ${product.LAMINE ? product.LAMINE : '-'}</td>
                            </tr>
                            <tr>
                                <td>MATERYAL:</td>
                                <td>${product.MATERYAL}</td>
                            </tr>
                            <tr>
                                <td>AYAK:</td>
                                <td>${product.LEG ? product.LEG : '-'}</td>
                            </tr>
                            <tr>
                                <td>PRK TL & USD:</td>
                                <td>${formatCurrency(product.SFIYAT1, 1)} / ${formatCurrency(product.SFIYAT4, 4)}</td>
                            </tr>
                            <tr>
                                <td>MALƒ∞YET TL & USD:</td>
                                <td>${formatCurrency(product.HSP_MALIYET_TL, 1)} / ${formatCurrency(product.HSP_MALIYET_USD, 4)}</td>
                            </tr>
                            <tr>
                                <td>√áARPAN TL & USD:</td>
                                <td>${formatNumber(product.CARPANTL)} / ${formatNumber(product.CARPANUSD)}</td>
                            </tr>
                            <tr>
                                <td>RE√áETE KONTROL:</td>
                                <td>
                                    <input type="checkbox" id="receteKontrol-${product.KOD}" onchange="updateReceteKontrol('${product.KOD}', this.checked)" ${product.RECETEKONTROL ? 'checked' : ''} /> / 
                                    ${product.RECETEKONTROLTARIH ? formatDate(product.RECETEKONTROLTARIH) : '-'}
                                </td>
                            </tr>
                            <tr>
                                <td style="width: 50%;"><strong>Malzeme & ƒ∞≈ü√ßilik USD</strong></td>
                                <td style="width: 50%;">${formatCurrency(product.MALZEMEUSD, 4)} + ${formatCurrency(product.ISCILIKUSD, 4)} = ${formatCurrency(product.RECETE_MALIYET_USD, 4)}</td>
                            </tr>
                            <tr>
                                <td>STOK / HM:</td>
                                <td>${product.STOK} / ${product.HOM}</td>
                            </tr>
                            <tr>
                                <td colspan="2">
                                    <div class="koleksiyon-checkboxes">
                                        <label style="margin: 0; padding: 0;">25: <input type="checkbox" ${product.KOLEKSIYON25 ? 'checked' : ''} onchange="updateKoleksiyon('${product.KOD}', 'KOLEKSIYON25', this.checked)"></label>
                                    </div>
                                </td>
                            </tr>
                            <tr>
                                <td>Fiyat Kontrol:</td>
                                <td>
                                    <input type="checkbox" id="fkontrol-${product.KOD}" ${product.FKONTROL ? 'checked' : ''} onchange="updateFkontrol('${product.KOD}', this.checked)">
                                    <input type="text" id="fkontrolnotes-${product.KOD}" value="${product.FKONTROLNOTES || ''}" style="display: ${product.FKONTROL ? 'inline-block' : 'none'};" onblur="updateFkontrolNotes('${product.KOD}', this.value)">
                                </td>
                            </tr>
                            <tr>
                                <td>Fuar 2025:</td>
                                <td>${product.FUAR25 ? '‚úÖ Evet' : '‚ùå Hayƒ±r'}</td>
                            </tr>
                            <tr>
                                <td>Kar≈üƒ±la≈ütƒ±r:</td>
                                <td>
                                    <label class="compare-checkbox">
                                        <input type="checkbox" data-product-code="${product.KOD}" onclick="toggleCompare('${product.KOD}', this)">
                                    </label>
                                </td>
                            </tr>
                            <tr style="padding: 0;">
                                <td>NOTLAR:</td>
                                <td><textarea onblur="updateNotes('${product.KOD}', this.value)">${product.NOTES || ''}</textarea></td>
                            </tr>
                            <tr>
								<td style="text-align: center;">
									${ imageUrl !== '/resim/YOK.jpg' ? `<button class="btn btn-sm" style="background-color: #d8f0f2; color: black; border: none;" onclick="openSuggestionModal('${product.KOD}')">√ñneriler</button>` : '' }
								</td>
                                <td colspan="2" style="text-align: center;">
                                    <button class="btn btn-sm" style="background-color: #727476; color: white; border: none;" onclick="addToCart('${product.KOD}')">Teklif Sepetine Ekle</button>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                `;
            }
            container.appendChild(productDiv);
        }
		filterProducts()
        const totalProductsInRow = columns;
        if (productCountInGroup % totalProductsInRow !== 0) {
            const placeholdersNeeded = totalProductsInRow - (productCountInGroup % totalProductsInRow);
            for (let i = 0; i < placeholdersNeeded; i++) {
                let placeholderDiv = document.createElement('div');
                placeholderDiv.className = 'product-placeholder';
                container.appendChild(placeholderDiv);
            }
        }
    } catch (error) {
        if (error.name === 'AbortError') {
            // ƒ∞ptal edildiƒüi durumlarda i≈ülem yapmayƒ±n
        } else {
            console.error("√úr√ºn y√ºkleme hatasƒ±:", error);
        }
    }
};

//Tarih Formatlama
function formatDate(dateString) {
  const date = new Date(dateString);
  if (isNaN(date)) return '-';
  const day = String(date.getDate()).padStart(2, '0');
  const month = String(date.getMonth() + 1).padStart(2, '0');
  const year = date.getFullYear();
  return `${day}.${month}.${year}`;
}
//√úr√ºn Re√ßete Kontrol G√ºncelleme
async function updateReceteKontrol(kod, isChecked) {
    try {
         const response = await fetch('/update-details', {
             method: 'POST',
             headers: { 'Content-Type': 'application/json' },
             body: JSON.stringify({ KOD: kod, RECETEKONTROL: isChecked })
         });
         const result = await response.json();
         
         // Gerekirse kullanƒ±cƒ±ya bilgi verin veya sayfayƒ± g√ºncelleyin.
         // √ñrneƒüin:
         // await showCartContents();
    } catch (error) {
         console.error('Re√ßete kontrol g√ºncelleme hatasƒ±:', error);
         alert('Re√ßete kontrol g√ºncellenirken bir hata olu≈ütu.');
    }
}

//Sepet Fiyatlarƒ± Kontrol Eden Fonksiyon
async function checkCartPriceChanges(cartId) {
    try {
        const response = await fetch(`/api/cart/update-prices?cartId=${cartId}`);
        const data = await response.json();

        if (!data.success) {
            alert("Fiyat g√ºncellenirken hata olu≈ütu.");
            return;
        }

        const priceChanges = data.priceChanges;
        if (priceChanges.length === 0) {
            alert("‚ö° T√ºm fiyatlar g√ºncel, deƒüi≈üiklik yok!");
            return;
        }

        // üìå Modal i√ßeriƒüini g√ºncelle
        const priceUpdateTableBody = document.getElementById("priceUpdateTableBody");
        const totalPriceDifferenceElement = document.getElementById("totalPriceDifference");
        let totalPriceDifference = 0;

        priceUpdateTableBody.innerHTML = "";
        priceChanges.forEach(change => {
            const row = `
                <tr>
                    <td>${change.PRODUCT_ID}</td>
                    <td>${formatCurrency(change.OLD_PRICE, change.PRICE_TYPE)}</td>
                    <td>${formatCurrency(change.NEW_PRICE, change.PRICE_TYPE)}</td>
                    <td>${formatCurrency(change.PRICE_DIFFERENCE, change.PRICE_TYPE)}</td>
                </tr>
            `;
            priceUpdateTableBody.innerHTML += row;
            totalPriceDifference += parseFloat(change.PRICE_DIFFERENCE);
        });

        totalPriceDifferenceElement.innerText = formatCurrency(totalPriceDifference, priceChanges[0]?.PRICE_TYPE || 1);

        // üìå Modalƒ± a√ß
        $('#priceUpdateModal').modal('show');

        // üìå G√ºncelleme butonuna event ekleyelim
        document.getElementById("confirmPriceUpdate").onclick = () => {
			updateCartPrices(cartId);
			totalPriceDifferenceElement.innerText = formatCurrency(0, priceChanges[0]?.PRICE_TYPE || 1); // üî• G√ºncellemeden sonra farkƒ± sƒ±fƒ±rla
		};

    } catch (error) {
        console.error("Fiyat deƒüi≈üiklikleri kontrol edilirken hata:", error);
    }
}
// Kullanƒ±cƒ± Onay Verdiƒüinde Sepet Fiyatlarƒ±nda G√ºncelleme Yapan Fonksiyon
async function updateCartPrices(cartId) {
    try {
        const response = await fetch("/api/cart/update-prices", {
			method: "POST",
			headers: { "Content-Type": "application/json" },
			body: JSON.stringify({ cartId, confirmUpdate: true }) // üî• Kullanƒ±cƒ± onayƒ±nƒ± ekledik!
		});

		$('#cartModal').modal('hide');
		const data = await response.json();
        if (data.success) {
            alert("‚úîÔ∏è Sepet fiyatlarƒ± ba≈üarƒ±yla g√ºncellendi!");
            // üî• G√ºncelleme sonrasƒ± farklarƒ± temizle
			priceUpdateTableBody.innerHTML = "";  
			totalPriceDifferenceElement.innerText = formatCurrency(0, priceChanges[0]?.PRICE_TYPE || 1);  
			$('#priceUpdateModal').modal('hide');
			$('#cartModal').modal('show');
			showCartContents();
			updateCartSummary();			
        } else {
            alert("‚ö†Ô∏è Fiyat g√ºncellemesi ba≈üarƒ±sƒ±z: " + data.message);
        }
    } catch (error) {
        console.error("Fiyat g√ºncellenirken hata olu≈ütu:", error);
    }
}

//grubu gizle butonu i≈ülevi
function toggleGroupVisibility(groupName) {
    const groupTitle = [...document.querySelectorAll(".group-title")].find(title => title.innerText.includes(groupName));
    if (!groupTitle) return;

    // üìå **Grup adƒ±nƒ± par√ßalara ayƒ±rarak kategori ve alt kategoriyi alalƒ±m**
    const [category, subCategory] = groupName.split(" - ").map(text => text.trim().toLowerCase());

    // üìå **T√ºm √ºr√ºnleri tarayalƒ±m ve e≈üle≈üenleri bulalƒ±m**
    const groupElements = [...document.querySelectorAll(".product")].filter(productDiv => {
        const productCategory = (productDiv.querySelector('tr:nth-child(1) td:nth-child(2)')?.textContent || '').toLowerCase();
        const productSubCategory = (productDiv.querySelector('tr:nth-child(2) td:nth-child(2)')?.textContent || '').toLowerCase();
        return productCategory === category && productSubCategory === subCategory;
    });

    // üìå **Eƒüer bu kategoride √ºr√ºn varsa, onlarƒ± gizle/g√∂ster**
    const isCurrentlyHidden = groupElements.length > 0 && groupElements[0].getAttribute("data-hidden-group") === "true";

    groupElements.forEach(el => {
        if (isCurrentlyHidden) {
            el.style.display = "inline-block";
            el.removeAttribute("data-hidden-group"); // üìå Gizli √∂zelliƒüi kaldƒ±r
        } else {
            el.style.display = "none";
            el.setAttribute("data-hidden-group", "true"); // üìå √úr√ºn√º gizli olarak i≈üaretle
        }
    });

    // üìå **Grup ba≈ülƒ±ƒüƒ±nƒ± da aynƒ± ≈üekilde gizle/g√∂ster**
    if (isCurrentlyHidden) {
        groupTitle.style.display = "flex";
    } else {
        groupTitle.style.display = "none";
    }

    removeAllPlaceholders();
    fixRowsWithPlaceholders();
}


//Kar≈üƒ±la≈ütƒ±rma
let compareList = [];
let products = []; // √úr√ºnleri tutacak global dizi

const MAX_COMPARE_ITEMS = 4; // Maksimum kar≈üƒ±la≈ütƒ±rma sayƒ±sƒ±

function toggleCompare(productCode, checkbox) {
    const product = getProductByCode(productCode); // √úr√ºn bilgisini al
    if (!product) {
        console.warn("√úr√ºn bilgisi bulunamadƒ±:", productCode);
        return;
    }

    if (checkbox.checked) {
        if (compareList.length >= MAX_COMPARE_ITEMS) {
            alert(`En fazla ${MAX_COMPARE_ITEMS} √ºr√ºn kar≈üƒ±la≈ütƒ±rabilirsiniz!`);
            checkbox.checked = false; // Maksimum a≈üƒ±ldƒ±ƒüƒ±nda checkbox'ƒ± kaldƒ±r
            return;
        }

        // Eƒüer √ºr√ºn zaten ekliyse ekleme yapƒ±lmƒ±yor
        if (!compareList.some(item => item.KOD === product.KOD)) {
            compareList.push(product);
        }
    } else {
        removeFromCompare(product.KOD); // √úr√ºn√º listeden √ßƒ±kar
    }

    updateCompareFooter(); // Footer'ƒ± g√ºncelle
}

function getProductByCode(productCode) {
    return products.find(product => product.KOD === productCode);
}

function updateCompareFooter() {
    const compareFooter = document.getElementById("compareFooter");
    const compareCount = document.getElementById("compareCount");

    if (compareList.length >= 2) {
        compareFooter.style.display = "block"; // Kar≈üƒ±la≈ütƒ±rma butonunu g√∂ster
        compareCount.textContent = compareList.length; // Sayacƒ± g√ºncelle
    } else {
        compareFooter.style.display = "none"; // 2'den az √ºr√ºn varsa butonu gizle
    }
}


function removeFromCompare(productCode) {
    // 1Ô∏è‚É£ **√úr√ºn√º kar≈üƒ±la≈ütƒ±rma listesinden √ßƒ±kar**
    compareList = compareList.filter(item => item.KOD !== productCode);

    // 2Ô∏è‚É£ **Checkbox g√ºncelleme (Body'deki √ºr√ºn checkbox'ƒ±nƒ± temizle)**
    const productCheckbox = document.querySelector(`input[data-product-code="${productCode}"]`);
    if (productCheckbox) {
        productCheckbox.checked = false;
    }

    // 3Ô∏è‚É£ **Eƒüer sadece 1 √ºr√ºn kaldƒ±ysa modalƒ± kapat ve √ßƒ±k**
    if (compareList.length < 2) {
        $("#compareModal").modal("hide"); // Bootstrap 4 i√ßin modal kapatma
        updateCompareFooter(); // Butonu g√ºncelle
        return; // Fonksiyonu burada bitiriyoruz
    }

    // 4Ô∏è‚É£ **Footer butonunu g√ºncelle**
    updateCompareFooter();

    // 5Ô∏è‚É£ **Modal i√ßeriƒüini tekrar olu≈ütur ve hizalamayƒ± d√ºzelt**
    openCompareModal();
}

function clearCompareList() {
    // 1Ô∏è‚É£ **Kar≈üƒ±la≈ütƒ±rma listesini temizle**
    compareList = [];

    // 2Ô∏è‚É£ **T√ºm checkbox'larƒ±n i≈üaretini kaldƒ±r**
    document.querySelectorAll('input[data-product-code]').forEach(checkbox => {
        checkbox.checked = false;
    });

    // 3Ô∏è‚É£ **Footer'daki butonu gizle**
    updateCompareFooter();

    // 4Ô∏è‚É£ **Modalƒ± kapat**
    $("#compareModal").modal("hide");

    
}
//√ñneri Fonksiyonu
async function openSuggestionModal(productId) {
  try {
    // 1. /api/similar endpoint'inden benzer √ºr√ºnleri √ßekiyoruz.
    const similarResponse = await fetch(`http://192.168.30.4:3000/api/similar?code=${productId}`);
    if (!similarResponse.ok) throw new Error("Benzer √ºr√ºnler alƒ±namadƒ±.");
    const similarData = await similarResponse.json();
    
    // Benzer √ºr√ºn kodlarƒ±nƒ± al ve konsola yazdƒ±r.
    const similarCodes = similarData.topSimilar.map(item => item.KOD);
    console.log("Benzer √úr√ºn Kodlarƒ±:", similarCodes);
    
    // 2. Tƒ±klanan (mevcut) √ºr√ºn detaylarƒ±nƒ± /products endpoint'inden √ßekiyoruz.
    let currentProduct = null;
    const currentResponse = await fetch(`http://192.168.30.4:3000/products?kod=${encodeURIComponent(productId)}`);
    if (currentResponse.ok) {
      const currentData = await currentResponse.json();
      // Tam e≈üle≈üme kontrol√º:
      const filtered = currentData.filter(prod => prod.KOD === productId);
      currentProduct = filtered.length > 0 ? filtered[0] : (currentData.length > 0 ? currentData[0] : null);
    } else {
      console.warn("Mevcut √ºr√ºn detaylarƒ± alƒ±namadƒ±.");
    }
    
    // Eƒüer benzer kodlar bo≈üsa, uyarƒ± verelim (currentProduct varsa yine devam edelim).
    if (similarCodes.length === 0 && !currentProduct) {
      alert("√ñnerilen √ºr√ºn bulunamadƒ±.");
      return;
    }
    
    // Eƒüer mevcut √ºr√ºn√ºn fotoƒürafƒ± yoksa, √∂neri yapƒ±lamayacaƒüƒ±nƒ± bildir ve fonksiyonu sonlandƒ±r.
    if (currentProduct) {
      const currentImageUrls = await fetchProductImages(currentProduct.KOD);
      const currentImageUrl = (currentImageUrls && currentImageUrls.length > 0) ? currentImageUrls[0] : '/resim/YOK.jpg';
      if (currentImageUrl === '/resim/YOK.jpg') {
        alert("Fotoƒürafsƒ±z √ºr√ºnler i√ßin √∂neri yapƒ±lamaz.");
        return;
      }
    }
    
    let uniqueProducts = [];
    
    // 3. Her benzer √ºr√ºn kodu i√ßin /products endpoint‚Äôine sƒ±ralƒ± olarak istek g√∂nderiyoruz.
    for (const code of similarCodes) {
      const res = await fetch(`http://192.168.30.4:3000/products?kod=${encodeURIComponent(code)}`);
      if (!res.ok) {
        console.warn(`Kod ${code} i√ßin √ºr√ºn verisi alƒ±namadƒ±.`);
        continue;
      }
      const data = await res.json();
      console.log(`Kod ${code} i√ßin √ºr√ºnler:`, data);
      
      // Gelen veride tam e≈üle≈üme varsa kullanƒ±n.
      const exactProducts = data.filter(prod => prod.KOD === code);
      if (exactProducts.length > 0) {
        uniqueProducts = uniqueProducts.concat(exactProducts);
      } else if (data.length > 0) {
        uniqueProducts.push(data[0]);
      }
    }
    
    console.log("Toplanan √úr√ºnler:", uniqueProducts);
    
    // 4. Modal i√ßeriƒüini olu≈üturuyoruz.
    let modalHtml = "";
    
    // B√∂l√ºm 1: Mevcut √úr√ºn
    if (currentProduct) {
      modalHtml += `<h5>Mevcut √úr√ºn</h5>`;
      modalHtml += `<div class="d-flex flex-row" style="flex-wrap: nowrap; width: 20%; margin-bottom: 20px;">`;
      const currentImageUrls = await fetchProductImages(currentProduct.KOD);
      const currentImageUrl = (currentImageUrls && currentImageUrls.length > 0) ? currentImageUrls[0] : '/resim/YOK.jpg';
      modalHtml += `
        <div class="text-center" style="flex: 0 0 25%; max-width: 25%;">
          <img src="${currentImageUrl}" alt="${currentProduct.KOD}" style="width: 100%; height: auto; cursor:pointer;" onclick="openImageModal('${currentProduct.KOD}')">
          <p style="margin-top:5px;">${currentProduct.KOD}<br><small>(Mevcut √úr√ºn)</small></p>
        </div>
      `;
      modalHtml += `</div>`;
    }
    
    // B√∂l√ºm 2: √ñnerilen √úr√ºnler
    if (uniqueProducts.length > 0) {
      modalHtml += `<h5>√ñnerilen √úr√ºnler</h5>`;
      // √úr√ºnler arasƒ±nda bo≈üluk bƒ±rakmak i√ßin gap √∂zelliƒüini ekleyin.
      modalHtml += `<div class="d-flex flex-row" style="flex-wrap: nowrap; width: 100%; overflow-x: auto; gap: 10px;">`;
      for (const product of uniqueProducts) {
        const imageUrls = await fetchProductImages(product.KOD);
        const imageUrl = (imageUrls && imageUrls.length > 0) ? imageUrls[0] : '/resim/YOK.jpg';
        
        // Eƒüer √∂nerilen √ºr√ºn√ºn fotoƒürafƒ± yoksa mesaj g√∂sterip fonksiyonu sonlandƒ±r.
        if (imageUrl === '/resim/YOK.jpg') {
          alert("Fotoƒürafsƒ±z √ºr√ºnler i√ßin √∂neri yapƒ±lamaz.");
          return;
        }
        
        modalHtml += `
          <div class="text-center" style="flex: 0 0 20%; max-width: 20%; margin-bottom: 10px;">
            <img src="${imageUrl}" alt="${product.KOD}" style="width: 100%; height: auto; cursor:pointer;" onclick="openImageModal('${product.KOD}')">
            <table style="width: 100%; text-align: left; font-size: 0.9em; display: inline-table;">
              <tbody>
                <tr>
                  <td><strong>KATEGORƒ∞:</strong></td>
                  <td><strong>${product.BASAMAK2}</strong></td>
                </tr>
                <tr>
                  <td><strong>ALT KATEGORI:</strong></td>
                  <td><strong>${product.BASAMAK4}</strong></td>
                </tr>
                <tr>
                  <td><strong>KOD:</strong></td>
                  <td><strong>${product.KOD}</strong></td>
                </tr>
                <tr>
                  <td><strong>MODEL:</strong></td>
                  <td><strong>${product.MODEL}</strong></td>
                </tr>
                <tr>
                  <td>EBAT:</td>
                  <td>${product.EBAT}</td>
                </tr>
                <tr>
                  <td>RENK:</td>
                  <td>${product.RENK}</td>
                </tr>
                <tr>
                  <td>DESEN & LAMINE:</td>
                  <td>${product.DESEN ? product.DESEN : '-'} / ${product.LAMINE ? product.LAMINE : '-'}</td>
                </tr>
                <tr>
                  <td>MATERYAL:</td>
                  <td>${product.MATERYAL}</td>
                </tr>
                <tr>
                  <td>AYAK:</td>
                  <td>${product.LEG ? product.LEG : '-'}</td>
                </tr>
                <tr>
                  <td>PRK TL & USD:</td>
                  <td>${formatCurrency(product.SFIYAT1, 1)} / ${formatCurrency(product.SFIYAT4, 4)}</td>
                </tr>
                <tr>
                  <td>STOK / HM:</td>
                  <td>${product.STOK} / ${product.HOM}</td>
                </tr>
                <tr>
                  <td>G√úNCEL KOLEKSƒ∞YON:</td>
                  <td>
                    <input type="checkbox" ${product.KOLEKSIYON25 ? 'checked' : ''} onchange="updateKoleksiyon('${product.KOD}', 'KOLEKSIYON25', this.checked)">
                  </td>
                </tr>
                <tr>
                  <td>PROJE:</td>
                  <td>
                    <input type="checkbox" ${product.KURUMSALLIST ? 'checked' : ''} onchange="updateKoleksiyon('${product.KOD}', 'KURUMSALLIST', this.checked)">
                  </td>
                </tr>
                <tr>
                  <td>Fiyat Kontrol:</td>
                  <td>
                    <input
                      type="checkbox"
                      id="fkontrol-${product.KOD}"
                      ${product.FKONTROL ? 'checked' : ''}
                      onchange="updateFkontrol('${product.KOD}', this.checked)"
                    >
                    <input
                      type="text"
                      id="fkontrolnotes-${product.KOD}"
                      value="${product.FKONTROLNOTES || ''}"
                      style="display: ${product.FKONTROL ? 'inline-block' : 'none'};"
                      onblur="updateFkontrolNotes('${product.KOD}', this.value)"
                    >
                  </td>
                </tr>
                <tr>
                  <td>Fuar 2025:</td>
                  <td>${product.FUAR25 ? '‚úÖ Evet' : '‚ùå Hayƒ±r'}</td>
                </tr>
                <tr>
                  <td>Kar≈üƒ±la≈ütƒ±r:</td>
                  <td>
                    <label class="compare-checkbox">
                      <input type="checkbox" data-product-code="${product.KOD}" onclick="toggleCompare('${product.KOD}', this)"> 
                    </label>
                  </td>
                </tr>
                <tr style="padding: 0;">
                  <td>NOTLAR:</td>
                  <td><textarea onblur="updateNotes('${product.KOD}', this.value)">${product.NOTES || ''}</textarea></td>
                </tr>
                <tr>
                  <td colspan="2" style="text-align: center;">
                    <button class="btn btn-sm" style="background-color: #727476; color: white; border: none;" onclick="addToCart('${product.KOD}')">Teklif Sepetine Ekle</button>
                  </td>
                </tr>
              </tbody>
            </table>
          </div>
        `;
      }
      modalHtml += `</div>`;
    }
    
    // 5. Modal body'yi g√ºncelleyin ve modalƒ± a√ßƒ±n.
    document.getElementById("suggestionModalBody").innerHTML = modalHtml;
    $('#suggestionModal').modal('show');
  } catch (error) {
    console.error("√ñneri modal hatasƒ±:", error);
    alert("√ñneriler y√ºklenirken bir hata olu≈ütu: " + error.message);
  }
}




function openCompareModal() {
    const modalBody = document.getElementById("compareProductsContainer");

    if (compareList.length < 2) {
        alert("Kar≈üƒ±la≈ütƒ±rma yapmak i√ßin en az 2 √ºr√ºn se√ßmelisiniz!");
        return;
    }

    modalBody.innerHTML = ""; // √ñnce i√ßeriƒüi temizle

    compareList.forEach(product => {
        const productDiv = document.createElement("div");
        productDiv.className = "compare-product";

        productDiv.innerHTML = `
            <div id="carousel${product.KOD}" class="carousel slide" data-ride="carousel">
                <ol class="carousel-indicators">
                    <li data-target="#carousel-${product.KOD}" data-slide-to="0" class="active"></li>
                </ol>
                <div class="carousel-inner">
                    <div class="carousel-item active">
                        <img src="/resim/${product.KOD}.jpg" class="d-block w-100" alt="${product.ADI}">
                    </div>
                </div>
            </div>
            <table class="table table-bordered">
                <tr><td><strong>KATEGORƒ∞:</strong></td><td>${product.BASAMAK2}</td></tr>
                <tr><td><strong>ALT KATEGORI:</strong></td><td>${product.BASAMAK4}</td></tr>
                <tr><td><strong>KOD:</strong></td><td>${product.KOD}</td></tr>
                <tr><td><strong>MODEL:</strong></td><td>${product.MODEL}</td></tr>
                <tr><td>EBAT:</td><td>${product.EBAT}</td></tr>
                <tr><td>RENK:</td><td>${product.RENK}</td></tr>
                <tr><td>DESEN & LAMINE:</td><td>${product.DESEN ? product.DESEN : '-'} / ${product.LAMINE ? product.LAMINE : '-'}</td></tr>
                <tr><td>MATERYAL:</td><td>${product.MATERYAL}</td></tr>
                <tr><td>PRK TL & USD:</td><td>${formatCurrency(product.SFIYAT1, 1)} / ${formatCurrency(product.SFIYAT4, 4)}</td></tr>
                <tr><td>STOK / HM:</td><td>${product.STOK} / ${product.HOM}</td></tr>
            </table>
            <button class="btn btn-danger btn-sm" onclick="removeFromCompare('${product.KOD}')">Listeden Kaldƒ±r</button>
        `;

        modalBody.appendChild(productDiv);
    });

    // **√úr√ºn sayƒ±sƒ±na g√∂re dizilim g√ºncelleme**
    if (compareList.length === 3) {
        modalBody.style.justifyContent = "space-around";
    } else if (compareList.length === 2) {
        modalBody.style.justifyContent = "center";
    } else {
        modalBody.style.justifyContent = "space-between";
    }

    $("#compareModal").modal("show");
}


function addToCompare(product) {
    
    if (compareList.length >= MAX_COMPARE_ITEMS) {
        alert(`En fazla ${MAX_COMPARE_ITEMS} √ºr√ºn kar≈üƒ±la≈ütƒ±rabilirsiniz!`);
        return;
    }

    // Eƒüer √ºr√ºn zaten ekliyse ekleme
    if (compareList.some(item => item.KOD === product.KOD)) {
        alert("Bu √ºr√ºn zaten kar≈üƒ±la≈ütƒ±rma listesinde!");
        return;
    }

    compareList.push(product);
    updateCompareFooter(); // Butonun g√∂r√ºn√ºrl√ºƒü√ºn√º g√ºncelle
    
    
}




// Men√º tƒ±klama olayƒ±nƒ± dinleyip sadece basamak2 ve basamak4 dropdownlarƒ±nƒ± g√ºncelleme
document.addEventListener('DOMContentLoaded', () => {
    
	const menu = document.getElementById('urunlerDropdown');
    const basamak2Select = document.getElementById("basamak2");
    const basamak4Select = document.getElementById("basamak4");

    if (!menu || !basamak2Select || !basamak4Select) {
        console.error("Gerekli elementler bulunamadƒ±. L√ºtfen HTML yapƒ±sƒ±nƒ± kontrol edin.");
        return;
    }



    // Men√º √∂ƒüesine tƒ±klama dinleyicisi
    menu.addEventListener('click', async (event) => {
        event.preventDefault(); // Varsayƒ±lan tƒ±klama davranƒ±≈üƒ±nƒ± engelle

        const target = event.target.closest('a'); // En yakƒ±n <a> √∂ƒüesini bul
        if (target) {
            const basamak2 = target.dataset.basamak2?.trim() || ""; // Ana kategori (BASAMAK2)
            const basamak4 = target.dataset.basamak4?.trim() || ""; // Alt kategori (BASAMAK4)

            // BASAMAK2 Dropdown G√ºncelleme
            try {
                const options = Array.from(basamak2Select.options);
                const optionExists = options.some((option) => option.value.trim() === basamak2);

                if (optionExists) {
                    basamak2Select.value = basamak2;
                } else if (basamak2) {
                    const newOption = new Option(basamak2, basamak2, false, true);
                    basamak2Select.add(newOption);
                    basamak2Select.value = basamak2;
                } else {
                    console.warn("BASAMAK2 deƒüeri bo≈ü, i≈ülem yapƒ±lmadƒ±.");
                }
            } catch (error) {
                console.error("BASAMAK2 Dropdown G√ºncelleme Hatasƒ±:", error);
            }

            // BASAMAK4 Dropdown G√ºncelleme
            try {
                if (basamak4) {
                    basamak4Select.value = basamak4;
                } else {
                    basamak4Select.value = ""; // Temizle
                }
            } catch (error) {
                console.error("BASAMAK4 Dropdown G√ºncelleme Hatasƒ±:", error);
            }

            // Sonu√ßlarƒ± Konsolda G√∂ster
            
			// **Ana √ºr√ºn konteynerini gizle, konsept √ºr√ºn konteynerini g√∂ster**
			document.getElementById("product-container").style.display = "flex";
			document.getElementById("concept-products-container").style.display = "none";
			// üìå **Varsayƒ±lan container belirle ve LoadProducts √ßaƒüƒ±r**
            let targetContainerId = "product-container"; // üåü Varsayƒ±lan olarak ana sayfaya y√ºkle
            const activeTab = document.querySelector(".nav-tabs .nav-link.active");
            if (activeTab) {
                const targetTab = activeTab.getAttribute("href").substring(1);
                if (targetTab === "adminPanel") {
                    targetContainerId = "admin-product-container";
                } else if (targetTab === "reports") {
                    targetContainerId = "report-product-container";
					
                }
            }
			
			if (initialImageContainer) {
				initialImageContainer.style.display = 'none';
			}

			currentPage = 1;
            showLoadingMessage();
            await loadProducts(currentPage, targetContainerId); // üìå **Doƒüru container ile √ßaƒüƒ±r!**
            hideLoadingMessage();
        } else {
            console.warn("Tƒ±klanan √∂ƒüe bir <a> etiketi deƒüil.");
        }
    });
});

// Checkbox g√ºncelleme fonksiyonu
const updateFkontrol = async (kod, isChecked) => {
    try {
        // Backend'e FKONTROL deƒüerini g√∂nder
        await fetch('http://192.168.30.4:3000/update-details', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                KOD: kod,
                FKONTROL: isChecked ? 1 : 0,
                FKONTROLNOTES: isChecked ? undefined : '', // Tiki kaldƒ±rƒ±lƒ±rsa notlarƒ± sil
            }),
        });

        // ƒ∞lgili notlar alanƒ±nƒ± kontrol et
        const notesInput = document.getElementById(`fkontrolnotes-${kod}`);
        if (!isChecked) {
            notesInput.value = ''; // Not alanƒ±nƒ± temizle
        }
        notesInput.style.display = isChecked ? 'inline-block' : 'none';
    } catch (error) {
        console.error('Checkbox g√ºncelleme hatasƒ±:', error);
    }
};

// Notlar g√ºncelleme fonksiyonu
const updateFkontrolNotes = async (kod, notes) => {
    try {
        await fetch('http://192.168.30.4:3000/update-details', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                KOD: kod,
                FKONTROLNOTES: notes,
            }),
        });
    } catch (error) {
        console.error('Notlar g√ºncelleme hatasƒ±:', error);
    }
};



	const updateKoleksiyon = async (kod, field, value) => {
		const response = await fetch(`http://192.168.30.4:3000/update-details`, {
			method: 'POST',
			headers: {
				'Content-Type': 'application/json'
			},
			body: JSON.stringify({ KOD: kod, [field]: value ? 1 : 0 })
		});
		const result = await response.json();
	};

	const updateNotes = async (kod, notes) => {
		const response = await fetch(`http://192.168.30.4:3000/update-details`, {
			method: 'POST',
			headers: {
				'Content-Type': 'application/json'
			},
			body: JSON.stringify({ KOD: kod, NOTES: notes })
		});
		const result = await response.json();
	};

	document.getElementById('threeProdBtn').addEventListener('click', () => {
		updateColumns(3);
		document.getElementById('threeProdBtn').classList.add('active');
		document.getElementById('fourProdBtn').classList.remove('active');
	});

	document.getElementById('fourProdBtn').addEventListener('click', () => {
		updateColumns(4);
		document.getElementById('fourProdBtn').classList.add('active');
		document.getElementById('threeProdBtn').classList.remove('active');
	});


	applyFiltersButton.addEventListener('click', async () => {
    const initialImageContainer = document.getElementById('initialImageContainer');
    const productContainer = document.getElementById('product-container');
    const adminProductContainer = document.getElementById('admin-product-container');
    
    // Aktif sekmeyi kontrol et (√∂rneƒüin, href deƒüeri)
    const activeTab = document.querySelector(".nav-tabs .nav-link.active");
    let targetContainer;
    if (activeTab && activeTab.getAttribute("href").substring(1) === "adminPanel") {
        targetContainer = adminProductContainer;
    } else {
        targetContainer = productContainer;
    }
    
    // Filtrelerin bo≈ü olup olmadƒ±ƒüƒ±nƒ± kontrol et
    const isAnyFilterSelected =
        basamak2Select.value ||
        basamak4Select.value ||
        anamodelSelect.value ||
        modelSelect.value ||
		kodSelect.value ||
        ebatSelect.value;

    // Eƒüer filtre se√ßilmediyse mesaj g√∂ster
    //if (!isAnyFilterSelected) {
    //    alert('√úr√ºn listelemek i√ßin en az bir filtre se√ßmelisiniz.');
    //    return;
    //}
    
    if (initialImageContainer) {
        initialImageContainer.style.display = 'none';
    }
    targetContainer.style.display = 'flex';
    
    currentPage = 1;
    // Y√ºkleme mesajƒ±nƒ± g√∂ster
    showLoadingMessage();
    
    
    // loadProducts fonksiyonunu, hedef container id'sini parametre olarak verin.
    await loadProducts(currentPage, targetContainer.id);
    
    // ƒ∞≈ülem tamamlandƒ±ktan sonra y√ºkleme mesajƒ±nƒ± gizle
    hideLoadingMessage();
});


	clearFiltersButton.addEventListener('click', clearFilters);
	


	updateColumns(columns);
	</script>
	<script>
	//Slider‚Äôlarƒ±n Dinamik Deƒüerlerini G√ºncelleyin
	
	
	
        // Fotoƒüraf kontrol√º i√ßin yardƒ±mcƒ± fonksiyon
        const checkImageExists = async (url) => {
            return new Promise((resolve) => {
                const img = new Image();
                img.onload = () => resolve(true);
                img.onerror = () => resolve(false);
                img.src = url;
            });
        };

        // Modal'ƒ± a√ßan ve fotoƒüraflarƒ± y√ºkleyen fonksiyon
window.openImageModal = async (productCode) => {
    const modalCarouselInner = document.querySelector('#modalCarouselInner');
    const modalCarouselIndicators = document.querySelector('#modalCarouselIndicators');
    const modalLabel = document.querySelector('#imageModalLabel');

    if (!modalCarouselInner || !modalLabel || !modalCarouselIndicators) {
        console.error('Modal carousel i√ßeriƒüi, indicator veya ba≈ülƒ±k bulunamadƒ±.');
        return;
    }

    // √úr√ºn kodunu modal ba≈ülƒ±ƒüƒ±na ata
    modalLabel.textContent = productCode;

    // Endpoint √ºzerinden resim URL'lerini al (UNC yollarƒ± burada d√∂n√º≈üt√ºr√ºlm√º≈ü oluyor)
    let imageUrls = [];
    try {
        const response = await fetch(`/api/intrafoto/${productCode}`);
        if (response.ok) {
            const data = await response.json();
            imageUrls = data.imageUrls;
        }
    } catch (error) {
        console.error("Resim bilgileri alƒ±nƒ±rken hata:", error);
    }
    // Eƒüer hi√ßbir g√∂rsel bulunamazsa, varsayƒ±lan g√∂rseli ekle
    if (!imageUrls || imageUrls.length === 0) {
        imageUrls = ['/resim/YOK.jpg'];
    }

    // √ñnceki i√ßerikleri temizle
    modalCarouselInner.innerHTML = '';
    modalCarouselIndicators.innerHTML = '';

    // Resim URL'lerine g√∂re carousel √∂ƒüelerini ve indicator'larƒ± olu≈ütur
    imageUrls.forEach((url, index) => {
        const carouselItem = document.createElement('div');
        carouselItem.className = `carousel-item ${index === 0 ? 'active' : ''}`;
        carouselItem.innerHTML = `<img src="${url}" alt="√úr√ºn G√∂rseli" class="d-block w-100">`;
        modalCarouselInner.appendChild(carouselItem);

        const indicator = document.createElement('li');
        indicator.setAttribute('data-target', '#modalCarousel');
        indicator.setAttribute('data-slide-to', index);
        if (index === 0) indicator.classList.add('active');
        modalCarouselIndicators.appendChild(indicator);
    });

    // ƒ∞lk √∂ƒüeyi aktif yap ve modalƒ± g√∂ster
    $('#modalCarousel').carousel(0);
    $('#imageModal').modal('show');
};


	const deleteCart = async (cartId) => {
		const confirmation = confirm("Bu sepeti ve t√ºm i√ßeriƒüini silmek istediƒüinizden emin misiniz?");
		if (!confirmation) return;

		try {
			// Sepet silme API √ßaƒürƒ±sƒ±
			const response = await fetch(`http://192.168.30.4:3000/delete-cart/${cartId}`, {
				method: "DELETE",
			});

			if (!response.ok) throw new Error("Sepet silinemedi.");

			const result = await response.json();
			if (result.success) {
				alert("Sepet ve i√ßeriƒüi ba≈üarƒ±yla silindi!");
				showCartList(); // Listeyi g√ºncelle
			} else {
				alert(result.message || "Sepet silinirken bir hata olu≈ütu.");
			}
		} catch (error) {
			console.error("Sepet silme hatasƒ±:", error);
			alert("Sepet silinemedi. L√ºtfen tekrar deneyin.");
		}
	};
	
	document.addEventListener("DOMContentLoaded", () => {
    const adminTabs = document.getElementById("adminTabs");
    const logoContainer = document.getElementById("logoContainer");

    // **Admin olup olmadƒ±ƒüƒ±nƒ± localStorage'dan kontrol et**
    const isAdmin = localStorage.getItem("isAdmin") === "true"; // Admin kontrol√º

    if (isAdmin) {
        adminTabs.style.display = "flex"; // **Admin sekmelerini a√ß**
        logoContainer.classList.add("admin-active"); // **Logoyu sekmelerin hizasƒ±na getir**
    } else {
        adminTabs.style.display = "none"; // **Normal kullanƒ±cƒ± ise sekmeler g√∂r√ºnmesin**
        logoContainer.classList.remove("admin-active"); // **Logo ortada kalsƒ±n**
    }
});

// üìä G√ºnl√ºk Sipari≈ü ve Teklif Grafiƒüini Y√ºkle ve G√ºncelle
let dailyOrdersChart, dailyOffersChart;
const updateSummaryTable = (ordersData) => {
    const weekDays = ["PAZARTESƒ∞", "SALI", "√áAR≈ûAMBA", "PER≈ûEMBE", "CUMA", "CUMARTESƒ∞", "PAZAR"];
    const summaryTableBody = document.getElementById("summaryTableBody");
    const totalSiparisEl = document.getElementById("totalSiparis");
    const totalTeklifEl = document.getElementById("totalTeklif");

    let totalSiparis = 0;
    let totalTeklif = 0;

    // üìå √ñnce tabloyu temizleyelim
    summaryTableBody.innerHTML = "";

    weekDays.forEach(day => {
        const siparisTotal = ordersData
            .filter(order => order.GUN === day && order.TIP === "SIPARIS")
            .reduce((sum, order) => sum + order.TOPLAM_SIPARIS, 0);

        const teklifTotal = ordersData
            .filter(order => order.GUN === day && order.TIP === "TEKLIF")
            .reduce((sum, order) => sum + order.TOPLAM_SIPARIS, 0);

        totalSiparis += siparisTotal;
        totalTeklif += teklifTotal;

        const row = `
            <tr>
                <td>${day}</td>
                <td>${siparisTotal.toLocaleString('tr-TR', { style: 'currency', currency: 'USD' })}</td>
                <td>${teklifTotal.toLocaleString('tr-TR', { style: 'currency', currency: 'USD' })}</td>
            </tr>
        `;
        summaryTableBody.innerHTML += row;
    });

    // üìå Alt toplamlarƒ± g√ºncelle
    totalSiparisEl.innerText = totalSiparis.toLocaleString('tr-TR', { style: 'currency', currency: 'USD' });
    totalTeklifEl.innerText = totalTeklif.toLocaleString('tr-TR', { style: 'currency', currency: 'USD' });
};

//Aylƒ±k √ñzet Tablosunu Dinamik Olarak Doldurma
const updateMonthlySummaryTable = async () => {
  try {
    const response = await fetch('/api/monthly-summary?year=' + new Date().getFullYear());
    if (!response.ok) throw new Error("Aylƒ±k veriler alƒ±namadƒ±.");
    const result = await response.json();
    if (!result.success) {
      throw new Error("Aylƒ±k veriler alƒ±namadƒ±.");
    }
    const monthlyData = result.data; // Yeni endpoint, { success, data } ≈üeklinde d√∂ner.
    const tbody = document.getElementById('monthlySummaryTableBody');
    tbody.innerHTML = "";
    
    // Toplamlarƒ± tutacak deƒüi≈ükenler
    let sumDekor = 0, sumDeri = 0, sumDiger = 0, sumToplam = 0;
    
    // Her bir ay i√ßin satƒ±r olu≈üturup toplamlarƒ± g√ºncelleyelim
    monthlyData.forEach(item => {
      // √ñnceki aya g√∂re deƒüi≈üim hesaplamasƒ± (y√ºzde)
      let change = "N/A";
      if (item.ONCEKI_TOPLAM && Number(item.ONCEKI_TOPLAM) !== 0) {
        change = (((Number(item.TOPLAM) - Number(item.ONCEKI_TOPLAM)) / Number(item.ONCEKI_TOPLAM)) * 100).toFixed(1) + "%";
      }
      
      // Artƒ±≈ü veya azalƒ±≈üa g√∂re stil uygulamasƒ± (artƒ±≈ü ye≈üil, azalƒ±≈ü kƒ±rmƒ±zƒ±)
      let changeStyle = "";
      if (item.ONCEKI_TOPLAM && Number(item.TOPLAM) > Number(item.ONCEKI_TOPLAM)) {
        changeStyle = 'style="color:green;"';
      } else if (item.ONCEKI_TOPLAM && Number(item.TOPLAM) < Number(item.ONCEKI_TOPLAM)) {
        changeStyle = 'style="color:red;"';
      }
      
      // Sayƒ±larƒ±n doƒüru hesaplanabilmesi i√ßin Number() kullanƒ±yoruz.
      sumDekor += Number(item.DEKOR) || 0;
      sumDeri += Number(item.DERI) || 0;
      sumDiger += Number(item.DIGER) || 0;
      sumToplam += Number(item.TOPLAM) || 0;
      
      const row = `
        <tr>
          <td>${item.AY}</td>
          <td>${Number(item.DEKOR).toLocaleString('tr-TR', { style: 'currency', currency: 'USD' })}</td>
          <td>${Number(item.DERI).toLocaleString('tr-TR', { style: 'currency', currency: 'USD' })}</td>
          <td>${Number(item.DIGER).toLocaleString('tr-TR', { style: 'currency', currency: 'USD' })}</td>
          <td>${Number(item.TOPLAM).toLocaleString('tr-TR', { style: 'currency', currency: 'USD' })}</td>
          <td ${changeStyle}>${change}</td>
        </tr>
      `;
      tbody.innerHTML += row;
    });
    
    // Alt toplam satƒ±rƒ±nƒ± ekleyelim
    const totalRow = `
      <tr>
        <td><strong>Toplam</strong></td>
        <td><strong>${sumDekor.toLocaleString('tr-TR', { style: 'currency', currency: 'USD' })}</strong></td>
        <td><strong>${sumDeri.toLocaleString('tr-TR', { style: 'currency', currency: 'USD' })}</strong></td>
        <td><strong>${sumDiger.toLocaleString('tr-TR', { style: 'currency', currency: 'USD' })}</strong></td>
        <td><strong>${sumToplam.toLocaleString('tr-TR', { style: 'currency', currency: 'USD' })}</strong></td>
        <td></td>
      </tr>
    `;
    tbody.innerHTML += totalRow;
    
  } catch (error) {
    console.error("Aylƒ±k √∂zet g√ºncelleme hatasƒ±:", error);
  }
};

updateMonthlySummaryTable();

//Top10 M√º≈üteri Performans Raporu
const loadTop10CustomerPerformance = async () => {
  try {
    const response = await fetch('/api/top10-customer-performance');
    if (!response.ok) {
      throw new Error('Top 10 m√º≈üteri performansƒ± verileri alƒ±namadƒ±.');
    }
    const result = await response.json();
    if (!result.success) {
      throw new Error('Veriler √ßekilirken bir hata olu≈ütu.');
    }
    const data = result.data;

    // Para birimi formatlamasƒ± i√ßin yardƒ±mcƒ± fonksiyon (USD √∂rneƒüi)
    const formatCurrency = (value) => {
      return Number(value).toLocaleString('tr-TR', { style: 'currency', currency: 'USD' });
    };

    const tbody = document.getElementById('top10CustomerPerformanceTableBody');
    tbody.innerHTML = ""; // Tabloyu temizle

    // Verileri SATISGRUP alanƒ±na g√∂re grupluyoruz
    const groupedData = data.reduce((groups, item) => {
      const group = item.SATISGRUP || "Bilinmiyor";
      if (!groups[group]) {
        groups[group] = [];
      }
      groups[group].push(item);
      return groups;
    }, {});

    // Her grup i√ßin: √∂nce grup ba≈ülƒ±ƒüƒ±, ardƒ±ndan satƒ±rlarƒ± ve alt toplam satƒ±rƒ±nƒ± ekleyelim
    Object.keys(groupedData).forEach(groupKey => {
      const groupRows = groupedData[groupKey];

      // Grup ba≈ülƒ±ƒüƒ± satƒ±rƒ±
      const groupHeaderRow = document.createElement('tr');
      groupHeaderRow.innerHTML = `<tr><th>Satƒ±≈ü Grubu</th><th> M√º≈üteri Adƒ±</th><th>√ñnceki Yƒ±l Toplam</th><th>√ñnceki Yƒ±l Ortalama</th><th>Bu Yƒ±l Toplam</th><th>Bu Yƒ±l Ortalama</th><th>Oran</th></tr>`;
      tbody.appendChild(groupHeaderRow);
							  
		
      // √ñnce grubun toplam CurrentYearTotal'ƒ±nƒ± hesaplayalƒ±m
      const groupTotalCurrentYear = groupRows.reduce((sum, item) => sum + Number(item.CurrentYearTotal), 0);

      // Diƒüer alt toplamlarƒ± da hesaplayabiliriz
      const subtotalPrevYearTotal = groupRows.reduce((sum, item) => sum + Number(item.PrevYearTotal), 0);
      const subtotalPrevYearAvg = groupRows.reduce((sum, item) => sum + Number(item.PrevYearAvg), 0);
      const subtotalCurrentYearAvg = groupRows.reduce((sum, item) => sum + Number(item.CurrentYearAvg), 0);

      // Her satƒ±r i√ßin: oran = (item.CurrentYearTotal / groupTotalCurrentYear) * 100
      groupRows.forEach(item => {
        const ratio = groupTotalCurrentYear > 0 
          ? ((Number(item.CurrentYearTotal) / groupTotalCurrentYear) * 100)
          : 0;
        const ratioFormatted = groupTotalCurrentYear > 0 ? ratio.toFixed(1) + "%" : "N/A";

        const row = document.createElement('tr');
        row.innerHTML = `
          <td>${item.SATISGRUP}</td>
          <td style="text-align: left;">${item.ADI}</td>
          <td>${formatCurrency(item.PrevYearTotal)}</td>
          <td>${formatCurrency(item.PrevYearAvg)}</td>
          <td>${formatCurrency(item.CurrentYearTotal)}</td>
          <td>${formatCurrency(item.CurrentYearAvg)}</td>
          <td>${ratioFormatted}</td>
        `;
        tbody.appendChild(row);
      });

      // Grup alt toplam satƒ±rƒ±
      const subtotalRow = document.createElement('tr');
      subtotalRow.style.fontWeight = "bold";
      subtotalRow.style.backgroundColor = "#f2f2f2";
      subtotalRow.innerHTML = `
        <td colspan="2">Toplam (${groupKey})</td>
        <td>${formatCurrency(subtotalPrevYearTotal)}</td>
        <td>${formatCurrency(subtotalPrevYearAvg)}</td>
        <td>${formatCurrency(groupTotalCurrentYear)}</td>
        <td>${formatCurrency(subtotalCurrentYearAvg)}</td>
        <td>${groupTotalCurrentYear !== 0 ? "100%" : "N/A"}</td>
		
      `;
      tbody.appendChild(subtotalRow);
	  
	  const bosRow = document.createElement('tr');
      bosRow.style.fontWeight = "bold";
      bosRow.style.backgroundColor = "#f2f2f2";
      bosRow.innerHTML = `
	  <td colspan="2"></td>
        <td></td>
        <td></td>
        <td></td>
        <td></td>
        <td></td>
		
      `;
      tbody.appendChild(bosRow);
	  
    });
  } catch (error) {
    console.error("Top 10 m√º≈üteri performansƒ± g√ºncelleme hatasƒ±:", error);
  }
};

// Sayfa y√ºklendiƒüinde √ßalƒ±≈ütƒ±r
loadTop10CustomerPerformance();


// üìå Grafikleri y√ºkledikten sonra tabloyu g√ºncelle
const loadDailyOrdersChart = async () => {
    try {
        if (typeof Chart === "undefined") {
            console.error("Chart.js y√ºklenmedi! L√ºtfen k√ºt√ºphaneyi eklediƒüinizden emin olun.");
            return;
        }

        const response = await fetch("http://192.168.30.4:3000/api/orders-daily");
        if (!response.ok) throw new Error("G√ºnl√ºk sipari≈ü verileri alƒ±namadƒ±.");

        const ordersData = await response.json();

        if (ordersData.length === 0) {
            console.warn("Bu hafta i√ßin sipari≈ü verisi bulunamadƒ±.");
            return;
        }

        // üìå √ñzet tabloyu g√ºncelle
        updateSummaryTable(ordersData);

        const weekDays = ["PAZARTESƒ∞", "SALI", "√áAR≈ûAMBA", "PER≈ûEMBE", "CUMA", "CUMARTESƒ∞", "PAZAR"];
        const groupNames = [...new Set(ordersData.map(order => order.SATISGRUP))];
		// üìå Daha Sof Pastel Renkler
		const pastelColors = [
			"rgba(75, 192, 192, 0.6)",  // Soft Mavi-Ye≈üil
			"rgba(153, 102, 255, 0.6)", // Soft Mor
			"rgba(255, 159, 64, 0.6)",  // Soft Turuncu
			"rgba(54, 162, 235, 0.6)",  // Soft Mavi
			"rgba(201, 203, 207, 0.6)", // Soft Gri
			"rgba(255, 205, 86, 0.6)",  // Soft Sarƒ±
			"rgba(233, 150, 122, 0.6)", // Soft Mercan
		];

		// üìå Daha Hafif Kenarlƒ±k Renkleri
		const pastelBorders = [
			"rgba(75, 192, 192, 1)",
			"rgba(153, 102, 255, 1)",
			"rgba(255, 159, 64, 1)",
			"rgba(54, 162, 235, 1)",
			"rgba(201, 203, 207, 1)",
			"rgba(255, 205, 86, 1)",
			"rgba(233, 150, 122, 1)"
		];

        const createDataset = (tip) => {
			return groupNames.map((group, index) => {
				return {
					label: `${group} (${tip === 'SIPARIS' ? "Sƒ∞PARƒ∞≈û" : "TEKLƒ∞F"})`,
					data: weekDays.map(day => {
						const order = ordersData.find(o => o.GUN === day && o.SATISGRUP === group && o.TIP === tip);
						return order ? order.TOPLAM_SIPARIS : 0;
					}),
					backgroundColor: pastelColors[index % pastelColors.length],  // üìå Sof Renkler Kullanƒ±ldƒ±
					borderColor: pastelBorders[index % pastelBorders.length],   // üìå Hafif Kenarlƒ±klar
					borderWidth: 1
				};
			});
		};


        const ctxOrders = document.getElementById("dailyOrdersChart")?.getContext("2d");
        const ctxOffers = document.getElementById("dailyOffersChart")?.getContext("2d");

        if (!ctxOrders || !ctxOffers) {
            console.error("Grafik canvaslarƒ± bulunamadƒ±!");
            return;
        }

        if (dailyOrdersChart) dailyOrdersChart.destroy();
        if (dailyOffersChart) dailyOffersChart.destroy();

        const commonOptions = {
            responsive: true,
            plugins: {
                tooltip: {
                    callbacks: {
                        label: function(tooltipItem) {
                            return tooltipItem.raw.toLocaleString('tr-TR', { style: 'currency', currency: 'USD' });
                        }
                    }
                },
                legend: {
                    position: "top"
                }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    title: { display: true, text: "Tutar (USD)" }
                },
                x: {
                    title: { display: true, text: "Haftanƒ±n G√ºnleri" }
                }
            }
        };

        dailyOrdersChart = new Chart(ctxOrders, {
            type: "bar",
            data: { labels: weekDays, datasets: createDataset('SIPARIS') },
            options: commonOptions
        });

        dailyOffersChart = new Chart(ctxOffers, {
            type: "bar",
            data: { labels: weekDays, datasets: createDataset('TEKLIF') },
            options: commonOptions
        });

    } catch (error) {
        console.error("G√ºnl√ºk grafik y√ºklenirken hata olu≈ütu:", error);
    }
};

loadDailyOrdersChart();
//2 dakikada bir raporlarƒ± yenile
setInterval(() => {
  loadDailyOrdersChart();
  updateMonthlySummaryTable();
  loadTop10CustomerPerformance();
}, 2 * 60 * 1000);



//Tab tƒ±klama dinleyicisi
document.querySelectorAll(".nav-tabs .nav-link").forEach(tab => {
    tab.addEventListener("click", function () {
        const targetTab = this.getAttribute("href").substring(1); // Aktif sekmeyi al
		const filterContainer = document.getElementById('filter-container'); // Global element her seferinde se√ßiliyor

        let targetContainerId = "";
        if (targetTab === "home") {
            targetContainerId = "product-container";
			//product-container.style.display = "block";

        } else if (targetTab === "adminPanel") {
            targetContainerId = "admin-product-container";
        }

        // üìå **Eƒüer raporlar sekmesi se√ßildiyse, grafiƒüi y√ºkle ve image container'ƒ± gizle**
        if (targetTab === "reports") {
            if (initialImageContainer) {
                initialImageContainer.style.display = "none";
            }
			if (filterContainer) {
				filterContainer.style.display = 'none';
			}
            loadDailyOrdersChart(); // üìä Haftalƒ±k grafik verisini y√ºkle
            return; // üìå **Fonksiyondan √ßƒ±k, loadProducts √ßaƒürƒ±lmasƒ±n**
			
        }

        // üìå **Eƒüer diƒüer sekmeler se√ßildiyse, √ºr√ºnleri y√ºkle**
        if (targetContainerId) {
            filterContainer.style.display = 'block';
			//loadProducts(1, targetContainerId);
        }
    });
});
//Banner Modalƒ±nƒ± A√ßan Fonksiyon
function openBannerSelection(cartId) {
    fetch('/api/get-banner-images')
        .then(response => response.json())
        .then(images => {
            const modalBody = document.getElementById("bannerImagesContainer"); // üìå Doƒüru ID

            // üìå Eƒüer modal bulunamazsa, hata ver ve √ßƒ±k
            if (!modalBody) {
                console.error("üìå HATA: Modal body bulunamadƒ±! 'bannerImagesContainer' id'sini kontrol edin.");
                return;
            }

            modalBody.innerHTML = ""; // √ñnce temizleyelim

            images.forEach(image => {
                const imageName = image.replace(".jpg", "").replace(".png", ""); // üìå .jpg ve .png uzantƒ±sƒ±nƒ± kaldƒ±r

                // üìå **Container Olu≈ütur**
                const imageContainer = document.createElement("div");
                imageContainer.className = "banner-item";
                imageContainer.style.textAlign = "center";
                imageContainer.style.margin = "10px";

                // üìå **G√∂rseli Olu≈ütur**
                const imgElement = document.createElement("img");
                imgElement.src = `/resim/banner/${image}`;
                imgElement.className = "banner-thumbnail"; // CSS Sƒ±nƒ±fƒ± (Gerekirse ekleyin)
                imgElement.style.cursor = "pointer";
                imgElement.style.border = "1px solid #ddd";
                imgElement.style.padding = "5px";
                imgElement.style.borderRadius = "8px";
                imgElement.style.maxWidth = "150px";
                imgElement.onclick = () => updateCartBanner(cartId, image);

                // üìå **ƒ∞smi Yazdƒ±r**
                const nameElement = document.createElement("div");
                nameElement.textContent = imageName;
                nameElement.style.fontSize = "14px";
                nameElement.style.marginTop = "5px";
                nameElement.style.color = "#333";
                nameElement.style.fontWeight = "bold";

                // üìå **Container‚Äôa Ekleyelim**
                imageContainer.appendChild(imgElement);
                imageContainer.appendChild(nameElement);
                modalBody.appendChild(imageContainer);
            });

            $('#bannerSelectionModal').modal('show'); // üìå Modalƒ± A√ß
        })
        .catch(error => console.error("Banner y√ºklenirken hata olu≈ütu:", error));
}

//Se√ßilen Banner'ƒ± G√ºncelleme Fonksiyonu
function updateCartBanner(cartId, bannerFileName) {
    fetch(`/api/update-cart-banner`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
            cartId,
            bannerPath: `/resim/banner/${bannerFileName}`
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            document.getElementById("conceptBannerImg").src = `/resim/banner/${bannerFileName}`;
            $('#bannerSelectionModal').modal('hide'); // Modalƒ± kapat
        } else {
            alert("Banner g√ºncellenemedi!");
        }
    })
    .catch(error => console.error("Banner g√ºncellenirken hata olu≈ütu:", error));
}


//Se√ßilen Banner‚Äôƒ± G√ºncelleyen Fonksiyon
function selectBannerImage(cartId, imageName) {
    const bannerPath = `/resim/banner/${imageName}`;
    document.getElementById("conceptBannerImage").src = bannerPath;

    // üìå Se√ßimi kaydet (CART tablosuna g√ºncelleme g√∂nderiyoruz)
    fetch('/api/update-cart-banner', {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ cartId, banner: bannerPath })
    }).then(() => {
        $('#bannerSelectionModal').modal('hide'); // Modalƒ± kapat
    });
}

//// üìå Dropdown'un a√ßƒ±lma y√∂n√ºn√º kontrol et
$('.selectpicker').on('show.bs.select', function () {
    const $menu = $(this).next('.dropdown-menu');
    const windowHeight = $(window).height();
    const dropdownTop = $(this).offset().top;
    const dropdownHeight = $menu.outerHeight();

    // Eƒüer dropdown ekranƒ±n altƒ±na ta≈üƒ±yorsa √ºste a√ß
    if (dropdownTop + dropdownHeight > windowHeight) {
        $menu.css({ top: 'auto', bottom: '100%', transform: 'translateY(-5px)' });
    } else {
        $menu.css({ top: '100%', bottom: 'auto', transform: 'translateY(5px)' });
    }
});

</script>
<script>
//Y√ºkleme animasyonunu g√∂ster
const showLoadingMessage = () => {
    const loadingMessage = document.getElementById("loadingMessage");
    if (loadingMessage) {
        loadingMessage.style.display = "flex";
        loadingMessage.style.opacity = "1";
    }
};
//Y√ºkleme animasyonunu gizle
const hideLoadingMessage = () => {
    const loadingMessage = document.getElementById("loadingMessage");
    if (loadingMessage) {
        loadingMessage.style.opacity = "0"; // G√∂r√ºnmezlik i√ßin animasyon
        setTimeout(() => {
            loadingMessage.style.display = "none"; // Tamamen kaldƒ±r
        }, 300); // Opaklƒ±k sƒ±fƒ±rlandƒ±ktan sonra 300ms bekle
    }
};

</script>

	
	<script>
		document.addEventListener('DOMContentLoaded', () => {
    const exportExcelButton = document.getElementById('exportExcelButton');
    
    if (exportExcelButton) {
        exportExcelButton.addEventListener('click', async () => {

            // üìå **Yalnƒ±zca g√∂r√ºnen √ºr√ºnleri al (`display !== none`)**
            const productDivs = document.querySelectorAll('.product');
            const visibleProducts = Array.from(productDivs).filter(div => div.style.display !== 'none');

            const products = visibleProducts.map(div => {
                const tdElements = div.querySelectorAll('td');
                let BASAMAK2, BASAMAK4, KOD, MODEL, EBAT, RENK, DESEN, LAMINE, LEG, SFIYAT1, SFIYAT4, STOK, HM, KOLEKSIYON, NOTES;

                tdElements.forEach(td => {
                    const nextTd = td.nextElementSibling;
                    const nextText = nextTd ? nextTd.textContent.trim() : "";

                    if (td.textContent.includes('KATEGORƒ∞')) BASAMAK2 = nextText;
                    if (td.textContent.includes('ALT KATEGORI')) BASAMAK4 = nextText;
                    if (td.textContent.includes('KOD')) KOD = nextText;
                    if (td.textContent.includes('MODEL')) MODEL = nextText;
                    if (td.textContent.includes('EBAT')) EBAT = nextText;
                    if (td.textContent.includes('RENK')) RENK = nextText;
                    if (td.textContent.includes('DESEN')) DESEN = nextText;
                    if (td.textContent.includes('LAMINE')) LAMINE = nextText;
                    if (td.textContent.includes('AYAK')) LEG = nextText;
                    if (td.textContent.includes('PRK TL')) {
						const priceMatch = nextText.match(/(\d{1,3}(\.\d{3})*,\d{2})/); // TL fiyatƒ±nƒ± bul (√∂rn: 36.600,00)
						SFIYAT1 = priceMatch ? priceMatch[0].replace(/\./g, '').replace('.', ',') : "0"; // Noktalarƒ± kaldƒ±r, virg√ºl√º noktaya √ßevir
					}
					if (td.textContent.includes('USD')) {
						const usdMatch = nextText.match(/\$(\d+,\d{2})/); // USD fiyatƒ±nƒ± bul (√∂rn: $990,00)
						SFIYAT4 = usdMatch ? usdMatch[1].replace('.', ',') : "0"; // Sadece rakam kƒ±smƒ±nƒ± al
					}
                    if (td.textContent.includes('STOK')) STOK = nextText.split(' ')[0];
                    if (td.textContent.includes('HM')) HM = nextText.split(' ')[2] || "";
                    if (td.textContent.includes('KOLEKSIYON')) KOLEKSIYON = nextText;
                });

                NOTES = div.querySelector('textarea')?.value?.trim() || '';

                return {
                    BASAMAK2, BASAMAK4, KOD, MODEL, EBAT, RENK, DESEN, LAMINE, LEG,
                    SFIYAT1, SFIYAT4, STOK, HM, KOLEKSIYON, NOTES
                };
            });

            if (products.length > 0) {
                await exportToExcelWithImages(products);
            } else {
                
            }
        });
    }
});

// üìå **Excel'e aktarma fonksiyonu**
const exportToExcelWithImages = async (products) => {
    const workbook = new ExcelJS.Workbook();
    const worksheet = workbook.addWorksheet('√úr√ºnler');

    worksheet.columns = [
        { header: '√úr√ºn Foto', key: 'image', width: 17 },
        { header: 'KATEGORƒ∞', key: 'BASAMAK2', width: 15 },
        { header: 'ALT KATEGORƒ∞', key: 'BASAMAK4', width: 15 },
        { header: 'KOD', key: 'KOD', width: 15 },
        { header: 'MODEL', key: 'MODEL', width: 15 },
        { header: 'EBAT', key: 'EBAT', width: 15 },
        { header: 'RENK', key: 'RENK', width: 15 },
        { header: 'DESEN', key: 'DESEN', width: 15 },
        { header: 'LAMINE', key: 'LAMINE', width: 15 },
        { header: 'AYAK', key: 'LEG', width: 15 },
        { header: 'PRK TL', key: 'SFIYAT1', width: 15 },
        { header: 'PRK USD', key: 'SFIYAT4', width: 15 },
        { header: 'STOK', key: 'STOK', width: 15 },
        { header: 'HM', key: 'HM', width: 15 },
        { header: 'KOLEKSIYON', key: 'KOLEKSIYON', width: 15 },
        { header: 'NOTLAR', key: 'NOTES', width: 30 }
    ];

    for (const [index, product] of products.entries()) {
        const rowNumber = index + 2; // ƒ∞lk satƒ±r ba≈ülƒ±k i√ßin kullanƒ±ldƒ±ƒüƒ± i√ßin 2'den ba≈ülar
        const row = worksheet.addRow({
            BASAMAK2: product.BASAMAK2,
            BASAMAK4: product.BASAMAK4,
            KOD: product.KOD,
            MODEL: product.MODEL,
            EBAT: product.EBAT,
            RENK: product.RENK,
            DESEN: product.DESEN,
            LAMINE: product.LAMINE,
            LEG: product.LEG,
            SFIYAT1: product.SFIYAT1,
            SFIYAT4: product.SFIYAT4,
            STOK: product.STOK,
            HM: product.HM,
            KOLEKSIYON: product.KOLEKSIYON,
            NOTES: product.NOTES
        });

        // üìå **Resmi Carousel'den Al**
        const imgElement = document.querySelector(`#carousel${product.KOD} .carousel-item:first-child img`);
        const imgSrc = imgElement ? imgElement.getAttribute('src') : '/resim/YOK.jpg';

        try {
            const imageBuffer = await fetch(imgSrc).then(res => res.arrayBuffer());

            const imageId = workbook.addImage({
                buffer: imageBuffer,
                extension: 'jpeg'
            });

            worksheet.addImage(imageId, {
                tl: { col: 0, row: rowNumber - 1, rowOffset: 5 },
                ext: { width: 100, height: 100 }
            });

            worksheet.getRow(rowNumber).height = 102;
        } catch (error) {
            console.error(`Resim y√ºklenemedi: ${imgSrc}`);
        }
    }

    workbook.xlsx.writeBuffer().then(buffer => {
        const blob = new Blob([buffer], { type: 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet' });
        const link = document.createElement('a');
        link.href = URL.createObjectURL(blob);
        link.download = 'urunler.xlsx';
        link.click();
    });
};



	</script>
	<script>
	let activeCartId = null; // ≈ûu anda aktif olan sepet kimliƒüi

	const updateCartButtonState = () => {
		const viewCartButton = document.querySelector('#viewCartButton');
		if (!viewCartButton) {
			
			return;
		}
		// Butonu her zaman etkin bƒ±rak
		viewCartButton.disabled = false;
		viewCartButton.title = '';
	};

	// Sepet Olu≈üturma Fonksiyonu
const createCart = async () => {
  const userId = localStorage.getItem('userId');
  if (!userId) {
    alert('L√ºtfen √∂nce giri≈ü yapƒ±n.');
    return;
  }

  // Form alanlarƒ±ndan verileri alƒ±yoruz:
  const customerType = document.getElementById('customerType').value || 'perakende';
  const salesArea = document.getElementById('salesArea').value || 'yurtici';
  const customerName = document.getElementById('cartName').value.trim() || 'Anonim M√º≈üteri';
  const priceType = document.getElementById('priceType').value || '1';
  const discountRate = parseFloat(document.getElementById('discountRate').value) || 0;
  const vatIncluded = document.getElementById('vatIncluded').value || '1';

  try {
    const response = await fetch('http://192.168.30.4:3000/create-cart', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ userId, customerType, salesArea, customerName, priceType, discountRate, vatIncluded }),
    });

    const data = await response.json();

    if (response.ok && data.success) {
      alert('Sepet ba≈üarƒ±yla olu≈üturuldu!');
      activeCartId = data.cartId; // Aktif sepet kimliƒüini g√ºncelle

      // Sepet olu≈üturulduktan sonra formu kapatma
      $('#cartFormModal').modal('hide');

      // Sepetler listesini g√ºncelleme
      showCartList();
    } else {
      alert(data.message || 'Sepet olu≈üturulamadƒ±.');
    }
  } catch (error) {
    console.error('Sepet olu≈üturma hatasƒ±:', error);
    alert('Bir hata olu≈ütu. L√ºtfen tekrar deneyin.');
  }
};


	// Sayfa ilk y√ºklendiƒüinde butonun durumunu kontrol et
	document.addEventListener('DOMContentLoaded', () => {
		updateCartButtonState();
	});

	// Sepete √ºr√ºn ekleme
	const addToCart = async (productId) => {
		try {
			// Aktif bir sepet yoksa kullanƒ±cƒ±yƒ± uyar ve modalƒ± g√∂ster
			if (!activeCartId) {
				alert('L√ºtfen √∂nce bir sepet olu≈üturun veya bir sepet se√ßin.');
				$('#cartModal').modal('show');
				return;
			}

			// Sepete √ºr√ºn ekleme i√ßin veri olu≈üturma
			const cartData = {
				cartId: activeCartId,
				productId,
				quantity: 1 // Varsayƒ±lan miktar
			};

			// Sepete √ºr√ºn ekleme API √ßaƒürƒ±sƒ±
			const response = await fetch('http://192.168.30.4:3000/cart/item', {
				method: 'POST',
				headers: { 'Content-Type': 'application/json' },
				body: JSON.stringify(cartData)
			});

			// Yanƒ±t doƒürulama
			if (!response.ok) {
				const errorText = await response.text();
				throw new Error(`Hata: ${response.status} - ${errorText}`);
			}

			const result = await response.json();

			if (result.success) {
				alert('√úr√ºn sepete ba≈üarƒ±yla eklendi!');
				await showCartContents(); // Sepeti yeniden y√ºkle
				updateCartSummary(); // Yeni eklenen √∂zet g√ºncelleme √ßaƒürƒ±sƒ±
				updateCartFreightInsurance;
				
			} else {
				throw new Error(result.message || '√úr√ºn sepete eklenemedi.');
			}
		} catch (error) {
			console.error('Sepete ekleme hatasƒ±:', error);
			alert(`Bir hata olu≈ütu: ${error.message}`);
		}
	};





	// Aktif sepeti belirleme
	const setActiveCart = async (cartId) => {
		activeCartId = cartId;
		$('#cartListModal').modal('hide');
		await showCartContents();
	};



	// Sepeti temizleme
const clearCart = async () => {
  if (!activeCartId) {
    alert('Aktif bir sepet bulunamadƒ±.');
    return;
  }
  
  // Temizleyen kullanƒ±cƒ± ID'sini localStorage'dan alƒ±yoruz (veya ba≈üka bir yerden)
  const clearedBy = localStorage.getItem('userId');
  
  try {
    const response = await fetch(`http://192.168.30.4:3000/clear-cart/${activeCartId}`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ cleared_by: clearedBy })
    });
    
    if (!response.ok) throw new Error('Sepet temizlenemedi.');
    
    alert('Sepet temizlendi!');
    showCartContents(); // Sepeti g√ºncel haliyle g√∂ster
  } catch (error) {
    console.error('Sepet temizleme hatasƒ±:', error);
    alert('Sepet temizlenemedi.');
  }
};



	// √úr√ºn√º sepetten kaldƒ±rma
	const removeFromCart = async (cartItemId) => {
		try {
			const response = await fetch(`http://192.168.30.4:3000/remove-from-cart/${cartItemId}`, {
				method: 'DELETE'
			});

			if (!response.ok) throw new Error('√úr√ºn kaldƒ±rƒ±lamadƒ±.');

			const result = await response.json();

			if (result.success) {
				alert('√úr√ºn ba≈üarƒ±yla kaldƒ±rƒ±ldƒ±.');
				showCartContents(); // Sepeti yeniden y√ºkle
				updateCartSummary(); // Yeni eklenen √∂zet g√ºncelleme √ßaƒürƒ±sƒ±
				
			} else {
				throw new Error(result.message || '√úr√ºn kaldƒ±rma sƒ±rasƒ±nda bir hata olu≈ütu.');
			}
		} catch (error) {
			console.error('√úr√ºn kaldƒ±rma hatasƒ±:', error);
			alert(`Bir hata olu≈ütu: ${error.message}`);
		}
	};
// Toggle butonuna tƒ±klandƒ±ƒüƒ±nda:
function toggleConceptCarts() {
  // Modal i√ßerisindeki t√ºm konsept sepet satƒ±rlarƒ±nƒ± se√ß
  const conceptRows = document.querySelectorAll('#cartListModalBody tr.concept-cart');
  
  // Eƒüer en az bir satƒ±r g√∂r√ºn√ºrse, hepsini gizle; aksi halde hepsini g√∂ster.
  let anyVisible = false;
  conceptRows.forEach(row => {
    if (row.style.display !== "none") {
      anyVisible = true;
    }
  });

  conceptRows.forEach(row => {
    row.style.display = anyVisible ? "none" : "";
  });
  
  // Buton metnini g√ºncelle (isteƒüe baƒülƒ±)
  const btn = document.getElementById('toggleConceptCartsBtn');
  btn.innerHTML = anyVisible 
    ? `<i class="fas fa-eye"></i> Konseptleri G√∂ster`
    : `<i class="fas fa-eye-slash"></i> Konseptleri Gizle`;
}


	</script>
	<script>
	// Sepeti y√ºkleme ve √ºr√ºnleri listeleme

		// loadCart fonksiyonunu global alana ta≈üƒ±yoruz
	// Sepeti y√ºkleme ve senaryolarƒ± kontrol etme
	window.loadCart = async () => {
    try {
        const userId = localStorage.getItem('userId'); // Kullanƒ±cƒ± kimliƒüini alƒ±n

        // Kullanƒ±cƒ± giri≈ü yapmamƒ±≈üsa giri≈ü modalƒ±nƒ± g√∂ster
        if (!userId) {
            alert('Sepetleri g√∂r√ºnt√ºlemek i√ßin √∂nce giri≈ü yapmalƒ±sƒ±nƒ±z.');
            $('#loginModal').modal('show');
            return;
        }

        // Kullanƒ±cƒ±nƒ±n sepetlerini API'den al
        const response = await fetch(`http://192.168.30.4:3000/carts/${userId}`);
        if (!response.ok) {
            throw new Error('Sepet listesi alƒ±namadƒ±.');
        }

        const carts = await response.json();

        // Eƒüer kullanƒ±cƒ±ya ait sepet yoksa
        if (carts.length === 0) {
            alert('Hen√ºz bir sepetiniz yok. ≈ûimdi bir sepet olu≈üturun.');
            $('#cartFormModal').modal('show'); // Sepet olu≈üturma modalƒ±nƒ± a√ß
            return;
        }

        // Eƒüer aktif bir sepet varsa, sepet i√ßerik modalƒ±nƒ± a√ß
        if (activeCartId) {
            await showCartContents(); // Aktif sepet i√ßeriƒüini g√∂ster
            return;
        }

        // Aktif sepet yoksa, sepetler listesini g√∂ster
        showCartList(carts);
    } catch (error) {
        console.error('Sepet y√ºkleme hatasƒ±:', error);
        alert('Bir hata olu≈ütu. L√ºtfen tekrar deneyin.');
    }
};

const generatePDF = async (language = "tr") => {
  const { jsPDF } = window.jspdf;
  const doc = new jsPDF({
    orientation: "portrait",
    unit: "mm",
    format: "a4",
  });

  const margin = 3; // Kenar bo≈üluƒüu
  const pageWidth = 210; // A4 geni≈üliƒüi
  const pageHeight = 297; // A4 y√ºksekliƒüi

  // Header, tablo ve footer parametreleri
  const headerHeight = 34; // Header y√ºksekliƒüi (mm)
  const tableStartY = headerHeight + 5; // Tablo header‚Äôdan 5mm a≈üaƒüƒ±dan ba≈ülasƒ±n
  const footerHeight = 20; // Footer y√ºksekliƒüi (mm)

  // Yardƒ±mcƒ±: ArrayBuffer'dan Base64'e d√∂n√º≈üt√ºrme fonksiyonu
  const arrayBufferToBase64 = (buffer) => {
    let binary = "";
    const bytes = new Uint8Array(buffer);
    for (let i = 0; i < bytes.byteLength; i++) {
      binary += String.fromCharCode(bytes[i]);
    }
    return btoa(binary);
  };

  // T√ºrk√ße karakter desteƒüi i√ßin font y√ºkle
  const loadFont = async () => {
    const fontUrl = "/fonts/Roboto-Regular.ttf";
    const fontResponse = await fetch(fontUrl);
    if (!fontResponse.ok) throw new Error("Font y√ºklenemedi.");
    const fontData = await fontResponse.arrayBuffer();
    const fontBase64 = arrayBufferToBase64(fontData);
    doc.addFileToVFS("Roboto-Regular.ttf", fontBase64);
    doc.addFont("Roboto-Regular.ttf", "Roboto", "normal");
    doc.setFont("Roboto");
  };
  await loadFont();

  // Logo y√ºkleme yardƒ±mcƒ± fonksiyonu
  const fetchBlobImage = async (url) => {
    const response = await fetch(url);
    if (!response.ok) throw new Error(`Fotoƒüraf y√ºklenemedi: ${url}`);
    const blob = await response.blob();
    return new Promise((resolve) => {
      const reader = new FileReader();
      reader.onload = () => resolve(reader.result);
      reader.readAsDataURL(blob);
    });
  };

  let logoBase64 = "";
  try {
    logoBase64 = await fetchBlobImage("/resim/EDLogo.png");
  } catch (error) {
    console.error("Logo y√ºklenemedi:", error);
  }

  // Sepet bilgilerini al
  const cartInfoResponse = await fetch(`http://192.168.30.4:3000/cart-info/${activeCartId}`);
  if (!cartInfoResponse.ok) throw new Error("Sepet bilgileri alƒ±namadƒ±.");
  const cartInfo = await cartInfoResponse.json();
  window.currentCartInfo = cartInfo;

  // D√∂viz kontrol√ºn√º g√ºncelleyelim:
  let currency = "TL";
  if (cartInfo.PRICE_TYPE === "4" || cartInfo.PRICE_TYPE === "3") {
    currency = "USD";
  } else if (cartInfo.PRICE_TYPE === "5" || cartInfo.PRICE_TYPE === "6") {
    currency = "EUR";
  }

  // Header ekleme fonksiyonu
  const addHeader = (pageNumber, totalPages) => {
    const headerY = margin;
    // Logo: Saƒü √ºstte
    if (logoBase64) {
      doc.addImage(logoBase64, "JPEG", pageWidth - margin - 50, headerY, 50, 10);
    }
    // Ba≈ülƒ±k (merkeze hizalƒ±)
    doc.setFontSize(22);
    doc.text(language === "tr" ? "Teklif Formu" : "Quotation Form", pageWidth / 2, headerY + 22, { align: "center" });
    // M√º≈üteri Adƒ± (sol alt header)
    doc.setFontSize(10);
    const customerNameLabel = language === "tr" ? "M√º≈üteri Adƒ±:" : "Customer Name:";
    const unknownText = language === "tr" ? "Bilinmiyor" : "Unknown";
    doc.text(`${customerNameLabel} ${cartInfo.CUSTOMER_NAME || unknownText}`, margin, headerY + 28);
    // Tarih ve D√∂viz (saƒü √ºst header)
    doc.setFontSize(8);
    const today = new Date().toLocaleDateString("tr-TR");
    const dateLabel = language === "tr" ? "Tarih:" : "Date:";
    const currencyLabel = language === "tr" ? "D√∂viz Cinsi:" : "Currency:";
    doc.text(`${dateLabel} ${today}`, pageWidth - margin, headerY + 22, { align: "right" });
    doc.text(`${currencyLabel} ${currency}`, pageWidth - margin, headerY + 27, { align: "right" });
    // Sayfa numarasƒ±
    const pageNumText = language === "tr" ? `Sayfa: ${pageNumber} / ${totalPages}` : `Page: ${pageNumber} / ${totalPages}`;
    doc.text(pageNumText, pageWidth - margin, headerY + 32, { align: "right" });
  };

  // T√ºrk√ße karakterleri ƒ∞ngilizce karakterlere d√∂n√º≈üt√ºren yardƒ±mcƒ± fonksiyon
  const replaceTurkishChars = (text) => {
    if (!text) return "";
    return text
      .replace(/≈û/g, 'S')
      .replace(/≈ü/g, 's')
      .replace(/ƒ∞/g, 'I')
      .replace(/ƒ±/g, 'i')
      .replace(/√á/g, 'C')
      .replace(/√ß/g, 'c')
      .replace(/√ú/g, 'U')
      .replace(/√º/g, 'u')
      .replace(/√ñ/g, 'O')
      .replace(/√∂/g, 'o')
      .replace(/ƒû/g, 'G')
      .replace(/ƒü/g, 'g');
  };

  // Footer ekleme fonksiyonu
  const addFooter = () => {
    const footerLine1 = "Estetik Decor - Istanbul - Turkey";
    const footerLine2 = "Tel: +90 216 394 03 06 - info@estetikdecor.com";
    doc.setFontSize(8);
    doc.text(footerLine1, pageWidth / 2, pageHeight - 15, { align: "center" });
    doc.text(footerLine2, pageWidth / 2, pageHeight - 10, { align: "center" });
  };

  // Tablo verileri i√ßin hazƒ±rlƒ±k
  const headers = [
    language === "tr"
      ? ["Fotograf", "√úr√ºn Kodu", "A√ßiklama", "Miktar", "Fiyat", "Ind. %", "Ind. Fiyat", "Tutar"]
      : ["Photo", "Product Code", "Description", "Quantity", "Price", "Disc %", "Disc. Price", "Amount"],
  ];
  const tableImages = [];
  const rows = [];
  let totalQuantity = 0;
  let totalAmount = 0;
  const formatNumber = (value) => {
    const parts = value.toFixed(2).split('.');
    parts[0] = parts[0].replace(/\B(?=(\d{3})+(?!\d))/g, ".");
    return parts.join(",");
  };

  // Sepet verisini PDF i√ßin √ßekiyoruz
  const fetchCartData = async (cartId, language = "tr") => {
    const endpoint = language === "en"
      ? `/api/cart/${cartId}/pdf-data-en`
      : `/api/cart/${cartId}/pdf-data`;
    const response = await fetch(endpoint);
    if (!response.ok) throw new Error("Sepet verisi alƒ±namadƒ±.");
    const result = await response.json();
    if (!result.success) throw new Error(result.message);
    return result.data;
  };

  const cartData = await fetchCartData(activeCartId, language);
  cartData.sort((a, b) => a.PRODUCT_ID.localeCompare(b.PRODUCT_ID));

  // √ñrnekte, eƒüer √ºr√ºn √∂zelle≈ütirilmi≈üse CUSTOM_PRICE ve CUSTOM_DISCOUNT_RATE kullanƒ±lacak ≈üekilde "effective" deƒüerleri belirleyelim:
  const getEffectivePrice = (item) => {
    if (item.CUSTOM_CODE) {
      return item.CUSTOM_PRICE || item.PRICE;
    }
    return item.PRICE;
  };
  const getEffectiveDiscountRate = (item) => {
    if (item.CUSTOM_CODE) {
      return item.CUSTOM_DISCOUNT_RATE || item.DISCOUNT_RATE;
    }
    return item.DISCOUNT_RATE;
  };

  for (const item of cartData) {
    const imageUrl = `/resim/${item.PRODUCT_ID}.jpg`;
    let base64Image = "";
    try {
      base64Image = await fetchBlobImage(imageUrl);
    } catch (error) {
      console.error("Fotoƒüraf y√ºklenemedi:", error);
    }
    if (!base64Image) {
      try {
        base64Image = await fetchBlobImage("/resim/YOK.jpg");
      } catch (error) {
        console.error("Varsayƒ±lan fotoƒüraf y√ºklenemedi:", error);
      }
    }
    tableImages.push({ base64: base64Image, width: 30, height: 30 });
    
    const effectivePrice = item.EFFECTIVE_PRICE || item.PRICE || 0;
    const effectiveDiscountRate = item.EFFECTIVE_DISCOUNT_RATE !== undefined ? item.EFFECTIVE_DISCOUNT_RATE : (item.DISCOUNT_RATE || 0);
    const effectiveDiscPrice = effectivePrice * (1 - effectiveDiscountRate / 100);
    const effectiveTotal = item.EFFECTIVE_TOTAL || (item.QUANTITY * effectivePrice * (1 - effectiveDiscountRate / 100));
    const customValueControl = (item.CUSTOM_CODE || item.CUSTOM_NAME) || "";
    const customValue = (item.CUSTOM_CODE) || "-";
    const productCodeCell = customValueControl !== ""
      ? `${customValue}\n\n${language === "tr" ? "Referans Kod:" : "Reference Code:"} ${item.PRODUCT_ID}`
      : item.PRODUCT_ID;
    rows.push([
      "", // Fotoƒüraf alanƒ±, didDrawCell ile eklenecek
      productCodeCell,
      replaceTurkishChars(item.CUSTOM_NAME ? item.CUSTOM_NAME : item.PRODUCT_NAME),
      item.QUANTITY.toString(),
      formatNumber(effectivePrice),
      `${effectiveDiscountRate}%`,
      formatNumber(effectiveDiscPrice),
      formatNumber(effectiveTotal),
    ]);
    totalQuantity += item.QUANTITY;
    totalAmount += effectiveTotal;
  }

  // jsPDF-AutoTable: √úr√ºn tablosunu ekleyip sola hizalƒ±yoruz.
  doc.autoTable({
    head: headers,
    body: rows,
    startY: tableStartY,
    margin: { top: tableStartY, bottom: footerHeight, left: margin },
    theme: "striped",
    styles: {
      cellPadding: 3,
      fontSize: 8,
      overflow: "linebreak",
      valign: "middle",
      halign: "center",
      minCellHeight: 32,
    },
    headStyles: {
      fillColor: [220, 220, 220],
      fontSize: 8,
      fontStyle: "bold",
      textColor: [102, 102, 102],
      minCellHeight: 10,
    },
    columnStyles: {
      0: { cellWidth: 30 },
      1: { cellWidth: 25, halign: 'left' },
      2: { cellWidth: 45, halign: 'left' },
      3: { cellWidth: 18 },
      4: { cellWidth: 25 },
      5: { cellWidth: 15 },
      6: { cellWidth: 25 },
      7: { cellWidth: 24 },
    },
    didDrawCell: (data) => {
	  if (data.column.index === 0 && data.row.section === "body") {
		const { base64 } = tableImages[data.row.index] || {};
		if (base64) {
		  const totalPages = doc.internal.getNumberOfPages();
		  const currentPage = doc.internal.getCurrentPageInfo().pageNumber;
		  const isLastPage = currentPage === totalPages;
		  const imageSize = isLastPage ? 27 : 30;
		  const x = data.cell.x + 2;
		  const y = data.cell.y + 2;
		  const adjustedHeight = data.cell.height - 4;
		  doc.addImage(base64, "JPEG", x, y, imageSize, adjustedHeight, null, "FAST");
		}
	  }
	},
    didDrawPage: (data) => {
      if (data.pageNumber > 1) {
        doc.autoTable.previous.finalY = tableStartY;
      }
    },
  });

  // finalY yalnƒ±zca bir kere hesaplanƒ±yor:
  const finalY = doc.lastAutoTable ? doc.lastAutoTable.finalY + 5 : tableStartY + 5;

  // Toplam sayfa sayƒ±sƒ±nƒ± hesaplayƒ±p, t√ºm sayfalara header ve footer ekleyelim.
  const totalPages = doc.internal.getNumberOfPages();
  for (let i = 1; i <= totalPages; i++) {
    doc.setPage(i);
    addHeader(i, totalPages);
    addFooter();
  }

  // Alt √∂zet ekle: tablo sonundan 5mm a≈üaƒüƒ±da, saƒüa hizalƒ±
  try {
    const summaryResponse = await fetch(`http://192.168.30.4:3000/cart-summary/${activeCartId}`);
    if (summaryResponse.ok) {
      const summaryData = await summaryResponse.json();
      if (summaryData.success) {
        const xRight = pageWidth - margin;
        doc.setFontSize(8);
        if (cartInfo.SALES_AREA.toLowerCase() === "yurtici") {
          const grossTotal = summaryData.grossTotal;
          const discountTotal = summaryData.discountTotal;
          const netTotal = summaryData.subtotal;
          const vatTotal = summaryData.vatTotal;
          const finalTotal = summaryData.total;
          if (language === "tr") {
            doc.text(`ƒ∞skontosuz Toplam: ${formatNumber(grossTotal)}`, xRight - 3, finalY, { align: "right" });
            doc.text(`Toplam ƒ∞ndirim: ${formatNumber(discountTotal)}`, xRight - 3, finalY + 5, { align: "right" });
            doc.text(`KDV'siz Toplam: ${formatNumber(netTotal)}`, xRight - 3, finalY + 10, { align: "right" });
            doc.text(`KDV: ${formatNumber(vatTotal)}`, xRight - 3, finalY + 15, { align: "right" });
            doc.text(`Toplam: ${formatNumber(finalTotal)}`, xRight - 3, finalY + 20, { align: "right" });
          } else {
            doc.text(`Gross Total: ${formatNumber(grossTotal)}`, xRight - 3, finalY, { align: "right" });
            doc.text(`Total Discount: ${formatNumber(discountTotal)}`, xRight - 3, finalY + 5, { align: "right" });
            doc.text(`Net Total: ${formatNumber(netTotal)}`, xRight - 3, finalY + 10, { align: "right" });
            doc.text(`VAT: ${formatNumber(vatTotal)}`, xRight - 3, finalY + 15, { align: "right" });
            doc.text(`Total: ${formatNumber(finalTotal)}`, xRight - 3, finalY + 20, { align: "right" });
          }
        } else if (cartInfo.SALES_AREA.toLowerCase() === "yurtdisi") {
          const grossTotal = summaryData.grossTotal;
          const discountTotal = summaryData.discountTotal;
          const netTotal = summaryData.subtotal;
          const insurance = summaryData.insurance;
          const freight = summaryData.freight;
          const finalTotal = summaryData.total;
          if (language === "tr") {
            doc.text(`ƒ∞skontosuz Toplam: ${formatNumber(grossTotal)}`, xRight - 3, finalY, { align: "right" });
            doc.text(`Toplam ƒ∞ndirim: ${formatNumber(discountTotal)}`, xRight - 3, finalY + 5, { align: "right" });
            doc.text(`Ara Toplam: ${formatNumber(netTotal)}`, xRight - 3, finalY + 10, { align: "right" });
            doc.text(`Sigorta: ${formatNumber(insurance)}`, xRight - 3, finalY + 15, { align: "right" });
            doc.text(`Navlun: ${formatNumber(freight)}`, xRight - 3, finalY + 20, { align: "right" });
            doc.text(`Toplam: ${formatNumber(finalTotal)}`, xRight - 3, finalY + 25, { align: "right" });
          } else {
            doc.text(`Gross Total: ${formatNumber(grossTotal)}`, xRight - 3, finalY, { align: "right" });
            doc.text(`Total Discount: ${formatNumber(discountTotal)}`, xRight - 3, finalY + 5, { align: "right" });
            doc.text(`Sub-total: ${formatNumber(netTotal)}`, xRight - 3, finalY + 10, { align: "right" });
            doc.text(`Insurance: ${formatNumber(insurance)}`, xRight - 3, finalY + 15, { align: "right" });
            doc.text(`Freight: ${formatNumber(freight)}`, xRight - 3, finalY + 20, { align: "right" });
            doc.text(`Total: ${formatNumber(finalTotal)}`, xRight - 3, finalY + 25, { align: "right" });
          }
        }
      }
    } else {
      console.error("Cart summary fetch failed");
    }
  } catch (error) {
    console.error("Sepet √∂zeti eklenirken hata:", error);
  }

  // ---------- Sipari≈ü √ñzel ≈ûartlarƒ± B√∂l√ºm√º ----------
  const specialConditionsY = doc.lastAutoTable ? doc.lastAutoTable.finalY + 10 : tableStartY + 10;
  doc.setFontSize(8);
  if (language === "tr") {
    doc.text("√ñzel ≈ûartlar:", margin, specialConditionsY);
    doc.text("1. Estetik Decor, ta≈üƒ±ma/teslimat sƒ±rasƒ±nda olu≈üabilecek hasarlarƒ± sigorta kapsamƒ±na almaz.", margin, specialConditionsY + 5);
    doc.text("2. Estetik Decor, g√ºmr√ºk, vergiler ve benzeri yerel masraflarƒ± kar≈üƒ±lamaz.", margin, specialConditionsY + 10);
  } else {
    doc.text("Special Conditions:", margin, specialConditionsY);
    doc.text("1. Estetik Decor does not insure any damage during transport/delivery.", margin, specialConditionsY + 5);
    doc.text("2. Estetik Decor does not cover any local costs, such as customs, taxes, etc.", margin, specialConditionsY + 10);
  }

  // ---------- √ñdeme ≈ûartlarƒ± ve Termin S√ºresi B√∂l√ºm√º ----------
  const extraInfoY = specialConditionsY + 20;
  let paymentTerms = "-";
  try {
    const ptResponse = await fetch(`/api/paymentterms`);
    if (ptResponse.ok) {
      const ptResult = await ptResponse.json();
      if (ptResult.success && ptResult.data && ptResult.data.length > 0) {
        const selectedPT = ptResult.data.find(pt => pt.KOD === cartInfo.PAYMENTTERMS);
        if (selectedPT) {
          paymentTerms = language === "tr" ? selectedPT.TR : selectedPT.EN;
        } else {
          paymentTerms = language === "tr" ? ptResult.data[0].TR : ptResult.data[0].EN;
        }
      }
    } else {
      console.error("Payment terms fetch failed");
    }
  } catch (e) {
    console.error("Payment terms fetch error:", e);
  }

  doc.setFontSize(8);
  if (language === "tr") {
    doc.text(`√ñdeme ≈ûartlarƒ±: ${paymentTerms}`, margin, extraInfoY);
    doc.text(`Termin S√ºresi: ${cartInfo.DELIVERYTIME ? cartInfo.DELIVERYTIME + " hafta" : "-"}`, margin, extraInfoY + 5);
    doc.text(`Teslim ≈ûekli: Fabrika Teslim`, margin, extraInfoY + 10);
  } else {
    doc.text(`Payment Terms: ${paymentTerms}`, margin, extraInfoY);
    doc.text(`Delivery Time: ${cartInfo.DELIVERYTIME ? cartInfo.DELIVERYTIME + " weeks" : "-"}`, margin, extraInfoY + 5);
    doc.text(`Delivery Method: Exworks`, margin, extraInfoY + 10);
  }

  // ---------- Banka Bilgileri B√∂l√ºm√º ----------
  const bankSectionY = extraInfoY + 15;
  let bankInfo = null;
  try {
    const bankResponse = await fetch(`/api/banks`);
    if (bankResponse.ok) {
      const bankResult = await bankResponse.json();
      if (bankResult.success && bankResult.data && bankResult.data.length > 0) {
        bankInfo = bankResult.data.find(b => b.KOD === cartInfo.BANK);
      }
    } else {
      console.error("Bank info fetch failed");
    }
  } catch (e) {
    console.error("Bank info fetch error:", e);
  }
  if (bankInfo) {
    doc.setDrawColor(0, 0, 0);
    doc.setLineWidth(0.5);
    doc.setLineDash([2, 2], 0);
    const bankRectX = margin;
    const bankRectY = bankSectionY;
    let currentY = bankRectY + 4;
    const lineSpacing = 5;
    doc.setFontSize(8);
    if (language === "tr") {
      const bankRectHeight = 5 * 5;
      const bankRectWidth = 80;
      doc.rect(bankRectX, bankRectY, bankRectWidth, bankRectHeight, 'D');
      doc.setLineDash([]);
      const text = "Banka Detaylarƒ±mƒ±z: ";
      const x = bankRectX + 2;
      const y = currentY;
      doc.text(text, x, y);
      const textWidth = doc.getTextWidth(text);
      doc.setLineWidth(0.5);
      doc.line(x, y + 0.5, x + textWidth, y + 0.5);
      currentY += lineSpacing;
      doc.text(`HESAP ADI: ${bankInfo.HESAPADI || '-'}`, bankRectX + 2, currentY);
      currentY += lineSpacing;
      doc.text(`BANKA ADI: ${bankInfo.BANKAADI || '-'}`, bankRectX + 2, currentY);
      currentY += lineSpacing;
      doc.text(`IBAN: ${bankInfo.IBAN || '-'}`, bankRectX + 2, currentY);
    } else {
      const bankRectHeight = 8 * 5;
      const bankRectWidth = 85;
      doc.rect(bankRectX, bankRectY, bankRectWidth, bankRectHeight, 'D');
      doc.setLineDash([]);
      const text = "Our Bank Details: ";
      const x = bankRectX + 2;
      const y = currentY;
      doc.text(text, x, y);
      const textWidth = doc.getTextWidth(text);
      doc.setLineWidth(0.5);
      doc.line(x, y + 0.5, x + textWidth, y + 0.5);
      currentY += lineSpacing;
      doc.text(`ACCOUNT NAME: ${bankInfo.HESAPADI || '-'}`, bankRectX + 2, currentY);
      currentY += lineSpacing;
      doc.text(`BANK NAME: ${bankInfo.BANKAADI || '-'}`, bankRectX + 2, currentY);
      currentY += lineSpacing;
      doc.text(`BRANCH: ${bankInfo.SUBEKODU} - ${bankInfo.SUBE || '-'}`, bankRectX + 2, currentY);
      currentY += lineSpacing;
      doc.text(`ACCOUNT NO: ${bankInfo.HESAP || '-'} - ${bankInfo.DOVIZ || '-'}`, bankRectX + 2, currentY);
      currentY += lineSpacing;
      doc.text(`IBAN: ${bankInfo.IBAN || '-'}`, bankRectX + 2, currentY);
      currentY += lineSpacing;
      doc.text(`SWIFTCODE: ${bankInfo.SWIFTCODE || '-'}`, bankRectX + 2, currentY);
    }
  }

  // PDF kaydet
  const customerName = cartInfo.CUSTOMER_NAME || "N/A";
  const fileName =
    language === "tr"
      ? `Teklif-Formu - ${customerName}.pdf`
      : `Quotation-Form - ${customerName}.pdf`;
  doc.save(fileName);
};

const generateConceptPDF = async (language = "tr") => {
  const { jsPDF } = window.jspdf;
  // A4 landscape: 297 x 210 mm
  const doc = new jsPDF({
    orientation: "landscape",
    unit: "mm",
    format: "a4",
  });

  const margin = 5;
  const pageWidth = 297; // Landscape A4 geni≈üliƒüi
  const pageHeight = 210; // Landscape A4 y√ºksekliƒüi

  // ---------------- Yardƒ±mcƒ± Fonksiyonlar ----------------
  const arrayBufferToBase64 = (buffer) => {
    let binary = "";
    const bytes = new Uint8Array(buffer);
    for (let i = 0; i < bytes.byteLength; i++) {
      binary += String.fromCharCode(bytes[i]);
    }
    return btoa(binary);
  };

  const formatNumber = (value) => {
    const parts = Number(value).toFixed(2).split(".");
    parts[0] = parts[0].replace(/\B(?=(\d{3})+(?!\d))/g, ".");
    return parts.join(",");
  };

  const loadFont = async () => {
    const fontUrl = "/fonts/Roboto-Regular.ttf";
    const fontResponse = await fetch(fontUrl);
    if (!fontResponse.ok) throw new Error("Font y√ºklenemedi.");
    const fontData = await fontResponse.arrayBuffer();
    const fontBase64 = arrayBufferToBase64(fontData);
    doc.addFileToVFS("Roboto-Regular.ttf", fontBase64);
    doc.addFont("Roboto-Regular.ttf", "Roboto", "normal");
    doc.setFont("Roboto");
  };
  await loadFont();

  const fetchBlobImage = async (url) => {
    const response = await fetch(url);
    if (!response.ok) throw new Error(`Fotoƒüraf y√ºklenemedi: ${url}`);
    const blob = await response.blob();
    return new Promise((resolve) => {
      const reader = new FileReader();
      reader.onload = () => resolve(reader.result);
      reader.readAsDataURL(blob);
    });
  };

  const replaceTurkishChars = (text) => {
    if (!text) return "";
    return text
      .replace(/≈û/g, "S")
      .replace(/≈ü/g, "s")
      .replace(/ƒ∞/g, "I")
      .replace(/ƒ±/g, "i")
      .replace(/√á/g, "C")
      .replace(/√ß/g, "c")
      .replace(/√ú/g, "U")
      .replace(/√º/g, "u")
      .replace(/√ñ/g, "O")
      .replace(/√∂/g, "o")
      .replace(/ƒû/g, "G")
      .replace(/ƒü/g, "g");
  };

  // ---------------- Sepet Bilgilerini √áekme ----------------
  const cartInfoResponse = await fetch(`http://192.168.30.4:3000/cart-info/${activeCartId}`);
  if (!cartInfoResponse.ok) throw new Error("Sepet bilgileri alƒ±namadƒ±.");
  const cartInfo = await cartInfoResponse.json();
  window.currentCartInfo = cartInfo;
  let globalCurrency = "TL";
  if (cartInfo.PRICE_TYPE === "1" || cartInfo.PRICE_TYPE === "2") globalCurrency = "TRY";
  if (cartInfo.PRICE_TYPE === "3" || cartInfo.PRICE_TYPE === "4") globalCurrency = "USD";
  if (cartInfo.PRICE_TYPE === "5" || cartInfo.PRICE_TYPE === "6") globalCurrency = "EUR";

  // ---------------- Header & Footer ----------------
  const addHeader = () => {
    const headerY = margin;
    const title = cartInfo.CUSTOMER_NAME || (language === "tr" ? "KONSEPT" : "CONCEPT");
    doc.setFontSize(18);
    doc.text(title, pageWidth / 2, headerY + 10, { align: "center" });
  };

  const addFooter = async () => {
    let logoBase64 = "";
    try {
      logoBase64 = await fetchBlobImage("/resim/EDLogo.png");
    } catch (error) {
      console.error("Logo y√ºklenemedi:", error);
      return;
    }
    const logoWidth = 35;
    const logoHeight = 7.5;
    const x = (pageWidth - logoWidth) / 2;
    const y = pageHeight - margin - logoHeight;
    doc.addImage(logoBase64, "PNG", x, y, logoWidth, logoHeight);
  };

  // ---------------- √úr√ºn Verilerini √áekme ----------------
  const fetchCartData = async (cartId, language = "tr") => {
    const endpoint = language === "en"
      ? `/api/cart/${cartId}/pdf-data-en`
      : `/api/cart/${cartId}/pdf-data`;
    const response = await fetch(endpoint);
    if (!response.ok) throw new Error("Sepet verisi alƒ±namadƒ±.");
    const result = await response.json();
    if (!result.success) throw new Error(result.message);
    return result.data;
  };

  let cartData = await fetchCartData(activeCartId, language);

  // ---------------- √úr√ºn Sƒ±ralamasƒ± (Global Toplamlar i√ßin) ----------------
  const groupOrder =
    language === "en"
      ? ["MAIN CONCEPT", "ADDITIONAL ITEMS", "ADDITIONAL ACCESSORIES", "ACCESSORIES", "SUPPLEMENTARY", "OTHER"]
      : ["ANA KONSEPT", "TAMAMLAYICI URUNLER", "TAMAMLAYICI AKSESUARLAR", "EK AKSESUARLAR", "EK URUNLER", "Dƒ∞ƒûER"];
  const defaultGroup = language === "en" ? "OTHER" : "Dƒ∞ƒûER";
  
  // Global toplam hesaplamalarƒ±nda EK URUNLER (SUPPLEMENTARY) hari√ß tutuluyor.
  let totalQuantity = 0;
  let totalAmount = 0;
  cartData.forEach((item) => {
    const groupKey = (item.CONCEPTGRUP || defaultGroup).toUpperCase();
    if (groupKey !== (language === "en" ? "SUPPLEMENTARY" : "EK URUNLER")) {
      const quantity = Number(item.QUANTITY);
      const price = item.CUSTOM_CODE ? (item.CUSTOM_PRICE || 0) : (item.PRICE || 0);
      const discountRate = item.CUSTOM_CODE ? (item.CUSTOM_DISCOUNT_RATE || 0) : (item.DISCOUNT_RATE || 0);
      const discountedPrice = price * (1 - discountRate / 100);
      totalQuantity += quantity;
      totalAmount += discountedPrice * quantity;
    }
  });
    // Global d√∂viz mapping
  const currencyMapping = {
    "1": "TRY",
    "2": "TL",
    "3": "USD",
    "4": "USD",
    "5": "EUR",
    "6": "EUR",
  };

  // ---------------- ƒ∞lk B√∂l√ºm: Grid G√∂r√ºn√ºm√º (Fotoƒüraflar ve Bilgiler) ----------------
  const imgWidth = 40, imgHeight = 40;
  const infoHeight = 10;
  const cellHeight = imgHeight + infoHeight;
  const gapX = 5, gapY = 5;
  const gridStartY = margin + 20; // Grid ba≈ülangƒ±√ß Y deƒüeri
  const availableHeight = pageHeight - margin - 20 - 10;
  const maxRowsPerColumn = Math.floor(availableHeight / (cellHeight + gapY));
  const cellWidth = imgWidth;
  const availableWidth = pageWidth - 2 * margin;
  const maxColsPerPage = Math.floor(availableWidth / (cellWidth + gapX));

  // Grid alanƒ±nƒ± gruplara ayƒ±rƒ±yoruz:
  // ƒ∞lk grup: ANA KONSEPT ve TAMAMLAYICI URUNLER
  // ƒ∞kinci grup: AKSESUARLAR, EK URUNLER ve varsa Dƒ∞ƒûER
  const firstGroupNames = language === "en" 
    ? ["MAIN CONCEPT", "ADDITIONAL ITEMS", "ADDITIONAL ACCESSORIES"] 
    : ["ANA KONSEPT", "TAMAMLAYICI URUNLER", "TAMAMLAYICI AKSESUARLAR"];
  const secondGroupNames = language === "en" 
    ? ["ACCESSORIES", "SUPPLEMENTARY", "OTHER"] 
    : ["EK AKSESUARLAR", "EK URUNLER", "Dƒ∞ƒûER"];

  const getGroupKey = (item) => (item.CONCEPTGRUP || defaultGroup).toUpperCase();
  const firstGroupItems = cartData.filter(item => firstGroupNames.includes(getGroupKey(item)));
  const secondGroupItems = cartData.filter(item => secondGroupNames.includes(getGroupKey(item)));

  // Her iki grup i√ßerisindeki √ºr√ºnleri, fiyata g√∂re (azalan) sƒ±ralayalƒ±m.
  const sortByPriceDescending = (a, b) => {
    const priceA = Number(a.CUSTOM_CODE ? (a.CUSTOM_PRICE || 0) : (a.PRICE || 0));
    const priceB = Number(b.CUSTOM_CODE ? (b.CUSTOM_PRICE || 0) : (b.PRICE || 0));
    return priceB - priceA;
  };

  firstGroupItems.sort(sortByPriceDescending);
  secondGroupItems.sort(sortByPriceDescending);

  // Grid g√∂r√ºn√ºm√ºn√º olu≈üturmak i√ßin yardƒ±mcƒ± fonksiyon
  const renderGridItems = async (items) => {
    let currentCol = 0, currentRow = 0;
    let gridX = margin, gridY = gridStartY;
    for (let i = 0; i < items.length; i++) {
      const item = items[i];
      let productImg = "";
      const imageUrl = `/resim/${item.PRODUCT_ID}.jpg`;
      try {
        productImg = await fetchBlobImage(imageUrl);
      } catch (error) {
        try {
          productImg = await fetchBlobImage("/resim/YOK.jpg");
        } catch (e) {
          console.error("Varsayƒ±lan fotoƒüraf alƒ±namadƒ±:", e);
        }
      }
      // Sayfa sƒ±nƒ±rƒ±nƒ± a≈üƒ±yorsa yeni sayfaya ge√ß
      if (gridY + cellHeight > pageHeight - margin) {
        await addFooter();
        doc.addPage();
        addHeader();
        currentCol = 0;
        currentRow = 0;
        gridX = margin;
        gridY = gridStartY;
      }
      if (productImg) {
        doc.addImage(productImg, "JPEG", gridX, gridY, imgWidth, imgHeight);
      }
      // Fotoƒüraf altƒ±ndaki bilgi kƒ±smƒ±: G√ºncel d√ºzenlemeniz uygulanƒ±yor.
      const labels = language === "en"
        ? { model: "Model", code: "Code", size: "Size", inch: "Inch", price: "Price" }
        : { model: "Model", code: "Kod", size: "Ebat", inch: "ƒ∞n√ß", price: "Fiyat" };
      const infoText = `${labels.model}: ${item.MODEL || "N/A"}\n${labels.code}: ${item.CUSTOM_CODE || item.PRODUCT_ID}\n${labels.size}: ${item.EBAT || "N/A"}\n${labels.inch}: ${item.EBATINCH || "N/A"}\n${labels.price}: ${formatNumber(item.PRICE) || "N/A"} ${currencyMapping[cartInfo.PRICE_TYPE] || "TRY"}`;
      doc.setFontSize(7);
      doc.text(infoText, gridX, gridY + imgHeight + 3);
      currentRow++;
      if (currentRow >= maxRowsPerColumn) {
        currentRow = 0;
        currentCol++;
        gridX = margin + currentCol * (cellWidth + gapX);
        gridY = gridStartY;
      } else {
        gridY += cellHeight + gapY;
      }
      if (gridX + cellWidth > pageWidth - margin) {
        await addFooter();
        doc.addPage();
        addHeader();
        currentCol = 0;
        currentRow = 0;
        gridX = margin;
        gridY = gridStartY;
      }
    }
  };

  // ƒ∞lk gruptaki (ANA KONSEPT & TAMAMLAYICI URUNLER) √ºr√ºnleri render et
  addHeader();
  await renderGridItems(firstGroupItems);
  await addFooter();

  // ƒ∞lk grup bittikten sonra yeni sayfada ikinci grubu (AKSESUARLAR, EK URUNLER, Dƒ∞ƒûER) render et
  if (secondGroupItems.length > 0) {
    doc.addPage();
    addHeader();
    await renderGridItems(secondGroupItems);
    await addFooter();
  }

  // ---------------- ƒ∞kinci B√∂l√ºm: √úr√ºn Listesi Tablosu (Fotoƒüraflar olmadan) ----------------
  doc.addPage();
  addHeader();

  // Tablo ba≈ülƒ±klarƒ± ("No" s√ºtunu ekleniyor)
  const headersTableArr =
    language === "tr"
      ? ["No", "√úr√ºn Kodu", "Kategori", "Model", "√ñl√ß√º cm", "√ñl√ß√º inch", "Fiyat", "Miktar", "Tutar", "D√∂viz"]
      : ["No", "Product Code", "Category", "Model", "Size cm", "Size inch", "Price", "Quantity", "Amount", "Currency"];

  // Gruplama: T√ºm √ºr√ºnler grup anahtarƒ±na g√∂re toplanƒ±yor
  const groupedData = cartData.reduce((groups, item) => {
    const groupKeyCandidate = (item.CONCEPTGRUP || defaultGroup).toUpperCase();
    const groupKey = groupOrder.includes(groupKeyCandidate) ? groupKeyCandidate : defaultGroup;
    if (!groups[groupKey]) {
      groups[groupKey] = [];
    }
    groups[groupKey].push(item);
    return groups;
  }, {});

  // Ayƒ±rƒ±yoruz: Ana gruplar (EK URUNLER hari√ß) ve EK URUNLER grubu
  const nonSuppOrderedGroups = groupOrder
  .filter((key) =>
    key !== (language === "en" ? "SUPPLEMENTARY" : "EK URUNLER") &&
    key !== (language === "en" ? "ACCESSORIES" : "EK AKSESUARLAR") &&
    groupedData[key]
  )
  .concat(
    Object.keys(groupedData).filter((key) =>
      key !== (language === "en" ? "SUPPLEMENTARY" : "EK URUNLER") &&
      key !== (language === "en" ? "ACCESSORIES" : "EK AKSESUARLAR") &&
      !groupOrder.includes(key)
    )
  );

  


  // Grup isimleri (dil parametresine g√∂re)
  const mainConceptKey = language === "en" ? "MAIN CONCEPT" : "ANA KONSEPT";
  const additionalItemsKey = language === "en" ? "ADDITIONAL ITEMS" : "TAMAMLAYICI URUNLER";
  const additionalItemsAksKey = language === "en" ? "ADDITIONAL ACCESSORIES" : "TAMAMLAYICI AKSESUARLAR";
  const accessoriesKey = language === "en" ? "ACCESSORIES" : "EK AKSESUARLAR";
  const supplementaryKey = language === "en" ? "SUPPLEMENTARY" : "EK URUNLER";

  let tableRows = [];
  let mainConceptTotals = { qty: 0, amount: 0 };
  let additionalTotals = { qty: 0, amount: 0 };
  let additionalAksTotals = { qty: 0, amount: 0 };

  // Ana gruplar i√ßin tablo satƒ±rlarƒ±nƒ± olu≈üturuyoruz (EK URUNLER hari√ß)
  nonSuppOrderedGroups.forEach((groupKey, idx) => {
    let groupItems = groupedData[groupKey];

    // Kategori toplamlarƒ±nƒ± hesaplayalƒ±m
    const categoryTotals = {};
    groupItems.forEach(item => {
      const cat = item.BASAMAK4 || "";
      const price = item.CUSTOM_CODE ? (item.CUSTOM_PRICE || 0) : (item.PRICE || 0);
      const discountRate = item.CUSTOM_CODE ? (item.CUSTOM_DISCOUNT_RATE || 0) : (item.DISCOUNT_RATE || 0);
      const discountedPrice = price * (1 - discountRate / 100);
      const amount = discountedPrice * Number(item.QUANTITY);
      if (!categoryTotals[cat]) categoryTotals[cat] = 0;
      categoryTotals[cat] += amount;
    });

    // Grup i√ßindeki √ºr√ºnleri √∂nce kategori toplamƒ±, sonra √ºr√ºn tutarƒ±na g√∂re azalan sƒ±ralƒ±yoruz
    groupItems.sort((a, b) => {
      const catA = a.BASAMAK4 || "";
      const catB = b.BASAMAK4 || "";
      const totalA = categoryTotals[catA] || 0;
      const totalB = categoryTotals[catB] || 0;
      if (totalB !== totalA) return totalB - totalA;
      const priceA = a.CUSTOM_CODE ? (a.CUSTOM_PRICE || 0) : (a.PRICE || 0);
      const discountRateA = a.CUSTOM_CODE ? (a.CUSTOM_DISCOUNT_RATE || 0) : (a.DISCOUNT_RATE || 0);
      const amountA = priceA * (1 - discountRateA / 100) * Number(a.QUANTITY);
      const priceB = b.CUSTOM_CODE ? (b.CUSTOM_PRICE || 0) : (b.PRICE || 0);
      const discountRateB = b.CUSTOM_CODE ? (b.CUSTOM_DISCOUNT_RATE || 0) : (b.DISCOUNT_RATE || 0);
      const amountB = priceB * (1 - discountRateB / 100) * Number(b.QUANTITY);
      return amountB - amountA;
    });

    // Grup ba≈ülƒ±ƒüƒ±
    tableRows.push([
      {
        content: groupKey,
        colSpan: 10,
        styles: {
          halign: "left",
          fillColor: [230, 230, 230],
          fontStyle: "bold",
          overflow: "linebreak",
        },
      },
    ]);
    // S√ºtun ba≈ülƒ±klarƒ±
    tableRows.push(headersTableArr);
    
    let rowNum = 0;
    let groupTotals = { qty: 0, amount: 0 };
    groupItems.forEach((item) => {
      rowNum++;
      const productCode = item.CUSTOM_CODE
        ? `${item.CUSTOM_CODE}\nReferans Kod: ${item.PRODUCT_ID}`
        : item.PRODUCT_ID;
      const category = replaceTurkishChars(item.BASAMAK4 || "");
      const model = replaceTurkishChars(item.MODEL || "");
      const sizeCm = replaceTurkishChars(item.EBAT || "");
      const sizeInch = replaceTurkishChars(item.EBATINCH || "");
      const price = item.CUSTOM_CODE ? (item.CUSTOM_PRICE || 0) : (item.PRICE || 0);
      const quantity = Number(item.QUANTITY);
      const discountRate = item.CUSTOM_CODE ? (item.CUSTOM_DISCOUNT_RATE || 0) : (item.DISCOUNT_RATE || 0);
      const discountedPrice = price * (1 - discountRate / 100);
      const amount = discountedPrice * quantity;
      groupTotals.qty += quantity;
      groupTotals.amount += amount;
      tableRows.push([
        rowNum.toString(),
        productCode,
        category,
        model,
        sizeCm,
        sizeInch,
        formatNumber(price),
        quantity.toString(),
        formatNumber(amount),
        currencyMapping[cartInfo.PRICE_TYPE] || "TRY",
      ]);
    });

    // Grup alt toplam satƒ±rƒ±
    tableRows.push([
      {
        content:
          language === "en"
            ? `Sub Total (${groupKey})`
            : `Alt Toplam (${groupKey})`,
        colSpan: 7,
        styles: {
          fontStyle: "bold",
          fillColor: [230, 230, 230],
          overflow: "linebreak",
        },
      },
      { content: groupTotals.qty.toString(), styles: { fillColor: [230, 230, 230] } },
      { content: formatNumber(groupTotals.amount), styles: { fillColor: [230, 230, 230] } },
      { content: currencyMapping[cartInfo.PRICE_TYPE] || "TRY", styles: { fillColor: [230, 230, 230] } },
    ]);

    if (groupKey === mainConceptKey) {
	  mainConceptTotals = groupTotals;
	} else if (groupKey === additionalItemsKey) {
	  additionalTotals = groupTotals;
	  const nextGroup = nonSuppOrderedGroups[idx + 1];
	  if (nextGroup && nextGroup === accessoriesKey  || nextGroup === supplementaryKey) {
		const combinedQty = mainConceptTotals.qty + additionalTotals.qty;
		const combinedAmount = mainConceptTotals.amount + additionalTotals.amount;
		tableRows.push([
		  {
			content:
			  language === "en"
				? `Sub Total (MAIN CONCEPT + ADDITIONAL ITEMS)`
				: `Alt Toplam (ANA KONSEPT + TAMAMLAYICI URUNLER)`,
			colSpan: 7,
			styles: { fontStyle: "bold", fillColor: [207, 207, 207], overflow: "linebreak" },
		  },
		  { content: combinedQty.toString(), styles: { fillColor: [207, 207, 207] } },
		  { content: formatNumber(combinedAmount), styles: { fillColor: [207, 207, 207] } },
		  { content: currencyMapping[cartInfo.PRICE_TYPE] || "TRY", styles: { fillColor: [207, 207, 207] } },
		]);
	  }
	} else if (groupKey === additionalItemsAksKey && (nextGroup === accessoriesKey || nextGroup === supplementaryKey) ) {
	  additionalAksTotals = groupTotals;
	  // Artƒ±k sonraki grup kontrol√ºne gerek kalmadan alt toplam ekleniyor:
	  
	  const combinedQty = mainConceptTotals.qty + additionalTotals.qty + additionalAksTotals.qty;
	  const combinedAmount = mainConceptTotals.amount + additionalTotals.amount + additionalAksTotals.amount;
	  tableRows.push([
		{
		  content:
			language === "en"
			  ? `Sub Total (MAIN CONCEPT + ADDITIONAL ITEMS + ADDITIONAL ACCESSORIES)`
			  : `Alt Toplam (ANA KONSEPT + TAMAMLAYICI URUNLER + TAMAMLAYICI AKSESUARLAR)`,
		  colSpan: 7,
		  styles: { fontStyle: "bold", fillColor: [207, 207, 207], overflow: "linebreak" },
		},
		{ content: combinedQty.toString(), styles: { fillColor: [207, 207, 207] } },
		{ content: formatNumber(combinedAmount), styles: { fillColor: [207, 207, 207] } },
		{ content: currencyMapping[cartInfo.PRICE_TYPE] || "TRY", styles: { fillColor: [207, 207, 207] } },
	  ]);
	  
	}

	if (groupKey !== accessoriesKey) {
	  tableRows.push(
		Array.from({ length: 10 }, () => ({
		  content: "",
		  styles: { fillColor: [255, 255, 255] },
		}))
	  );
	}

  });

  // Ana tablo AutoTable
  doc.autoTable({
    head: false,
    body: tableRows,
    foot: [
      [{
          content:
            language === "en"
              ? `Total `
              : `Toplam `,
          colSpan: 7,
          styles: { fontStyle: "bold", fillColor: [207, 207, 207], overflow: "linebreak" },
        },
        { content: totalQuantity.toString(), styles: { halign: "right" } },
        { content: formatNumber(totalAmount), styles: { halign: "right" } },
        { content: globalCurrency.toString(), styles: { halign: "center" } },
      ],
    ],
    footStyles: {
      fillColor: [207, 207, 207],
      fontStyle: "bold",
      textColor: [0, 0, 0],
    },
    showFoot: "lastPage",
    startY: margin + 20,
    margin: { left: margin, right: margin },
    theme: "striped",
    styles: {
      cellPadding: 2,
      fontSize: 8,
      overflow: "ellipsize",
      valign: "middle",
      halign: "left",
      minCellHeight: 6,
    },
    headStyles: {
      fillColor: [220, 220, 220],
      fontSize: 8,
      fontStyle: "bold",
      textColor: [102, 102, 102],
      minCellHeight: 6,
    },
    columnStyles: {
      0: { cellWidth: 10, halign: "center" },
      1: { cellWidth: 30, halign: "left" },
      2: { cellWidth: 50, halign: "left" },
      3: { cellWidth: 40, halign: "left" },
      4: { cellWidth: 30, halign: "left" },
      5: { cellWidth: 30, halign: "left" },
      6: { cellWidth: 25, halign: "right" },
      7: { cellWidth: 25, halign: "right" },
      8: { cellWidth: 25, halign: "right" },
      9: { cellWidth: 20, halign: "center" },
    },
    didDrawPage: (data) => {
      if (data.pageNumber > 1) {
        doc.autoTable.previous.finalY = margin + 10;
      }
    },
  });
  
  // ---------------- EK URUNLER Grubunu Aynƒ± Sayfada, Bo≈ü Bir Satƒ±r Sonrasƒ± Ekle ----------------
  if (groupedData[supplementaryKey] && groupedData[supplementaryKey].length > 0) {
    // Yeni sayfa eklemiyoruz; mevcut sayfadaki autotable'ƒ±n finalY'sinden 6 mm a≈üaƒüƒ±dan ba≈ülƒ±yoruz.
    const startYSupp = doc.lastAutoTable.finalY + 6;
    let suppItems = groupedData[supplementaryKey];

    // Kategori toplamlarƒ±nƒ± hesaplayalƒ±m
    const suppCategoryTotals = {};
    suppItems.forEach(item => {
      const cat = item.BASAMAK4 || "";
      const price = item.CUSTOM_CODE ? (item.CUSTOM_PRICE || 0) : (item.PRICE || 0);
      const discountRate = item.CUSTOM_CODE ? (item.CUSTOM_DISCOUNT_RATE || 0) : (item.DISCOUNT_RATE || 0);
      const discountedPrice = price * (1 - discountRate / 100);
      const amount = discountedPrice * Number(item.QUANTITY);
      if (!suppCategoryTotals[cat]) suppCategoryTotals[cat] = 0;
      suppCategoryTotals[cat] += amount;
    });

    // EK URUNLER grubunu sƒ±ralƒ±yoruz (√∂nce kategori toplamƒ±, sonra √ºr√ºn tutarƒ± azalan)
    suppItems.sort((a, b) => {
      const catA = a.BASAMAK4 || "";
      const catB = b.BASAMAK4 || "";
      const totalA = suppCategoryTotals[catA] || 0;
      const totalB = suppCategoryTotals[catB] || 0;
      if (totalB !== totalA) return totalB - totalA;
      const priceA = a.CUSTOM_CODE ? (a.CUSTOM_PRICE || 0) : (a.PRICE || 0);
      const discountRateA = a.CUSTOM_CODE ? (a.CUSTOM_DISCOUNT_RATE || 0) : (a.DISCOUNT_RATE || 0);
      const amountA = priceA * (1 - discountRateA / 100) * Number(a.QUANTITY);
      const priceB = b.CUSTOM_CODE ? (b.CUSTOM_PRICE || 0) : (b.PRICE || 0);
      const discountRateB = b.CUSTOM_CODE ? (b.CUSTOM_DISCOUNT_RATE || 0) : (b.DISCOUNT_RATE || 0);
      const amountB = priceB * (1 - discountRateB / 100) * Number(b.QUANTITY);
      return amountB - amountA;
    });

    // EK URUNLER i√ßin tablo satƒ±rlarƒ±nƒ± olu≈üturalƒ±m
    let suppTableRows = [];
    suppTableRows.push([
      {
        content: supplementaryKey,
        colSpan: 10,
        styles: {
          halign: "left",
          fillColor: [230, 230, 230],
          fontStyle: "bold",
          overflow: "linebreak",
        },
      },
    ]);
    suppTableRows.push(headersTableArr);
    let rowNum = 0;
    let suppTotals = { qty: 0, amount: 0 };
    suppItems.forEach((item) => {
      rowNum++;
      const productCode = item.CUSTOM_CODE
        ? `${item.CUSTOM_CODE}\nReferans Kod: ${item.PRODUCT_ID}`
        : item.PRODUCT_ID;
      const category = replaceTurkishChars(item.BASAMAK4 || "");
      const model = replaceTurkishChars(item.MODEL || "");
      const sizeCm = replaceTurkishChars(item.EBAT || "");
      const sizeInch = replaceTurkishChars(item.EBATINCH || "");
      const price = item.CUSTOM_CODE ? (item.CUSTOM_PRICE || 0) : (item.PRICE || 0);
      const quantity = Number(item.QUANTITY);
      const discountRate = item.CUSTOM_CODE ? (item.CUSTOM_DISCOUNT_RATE || 0) : (item.DISCOUNT_RATE || 0);
      const discountedPrice = price * (1 - discountRate / 100);
      const amount = discountedPrice * quantity;
      suppTotals.qty += quantity;
      suppTotals.amount += amount;
      suppTableRows.push([
        rowNum.toString(),
        productCode,
        replaceTurkishChars(item.BASAMAK4 || ""),
        replaceTurkishChars(item.MODEL || ""),
        replaceTurkishChars(item.EBAT || ""),
        replaceTurkishChars(item.EBATINCH || ""),
        formatNumber(price),
        quantity.toString(),
        formatNumber(amount),
        currencyMapping[cartInfo.PRICE_TYPE] || "TRY",
      ]);
    });
    suppTableRows.push([
      {
        content:
          language === "en"
            ? `Sub Total (${supplementaryKey})`
            : `Alt Toplam (${supplementaryKey})`,
        colSpan: 7,
        styles: {
          fontStyle: "bold",
          fillColor: [230, 230, 230],
          overflow: "linebreak",
        },
      },
      { content: suppTotals.qty.toString(), styles: { fillColor: [230, 230, 230] } },
      { content: formatNumber(suppTotals.amount), styles: { fillColor: [230, 230, 230] } },
      { content: currencyMapping[cartInfo.PRICE_TYPE] || "TRY", styles: { fillColor: [230, 230, 230] } },
    ]);

    doc.autoTable({
      head: false,
      body: suppTableRows,
      startY: startYSupp,
      margin: { left: margin, right: margin },
      theme: "striped",
      styles: {
        cellPadding: 2,
        fontSize: 8,
        overflow: "ellipsize",
        valign: "middle",
        halign: "left",
        minCellHeight: 6,
      },
      headStyles: {
        fillColor: [220, 220, 220],
        fontSize: 8,
        fontStyle: "bold",
        textColor: [102, 102, 102],
        minCellHeight: 6,
      },
      columnStyles: {
        0: { cellWidth: 10, halign: "center" },
        1: { cellWidth: 30, halign: "left" },
        2: { cellWidth: 50, halign: "left" },
        3: { cellWidth: 40, halign: "left" },
        4: { cellWidth: 30, halign: "left" },
        5: { cellWidth: 30, halign: "left" },
        6: { cellWidth: 25, halign: "right" },
        7: { cellWidth: 25, halign: "right" },
        8: { cellWidth: 25, halign: "right" },
        9: { cellWidth: 20, halign: "center" },
      },
      didDrawPage: (data) => {
        if (data.pageNumber > 1) {
          doc.autoTable.previous.finalY = margin + 10;
        }
      },
    });
  }
  
  await addFooter();

  const fileName =
    language === "tr"
      ? `KONSEPT-Formu - ${cartInfo.CUSTOMER_NAME || "N/A"}.pdf`
      : `CONCEPT-Form - ${cartInfo.CUSTOMER_NAME || "N/A"}.pdf`;
  doc.save(fileName);
};



// Yardƒ±mcƒ± Fonksiyon: ArrayBuffer'ƒ± Base64'e d√∂n√º≈üt√ºr
const arrayBufferToBase64 = (buffer) => {
    let binary = "";
    const bytes = new Uint8Array(buffer);
    const len = bytes.byteLength;
    for (let i = 0; i < len; i++) {
        binary += String.fromCharCode(bytes[i]);
    }
    return btoa(binary);
};

	//pdf fetchcartdata
	const fetchCartData = async (cartId, language = "tr") => {
		const response = await fetch(`/api/cart/${cartId}/pdf-data?lang=${language}`);
		if (!response.ok) throw new Error("Sepet verisi alƒ±namadƒ±.");
		const result = await response.json();
		if (!result.success) throw new Error(result.message);
		return result.data;
	};


	// G√∂rsel Y√ºkleme Fonksiyonu
	const loadImage = (url) => {
		return new Promise((resolve, reject) => {
			const img = new Image();
			img.crossOrigin = "Anonymous"; // Farklƒ± kaynaklardan g√∂rsel alƒ±mƒ± i√ßin
			img.onload = () => {
				const canvas = document.createElement("canvas");
				canvas.width = img.width;
				canvas.height = img.height;
				const ctx = canvas.getContext("2d");
				ctx.drawImage(img, 0, 0);
				const dataUrl = canvas.toDataURL("image/jpeg");
				resolve(dataUrl);
			};
			img.onerror = (err) => reject(err);
			img.src = url;
		});
	};


//Sepet i√ßeriƒüini g√∂stermek i√ßin kullanƒ±lan fonksiyon
//Sepet i√ßeriƒüini g√∂stermek i√ßin kullanƒ±lan fonksiyon
const showCartContents = async () => {
    const modalCartContent = document.getElementById('modalCartContent');
    const cartNameDisplay = document.getElementById('cartNameDisplay');
    const customerTypeDisplay = document.getElementById('customerTypeDisplay');
    const salesAreaDisplay = document.getElementById('salesAreaDisplay');
    const priceTypeDisplay = document.getElementById('priceTypeDisplay');
    const vatIncludedDisplay = document.getElementById('vatIncludedDisplay');
    const discountRateDisplay = document.getElementById('discountRateDisplay');
    const paymentTermsDisplay = document.getElementById('paymentTermsDisplay');
    const bankDisplay = document.getElementById('bankDisplay');

    // DOM √∂ƒüelerinin varlƒ±ƒüƒ±nƒ± kontrol et
    if (!modalCartContent || !cartNameDisplay || !customerTypeDisplay || !salesAreaDisplay ||
        !priceTypeDisplay || !vatIncludedDisplay || !discountRateDisplay || !paymentTermsDisplay || !bankDisplay  || !ckartSelect) {
        console.error('Gerekli DOM √∂ƒüelerinden biri eksik. L√ºtfen kontrol edin.');
        return;
    }

    try {
        if (!activeCartId) throw new Error('Aktif bir sepet bulunamadƒ±.');
        
        //banner alanƒ± tanƒ±mƒ±
        const conceptBannerContainer = document.getElementById("conceptBannerContainer");
        const conceptBannerImg = document.getElementById("conceptBannerImg");

        // Sepet bilgilerini al
        const cartInfoResponse = await fetch(`http://192.168.30.4:3000/cart-info/${activeCartId}`);
        if (!cartInfoResponse.ok) throw new Error('Sepet bilgileri alƒ±namadƒ±.');
        const cartInfo = await cartInfoResponse.json();
        window.currentCartInfo = cartInfo; // Global deƒüi≈üken

        // üìå Eƒüer **Sepet Konseptse**, banner alanƒ±nƒ± g√∂ster
        if (cartInfo.CONCEPT === 1) {
            conceptBannerContainer.style.display = "block"; // üìå Banner alanƒ±nƒ± g√∂ster

            // Eƒüer CONCEPT_BANNER varsa, ilgili g√∂rseli kullan; yoksa varsayƒ±lan banner
            conceptBannerImg.src = cartInfo.CONCEPT_BANNER ? cartInfo.CONCEPT_BANNER : '/resim/YOK.jpg';
        } else {
            conceptBannerContainer.style.display = "none"; // üìå Konsept deƒüilse bannerƒ± gizle
        }

        const showCategoryColumn = cartInfo.CONCEPT === 1; // **Kategori s√ºtunu g√∂r√ºns√ºn m√º?**
        // Sepet bilgilerini aldƒ±ktan sonra (√∂rneƒüin cartInfo nesnesi mevcut)
        if (cartInfo.CONCEPT === 1) {
            // Konsept sepet ise, "Konsept Alanƒ±" b√∂l√ºm√ºn√º g√∂ster
            const conceptDiv = document.querySelector('#conceptarea').closest('.col-md-2');
            if (conceptDiv) {
                conceptDiv.style.display = "block";
            }
            // Ayrƒ±ca, isterseniz conceptarea span'ƒ±nƒ± da doldurabilirsiniz:
            document.getElementById("conceptarea").textContent = cartInfo.CONCEPT_AREA || ""; // eƒüer konsept alanƒ± verisi varsa
        } else {
            // Konsept deƒüilse, ilgili alanƒ± gizle
            const conceptDiv = document.querySelector('#conceptarea').closest('.col-md-2');
            if (conceptDiv) {
                conceptDiv.style.display = "none";
            }
        }

        // ‚Äì‚Äì‚Äì Alanlarƒ± DOM‚Äôa y√ºkle ‚Äì‚Äì‚Äì
        
        // M√º≈üteri Adƒ± (varsa kullanƒ±cƒ± deƒüi≈ütirip update edebilsin)
        cartNameDisplay.innerHTML = `
            <input type="text" id="customerNameInput" value="${cartInfo.CUSTOMER_NAME || ''}" placeholder="M√º≈üteri Adƒ±" 
              onblur="updateCustomerName(this.value)" style="width: 100%; padding: 5px;" />
        `;
        
        // **M√º≈üteri Tipi** ‚Äì Dropdown; onchange'da updateCartCustomerType() √ßaƒürƒ±lƒ±r
        customerTypeDisplay.innerHTML = `
            <select id="customerTypeSelector" class="form-control" onchange="updateCartCustomerType(this.value)">
                <option value="perakende" ${cartInfo.CUSTOMER_TYPE === 'perakende' ? 'selected' : ''}>Perakende</option>
                <option value="kurumsal" ${cartInfo.CUSTOMER_TYPE === 'kurumsal' ? 'selected' : ''}>Kurumsal</option>
                <option value="toptan" ${cartInfo.CUSTOMER_TYPE === 'toptan' ? 'selected' : ''}>Toptan</option>
            </select>
        `;
        
        // **Satƒ±≈ü B√∂lgesi** ‚Äì Dropdown; onchange'da updateCartSalesArea() √ßaƒürƒ±lƒ±r
        salesAreaDisplay.innerHTML = `
            <select id="salesAreaSelector" class="form-control" onchange="updateCartSalesArea(this.value)">
                <option value="yurtici" ${cartInfo.SALES_AREA === 'yurtici' ? 'selected' : ''}>Yurti√ßi</option>
                <option value="yurtdisi" ${cartInfo.SALES_AREA === 'yurtdisi' ? 'selected' : ''}>Yurtdƒ±≈üƒ±</option>
            </select>
        `;
        
        // **Fiyat Tipi** ‚Äì Dropdown; se√ßenekler m√º≈üteri tipine g√∂re ayarlanƒ±yor
        priceTypeDisplay.innerHTML = `
            <select id="priceTypeSelector" class="form-control" onchange="updateCartPriceType(this.value)"></select>
        `;
        updateCartPriceTypeOptions(cartInfo.CUSTOMER_TYPE, cartInfo.PRICE_TYPE);
        
        // **KDV Dahil/Hari√ß** ‚Äì Dropdown; m√º≈üteri tipine g√∂re otomatik (Perakende: Dahil, Toptan: Hari√ß, Kurumsal: kullanƒ±cƒ± se√ßebilir)
        vatIncludedDisplay.innerHTML = `
            <select id="vatIncludedSelector" class="form-control" onchange="updateCartVatIncluded(this.value)"></select>
        `;
        updateCartVatIncludedOptions(cartInfo.CUSTOMER_TYPE, cartInfo.VATINCLUEDED);
        
        // **ƒ∞ndirim Oranƒ±**
        discountRateDisplay.innerHTML = `
            <input type="number" id="cartDiscountRate" value="${cartInfo.DISCOUNT_RATE || 0}" min="0" max="100" step="5"
              onchange="updateCartDiscountRate(this.value)" style="width: 60px; text-align: center;" />%
        `;
        // Yeni: √ñdeme ≈ûartlarƒ± dropdown'unu olu≈ütur
        paymentTermsDisplay.innerHTML = `<select id="paymentTermsSelector" class="form-control"></select>`;
        loadPaymentTermsOptions(cartInfo.PAYMENTTERMS);
        // Yeni: Teslim S√ºresi dropdown'unu olu≈ütur
        deliveryTimeDisplay.innerHTML = `<select id="deliveryTimeSelector" class="form-control"></select>`;
        loadDeliveryTimeOptions(cartInfo.DELIVERYTIME);
        // Yeni: Teslim S√ºresi dropdown'unu olu≈ütur
        conceptarea.innerHTML = `<select id="conceptareaSelector" class="form-control"></select>`;
        conceptareaOptions(cartInfo.CONCEPT_AREA);
        // Yeni: Banka select alanƒ±
        bankDisplay.innerHTML = `<select id="bankSelector" class="form-control" onchange="updateCartBank(this.value)"></select>`;
        loadBankOptions(cartInfo.BANK);

        // ‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì
        // Sepet √úr√ºnleri ƒ∞√ßeriƒüi (mevcut kodunuzla devam ediyor)
        // ‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì
        
        // üìå **Konsept Sepet i√ßin Banner Se√ßim Butonu Ekle**
        if (cartInfo.CONCEPT === 1) { // **Sepet Konseptse butonu ekle**
            document.getElementById("selectBannerButtonContainer").innerHTML = `
                <button class="btn btn-primary btn-sm" onclick="openBannerSelection(${activeCartId})">
                    üì∑ Banner Se√ß
                </button>
            `;
        } else {
            document.getElementById("selectBannerButtonContainer").innerHTML = ""; // **Konsept deƒüilse butonu kaldƒ±r**
        }

        // Sepet i√ßeriƒüini al
        const response = await fetch(`http://192.168.30.4:3000/get-cart/${activeCartId}`);
        if (!response.ok) throw new Error('Sepet i√ßeriƒüi alƒ±namadƒ±.');

        const { items } = await response.json();

        if (!items || items.length === 0) {
            modalCartContent.innerHTML = `
                <p class="text-center text-muted">Sepetiniz bo≈ü.</p>
            `;
            $('#cartModal').modal('show');
            return;
        }
        // Eƒüer sepet konseptse, √ºr√ºnleri kategori sƒ±rasƒ±na g√∂re sƒ±rala
        if (cartInfo.CONCEPT === 1) {
            const categoryOrder = [
                "ANA KONSEPT",
                "TAMAMLAYICI URUNLER",
                "TAMAMLAYICI AKSESUARLAR",
                "EK AKSESUARLAR",
                "EK URUNLER",
                "DIGER"
            ];
            // Yardƒ±mcƒ± fonksiyon: √úr√ºn i√ßin kategori belirleme
            const getItemCategory = (item) => {
                if (item.MAINCONCEPT) return "ANA KONSEPT";
                if (item.ADDITIONAL) return "TAMAMLAYICI URUNLER";
                if (item.ADDITIONALAKS) return "TAMAMLAYICI AKSESUARLAR";
                if (item.ACCESSORIES) return "EK AKSESUARLAR";
                if (item.SUPPLEMENTARY) return "EK URUNLER";
                return "DIGER";
            };

            items.sort((a, b) => {
                const catA = getItemCategory(a);
                const catB = getItemCategory(b);
                return categoryOrder.indexOf(catA) - categoryOrder.indexOf(catB);
            });
        }
        const formatCurrency = (value, priceType) => {
            const currencyMap = {
                1: 'TRY',
                2: 'TRY',
                3: 'USD',
                4: 'USD',
                5: 'EUR',
                6: 'EUR'
            };
            const currency = currencyMap[priceType] || 'TRY';
            return new Intl.NumberFormat('tr-TR', {
                style: 'currency',
                currency
            }).format(value);
        };

        const getImageUrl = (productId) => {
            const basePath = '/resim';
            return `${basePath}/${productId}.jpg`;
        };

        let totalQuantity = 0;
        let totalAmount = 0;
        let totalKdvsiz = 0;
        let totalKdv = 0;
        const rowsHtml = items.map(item => {
            const imageUrl = getImageUrl(item.PRODUCT_ID);
            const fallbackImage = '/resim/YOK.jpg';

            // √ñzelle≈ütirilmi≈ü √ºr√ºn kontrol√º
            const isCustomized = !!(item.CUSTOM_CODE || item.CUSTOM_NAME);
            const rowClass = isCustomized ? 'customized-row' : ''; // Eƒüer √∂zelle≈ütirilmi≈üse √∂zel CSS sƒ±nƒ±fƒ±
            const customPriceInputId = `customPrice-${item.cartItemId}`;

            // Toplam ve indirimli fiyat hesaplama
            const price = item.CUSTOM_PRICE || item.PRICE; // √ñncelikli olarak √∂zelle≈ütirilmi≈ü fiyatƒ± kullan
            const discountRate = item.DISCOUNT_RATE || 0;
            const discountedPrice = item.DISCOUNTED_PRICE; // ƒ∞ndirimli fiyat
            const kdvsizTutar = item.AMOUNT_NOTINCLUDED_VAT; // Kdvsiz Tutar
            const kdvTutari = item.VAT_TOTAL; // KDV Tutarƒ±
            const total = item.TOTAL_AMOUNT; // Tutar

            totalQuantity += item.QUANTITY;
            totalKdvsiz += kdvsizTutar;
            totalKdv += kdvTutari;
            totalAmount += total;

            // Fiyat deƒüi≈üim fonksiyonunu global hale getirin
            window.handleCustomPriceChange = async (cartItemId, isCustomized = false) => {
                const customPriceElement = document.getElementById(`customPrice-${cartItemId}`);
                const discountRateElement = document.getElementById(`discountRate-${cartItemId}`);
                const quantityElement = document.getElementById(`quantity-${cartItemId}`);

                // Fiyat ve indirim oranƒ±nƒ± al
                const customPrice = isCustomized
                    ? parseFloat(customPriceElement?.value || 0) // √ñzelle≈ütirilmi≈ü fiyat
                    : parseFloat(customPriceElement?.getAttribute("data-original-price") || 0); // Orijinal fiyat
                const discountRate = parseFloat(discountRateElement?.value || 0);
                const quantity = parseFloat(quantityElement?.value || 1);

                // Yeni indirimli fiyat ve toplam tutarƒ± hesapla
                const discountedPrice = customPrice * (1 - discountRate / 100);
                const total = discountedPrice * quantity;

                // DOM g√ºncellemesi: Satƒ±rdaki indirimli fiyat ve toplamƒ± g√∂ster
                document.getElementById(`discountedPrice-${cartItemId}`).innerText = formatCurrency(discountedPrice, cartInfo.PRICE_TYPE);
                document.getElementById(`totalAmount-${cartItemId}`).innerText = formatCurrency(total, cartInfo.PRICE_TYPE);

                try {
                    // 1. Adƒ±m: √úr√ºn√ºn √∂zelle≈ütirilmi≈ü/normal verilerini g√ºncelleyen endpoint √ßaƒürƒ±sƒ±
                    const endpoint = isCustomized
                        ? `/api/cart-items/${cartItemId}/update-custom-data`
                        : `/api/cart-items/${cartItemId}/update-original-data`;
                    const body = isCustomized
                        ? { customPrice, discountRate }
                        : { discountRate };
                    const response = await fetch(endpoint, {
                        method: "POST",
                        headers: { "Content-Type": "application/json" },
                        body: JSON.stringify(body)
                    });
                    const result = await response.json();
                    if (!result.success) {
                        console.error("G√ºncelleme ba≈üarƒ±sƒ±z:", result.message);
                        alert(result.message);
                        return;
                    }

                    // 2. Adƒ±m: Satƒ±rdaki VAT hesaplamalarƒ±nƒ± (Kdvsiz Tutar, KDV Tutarƒ±, Toplam Tutar vb.) yeniden hesaplayan endpoint'i √ßaƒüƒ±rƒ±n.
                    const vatResponse = await fetch(`http://192.168.30.4:3000/cart/item/${cartItemId}/update-discount-vat`, {
                        method: "PUT",
                        headers: { "Content-Type": "application/json" },
                        body: JSON.stringify({ discountRate })
                    });
                    if (!vatResponse.ok) {
                        const vatError = await vatResponse.json();
                        alert(`KDV hesaplamalarƒ± g√ºncellenemedi: ${vatError.message}`);
                        return;
                    }

                    // 3. Adƒ±m: G√ºncel sepet i√ßeriƒüini yeniden y√ºkle
                    await showCartContents();
                    updateCartFreightInsurance();
                } catch (error) {
                    console.error("G√ºncelleme sƒ±rasƒ±nda hata olu≈ütu:", error);
                    alert("G√ºncelleme sƒ±rasƒ±nda bir hata olu≈ütu.");
                }
            };

            return `
                <tr class="${rowClass}">
                    <td>
                        <img src="${imageUrl}" onerror="this.onerror=null;this.src='${fallbackImage}';" alt="√úr√ºn Fotoƒürafƒ±" style="width: 50px; height: 50px; object-fit: cover;">
                    </td>
                    <td>
                        ${isCustomized ? '<span style="font-weight: bold; color: #000;">Referans Kod:</span> ' : ''}
                        ${item.PRODUCT_ID}<br><br>
                        <span style="font-weight: bold; color: #0d285a;">${item.CUSTOM_CODE || ''}</span>
                    </td>
                    <td>${item.PRODUCT_NAME}<br><br><span style="font-weight: bold; color: #0d285a;">${item.CUSTOM_NAME || ''}</span></td>
                    
                    <!-- üìå MAINCONCEPT, ADDITIONAL, ACCESSORIES Se√ßenekleri -->
                    ${showCategoryColumn ? `
                    <td>
                      <label>
                        <input type="checkbox" id="mainConcept-${item.cartItemId}" 
                          ${item.MAINCONCEPT ? 'checked' : ''} 
                          onchange="updateCartCategory(${item.cartItemId}, this)">
                        Ana Konsept
                      </label><br>

                      <label>
                        <input type="checkbox" id="additional-${item.cartItemId}" 
                          ${item.ADDITIONAL ? 'checked' : ''} 
                          onchange="updateCartCategory(${item.cartItemId}, this)">
                        Tam.√úr√ºnler
                      </label><br>
                      <label>
                        <input type="checkbox" id="additionalaks-${item.cartItemId}" 
                          ${item.ADDITIONALAKS ? 'checked' : ''} 
                          onchange="updateCartCategory(${item.cartItemId}, this)">
                        Tam. Aks.
                      </label><br>

                      <label>
                        <input type="checkbox" id="accessories-${item.cartItemId}" 
                          ${item.ACCESSORIES ? 'checked' : ''} 
                          onchange="updateCartCategory(${item.cartItemId}, this)">
                        Ek Aksesuar
                      </label><br>
                      <label>
                        <input type="checkbox" id="supplementary-${item.cartItemId}" 
                          ${item.SUPPLEMENTARY ? 'checked' : ''} 
                          onchange="updateCartCategory(${item.cartItemId}, this)">
                        Ek √úr√ºn
                      </label>
                    </td>

                    ` : ""}
                    <td>
                        <div class="quantity-controls">
                            <button class="quantity-btn" onclick="updateQuantity(${item.cartItemId}, -1)">-</button>
                            <input type="text" class="quantity-input" id="quantity-${item.cartItemId}" value="${item.QUANTITY}" readonly />
                            <button class="quantity-btn" onclick="updateQuantity(${item.cartItemId}, 1)">+</button>
                        </div>
                    </td>
                    <td>
                        ${isCustomized ? `
                            <input 
                                type="number" 
                                id="customPrice-${item.cartItemId}" 
                                value="${item.CUSTOM_PRICE || item.PRICE}" 
                                min="0" 
                                step="100"
                                onchange="handleCustomPriceChange(${item.cartItemId}, true)"
                                style="width: 80px; text-align: right;" 
                            />
                        ` : `
                             <span style="display: block; text-align: right;">${formatCurrency(item.PRICE, cartInfo.PRICE_TYPE)}</span>
                        `}
                    </td>
                    <td>
                        <input
                            type="number"
                            id="discountRate-${item.cartItemId}"
                            value="${item.CUSTOM_DISCOUNT_RATE !== undefined && item.CUSTOM_DISCOUNT_RATE !== null ? item.CUSTOM_DISCOUNT_RATE : (item.DISCOUNT_RATE || 0)}"
                            min="0"
                            max="100"
                            step="5"
                            onchange="handleCustomPriceChange(${item.cartItemId}, ${isCustomized})"
                            style="width: 60px; text-align: center;"
                        />

                    </td>

                    <td style="text-align: right;" id="discountedPrice-${item.cartItemId}">
                        ${formatCurrency(discountedPrice, cartInfo.PRICE_TYPE)}
                    </td>
                    <td style="text-align: right;" >
                        ${formatCurrency(kdvsizTutar, cartInfo.PRICE_TYPE)}
                    </td>
                    <td style="text-align: right;" >
                        ${formatCurrency(kdvTutari, cartInfo.PRICE_TYPE)}
                    </td style="text-align: right;" >
                    <td style="text-align: right;" id="totalAmount-${item.cartItemId}">
                        ${formatCurrency(total, cartInfo.PRICE_TYPE)}
                    </td>
                    <td>
                        <button class="btn btn-danger btn-sm" onclick="removeFromCart(${item.cartItemId})">
                            <i class="fa fa-trash"></i>
                        </button>
                    </td>
                    <td>
                        <!-- √ñzelle≈ütir Butonu (Sadece simge) -->
                        <button class="btn btn-info btn-sm" title="√ñzelle≈ütir" onclick="openConfigModal(${item.cartItemId})">
                            <i class="fa fa-cogs"></i>
                        </button>

                        <!-- √ñzelle≈ütirmeyi Sil Butonu -->
                        <button class="btn btn-danger btn-sm" title="√ñzelle≈ütirmeyi Sil" onclick="deleteCustomization(${item.cartItemId})">
                            <i class="fa fa-times"></i>
                        </button>
                        <!-- √ñneri Butonu (Sadece simge) -->
                        <button class="btn btn-warning btn-sm" title="√ñneri" onclick="openSuggestionModal('${item.PRODUCT_ID}')">
                            <i class="fa fa-lightbulb-o"></i>
                        </button>
                    </td>
                </tr>
            `;
        }).join("");

        // ƒ∞lk footer satƒ±rƒ±: Toplam deƒüerler
        let footerRow = "";
        if (showCategoryColumn) {
            footerRow = `
                <tr>
                  <th colspan="4">Toplam</th>
                  <th align="center">${totalQuantity}</th>
                  <th colspan="3"></th>
                  <th>${formatCurrency(totalKdvsiz, cartInfo.PRICE_TYPE)}</th>
                  <th>${formatCurrency(totalKdv, cartInfo.PRICE_TYPE)}</th>
                  <th>${formatCurrency(totalAmount, cartInfo.PRICE_TYPE)}</th>
                  <th colspan="2"></th>
                </tr>
            `;
        } else {
            footerRow = `
                <tr>
                  <th colspan="3">Toplam</th>
                  <th style="text-align: center;">${totalQuantity}</th>
                  <th colspan="3"></th>
                  <th>${formatCurrency(totalKdvsiz, cartInfo.PRICE_TYPE)}</th>
                  <th>${formatCurrency(totalKdv, cartInfo.PRICE_TYPE)}</th>
                  <th>${formatCurrency(totalAmount, cartInfo.PRICE_TYPE)}</th>
                  <th colspan="2"></th>
                </tr>
            `;
        }

        // ƒ∞kinci footer satƒ±rƒ±: Sigorta ve Navlun deƒüerleri (sunucudan alƒ±nan summaryData)
        let additionalRow = "";
        // summaryData'yƒ± almak i√ßin:
        let summaryData = null;
        try {
            const summaryResponse = await fetch(`http://192.168.30.4:3000/cart-summary/${activeCartId}`);
            if (summaryResponse.ok) {
                summaryData = await summaryResponse.json();
            }
        } catch (error) {
            console.error("Sepet √∂zeti fetch hatasƒ±:", error);
        }
        if (summaryData && summaryData.success) {
            if (showCategoryColumn) {
                additionalRow = `
                    <tr>
                      <th colspan="9"></th>
                      
                      <th>
                        <div style="text-align: center;">
                          <label style="font-size: 0.9em;">Sigorta:</label><br>
                          <input type="number" id="insuranceInput" value="${summaryData.insurance}" style="width: 80px; text-align: center;" onchange="updateCartFreightInsurance()" />
                        </div>
                      </th>
                      <th>
                        <div style="text-align: center;">
                          <label style="font-size: 0.9em;">Navlun:</label><br>
                          <input type="number" id="freightInput" value="${summaryData.freight}" style="width: 80px; text-align: center;" onchange="updateCartFreightInsurance()" />
                        </div>
                      </th>
                      <th colspan="2"></th>
                    </tr>
                `;
            } else {
                additionalRow = `
                    <tr>
                      <th colspan="8"></th>
                      <th>
                        <div style="text-align: center;">
                          <label style="font-size: 0.9em;">Sigorta:</label><br>
                          <input type="number" id="insuranceInput" value="${summaryData.insurance}" style="width: 80px; text-align: center;" onchange="updateCartFreightInsurance()" />
                        </div>
                      </th>
                      <th>
                        <div style="text-align: center;">
                          <label style="font-size: 0.9em;">Navlun:</label><br>
                          <input type="number" id="freightInput" value="${summaryData.freight}" style="width: 80px; text-align: center;" onchange="updateCartFreightInsurance()" />
                        </div>
                      </th>
                      <th colspan="2"></th>
                    </tr>
                `;
            }
        }

        // √ú√ß√ºnc√º footer satƒ±rƒ±: Genel Toplam
        let totalRow = "";
        if (showCategoryColumn) {
            totalRow = `
                <tr>
                  <th colspan="9"></th>
                  <th style="text-align: center;">Genel Toplam:</th>
                  <th style="text-align: center;">${summaryData ? formatCurrency(summaryData.total, cartInfo.PRICE_TYPE) : formatCurrency(totalAmount, cartInfo.PRICE_TYPE)}</th>
                  <th colspan="2"></th>
                </tr>
            `;
        } else {
            totalRow = `
                <tr>
                  <th colspan="8"></th>
                  <th style="text-align: center;">Genel Toplam:</th>
                  <th style="text-align: center;">${summaryData ? formatCurrency(summaryData.total, cartInfo.PRICE_TYPE) : formatCurrency(totalAmount, cartInfo.PRICE_TYPE)}</th>
                  <th colspan="2"></th>
                </tr>
            `;
        }
        // PDF butonlarƒ±nƒ± belirleyen deƒüi≈üken:
        const pdfButtons = cartInfo.CONCEPT === 1 
          ? `<button class="btn btn-primary" onclick="generateConceptPDF('tr')">Konsept PDF (T√ºrk√ße)</button>
             <button class="btn btn-primary" onclick="generateConceptPDF('en')">Konsept PDF (English)</button>`
          : `<button class="btn btn-primary" onclick="generatePDF('tr')">PDF (T√ºrk√ße)</button>
             <button class="btn btn-primary" onclick="generatePDF('en')">PDF (English)</button>`;

        modalCartContent.innerHTML = `
          <table class="table table-bordered">
            <thead>
              <tr>
                <th>Fotoƒüraf</th>
                <th class="sortable" data-sort-field="PRODUCT_ID">√úr√ºn ID</th>
                <th>√úr√ºn Adƒ±</th>
                ${showCategoryColumn ? `<th>Kategori</th>` : ""}
                <th>Miktar</th>
                <th>Fiyat</th>
                <th>ƒ∞nd.(%)</th>
                <th>ƒ∞ndirimli Fiyat</th>
                <th>Kdvsiz Tutar</th>
                <th>KDV Tutarƒ±</th>
                <th>Tutar</th>
                <th>Sil</th>
                <th>√ñzelle≈ütir</th>
              </tr>
            </thead>
            <tbody id="cartTableBody">
              ${rowsHtml}
            </tbody>
            <tfoot>
              ${footerRow}
              ${additionalRow}
              ${totalRow}
              <tr>
                <td colspan="6" class="text-left">
                  <button class="btn btn-secondary" onclick="generateExcelAndOpenEmail()">Kod Talebi</button>
                </td>
                <td colspan="4" class="text-right">
                  ${pdfButtons}
                </td>
              </tr>
            </tfoot>
          </table>
        `;

        // Yeni: Sepet √∂zet bilgilerini (total, freight, insurance) sunucudan √ßek ve g√∂ster
        try {
            const summaryResponse = await fetch(`http://192.168.30.4:3000/cart-summary/${activeCartId}`);
            if (summaryResponse.ok) {
                const summaryData = await summaryResponse.json();
                if (summaryData.success) {
                    // Genel Toplamƒ± formatlayarak g√∂sterelim
                    document.getElementById('totalDisplayValue').innerText = formatCurrency(summaryData.total, window.currentCartInfo ? window.currentCartInfo.PRICE_TYPE : 1);
                    // Navlun ve Sigorta input alanlarƒ±nƒ± da sunucudan gelen deƒüerlerle g√ºncelleyelim (varsa)
                    const freightInput = document.getElementById('freightInput');
                    if (freightInput) freightInput.value = summaryData.freight;
                    const insuranceInput = document.getElementById('insuranceInput');
                    if (insuranceInput) insuranceInput.value = summaryData.insurance;
                    updateCartFreightInsurance();
                }
            } else {
                console.error("Cart summary fetch failed");
            }
        } catch (error) {
            console.error("Sepet √∂zeti g√ºncelleme hatasƒ±:", error);
        }
        $('#cartModal').modal('show');
    } catch (error) {
        console.error('Sepet i√ßeriƒüi y√ºklenemedi:', error);
        modalCartContent.innerHTML = `<p class="text-danger">Bir hata olu≈ütu: ${error.message}</p>`;
        $('#cartModal').modal('show');
		
    }
    $('#cartModal').on('shown.bs.modal', () => {
        loadCkartList();
		
    });
	attachProductIdSorting();
};

// Eƒüer global olarak tanƒ±mlƒ± deƒüilse getImageUrl ve formatCurrency fonksiyonlarƒ±nƒ± ekleyin:
const getImageUrl = (productId) => {
  const basePath = '/resim';
  return `${basePath}/${productId}.jpg`;
};


const attachProductIdSorting = () => {
  // √úr√ºn ID ba≈ülƒ±ƒüƒ± th elementini se√ßiyoruz
  const productIdHeader = document.querySelector('th.sortable[data-sort-field="PRODUCT_ID"]');
  
  if (productIdHeader) {
    if (!window.productIdSortDirection) {
      window.productIdSortDirection = 'asc';
    }
    productIdHeader.addEventListener('click', async function() {
      console.log("√úr√ºn Id ba≈ülƒ±ƒüƒ± tƒ±klandƒ±");
      // Sƒ±ralama y√∂n√ºn√º tersine √ßeviriyoruz
      window.productIdSortDirection = window.productIdSortDirection === 'asc' ? 'desc' : 'asc';
      
      // Sƒ±ralama parametreleriyle endpoint √ßaƒürƒ±sƒ± yapƒ±yoruz
      const sortUrl = `http://192.168.30.4:3000/get-cart/${activeCartId}?order=PRODUCT_ID&direction=${window.productIdSortDirection}`;
      try {
        const response = await fetch(sortUrl);
        if (!response.ok) throw new Error('Sƒ±ralƒ± sepet verisi alƒ±namadƒ±.');
        const data = await response.json();
        if (data.success) {
          const items = data.items;
          let totalQuantity = 0, totalAmount = 0, totalKdvsiz = 0, totalKdv = 0;
          // Global olarak g√∂sterilen cartInfo'yu kullanƒ±yoruz (showCartContents i√ßinde window.currentCartInfo atanƒ±yor)
          const cartInfo = window.currentCartInfo;
          const showCategoryColumn = (cartInfo && cartInfo.CONCEPT === 1);
          
          // Satƒ±rlarƒ±n tamamƒ±nƒ± olu≈üturuyoruz
          const tbodyContent = items.map(item => {
            totalQuantity += item.QUANTITY;
            totalKdvsiz += item.AMOUNT_NOTINCLUDED_VAT;
            totalKdv += item.VAT_TOTAL;
            totalAmount += item.TOTAL_AMOUNT;
            
            const imageUrl = getImageUrl(item.PRODUCT_ID);
            const fallbackImage = '/resim/YOK.jpg';
            
            const isCustomized = !!(item.CUSTOM_CODE || item.CUSTOM_NAME);
            const rowClass = isCustomized ? 'customized-row' : '';
            const discountedPrice = item.DISCOUNTED_PRICE;
            const kdvsizTutar = item.AMOUNT_NOTINCLUDED_VAT;
            const kdvTutari = item.VAT_TOTAL;
            const total = item.TOTAL_AMOUNT;
            
            return `
              <tr class="${rowClass}">
                <td>
                  <img src="${imageUrl}" onerror="this.onerror=null;this.src='${fallbackImage}';" alt="√úr√ºn Fotoƒürafƒ±" style="width: 50px; height: 50px; object-fit: cover;">
                </td>
                <td>
                  ${isCustomized ? '<span style="font-weight: bold; color: #000;">Referans Kod:</span> ' : ''}
                  ${item.PRODUCT_ID}<br><br>
                  <span style="font-weight: bold; color: #0d285a;">${item.CUSTOM_CODE || ''}</span>
                </td>
                <td>
                  ${item.PRODUCT_NAME}<br><br>
                  <span style="font-weight: bold; color: #0d285a;">${item.CUSTOM_NAME || ''}</span>
                </td>
                ${showCategoryColumn ? `
                <td>
                  <label>
                    <input type="checkbox" id="mainConcept-${item.cartItemId}" ${item.MAINCONCEPT ? 'checked' : ''} onchange="updateCartCategory(${item.cartItemId}, this)">
                    Ana Konsept
                  </label><br>
                  <label>
                    <input type="checkbox" id="additional-${item.cartItemId}" ${item.ADDITIONAL ? 'checked' : ''} onchange="updateCartCategory(${item.cartItemId}, this)">
                    Tam.√úr√ºnler
                  </label><br>
                  <label>
                    <input type="checkbox" id="additionalaks-${item.cartItemId}" ${item.ADDITIONALAKS ? 'checked' : ''} onchange="updateCartCategory(${item.cartItemId}, this)">
                    Tam. Aks.
                  </label><br>
                  <label>
                    <input type="checkbox" id="accessories-${item.cartItemId}" ${item.ACCESSORIES ? 'checked' : ''} onchange="updateCartCategory(${item.cartItemId}, this)">
                    Ek Aksesuar
                  </label><br>
                  <label>
                    <input type="checkbox" id="supplementary-${item.cartItemId}" ${item.SUPPLEMENTARY ? 'checked' : ''} onchange="updateCartCategory(${item.cartItemId}, this)">
                    Ek √úr√ºn
                  </label>
                </td>
                ` : ""}
                <td>
                  <div class="quantity-controls">
                    <button class="quantity-btn" onclick="updateQuantity(${item.cartItemId}, -1)">-</button>
                    <input type="text" class="quantity-input" id="quantity-${item.cartItemId}" value="${item.QUANTITY}" readonly />
                    <button class="quantity-btn" onclick="updateQuantity(${item.cartItemId}, 1)">+</button>
                  </div>
                </td>
                <td>
                  ${isCustomized ? `
                    <input type="number" id="customPrice-${item.cartItemId}" value="${item.CUSTOM_PRICE || item.PRICE}" min="0" step="100" onchange="handleCustomPriceChange(${item.cartItemId}, true)" style="width: 80px; text-align: right;" />
                  ` : `
                    <span style="display: block; text-align: right;">${formatCurrency(item.PRICE, cartInfo.PRICE_TYPE)}</span>
                  `}
                </td>
                <td>
                  <input type="number" id="discountRate-${item.cartItemId}" value="${(item.CUSTOM_DISCOUNT_RATE !== undefined && item.CUSTOM_DISCOUNT_RATE !== null) ? item.CUSTOM_DISCOUNT_RATE : (item.DISCOUNT_RATE || 0)}" min="0" max="100" step="5" onchange="handleCustomPriceChange(${item.cartItemId}, ${isCustomized})" style="width: 60px; text-align: center;" />
                </td>
                <td style="text-align: right;" id="discountedPrice-${item.cartItemId}">
                  ${formatCurrency(discountedPrice, cartInfo.PRICE_TYPE)}
                </td>
                <td style="text-align: right;">
                  ${formatCurrency(kdvsizTutar, cartInfo.PRICE_TYPE)}
                </td>
                <td style="text-align: right;">
                  ${formatCurrency(kdvTutari, cartInfo.PRICE_TYPE)}
                </td>
                <td style="text-align: right;" id="totalAmount-${item.cartItemId}">
                  ${formatCurrency(total, cartInfo.PRICE_TYPE)}
                </td>
                <td>
                  <button class="btn btn-danger btn-sm" onclick="removeFromCart(${item.cartItemId})">
                    <i class="fa fa-trash"></i>
                  </button>
                </td>
                <td>
                  <button class="btn btn-info btn-sm" title="√ñzelle≈ütir" onclick="openConfigModal(${item.cartItemId})">
                    <i class="fa fa-cogs"></i>
                  </button>
                  <button class="btn btn-danger btn-sm" title="√ñzelle≈ütirmeyi Sil" onclick="deleteCustomization(${item.cartItemId})">
                    <i class="fa fa-times"></i>
                  </button>
                  <button class="btn btn-warning btn-sm" title="√ñneri" onclick="openSuggestionModal('${item.PRODUCT_ID}')">
                    <i class="fa fa-lightbulb-o"></i>
                  </button>
                </td>
              </tr>
            `;
          }).join("");
          
          const tbody = document.getElementById('cartTableBody');
          if (tbody) {
            tbody.innerHTML = tbodyContent;
            console.log("Yeni tbody i√ßeriƒüi g√ºncellendi:", tbody.innerHTML);
          } else {
            console.error("cartTableBody id'li tbody bulunamadƒ±.");
          }
          
        } else {
          console.error("Sƒ±ralƒ± sepet verisi alƒ±nƒ±rken hata olu≈ütu.");
        }
      } catch (error) {
        console.error("Sƒ±ralama fetch hatasƒ±:", error);
      }
    });
  } else {
    console.error("√úr√ºn ID s√ºtunu th elementi bulunamadƒ±. L√ºtfen th etiketinin class ve data-sort-field √∂zniteliklerini kontrol edin.");
  }
};


// M√º≈üteri Tipi G√ºncelleme
async function updateCartCustomerType(newType) {
  try {
    const response = await fetch(`http://192.168.30.4:3000/cart/${activeCartId}/customer-type`, {
      method: 'PUT',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ customerType: newType })
    });
    if (!response.ok) {
      const errorData = await response.json();
      alert(`M√º≈üteri tipi g√ºncellenemedi: ${errorData.message}`);
    } else {
      
      // M√º≈üteri tipi deƒüi≈ütiƒüinde, KDV alanƒ± otomatik g√ºncellendiƒüi i√ßin bunu da veritabanƒ±na yollayalƒ±m.
      if (newType === 'perakende') {
        // Perakende i√ßin KDV Dahil: 1
        await updateCartVatIncluded('1', true);
      } else if (newType === 'toptan') {
        // Toptan i√ßin KDV Hari√ß: 0
        await updateCartVatIncluded('0', true);
      } 
      // Kurumsal i√ßin kullanƒ±cƒ± se√ßimi devam edeceƒüinden burada otomatik g√ºncelleme yapmayƒ±z.
      showCartContents();
	  updateCartSummary(); // Yeni eklenen √∂zet g√ºncelleme √ßaƒürƒ±sƒ±
    }
  } catch (error) {
    console.error("M√º≈üteri tipi g√ºncelleme hatasƒ±:", error);
    alert("M√º≈üteri tipi g√ºncellenirken bir hata olu≈ütu.");
  }
}
//Banka Se√ßeneklerini Y√ºkleyen Fonksiyon
async function loadBankOptions(selectedBank) {
  try {
    const response = await fetch('http://192.168.30.4:3000/api/banks');
    const result = await response.json();
    if (result.success) {
      let options = `<option value="">Se√ßiniz</option>`;
      result.data.forEach(bank => {
        // Se√ßili bankayƒ± belirlemek i√ßin
        const selected = bank.KOD === selectedBank ? "selected" : "";
        options += `<option value="${bank.KOD}" ${selected}>${bank.ADI}</option>`;
      });
      document.getElementById('bankSelector').innerHTML = options;
    }
  } catch (error) {
    console.error("Error loading bank options:", error);
  }
}

//Cart‚Äôin Bankasƒ±nƒ± G√ºncelleyen Fonksiyon
async function updateCartBank(selectedBank) {
  try {
    const response = await fetch('http://192.168.30.4:3000/update-cart-bank', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ cartId: activeCartId, bank: selectedBank })
    });
    const result = await response.json();
    if (!result.success) {
      alert(result.message);
    }
  } catch (error) {
    console.error("Error updating cart bank:", error);
  }
}

// Satƒ±≈ü B√∂lgesi G√ºncelleme
async function updateCartSalesArea(newSalesArea) {
    try {
        const response = await fetch(`http://192.168.30.4:3000/cart/${activeCartId}/sales-area`, {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ salesArea: newSalesArea })
        });
        if (!response.ok) {
            const errorData = await response.json();
            alert(`Satƒ±≈ü b√∂lgesi g√ºncellenemedi: ${errorData.message}`);
        } else {
            
            // Yeni satƒ±≈ü b√∂lgesine g√∂re VAT hesaplamalarƒ±nƒ± g√ºncelle:
            await fetch(`http://192.168.30.4:3000/cart/${activeCartId}/update-vat`, { method: 'PUT' });
            showCartContents();
			updateCartSummary(); // Yeni eklenen √∂zet g√ºncelleme √ßaƒürƒ±sƒ±
        }
    } catch (error) {
        console.error("Satƒ±≈ü b√∂lgesi g√ºncelleme hatasƒ±:", error);
        alert("Satƒ±≈ü b√∂lgesi g√ºncellenirken bir hata olu≈ütu.");
    }
}
// √ñdeme ≈ûartlarƒ± se√ßeneklerini y√ºkleyen fonksiyon
const loadPaymentTermsOptions = async (currentValue) => {
  try {
    const response = await fetch('/api/paymentterms');
    if (!response.ok) throw new Error('Payment terms se√ßenekleri alƒ±namadƒ±.');
    const result = await response.json();
    if (result.success) {
      const selector = document.getElementById('paymentTermsSelector');
      selector.innerHTML = `<option value="">√ñdeme ≈ûartlarƒ± Se√ßiniz</option>`;
      result.data.forEach(term => {
        // Dil ayarƒ±na g√∂re etiket: √ñrneƒüin, "tr" i√ßin TR s√ºtunu, "en" i√ßin EN s√ºtunu.
        const label = (window.currentLanguage && window.currentLanguage === "en") ? term.EN : term.TR;
        const option = document.createElement('option');
        option.value = term.KOD;
        option.textContent = label;
        if (term.KOD === currentValue) {
          option.selected = true;
        }
        selector.appendChild(option);
      });
      selector.addEventListener('change', async function() {
        const selectedValue = this.value;
        updateCartPaymentTerms(selectedValue);
      });
    }
  } catch (error) {
    console.error('√ñdeme ≈üartlarƒ± y√ºklenirken hata:', error);
  }
};

// Konsept Alanƒ± se√ßeneklerini y√ºkleyen fonksiyon
const conceptareaOptions = async (currentValue) => {
  try {
    const response = await fetch('/api/conceptarea');
    if (!response.ok) throw new Error('Payment terms se√ßenekleri alƒ±namadƒ±.');
    const result = await response.json();
    if (result.success) {
      const selector = document.getElementById('conceptareaSelector');
      selector.innerHTML = `<option value="">Konsept Alanƒ±nƒ± Se√ßiniz..</option>`;
      result.data.forEach(concept => {
        // Dil ayarƒ±na g√∂re etiket: √ñrneƒüin, "tr" i√ßin TR s√ºtunu, "en" i√ßin EN s√ºtunu.
        const label = (window.currentLanguage && window.currentLanguage === "en") ? concept.EN : concept.TR;
        const option = document.createElement('option');
        option.value = concept.KOD;
        option.textContent = label;
        if (concept.KOD === currentValue) {
          option.selected = true;
        }
        selector.appendChild(option);
      });
      selector.addEventListener('change', async function() {
        const selectedValue = this.value;
        updateconceptarea(selectedValue);
      });
    }
  } catch (error) {
    console.error('Konsept alanlarƒ± y√ºklenirken hata:', error);
  }
};

// CKART listesini y√ºkleyen fonksiyon
async function loadCkartList() {
  try {
    const response = await fetch('/api/ckart');
    if (response.ok) {
      const data = await response.json();
      const ckartSelect = document.getElementById("ckartSelect");
      ckartSelect.innerHTML = `<option value="">Se√ßiniz</option>`;
      data.data.forEach(item => {
        const option = document.createElement("option");
        option.value = item.KOD;
        // Listede "ADI (KOD)" formatƒ±nda g√∂r√ºns√ºn
        option.textContent = `${item.ADI} (${item.KOD})`;
        // Arama i√ßin hem ADI hem de KOD'u dahil et
        option.setAttribute("data-tokens", `${item.ADI} ${item.KOD}`);
        ckartSelect.appendChild(option);
      });
      // Eƒüer Bootstrap Select kullanƒ±yorsanƒ±z yenileyin
      $(ckartSelect).selectpicker("refresh");

      // Sepet bilgileri y√ºklendiƒüinde, eƒüer aktif sepetin CKOD deƒüeri varsa bunu select'te se√ßin
      if (window.currentCartInfo && window.currentCartInfo.CKOD) {
        ckartSelect.value = window.currentCartInfo.CKOD;
        $(ckartSelect).selectpicker("refresh");
      }
    } else {
      console.error("CKART verileri alƒ±namadƒ±:", response.status, response.statusText);
    }
  } catch (error) {
    console.error("CKART listesi y√ºklenirken hata:", error);
  }
}


// CKART se√ßimi deƒüi≈ütiƒüinde g√ºncelleme yapan event listener
document.getElementById("ckartSelect").addEventListener("change", async function() {
  const selectedCkod = this.value;
  if (!activeCartId) {
    alert("√ñnce sepet olu≈üturulmalƒ± veya aktif sepet se√ßilmeli.");
    return;
  }
  
  // Se√ßili option'ƒ±n metnini alƒ±p ADI kƒ±smƒ±nƒ± √ßƒ±kartƒ±yoruz.
  const selectedOption = this.options[this.selectedIndex];
  // Eƒüer metin "ADI (KOD)" ≈üeklindeyse, ADI'yƒ± ayƒ±klamak i√ßin:
  const optionText = selectedOption.textContent;
  const adValue = optionText.split(" (")[0];  // " (" karakterine g√∂re b√∂l√ºp ilk kƒ±smƒ± alƒ±yoruz.
  
  try {
    const response = await fetch("http://192.168.30.4:3000/cart/update-ckod", {
      method: "PUT",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ cartId: activeCartId, ckod: selectedCkod })
    });
    if (response.ok) {
      // Backend'den d√∂nen data.customerName yerine, se√ßili option'dan aldƒ±ƒüƒ±mƒ±z adValue'yu kullanƒ±yoruz.
      alert("Sepet bilgileri g√ºncellendi.");
      document.getElementById("cartNameDisplay").innerHTML = `
        <input type="text" id="customerNameInput" value="${adValue}" placeholder="M√º≈üteri Adƒ±" 
          onblur="updateCustomerName(this.value)" style="width: 100%; padding: 5px;" />
      `;
    } else {
      alert("G√ºncelleme sƒ±rasƒ±nda hata olu≈ütu.");
    }
  } catch (error) {
    console.error("CKOD g√ºncelleme hatasƒ±:", error);
  }
});




// Se√ßilen √∂deme ≈üartlarƒ±nƒ± CART tablosuna kaydeden fonksiyon
const updateCartPaymentTerms = async (newValue) => {
  try {
    const response = await fetch(`/cart/${activeCartId}/paymentterms`, {
      method: 'PUT',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ paymentTerms: newValue })
    });
    const result = await response.json();
    if (!result.success) {
      alert(result.message);
    } else {
      
    }
  } catch (error) {
    console.error('√ñdeme ≈üartlarƒ± g√ºncellenirken hata:', error);
  }
};

// Se√ßilen Konsept Alanƒ±nƒ± CART tablosuna kaydeden fonksiyon
const updateconceptarea = async (newValue) => {
  try {
    const response = await fetch(`/cart/${activeCartId}/conceptarea`, {
      method: 'PUT',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ conceptarea: newValue })
    });
    const result = await response.json();
    if (!result.success) {
      alert(result.message);
    } else {
      
    }
  } catch (error) {
    console.error('Konsept alanƒ± g√ºncellenirken hata:', error);
  }
};
// Teslim S√ºresi se√ßeneklerini y√ºkleyen fonksiyon (sabit se√ßenekler)
const loadDeliveryTimeOptions = (currentValue) => {
  const options = [1, 2, 3, 4, 6, 8, 10, 12];
  const selector = document.getElementById('deliveryTimeSelector');
  selector.innerHTML = `<option value="">Teslim S√ºresi Se√ßiniz</option>`;
  options.forEach(option => {
    const opt = document.createElement('option');
    opt.value = option;
    opt.textContent = option; // ƒ∞steƒüe g√∂re "g√ºn" veya "hafta" ekleyebilirsiniz
    if (String(option) === String(currentValue)) {
      opt.selected = true;
    }
    selector.appendChild(opt);
  });
  selector.addEventListener('change', async function(){
      const selectedValue = this.value;
      updateCartDeliveryTime(selectedValue);
  });
};

// Se√ßilen teslim s√ºresini g√ºncelleyen fonksiyon
const updateCartDeliveryTime = async (newValue) => {
  try {
    const response = await fetch(`/cart/${activeCartId}/deliverytime`, {
      method: 'PUT',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ deliveryTime: newValue })
    });
    const result = await response.json();
    if (!result.success) {
      alert(result.message);
    } else {
      
    }
  } catch (error) {
    console.error('Teslim s√ºresi g√ºncellenirken hata:', error);
  }
};
// KDV Dahil/Hari√ß G√ºncelleme
async function updateCartVatIncluded(newVatIncluded, force = false) {
  try {
    // Eƒüer force parametresi true ise veya select √∂ƒüesi enabled ise API √ßaƒürƒ±sƒ± yap.
    if (force || !document.getElementById('vatIncludedSelector').disabled) {
      const response = await fetch(`http://192.168.30.4:3000/cart/${activeCartId}/vat-included`, {
        method: 'PUT',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ vatIncluded: newVatIncluded })
      });
      if (!response.ok) {
        const errorData = await response.json();
        alert(`KDV durumu g√ºncellenemedi: ${errorData.message}`);
        return;
      } else {
        
        // G√ºncelleme ba≈üarƒ±lƒ±ysa, sepetteki √ºr√ºnlerin hesaplamalarƒ±nƒ± g√ºncellemek i√ßin update-vat endpoint'ini tetikleyin.
        await fetch(`http://192.168.30.4:3000/cart/${activeCartId}/update-vat`, { method: 'PUT' });
        showCartContents();
		updateCartSummary(); // Yeni eklenen √∂zet g√ºncelleme √ßaƒürƒ±sƒ±
      }
    }
  } catch (error) {
    console.error("KDV g√ºncelleme hatasƒ±:", error);
    alert("KDV durumu g√ºncellenirken bir hata olu≈ütu.");
  }
}


// Fiyat Tipi Se√ßeneklerini G√ºncelle (showCartContents i√ßinde √ßaƒürƒ±lƒ±yor)
function updateCartPriceTypeOptions(customerType, currentPriceType) {
    const priceTypeSelector = document.getElementById('priceTypeSelector');
    priceTypeSelector.innerHTML = '';
    if (customerType === 'toptan') {
        priceTypeSelector.add(new Option('TOP TL', '2'));
        priceTypeSelector.add(new Option('TOP USD', '3'));
        priceTypeSelector.add(new Option('TOP EUR', '6'));
    } else {
        priceTypeSelector.add(new Option('PRK TL', '1'));
        priceTypeSelector.add(new Option('PRK USD', '4'));
        priceTypeSelector.add(new Option('PRK EUR', '5'));
    }
    priceTypeSelector.value = currentPriceType || (customerType === 'toptan' ? '2' : '1');
}

// KDV Se√ßeneklerini G√ºncelle
function updateCartVatIncludedOptions(customerType, currentVatIncluded) {
    const vatIncludedSelector = document.getElementById('vatIncludedSelector');
    vatIncludedSelector.innerHTML = '';
    if (customerType === 'perakende') {
        vatIncludedSelector.add(new Option('Dahil', '1'));
        vatIncludedSelector.value = '1';
        vatIncludedSelector.disabled = true;
    } else if (customerType === 'toptan') {
        vatIncludedSelector.add(new Option('Hari√ß', '0'));
        vatIncludedSelector.value = '0';
        vatIncludedSelector.disabled = true;
    } else { // kurumsal
        vatIncludedSelector.add(new Option('Dahil', '1'));
        vatIncludedSelector.add(new Option('Hari√ß', '0'));
        vatIncludedSelector.disabled = false;
        // currentVatIncluded deƒüeri 0 ise (ya da "0") onu kullan, aksi halde 1 deƒüerini kullan.
        if (currentVatIncluded === 0 || currentVatIncluded === '0') {
            vatIncludedSelector.value = '0';
        } else {
            vatIncludedSelector.value = '1';
        }
    }
}
//Ba≈ülƒ±ktaki Fiyat Tipini G√ºncelleme Fonksiyonu
const updateCartPriceType = async (priceType) => {
    try {
        // 1. Adƒ±m: Fiyat tipi g√ºncelleme isteƒüini g√∂nderiyoruz.
        const response = await fetch(`http://192.168.30.4:3000/cart/${activeCartId}/price-type`, {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ priceType })
        });

        if (!response.ok) {
            const errorData = await response.json();
            alert(`Hata: ${errorData.message}`);
            return;
        }
        
        
        // 2. Adƒ±m: Fiyat tipi deƒüi≈üikliƒüi, √ºr√ºn hesaplamalarƒ±nƒ± etkileyebileceƒüinden, 
        // t√ºm satƒ±rlar i√ßin VAT hesaplamalarƒ±nƒ± yeniden g√ºncellemek amacƒ±yla update‚Äëvat endpoint‚Äôini √ßaƒüƒ±rƒ±yoruz.
        await fetch(`http://192.168.30.4:3000/cart/${activeCartId}/update-vat`, { method: 'PUT' });
        
        // 3. Adƒ±m: G√ºncel sepet i√ßeriƒüini y√ºkle
        showCartContents();
		updateCartSummary(); // Yeni eklenen √∂zet g√ºncelleme √ßaƒürƒ±sƒ±
    } catch (error) {
        console.error('Fiyat tipi g√ºncelleme hatasƒ±:', error);
        alert('Bir hata olu≈ütu, l√ºtfen tekrar deneyin.');
    }
};


//ba≈ülƒ±ktaki indirim oranƒ±nƒ± deƒüi≈ütiren fonksiyon
const updateCartDiscountRate = async (discountRate) => {
  try {
    // ƒ∞ndirim oranƒ± g√ºncelleme isteƒüi
    const response = await fetch(`http://192.168.30.4:3000/cart/${activeCartId}/discount-rate`, {
      method: 'PUT',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ discountRate })
    });

    if (!response.ok) {
      const errorData = await response.json();
      alert(`Hata: ${errorData.message}`);
      return;
    }
    
    // ƒ∞ndirim oranƒ± deƒüi≈ütiƒüinde, sepetteki √ºr√ºnlerin hesaplamalarƒ±nƒ± yeniden yapabilmek i√ßin update‚Äëvat endpoint'ini tetikleyin
    await fetch(`http://192.168.30.4:3000/cart/${activeCartId}/update-vat`, { method: 'PUT' });
    
    // G√ºncellenen sepet i√ßeriƒüini ekrana yansƒ±tƒ±n
    showCartContents();
	updateCartSummary(); // Yeni eklenen √∂zet g√ºncelleme √ßaƒürƒ±sƒ±
  } catch (error) {
    console.error('Sepet indirimi g√ºncelleme hatasƒ±:', error);
    alert('Bir hata olu≈ütu, l√ºtfen tekrar deneyin.');
  }
};
//indirim oranƒ± deƒüi≈ütiƒüinde backend'e bir istek g√∂nderir ve tabloyu yeniden y√ºkler.
const updateDiscountRate = async (cartItemId, discountRate) => {
    try {
        const response = await fetch(`http://192.168.30.4:3000/cart/item/${cartItemId}/update-discount-vat`, {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ discountRate })
        });
        if (!response.ok) {
            const errorData = await response.json();
            alert(`Hata: ${errorData.message}`);
            return;
        }
        showCartContents();
		updateCartFreightInsurance();
		
    } catch (error) {
        console.error('Satƒ±r bazƒ±nda g√ºncelleme hatasƒ±:', error);
        alert('Bir hata olu≈ütu, l√ºtfen tekrar deneyin.');
    }
};
//Navlun ve Sigorta G√ºncelleme Fonksiyonu
const updateCartFreightInsurance = async () => {
  try {
    // Input alanlarƒ±ndan navlun ve sigorta deƒüerlerini al
    const freightInput = document.getElementById('freightInput');
    const insuranceInput = document.getElementById('insuranceInput');
    const freight = parseFloat(freightInput.value) || 0;
    const insurance = parseFloat(insuranceInput.value) || 0;

    // Yeni sepet √∂zet endpoint'ine PUT isteƒüi g√∂nder
    const response = await fetch(`http://192.168.30.4:3000/cart/${activeCartId}/update-summary`, {
      method: 'PUT',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ freight, insurance })
    });

    if (!response.ok) {
      const errorData = await response.json();
      alert(`√ñzet g√ºncellemesi yapƒ±lamadƒ±: ${errorData.message}`);
      return;
    }
    const result = await response.json();
    // G√ºncellenen sepet i√ßeriƒüini yeniden y√ºkle
    showCartContents();
	updateCartSummary(); // Yeni eklenen √∂zet g√ºncelleme √ßaƒürƒ±sƒ±
  } catch (error) {
    console.error("Navlun/Sigorta g√ºncelleme hatasƒ±:", error);
    alert("Navlun/Sigorta g√ºncellenirken bir hata olu≈ütu.");
  }
};

//Sepet GrandTotal yazdƒ±rma
const updateCartSummary = async () => {
  try {
    // Navlun ve Sigorta deƒüerlerini al (input'larda tanƒ±mlƒ±ysa)
    const freightInput = document.getElementById('freightInput');
    const insuranceInput = document.getElementById('insuranceInput');
    const freight = freightInput ? parseFloat(freightInput.value) || 0 : 0;
    const insurance = insuranceInput ? parseFloat(insuranceInput.value) || 0 : 0;
    
    // √ñzet g√ºncelleme endpoint'ine istek g√∂nder
    const response = await fetch(`http://192.168.30.4:3000/cart/${activeCartId}/update-summary`, {
      method: 'PUT',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ freight, insurance })
    });
    
    if (!response.ok) {
      const errorData = await response.json();
      alert(`Sepet √∂zeti g√ºncellenemedi: ${errorData.message}`);
      return;
    }
    const result = await response.json();
    
    // total: SUBTOTAL + VATTOTAL + FREIGHT + INSURANCE
    // Bu deƒüeri formatlayarak modalda g√∂sterelim.
    document.getElementById('totalDisplayValue').innerText = formatCurrency(result.total, window.currentCartInfo ? window.currentCartInfo.PRICE_TYPE : 1);
  } catch (error) {
    console.error("Sepet √∂zeti g√ºncelleme hatasƒ±:", error);
    //alert("Sepet √∂zeti g√ºncellenirken bir hata olu≈ütu.");
  }
};

//toplamlarƒ± g√ºncelle
const updateTotalAmount = (items, priceType) => {
    let totalQuantity = 0;
    let totalAmount = 0;

    items.forEach(item => {
        const customPriceElement = document.getElementById(`customPrice-${item.cartItemId}`);
        const discountRateElement = document.getElementById(`discountRate-${item.cartItemId}`);

        const customPrice = customPriceElement && customPriceElement.value !== ""
            ? parseFloat(customPriceElement.value)
            : item.PRICE; // Eƒüer √∂zelle≈ütirilmi≈ü fiyat yoksa orijinal fiyatƒ± kullan

        const discountRate = discountRateElement && discountRateElement.value !== ""
            ? parseFloat(discountRateElement.value)
            : item.DISCOUNT_RATE; // Eƒüer √∂zelle≈ütirilmi≈ü indirim oranƒ± yoksa orijinal oranƒ± kullan

        const discountedPrice = customPrice * (1 - discountRate / 100);
        const rowTotal = discountedPrice * item.QUANTITY;

        totalQuantity += item.QUANTITY;
        totalAmount += rowTotal;
    });

    // Alt toplamlarƒ± g√ºncelle
    const totalQuantityElement = document.getElementById("totalQuantity");
    const totalAmountElement = document.getElementById("totalAmount");

    if (totalQuantityElement) totalQuantityElement.innerText = totalQuantity;
    if (totalAmountElement) totalAmountElement.innerText = formatCurrency(totalAmount, priceType);
};
//√ñzelle≈ütirmeyi silen Fonksiyon
async function deleteCustomization(cartItemId) {
    try {
        const confirmation = confirm("Bu √ºr√ºne ait √∂zelle≈ütirmeyi silmek istediƒüinize emin misiniz?");
        if (!confirmation) return;

        const response = await fetch(`/api/cart-items/${cartItemId}/customization`, {
            method: 'DELETE'
        });

        const json = await response.json();

        if (json.success) {
            alert('√ñzelle≈ütirme ba≈üarƒ±yla silindi.');
            await showCartContents(); // Sepet i√ßeriƒüini g√ºncelle
        } else {
            alert(`Hata: ${json.message}`);
        }
    } catch (error) {
        console.error('√ñzelle≈ütirme silinirken hata:', error);
        alert('√ñzelle≈ütirme silinirken bir hata olu≈ütu.');
    }
}

//Kod Talebi Fonksiyonu
async function generateExcelAndOpenEmail() {
    try {
        // Sepet i√ßeriƒüini al
        const response = await fetch(`http://192.168.30.4:3000/get-cart/${activeCartId}`);
        if (!response.ok) throw new Error('Sepet i√ßeriƒüi alƒ±namadƒ±.');

        const { items } = await response.json();

        // Sepet bilgilerini al
        const cartInfoResponse = await fetch(`http://192.168.30.4:3000/cart-info/${activeCartId}`);
        if (!cartInfoResponse.ok) throw new Error('Sepet bilgileri alƒ±namadƒ±.');

        const cartInfo = await cartInfoResponse.json();
        const customerName = cartInfo.CUSTOMER_NAME || 'Bilinmiyor';
        const cartId = activeCartId || 'Bilinmiyor';

        // Sadece √∂zelle≈ütirilmi≈ü √ºr√ºnleri filtrele
        const customizedItems = items.filter(item => item.CUSTOM_CODE || item.CUSTOM_NAME);

        // Eƒüer √∂zelle≈ütirilmi≈ü √ºr√ºn yoksa uyarƒ± ver ve √ßƒ±k
        if (customizedItems.length === 0) {
            alert('Sepette √∂zelle≈ütirilmi≈ü √ºr√ºn bulunamadƒ±.');
            return;
        }

        // ExcelJS ile Excel dosyasƒ± olu≈üturma
        const ExcelJS = window.ExcelJS;
        const workbook = new ExcelJS.Workbook();
        const worksheet = workbook.addWorksheet('Kod Talebi');

        // Ba≈ülƒ±klar
        worksheet.columns = [
            { header: 'Referans Kod', key: 'referenceCode', width: 20 },
            { header: '√ñzelle≈ütirilmi≈ü Kod', key: 'customCode', width: 20 },
            { header: '√ñzelle≈ütirilmi≈ü Ad', key: 'customName', width: 40 },
            { header: 'Model Kod', key: 'modelKod', width: 20 },
            { header: 'Model Adƒ±', key: 'modelAdi', width: 30 },
            { header: 'Materyal Kod', key: 'materyalKod', width: 20 },
            { header: 'Materyal Adƒ±', key: 'materyalAdi', width: 30 },
            { header: 'Desen Kod', key: 'desenKod', width: 20 },
            { header: 'Desen Adƒ±', key: 'desenAdi', width: 30 },
            { header: 'Lamine Kod', key: 'lamineKod', width: 20 },
            { header: 'Lamine Adƒ±', key: 'lamineAdi', width: 30 },
            { header: 'Aksesuar1 Kod', key: 'aksesuar1Kod', width: 20 },
            { header: 'Aksesuar1 Adƒ±', key: 'aksesuar1Adi', width: 30 },
            { header: 'Aksesuar2 Kod', key: 'aksesuar2Kod', width: 20 },
            { header: 'Aksesuar2 Adƒ±', key: 'aksesuar2Adi', width: 30 },
            { header: 'Aksesuar3 Kod', key: 'aksesuar3Kod', width: 20 },
            { header: 'Aksesuar3 Adƒ±', key: 'aksesuar3Adi', width: 30 },
            { header: 'Ebat Kod', key: 'ebatKod', width: 20 },
            { header: 'Ebat Adƒ±', key: 'ebatAdi', width: 30 },
            { header: 'Renk Kod', key: 'renkKod', width: 20 },
            { header: 'Renk Adƒ±', key: 'renkAdi', width: 30 }
        ];

        // √ñzelle≈ütirilmi≈ü √ºr√ºnleri ekleyin
        customizedItems.forEach(item => {
            worksheet.addRow({
                referenceCode: item.PRODUCT_ID,
                customCode: item.CUSTOM_CODE || '',
                customName: item.CUSTOM_NAME || '',
                modelKod: item.MODEL_KOD || '',
                modelAdi: item.MODEL_ADI || '',
                materyalKod: item.MATERYAL_KOD || '',
                materyalAdi: item.MATERYAL_ADI || '',
                desenKod: item.DESEN_KOD || '',
                desenAdi: item.DESEN_ADI || '',
                lamineKod: item.LAMINE_KOD || '',
                lamineAdi: item.LAMINE_ADI || '',
                aksesuar1Kod: item.AKSESUAR1_KOD || '',
                aksesuar1Adi: item.AKSESUAR1_ADI || '',
                aksesuar2Kod: item.AKSESUAR2_KOD || '',
                aksesuar2Adi: item.AKSESUAR2_ADI || '',
                aksesuar3Kod: item.AKSESUAR3_KOD || '',
                aksesuar3Adi: item.AKSESUAR3_ADI || '',
                ebatKod: item.EBAT_KOD || '',
                ebatAdi: item.EBAT_ADI || '',
                renkKod: item.RENK_KOD || '',
                renkAdi: item.RENK_ADI || ''
            });
        });

        // Excel dosyasƒ±nƒ± olu≈ütur ve e-postayƒ± g√∂nder
        const buffer = await workbook.xlsx.writeBuffer();
        const blob = new Blob([buffer], { type: 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet' });
        const fileName = `Kod_Talebi_Sepet_${cartId}.xlsx`;

        // Mail ve indirme i≈ülemleri
        const fileURL = URL.createObjectURL(blob);
        const email = 'planlama@estetikdecor.com';
        const subject = encodeURIComponent(`Kod Talebi - Sepet ${cartId}`);
        const body = encodeURIComponent(`
Merhaba,

Ekteki dosyada kod talebi detaylarƒ±nƒ± bulabilirsiniz.

M√º≈üteri Adƒ±: ${customerName}
Sepet No: ${cartId}
Talep Edilen Kod Sayƒ±sƒ±: ${customizedItems.length}

Saygƒ±lar.
        `);

        const mailtoLink = `mailto:${email}?subject=${subject}&body=${body}`;
        const a = document.createElement('a');
        a.href = mailtoLink;
        a.click();

        const downloadLink = document.createElement('a');
        downloadLink.href = fileURL;
        downloadLink.download = fileName;
        downloadLink.click();
        URL.revokeObjectURL(fileURL);
    } catch (error) {
        console.error('Excel olu≈üturulurken veya mail g√∂nderilirken hata:', error);
        alert('Excel olu≈üturulurken bir hata olu≈ütu.');
    }
}


//ba≈ülƒ±ktaki m√º≈üteri ismini deƒüi≈ütiren Fonksiyon
const updateCustomerName = async (newName) => {
    try {
        const response = await fetch(`http://192.168.30.4:3000/update-customer-name`, {
            method: 'PUT',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                cartId: activeCartId,
                customerName: newName,
            }),
        });
        if (!response.ok) throw new Error('M√º≈üteri adƒ± g√ºncellenemedi.');
    } catch (error) {
        console.error('M√º≈üteri adƒ± g√ºncelleme hatasƒ±:', error);
    }
};

//Sepet Kategorilerini G√ºncelleme
const updateCartCategory = async (cartItemId, changedElem) => {
  // Eƒüer tƒ±klanan checkbox se√ßiliyse, diƒüerlerinin se√ßimini kaldƒ±rƒ±yoruz:
  if (changedElem.checked) {
    const mainConceptElem = document.querySelector(`#mainConcept-${cartItemId}`);
    const additionalElem = document.querySelector(`#additional-${cartItemId}`);
	const additionalAksElem = document.querySelector(`#additionalaks-${cartItemId}`);
    const accessoriesElem = document.querySelector(`#accessories-${cartItemId}`);
	const supplementaryElem = document.querySelector(`#supplementary-${cartItemId}`);
    
    if (changedElem !== mainConceptElem) {
      mainConceptElem.checked = false;
    }
    if (changedElem !== additionalElem) {
      additionalElem.checked = false;
    }
	if (changedElem !== additionalAksElem) {
      additionalAksElem.checked = false;
    }
    if (changedElem !== accessoriesElem) {
      accessoriesElem.checked = false;
    }
	if (changedElem !== supplementaryElem) {
      supplementaryElem.checked = false;
    }
  }
  
  // Her checkbox'ƒ±n durumunu alƒ±yoruz:
  const mainConceptChecked = document.querySelector(`#mainConcept-${cartItemId}`).checked;
  const additionalChecked = document.querySelector(`#additional-${cartItemId}`).checked;
  const additionalAksChecked = document.querySelector(`#additionalaks-${cartItemId}`).checked;
  const accessoriesChecked = document.querySelector(`#accessories-${cartItemId}`).checked;
  const supplementaryChecked = document.querySelector(`#supplementary-${cartItemId}`).checked;

  try {
    const response = await fetch('http://192.168.30.4:3000/update-cart-category', {
      method: 'PUT',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        cartItemId: cartItemId, // G√ºncellenen sepet √∂ƒüesi
        mainConcept: mainConceptChecked ? 1 : 0, 
        additional: additionalChecked ? 1 : 0,
		additionalaks: additionalAksChecked ? 1 : 0,
		supplementary: supplementaryChecked ? 1 : 0,
        accessories: accessoriesChecked ? 1 : 0
      })
    });

    if (!response.ok) throw new Error('Kategori g√ºncellenemedi.');

    const result = await response.json();

    if (result.success) {
      await showCartContents(); // Sepet i√ßeriƒüini yenile
    } else {
      throw new Error(result.message || 'Kategori g√ºncellenirken hata olu≈ütu.');
    }
  } catch (error) {
    console.error('‚ö†Ô∏è Kategori g√ºncelleme hatasƒ±:', error);
    alert(`Bir hata olu≈ütu: ${error.message}`);
  }
};


//Miktar G√ºncelleme Fonksiyonu 
const updateQuantity = async (cartItemId, change) => {
    try {
        // Input alanƒ±nƒ± bul ve mevcut miktarƒ± al
        const quantityInput = document.getElementById(`quantity-${cartItemId}`);
        if (!quantityInput) {
            console.error(`Element not found: quantity-${cartItemId}`);
            throw new Error(`Miktar input elemanƒ± bulunamadƒ±: quantity-${cartItemId}`);
        }

        const currentQuantity = parseInt(quantityInput.value, 10);
        const newQuantity = currentQuantity + change;
        if (newQuantity < 1) {
            alert('Miktar 1\'den k√º√ß√ºk olamaz.');
            return;
        }

        // Backend API'ye miktar g√ºncelleme isteƒüi g√∂nder
        const response = await fetch('http://192.168.30.4:3000/update-cart-item', {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                cartItemId, // Cart item ID g√∂nderiliyor
                quantity: newQuantity
            })
        });

        if (!response.ok) throw new Error('Miktar g√ºncellenemedi.');
        const result = await response.json();

        if (result.success) {
            // Miktar input deƒüerini g√ºncelle
            quantityInput.value = newQuantity;

            // Satƒ±rdaki mevcut indirim oranƒ±nƒ± al (√∂rneƒüin, discountRate input'undan)
            const discountRateElement = document.getElementById(`discountRate-${cartItemId}`);
            const discountRate = parseFloat(discountRateElement?.value || 0);

            // Miktar g√ºncellendikten sonra, ilgili satƒ±rƒ±n VAT ve diƒüer hesaplama alanlarƒ±nƒ± yeniden hesaplamak i√ßin
            // update-discount-vat endpoint‚Äôini √ßaƒüƒ±rƒ±yoruz (bu endpoint, satƒ±rdaki discountRate, quantity, VAT hesaplamalarƒ±nƒ± yapƒ±yor)
            const vatResponse = await fetch(`http://192.168.30.4:3000/cart/item/${cartItemId}/update-discount-vat`, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ discountRate })
            });
            if (!vatResponse.ok) {
                const vatError = await vatResponse.json();
                alert(`KDV hesaplamalarƒ± g√ºncellenemedi: ${vatError.message}`);
            } else {
            }

            // Sepet i√ßeriƒüini yeniden y√ºkle
            showCartContents();
			updateCartFreightInsurance()
        } else {
            throw new Error(result.message || 'Miktar g√ºncellenirken bir hata olu≈ütu.');
        }
    } catch (error) {
        console.error('Miktar g√ºncelleme hatasƒ±:', error);
        alert(`Bir hata olu≈ütu: ${error.message}`);
    }
};


	const addImageToPDF = async (doc, url, x, y, width, height) => {
		try {
			const response = await fetch(url);
			const blob = await response.blob();
			const reader = new FileReader();
			reader.onload = function (event) {
				const base64Image = event.target.result;
				doc.addImage(base64Image, 'JPEG', x, y, width, height);
			};
			reader.readAsDataURL(blob);
		} catch (error) {
			console.error(`Resim eklenemedi: ${url}`, error);
		}
	};

// Sepeti G√∂sterme
const showCartList = async () => {
  try {
    const userId = localStorage.getItem('userId');
    if (!userId) {
      alert('Sepetleri g√∂r√ºnt√ºlemek i√ßin √∂nce giri≈ü yapmalƒ±sƒ±nƒ±z.');
      $('#loginModal').modal('show');
      return;
    }

    // Kullanƒ±cƒ± bilgilerini √ßekelim ve CONCEPTADMIN ile CONCEPTUNLOCK deƒüerlerini alalƒ±m.
    const userResponse = await fetch(`http://192.168.30.4:3000/api/user/${userId}`);
    if (!userResponse.ok) throw new Error('Kullanƒ±cƒ± bilgisi alƒ±namadƒ±.');
    const userData = await userResponse.json();
    const isAdmin = userData.CONCEPTADMIN === 1;
    // Kilidi kaldƒ±rma yetkisini belirleyelim: Eƒüer true ise kullanƒ±cƒ± kilidi a√ßabilir, false ise sadece kilitleyebilir.
    const userConceptUnlock = userData.CONCEPTUNLOCK === 1;
    console.log("Kullanƒ±cƒ± Konsept Kilit Admin", userConceptUnlock);

    // Sepetleri backend'den √ßekelim
    const response = await fetch(`http://192.168.30.4:3000/carts/${userId}`);
    if (!response.ok) throw new Error('Sepet listesi alƒ±namadƒ±.');
    const carts = await response.json();

    // En az bir konsept sepet var mƒ± kontrol edelim
    const hasConceptCart = carts.some(cart => cart.CONCEPT == 1);

    // Eƒüer konsept sepet varsa; sƒ±ralama √∂nce CONCEPT_AREA'ya g√∂re (tanƒ±mlƒ± sƒ±ralama dizisi) sonra CUSTOMER_NAME'e g√∂re yapƒ±lƒ±r.
    if (hasConceptCart) {
      const conceptAreaOrder = [
        "OTURMA ODASI - SECTIONAL",
        "OTURMA ODASI",
        "OTURMA ODASI - TV UNITESI",
        "OTURMA ODASI - TEA CORNER",
        "OTURMA ODASI - BAR",
        "YEMEK ODASI - MASA",
        "YEMEK ODASI - B√úFE/KONSOL",
        "YATAK ODASI",
        "YATAK ODASI - MAKYAJ",
        "YATAK ODASI - DOLAP",
        "YATAK ODASI - CEKMECE",
        "YATAK ODASI - JOSEFIN",
        "ANTRE",
        "GIYINME ODASI",
        "OFIS",
        "TERAS",
        "ARANJMAN - CICEK",
        "Dƒ∞ƒûER"
      ];

      carts.sort((a, b) => {
        if (a.CONCEPT == 1 && b.CONCEPT == 1) {
          let indexA = conceptAreaOrder.indexOf(a.CONCEPT_AREA);
          let indexB = conceptAreaOrder.indexOf(b.CONCEPT_AREA);
          if (indexA === -1) indexA = conceptAreaOrder.length;
          if (indexB === -1) indexB = conceptAreaOrder.length;
          if (indexA !== indexB) return indexA - indexB;
          return a.CUSTOMER_NAME.localeCompare(b.CUSTOMER_NAME);
        } else if (a.CONCEPT == 1) {
          return -1;
        } else if (b.CONCEPT == 1) {
          return 1;
        } else {
          return a.CUSTOMER_NAME.localeCompare(b.CUSTOMER_NAME);
        }
      });
    } else {
      carts.sort((a, b) => a.CUSTOMER_NAME.localeCompare(b.CUSTOMER_NAME));
    }

    // Tablo ba≈ülƒ±ƒüƒ±nƒ± olu≈üturuyoruz; (ilk render‚Äôda modal a√ßƒ±ldƒ±ƒüƒ±nda konsept sepetler gizli, fakat s√ºtunlar render ediliyor)
    let cartListHtml = `
      <table class="table table-bordered">
        <thead>
          <tr>
            <th>ID</th>
            ${hasConceptCart ? `<th>Konsept Alanƒ±</th>` : ""}
            <th>M√º≈üteri Adƒ±</th>
            <th>Olu≈üturulma Tarihi</th>
            <th>Olu≈üturan Kullanƒ±cƒ±</th>
            ${hasConceptCart && isAdmin ? `<th>Konsept</th>` : ""}
            <th>Konsept Kilidi</th>
            <th>ƒ∞≈ülemler</th>
          </tr>
        </thead>
        <tbody>
    `;

    carts.forEach(cart => {
      const isConcept = cart.CONCEPT == 1;
      // Eƒüer konsept sepet ise, satƒ±r ilk a√ßƒ±lƒ±≈üta gizlensin.
      cartListHtml += `<tr class="${isConcept ? 'concept-cart' : ''}" ${isConcept ? 'style="display:none;"' : ''}>`;
      cartListHtml += `<td>${cart.ID}</td>`;
      if (hasConceptCart) {
        // Konsept alanƒ± s√ºtunu: Sadece konsept sepetlerde g√∂sterilir.
        cartListHtml += `<td class="text-center">${isConcept ? (cart.CONCEPT_AREA || "") : ""}</td>`;
      }
      cartListHtml += `<td>${cart.CUSTOMER_NAME}</td>`;
      cartListHtml += `<td>${new Date(cart.CREATED_AT).toLocaleString()}</td>`;
      cartListHtml += `<td>${cart.USER_ID}</td>`;

      // Admin i√ßin "Konsept" checkbox s√ºtunu:
      // Burada, checkbox her zaman aktif olsun (kilit durumuna bakƒ±lmaksƒ±zƒ±n) √ß√ºnk√º kilit kaldƒ±rma i≈ülemi kullanƒ±cƒ± yetkisine baƒülƒ±.
      if (hasConceptCart && isAdmin) {
        cartListHtml += `
          <td class="text-center">
            <input type="checkbox" class="concept-checkbox" data-cart-id="${cart.ID}"
                   ${isConcept ? "checked" : ""} />
          </td>
        `;
      }

      // "Konsept Kilidi" s√ºtunu: Eƒüer sepet kilitliyse (cart.CONCEPTLOCK == 1) ve kullanƒ±cƒ± yetkisi yoksa disable,
      // aksi halde (kilitli deƒüilse) t√ºm kullanƒ±cƒ±lar kilitleyebilir.
      cartListHtml += `
          <td class="text-center">
            <input type="checkbox" class="conceptlock-checkbox" data-cart-id="${cart.ID}"
                   ${cart.CONCEPTLOCK == 1 ? "checked" : ""}
                   ${(cart.CONCEPTLOCK == 1 && !userConceptUnlock) ? "disabled" : ""} />
          </td>
      `;

      // "ƒ∞≈ülemler" s√ºtunu: "Bu Sepeti Se√ß" ve "Sil" butonlarƒ±, eƒüer sepet kilitliyse disable edilsin.
      cartListHtml += `
          <td class="text-center">
            <button class="btn btn-primary btn-sm me-2" onclick="setActiveCart(${cart.ID})" title="Bu Sepeti Se√ß" ${cart.CONCEPTLOCK == 1 ? "disabled" : ""}>
              <i class="fas fa-check-circle"></i>
            </button>
            <button class="btn btn-danger btn-sm" onclick="deleteCart(${cart.ID})" title="Sil" ${cart.CONCEPTLOCK == 1 ? "disabled" : ""}>
              <i class="fas fa-trash-alt"></i>
            </button>
          </td>
      `;
      cartListHtml += `</tr>`;
    });

    cartListHtml += `</tbody></table>`;
    document.getElementById('cartListModalBody').innerHTML = cartListHtml;

    // Admin i√ßin, "Konsept" checkbox'larƒ± event listener'ƒ±:
    if (isAdmin && hasConceptCart) {
      document.querySelectorAll('.concept-checkbox').forEach(checkbox => {
        checkbox.addEventListener('change', function () {
          const cartId = this.dataset.cartId;
          const conceptValue = this.checked ? 1 : 0;
          fetch("http://192.168.30.4:3000/api/cart/concept", {
            method: "PUT",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ cartId, conceptValue })
          })
          .then(response => response.json())
          .then(data => {
            console.log("Konsept g√ºncellendi:", data);
            // Eƒüer konsept checkbox'ƒ± unchecked yapƒ±ldƒ±ysa, otomatik olarak "Konsept Kilidi" checkbox'ƒ±nƒ± sƒ±fƒ±rla
            if (!this.checked) {
              const lockCheckbox = document.querySelector(`.conceptlock-checkbox[data-cart-id="${cartId}"]`);
              if (lockCheckbox) {
                lockCheckbox.checked = false;
                // Backend'de de CONCEPTLOCK deƒüeri 0 olarak g√ºncellensin
                fetch("http://192.168.30.4:3000/api/cart/conceptlock", {
                  method: "PUT",
                  headers: { "Content-Type": "application/json" },
                  body: JSON.stringify({ cartId, conceptLockValue: 0 })
                })
                .then(response => response.json())
                .then(dataLock => {
                  console.log("Konsept kilidi g√ºncellendi (otomatik):", dataLock);
                  // Butonlarƒ± enable yapalƒ±m
                  const setCartBtn = document.querySelector(`button[onclick="setActiveCart(${cartId})"]`);
                  if (setCartBtn) {
                    setCartBtn.disabled = false;
                  }
                  const deleteCartBtn = document.querySelector(`button[onclick="deleteCart(${cartId})"]`);
                  if (deleteCartBtn) {
                    deleteCartBtn.disabled = false;
                  }
                })
                .catch(error => console.error("Konsept kilidi g√ºncelleme hatasƒ± (otomatik):", error));
              }
            }
          })
          .catch(error => console.error("G√ºncelleme hatasƒ±:", error));
        });
      });
    }

    // "Konsept Kilidi" checkbox'larƒ± i√ßin event listener:
    document.querySelectorAll('.conceptlock-checkbox').forEach(checkbox => {
      checkbox.addEventListener('change', function () {
        const cartId = this.dataset.cartId;
        const newLockValue = this.checked ? 1 : 0;
        // Eƒüer kullanƒ±cƒ± kilidi kaldƒ±rmaya (unlock) √ßalƒ±≈üƒ±yor fakat yetkisi yoksa i≈ülemi iptal et
        if (newLockValue === 0 && !userConceptUnlock) {
          alert("Kilidi kaldƒ±ramazsƒ±nƒ±z. Bu i≈ülem i√ßin yetkiniz bulunmuyor.");
          this.checked = true;
          return;
        }
        fetch("http://192.168.30.4:3000/api/cart/conceptlock", {
          method: "PUT",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ cartId, conceptLockValue: newLockValue })
        })
        .then(response => response.json())
        .then(data => {
          console.log("Konsept kilidi g√ºncellendi:", data);
          // G√ºncelleme sonrasƒ±, "Bu Sepeti Se√ß" ve "Sil" butonlarƒ±nƒ±n durumunu g√ºncelleyelim.
          const setCartBtn = document.querySelector(`button[onclick="setActiveCart(${cartId})"]`);
          if (setCartBtn) {
            setCartBtn.disabled = newLockValue == 1;
          }
          const deleteCartBtn = document.querySelector(`button[onclick="deleteCart(${cartId})"]`);
          if (deleteCartBtn) {
            deleteCartBtn.disabled = newLockValue == 1;
          }
          // Admin konsept checkbox'ƒ± i√ßin de g√ºncelleme yapalƒ±m (kilit kaldƒ±rma, yetki varsa aktif)
          const conceptCheckbox = document.querySelector(`.concept-checkbox[data-cart-id="${cartId}"]`);
          if (conceptCheckbox) {
            conceptCheckbox.disabled = newLockValue == 1 && !userConceptUnlock;
          }
        })
        .catch(error => console.error("Konsept kilidi g√ºncelleme hatasƒ±:", error));
      });
    });

    $('#cartListModal').modal('show'); // Modalƒ± g√∂ster

  } catch (error) {
    console.error('Sepet listesi hatasƒ±:', error);
    alert('Bir hata olu≈ütu: ' + error.message);
  }
};


	// Fiyat tipi belirleme fonksiyonu
	const getPriceType = (priceType) => {
		switch (Number(priceType)) {
			case 1: return "PRK TL";
			case 2: return "TOP TL";
			case 3: return "TOP USD";
			case 4: return "PRK USD";
			case 5: return "PRK EUR";
			case 6: return "TOP EUR";
			default: return "Bilinmiyor";
		}
	};

	document.getElementById("cartModal").addEventListener("shown.bs.dropdown", function (e) {
		const dropdownMenu = e.target.querySelector(".dropdown-menu");
		if (dropdownMenu) {
			dropdownMenu.style.position = "absolute";
			dropdownMenu.style.transform = "translateY(-100%)";
			dropdownMenu.style.zIndex = "1060";
		}
	});

	// CartModal'ƒ± kapatma i≈ülevi
	const closeCartModal = () => {
		$('#cartModal').modal('hide'); // Bootstrap modalƒ±nƒ± gizler
	};
	// CartListModal'ƒ± kapatma i≈ülevi
	const closeCartListModal = () => {
		$('#cartListModal').modal('hide'); // Bootstrap modalƒ±nƒ± gizler
	};
	// CartFormModal'ƒ± kapatma i≈ülevi
	const closeCartFormModal = () => {
		$('#cartFormModal').modal('hide'); // Bootstrap modalƒ±nƒ± gizler
	};
	
// Konfig√ºrasyon Modalƒ±nƒ± A√ßma Fonksiyonu
async function openConfigModal(cartItemId) {
    try {

        document.getElementById('configCartItemId').value = cartItemId;

        const lookupTypes = {
            model: 71,
            materyal: 72,
            desen: 73,
            lamine: 74,
            aksesuar1: 75,
            aksesuar2: 75,
            aksesuar3: 75,
            ebat: 78,
            renk: 79,
			ayak: 209
        };

        // Dropdown'larƒ± doldur ve default deƒüerleri ayarla
        for (const [key, type] of Object.entries(lookupTypes)) {
            await fillDropdown(`${key}Select`, type);
        }

        // Konfig√ºrasyon verilerini sunucudan √ßek
        const response = await fetch(`/api/cart-items/${cartItemId}/config`);
        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }

        const json = await response.json();
        const data = json.success && json.data ? json.data : {};

        // Dropdown'lara default deƒüerleri set et
        $('#modelSelect').val(data.MODEL_KOD || data.MODELKOD || '').selectpicker('refresh');
        $('#materyalSelect').val(data.MATERYAL_KOD || data.MATERYALKOD || '').selectpicker('refresh');
        $('#desenSelect').val(data.DESEN_KOD || data.DESENKOD || '').selectpicker('refresh');
        $('#lamineSelect').val(data.LAMINE_KOD || data.LAMINEKOD || '').selectpicker('refresh');
        $('#aksesuar1Select').val(data.AKSESUAR1_KOD || data.AKSESUAR1KOD || '').selectpicker('refresh');
        $('#aksesuar2Select').val(data.AKSESUAR2_KOD || data.AKSESUAR2KOD || '').selectpicker('refresh');
        $('#aksesuar3Select').val(data.AKSESUAR3_KOD || data.AKSESUAR3KOD || '').selectpicker('refresh');
        $('#ebatSelect').val(data.EBAT_KOD || data.EBATKOD || '').selectpicker('refresh');
        $('#renkSelect').val(data.RENK_KOD || data.RENKKOD || '').selectpicker('refresh');
		$('#ayakSelect').val(data.AYAK_KOD || data.AYAKKOD || '').selectpicker('refresh');

        // Referans kodu ve diƒüer alanlar
        document.getElementById('referenceCodeInput').value = data.REFERENCE_CODE || '';
        document.getElementById('customCodeInput').value = data.CUSTOM_CODE || '';
        document.getElementById('customNameInput').value = data.CUSTOM_NAME || '';

        // Modal i≈ülemleri
        $('#cartModal').modal('hide');
        $('#configureModal').modal('show');
    } catch (error) {
        console.error('Konfig√ºrasyon y√ºklenemedi:', error);
        alert('Konfig√ºrasyon y√ºklenirken bir hata olu≈ütu.');
    }
}

// Dropdown'larƒ± doldurma fonksiyonu
async function fillDropdown(selectId, type) {
    try {

        const response = await fetch(`/api/lookups?tip=${type}`);
        if (!response.ok) throw new Error('Lookup verileri alƒ±namadƒ±.');

        const json = await response.json();
        if (!json.success) throw new Error('Lookup verileri ba≈üarƒ±lƒ± bir ≈üekilde alƒ±namadƒ±.');

        const selectElement = $(`#${selectId}`);
        if (selectElement.length === 0) {
            //console.error(`Dropdown element (${selectId}) bulunamadƒ±.`);
            return;
        }

        // Mevcut se√ßenekleri temizle
        selectElement.empty();

        // Varsayƒ±lan se√ßeneƒüi ekle
        selectElement.append('<option value="">Se√ßiniz</option>');

        // Yeni se√ßenekleri ekle
        json.data.forEach((item) => {
            selectElement.append(`<option value="${item.KOD}">${item.ADI}</option>`);
        });

        // Bootstrap Select'i yenile
        if (typeof selectElement.selectpicker === 'function') {
            selectElement.selectpicker('refresh');
        } else {
            console.error('selectpicker fonksiyonu mevcut deƒüil.');
        }
    } catch (error) {
        console.error(`Dropdown (${selectId}) doldurulurken hata:`, error);
    }
}


async function saveConfig() {
	const referenceCode = document.getElementById('referenceCodeInput').value.trim();
    const cartItemId = document.getElementById('configCartItemId').value;
    const customCode = document.getElementById('customCodeInput').value.trim();
    const customName = document.getElementById('customNameInput').value.trim();
    const modelKod = document.getElementById('modelSelect').value;
    const materyalKod = document.getElementById('materyalSelect').value;
    const desenKod = document.getElementById('desenSelect').value;
    const lamineKod = document.getElementById('lamineSelect').value;
    const aksesuar1Kod = document.getElementById('aksesuar1Select').value;
    const aksesuar2Kod = document.getElementById('aksesuar2Select').value;
    const aksesuar3Kod = document.getElementById('aksesuar3Select').value;
    const ebatKod = document.getElementById('ebatSelect').value;
    const renkKod = document.getElementById('renkSelect').value;
	const ayakKod = document.getElementById('ayakSelect').value;

    const payload = {
		referenceCode,
        customCode,
        customName,
        modelKod: modelKod || null,
        materyalKod: materyalKod || null,
        desenKod: desenKod || null,
        lamineKod: lamineKod || null,
        aksesuar1Kod: aksesuar1Kod || null,
        aksesuar2Kod: aksesuar2Kod || null,
        aksesuar3Kod: aksesuar3Kod || null,
        ebatKod: ebatKod || null,
        renkKod: renkKod || null,
		ayakKod: ayakKod || null
		
    };

    try {
        const response = await fetch(`/api/cart-items/${cartItemId}/config`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload)
        });

        if (!response.ok) {
            throw new Error(`HTTP hata kodu: ${response.status}`);
        }

        const json = await response.json();

        if (json.success) {
            alert('Konfig√ºrasyon ba≈üarƒ±yla kaydedildi.');
            $('#configureModal').modal('hide');
            // Sepet i√ßeriƒüini g√ºncellemek i√ßin gerekirse yeniden y√ºkleyebilirsiniz
            if (typeof showCartContents === 'function') {
                showCartContents();
            }
        } else {
            alert(`Hata: ${json.message}`);
        }
    } catch (error) {
        console.error('Konfig√ºrasyon kaydedilirken hata:', error);
        alert(`Konfig√ºrasyon kaydedilirken bir hata olu≈ütu: ${error.message}`);
    }
}



	</script>
	<script>
document.getElementById('loginForm').addEventListener('submit', async (e) => {
  e.preventDefault();

  const username = document.getElementById('username').value.trim();
  const password = document.getElementById('password').value.trim();

  try {
    const res = await fetch('/auth/login', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ username, password })
    });
    const data = await res.json();

    if (!data.success) {
      return alert(data.message || 'Ge√ßersiz kullanƒ±cƒ± adƒ± veya ≈üifre.');
    }

    // 1) LocalStorage‚Äôa oturum bilgisini kaydet
    localStorage.setItem('username',         data.user.username);
    localStorage.setItem('userId',           data.user.id);
    localStorage.setItem('isAdmin',          data.user.isAdmin ? "true" : "false");
    localStorage.setItem('isCampaignAdmin',  data.user.isCampaignAdmin ? "true" : "false");
    localStorage.setItem('token',            data.token);

    // 2) Modal‚Äôƒ± kapat
    $('#loginModal').modal('hide');

    // 3) Anƒ±nda UI‚Äôƒ± g√ºncelle
    updateAuthUI();

  } catch (err) {
    console.error('Login hatasƒ±:', err);
    alert('Sunucuya ula≈üƒ±lamadƒ±.');
  }
});


// Sayfa y√ºklendiƒüinde kullanƒ±cƒ± adƒ± otomatik yazƒ±lsƒ±n
window.addEventListener('DOMContentLoaded', () => {
  const username = localStorage.getItem('username');
  if (username) {
    document.getElementById('usernameDisplay').textContent = username;
  }
});

function updateAuthUI() {
  const authButton      = document.getElementById("authButton");
  const authIcon        = document.getElementById("authIcon");
  const welcomeMessage  = document.getElementById("welcomeMessage");
  const usernameDisplay = document.getElementById("usernameDisplay");
  const adminTabs       = document.getElementById("adminTabs");
  const campaignMenu    = document.getElementById("campaignMenu");

  const username        = localStorage.getItem("username");
  const isAdmin         = localStorage.getItem("isAdmin") === "true";
  const isCampaignAdmin = localStorage.getItem("isCampaignAdmin") === "true";

  // Kampanya men√ºs√º (inline display)
  campaignMenu.style.display = isCampaignAdmin ? "" : "none";

  if (username) {
    // ‚Äî Oturum A√ßƒ±k ‚Äî
    authIcon.className = "fas fa-sign-out-alt";
    authButton.title   = "√áƒ±kƒ±≈ü Yap";
    authButton.removeAttribute("data-toggle");
    authButton.removeAttribute("data-target");

    // Ho≈ü geldin mesajƒ±nƒ± **inline** olarak g√∂ster (inline-stylde tanƒ±mlƒ± margin vs. kalƒ±r)
    welcomeMessage.style.display = "";

    usernameDisplay.textContent = username;

    // Admin sekmelerini g√∂ster
		if (isAdmin) {
            adminTabs.style.display = "flex"; // Sekmeleri g√∂r√ºn√ºr yap
        } else {
            adminTabs.style.display = "none"; // Normal kullanƒ±cƒ± sekmeleri g√∂rmesin
        }

    authButton.onclick = () => {
      localStorage.clear();
      updateAuthUI();
	  
    };
  } else {
    // ‚Äî Oturum Kapalƒ± ‚Äî
    authIcon.className = "fas fa-user";
    authButton.title   = "Giri≈ü Yap";
    authButton.setAttribute("data-toggle", "modal");
    authButton.setAttribute("data-target", "#loginModal");

    // T√ºm mesaj/tablarƒ± inline gizle
    welcomeMessage.style.display = "none";
    adminTabs.style.display      = "none";

    authButton.onclick = null;
  }
}

// Sayfa ilk y√ºklendiƒüinde ve login/logout sonrasƒ± √ßaƒüƒ±rƒ±n
document.addEventListener("DOMContentLoaded", updateAuthUI);


document.addEventListener("DOMContentLoaded", () => {
    const authButton = document.getElementById("authButton");
    const authIcon = document.getElementById("authIcon");
    const usernameDisplay = document.getElementById("usernameDisplay");
    const welcomeMessage = document.getElementById("welcomeMessage");
	const adminTabs = document.getElementById("adminTabs"); // Admin sekmeleri

    const username = localStorage.getItem("username"); // Kullanƒ±cƒ± adƒ±nƒ± al
	const userId = localStorage.getItem("userId"); // Kullanƒ±cƒ± adƒ±nƒ± al
	const isAdmin = localStorage.getItem("isAdmin") === "true"; // Admin kontrol√º
	const isCampaignAdmin = localStorage.getItem("isCampaignAdmin") === "true"; // Kampanya Admin kontrol√º
    //Kampanya Y√∂neticisi kontrol√º ile Kampanya Y√∂netim Paneli Men√º G√∂sterimi"	
	if (isCampaignAdmin) {
	  document.getElementById('campaignMenu').style.display = 'block';
	} else {
	  document.getElementById('campaignMenu').style.display = 'none';
	}

    if (username) {
        // Kullanƒ±cƒ± giri≈ü yapmƒ±≈ü
        authIcon.className = "fas fa-sign-out-alt"; // √áƒ±kƒ±≈ü ikonu
        authButton.setAttribute("title", "√áƒ±kƒ±≈ü Yap"); // √áƒ±kƒ±≈ü i√ßin ipucu metni
        authButton.removeAttribute("data-toggle"); // Modal tetikleyici kaldƒ±rƒ±lƒ±r
        authButton.removeAttribute("data-target");

        // Ho≈ü geldin mesajƒ±nƒ± g√∂ster
        welcomeMessage.style.display = "inline";
        usernameDisplay.textContent = username;
		
		// **Admin Kullanƒ±cƒ±ysa Sekmeleri A√ß**
        if (isAdmin) {
            adminTabs.style.display = "flex"; // Sekmeleri g√∂r√ºn√ºr yap
        } else {
            adminTabs.style.display = "none"; // Normal kullanƒ±cƒ± sekmeleri g√∂rmesin
        }

        // √áƒ±kƒ±≈ü i≈ülemini baƒüla
        authButton.onclick = () => {
            localStorage.removeItem("username"); // Giri≈ü bilgisini temizle
			localStorage.removeItem("userId"); // Kullanƒ±cƒ± kimliƒüini temizle
			localStorage.removeItem("isAdmin"); // Admin bilgisi de sƒ±fƒ±rlansƒ±n
			localStorage.removeItem("isCampaignAdmin"); // Admin bilgisi de sƒ±fƒ±rlansƒ±n
			localStorage.removeItem("activeCartId"); // Aktif sepet ID'sini temizle (Eƒüer sepet bu ID ile √ßaƒürƒ±lƒ±yorsa)
			// Eƒüer ba≈üka bir kimlik bilgisi saklanƒ±yorsa, bunlarƒ± da sƒ±fƒ±rlayƒ±n
			sessionStorage.clear(); // T√ºm oturum bilgilerini temizle

            // Sayfayƒ± yenileyerek her ≈üeyi sƒ±fƒ±rla
            location.reload(); // Sayfayƒ± yenile
        };
    } else {
        // Kullanƒ±cƒ± giri≈ü yapmamƒ±≈ü
        authIcon.className = "fas fa-user"; // Giri≈ü ikonu
        authButton.setAttribute("title", "Giri≈ü Yap");
        authButton.setAttribute("data-toggle", "modal"); // Giri≈ü modali tetikleyici
        authButton.setAttribute("data-target", "#loginModal");

        // Ho≈ü geldin mesajƒ±nƒ± gizle
        welcomeMessage.style.display = "none";

        // Giri≈ü i√ßin modal a√ßma davranƒ±≈üƒ±nƒ± koru
        authButton.onclick = null; // √áƒ±kƒ±≈ü i≈ülemini kaldƒ±r
    }
});




	</script>
	<script>
// Dinamik Men√º Doldurma Fonksiyonu
const populateMenus = async () => {
  try {
    const response = await fetch('/api/menu-data'); // Men√º verilerini √ßeken API
    if (!response.ok) throw new Error('Men√º verisi alƒ±namadƒ±.');
    const menuData = await response.json();

    // √úr√ºnler Men√ºs√º
    const urunlerDropdown = document.getElementById('urunlerDropdown');
    if (urunlerDropdown) {
      urunlerDropdown.innerHTML = ""; // Eski i√ßeriƒüi temizle

      // RAPOR ana √∂ƒüesi: dropdown-submenu olarak olu≈üturuluyor
      const raporLi = document.createElement("li");
      raporLi.className = "dropdown-submenu";
      
      const raporLink = document.createElement("a");
      raporLink.className = "dropdown-item";
      raporLink.href = "#";
      raporLink.textContent = "RAPORLAR";
      raporLi.appendChild(raporLink);
      
      // RAPOR alt men√ºs√º: UL olu≈üturuyoruz
      const raporSubmenu = document.createElement("ul");
      raporSubmenu.className = "dropdown-menu";
      
      // "√ñZET" √∂ƒüesi ekle
      const ozetLi = document.createElement("li");
      const ozetLink = document.createElement("a");
      ozetLink.className = "dropdown-item";
      ozetLink.href = "#";
      ozetLink.textContent = "√ñZET";
      // Tƒ±klandƒ±ƒüƒ±nda yalnƒ±zca loadOzetReport √ßaƒürƒ±lacak, diƒüer eventler durdurulacak.
      ozetLink.addEventListener("click", (event) => {
          event.preventDefault();
          event.stopPropagation();
          loadOzetReport();
      });
      ozetLi.appendChild(ozetLink);
      raporSubmenu.appendChild(ozetLi);
      
      raporLi.appendChild(raporSubmenu);
      urunlerDropdown.appendChild(raporLi);
	  
	  // üî• YENƒ∞: "√ñZET MODEL" √∂ƒüesi
      const ozetModelLi = document.createElement("li");
      const ozetModelLink = document.createElement("a");
      ozetModelLink.className = "dropdown-item";
      ozetModelLink.href = "#";
      ozetModelLink.textContent = "√ñZET MODEL";
      ozetModelLink.addEventListener("click", (event) => {
        event.preventDefault();
        event.stopPropagation();
        loadOzetModelReport();
      });
      ozetModelLi.appendChild(ozetModelLink);
      raporSubmenu.appendChild(ozetModelLi);

      raporLi.appendChild(raporSubmenu);
      urunlerDropdown.appendChild(raporLi);

	  // üî• YENƒ∞: "DETAY MODEL" √∂ƒüesi
      const detayModelLi = document.createElement("li");
      const detayModelLink = document.createElement("a");
      detayModelLink.className = "dropdown-item";
      detayModelLink.href = "#";
      detayModelLink.textContent = "DETAY MODEL";
      detayModelLink.addEventListener("click", (event) => {
        event.preventDefault();
        event.stopPropagation();
        loadDetayModelReport();
      });
      detayModelLi.appendChild(detayModelLink);
      raporSubmenu.appendChild(detayModelLi);

      raporLi.appendChild(raporSubmenu);
      urunlerDropdown.appendChild(raporLi);



      // RAPOR grubundan sonra g√∂rsel ayƒ±rƒ±cƒ± ekle
      const divider = document.createElement("div");
      divider.className = "dropdown-divider";
      urunlerDropdown.appendChild(divider);

      // BASAMAK2 kategorilerini alfabetik sƒ±rayla al ve `null` deƒüerleri filtrele
      const sortedBasamak2 = Object.keys(menuData)
          .filter(basamak2 => basamak2 && basamak2.trim() !== "")
          .sort((a, b) => a.localeCompare(b, 'tr'));

      // Alfabetik sƒ±raya g√∂re BASAMAK2 kategorilerini ekle
      sortedBasamak2.forEach(basamak2 => {
          // Ana kategori i√ßin bir men√º ba≈ülƒ±ƒüƒ± olu≈ütur
          const categoryLi = document.createElement('li');
          categoryLi.className = 'dropdown-submenu';

          // Ana kategoriye `data-basamak2` ekle
          categoryLi.innerHTML = `<a class="dropdown-item" href="#" data-basamak2="${basamak2}">${basamak2}</a>`;

          // BASAMAK4 alt kategorilerini alfabetik sƒ±rayla al ve `null` deƒüerleri filtrele
          const sortedBasamak4List = (menuData[basamak2] || [])
              .filter(basamak4 => basamak4 && basamak4.trim() !== "")
              .sort((a, b) => a.localeCompare(b, 'tr'));

          // Alt kategori men√ºs√ºn√º olu≈ütur
          if (sortedBasamak4List.length > 0) {
              const subMenuUl = document.createElement('ul');
              subMenuUl.className = 'dropdown-menu';

              sortedBasamak4List.forEach(basamak4 => {
                  const subMenuLi = document.createElement('li');
                  subMenuLi.innerHTML = `<a class="dropdown-item" href="#" data-basamak2="${basamak2}" data-basamak4="${basamak4}">${basamak4}</a>`;
                  subMenuUl.appendChild(subMenuLi);
              });

              categoryLi.appendChild(subMenuUl);
          }

          urunlerDropdown.appendChild(categoryLi);
      });
    }
  } catch (error) {
    console.error('Men√º doldurma hatasƒ±:', error);
  }
};

//Konseptler Men√ºs√ºn√º Olu≈ütur.
const loadConceptsMenu = async () => {
  try {
    const response = await fetch("http://192.168.30.4:3000/concepts");
    if (!response.ok) throw new Error("Konseptler alƒ±namadƒ±.");
    
    const concepts = await response.json();
    const menu = document.getElementById("conceptsDropdown");
    menu.innerHTML = ""; // √ñnce men√ºy√º temizle

    // RAPOR ana √∂ƒüesi: dropdown-submenu olarak olu≈üturuluyor
    const raporLi = document.createElement("li");
    raporLi.className = "dropdown-submenu";
    
    const raporLink = document.createElement("a");
    raporLink.className = "dropdown-item";
    raporLink.href = "#";
    raporLink.textContent = "RAPORLAR";
    raporLi.appendChild(raporLink);
    
    // RAPOR alt men√ºs√º: UL olu≈üturuyoruz
    const raporSubmenu = document.createElement("ul");
    raporSubmenu.className = "dropdown-menu";
    
    // "√ñZET" √∂ƒüesi ekle
    const ozetLi = document.createElement("li");
    const ozetLink = document.createElement("a");
    ozetLink.className = "dropdown-item";
    ozetLink.href = "#";
    ozetLink.textContent = "√ñZET";
    ozetLink.addEventListener("click", () => loadConceptSummaryReport());
    ozetLi.appendChild(ozetLink);
    raporSubmenu.appendChild(ozetLi);
    
        
    raporLi.appendChild(raporSubmenu);
    menu.appendChild(raporLi);

    // Men√ºde okunurluƒüu artƒ±rmak i√ßin g√∂rsel ayƒ±rƒ±cƒ± ekleyelim
    const divider = document.createElement("div");
    divider.className = "dropdown-divider"; // Bootstrap sƒ±nƒ±fƒ±, yatay √ßizgi olu≈üturur
    menu.appendChild(divider);

    // Devamƒ±nda mevcut konsept alanlarƒ± ekleniyor
    const conceptAreas = [...new Set(concepts.map(c => (c.CONCEPT_AREA || "Diƒüer").trim()))]
                          .sort((a, b) => a.localeCompare(b, 'tr', { sensitivity: 'base' }));
    
    conceptAreas.forEach(area => {
      const li = document.createElement("li");
      li.className = "dropdown-submenu";
      
      const areaLink = document.createElement("a");
      areaLink.className = "dropdown-item";
      areaLink.href = "#";
      areaLink.textContent = area;
      li.appendChild(areaLink);

      const subMenu = document.createElement("ul");
      subMenu.className = "dropdown-menu";
      
      const areaConcepts = concepts
        .filter(c => (c.CONCEPT_AREA || "Diƒüer").trim() === area)
        .sort((a, b) =>
          a.CUSTOMER_NAME.localeCompare(b.CUSTOMER_NAME, 'tr', { sensitivity: 'base' })
        );
      
      areaConcepts.forEach(concept => {
        const subLi = document.createElement("li");
        const conceptLink = document.createElement("a");
        conceptLink.className = "dropdown-item";
        conceptLink.href = "#";
        conceptLink.textContent = concept.CUSTOMER_NAME;
        conceptLink.addEventListener("click", () => loadProductsByConcept(concept.ID));
        subLi.appendChild(conceptLink);
        subMenu.appendChild(subLi);
      });

      li.appendChild(subMenu);
      menu.appendChild(li);
    });
  } catch (error) {
    console.error("Konseptler y√ºklenirken hata:", error);
  }
};





// Sayfa y√ºklendiƒüinde men√ºleri doldur
document.addEventListener('DOMContentLoaded', populateMenus);
document.addEventListener("DOMContentLoaded", loadConceptsMenu);

const loadOzetModelReport = async (language = "tr") => {
  try {
    const productContainer = document.getElementById("product-container");
    if (productContainer) productContainer.style.display = "none";

    const initialImageContainer = document.getElementById("initialImageContainer");
    if (initialImageContainer) initialImageContainer.style.display = "none";
	
	const stokKartiContainer = document.getElementById("stokKartiContainer");
    if (stokKartiContainer) stokKartiContainer.style.display = "none";

    const conceptContainer = document.getElementById("concept-products-container");
    if (conceptContainer) {
      conceptContainer.style.display = "flex";
      conceptContainer.innerHTML = "";
    }

    const response = await fetch("/api/ozet-model-report");
    if (!response.ok) throw new Error("Model bazlƒ± √∂zet raporu alƒ±namadƒ±.");
    const result = await response.json();
    if (!result.success) throw new Error(result.message);
    const data = result.data;

    const grouped = {};
    const seenB2 = new Set();
    const orderedB2 = [];

    data.forEach(item => {
      const b2 = item.BASAMAK2 || "DIGER";
      const b4 = item.BASAMAK4 || "DIGER";
      if (!grouped[b2]) {
        grouped[b2] = {};
        if (!seenB2.has(b2)) {
          orderedB2.push(b2);
          seenB2.add(b2);
        }
      }
      if (!grouped[b2][b4]) grouped[b2][b4] = [];
      grouped[b2][b4].push(item);
    });

    let finalHTML = `
      <style>
        @media print {
          @page { size: A4 portrait; margin: 5mm; }
          body { -webkit-print-color-adjust: exact; }
          #printButton, #exportButton, #toggle100Button { display: none; }
        }
        table { width: 95%; border-collapse: collapse; }
        th, td { padding: 5px; border: 1px solid #ccc; }
        .text-right { text-align: right; }
        .highlight-100 { color: red; font-weight: bold; }
        .hide-100 { display: none !important; }
      </style>
      <div style="max-width: 95%; margin-top: 20px; margin-left: auto; margin-right: auto; font-size: 12px;">
        <div style="display: flex; justify-content: space-between; align-items: center;">
          <h4 style="text-align: center; margin-bottom: 15px;">
            ${language === "tr" ? "Model Bazlƒ± √úr√ºn √ñzet Raporu" : "Model Summary Report"}
          </h4>
          <div>
            <button id="printButton" onclick="printConceptContainer()" class="btn btn-primary">
              <span style="margin-right: 5px;">üñ®</span>Yazdƒ±r
            </button>
            <button id="exportButton" onclick="exportModelSummaryReportToExcel()" class="btn btn-success">
              <span style="margin-right: 5px;">üìä</span>Excel'e Aktar
            </button>
            <button id="toggle100Button" onclick="toggleHundredRows()" class="btn btn-secondary" style="margin-left: 5px;">
              üîÅ %100 Olanlarƒ± Gizle
            </button>
          </div>
        </div>
        <table id="urunozetmodel" class="table table-bordered table-striped">
          <thead>
            <tr>
              <th>S</th>
              <th>BASAMAK4</th>
              <th>MODEL</th>
              <th>Toplam √úr√ºn</th>
              <th>Konsept √úr√ºn</th>
              <th>Konsept Dƒ±≈üƒ±</th>
              <th>Oran (%)</th>
            </tr>
          </thead>
          <tbody>
    `;

    let grandHom = 0;
    let grandKonsept = 0;
    let rowCounter = 1;

    orderedB2.forEach(basamak2 => {
      const basamak4Map = grouped[basamak2];
      const basamak4Keys = Object.keys(basamak4Map).sort((a, b) =>
        a.localeCompare(b, 'tr', { sensitivity: 'base' })
      );

      let b2Rows = "";
      let b2TotalHom = 0;
      let b2TotalKonsept = 0;
      let isB2Fully100 = true;

      basamak4Keys.forEach(basamak4 => {
        const items = basamak4Map[basamak4].sort((a, b) =>
          (a.MODEL || "").localeCompare(b.MODEL || "", 'tr')
        );

        let b4Rows = "";
        let b4TotalHom = 0;
        let b4TotalKonsept = 0;
        let isB4Fully100 = true;

        items.forEach(item => {
          const ratioDisplay = item.Ratio ? item.Ratio.toString().replace('.', ',') : "0%";
          const is100 = ratioDisplay === "100%" || ratioDisplay === "100,00%";
          if (!is100) isB4Fully100 = false;

          b4Rows += `
            <tr class="${is100 ? 'ratio-100-row' : ''}">
              <td>${rowCounter++}</td>
              <td>${item.BASAMAK4}</td>
              <td>${item.MODEL || ""}</td>
              <td class="text-right">${item.HomKodSayisi}</td>
              <td class="text-right">${item.KonseptProductCount}</td>
              <td class="text-right">${item.HomKodSayisi - item.KonseptProductCount}</td>
              <td class="text-right ${is100 ? 'highlight-100' : ''}">${ratioDisplay}</td>
            </tr>
          `;

          b4TotalHom += Number(item.HomKodSayisi) || 0;
          b4TotalKonsept += Number(item.KonseptProductCount) || 0;
        });

        const b4Ratio = b4TotalHom > 0
          ? new Intl.NumberFormat('tr-TR', { minimumFractionDigits: 2, maximumFractionDigits: 2 }).format((b4TotalKonsept / b4TotalHom) * 100) + "%"
          : "0%";

        b2TotalHom += b4TotalHom;
        b2TotalKonsept += b4TotalKonsept;
        if (!isB4Fully100) isB2Fully100 = false;

        b2Rows += `
          <tr style="background-color:#f9f9f9;" class="${isB4Fully100 ? 'ratio-100-group' : ''}">
            <td colspan="7" style="font-weight:bold;">üìÇ ${basamak4}</td>
          </tr>
          ${b4Rows}
          <tr class="${isB4Fully100 ? 'ratio-100-group' : ''}" style="background-color:#f0f0f0; font-weight:bold;">
            <td colspan="3" class="text-right">Alt Toplam (${basamak4}):</td>
            <td class="text-right">${b4TotalHom}</td>
            <td class="text-right">${b4TotalKonsept}</td>
            <td class="text-right">${b4TotalHom - b4TotalKonsept}</td>
            <td class="text-right">${b4Ratio}</td>
          </tr>
        `;
      });

      const b2Ratio = b2TotalHom > 0
        ? new Intl.NumberFormat('tr-TR', { minimumFractionDigits: 2, maximumFractionDigits: 2 }).format((b2TotalKonsept / b2TotalHom) * 100) + "%"
        : "0%";

      finalHTML += `
        <tr class="${isB2Fully100 ? 'ratio-100-group' : ''}" style="background-color:#e6e6e6;">
          <td colspan="7" style="font-weight:bold; text-align:left;">${basamak2}</td>
        </tr>
        ${b2Rows}
        <tr class="${isB2Fully100 ? 'ratio-100-group' : ''}" style="background-color:#d9edf7; font-weight:bold;">
          <td colspan="3" class="text-right">Alt Toplam (${basamak2}):</td>
          <td class="text-right">${b2TotalHom}</td>
          <td class="text-right">${b2TotalKonsept}</td>
          <td class="text-right">${b2TotalHom - b2TotalKonsept}</td>
          <td class="text-right">${b2Ratio}</td>
        </tr>
      `;

      grandHom += b2TotalHom;
      grandKonsept += b2TotalKonsept;
    });

    const grandRatio = grandHom > 0
      ? new Intl.NumberFormat('tr-TR', { minimumFractionDigits: 2, maximumFractionDigits: 2 }).format((grandKonsept / grandHom) * 100) + "%"
      : "0%";

    finalHTML += `
      <tr style="font-weight:bold; background-color:#dcdcdc;">
        <td colspan="3" class="text-right">Genel Toplam:</td>
        <td class="text-right">${grandHom}</td>
        <td class="text-right">${grandKonsept}</td>
        <td class="text-right">${grandHom - grandKonsept}</td>
        <td class="text-right">${grandRatio}</td>
      </tr>
      </tbody>
      </table>
      </div>
    `;

    if (conceptContainer) {
      conceptContainer.innerHTML = finalHTML;
    }

    createStickyHeaderBarY();
  } catch (error) {
    console.error("Model √∂zet raporu y√ºklenirken hata:", error);
    alert("Model √∂zet raporu y√ºklenirken bir hata olu≈ütu: " + error.message);
  }
};

// ‚úÖ %100 Oranlarƒ± Gizle/G√∂ster Butonu
let hide100 = false;
function toggleHundredRows() {
  hide100 = !hide100;
  
  // Toggle buton metnini g√ºncelleyelim:
  const btn = document.getElementById("toggle100Button");
  if (btn) {
    btn.textContent = hide100 ? "üîÅ %100 Olanlarƒ± G√∂ster" : "üîÅ %100 Olanlarƒ± Gizle";
  }
  
  // 1. Veri satƒ±rlarƒ±nƒ± kontrol edelim: 
  // "data-row" sƒ±nƒ±fƒ±na sahip satƒ±rlar arasƒ±nda, eƒüer satƒ±r "ratio-100-row" sƒ±nƒ±fƒ±na sahipse, toggle durumuna g√∂re g√∂ster/gizle.
  const dataRows = document.querySelectorAll("#urundetaymodel tbody tr.data-row");
  dataRows.forEach(row => {
    if (row.classList.contains("ratio-100-row")) {
      row.style.display = hide100 ? "none" : "";
    }
  });
  
  // 2. Her grup i√ßin (group-header ve group-subtotal), o grupta g√∂r√ºn√ºr data satƒ±rƒ± kalƒ±p kalmadƒ±ƒüƒ±nƒ± kontrol edelim.
  // Grup ba≈ülƒ±k satƒ±rlarƒ± "group-header", alt toplam satƒ±rlarƒ± "group-subtotal".
  const groupHeaders = document.querySelectorAll("#urundetaymodel tbody tr.group-header");
  groupHeaders.forEach(headerRow => {
    let visibleDataFound = false;
    let next = headerRow.nextElementSibling;
    let groupSubtotalRow = null;
    // Grup satƒ±rlarƒ±, bir sonraki "group-header" gelene kadar devam eder.
    while (next && !next.classList.contains("group-header")) {
      if (next.classList.contains("group-subtotal")) {
        groupSubtotalRow = next;
        break;
      }
      if (next.classList.contains("data-row") && next.style.display !== "none") {
        visibleDataFound = true;
        break;
      }
      next = next.nextElementSibling;
    }
    // Eƒüer o grupta hi√ßbir veri satƒ±rƒ± g√∂r√ºnm√ºyorsa, grup ba≈ülƒ±ƒüƒ± ve alt toplam gizlensin.
    headerRow.style.display = visibleDataFound ? "" : "none";
    if (groupSubtotalRow) {
      groupSubtotalRow.style.display = visibleDataFound ? "" : "none";
    }
  });
}


//√ñzet model tablosunu excele Aktar
function exportModelSummaryReportToExcel() {
  const table = document.getElementById("urunozetmodel");
  if (!table) {
    alert("Tablo bulunamadƒ±!");
    return;
  }

  const wb = XLSX.utils.book_new();
  const ws_data = [];

  // Ba≈ülƒ±k satƒ±rƒ±
  ws_data.push([
    "S", "BASAMAK4", "MODEL", "Toplam √úr√ºn", "Konsept √úr√ºn", "Konsept Dƒ±≈üƒ±", "Oran (%)"
  ]);

  let rowIndex = 1;
  let grandHom = 0;
  let grandKonsept = 0;

  const visibleRows = Array.from(table.querySelectorAll("tbody > tr")).filter(tr => {
    return tr.offsetParent !== null && !tr.classList.contains("hide-100");
  });

  for (const tr of visibleRows) {
    const tds = tr.querySelectorAll("td");
    if (tds.length === 7) {
      const b4 = tds[1].innerText.trim();
      const model = tds[2].innerText.trim();
      const hom = parseInt(tds[3].innerText.replace(/\./g, '')) || 0;
      const konsept = parseInt(tds[4].innerText.replace(/\./g, '')) || 0;
      const oran = tds[6].innerText.trim();

      ws_data.push([rowIndex++, b4, model, hom, konsept, hom - konsept, oran]);
      grandHom += hom;
      grandKonsept += konsept;
    }
  }

  // Genel Toplam
  const grandRatio = grandHom > 0 ? ((grandKonsept / grandHom) * 100).toFixed(2) + "%" : "0%";
  ws_data.push(["", "", "Genel Toplam", grandHom, grandKonsept, grandHom - grandKonsept, grandRatio]);

  const ws = XLSX.utils.aoa_to_sheet(ws_data);
  XLSX.utils.book_append_sheet(wb, ws, "Model Raporu");
  XLSX.writeFile(wb, "model-ozet-raporu.xlsx");
}
//Kategori Kampanyalarƒ±
// Global mapping nesnesi
let categoryCampaignMap = {};
let productCampaignMap  = {};


// Bu fonksiyon, /api/category-campaigns endpoint‚Äôinden kategori kampanya kayƒ±tlarƒ±nƒ± √ßekip,
// ge√ßerli tarih aralƒ±ƒüƒ±nda olan ve aynƒ± kategori i√ßin en y√ºksek indirim oranƒ±na sahip kampanyayƒ± mapping‚Äôe atar.
async function loadCategoryCampaignMapping() {
  try {
    const response = await fetch('/api/category-campaigns');
    const result = await response.json();
    if (result.success && result.data) {
      result.data.forEach(item => {
        const cat = item.categoryName; // √ñrneƒüin "AYDINLATMA"
        const currentDate = new Date();
        const campStart = new Date(item.StartDate);
        const campEnd = new Date(item.EndDate);
        // Sadece ge√ßerli tarih aralƒ±ƒüƒ±ndaki kayƒ±tlarƒ± i≈üleyelim.
        if (currentDate >= campStart && currentDate <= campEnd) {
          // Eƒüer kategori i√ßin zaten bir kayƒ±t varsa, DiscountValue'ya g√∂re kar≈üƒ±la≈ütƒ±rƒ±yoruz.
          if (categoryCampaignMap[cat]) {
            // Eski kaydƒ±n tam bilgilerini de saklƒ±yoruz.
            let existing = categoryCampaignMap[cat + "_full"];
            if (!existing || (Number(item.DiscountValue) > Number(existing.DiscountValue))) {
              categoryCampaignMap[cat] = item.CampaignName;
              categoryCampaignMap[cat + "_full"] = item;
            }
          } else {
            categoryCampaignMap[cat] = item.CampaignName;
            categoryCampaignMap[cat + "_full"] = item;
          }
        }
      });
    }
    console.log("Kategori kampanya mapping:", categoryCampaignMap);
  } catch (error) {
    console.error("Mapping y√ºklenirken hata:", error);
  }
}

// --- √úr√ºn bazlƒ± kampanya mapping ---
async function loadProductCampaignMapping() {
  productCampaignMap = {};
  try {
    const resp = await fetch('/api/product-campaigns');
    const json = await resp.json();
    if (json.success && Array.isArray(json.data)) {
      json.data.forEach(item => {
        const kod = item.KOD?.trim();
        if (kod) productCampaignMap[kod] = Number(item.DiscountValue);
      });
    }
  } catch (e) {
    console.error("√úr√ºn kampanya mapping y√ºklenirken hata:", e);
  }
}

function getCategoryCampaignLabel(categoryName) {
  const label = categoryCampaignMap?.[categoryName];
  return label ? `<span class="badge badge-warning ml-2">${label}</span>` : "";
}

function getProductCampaignLabel(kod) {
  const discount = productCampaignMap?.[kod];
  return discount ? `<div class="etiket-img">%${discount}</div>` : "";
}



// √úr√ºn Detay Rapor
const loadDetayModelReport = async (language = "tr") => {
  try {
    // Container ayarlarƒ±
    const productContainer = document.getElementById("product-container");
    if (productContainer) productContainer.style.display = "none";
    
    const initialImageContainer = document.getElementById("initialImageContainer");
    if (initialImageContainer) initialImageContainer.style.display = "none";
    
    const stokKartiContainer = document.getElementById("stokKartiContainer");
    if (stokKartiContainer) stokKartiContainer.style.display = "none";
    
    const conceptContainer = document.getElementById("concept-products-container");
    if (conceptContainer) {
      conceptContainer.style.display = "flex";
      conceptContainer.innerHTML = "";
    }
  
    // Sayƒ± formatlama fonksiyonu (ondalƒ±k kƒ±smƒ± sƒ±fƒ±r)
    const formatNumber = (value) => {
      const parts = Number(value).toFixed(0).split(".");
      parts[0] = parts[0].replace(/\B(?=(\d{3})+(?!\d))/g, ".");
      return parts.join(",");
    };

    // √ñnce kategori kampanya mapping‚Äôini y√ºkleyelim
    await loadCategoryCampaignMapping();
	await loadProductCampaignMapping();
    console.log("Kategori Mapping", categoryCampaignMap);

    // Model detay rapor verisini √ßekiyoruz
    const response = await fetch("/api/detay-model-report");
    if (!response.ok) throw new Error("Model bazlƒ± √∂zet raporu alƒ±namadƒ±.");
    const result = await response.json();
    if (!result.success) throw new Error(result.message);
    const data = result.data;

    // Veriyi BASAMAK2 ve BASAMAK4'ye g√∂re grupluyoruz
    const grouped = {};
    const seenB2 = new Set();
    const orderedB2 = [];
    data.forEach(item => {
      const b2 = item.BASAMAK2 || "DIGER";
      const b4 = item.BASAMAK4 || "DIGER";
      if (!grouped[b2]) {
        grouped[b2] = {};
        if (!seenB2.has(b2)) {
          orderedB2.push(b2);
          seenB2.add(b2);
        }
      }
      if (!grouped[b2][b4]) grouped[b2][b4] = [];
      grouped[b2][b4].push(item);
    });

    let finalHTML = `
      <style>
        @media print {
          @page { size: A4 portrait; margin: 5mm; }
          body { -webkit-print-color-adjust: exact; }
          #printButton, #exportButton, #toggle100Button, #toggleZeroButton, #basamak2Filter, #basamak4Filter { display: none; }
        }
        table { width: 95%; border-collapse: collapse; }
        th, td { padding: 5px; border: 1px solid #ccc; }
        .text-right { text-align: right; }
        .highlight-100 { color: red; font-weight: bold; }
        .hide-100 { display: none !important; }
        .kod-popup {
          display: none;
          position: absolute;
          background-color: #fff;
          border: 1px solid #ccc;
          padding: 8px;
          box-shadow: 2px 2px 6px rgba(0,0,0,0.2);
          z-index: 1000;
          font-size: 12px;
          max-width: 250px;
        }
		.badge-info{background:#ff0000;color:#fff;padding:2px 4px;border-radius:3px;font-size:10px;align:right;}
      </style>
      <div style="max-width: 95%; margin: 20px auto; font-size: 12px;">
        <div style="display: flex; flex-direction: column; align-items: center; margin-bottom:15px;">
          <h4 style="text-align: center; margin-bottom: 15px;">
            ${language === "tr" ? "Model Bazlƒ± √úr√ºn Detay Raporu" : "Model Summary Report"}
          </h4>
          <!-- Filtre Dropdownlarƒ± -->
          <div id="filterContainer" style="margin-bottom: 15px; text-align:center;">
            <select id="basamak2Filter" class="selectpicker" data-live-search="true" title="BASAMAK2 Se√ßiniz">
              <option value="">Se√ßiniz</option>
            </select>
            <select id="basamak4Filter" class="selectpicker" data-live-search="true" title="BASAMAK4 Se√ßiniz" style="margin-left: 10px;">
              <option value="">Se√ßiniz</option>
            </select>
          </div>
        </div>
        <div style="margin-bottom: 15px;">
          <button id="printButton" onclick="printConceptContainer()" class="btn btn-primary">
            <span style="margin-right: 5px;">üñ®</span>Yazdƒ±r
          </button>
          <button id="exportButton" onclick="exportModelDetailReportToExcel()" class="btn btn-success">
            <span style="margin-right: 5px;">üìä</span>Excel'e Aktar
          </button>
          <button id="toggle100Button" onclick="toggleHundredRows()" class="btn btn-secondary" style="margin-left: 5px;">
            üîÅ %100 Olanlarƒ± Gizle
          </button>
          <button id="toggleZeroButton" onclick="toggleZeroPriceRows()" class="btn btn-secondary" style="margin-left: 5px;">
            üîÅ Sƒ±fƒ±r Fiyatlƒ±larƒ± G√∂ster
          </button>
        </div>
        <table id="urundetaymodel" class="table table-bordered table-striped">
          <thead>
            <tr>
              <th>S</th>
              <th>BASAMAK4</th>
              <th>MODEL</th>
              <th>KOD</th>
              <th>FIYAT TL</th>
              <th>FIYAT USD</th>
              <th>Stok</th>
              <th>Konsept</th>
              <th>Konsept Dƒ±≈üƒ±</th>
              <th>Oran (%)</th>
              <th>Sepet</th>
            </tr>
          </thead>`;
      
    let grandHom = 0;
    let grandKonsept = 0;
    let rowCounter = 1;
    
    orderedB2.forEach(b2 => {
      finalHTML += `<tbody class="basamak2-group" data-value="${b2}">
          <tr class="group-header group-header-b2" data-value="${b2}" style="background-color:#e6e6e6; font-weight:bold; text-align:left;">
              <td colspan="11">${b2}</td>
          </tr>`;
      const b2Groups = grouped[b2];
      const b2GroupKeys = Object.keys(b2Groups).sort((a, b) => a.localeCompare(b, 'tr', { sensitivity: 'base' }));
      let b2TotalHom = 0;
      let b2TotalKonsept = 0;
      b2Groups && b2GroupKeys.forEach(b4 => {
        let b4TotalHom = 0;
        let b4TotalKonsept = 0;
        let rowSection = "";
        b2Groups[b4].forEach(item => {
          const ratioDisplay = item.Ratio ? item.Ratio.toString().replace('.', ',') : "0%";
          const is100 = (ratioDisplay === "100%" || ratioDisplay === "100,00%");
          const priceStyle = Number(item.PRKTL) === 0 ? 'color:red; font-weight:bold;' : '';
          const usdStyle = Number(item.PRKUSD) === 0 ? 'color:red; font-weight:bold;' : '';
		  // √úr√ºn kampanya badge
          const prodBadge = productCampaignMap[item.KOD]
            ? ` <span class="badge badge-info float-right">%
			${productCampaignMap[item.KOD]}</span>`
            : "";
          rowSection += `
            <tr class="data-row ${is100 ? 'ratio-100-row' : ''}" data-value="${b4}">
              <td>${rowCounter++}</td>
              <td>${item.BASAMAK4}</td>
              <td>${item.MODEL || ""}</td>
              <td class="kod-cell" data-kod="${item.KOD}">${item.KOD}${prodBadge}</td>
              <td class="text-right price-cell" data-price="${item.PRKTL}" style="${priceStyle}">${formatNumber(item.PRKTL)}</td>
              <td class="text-right" style="${usdStyle}">${formatNumber(item.PRKUSD)}</td>
              <td class="text-right">${item.HomKodSayisi}</td>
              <td class="text-right">${item.KonseptProductCount}</td>
              <td class="text-right">${item.HomKodSayisi - item.KonseptProductCount}</td>
              <td class="text-right ${is100 ? '' : 'highlight-100'}">${ratioDisplay}</td>
              <td class="text-center">
                  <button class="btn btn-sm btn-secondary" style="width:15px; height:15px;" onclick="addToCart('${item.KOD}')">
                    <i class="fas fa-shopping-basket"></i>
                  </button>
              </td>
            </tr>`;
          b4TotalHom += Number(item.HomKodSayisi) || 0;
          b4TotalKonsept += Number(item.KonseptProductCount) || 0;
        });
        const b4Ratio = b4TotalHom > 0 ? new Intl.NumberFormat('tr-TR', { minimumFractionDigits: 2, maximumFractionDigits: 2 }).format((b4TotalKonsept / b4TotalHom) * 100) + "%" : "0%";
        b2TotalHom += b4TotalHom;
        b2TotalKonsept += b4TotalKonsept;
        
        // Grup ba≈ülƒ±ƒüƒ± i√ßin kategori kampanya etiketi: BASAMAK4 deƒüeri b4,
        // eƒüer mapping'te varsa (√∂zellikle aktif kampanyalardan √∂nce backend mapping'inde en iyi kampanya se√ßildiyse)
        let campaignTag = "";
        if (categoryCampaignMap && categoryCampaignMap[b4]) {
          campaignTag = `<span class="badge badge-warning" style="margin-left: 5px;">${categoryCampaignMap[b4]}</span>`;
        }
        
        finalHTML += `
          <tr class="group-header group-header-b4" data-value="${b4}" style="background-color:#f9f9f9; font-weight:bold;">
              <td colspan="11">üìÇ ${b4} ${campaignTag}</td>
          </tr>
          ${rowSection}
          <tr class="group-subtotal group-subtotal-b4" data-value="${b4}" style="background-color:#f0f0f0; font-weight:bold;">
              <td colspan="6" class="text-right">Alt Toplam (${b4}):</td>
              <td class="text-right">${b4TotalHom}</td>
              <td class="text-right">${b4TotalKonsept}</td>
              <td class="text-right">${b4TotalHom - b4TotalKonsept}</td>
              <td class="text-right">${b4Ratio}</td>
          </tr>
        `;
      });
      const b2Ratio = b2TotalHom > 0 ? new Intl.NumberFormat('tr-TR', { minimumFractionDigits: 2, maximumFractionDigits: 2 }).format((b2TotalKonsept / b2TotalHom) * 100) + "%" : "0%";
      finalHTML += `
          <tr class="group-subtotal group-subtotal-b2" data-value="${b2}" style="background-color:#d9edf7; font-weight:bold;">
              <td colspan="6" class="text-right">Alt Toplam (${b2}):</td>
              <td class="text-right">${b2TotalHom}</td>
              <td class="text-right">${b2TotalKonsept}</td>
              <td class="text-right">${b2TotalHom - b2TotalKonsept}</td>
              <td class="text-right">${b2Ratio}</td>
          </tr>
      </tbody>`;
      grandHom += b2TotalHom;
      grandKonsept += b2TotalKonsept;
    });
    
    const grandRatio = grandHom > 0 ? new Intl.NumberFormat('tr-TR', { minimumFractionDigits: 2, maximumFractionDigits: 2 }).format((grandKonsept / grandHom) * 100) + "%" : "0%";
    
    finalHTML += `
      <tbody>
        <tr style="font-weight:bold; background-color:#dcdcdc;">
            <td colspan="6" class="text-right">Genel Toplam:</td>
            <td class="text-right">${grandHom}</td>
            <td class="text-right">${grandKonsept}</td>
            <td class="text-right">${grandHom - grandKonsept}</td>
            <td class="text-right">${grandRatio}</td>
        </tr>
      </tbody>
      </table>
      </div>
      <!-- Popup container -->
      <div id="kodPopup" class="kod-popup"></div>
    `;
    
    if (conceptContainer) {
      conceptContainer.innerHTML = finalHTML;
    }
    
    createStickyHeaderBarY();
    
    // KOD h√ºcresine tƒ±klayƒ±nca popup a√ßƒ±lmasƒ±
    $(document).on("click", "#urundetaymodel .kod-cell", function(e) {
      try {
        const $target = $(this);
        const rect = this.getBoundingClientRect();
        const x = rect.right + window.scrollX + 10;
        const y = rect.top + window.scrollY;
        const kod = $target.data("kod");
        if (kod) {
          showKodPopup(kod, x, y);
        } else {
          console.warn("data-kod attribute bo≈ü veya tanƒ±msƒ±z.");
        }
      } catch (err) {
        console.error("kod-cell tƒ±klama eventinde hata:", err);
      }
    });
    
    $(document).on("click", function(e) {
      if (!$(e.target).closest(".kod-cell, #kodPopup").length) {
        hideKodPopup();
      }
    });
    
    // BASAMAK2 ve BASAMAK4 filtre dropdownlarƒ±
    const $basamak2Filter = $("#basamak2Filter");
    $basamak2Filter.empty().append(`<option value="">Se√ßiniz</option>`);
    orderedB2.forEach(b2 => {
      $basamak2Filter.append(`<option value="${b2}">${b2}</option>`);
    });
    $basamak2Filter.selectpicker();
    
    const $basamak4Filter = $("#basamak4Filter");
    $basamak4Filter.empty().append(`<option value="">Se√ßiniz</option>`);
    $basamak4Filter.selectpicker();
    
    $basamak2Filter.on("changed.bs.select", function(e, clickedIndex, isSelected, previousValue) {
      const selectedB2 = $(this).val();
      if (!selectedB2) {
        $("tbody.basamak2-group").show();
      } else {
        $("tbody.basamak2-group").each(function() {
          const b2Value = $(this).data("value");
          $(this).toggle(b2Value === selectedB2);
        });
      }
      
      const basamak4Set = new Set();
      $("tbody.basamak2-group:visible").find("tr.group-header.group-header-b4").each(function() {
        basamak4Set.add($(this).data("value"));
      });
      $basamak4Filter.empty().append(`<option value="">Se√ßiniz</option>`);
      Array.from(basamak4Set).forEach(b4 => {
        $basamak4Filter.append(`<option value="${b4}">${b4}</option>`);
      });
      $basamak4Filter.selectpicker("refresh");
      $basamak4Filter.selectpicker("val", "");
    });
    
    $basamak4Filter.on("changed.bs.select", function(e, clickedIndex, isSelected, previousValue) {
      const selectedB4 = $(this).val();
      if (!selectedB4) {
        $("tbody.basamak2-group:visible").find("tr.group-header.group-header-b4").show();
        $("tbody.basamak2-group:visible").find("tr.group-subtotal.group-subtotal-b4").show();
        $("tbody.basamak2-group:visible").find("tr.data-row").show();
      } else {
        $("tbody.basamak2-group:visible").find("tr.group-header.group-header-b4").each(function() {
          const b4Value = $(this).data("value");
          $(this).toggle(b4Value === selectedB4);
        });
        $("tbody.basamak2-group:visible").find("tr.group-subtotal.group-subtotal-b4").each(function() {
          const b4Value = $(this).data("value");
          $(this).toggle(b4Value === selectedB4);
        });
        $("tbody.basamak2-group:visible").find("tr.data-row").each(function() {
          const b4Value = $(this).data("value");
          $(this).toggle(b4Value === selectedB4);
        });
      }
    });
    
    window.showZeroOnly = false;
    window.toggleZeroPriceRows = function() {
      showZeroOnly = !showZeroOnly;
      const btn = document.getElementById("toggleZeroButton");
      if (btn) {
        btn.textContent = showZeroOnly ? "üîÅ T√ºm√ºn√º G√∂ster" : "üîÅ Sƒ±fƒ±r Fiyatlƒ±larƒ± G√∂ster";
      }
      
      const dataRows = document.querySelectorAll("#urundetaymodel tbody tr.data-row");
      dataRows.forEach(row => {
        const priceCell = row.querySelector(".price-cell");
        if (priceCell) {
          const price = parseFloat(priceCell.getAttribute("data-price"));
          row.style.display = showZeroOnly ? (price === 0 ? "" : "none") : "";
        }
      });
      
      $("tbody.basamak2-group").each(function() {
        let groupVisible = false;
        $(this).find("tr.data-row").each(function() {
          if ($(this).css("display") !== "none") {
            groupVisible = true;
            return false;
          }
        });
        $(this).find("tr.group-header, tr.group-subtotal").toggle(groupVisible);
      });
    };
    
  } catch (error) {
    console.error("Model detay raporu y√ºklenirken hata:", error);
    alert("Model detay raporu y√ºklenirken bir hata olu≈ütu: " + error.message);
  }
};



//Detay model tablosunu excele Aktar
function exportModelDetailReportToExcel() {
  const table = document.getElementById("urundetaymodel");
  if (!table) {
    alert("Tablo bulunamadƒ±!");
    return;
  }

  const wb = XLSX.utils.book_new();
  const ws_data = [];

  // Ba≈ülƒ±k satƒ±rƒ±
  ws_data.push([
    "S", "BASAMAK4", "MODEL", "KOD", "FIYAT TL", "FIYAT USD", "HOM STOK", "Konsept √úr√ºn", "Konsept Dƒ±≈üƒ±", "Oran (%)"
  ]);

  let rowIndex = 1;
  let grandHom = 0;
  let grandKonsept = 0;

  const visibleRows = Array.from(table.querySelectorAll("tbody > tr")).filter(tr => {
    return tr.offsetParent !== null && !tr.classList.contains("hide-100");
  });

  for (const tr of visibleRows) {
    const tds = tr.querySelectorAll("td");
    if (tds.length === 10) {
      const b4 = tds[1].innerText.trim();
      const model = tds[2].innerText.trim();
	  const kod = tds[3].innerText.trim();
      const fiyattl = parseInt(tds[4].innerText.replace(/\./g, '')) || 0;
	  const fiyatusd = parseInt(tds[5].innerText.replace(/\./g, '')) || 0;
	  const hom = parseInt(tds[6].innerText.replace(/\./g, '')) || 0;
      const konsept = parseInt(tds[7].innerText.replace(/\./g, '')) || 0;
	  const konseptdisi = parseInt(tds[8].innerText.replace(/\./g, '')) || 0;
      const oran = tds[9].innerText.trim();

      ws_data.push([rowIndex++, b4, model, kod, hom, konsept, hom - konsept, oran]);
      grandHom += hom;
      grandKonsept += konsept;
    }
  }

  // Genel Toplam
  const grandRatio = grandHom > 0 ? ((grandKonsept / grandHom) * 100).toFixed(2) + "%" : "0%";
  ws_data.push(["", "", "Genel Toplam", "","","", grandHom, grandKonsept, grandHom - grandKonsept, grandRatio]);

  const ws = XLSX.utils.aoa_to_sheet(ws_data);
  XLSX.utils.book_append_sheet(wb, ws, "Model Detay Raporu");
  XLSX.writeFile(wb, "model-detay-raporu.xlsx");
}



// Konsept Se√ßildiƒüinde product-container Gizle & √úr√ºnleri Y√ºkle
const loadProductsByConcept = async (conceptId) => {
    if (!conceptId) {
        console.warn("Konsept ID tanƒ±mlƒ± deƒüil!");
        return;
    }
    
    // Ana √ºr√ºn konteynerini gizle, konsept √ºr√ºn konteynerini g√∂ster
    document.getElementById("product-container").style.display = "none";
    if (initialImageContainer) {
        initialImageContainer.style.display = 'none';
    }
    document.getElementById("concept-products-container").style.display = "flex";

    const container = document.getElementById("concept-products-container");
    container.innerHTML = ''; // √ñnce temizle

    // Konsept bilgilerini getir
    const conceptResponse = await fetch(`http://192.168.30.4:3000/concept-info?conceptId=${conceptId}`);
    const conceptData = await conceptResponse.json();
    if (!conceptResponse.ok || !conceptData) {
        console.error("Konsept bilgileri y√ºklenemedi:", conceptResponse.status, conceptResponse.statusText);
        return;
    }

    const conceptBanner = conceptData.CONCEPT_BANNER || '/resim/banner/default-banner.jpg'; 
    const conceptTitle = conceptData.CUSTOMER_NAME || 'Konsept Adƒ± Bulunamadƒ±';

    // Konsept Banner Alanƒ±nƒ± Ekle
    const bannerDiv = document.createElement("div");
    bannerDiv.className = "concept-banner";
    bannerDiv.innerHTML = `
        <img src="${conceptBanner}" alt="Konsept Banner" class="concept-banner-image">
        <h2 class="concept-title">${conceptTitle}</h2>
    `;
    container.prepend(bannerDiv);

    // Konsept √úr√ºnlerini Getir
    try {
        const response = await fetch(`http://192.168.30.4:3000/concept-products?conceptId=${conceptId}`);
        const products = await response.json();
        if (!response.ok) {
            console.error("Konsept API Hatasƒ±:", response.status, response.statusText);
            return;
        }
        if (products.length === 0) {
            alert('Bu konsepte ait √ºr√ºn bulunamadƒ±.');
            return;
        }

        let currentGroup = '';  // Mevcut grup ba≈ülƒ±ƒüƒ±nƒ± saklamak i√ßin
        let productCountInGroup = 0; // Gruplama i√ßin saya√ß
        let productCount = 0;
        const columns = 4; // Satƒ±r ba≈üƒ±na √ºr√ºn sayƒ±sƒ±

        // √úr√ºnleri gruplandƒ±rarak sƒ±rala (√∂rnek sƒ±ralama, ihtiyaca g√∂re d√ºzenleyebilirsiniz)
        products.sort((a, b) => {
            const order = { "ANA KONSEPT √úR√úNLERƒ∞": 1, "TAMAMLAYICI √úR√úNLER": 2, "EK AKSESUARLAR": 3, "EK √úR√úNLER": 4, "Dƒ∞ƒûER": 5};
            let groupA = a.MAINCONCEPT ? "ANA KONSEPT √úR√úNLERƒ∞" : a.ADDITIONAL ? "TAMAMLAYICI √úR√úNLER" :a.ADDITIONALAKS ? "TAMAMLAYICI AKSESUARLAR" : a.ACCESSORIES ? "EK AKSESUARLAR" : a.SUPPLEMENTARY ? "EK √úR√úNLER" :  "Dƒ∞ƒûER";
            let groupB = b.MAINCONCEPT ? "ANA KONSEPT √úR√úNLERƒ∞" : b.ADDITIONAL ? "TAMAMLAYICI √úR√úNLER" : b.ADDITIONALAKS ? "TAMAMLAYICI AKSESUARLAR" : b.ACCESSORIES ? "EK AKSESUARLAR" : b.SUPPLEMENTARY ? "EK √úR√úNLER" : "Dƒ∞ƒûER";
            return order[groupA] - order[groupB];
        });

        for (const product of products) {
            if (initialImageContainer) {
                initialImageContainer.style.display = 'none';
            }
            
            // √úr√ºn grubunu belirle
            let group = "Dƒ∞ƒûER";
            if (product.MAINCONCEPT == 1) {
                group = "ANA KONSEPT √úR√úNLERƒ∞";
            } else if (product.ADDITIONAL == 1) {
                group = "TAMAMLAYICI √úR√úNLER";
            } else if (product.ADDITIONALAKS == 1) {
                group = "TAMAMLAYICI AKSESUARLAR";
            } else if (product.ACCESSORIES == 1) {
                group = "EK AKSESUARLAR";
            } else if (product.SUPPLEMENTARY == 1) {
                group = "EK √úR√úNLER";
            }
            
            // Grup ba≈ülƒ±ƒüƒ± gerekiyorsa ekle
            if (group !== currentGroup) {
                if (currentGroup !== '') {
                    const totalProductsInRow = columns;
                    if (productCountInGroup % totalProductsInRow !== 0) {
                        const placeholdersNeeded = totalProductsInRow - (productCountInGroup % totalProductsInRow);
                        for (let i = 0; i < placeholdersNeeded; i++) {
                            let placeholderDiv = document.createElement('div');
                            placeholderDiv.className = 'product-placeholder';
                            container.appendChild(placeholderDiv);
                        }
                    }
                }
                currentGroup = group;
                productCountInGroup = 0;
                
                // Grup Ba≈ülƒ±ƒüƒ± Ekle
                let groupDiv = document.createElement('div');
                groupDiv.className = 'group-title d-flex justify-content-between align-items-center';
                groupDiv.style.color = "#727476";
                let titleSpan = document.createElement("span");
                titleSpan.innerText = group;
                groupDiv.appendChild(titleSpan);
                let addAllButton = document.createElement("button");
                addAllButton.className = "btn btn-sm";
                addAllButton.style.backgroundColor = "#727476";
                addAllButton.style.color = "white";
                addAllButton.style.border = "none";
                addAllButton.style.padding = "8px 12px";
                addAllButton.style.borderRadius = "5px";
                addAllButton.innerText = "T√ºm√ºn√º Sepete Ekle";
                addAllButton.onclick = () => addGroupToCart(group, products);
                groupDiv.appendChild(addAllButton);
                container.appendChild(groupDiv);
            }
            
            productCountInGroup++;
            let productDiv = document.createElement('div');
            productDiv.className = 'product';
            productDiv.style.flex = `1 1 calc(100% / ${columns} - 20px)`;

            // √úr√ºn bilgilerini attribute olarak ekle
            productDiv.setAttribute("data-kurumsal", product.KURUMSALLIST ? "1" : "0");
            productDiv.setAttribute("data-indirim", product.INDIRIMLIST ? "1" : "0");
            productDiv.setAttribute("data-stock", product.STOK);
            productDiv.setAttribute("data-hm-stock", product.HOM);
            productDiv.setAttribute("data-koleksiyon25", product.KOLEKSIYON25 ? "1" : "0");
            productDiv.setAttribute("data-price", product.SFIYAT1);
            productDiv.setAttribute("data-fkontrol", product.FKONTROL ? "1" : "0");
            productDiv.setAttribute("data-fuar25", product.FUAR25 ? "1" : "0");

            // Yeni: Resimleri endpoint'ten √ßekiyoruz (UNC yol d√∂n√º≈ü√ºm√º ve sƒ±ralama, base image ilk sƒ±rada olacak)
            const imageUrls = await fetchProductImages(product.KOD);
            
            // Indicators (Noktalar)
            const indicators = imageUrls.map((_, index) => `
                <li data-target="#carousel-${product.KOD}" data-slide-to="${index}" ${index === 0 ? 'class="active"' : ''}></li>
            `).join('');
            
            // Carousel Items (Resimler)
            const carouselItems = imageUrls.map((url, index) => `
                <div class="carousel-item ${index === 0 ? 'active' : ''}">
                    <img src="${url}" alt="${product.ADI}" class="d-block w-100" 
                        data-urls='${JSON.stringify(imageUrls)}' onclick="openImageModal('${product.KOD}')">
                </div>
            `).join('');
            
            // √úr√ºn ƒ∞√ßeriƒüini Olu≈ütur
            productDiv.innerHTML = `
                <div id="carousel${product.KOD}" class="carousel slide" data-ride="carousel">
                    <ol class="carousel-indicators">${indicators}</ol>
                    <div class="carousel-inner">${carouselItems}</div>
                    <a class="carousel-control-prev" href="#carousel${product.KOD}" role="button" data-slide="prev">
                        <span class="carousel-control-prev-icon" aria-hidden="true"></span>
                        <span class="sr-only">Previous</span>
                    </a>
                    <a class="carousel-control-next" href="#carousel${product.KOD}" role="button" data-slide="next">
                        <span class="carousel-control-next-icon" aria-hidden="true"></span>
                        <span class="sr-only">Next</span>
                    </a>
                </div>
                <table style="width: 100%; text-align: left;">
                    <tbody>
                        <tr>
                            <td><strong>KATEGORƒ∞:</strong></td>
                            <td><strong>${product.BASAMAK2}</strong></td>
                        </tr>
                        <tr>
                            <td><strong>ALT KATEGORI:</strong></td>
                            <td><strong>${product.BASAMAK4}</strong></td>
                        </tr>
                        <tr>
                            <td><strong>KOD:</strong></td>
                            <td><strong>${product.KOD}</strong></td>
                        </tr>
                        <tr>
                            <td><strong>MODEL:</strong></td>
                            <td><strong>${product.MODEL}</strong></td>
                        </tr>
                        <tr>
                            <td>EBAT:</td>
                            <td>${product.EBAT}</td>
                        </tr>
                        <tr>
                            <td>RENK:</td>
                            <td>${product.RENK}</td>
                        </tr>
                        <tr>
                            <td>DESEN & LAMINE:</td>
                            <td>${product.DESEN ? product.DESEN : '-'} / ${product.LAMINE ? product.LAMINE : '-'}</td>
                        </tr>
                        <tr>
                            <td>MATERYAL:</td>
                            <td>${product.MATERYAL}</td>
                        </tr>
                        <tr>
                            <td>AYAK:</td>
                            <td>${product.LEG ? product.LEG : '-'}</td>
                        </tr>
                        <tr>
                            <td>PRK TL & USD:</td>
                            <td>${formatCurrency(product.SFIYAT1, 1)} / ${formatCurrency(product.SFIYAT4, 4)}</td>
                        </tr>
                        <tr>
                            <td>STOK / HM:</td>
                            <td>${product.STOK} / ${product.HOM}</td>
                        </tr>
						<tr>
                            <td>MIKTAR:</td>
                            <td>${product.MIKTAR}</td>
                        </tr>
                        <tr>
                            <td colspan="2">
                                <div class="koleksiyon-checkboxes">
                                    <label style="margin: 0; padding: 0;">25: <input type="checkbox" ${product.KOLEKSIYON25 ? 'checked' : ''} onchange="updateKoleksiyon('${product.KOD}', 'KOLEKSIYON25', this.checked)"></label>
                                    <label style="margin: 0; padding: 0;">24: <input type="checkbox" ${product.KOLEKSIYON24 ? 'checked' : ''} onchange="updateKoleksiyon('${product.KOD}', 'KOLEKSIYON24', this.checked)"></label>
                                </div>
                            </td>
                        </tr>
                        <tr>
                            <td>Fiyat Kontrol:</td>
                            <td>
                                <input
                                    type="checkbox"
                                    id="fkontrol-${product.KOD}"
                                    ${product.FKONTROL ? 'checked' : ''}
                                    onchange="updateFkontrol('${product.KOD}', this.checked)"
                                >
                                <input
                                    type="text"
                                    id="fkontrolnotes-${product.KOD}"
                                    value="${product.FKONTROLNOTES || ''}"
                                    style="display: ${product.FKONTROL ? 'inline-block' : 'none'};"
                                    onblur="updateFkontrolNotes('${product.KOD}', this.value)"
                                >
                            </td>
                        </tr>
						<tr>
							<td>Fuar 2025:</td>
							<td>${product.FUAR25 ? '‚úÖ Evet' : '‚ùå Hayƒ±r'}</td>
						</tr>
						<tr>
                            <td>Kar≈üƒ±la≈ütƒ±r:</td>
                            <td>	
                                <label class="compare-checkbox">
                                    <input type="checkbox" data-product-code="${product.KOD}" onclick="toggleCompare('${product.KOD}', this)"> 
                                </label>
                            </td>
                        </tr>
                        <tr style="padding: 0;">
                            <td>NOTLAR:</td>
                            <td><textarea onblur="updateNotes('${product.KOD}', this.value)">${product.NOTES || ''}</textarea></td>
                        </tr>
                        <tr>
                            <td colspan="2" style="text-align: center;">
                                <button class="btn btn-sm" style="background-color: #727476; color: white; border: none;" onclick="addToCart('${product.KOD}')">Teklif Sepetine Ekle</button>
                            </td>
                        </tr>
                    </tbody>
                </table>
            `;
            container.appendChild(productDiv);
            productCount++;
            // Satƒ±rƒ±n eksik kalan kƒ±smƒ±nƒ± doldur
            if (productCount % columns !== 0 && productCount === products.length) {
                const placeholdersNeeded = columns - (productCount % columns);
                for (let i = 0; i < placeholdersNeeded; i++) {
                    let placeholderDiv = document.createElement('div');
                    placeholderDiv.className = 'product-placeholder';
                    container.appendChild(placeholderDiv);
                }
            }
        }
    } catch (error) {
        console.error("Konsept √ºr√ºnleri y√ºkleme hatasƒ±:", error);
    }
};

//Kampanya Panelini G√∂steren Fonksiyon
function showCampaignPanel() {

    

    const initialImageContainer = document.getElementById("initialImageContainer");
    if (initialImageContainer) initialImageContainer.style.display = "none";
	
	
	const stokKartiContainer = document.getElementById("stokKartiContainer");
    if (stokKartiContainer) stokKartiContainer.style.display = "none";
	

    const conceptContainer = document.getElementById("concept-products-container");
    if (conceptContainer) 
      conceptContainer.style.display = "none";
	const productContainer = document.getElementById("product-container");
    if (productContainer) productContainer.style.display = "flex";
  // Eƒüer tab tabanlƒ± bir yapƒ± kullanƒ±yorsanƒ±z: T√ºm tab-pane'leri pasif hale getirin.
  $('.tab-pane').removeClass('show active');
  
  // Kampanya panelini aktif yapƒ±n.
  $('#campaignPanel').addClass('show active');
  
  // ƒ∞lgili navigasyon butonlarƒ±na da aktif sƒ±nƒ±fƒ± ekleyin (√∂rneƒüin, ƒ∞≈ülevler men√ºs√ºnde Kampanya √∂ƒüesi)
  // Eƒüer √∂zel bir aktif sƒ±nƒ±fƒ±nƒ±z varsa buraya ekleyebilirsiniz.
  console.log("Kampanya paneli a√ßƒ±ldƒ±!");
  loadCategoryTree();
}

// Kategori verilerini aƒüa√ß ≈üeklinde jstree‚Äôye y√ºkleyecek fonksiyon
function loadCategoryTree() {
  fetch('/api/categories')
    .then(response => response.json())
    .then(data => {
      // jstree'yi initialize ediyoruz
      $('#campaignCategoriesTree').jstree({
        'core': {
          'data': data,
          'themes': { 'responsive': true }
        },
        "checkbox": {
          "keep_selected_style": false
        },
        "plugins": ["checkbox", "wholerow"]
      });
    })
    .catch(error => console.error("Kategori verileri y√ºklenirken hata:", error));
}

// Se√ßili kategorileri g√ºncelleyen jstree event listener'ƒ±
$('#campaignCategoriesTree').on("changed.jstree", function (e, data) {
  const selectedNodes = data.selected;
  document.getElementById('selectedCategories').value = selectedNodes.join(',');
  console.log("Se√ßili kategoriler:", selectedNodes);
});



// Sadece concept-products-container i√ßeriƒüini Excel'e aktaran global fonksiyon
function exportConceptToExcel() {
  const container = document.getElementById("concept-products-container");
  if (!container) return;
  const tableHTML = container.innerHTML;
  const dataType = 'application/vnd.ms-excel';
  const filename = 'KONSEPT_DISI_URUNLER_RAPORU.xls';
  const downloadLink = document.createElement("a");
  document.body.appendChild(downloadLink);
  downloadLink.href = 'data:' + dataType + ', ' + encodeURIComponent(tableHTML);
  downloadLink.download = filename;
  downloadLink.click();
  document.body.removeChild(downloadLink);
}


//√úr√ºnler √ñzet Raporu
const loadOzetReport = async (language = "tr") => {
  try {
    const productContainer = document.getElementById("product-container");
    if (productContainer) productContainer.style.display = "none";

    const initialImageContainer = document.getElementById("initialImageContainer");
    if (initialImageContainer) initialImageContainer.style.display = "none";
	
	
	const stokKartiContainer = document.getElementById("stokKartiContainer");
    if (stokKartiContainer) stokKartiContainer.style.display = "none";
	

    const conceptContainer = document.getElementById("concept-products-container");
    if (conceptContainer) {
      conceptContainer.style.display = "flex";
      conceptContainer.innerHTML = "";
    }

    const formatCurrency = (value, priceType) => {
      let currency;
      switch (parseInt(priceType, 10)) {
        case 1:
        case 2:
          currency = 'TRY';
          break;
        case 3:
        case 4:
          currency = 'USD';
          break;
        case 5:
        case 6:
          currency = 'EUR';
          break;
        default:
          currency = 'TRY';
      }
      return new Intl.NumberFormat('tr-TR', {
        style: 'currency',
        currency: currency,
        minimumFractionDigits: 0,
        maximumFractionDigits: 0
      }).format(value);
    };

    const response = await fetch("http://192.168.30.4:3000/api/ozet-report");
    if (!response.ok) throw new Error("√ñzet raporu alƒ±namadƒ±.");
    const result = await response.json();
    if (!result.success) throw new Error(result.message);
    const data = result.data;

    const groups = {};
    data.forEach(record => {
      const key = record.BASAMAK2 ? record.BASAMAK2.toUpperCase() : "DIGER";
      if (!groups[key]) {
        groups[key] = [];
      }
      groups[key].push(record);
    });

    // G√ºvenli customOrder tanƒ±mƒ±
    const customOrder = window.customOrderBasamak || [];

    let groupKeys = Object.keys(groups).sort((a, b) => {
      const aIndex = customOrder.indexOf(a);
      const bIndex = customOrder.indexOf(b);
      if (aIndex !== -1 && bIndex !== -1) return aIndex - bIndex;
      if (aIndex !== -1) return -1;
      if (bIndex !== -1) return 1;
      return a.localeCompare(b, 'tr', { sensitivity: 'base' });
    });

    let finalHTML = `
      <style>
        @media print {
          @page { size: A4 portrait; margin: 5mm; }
          body { -webkit-print-color-adjust: exact; }
          #printButton, #exportButton { display: none; }
        }
        table { width: 45%; border-collapse: collapse; }
        th, td { padding: 5px; border: 1px solid #ccc; }
        .text-right { text-align: right; }
      </style>
      <div style="max-width: 45%; margin-top: 20px; margin-left: 323px; font-size: 12px;">
        <div style="display: flex; justify-content: space-between; align-items: center;">
          <h4 style="text-align: center; margin-bottom: 15px;">
            ${language === "tr" ? "√úr√ºn √ñzet Raporu" : "Summary Report"}
          </h4>
          <div>
            <button id="printButton" onclick="printConceptContainer()" class="btn btn-primary">
              <span style="margin-right: 5px;">üñ®</span>Yazdƒ±r
            </button>
            <button id="exportButton" onclick="exportSummaryReportToExcel()" class="btn btn-success">
              <span style="margin-right: 5px;">üìä</span>Excel'e Aktar
            </button>
          </div>
        </div>
        <table id="urunozet" class="table table-bordered table-striped">
          <thead>
            <tr>
              <th rowspan="2">S</th>
              <th rowspan="2">BASAMAK4</th>
              <th rowspan="2">Toplam √úr√ºn (Adet)</th>
              <th rowspan="2">Konsept √úr√ºn (Adet)</th>
              <th rowspan="2">Konsept Dƒ±≈üƒ± (Adet)</th>
              <th rowspan="2">Oran (%)</th>
            </tr>
          </thead>
          <tbody>
    `;

    let grandHom = 0;
    let grandKonsept = 0;

    groupKeys.forEach(groupKey => {
      finalHTML += `
        <tr style="background-color:#e6e6e6; font-size: 14px;">
          <td colspan="6" style="font-weight:bold; text-align:left;">${groupKey}</td>
        </tr>
      `;
      let groupHom = 0;
      let groupKonsept = 0;

      groups[groupKey].sort((a, b) => a.BASAMAK4.localeCompare(b.BASAMAK4, 'tr', { sensitivity: 'base' }));
      groups[groupKey].forEach((record, index) => {
        let ratioDisplay = record.Ratio ? record.Ratio.toString().replace('.', ',') : '0%';
        finalHTML += `
          <tr>
            <td style="width:5%;">${index + 1}</td>
            <td style="width:20%;">${record.BASAMAK4 || ""}</td>
            <td class="text-right" style="width:20%;">${record.HomKodSayisi}</td>
            <td class="text-right" style="width:20%;">${record.KonseptProductCount}</td>
            <td class="text-right" style="width:20%;">${record.HomKodSayisi - record.KonseptProductCount}</td>
            <td class="text-right" style="width:15%;">${ratioDisplay}</td>
          </tr>
        `;
        groupHom += Number(record.HomKodSayisi) || 0;
        groupKonsept += Number(record.KonseptProductCount) || 0;
      });

      const groupRatio = groupHom > 0
        ? new Intl.NumberFormat('tr-TR', { minimumFractionDigits: 2, maximumFractionDigits: 2 }).format((groupKonsept / groupHom) * 100) + '%'
        : '0%';

      finalHTML += `
        <tr style="font-weight:bold; background-color:#f0f0f0;">
          <td colspan="2" class="text-right">Alt Toplam:</td>
          <td class="text-right">${groupHom}</td>
          <td class="text-right">${groupKonsept}</td>
          <td class="text-right">${groupHom - groupKonsept}</td>
          <td class="text-right">${groupRatio}</td>
        </tr>
      `;

      grandHom += groupHom;
      grandKonsept += groupKonsept;
    });

    const grandRatio = grandHom > 0
      ? new Intl.NumberFormat('tr-TR', { minimumFractionDigits: 2, maximumFractionDigits: 2 }).format((grandKonsept / grandHom) * 100) + '%'
      : '0%';

    finalHTML += `
      <tr style="font-weight:bold; background-color:#dcdcdc;">
        <td colspan="2" class="text-right">Genel Toplam:</td>
        <td class="text-right">${grandHom}</td>
        <td class="text-right">${grandKonsept}</td>
        <td class="text-right">${grandHom - grandKonsept}</td>
        <td class="text-right">${grandRatio}</td>
      </tr>
      </tbody>
      </table>
      </div>
    `;

    if (conceptContainer) {
      conceptContainer.innerHTML = finalHTML;
    }

    createStickyHeaderBarY();
  } catch (error) {
    console.error("√ñzet raporu y√ºklenirken hata:", error);
    alert("√ñzet raporu y√ºklenirken bir hata olu≈ütu: " + error.message);
  }
};



// Sadece concept-products-container i√ßeriƒüini Excel'e aktaran global fonksiyon
function exportSummaryReportToExcel() {
  const container = document.getElementById("concept-products-container");
  if (!container) return;
  
  // Konsept raporunun HTML tablosunun bir kopyasƒ±nƒ± olu≈üturuyoruz
  const clone = container.cloneNode(true);
  
  // Yazdƒ±r ve Excel'e Aktar butonlarƒ±nƒ± klon i√ßerikten kaldƒ±rƒ±yoruz
  const printBtn = clone.querySelector("#printButton");
  if (printBtn) printBtn.remove();
  const exportBtn = clone.querySelector("#exportButton");
  if (exportBtn) exportBtn.remove();
  
  // Tablonun HTML i√ßeriƒüini string olarak alalƒ±m
  let tableHTML = clone.innerHTML;
  
  // <thead> ... </thead> kƒ±smƒ±nƒ± tamamen kaldƒ±rƒ±yoruz
  tableHTML = tableHTML.replace(/<thead>[\s\S]*?<\/thead>/i, "");
  
  // S√ºtun ba≈ülƒ±klarƒ±nƒ± i√ßeren header row'u manuel olarak olu≈üturup <tbody> nin ba≈üƒ±na ekleyelim.
  const headerRow = `
    <tr>
      <th>S</th>
      <th>BASAMAK4</th>
      <th>Toplam Urun (Adet)</th>
      <th>Konsept Urun (Adet)</th>
      <th>Konsept Disi (Adet)</th>
      <th>Oran (%)</th>
    </tr>
  `;
  // <tbody> a√ßƒ±lƒ±≈ü etiketinin hemen sonuna headerRow'u ekleyelim:
  tableHTML = tableHTML.replace(/<tbody>/i, `<tbody>${headerRow}`);
  
  // Olu≈üan HTML i√ßeriƒüini UTF-8 meta etiketiyle sarmalayalƒ±m
  const htmlContent = `
    <html>
      <head>
        <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
      </head>
      <body>
        ${tableHTML}
      </body>
    </html>
  `;
  
  const dataType = 'application/vnd.ms-excel;charset=UTF-8';
  const filename = '√ñzet √úr√ºnler Raporu.xls';
  const downloadLink = document.createElement("a");
  document.body.appendChild(downloadLink);
  downloadLink.href = 'data:' + dataType + ', ' + encodeURIComponent(htmlContent);
  downloadLink.download = filename;
  downloadLink.click();
  document.body.removeChild(downloadLink);
}

function getSelectedCurrency() {
  return $('#currencySelect').selectpicker('val'); // selectpicker'ƒ±n g√ºncel deƒüerini d√∂nd√ºr√ºr.
}

// Konseptler √ñzet Raporu
const loadConceptSummaryReport = async (language = "tr", currency = "TL") => {
  try {
    // Yerel para birimi bi√ßimlendirme fonksiyonu (se√ßilen d√∂viz cinsine g√∂re)
    const formatCurrencyLocal = (value, curr) => {
      let currencyCode;
      switch (curr) {
        case "TL":
          currencyCode = "TRY";
          break;
        case "USD":
          currencyCode = "USD";
          break;
        case "EUR":
          currencyCode = "EUR";
          break;
        default:
          currencyCode = "TRY";
      }
      return new Intl.NumberFormat("tr-TR", {
        style: "currency",
        currency: currencyCode,
        currencyDisplay: "symbol",
        minimumFractionDigits: 0,
        maximumFractionDigits: 0,
      }).format(value);
    };

    // √úr√ºn ve resim konteynerlerini gizle, konsept konteynerini g√∂ster
    const productContainer = document.getElementById("product-container");
    if (productContainer) productContainer.style.display = "none";
	const stokKartiContainer = document.getElementById("stokKartiContainer");
    if (stokKartiContainer) stokKartiContainer.style.display = "none";
    const initialImageContainer = document.getElementById("initialImageContainer");
    if (initialImageContainer) initialImageContainer.style.display = "none";
    const conceptContainer = document.getElementById("concept-products-container");
    if (conceptContainer) {
      conceptContainer.style.display = "flex";
      // ƒ∞√ßerik temizlensin
      conceptContainer.innerHTML = "";
    }

    // Se√ßilen para cinsine g√∂re API √ßaƒürƒ±sƒ±
    const response = await fetch(`http://192.168.30.4:3000/api/konsept-summary?currency=${currency}`);
    if (!response.ok) throw new Error("√ñzet raporu alƒ±namadƒ±.");
    const result = await response.json();
    if (!result.success) throw new Error(result.message);
    const data = result.data;

    // Eƒüer t√ºm kayƒ±tlar i√ßin Others s√ºtunundaki deƒüerler 0 ise, diƒüer s√ºtunlarƒ± gizleyelim
    window.hideOthersColumns = data.every(record =>
      (record.Others_Miktar || 0) === 0 && (record.Others_Tutar || 0) === 0
    );
    // PDF s√ºtunu eklediƒüimiz i√ßin toplam s√ºtun sayƒ±sƒ±nƒ± belirleyelim:
    // Yeni "Kilitli" s√ºtunu eklediƒüimizden dolayƒ± totalColumns artacak.
    let totalColumns = hideOthersColumns ? 16 : 18;
    console.log("Konsept ID:", data.ID);

    // Genel HTML yapƒ±sƒ±nƒ± olu≈üturuyoruz: ba≈ülƒ±k, yazdƒ±r ve Excel'e Aktar butonlarƒ±,
    // aynƒ± satƒ±rda "D√∂viz Cinsi:" etiketli dropdown da yer alƒ±yor.
    let finalHTML = `
      
	<style>
    @media print {
      @page { size: A4 portrait; margin: 5mm; }
      body { -webkit-print-color-adjust: exact; }
      #printButton, #exportButton, #currencySelect { display: none; }
    }
    table { width: 85%; border-collapse: collapse; }
    th, td { padding: 5px; border: 1px solid #ccc; }
    .text-right { text-align: right; }
    .sticky-header {
      position: sticky;
      top: 0;
      background-color: #fff;
      z-index: 100;
    }
    .sticky-toolbar {
      position: sticky;
      top: 0;
      background-color: #fff;
      z-index: 100;
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 10px 0;
    }
  </style>



      <div style="max-width: 85%px; margin: 5px auto; font-size: 15px;">
        <!-- Ba≈ülƒ±k ve √úst ƒ∞≈ülemler -->
       <div class="sticky-toolbar">
            <h4>
              ${language === "tr" ? "Konseptler Kategori Detaylƒ± √ñzet" : "Concept Summary Details by Categories"}
            </h4>
            <div>
              <button id="printButton" onclick="printConceptContainer()" class="btn btn-primary">
                <span style="margin-right: 5px;">üñ®</span>Yazdƒ±r
              </button>
              <button id="exportButton" onclick="exportConceptOzetToExcel()" class="btn btn-success" style="margin-left: 5px;">
                <span style="margin-right: 5px;">üìä</span>Excel'e Aktar
              </button>
              <label id="currencySelectLabel" for="currencySelect" style="margin-left: 10px; margin-right: 5px;">D√∂viz Cinsi:</label>
              <select id="currencySelect">
                <option value="TL" ${currency === "TL" ? "selected" : ""}>TL</option>
                <option value="USD" ${currency === "USD" ? "selected" : ""}>USD</option>
                <option value="EUR" ${currency === "EUR" ? "selected" : ""}>EUR</option>
              </select>
            </div>
          </div>
       <!-- Tablo Ba≈ülangƒ±cƒ± -->
    <table id="konseptozet" class="table table-bordered table-striped">
      <colgroup>
        <!-- ƒ∞lk 3 s√ºtun: S, Konsept Adƒ±, Kilitli -->
        <col style="width:5%;">        
        <col style="width:20%;">       
        <col style="width:5%;">        
        <!-- Ana Konsept (2 s√ºtun) -->
        <col style="width:10%;">       
        <col style="width:10%;">       
        <!-- Tamamlayƒ±cƒ± √úr√ºnler (2 s√ºtun) -->
        <col style="width:10%;">       
        <col style="width:10%;">       
        <!-- Tamamlayƒ±cƒ± Aksesuarlar (2 s√ºtun) -->
        <col style="width:10%;">       
        <col style="width:10%;">       
        <!-- Genel Toplam (2 s√ºtun) -->
        <col style="width:10%;">       
        <col style="width:10%;">       
        <!-- Ek Aksesuarlar (2 s√ºtun) -->
        <col style="width:10%;">       
        <col style="width:10%;">       
        <!-- Ek √úr√ºnler (2 s√ºtun) -->
        <col style="width:10%;">       
        <col style="width:10%;">       
        ${!hideOthersColumns ? `
          <!-- Diƒüer √úr√ºnler (2 s√ºtun) -->
          <col style="width:10%;">
          <col style="width:10%;">  
        ` : ``}
        <!-- PDF s√ºtunu -->
        <col style="width:5%;">        
      </colgroup>
      <thead>
        <tr>
          <th rowspan="2">S</th>
          <th rowspan="2">Konsept Adƒ±</th>
          <th rowspan="2">Kilitli</th>
          <th colspan="2" class="text-center">Ana Konsept</th>
          <th colspan="2" class="text-center">Tamamlayƒ±cƒ± √úr√ºnler</th>
          <th colspan="2" class="text-center">Tamamlayƒ±cƒ± Aksesuarlar</th>
          <th colspan="2" class="text-center" style="background-color: #bfc9ca;">Genel Toplam</th>
          <th colspan="2" class="text-center">Ek Aksesuarlar</th>
          <th colspan="2" class="text-center">Ek √úr√ºnler</th>
          ${!hideOthersColumns ? `<th colspan="2">Diƒüer √úr√ºnler</th>` : ""}
          <th rowspan="2" class="text-center">PDF</th>
        </tr>
        <tr>
          <th class="text-right">Miktar</th>
          <th class="text-right">Tutar</th>
          <th class="text-right">Miktar</th>
          <th class="text-right">Tutar</th>
          <th class="text-right">Miktar</th>
          <th class="text-right">Tutar</th>
          <th class="text-right">Miktar</th>
          <th class="text-right">Tutar</th>
          <th class="text-right">Miktar</th>
          <th class="text-right">Tutar</th>
          <th class="text-right">Miktar</th>
          <th class="text-right">Tutar</th>
          ${!hideOthersColumns ? `<th class="text-right">Miktar</th><th class="text-right">Tutar</th>` : ""}
        </tr>
      </thead>
      <tbody>
    `;

    // Verileri "Alan" deƒüerine g√∂re gruplandƒ±ralƒ±m
    const groups = {};
    data.forEach(record => {
      let group = (record.Alan || "Diƒüer").trim();
      if (!group) group = "Diƒüer";
      if (!groups[group]) groups[group] = [];
      groups[group].push(record);
    });

    // Grup sƒ±ralamasƒ± i√ßin sabit sƒ±ralama d√ºzeni
    window.customOrder = [
      "OTURMA ODASI - SECTIONAL",
      "OTURMA ODASI",
      "OTURMA ODASI - TV UNITESI",
      "OTURMA ODASI - TEA CORNER",
      "OTURMA ODASI - BAR",
      "YEMEK ODASI - MASA",
      "YEMEK ODASI - B√úFE/KONSOL",
      "YATAK ODASI",
      "YATAK ODASI - MAKYAJ",
      "YATAK ODASI - DOLAP",
	  "YATAK ODASI - CEKMECE",
      "YATAK ODASI - JOSEFIN",
      "ANTRE",
      "GIYINME ODASI",
      "OFIS",
      "TERAS",
      "ARANJMAN - CICEK",
      "Dƒ∞ƒûER"
    ];
    let groupKeys = Object.keys(groups).sort((a, b) => {
      const aUpper = a.toUpperCase();
      const bUpper = b.toUpperCase();
      const aIndex = window.customOrder.indexOf(aUpper);
      const bIndex = window.customOrder.indexOf(bUpper);
      if (aIndex !== -1 && bIndex !== -1) return aIndex - bIndex;
      if (aIndex !== -1) return -1;
      if (bIndex !== -1) return 1;
      return a.localeCompare(b, 'tr', { sensitivity: 'base' });
    });

    let grandTotal = 0;
    // Her grup i√ßin tablo satƒ±rlarƒ±nƒ± olu≈üturalƒ±m
    groupKeys.forEach((group, groupIndex) => {
      if (groupIndex > 0) {
        finalHTML += `<tr style="height:10px;"><td colspan="${totalColumns}"></td></tr>`;
      }
      finalHTML += `
        <tr style="background-color:#e6e6e6; font-size: 16px;">
          <td colspan="${totalColumns}" style="font-weight:bold; text-align:left;">${group}</td>
        </tr>
      `;
      // Grup i√ßindeki kayƒ±tlarƒ± Ana Konsept Tutarƒ±na g√∂re azalan sƒ±rada sƒ±ralayalƒ±m
      groups[group].sort((a, b) => {
        let aVal = 0, bVal = 0;
        if (typeof a.MainConcept_Tutar === "string") {
          let rawA = a.MainConcept_Tutar.substring(1).trim();
          rawA = rawA.replace(/\./g, "").replace(/,/g, ".");
          aVal = parseFloat(rawA) || 0;
        } else {
          aVal = a.MainConcept_Tutar || 0;
        }
        if (typeof b.MainConcept_Tutar === "string") {
          let rawB = b.MainConcept_Tutar.substring(1).trim();
          rawB = rawB.replace(/\./g, "").replace(/,/g, ".");
          bVal = parseFloat(rawB) || 0;
        } else {
          bVal = b.MainConcept_Tutar || 0;
        }
        return bVal - aVal; // Azalan sƒ±ralama
      });
      groups[group].forEach((record, index) => {
        // Ana konsept tutarƒ±nƒ± sayƒ±ya √ßevirme (gerekirse)
        let mainTutar = record.MainConcept_Tutar;
        if (typeof mainTutar === "string" && (mainTutar.startsWith("‚Ç∫") || mainTutar.startsWith("$") || mainTutar.startsWith("‚Ç¨"))) {
          let raw = mainTutar.substring(1).trim();
          raw = raw.replace(/\./g, "").replace(/,/g, ".");
          const num = parseFloat(raw);
          if (!isNaN(num)) {
            mainTutar = num;
          }
        }
        
        finalHTML += `
          <tr data-concept-id="${record.ID}">
            <td style="width:5%;">${index + 1}</td>
            <td style="width:20%;">${record.KonseptAdi || ""}</td>
            <td style="width:5%; text-align: center;">
              ${record.CONCEPTLOCK == 1 ? '<i class="fas fa-check" style="color: green;"></i>' : '<i class="fas fa-times" style="color: red;"></i>'}
            </td>
            <td class="text-right" style="width:10%;">${record.MainConcept_Miktar || 0}</td>
            <td class="text-right" style="width:10%;">${formatCurrencyLocal(mainTutar || 0, currency)}</td>
            <td class="text-right" style="width:10%;">${record.Additional_Miktar || 0}</td>
            <td class="text-right" style="width:10%;">${formatCurrencyLocal(record.Additional_Tutar || 0, currency)}</td>
            <td class="text-right" style="width:10%;">${record.Additionalaks_Miktar || 0}</td>
            <td class="text-right" style="width:10%;">${formatCurrencyLocal(record.Additionalaks_Tutar || 0, currency)}</td>
            <td class="text-right" style="width:10%; background-color: #bfc9c9;">
              ${(record.MainConcept_Miktar || 0) + (record.Additional_Miktar || 0) + (record.Additionalaks_Miktar || 0)}
            </td>
            <td class="text-right" style="width:10%; background-color: #bfc9c9;">
              ${formatCurrencyLocal((record.MainConcept_Tutar || 0) + (record.Additional_Tutar || 0) + (record.Additionalaks_Tutar || 0), currency)}
            </td>
            <td class="text-right" style="width:10%;">${record.Accessories_Miktar || 0}</td>
            <td class="text-right" style="width:10%;">${formatCurrencyLocal(record.Accessories_Tutar || 0, currency)}</td>
            <td class="text-right" style="width:10%;">${record.Supplementary_Miktar || 0}</td>
            <td class="text-right" style="width:10%;">${formatCurrencyLocal(record.Supplementary_Tutar || 0, currency)}</td>
            ${!hideOthersColumns ? `
              <td class="text-right" style="width:10%; ${(record.Others_Miktar > 0) ? 'background-color: #c8e6c9;' : ''}">
                ${record.Others_Miktar || 0}
              </td>
              <td class="text-right" style="width:10%; ${(record.Others_Tutar > 0) ? 'background-color: #c8e6c9;' : ''}">
                ${formatCurrencyLocal(record.Others_Tutar || 0, currency)}
              </td>
            ` : ""}
            <td style="width:5%; text-align: center;">
              <button style="border: none; background: none; cursor: pointer;" 
                onclick="generateConceptTablePDF('tr', this.closest('tr').getAttribute('data-concept-id'))">
                üìÑ TR
              </button>
              <button style="border: none; background: none; cursor: pointer;" 
                onclick="generateConceptTablePDF('en', this.closest('tr').getAttribute('data-concept-id'))">
                üìÑ EN
              </button>
            </td>
          </tr>
        `;
      });
      grandTotal += groups[group].length;
      finalHTML += `
        <tr style="font-weight:bold; background-color:#f0f0f0;">
          <td colspan="${totalColumns}" class="text-left">${group} - ${groups[group].length} Adet Konsept</td>
        </tr>
      `;
    });

    finalHTML += `
      <tr style="font-weight:bold; background-color:#dcdcdc;">
        <td colspan="${totalColumns}" class="text-left">Toplam - ${grandTotal} Adet Konsept</td>
      </tr>
          </tbody>
        </table>
      </div>
    `;

    // Olu≈üturduƒüumuz HTML'i conceptContainer i√ßerisine aktaralƒ±m
    if (conceptContainer) {
      conceptContainer.innerHTML = finalHTML;
    }
	 // Sticky header bar'ƒ± olu≈üturacak fonksiyonu √ßaƒüƒ±rƒ±n
    createStickyHeaderBar();

    // Render sonrasƒ±, dropdown i√ßin event listener ekleyelim
    const dropdown = document.getElementById("currencySelect");
    if (dropdown) {
      dropdown.addEventListener("change", () => {
        window.selectedCurrency = dropdown.value; // Global deƒüeri g√ºncelle
        console.log("Se√ßilen Para Birimi:", window.selectedCurrency);
        loadConceptSummaryReport(language, window.selectedCurrency);
      });
    }

  } catch (error) {
    console.error("Konsept √∂zet raporu y√ºklenirken hata:", error);
    alert("Konsept √∂zet raporu y√ºklenirken bir hata olu≈ütu: " + error.message);
  }
};

//navbar altƒ±na s√ºtun ba≈ülƒ±ƒüƒ± i√ßin bar
function createStickyHeaderBar() {
  // Eski sticky header varsa kaldƒ±r
  const existingBar = document.getElementById("stickyHeaderBar");
  if (existingBar) {
    existingBar.remove();
  }
  const existingBarY = document.getElementById("stickyHeaderBarY");
  if (existingBarY) {
    existingBarY.remove();
  }
  const existingBarZ = document.getElementById("stickyHeaderBarZ");
  if (existingBarZ) {
    existingBarZ.remove();
  }

  // "konseptozet" id'li tabloyu se√ßiyoruz
  const table = document.querySelector("table#konseptozet");
  if (!table) return;

  // Sticky header kapsayƒ±cƒ± div
  const stickyHeaderBar = document.createElement("div");
  stickyHeaderBar.id = "stickyHeaderBar";
  stickyHeaderBar.style.display = "none"; // Ba≈ülangƒ±√ßta gizli
  stickyHeaderBar.style.position = "fixed";
  stickyHeaderBar.style.top = "50px";        // Nav bar y√ºksekliƒüi (gerekirse ayarlayƒ±n)
  console.log("hideOthersColumns deƒüeri", window.hideOthersColumns);
  // hideOthersColumns deƒüerine g√∂re left/right ayarlarƒ±:
  if (window.hideOthersColumns) {
  //Diƒüer S√ºtunlarƒ± Gizli ise
  stickyHeaderBar.style.left = "15.9%";
  stickyHeaderBar.style.right = "4.2%";
  } else {
  //Diƒüer S√ºtunlarƒ± G√∂steriliyor ise
  stickyHeaderBar.style.left = "12%";
  stickyHeaderBar.style.right = "0.35%";
  }
  stickyHeaderBar.style.overflow = "hidden";
  stickyHeaderBar.style.backgroundColor = "#fff";
  stickyHeaderBar.style.borderBottom = "1px solid #ccc";
  stickyHeaderBar.style.zIndex = "999";

  // Sticky header i√ßindeki tabloyu olu≈üturuyoruz
  const stickyTable = document.createElement("table");
  stickyTable.style.width = "100%";
  stickyTable.style.borderCollapse = "collapse";
  stickyTable.style.tableLayout = "fixed";

  // Manuel <colgroup> ‚Äì Konsept √ñzet Raporu s√ºtun geni≈ülikleri (√∂rnek deƒüerler)
  // hideOthersColumns deƒüerine g√∂re colgroup olu≈ütur
  const colgroupHTML = getColgroupHTML(hideOthersColumns);
  stickyTable.innerHTML = colgroupHTML;

  // Ana tablodaki <thead>'i klonlayƒ±p sticky tabloya ekliyoruz
  const originalThead = table.querySelector("thead");
  if (!originalThead) return;
  const clonedThead = originalThead.cloneNode(true);
  stickyTable.appendChild(clonedThead);

  // Sticky tabloyu kapsayƒ±cƒ± div'e ekleyip body'ye yerle≈ütiriyoruz
  stickyHeaderBar.appendChild(stickyTable);
  document.body.appendChild(stickyHeaderBar);

  // Scroll event'i: Belirli e≈üik deƒüeri a≈üƒ±ldƒ±ƒüƒ±nda sticky header g√∂r√ºn√ºr olsun
  window.addEventListener("scroll", function() {
    const headerHeight = originalThead.offsetHeight;
    const threshold = table.offsetTop + (headerHeight);
    if (window.scrollY > threshold) {
      stickyHeaderBar.style.display = "block";
    } else {
      stickyHeaderBar.style.display = "none";
    }
  });
}

//konsept √∂zet tablosunda gizlenen kolonlara g√∂re manuel ba≈ülƒ±k geni≈üliƒüi (steakyheaderbar i√ßin)
function getColgroupHTML(hideOthersColumns) {
  if (hideOthersColumns) {
    // Others s√ºtunlarƒ± gizlenecek; toplam s√ºtun sayƒ±sƒ± 16 olacak ≈üekilde (√∂rnek deƒüerler)
    return `
      <colgroup>
        <col style="width: 2.77%;">   <!-- S -->
        <col style="width: 17.98443%;">  <!-- Konsept Adƒ± -->
        <col style="width: 3.728479%;">   <!-- Kilitli -->
        <col style="width: 4.485141%;">  <!-- Ana Konsept Miktar -->
        <col style="width: 6.579669%;">     <!-- Ana Konsept Tutar -->
        <col style="width: 4.82509%;">   <!-- Tamamlayƒ±cƒ± √úr√ºn Miktar -->
        <col style="width: 5.921702%;">   <!-- Tamamlayƒ±cƒ± √úr√ºn Tutar -->
        <col style="width: 5.921702%;">   <!-- Tamamlayƒ±cƒ± Aksesuar Miktar -->
        <col style="width: 6.908652%;">   <!-- Tamamlayƒ±cƒ± Aksesuar Tutar -->
        <col style="width: 4.386446%;">     <!-- Genel Toplam Miktar -->
        <col style="width: 6.579669%;">     <!-- Genel Toplam Tutar -->
        <col style="width: 4.485141%;">  <!-- Ek Aksesuar Miktar -->
        <col style="width: 5.70238%;">   <!-- Ek Aksesuar Tutar -->
        <col style="width: 4.485141%;">  <!-- Ek √úr√ºn Miktar -->
        <col style="width: 5.833973%;">  <!-- Ek √úr√ºn Tutar -->
        <col style="width: 9.430859%;">   <!-- PDF -->
      </colgroup>
    `;
  } else {
    // Others s√ºtunlarƒ± dahil; toplam s√ºtun sayƒ±sƒ± 18 olacak ≈üekilde (√∂rnek deƒüerler)
    return `
      <colgroup>
        <col style="width: 2.5%;">   <!-- S -->
        <col style="width: 16.4%;">  <!-- Konsept Adƒ± -->
        <col style="width: 3.4%;">   <!-- Kilitli -->
        <col style="width: 4.09%;">  <!-- Ana Konsept Miktar -->
        <col style="width: 6%;">     <!-- Ana Konsept Tutar -->
        <col style="width: 4.4%;">   <!-- Tamamlayƒ±cƒ± √úr√ºn Miktar -->
        <col style="width: 5.4%;">   <!-- Tamamlayƒ±cƒ± √úr√ºn Tutar -->
        <col style="width: 5.4%;">   <!-- Tamamlayƒ±cƒ± Aksesuar Miktar -->
        <col style="width: 6.3%;">   <!-- Tamamlayƒ±cƒ± Aksesuar Tutar -->
        <col style="width: 4%;">     <!-- Genel Toplam Miktar -->
        <col style="width: 6%;">     <!-- Genel Toplam Tutar -->
        <col style="width: 4.09%;">  <!-- Ek Aksesuar Miktar -->
        <col style="width: 5.2%;">   <!-- Ek Aksesuar Tutar -->
        <col style="width: 4.09%;">  <!-- Ek √úr√ºn Miktar -->
        <col style="width: 5.32%;">  <!-- Ek √úr√ºn Tutar -->
        <col style="width: 4.09%;">  <!-- Diƒüer √úr√ºnler Miktar -->
        <col style="width: 4.7%;">   <!-- Diƒüer √úr√ºnler Tutar -->
        <col style="width: 8.6%;">   <!-- PDF -->
      </colgroup>
    `;
  }
}


//√úr√ºn √ñzet Raporu i√ßin Scrooll ba≈ülƒ±ƒüƒ± olu≈üturma 
function createStickyHeaderBarY() {
  // Eski sticky header varsa kaldƒ±r
  const existingBarY = document.getElementById("stickyHeaderBarY");
  if (existingBarY) {
    existingBarY.remove();
  }
  const existingBar = document.getElementById("stickyHeaderBar");
  if (existingBar) {
    existingBar.remove();
  }
  const existingBarZ = document.getElementById("stickyHeaderBarZ");
  if (existingBarZ) {
    existingBarZ.remove();
  }
  

  // "urunozet" id'li tabloyu se√ßiyoruz
  const activeTable = document.querySelector("table#urunozet");
  if (!activeTable) return;

  // Sticky header kapsayƒ±cƒ± div
  const stickyHeaderBarY = document.createElement("div");
  stickyHeaderBarY.id = "stickyHeaderBarY";
  stickyHeaderBarY.style.display = "none"; // ƒ∞lk √ßaƒürƒ±da g√∂r√ºnmemeli
  stickyHeaderBarY.style.position = "fixed";
  stickyHeaderBarY.style.top = "50px";          // Nav bar y√ºksekliƒüi
  stickyHeaderBarY.style.left = "28.5%";         // Sol filtre alanƒ± geni≈üliƒüi
  stickyHeaderBarY.style.right = "31.8%";         // Sol filtre alanƒ± geni≈üliƒüi
  stickyHeaderBarY.style.fontSize = "12px";
  stickyHeaderBarY.style.overflow = "hidden";
  stickyHeaderBarY.style.backgroundColor = "#fff";
  stickyHeaderBarY.style.borderBottom = "1px solid #ccc";
  stickyHeaderBarY.style.zIndex = "999";

  // Sticky header i√ßindeki tabloyu olu≈üturuyoruz
  const stickyTableY = document.createElement("table");
  stickyTableY.style.width = "100%";
  stickyTableY.style.font = "14px";
  stickyTableY.style.borderCollapse = "collapse";
  stickyTableY.style.tableLayout = "fixed";

  // Manuel <colgroup> ‚Äì √úr√ºn √ñzet Raporu s√ºtun geni≈ülikleri (√∂rnek deƒüerler)
  // S: %5, BASAMAK4: %20, Toplam √úr√ºn: %20, Konsept √úr√ºn: %20, Konsept Dƒ±≈üƒ±: %20, Oran: %15
  const colgroupHTMLY = `
    <colgroup>
      <col style="width:5.52%;">
      <col style="width:33.20%;">
      <col style="width:17.02%;">
      <col style="width:18.12%;">
      <col style="width:17.1%;">
      <col style="width:9.04%;">
    </colgroup>
  `;
  stickyTableY.innerHTML = colgroupHTMLY;

  // Ana tablodaki <thead>'i klonlayƒ±p sticky tabloya ekliyoruz
  const originalTheadY = activeTable.querySelector("thead");
  if (!originalTheadY) return;
  const clonedTheadY = originalTheadY.cloneNode(true);
  stickyTableY.appendChild(clonedTheadY);

  // Sticky tabloyu kapsayƒ±cƒ± div'e ekleyip body'ye yerle≈ütiriyoruz
  stickyHeaderBarY.appendChild(stickyTableY);
  document.body.appendChild(stickyHeaderBarY);

  // Scroll event'i: Belirli e≈üik deƒüeri a≈üƒ±ldƒ±ƒüƒ±nda sticky header g√∂r√ºn√ºr olsun
  window.addEventListener("scroll", function() {
    const headerHeight = originalTheadY.offsetHeight;
    const threshold = activeTable.offsetTop + (headerHeight * 2);
    if (window.scrollY > threshold) {
      stickyHeaderBarY.style.display = "block";
    } else {
      stickyHeaderBarY.style.display = "none";
    }
  });
}



// Konsept √∂zeti i√ßin Konteyner i√ßinde bulunan tablolardan, g√∂r√ºnt√ºde olan (aktif) tabloyu tespit edip sticky header'ƒ± olu≈üturur.
function updateStickyHeaderBar() {
  // Sadece tablo id'lerine g√∂re kontrol yapƒ±yoruz.
  const tableK = document.querySelector("table#konseptozet");
  const tableU = document.querySelector("table#urunozet");

  if (tableK) {
    // Eƒüer "konseptozet" tablosu varsa, konsept sticky header'ƒ± √ßaƒüƒ±r.
    createStickyHeaderBar();
    // "urunozet" sticky header varsa gizle
    const stickyY = document.getElementById("stickyHeaderBarY");
    if (stickyY) stickyY.style.display = "none";
	
  } else if (tableU) {
    // Eƒüer "urunozet" tablosu varsa, √ºr√ºn sticky header'ƒ± √ßaƒüƒ±r.
    createStickyHeaderBarY();
    // "konseptozet" sticky header varsa gizle
    const stickyX = document.getElementById("stickyHeaderBar");
    if (stickyX) stickyX.style.display = "none";
	
  } else {
    // Hi√ßbiri yoksa, varsa her iki sticky header'ƒ± da gizle.
    const stickyX = document.getElementById("stickyHeaderBar");
    if (stickyX) stickyX.style.display = "none";
    const stickyY = document.getElementById("stickyHeaderBarY");
    if (stickyY) stickyY.style.display = "none";
	
  }
}



// Sadece concept-products-container i√ßeriƒüini yazdƒ±ran global yazdƒ±rma fonksiyonu
function printConceptContainer() {
  const container = document.getElementById("concept-products-container");
  if (!container) return;
  const printWindow = window.open("", "", "height=600,width=800");
  printWindow.document.write("<html><head><title>Konsept Raporu</title>");
  printWindow.document.write("<style>");
  // Kenar bo≈üluklarƒ± minimuma indirilmi≈ü yazdƒ±rma stili + .text-right kuralƒ± ekleniyor
  printWindow.document.write("@media print { @page { size: A4 portrait; margin: 5mm; } body { -webkit-print-color-adjust: exact; } }");
  printWindow.document.write("table { width: 100%; border-collapse: collapse; } th, td { padding: 5px; border: 1px solid #ccc; }");
  printWindow.document.write(".text-right { text-align: right; }");
  printWindow.document.write("</style>");
  printWindow.document.write("</head><body>");
  printWindow.document.write(container.innerHTML);
  printWindow.document.write("</body></html>");
  printWindow.document.close();
  printWindow.focus();
  setTimeout(() => {
    printWindow.print();
    printWindow.close();
  }, 500);
}

// Sadece concept-products-container i√ßeriƒüini Excel'e aktaran global fonksiyon
function exportConceptOzetToExcel() {
  const container = document.getElementById("concept-products-container");
  if (!container) return;
  
  // Konsept raporunun HTML tablosunun bir kopyasƒ±nƒ± olu≈üturuyoruz.
  const clone = container.cloneNode(true);
  
  // Yazdƒ±r ve Excel'e Aktar butonlarƒ±nƒ± klon i√ßerikten kaldƒ±rƒ±yoruz.
  const btns = clone.querySelectorAll("#printButton, #exportButton, #currencySelect, #currencySelectLabel");
  btns.forEach(btn => btn.remove());
  
  // --- Yeni: Header'da "Para Cinsi" s√ºtunu ekleyelim ---
  // Burada, header yapƒ±nƒ±zƒ±n 2. satƒ±rƒ±nda (birle≈üik "Konsept Adƒ±" h√ºcresinden sonra)
  let headerRows = [];
  if (clone.querySelector("thead") && clone.querySelector("thead").rows.length >= 2) {
    headerRows = Array.from(clone.querySelector("thead").rows);
  } else if (clone.querySelector("table").rows.length >= 2) {
    headerRows = [clone.querySelector("table").rows[0], clone.querySelector("table").rows[1]];
  }
  if (headerRows.length >= 2) {
    // "Konsept Adƒ±" h√ºcresinin indeksini bulalƒ±m (√∂rneƒüin, header'da 2. s√ºtun)
    const firstHeaderRow = headerRows[0];
    let konseptAdiIndex = -1;
    for (let i = 0; i < firstHeaderRow.cells.length; i++) {
      const txt = firstHeaderRow.cells[i].textContent.trim().toLowerCase();
      if (txt.includes("konsept adƒ±")) {
        konseptAdiIndex = i;
        break;
      }
    }
    if (konseptAdiIndex !== -1) {
      // Yeni header h√ºcresi: "Para Cinsi", rowspan="2"
      const newHeaderCell = document.createElement("th");
      newHeaderCell.textContent = "Para Cinsi";
      newHeaderCell.setAttribute("rowspan", "2");
      // Yeni h√ºcreyi, "Konsept Adƒ±" h√ºcresinin hemen sonrasƒ±na ekleyelim.
      firstHeaderRow.insertBefore(newHeaderCell, firstHeaderRow.cells[konseptAdiIndex + 1]);
    }
  }
  
  // --- Veri satƒ±rlarƒ±nda para cinsi s√ºtunu ekleyelim ---
  // Varsayalƒ±m ki veri satƒ±rlarƒ± <tbody> i√ßinde yer alƒ±yor.
  const tbody = clone.querySelector("table").tBodies[0];
  if (tbody) {
    for (let i = 0; i < tbody.rows.length; i++) {
      const row = tbody.rows[i];
      // Varsayƒ±lan yapƒ±: 0: S, 1: Konsept Adƒ±, 2: Ana Konsept Miktar, 3: Ana Konsept Tutar, ...
      // Yeni "Para Cinsi" s√ºtunu, "Konsept Adƒ±" s√ºtunundan hemen sonra eklenmeli (yani index 2'e)
      const targetIndex = 3; // "Ana Konsept Tutar" h√ºcresinin indeksi (√∂rneƒüin)
      let currency = "";
      if (row.cells.length > targetIndex) {
        const cellText = row.cells[targetIndex].textContent.trim();
        if (cellText.startsWith("‚Ç∫")) {
          currency = "TL";
        } else if (cellText.startsWith("$")) {
          currency = "USD";
        } else if (cellText.startsWith("‚Ç¨")) {
          currency = "EUR";
        }
      }
      const newCell = document.createElement("td");
      newCell.textContent = currency;
      newCell.className = "text-right";
      // "Konsept Adƒ±" s√ºtunu varsayƒ±lan olarak index 1 olduƒüundan, eklemek i√ßin index 2'ye ekliyoruz.
      row.insertBefore(newCell, row.cells[2]);
    }
  }
  
  // --- Tutar s√ºtunlarƒ±ndaki h√ºcrelerdeki para birimi deƒüerlerini d√ºzenleyelim ---
  // Bu adƒ±mda, TUTAR h√ºcrelerinde bulunan para birimi sembollerini kaldƒ±rƒ±p, sadece sayƒ± deƒüeri olarak aktaracaƒüƒ±z.
  // (√ñrneƒüin, "‚Ç∫300.000" ‚Üí "300000" sayƒ±sƒ±)
  const cells = clone.querySelectorAll("td");
  cells.forEach(cell => {
    let text = cell.textContent.trim();
    if (text.startsWith("‚Ç∫") || text.startsWith("$") || text.startsWith("‚Ç¨")) {
      // ƒ∞lk karakterdeki para birimi sembol√ºn√º alƒ±p kaldƒ±rƒ±yoruz.
      const symbol = text.charAt(0);
      let raw = text.substring(1).trim();
      // T√ºm noktalarƒ± (binlik ayracƒ±) kaldƒ±r; virg√ºl√º ondalƒ±k ayracƒ± temsil edecek ≈üekilde nokta yap:
      raw = raw.replace(/\./g, "").replace(/,/g, ".");
      const num = parseFloat(raw);
      if (!isNaN(num)) {
        cell.textContent = num; // H√ºcreye sayƒ±sal deƒüeri yazƒ±yoruz.
        // H√ºcredeki sayƒ±, Excel'e sistem b√∂lgesine baƒülƒ± olarak bi√ßimlendirilecek.
        // Excel'in T√ºrk√ße formatƒ± kullanmasƒ± i√ßin mso-number-format " #,##0" kullanƒ±labilir.
        if (symbol === "‚Ç∫") {
          cell.style.cssText += " mso-number-format:\"[$-tr-TR]#.##0\";";
        } else if (symbol === "$") {
          cell.style.cssText += " mso-number-format:\"[$-tr-TR]#.##0\";";
        } else if (symbol === "‚Ç¨") {
          cell.style.cssText += " mso-number-format:\"[$-tr-TR]#.##0\";";
        }
      }
    }
  });
  
  // Dƒ±≈üarƒ± aktarƒ±lacak HTML i√ßeriƒüini UTF-8 meta etiketi ve dahili stil kurallarƒ± ile sarmalƒ±yoruz.
  const htmlContent = `
    <html>
      <head>
        <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
        <style>
          @media print {
            @page { size: A4 portrait; margin: 5mm; }
            body { -webkit-print-color-adjust: exact; }
            #printButton, #exportButton { display: none; }
          }
          table { width: 100%; border-collapse: collapse; }
          th, td { padding: 5px; border: 1px solid #ccc; }
          .text-right { text-align: right; }
        </style>
      </head>
      <body>
        ${clone.innerHTML}
      </body>
    </html>
  `;
  
  const dataType = 'application/vnd.ms-excel;charset=UTF-8';
  const filename = 'Konseptler Kategori Detaylƒ± √ñzet.xls';
  const downloadLink = document.createElement("a");
  downloadLink.href = 'data:' + dataType + ', ' + encodeURIComponent(htmlContent);
  downloadLink.download = filename;
  document.body.appendChild(downloadLink);
  downloadLink.click();
  document.body.removeChild(downloadLink);
}



const updateConceptProductLayout = () => {
    const filterContainer = document.getElementById("filter-container");
    const conceptContainer = document.getElementById("concept-products-container");
    if (!conceptContainer) return;
    let filterWidth = filterContainer ? filterContainer.offsetWidth : 220;
    let availableWidth = window.innerWidth - filterWidth;
    let columnCount = 4;
    if (availableWidth < 1280) columnCount = 3;
    if (availableWidth < 1024) columnCount = 2;
    if (availableWidth < 768) columnCount = 1;
    document.documentElement.style.setProperty("--column-count", columnCount);
    document.querySelectorAll("#concept-products-container .product").forEach(product => {
        product.style.flex = `0 1 calc(${availableWidth / columnCount - 20}px)`;
        product.style.maxWidth = `calc(${availableWidth / columnCount - 20}px)`;
    });
};

window.addEventListener("resize", updateConceptProductLayout);
document.addEventListener("DOMContentLoaded", updateConceptProductLayout);

const addGroupToCart = async (groupName, allProducts) => {
    try {
        if (!activeCartId) {
            alert("L√ºtfen √∂nce bir sepet se√ßin.");
            return;
        }
        const cartInfoResponse = await fetch(`http://192.168.30.4:3000/cart-info/${activeCartId}`);
        if (!cartInfoResponse.ok) throw new Error("Aktif sepet bilgileri alƒ±namadƒ±.");
        const cartInfo = await cartInfoResponse.json();
        if (cartInfo.CONCEPT === 1) {
            alert("Toplu √úr√ºn Eklemede Se√ßili Sepet Konsept Sepeti Olamaz");
            return;
        }
        const groupProducts = allProducts.filter(product => {
            if (groupName === "ANA KONSEPT √úR√úNLERƒ∞") return product.MAINCONCEPT == 1;
            if (groupName === "TAMAMLAYICI √úR√úNLER") return product.ADDITIONAL == 1;
			if (groupName === "TAMAMLAYICI AKSESUARLAR") return product.ADDITIONALAKS == 1;
            if (groupName === "EK AKSESUARLAR") return product.ACCESSORIES == 1;
			if (groupName === "EK √úR√úNLER") return product.SUPPLEMENTARY == 1;
            return false;
        });
        if (groupProducts.length === 0) {
            alert("Bu gruba ait √ºr√ºn bulunamadƒ±.");
            return;
        }
        for (const product of groupProducts) {
            await fetch("http://192.168.30.4:3000/cart/item", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({
                    cartId: activeCartId,
                    productId: product.KOD,
                    quantity: product.MIKTAR || 1
                })
            });
        }
        alert(`${groupName} grubundaki t√ºm √ºr√ºnler sepete eklendi.`);
        await showCartContents();
    } catch (error) {
        console.error("Grup √ºr√ºnlerini sepete ekleme hatasƒ±:", error);
        alert("√úr√ºnler sepete eklenirken bir hata olu≈ütu.");
    }
};
//Men√ºlerin ekranƒ±n dƒ±≈üƒ±na ta≈ümasƒ±nƒ± engellemek i√ßin JavaScript
document.addEventListener('DOMContentLoaded', () => {
    const dropdownMenus = document.querySelectorAll('.dropdown');

    dropdownMenus.forEach((menu) => {
        menu.addEventListener('show.bs.dropdown', function () {
            const dropdownMenu = this.querySelector('.dropdown-menu');
            const navbar = document.querySelector('.navbar');
            const navbarHeight = navbar.offsetHeight;

            // Dropdown men√º pozisyonunu ayarla
            dropdownMenu.style.top = `${navbarHeight}px`; // Navbarƒ±n altƒ±ndan ba≈ülar
            dropdownMenu.style.left = '0'; // Varsayƒ±lan sola hizalanƒ±r
            dropdownMenu.style.display = 'block'; // G√∂r√ºn√ºr yap
        });
    });
});

//konsept pdfsini tablodan olu≈üturma
window.generateConceptTablePDF = async (language = "tr", conceptId) => {

	if (!conceptId) {
		alert("Konsept ID belirtilmedi.");
		return;
	  }
  const { jsPDF } = window.jspdf;
  // A4 landscape: 297 x 210 mm
  const doc = new jsPDF({
    orientation: "landscape",
    unit: "mm",
    format: "a4",
  });
  
  const margin = 5;
  const pageWidth = 297; // Landscape A4 geni≈üliƒüi
  const pageHeight = 210; // Landscape A4 y√ºksekliƒüi

  // ---------------- Yardƒ±mcƒ± Fonksiyonlar ----------------
  const arrayBufferToBase64 = (buffer) => {
    let binary = "";
    const bytes = new Uint8Array(buffer);
    for (let i = 0; i < bytes.byteLength; i++) {
      binary += String.fromCharCode(bytes[i]);
    }
    return btoa(binary);
  };

  const formatNumber = (value) => {
    const parts = Number(value).toFixed(2).split(".");
    parts[0] = parts[0].replace(/\B(?=(\d{3})+(?!\d))/g, ".");
    return parts.join(",");
  };

  const loadFont = async () => {
    const fontUrl = "/fonts/Roboto-Regular.ttf";
    const fontResponse = await fetch(fontUrl);
    if (!fontResponse.ok) throw new Error("Font y√ºklenemedi.");
    const fontData = await fontResponse.arrayBuffer();
    const fontBase64 = arrayBufferToBase64(fontData);
    doc.addFileToVFS("Roboto-Regular.ttf", fontBase64);
    doc.addFont("Roboto-Regular.ttf", "Roboto", "normal");
    doc.setFont("Roboto");
  };
  await loadFont();

  const fetchBlobImage = async (url) => {
    const response = await fetch(url);
    if (!response.ok) throw new Error(`Fotoƒüraf y√ºklenemedi: ${url}`);
    const blob = await response.blob();
    return new Promise((resolve) => {
      const reader = new FileReader();
      reader.onload = () => resolve(reader.result);
      reader.readAsDataURL(blob);
    });
  };

  const replaceTurkishChars = (text) => {
    if (!text) return "";
    return text
      .replace(/≈û/g, "S")
      .replace(/≈ü/g, "s")
      .replace(/ƒ∞/g, "I")
      .replace(/ƒ±/g, "i")
      .replace(/√á/g, "C")
      .replace(/√ß/g, "c")
      .replace(/√ú/g, "U")
      .replace(/√º/g, "u")
      .replace(/√ñ/g, "O")
      .replace(/√∂/g, "o")
      .replace(/ƒû/g, "G")
      .replace(/ƒü/g, "g");
  };

  // ---------------- Sepet Bilgilerini √áekme ----------------
  const cartInfoResponse = await fetch(`http://192.168.30.4:3000/cart-info/${conceptId}`);
  if (!cartInfoResponse.ok) throw new Error("Sepet bilgileri alƒ±namadƒ±.");
  const cartInfo = await cartInfoResponse.json();
  window.currentCartInfo = cartInfo;
  let globalCurrency = window.selectedCurrency;
  if (cartInfo.PRICE_TYPE === "1" || cartInfo.PRICE_TYPE === "2") globalCurrency = "TRY";
  if (cartInfo.PRICE_TYPE === "3" || cartInfo.PRICE_TYPE === "4") globalCurrency = "USD";
  if (cartInfo.PRICE_TYPE === "5" || cartInfo.PRICE_TYPE === "6") globalCurrency = "EUR";

  // ---------------- Header & Footer ----------------
  const addHeader = () => {
    const headerY = margin;
    const title = cartInfo.CUSTOMER_NAME || (language === "tr" ? "KONSEPT" : "CONCEPT");
    doc.setFontSize(18);
    doc.text(title, pageWidth / 2, headerY + 10, { align: "center" });
  };

  const addFooter = async () => {
    let logoBase64 = "";
    try {
      logoBase64 = await fetchBlobImage("/resim/EDLogo.png");
    } catch (error) {
      console.error("Logo y√ºklenemedi:", error);
      return;
    }
    const logoWidth = 35;
    const logoHeight = 7.5;
    const x = (pageWidth - logoWidth) / 2;
    const y = pageHeight - margin - logoHeight;
    doc.addImage(logoBase64, "PNG", x, y, logoWidth, logoHeight);
  };

  // ---------------- √úr√ºn Verilerini √áekme ----------------
	 const fetchCartData = async (cartId, language = "tr", currency = "TL") => {
	 currency = window.selectedCurrency;
     console.log("GeneratePDF Ba≈üƒ±nda:", currency);
	  const endpoint = language === "en"
		? `/api/cart/${cartId}/pdfdata-en?currency=${currency}`
		: `/api/cart/${cartId}/pdfdata?currency=${currency}`;
		 console.log("Fetching cart data with parameters:", { cartId, language, currency, endpoint })
	  const response = await fetch(endpoint);
	  if (!response.ok) throw new Error("Sepet verisi alƒ±namadƒ±.");
	  const result = await response.json();
	  if (!result.success) throw new Error(result.message);
	  return result.data;
	};


  let cartData = await fetchCartData(conceptId, language);

  // ---------------- √úr√ºn Sƒ±ralamasƒ± (Global Toplamlar i√ßin) ----------------
  const groupOrder =
    language === "en"
      ? ["MAIN CONCEPT", "ADDITIONAL ITEMS", "ADDITIONAL ACCESSORIES", "ACCESSORIES", "SUPPLEMENTARY", "OTHER"]
      : ["ANA KONSEPT", "TAMAMLAYICI URUNLER", "TAMAMLAYICI AKSESUARLAR", "EK AKSESUARLAR", "EK URUNLER", "DIGER"];
  const defaultGroup = language === "en" ? "OTHER" : "DIGER";
  
  // Global toplam hesaplamalarƒ±nda EK URUNLER (SUPPLEMENTARY) hari√ß tutuluyor.
  let totalQuantity = 0;
  let totalAmount = 0;
  cartData.forEach((item) => {
    const groupKey = (item.CONCEPTGRUP || defaultGroup).toUpperCase();
    if (
  (language === "en" && groupKey !== "SUPPLEMENTARY" && groupKey !== "ACCESSORIES") ||
  (language !== "en" && groupKey !== "EK URUNLER" && groupKey !== "EK AKSESUARLAR")
) {
      const quantity = Number(item.QUANTITY);
      const price = item.CUSTOM_CODE ? (item.CUSTOM_PRICE || 0) : (item.PRICE || 0);
      const discountRate = item.CUSTOM_CODE ? (item.CUSTOM_DISCOUNT_RATE || 0) : (item.DISCOUNT_RATE || 0);
      const discountedPrice = price * (1 - discountRate / 100);
      totalQuantity += quantity;
      totalAmount += discountedPrice * quantity;
    }
  });
    // Global d√∂viz mapping
  const currencyMapping = {
    "1": "TRY",
    "2": "TL",
    "3": "USD",
    "4": "USD",
    "5": "EUR",
    "6": "EUR",
  };

  // ---------------- ƒ∞lk B√∂l√ºm: Grid G√∂r√ºn√ºm√º (Fotoƒüraflar ve Bilgiler) ----------------
  const imgWidth = 40, imgHeight = 40;
  const infoHeight = 10;
  const cellHeight = imgHeight + infoHeight;
  const gapX = 5, gapY = 5;
  const gridStartY = margin + 20; // Grid ba≈ülangƒ±√ß Y deƒüeri
  const availableHeight = pageHeight - margin - 20 - 10;
  const maxRowsPerColumn = Math.floor(availableHeight / (cellHeight + gapY));
  const cellWidth = imgWidth;
  const availableWidth = pageWidth - 2 * margin;
  const maxColsPerPage = Math.floor(availableWidth / (cellWidth + gapX));

  // Grid alanƒ±nƒ± gruplara ayƒ±rƒ±yoruz:
  // ƒ∞lk grup: ANA KONSEPT ve TAMAMLAYICI URUNLER
  // ƒ∞kinci grup: AKSESUARLAR, EK URUNLER ve varsa Dƒ∞ƒûER
  const firstGroupNames = language === "en" 
    ? ["MAIN CONCEPT", "ADDITIONAL ITEMS", "ADDITIONAL ACCESSORIES"] 
    : ["ANA KONSEPT", "TAMAMLAYICI URUNLER", "TAMAMLAYICI AKSESUARLAR"];
  const secondGroupNames = language === "en" 
    ? ["ACCESSORIES", "SUPPLEMENTARY", "OTHER"] 
    : ["EK AKSESUARLAR", "EK URUNLER", "DIGER"];

  const getGroupKey = (item) => (item.CONCEPTGRUP || defaultGroup).toUpperCase();
  const firstGroupItems = cartData.filter(item => firstGroupNames.includes(getGroupKey(item)));
  const secondGroupItems = cartData.filter(item => secondGroupNames.includes(getGroupKey(item)));

  // Her iki grup i√ßerisindeki √ºr√ºnleri, fiyata g√∂re (azalan) sƒ±ralayalƒ±m.
  const sortByPriceDescending = (a, b) => {
    const priceA = Number(a.CUSTOM_CODE ? (a.CUSTOM_PRICE || 0) : (a.PRICE || 0));
    const priceB = Number(b.CUSTOM_CODE ? (b.CUSTOM_PRICE || 0) : (b.PRICE || 0));
    return priceB - priceA;
  };

  firstGroupItems.sort(sortByPriceDescending);
  secondGroupItems.sort(sortByPriceDescending);

  // Grid g√∂r√ºn√ºm√ºn√º olu≈üturmak i√ßin yardƒ±mcƒ± fonksiyon
  const renderGridItems = async (items) => {
    let currentCol = 0, currentRow = 0;
    let gridX = margin, gridY = gridStartY;
    for (let i = 0; i < items.length; i++) {
      const item = items[i];
      let productImg = "";
      const imageUrl = `/resim/${item.PRODUCT_ID}.jpg`;
      try {
        productImg = await fetchBlobImage(imageUrl);
      } catch (error) {
        try {
          productImg = await fetchBlobImage("/resim/YOK.jpg");
        } catch (e) {
          console.error("Varsayƒ±lan fotoƒüraf alƒ±namadƒ±:", e);
        }
      }
      // Sayfa sƒ±nƒ±rƒ±nƒ± a≈üƒ±yorsa yeni sayfaya ge√ß
      if (gridY + cellHeight > pageHeight - margin) {
        await addFooter();
        doc.addPage();
        addHeader();
        currentCol = 0;
        currentRow = 0;
        gridX = margin;
        gridY = gridStartY;
      }
      if (productImg) {
        doc.addImage(productImg, "JPEG", gridX, gridY, imgWidth, imgHeight);
      }
      // Fotoƒüraf altƒ±ndaki bilgi kƒ±smƒ±: G√ºncel d√ºzenlemeniz uygulanƒ±yor.
      const labels = language === "en"
        ? { model: "Model", code: "Code", size: "Size", inch: "Inch", price: "Price" }
        : { model: "Model", code: "Kod", size: "Ebat", inch: "ƒ∞n√ß", price: "Fiyat" };
      const infoText = `${labels.model}: ${item.MODEL || "N/A"}\n${labels.code}: ${item.CUSTOM_CODE || item.PRODUCT_ID}\n${labels.size}: ${item.EBAT || "N/A"}\n${labels.inch}: ${item.EBATINCH || "N/A"}\n${labels.price}: ${formatNumber(item.PRICE) || "N/A"} ${window.selectedCurrency || "TRY"}`;
      doc.setFontSize(7);
      doc.text(infoText, gridX, gridY + imgHeight + 3);
      currentRow++;
      if (currentRow >= maxRowsPerColumn) {
        currentRow = 0;
        currentCol++;
        gridX = margin + currentCol * (cellWidth + gapX);
        gridY = gridStartY;
      } else {
        gridY += cellHeight + gapY;
      }
      if (gridX + cellWidth > pageWidth - margin) {
        await addFooter();
        doc.addPage();
        addHeader();
        currentCol = 0;
        currentRow = 0;
        gridX = margin;
        gridY = gridStartY;
      }
    }
  };

  // ƒ∞lk gruptaki (ANA KONSEPT & TAMAMLAYICI URUNLER) √ºr√ºnleri render et
  addHeader();
  await renderGridItems(firstGroupItems);
  await addFooter();

  // ƒ∞lk grup bittikten sonra yeni sayfada ikinci grubu (AKSESUARLAR, EK URUNLER, Dƒ∞ƒûER) render et
  if (secondGroupItems.length > 0) {
    doc.addPage();
    addHeader();
    await renderGridItems(secondGroupItems);
    await addFooter();
  }

  // ---------------- ƒ∞kinci B√∂l√ºm: √úr√ºn Listesi Tablosu (Fotoƒüraflar olmadan) ----------------
  doc.addPage();
  addHeader();

  // Tablo ba≈ülƒ±klarƒ± ("No" s√ºtunu ekleniyor)
  const headersTableArr =
    language === "tr"
      ? ["No", "√úr√ºn Kodu", "Kategori", "Model", "√ñl√ß√º cm", "√ñl√ß√º inch", "Fiyat", "Miktar", "Tutar", "D√∂viz"]
      : ["No", "Product Code", "Category", "Model", "Size cm", "Size inch", "Price", "Quantity", "Amount", "Currency"];

  // Gruplama: T√ºm √ºr√ºnler grup anahtarƒ±na g√∂re toplanƒ±yor
  const groupedData = cartData.reduce((groups, item) => {
    const groupKeyCandidate = (item.CONCEPTGRUP || defaultGroup).toUpperCase();
    const groupKey = groupOrder.includes(groupKeyCandidate) ? groupKeyCandidate : defaultGroup;
    if (!groups[groupKey]) {
      groups[groupKey] = [];
    }
    groups[groupKey].push(item);
    return groups;
  }, {});

  // Ayƒ±rƒ±yoruz: Ana gruplar (EK URUNLER hari√ß) ve EK URUNLER grubu
  const nonSuppOrderedGroups = groupOrder
  .filter((key) =>
    key !== (language === "en" ? "SUPPLEMENTARY" : "EK URUNLER") &&
    key !== (language === "en" ? "ACCESSORIES" : "EK AKSESUARLAR") &&
    groupedData[key]
  )
  .concat(
    Object.keys(groupedData).filter((key) =>
      key !== (language === "en" ? "SUPPLEMENTARY" : "EK URUNLER") &&
      key !== (language === "en" ? "ACCESSORIES" : "EK AKSESUARLAR") &&
      !groupOrder.includes(key)
    )
  );


  // Grup isimleri (dil parametresine g√∂re)
  const mainConceptKey = language === "en" ? "MAIN CONCEPT" : "ANA KONSEPT";
  const additionalItemsKey = language === "en" ? "ADDITIONAL ITEMS" : "TAMAMLAYICI URUNLER";
  const additionalItemsAksKey = language === "en" ? "ADDITIONAL ACCESSORIES" : "TAMAMLAYICI AKSESUARLAR";
  const accessoriesKey = language === "en" ? "ACCESSORIES" : "EK AKSESUARLAR";
  const supplementaryKey = language === "en" ? "SUPPLEMENTARY" : "EK URUNLER";

  let tableRows = [];
  let mainConceptTotals = { qty: 0, amount: 0 };
  let additionalTotals = { qty: 0, amount: 0 };
  let additionalAksTotals = { qty: 0, amount: 0 };

  // Ana gruplar i√ßin tablo satƒ±rlarƒ±nƒ± olu≈üturuyoruz (EK URUNLER hari√ß)
  nonSuppOrderedGroups.forEach((groupKey, idx) => {
    let groupItems = groupedData[groupKey];

    // Kategori toplamlarƒ±nƒ± hesaplayalƒ±m
    const categoryTotals = {};
    groupItems.forEach(item => {
      const cat = item.BASAMAK4 || "";
      const price = item.PRICE || 0;
      const discountRate = 0;
      const discountedPrice = price * (1 - discountRate / 100);
      const amount = discountedPrice * Number(item.QUANTITY);
      if (!categoryTotals[cat]) categoryTotals[cat] = 0;
      categoryTotals[cat] += amount;
    });

    // Grup i√ßindeki √ºr√ºnleri √∂nce kategori toplamƒ±, sonra √ºr√ºn tutarƒ±na g√∂re azalan sƒ±ralƒ±yoruz
    groupItems.sort((a, b) => {
      const catA = a.BASAMAK4 || "";
      const catB = b.BASAMAK4 || "";
      const totalA = categoryTotals[catA] || 0;
      const totalB = categoryTotals[catB] || 0;
      if (totalB !== totalA) return totalB - totalA;
      const priceA = a.CUSTOM_CODE ? (a.CUSTOM_PRICE || 0) : (a.PRICE || 0);
      const discountRateA = 0;
      const amountA = priceA * (1 - discountRateA / 100) * Number(a.QUANTITY);
      const priceB = b.CUSTOM_CODE ? (b.CUSTOM_PRICE || 0) : (b.PRICE || 0);
      const discountRateB = b.CUSTOM_CODE ? (b.CUSTOM_DISCOUNT_RATE || 0) : (b.DISCOUNT_RATE || 0);
      const amountB = priceB * (1 - discountRateB / 100) * Number(b.QUANTITY);
      return amountB - amountA;
    });

    // Grup ba≈ülƒ±ƒüƒ±
    tableRows.push([
      {
        content: groupKey,
        colSpan: 10,
        styles: {
          halign: "left",
          fillColor: [230, 230, 230],
          fontStyle: "bold",
          overflow: "linebreak",
        },
      },
    ]);
    // S√ºtun ba≈ülƒ±klarƒ±
    tableRows.push(headersTableArr);
    
    let rowNum = 0;
    let groupTotals = { qty: 0, amount: 0 };
    groupItems.forEach((item) => {
      rowNum++;
      const productCode = item.CUSTOM_CODE
        ? `${item.CUSTOM_CODE}\nReferans Kod: ${item.PRODUCT_ID}`
        : item.PRODUCT_ID;
      const category = replaceTurkishChars(item.BASAMAK4 || "");
      const model = replaceTurkishChars(item.MODEL || "");
      const sizeCm = replaceTurkishChars(item.EBAT || "");
      const sizeInch = replaceTurkishChars(item.EBATINCH || "");
      const price = item.PRICE || 0;
      const quantity = Number(item.QUANTITY);
      const discountRate = 0;
      const discountedPrice = price * (1 - discountRate / 100);
      const amount = discountedPrice * quantity;
	  const currencyuse = window.selectedCurrency;
      groupTotals.qty += quantity;
      groupTotals.amount += amount;
      tableRows.push([
        rowNum.toString(),
        productCode,
        category,
        model,
        sizeCm,
        sizeInch,
        formatNumber(price),
        quantity.toString(),
        formatNumber(amount),
        currencyuse || "TRY",
      ]);
    });

    // Grup alt toplam satƒ±rƒ±
    tableRows.push([
      {
        content:
          language === "en"
            ? `Sub Total (${groupKey})`
            : `Alt Toplam (${groupKey})`,
        colSpan: 7,
        styles: {
          fontStyle: "bold",
          fillColor: [230, 230, 230],
          overflow: "linebreak",
        },
      },
      { content: groupTotals.qty.toString(), styles: { fillColor: [230, 230, 230] } },
      { content: formatNumber(groupTotals.amount), styles: { fillColor: [230, 230, 230] } },
      { content: window.selectedCurrency || "TRY", styles: { fillColor: [230, 230, 230] } },
    ]);

    if (groupKey === mainConceptKey) {
      mainConceptTotals = groupTotals;
    } else if (groupKey === additionalItemsKey) {
      additionalTotals = groupTotals;
      const nextGroup = nonSuppOrderedGroups[idx + 1];
      if (nextGroup && nextGroup === accessoriesKey || supplementaryKey) {
        const combinedQty = mainConceptTotals.qty + additionalTotals.qty;
        const combinedAmount = mainConceptTotals.amount + additionalTotals.amount;
        tableRows.push([
          {
            content:
              language === "en"
                ? `Sub Total (MAIN CONCEPT + ADDITIONAL ITEMS)`
                : `Alt Toplam (ANA KONSEPT + TAMAMLAYICI URUNLER)`,
            colSpan: 7,
            styles: { fontStyle: "bold", fillColor: [207, 207, 207], overflow: "linebreak" },
          },
          { content: combinedQty.toString(), styles: { fillColor: [207, 207, 207] } },
          { content: formatNumber(combinedAmount), styles: { fillColor: [207, 207, 207] } },
          { content: window.selectedCurrency || "TRY", styles: { fillColor: [207, 207, 207] } },
        ]);
      }
    } else if (groupKey === additionalItemsAksKey) {
	  additionalAksTotals = groupTotals;
	  const combinedQty = mainConceptTotals.qty + additionalTotals.qty + additionalAksTotals.qty;
	  const combinedAmount = mainConceptTotals.amount + additionalTotals.amount + additionalAksTotals.amount;
	  tableRows.push([
		{
		  content:
			language === "en"
			  ? `Sub Total (MAIN CONCEPT + ADDITIONAL ITEMS + ADDITIONAL ACCESSORIES)`
			  : `Alt Toplam (ANA KONSEPT + TAMAMLAYICI URUNLER + TAMAMLAYICI AKSESUARLAR)`,
		  colSpan: 7,
		  styles: { fontStyle: "bold", fillColor: [207, 207, 207], overflow: "linebreak" },
		},
		{ content: combinedQty.toString(), styles: { fillColor: [207, 207, 207] } },
		{ content: formatNumber(combinedAmount), styles: { fillColor: [207, 207, 207] } },
		{ content: currencyMapping[cartInfo.PRICE_TYPE] || "TRY", styles: { fillColor: [207, 207, 207] } },
	  ]);
	}

    if (groupKey !== accessoriesKey) {
      tableRows.push(
        Array.from({ length: 10 }, () => ({
          content: "",
          styles: { fillColor: [255, 255, 255] },
        }))
      );
    }
  });

  // Ana tablo AutoTable
  doc.autoTable({
    head: false,
    body: tableRows,
    foot: [
      [{
          content:
            language === "en"
              ? `Total `
              : `Toplam `,
          colSpan: 7,
          styles: { fontStyle: "bold", fillColor: [207, 207, 207], overflow: "linebreak" },
        },
        { content: totalQuantity.toString(), styles: { halign: "right" } },
        { content: formatNumber(totalAmount), styles: { halign: "right" } },
        { content: window.selectedCurrency || "TRY", styles: { halign: "center" } },
      ],
    ],
    footStyles: {
      fillColor: [207, 207, 207],
      fontStyle: "bold",
      textColor: [0, 0, 0],
    },
    showFoot: "lastpage", // global toplam none ile gizlenir. lastpage ile son sayfada g√∂sterilir.
    startY: margin + 20,
    margin: { left: margin, right: margin },
    theme: "striped",
    styles: {
      cellPadding: 2,
      fontSize: 8,
      overflow: "ellipsize",
      valign: "middle",
      halign: "left",
      minCellHeight: 6,
    },
    headStyles: {
      fillColor: [220, 220, 220],
      fontSize: 8,
      fontStyle: "bold",
      textColor: [102, 102, 102],
      minCellHeight: 6,
    },
    columnStyles: {
      0: { cellWidth: 10, halign: "center" },
      1: { cellWidth: 30, halign: "left" },
      2: { cellWidth: 50, halign: "left" },
      3: { cellWidth: 40, halign: "left" },
      4: { cellWidth: 30, halign: "left" },
      5: { cellWidth: 30, halign: "left" },
      6: { cellWidth: 25, halign: "right" },
      7: { cellWidth: 25, halign: "right" },
      8: { cellWidth: 25, halign: "right" },
      9: { cellWidth: 20, halign: "center" },
    },
    didDrawPage: (data) => {
      if (data.pageNumber > 1) {
        doc.autoTable.previous.finalY = margin + 10;
      }
    },
  });
  
  // ---------------- EK URUNLER Grubunu Aynƒ± Sayfada, Bo≈ü Bir Satƒ±r Sonrasƒ± Ekle ----------------
  if (groupedData[supplementaryKey] && groupedData[supplementaryKey].length > 0) {
    // Yeni sayfa eklemiyoruz; mevcut sayfadaki autotable'ƒ±n finalY'sinden 6 mm a≈üaƒüƒ±dan ba≈ülƒ±yoruz.
    const startYSupp = doc.lastAutoTable.finalY + 6;
    let suppItems = groupedData[supplementaryKey];

    // Kategori toplamlarƒ±nƒ± hesaplayalƒ±m
    const suppCategoryTotals = {};
    suppItems.forEach(item => {
      const cat = item.BASAMAK4 || "";
      const price = item.CUSTOM_CODE ? (item.CUSTOM_PRICE || 0) : (item.PRICE || 0);
      const discountRate = item.CUSTOM_CODE ? (item.CUSTOM_DISCOUNT_RATE || 0) : (item.DISCOUNT_RATE || 0);
      const discountedPrice = price * (1 - discountRate / 100);
      const amount = discountedPrice * Number(item.QUANTITY);
      if (!suppCategoryTotals[cat]) suppCategoryTotals[cat] = 0;
      suppCategoryTotals[cat] += amount;
    });

    // EK URUNLER grubunu sƒ±ralƒ±yoruz (√∂nce kategori toplamƒ±, sonra √ºr√ºn tutarƒ± azalan)
    suppItems.sort((a, b) => {
      const catA = a.BASAMAK4 || "";
      const catB = b.BASAMAK4 || "";
      const totalA = suppCategoryTotals[catA] || 0;
      const totalB = suppCategoryTotals[catB] || 0;
      if (totalB !== totalA) return totalB - totalA;
      const priceA = a.CUSTOM_CODE ? (a.CUSTOM_PRICE || 0) : (a.PRICE || 0);
      const discountRateA = a.CUSTOM_CODE ? (a.CUSTOM_DISCOUNT_RATE || 0) : (a.DISCOUNT_RATE || 0);
      const amountA = priceA * (1 - discountRateA / 100) * Number(a.QUANTITY);
      const priceB = b.CUSTOM_CODE ? (b.CUSTOM_PRICE || 0) : (b.PRICE || 0);
      const discountRateB = b.CUSTOM_CODE ? (b.CUSTOM_DISCOUNT_RATE || 0) : (b.DISCOUNT_RATE || 0);
      const amountB = priceB * (1 - discountRateB / 100) * Number(b.QUANTITY);
      return amountB - amountA;
    });

    // EK URUNLER i√ßin tablo satƒ±rlarƒ±nƒ± olu≈üturalƒ±m
    let suppTableRows = [];
    suppTableRows.push([
      {
        content: supplementaryKey,
        colSpan: 10,
        styles: {
          halign: "left",
          fillColor: [230, 230, 230],
          fontStyle: "bold",
          overflow: "linebreak",
        },
      },
    ]);
    suppTableRows.push(headersTableArr);
    let rowNum = 0;
    let suppTotals = { qty: 0, amount: 0 };
    suppItems.forEach((item) => {
      rowNum++;
      const productCode = item.CUSTOM_CODE
        ? `${item.CUSTOM_CODE}\nReferans Kod: ${item.PRODUCT_ID}`
        : item.PRODUCT_ID;
      const category = replaceTurkishChars(item.BASAMAK4 || "");
      const model = replaceTurkishChars(item.MODEL || "");
      const sizeCm = replaceTurkishChars(item.EBAT || "");
      const sizeInch = replaceTurkishChars(item.EBATINCH || "");
      const price = item.CUSTOM_CODE ? (item.CUSTOM_PRICE || 0) : (item.PRICE || 0);
      const quantity = Number(item.QUANTITY);
      const discountRate = item.CUSTOM_CODE ? (item.CUSTOM_DISCOUNT_RATE || 0) : (item.DISCOUNT_RATE || 0);
      const discountedPrice = price * (1 - discountRate / 100);
      const amount = discountedPrice * quantity;
	  const currencyuse = window.selectedCurrency;
      suppTotals.qty += quantity;
      suppTotals.amount += amount;
      suppTableRows.push([
        rowNum.toString(),
        productCode,
        replaceTurkishChars(item.BASAMAK4 || ""),
        replaceTurkishChars(item.MODEL || ""),
        replaceTurkishChars(item.EBAT || ""),
        replaceTurkishChars(item.EBATINCH || ""),
        formatNumber(price),
        quantity.toString(),
        formatNumber(amount),
        currencyuse || "TRY",
      ]);
    });
    suppTableRows.push([
      {
        content:
          language === "en"
            ? `Sub Total (${supplementaryKey})`
            : `Alt Toplam (${supplementaryKey})`,
        colSpan: 7,
        styles: {
          fontStyle: "bold",
          fillColor: [230, 230, 230],
          overflow: "linebreak",
        },
      },
      { content: suppTotals.qty.toString(), styles: { fillColor: [230, 230, 230] } },
      { content: formatNumber(suppTotals.amount), styles: { fillColor: [230, 230, 230] } },
      { content: window.selectedCurrency || "TRY", styles: { fillColor: [230, 230, 230] } },
    ]);

    doc.autoTable({
      head: false,
      body: suppTableRows,
      startY: startYSupp,
      margin: { left: margin, right: margin },
      theme: "striped",
      styles: {
        cellPadding: 2,
        fontSize: 8,
        overflow: "ellipsize",
        valign: "middle",
        halign: "left",
        minCellHeight: 6,
      },
      headStyles: {
        fillColor: [220, 220, 220],
        fontSize: 8,
        fontStyle: "bold",
        textColor: [102, 102, 102],
        minCellHeight: 6,
      },
      columnStyles: {
        0: { cellWidth: 10, halign: "center" },
        1: { cellWidth: 30, halign: "left" },
        2: { cellWidth: 50, halign: "left" },
        3: { cellWidth: 40, halign: "left" },
        4: { cellWidth: 30, halign: "left" },
        5: { cellWidth: 30, halign: "left" },
        6: { cellWidth: 25, halign: "right" },
        7: { cellWidth: 25, halign: "right" },
        8: { cellWidth: 25, halign: "right" },
        9: { cellWidth: 20, halign: "center" },
      },
      didDrawPage: (data) => {
        if (data.pageNumber > 1) {
          doc.autoTable.previous.finalY = margin + 10;
        }
      },
    });
  }
  
  await addFooter();

  const fileName =
    language === "tr"
      ? `KONSEPT-Formu - ${cartInfo.CUSTOMER_NAME || "N/A"}.pdf`
      : `CONCEPT-Form - ${cartInfo.CUSTOMER_NAME || "N/A"}.pdf`;
  doc.save(fileName);
};


// Basamak2 ve Basamak4 dropdownlarƒ±nƒ± y√ºkleme √∂rneƒüi
async function loadBarcodeBasamakOptions() {
  const basamak2Select = document.getElementById("barcodeBasamak2");
  const basamak4Select = document.getElementById("barcodeBasamak4");
  const KodSelect = document.getElementById("barcodeKod");
  try {
    // Filter-options endpoint'inden t√ºm filtre verileri alƒ±nƒ±r
    const response = await fetch("http://192.168.30.4:3000/filter-options");
    if (!response.ok) throw new Error("Filter options alƒ±namadƒ±.");
    const filters = await response.json();
    
    // BASAMAK2 i√ßin benzersiz deƒüerleri √ßƒ±karalƒ±m
    const basamak2Set = new Set();
    filters.forEach(item => {
      if (item.BASAMAK2) {
        basamak2Set.add(item.BASAMAK2);
      }
    });
    
    let optionsHtml = `<option value="">Se√ßiniz</option>`;
    basamak2Set.forEach(val => {
      optionsHtml += `<option value="${val}">${val}</option>`;
    });
    basamak2Select.innerHTML = optionsHtml;
    $(basamak2Select).selectpicker("refresh");

    // Basamak2 deƒüi≈ütiƒüinde, ilgili BASAMAK4 deƒüerlerini filtreleyelim
    basamak2Select.addEventListener("change", function() {
      const selectedBasamak2 = this.value;
      const basamak4Set = new Set();
      filters.forEach(item => {
        if (item.BASAMAK2 === selectedBasamak2 && item.BASAMAK4) {
          basamak4Set.add(item.BASAMAK4);
        }
      });
      let options4 = `<option value="">Se√ßiniz</option>`;
      basamak4Set.forEach(val => {
        options4 += `<option value="${val}">${val}</option>`;
      });
      basamak4Select.innerHTML = options4;
      $(basamak4Select).selectpicker("refresh");
    });
    
    // Ba≈ülangƒ±√ßta BASAMAK4 bo≈ü
    basamak4Select.innerHTML = `<option value="">Se√ßiniz</option>`;
    $(basamak4Select).selectpicker("refresh");
	
	// KOD i√ßin benzersiz deƒüerleri √ßƒ±karalƒ±m
    const KodSet = new Set();
    filters.forEach(item => {
      if (item.KOD) {
        KodSet.add(item.KOD);
      }
    });
    
    let optionsKod = `<option value="">Se√ßiniz</option>`;
    KodSet.forEach(val => {
      optionsKod += `<option value="${val}">${val}</option>`;
    });
    KodSelect.innerHTML = optionsKod;
    $(KodSelect).selectpicker("refresh");
  } catch (err) {
    console.error(err);
  }
}


// √úr√ºnleri getirme ve barkod etiketlerini olu≈üturma
async function loadBarcodeProducts() {
  const basamak2 = document.getElementById("barcodeBasamak2").value;
  const basamak4 = document.getElementById("barcodeBasamak4").value;
  const Kod = document.getElementById("barcodeKod").value;
  const stoklu = document.getElementById("filterStoklu").checked;
  const priceOption = document.querySelector('input[name="priceOption"]:checked').value; // "with" veya "without"
  const labelType = document.querySelector('input[name="labelType"]:checked').value; // "large" veya "small"

  let query = `?`;
  if (basamak2) query += `basamak2=${basamak2}&`;
  if (basamak4) query += `basamak4=${basamak4}&`;
  if (Kod) query += `kod=${Kod}&`;
  if (stoklu) query += `stoklu=true&`;

  try {
    const response = await fetch(`http://192.168.30.4:3000/api/skart-ozellik${query}`);
    
	if (!response.ok) throw new Error("√úr√ºnler alƒ±namadƒ±.");
    const result = await response.json();
	
    if (!result.success) throw new Error(result.message);
    const products = result.data;
    renderBarcodeLabels(products, priceOption, labelType);
  } catch (err) {
    alert(err.message);
  }
}

function renderBarcodeLabels(products, priceOption, labelType) {
  // √úr√ºn ve konsept konteynerlerini temizleyip, gizleyelim:
  document.getElementById('product-container').innerHTML = "";
  const conceptContainer = document.getElementById('concept-products-container');
  if (conceptContainer && conceptContainer.style.display !== "none") {
    conceptContainer.style.display = "none";
  }
  const initialImageContainer = document.getElementById("initialImageContainer");
  if (initialImageContainer) initialImageContainer.style.display = "none";
  
  const container = document.getElementById("barcodeLabelsContainer");
  container.innerHTML = "";
  
  products.forEach(prod => {
    const stock = prod.HM || 1; // Stok sayƒ±sƒ±
    // Null deƒüerleri bo≈ü string ile deƒüi≈ütirelim:
    const barkod = prod.BARKOD ? prod.BARKOD.toString() : "";
    const kod = prod.KOD || "";
    const model = prod.MODEL || "";
    const ebat = prod.EBAT || "";
    const renk = prod.RENK || "";
    const desen = prod.DESEN || "";
    const lamine = prod.LAMINE || "";
    const fiyat = prod.SFIYAT1; // TL fiyatƒ±
    
    for (let i = 0; i < stock; i++) {
      let labelDiv = document.createElement("div");
      labelDiv.classList.add("barcode-label");
      labelDiv.style.boxSizing = "border-box";
      labelDiv.style.fontFamily = "Arial, sans-serif";
      labelDiv.style.textAlign = "center";
      labelDiv.style.position = "relative";
      labelDiv.style.margin = "2mm"; // ekran g√∂r√ºn√ºm√º i√ßin
      labelDiv.style.pageBreakAfter = "always";
      labelDiv.style.pageBreakInside = "avoid";
      
      if (labelType === "large") {
        // B√ºy√ºk etiket: 78mm geni≈ülik, 27mm y√ºkseklik
        labelDiv.style.width = "78mm";
        labelDiv.style.height = "26mm";
        labelDiv.style.border = "1px solid #000";
        labelDiv.style.padding = "1mm";
  
        // Barkod SVG: geni≈ülik %117, y√ºkseklik 9.6mm
        let svg = document.createElementNS("http://www.w3.org/2000/svg", "svg");
        svg.id = `barcode-${kod}-${i}`;
        svg.style.display = "block";
        svg.style.margin = "0 auto";
        svg.style.width = "117%";
        svg.style.height = "9.6mm";
        labelDiv.appendChild(svg);
  
        // "KOD - Fƒ∞YAT" satƒ±rƒ± (font 10px)
        let kodFiyatDiv = document.createElement("div");
        kodFiyatDiv.style.fontSize = "10px";
        kodFiyatDiv.style.marginTop = "1mm";
        let fiyatText = "";
        if (priceOption === "with" && fiyat != null) {
          fiyatText = new Intl.NumberFormat('tr-TR', { 
            style: 'currency', 
            currency: 'TRY', 
            minimumFractionDigits: 0 
          }).format(fiyat);
        }
        kodFiyatDiv.innerText = kod + (fiyatText ? " - " + fiyatText : "");
        labelDiv.appendChild(kodFiyatDiv);
  
        // "Model:" satƒ±rƒ±: Sol hizalƒ±, Model ve Ebat bilgileri
        let modelEbatDiv = document.createElement("div");
        modelEbatDiv.style.fontSize = "10px";
        modelEbatDiv.style.marginTop = "1mm";
        modelEbatDiv.style.textAlign = "left";
        let modelEbatText = "";
        if (model) modelEbatText += "Model: " + model;
        if (model && ebat) modelEbatText += "     " + "Ebat: " + ebat; // ilave 5 bo≈üluk bƒ±rakƒ±ldƒ±
        modelEbatDiv.innerText = modelEbatText;
        labelDiv.appendChild(modelEbatDiv);
  
        // "Renk/Desen/Lamine:" satƒ±rƒ±: Sol hizalƒ±, bo≈ü alanlar √ßƒ±karƒ±larak
        let renkDiv = document.createElement("div");
        renkDiv.style.fontSize = "10px";
        renkDiv.style.marginTop = "1mm";
        renkDiv.style.textAlign = "left";
        let renkText = "";
        if (renk) renkText += renk;
        if (renk && desen) {
          renkText += " - " + desen;
        } else if (desen) {
          renkText += desen;
        }
        if ((renk || desen) && lamine) {
          renkText += " - " + lamine;
        } else if (lamine) {
          renkText += lamine;
        }
        // Birden fazla tireyi tek tireye indirgemek ve ba≈ütaki/sondaki tireyi kaldƒ±rmak:
        renkText = renkText.split('-')
                   .map(s => s.trim())
                   .filter(s => s !== "")
                   .join(" - ");
        if (renkText) {
          renkText = "Renk/Desen/Lamine: " + renkText;
        }
        renkDiv.innerText = renkText;
        labelDiv.appendChild(renkDiv);
  
        // Saƒü alt k√∂≈üede "03/25" (font 8px)
        let footerDiv = document.createElement("div");
        footerDiv.innerText = "03/25";
        footerDiv.style.fontSize = "8px";
        footerDiv.style.position = "absolute";
        footerDiv.style.bottom = "1mm";
        footerDiv.style.right = "1mm";
        labelDiv.appendChild(footerDiv);
  
        container.appendChild(labelDiv);
  
        // Barkodu olu≈ütur: JsBarcode kullanƒ±larak
        if (typeof JsBarcode !== "undefined") {
          JsBarcode(`#barcode-${kod}-${i}`, barkod, {
            format: "CODE128",
            displayValue: false,
            height: 9.6 * 3.78, // yakla≈üƒ±k 36px
            margin: 0,
            width: 1
          });
        }
      } else {
        // K√º√ß√ºk etiket: 40mm geni≈ülik, 18mm y√ºkseklik
        labelDiv.style.width = "40mm";
        labelDiv.style.height = "18mm";
        labelDiv.style.border = "1px solid #000";
        labelDiv.style.padding = "1mm";
        labelDiv.style.position = "relative";
  
        // Sol alt k√∂≈üeye logo ekleyelim: /resim/ED.png, geni≈üliƒüi 4mm
        let logoSmall = document.createElement("img");
        logoSmall.src = "/resim/ED.png";
        logoSmall.alt = "ED";
        logoSmall.style.width = "4mm";
        logoSmall.style.height = "auto";
        logoSmall.style.position = "absolute";
        logoSmall.style.bottom = "1mm";
        logoSmall.style.left = "1mm";
        labelDiv.appendChild(logoSmall);
  
        // Barkod SVG
        let svgSmall = document.createElementNS("http://www.w3.org/2000/svg", "svg");
        svgSmall.id = `barcode-small-${kod}-${i}`;
        svgSmall.style.display = "block";
        svgSmall.style.margin = "0 auto";
        svgSmall.style.width = "90%";
        svgSmall.style.height = "8mm";
        labelDiv.appendChild(svgSmall);
  
        // √úst satƒ±r: KOD (b√ºy√ºk font, sol hizalƒ±)
        let kodDivSmall = document.createElement("div");
        kodDivSmall.style.fontSize = "9px";
        kodDivSmall.style.marginTop = "1mm";
        kodDivSmall.style.textAlign = "center";
        kodDivSmall.style.fontWeight = "bold";
        kodDivSmall.innerText = kod;
        labelDiv.appendChild(kodDivSmall);
  
        // Alt satƒ±r: Fiyat (b√ºy√ºk font, sol hizalƒ±); fiyat se√ßeneƒüine g√∂re
        let fiyatDivSmall = document.createElement("div");
        fiyatDivSmall.style.fontSize = "9px";
        fiyatDivSmall.style.marginTop = "1mm";
        fiyatDivSmall.style.textAlign = "center";
        let fiyatTextSmall = "";
        if (priceOption === "with" && fiyat != null) {
          fiyatTextSmall = new Intl.NumberFormat('tr-TR', { 
            style: 'currency', 
            currency: 'TRY', 
            minimumFractionDigits: 0 
          }).format(fiyat);
        }
        fiyatDivSmall.innerText = fiyatTextSmall;
        labelDiv.appendChild(fiyatDivSmall);
  
        // Saƒü alt k√∂≈üede "03/25" (font 8px)
        let footerDivSmall = document.createElement("div");
        footerDivSmall.innerText = "03/25";
        footerDivSmall.style.fontSize = "8px";
        footerDivSmall.style.position = "absolute";
        footerDivSmall.style.bottom = "1mm";
        footerDivSmall.style.right = "1mm";
        labelDiv.appendChild(footerDivSmall);
  
        container.appendChild(labelDiv);
  
        if (typeof JsBarcode !== "undefined") {
          JsBarcode(`#barcode-small-${kod}-${i}`, barkod, {
            format: "CODE128",
            displayValue: false,
            height: 8 * 3.78, // yakla≈üƒ±k 30px
            margin: 0,
            width: 1
          });
        }
      }
    }
  });
}


//Barkod Yazdƒ±rma fonksiyonu
function printBarcodes() {
  const container = document.getElementById("barcodeLabelsContainer");
  if (!container) {
    alert("Barkod etiketleri bulunamadƒ±.");
    return;
  }
  const printContents = container.innerHTML;
  if (!printContents.trim()) {
    alert("Barkod etiketleri hen√ºz olu≈üturulmamƒ±≈ü.");
    return;
  }
  
  // Yeni bir pencere a√ßƒ±p yazdƒ±rma i√ßeriƒüini ekleyelim
  const printWindow = window.open("", "", "height=600,width=800");
  printWindow.document.write("<html><head><title>Barkod Etiketleri</title>");
  printWindow.document.write("<style>");
  // Yazdƒ±rma modunda t√ºm kenar bo≈üluklarƒ±nƒ± sƒ±fƒ±r yapacak CSS kurallarƒ±:
  printWindow.document.write("@page { margin: 0; }");
  printWindow.document.write("body { margin: 0; padding: 0; }");
  printWindow.document.write(".barcode-label { page-break-after: always; page-break-inside: avoid; border: none !important; }");
  printWindow.document.write("</style>");
  printWindow.document.write("</head><body>");
  printWindow.document.write(printContents);
  printWindow.document.write("</body></html>");
  printWindow.document.close();
  printWindow.focus();
  printWindow.print();
  // Not: Pencere otomatik kapatƒ±lmaz; b√∂ylece kullanƒ±cƒ± se√ßenekleri g√∂rebilir.
}

//Konsept Etiketleri i√ßin dropdown doldurma fonksiyonu
async function loadConceptLabelOptions() {
  try {
    const response = await fetch('http://192.168.30.4:3000/concept-label-options');
    if (!response.ok) {
      throw new Error('Konsept etiket se√ßenekleri alƒ±namadƒ±.');
    }
    const data = await response.json();

    // Verileri, √∂nce CONCEPT_AREA, sonra CUSTOMER_NAME'ye g√∂re sƒ±ralƒ±yoruz.
    data.sort((a, b) => {
      const areaCompare = a.CONCEPT_AREA.localeCompare(b.CONCEPT_AREA, 'tr', { sensitivity: 'base' });
      if (areaCompare !== 0) return areaCompare;
      return a.CUSTOMER_NAME.localeCompare(b.CUSTOMER_NAME, 'tr', { sensitivity: 'base' });
    });

    const dropdown = document.getElementById('conceptLabelDropdown');
    dropdown.innerHTML = '<option value="">Se√ßiniz</option>';
    data.forEach(item => {
      const option = document.createElement('option');
      option.value = item.ID; // CART.ID saklanƒ±r
      option.textContent = `${item.CUSTOMER_NAME} // ${item.CONCEPT_AREA}`;
      dropdown.appendChild(option);
    });

    // Eƒüer Bootstrap Select kullanƒ±yorsanƒ±z, selectpicker'ƒ± yenileyin:
    if (window.jQuery && $(dropdown).selectpicker) {
      $(dropdown).selectpicker('refresh');
    }
  } catch (error) {
    console.error('Konsept etiket se√ßenekleri y√ºklenirken hata:', error);
  }
}

//showfiltercontainer
function showfiltercontainer (){
  // Barkod konteynerini gizle
  document.getElementById("barcodeContainer").style.display = "none";
  document.getElementById("conceptLabelContainer").style.display = "none";
  const initialImageContainer = document.getElementById("initialImageContainer");
  if (initialImageContainer) initialImageContainer.style.display = "none";
  // Diƒüer konteynerleri g√∂ster
  document.getElementById("product-container").style.display = "block"; 
}

// G√∂ster butonuna tƒ±klandƒ±ƒüƒ±nda ilgili konteyneri a√ßan fonksiyon
function showBarcodeContainer() {
  // Diƒüer konteynerleri gizle
  const productContainer = document.getElementById("product-container");
    if (productContainer) productContainer.style.display = "none";
    const initialImageContainer = document.getElementById("initialImageContainer");
    if (initialImageContainer) initialImageContainer.style.display = "none";
    const conceptContainer = document.getElementById("concept-products-container");
    if (conceptContainer) {
      conceptContainer.style.display = "none";
      
    }
  // Barkod konteynerini g√∂ster
  document.getElementById("barcodeContainer").style.display = "block";
  // Basamak dropdownlarƒ±nƒ± y√ºkleyelim
  loadBarcodeBasamakOptions();
}

// Konsept Etiket Men√º √ñƒüesi ile konteyneri a√ßan fonksiyon
function showconceptLabelContainer() {
  // Diƒüer konteynerleri gizle
  const productContainer = document.getElementById("product-container");
    if (productContainer) productContainer.style.display = "none";
    const initialImageContainer = document.getElementById("initialImageContainer");
    if (initialImageContainer) initialImageContainer.style.display = "none";
    const conceptContainer = document.getElementById("concept-products-container");
    if (conceptContainer) {
      conceptContainer.style.display = "none";
      
    }
  // Barkod konteynerini g√∂ster
  document.getElementById("conceptLabelContainer").style.display = "block";
  // Basamak dropdownlarƒ±nƒ± y√ºkleyelim
  loadConceptLabelOptions();
}

// Konsept Etiket konteyneri dil √∂ƒüesi se√ßimi olay dinleyicileri
document.getElementById("turkceEtiket").addEventListener("change", function() {
  if (this.checked) {
    document.getElementById("ingilizceEtiket").checked = false;
  }
});

document.getElementById("ingilizceEtiket").addEventListener("change", function() {
  if (this.checked) {
    document.getElementById("turkceEtiket").checked = false;
  }
});
         
// Global saya√ß: etiketlere sƒ±ra numarasƒ± vermek i√ßin
let labelIndexCounter = 1;

// Yakla≈üƒ±k 148 mm y√ºksekliƒüe denk gelen e≈üik (148 mm ‚âà 148 * 3.78 ‚âà 560px)
const THRESHOLD_PX = 560; 

// Belirtilen verilerle (conceptNameDisplay, formattedDate) sabit ebatlƒ± etiket (label) olu≈üturur.
// Artƒ±k labelPosition parametresi kullanƒ±lmƒ±yor; her etiket olu≈üturulduƒüunda
// data-label-index atanƒ±yor.
function createLabel(conceptNameDisplay, formattedDate) {
  const label = document.createElement("div");
  label.className = "print-label";
  label.style.width = "168mm";
  label.style.height = "148mm";
  label.style.boxSizing = "border-box";
  label.style.border = "1px solid #000";
  label.style.padding = "5mm";
  label.style.position = "relative";
  // Gizli sƒ±ra numarasƒ± ata ve saya√ß artƒ±r
  label.setAttribute("data-label-index", labelIndexCounter);
  labelIndexCounter++;

  // Header: logo, konsept adƒ±, tarih
  const header = document.createElement("div");
  header.className = "print-header";
  header.innerHTML = `
    <div style="display: flex; justify-content: space-between; align-items: center;">
      <img src="/resim/EDLogo2.jpg" style="width: 6cm;">
      <div style="display: flex; flex-direction: column; align-items: flex-end;">
        <div style="font-size: 16px;">${conceptNameDisplay}</div>
        <div style="font-size: 10px;">${formattedDate}</div>
      </div>
    </div>`;
  label.appendChild(header);
  
  // ƒ∞√ßerik alanƒ±: Header'dan sonra gelecek
  const content = document.createElement("div");
  content.className = "label-content";
  // Header i√ßin yakla≈üƒ±k 15mm bo≈üluk bƒ±rakƒ±yoruz
  content.style.marginTop = "15mm";
  label.appendChild(content);
  
  return { label, content };
}
 
// Yeni A4 sayfasƒ± olu≈üturur. Her A4 sayfasƒ± 2 etiket (ilk ve ikinci) barƒ±ndƒ±rƒ±r.
function createNewA4Page(conceptNameDisplay, formattedDate) {
  const page = document.createElement("div");
  page.className = "a4-page";
  // A4 √∂l√ß√ºs√º: 210mm x 297mm (kenar bo≈üluklarƒ± sƒ±fƒ±r kabul ediliyor)
  page.style.width = "210mm";
  page.style.height = "297mm";
  page.style.margin = "0 auto";
  // Etiketleri dikey sƒ±ralamak i√ßin flex kullanƒ±yoruz
  page.style.display = "flex";
  page.style.flexDirection = "column";
  
  // √úst etiket (ilk etiket)
  const topLabelObj = createLabel(conceptNameDisplay, formattedDate);
  // Alt etiket (ikinci etiket; d√∂nd√ºrme daha sonra applyRotation ile yapƒ±lacak)
  const bottomLabelObj = createLabel(conceptNameDisplay, formattedDate);
  
  page.appendChild(topLabelObj.label);
  page.appendChild(bottomLabelObj.label);
  
  return { page, topLabel: topLabelObj.content, bottomLabel: bottomLabelObj.content };
}
 
// T√ºm etiketler olu≈üturulduktan sonra, data-label-index deƒüeri √ßift olanlarƒ± (2,4,6,...) 180¬∞ d√∂nd√ºr√ºr.
function applyRotation() {
  const labels = document.querySelectorAll(".print-label");
  labels.forEach(label => {
    const idx = parseInt(label.getAttribute("data-label-index"), 10);
    if (idx % 2 === 0) {
      label.style.transform = "rotate(180deg)";
    } else {
      label.style.transform = "none";
    }
  });
}
 
// Dinamik olarak etiketleri olu≈üturan ana fonksiyon
async function loadConceptLabelPrint() {
  try {
    // ‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî
    // 1) Saya√ß ve se√ßimleri al
    labelIndexCounter = 1; // global saya√ß sƒ±fƒ±rlansƒ±n

    const cartId = document.getElementById('conceptLabelDropdown').value;
    if (!cartId) {
      alert("L√ºtfen bir konsept etiketi se√ßiniz.");
      return;
    }

    const lang = document.getElementById('turkceEtiket').checked ? 'tr' : 'en';
    const type = document.getElementById('conceptTypeFilter').value; // 'ANA' veya 'EK'

    // ‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî
    // 2) API‚Äôden t√ºm gruplarƒ± √ßek
    const resp = await fetch(`/api/print-concept-label?cartId=${cartId}&lang=${lang}`);
    if (!resp.ok) throw new Error("Etiket bilgileri alƒ±namadƒ±.");
    const groups = await resp.json();

    // ‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî
    // 3) Client‚Äëside filtre: Ana vs Ek
    const anaSet = new Set([
      'ANA KONSEPT',
      'TAMAMLAYICI URUNLER',
      'TAMAMLAYICI AKSESUARLAR'
    ]);
    const ekSet = new Set([
      'AKSESUARLAR',
      'EK URUNLER'
    ]);

    const filtered = type === 'ANA'
      ? groups.filter(g => anaSet.has(g.group))
      : groups.filter(g => ekSet.has(g.group));

    // ‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî
    // 4) Etiket ba≈ülƒ±ƒüƒ± ve tarih
    let conceptNameDisplay = '';
    if (filtered.length && filtered[0].items.length) {
      conceptNameDisplay = filtered[0].items[0].CUSTOMER_NAME;
    }
    const formattedDate = new Date().toLocaleDateString('tr-TR');

    // ‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî
    // 5) Container‚Äôƒ± temizle, ilk A4 sayfasƒ±nƒ± olu≈ütur
    const container = document.getElementById("conceptLabelsContainer");
    container.innerHTML = "";

    let { page, topLabel, bottomLabel } = createNewA4Page(conceptNameDisplay, formattedDate);
    container.appendChild(page);

    let currentLabelContent = topLabel;
    let labelSlot = 1; // 1 = √ºst, 2 = alt

    // ‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî
    // 6) Tablo ba≈ülƒ±klarƒ± & sayƒ± formatlayƒ±cƒ±
    const formatter = new Intl.NumberFormat('tr-TR',{ minimumFractionDigits:0, maximumFractionDigits:0 });
    const tableHeaders = lang === "tr"
      ? ["KATEGORI","MODEL","EBAT","KOD","MIKTAR","FIYAT","TUTAR"]
      : ["CATEGORY","MODEL","SIZE","CODE","QUANTITY","PRICE","AMOUNT"];

    // ‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî
    // 7) Gruplarƒ± dola≈ü ve etiketlere ekle
    for (let groupData of filtered) {
      // 7.a) Grup bloƒüu olu≈ütur
      const groupBlock = document.createElement("div");
      let html = `<h6 style="margin:1mm 0;font-size:14px;">
                    ${translateGroupName(groupData.group, lang)}
                  </h6>`;
      html += `<table style="width:100%;font-size:12px;border-collapse:collapse;" border="1">
                 <thead><tr>`;
      tableHeaders.forEach(h => html += `<th>${h}</th>`);
      html += `</tr></thead><tbody>`;
      groupData.items.forEach(item => {
        html += `<tr>
                   <td>${item.Kategori}</td>
                   <td>${item.MODEL}</td>
                   <td>${item.EBAT}</td>
                   <td>${item.KOD}</td>
                   <td style="text-align:right;">${item.QUANTITY}</td>
                   <td style="text-align:right;">${formatter.format(item.SFIYAT1)}</td>
                   <td style="text-align:right;">${formatter.format(item.Amount)}</td>
                 </tr>`;
      });
      html += `<tr style="font-weight:bold;">
                 <td colspan="4" style="text-align:right;">Grup Toplamƒ±:</td>
                 <td style="text-align:right;">${groupData.totalQuantity}</td>
                 <td></td>
                 <td style="text-align:right;">${formatter.format(groupData.totalAmount)}</td>
               </tr>`;
      html += `</tbody></table><br>`;
      groupBlock.innerHTML = html;

      // 7.b) Eklemeye √ßalƒ±≈ü, sonra sƒ±ƒümazsa alt/sonraki sayfaya al
      currentLabelContent.appendChild(groupBlock);

      // Y√ºksekliƒüi √∂l√ß (alt etiket i√ßin transform‚Äôu ge√ßici kaldƒ±r)
      let currentHeight;
      if (labelSlot === 2) {
        const orig = currentLabelContent.style.transform;
        currentLabelContent.style.transform = "none";
        currentHeight = currentLabelContent.getBoundingClientRect().height;
        currentLabelContent.style.transform = orig;
      } else {
        currentHeight = currentLabelContent.getBoundingClientRect().height;
      }

      if (currentHeight > THRESHOLD_PX) {
        currentLabelContent.removeChild(groupBlock);
        if (labelSlot === 1) {
          // alt etikete ge√ß
          currentLabelContent = bottomLabel;
          labelSlot = 2;
          currentLabelContent.appendChild(groupBlock);
        } else {
          // yeni sayfa a√ß, √ºst etikete ekle
          ({ page, topLabel, bottomLabel } = createNewA4Page(conceptNameDisplay, formattedDate));
          container.appendChild(page);
          currentLabelContent = topLabel;
          labelSlot = 1;
          currentLabelContent.appendChild(groupBlock);
        }
      }
    }

    // ‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî
    // 8) Bo≈ü alt etiketleri temizle
    document.querySelectorAll(".a4-page").forEach(pg => {
      const bottom = pg.querySelector(".label-bottom");
      if (bottom && bottom.querySelector(".label-content").innerHTML.trim() === "") {
        bottom.remove();
      }
    });

    // ‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî
    // 9) ƒ∞kinci etiketleri 180¬∞ √ßevir
    applyRotation();

  } catch (error) {
    console.error("Etiket olu≈üturma hatasƒ±:", error);
    alert("Etiket olu≈üturulurken hata olu≈ütu.");
  }
}


 
// Yazdƒ±rma fonksiyonu: Olu≈üturulan A4 sayfalarƒ±nƒ± yeni pencerede a√ßƒ±p yazdƒ±rƒ±r.
function printConceptLabels() {
  const container = document.getElementById("conceptLabelsContainer");
  if (!container) {
    alert("Barkod etiketleri bulunamadƒ±.");
    return;
  }
  const printContents = container.innerHTML;
  if (!printContents.trim()) {
    alert("Barkod etiketleri hen√ºz olu≈üturulmamƒ±≈ü.");
    return;
  }
  
  const printWindow = window.open("", "", "height=800,width=1000");
  printWindow.document.write("<html><head><title>Barkod Etiketleri</title>");
  printWindow.document.write("<style>");
  printWindow.document.write("@page { margin: 0; }");
  printWindow.document.write("body { margin: 0; padding: 0; }");
  printWindow.document.write(".a4-page { page-break-after: always; }");
  printWindow.document.write("</style>");
  printWindow.document.write("</head><body>");
  printWindow.document.write(printContents);
  printWindow.document.write("</body></html>");
  printWindow.document.close();
  printWindow.focus();
  printWindow.print();
}


function autoShrinkText() {
  const cells = document.querySelectorAll('.shrinkable');
  cells.forEach(cell => {
    // Ba≈ülangƒ±√ßta computed font size alƒ±nƒ±r.
    let style = window.getComputedStyle(cell);
    let fontSize = parseFloat(style.fontSize);
    
    // Metin h√ºcre geni≈üliƒüini a≈üƒ±yorsa, minimum 6px'e kadar azaltarak yeniden deniyoruz.
    while (cell.scrollWidth > cell.clientWidth && fontSize > 6) {
      fontSize -= 0.5;
      cell.style.fontSize = fontSize + 'px';
    }
  });
}

// Grup adlarƒ±nƒ± √ßevirmek i√ßin fonksiyon
	function translateGroupName(groupName, lang) {
	  const translations = {
		"ANA KONSEPT": { tr: "ANA KONSEPT", en: "MAIN CONCEPT" },
		"TAMAMLAYICI URUNLER": { tr: "TAMAMLAYICI URUNLER", en: "ADDITIONAL PRODUCTS" },
		"TAMAMLAYICI AKSESUARLAR": { tr: "TAMAMLAYICI AKSESUARLAR", en: "ADDITIONAL ACCESSORIES" },
		"OTHER": { tr: "OTHER", en: "OTHER" }
	  };
	  return translations[groupName] ? translations[groupName][lang] : groupName;
	}	

// Excelden Fiyat G√ºncelleme alanƒ±nƒ± g√∂steren fonksiyon
function showPriceUpdateContainer() {
  const activeTab = document.querySelector('.tab-pane.active');
  if (activeTab && activeTab.id === "adminPanel") {
    // Admin panelde admin-product-container'ƒ± gizle
    document.getElementById("admin-product-container").style.display = "none";
	document.getElementById("initialImageContainer").style.display = "none";
	document.getElementById("stokKartiContainer").style.display = "none";
    // Fiyat G√ºncelleme konteynerini g√∂ster
    const priceUpdateContainer = document.getElementById("priceUpdateContainer");
    priceUpdateContainer.style.display = "block";
    priceUpdateContainer.style.marginLeft = "30%";
	priceUpdateContainer.style.marginRight = "30%";
	priceUpdateContainer.style.marginTop = "20%";
  } else {
    alert("Fiyat G√ºncelleme i≈ülemi yalnƒ±zca Admin Panel'de kullanƒ±labilir.");
    // Alternatif: Otomatik olarak adminPanel'e ge√ßi≈ü yapmak i√ßin:
    //$('#adminPanel').tab('show');
  }
}



// Excel dosyasƒ±nƒ± okuyup backend'e g√∂nderen fonksiyon (g√ºncelleme i≈ülemi ilerlemesini ger√ßek zamanlƒ± g√∂sterir)
async function updatePrices() {
  const fileInput = document.getElementById("excelFileInput");
  if (!fileInput.files || fileInput.files.length === 0) {
    alert("L√ºtfen bir Excel dosyasƒ± se√ßiniz.");
    return;
  }
  const file = fileInput.files[0];
  const formData = new FormData();
  formData.append("excelFile", file);

  // G√ºncelleme durumunu g√∂stermek i√ßin bir progress div'imiz olsun.
  let progressDiv = document.getElementById("updateProgress");
  if (!progressDiv) {
    progressDiv = document.createElement("div");
    progressDiv.id = "updateProgress";
    // A≈üaƒüƒ±daki stil ayarlarƒ± div'in belirli bir y√ºkseklikte kalmasƒ±nƒ± ve i√ßerik ta≈üarsa dikey kaydƒ±rma √ßubuƒüunun g√∂r√ºnmesini saƒülar.
    progressDiv.style.background = "#eef";
    progressDiv.style.padding = "10px";
    progressDiv.style.marginTop = "10px";
    progressDiv.style.marginLeft = "30%";
    progressDiv.style.marginRight = "20%";
    progressDiv.style.width = "40%"; // Geni≈üliƒüi ayarlayabilirsiniz
    progressDiv.style.maxHeight = "300px"; // Maksimum y√ºkseklik
    progressDiv.style.overflowY = "auto"; // Dikey kaydƒ±rma √ßubuƒüu
    document.body.appendChild(progressDiv);
  }
  progressDiv.innerHTML = "G√ºncelleme ba≈üladƒ±...<br>";
  progressDiv.style.display = "block";

  try {
    const response = await fetch("/api/update-prices", {
      method: "POST",
      headers: {
        "isadmin": localStorage.getItem("isAdmin"),
        "kullanici": localStorage.getItem("username") || "Bilinmiyor"
      },
      body: formData
    });
    const reader = response.body.getReader();
    const decoder = new TextDecoder("utf-8");

    function readChunk() {
      reader.read().then(({ done, value }) => {
        if (done) {
          progressDiv.innerHTML += "<br><strong>G√ºncelleme tamamlandƒ±.</strong>";
          return;
        }
        const chunkText = decoder.decode(value);
        console.log(chunkText);
        progressDiv.innerHTML += chunkText.replace(/\n/g, "<br>");
        readChunk();
      }).catch(err => {
        progressDiv.innerHTML += "<br><span style='color:red;'>Hata: " + err.message + "</span>";
        console.error("Progress okuma hatasƒ±:", err);
      });
    }
    readChunk();
  } catch (error) {
    alert("Fiyat g√ºncelleme sƒ±rasƒ±nda hata olu≈ütu: " + error.message);
  }
}


	
</script>
  <script>
// Custom editor: select2Editor
var select2Editor = function(cell, onRendered, success, cancel, editorParams) {
  var cellValue = cell.getValue();
  var editorDiv = document.createElement("div");
  editorDiv.style.width = "100%";
  
  var select = document.createElement("select");
  select.style.width = "100%";
  
  // √áoklu se√ßim kaldƒ±rƒ±ldƒ±, tek se√ßim kullanƒ±lacak.
  // editorParams.values: √ñrneƒüin { "1": "Model A", "2": "Model B", ... }
  var values = editorParams.values;
  for (var key in values) {
    if (values.hasOwnProperty(key)) {
      var option = document.createElement("option");
      option.value = key;
      option.text = values[key];
      if (cellValue == key) {
        option.selected = true;
      }
      select.appendChild(option);
    }
  }
  
  editorDiv.appendChild(select);
  
  onRendered(function(){
    $(select).select2({
      dropdownParent: $("#hotContainer"),  // Grid container
      width: '100%',
      placeholder: "Se√ßim yapƒ±n...",
      // Wild card destekleyen matcher fonksiyonu:
      matcher: function(params, data) {
        // Arama kutusu bo≈üsa, t√ºm se√ßenekleri d√∂nd√ºr.
        if ($.trim(params.term) === '') {
          return data;
        }
        if (typeof data.text === 'undefined') {
          return null;
        }
        
        var searchTerm = params.term;
        // Eƒüer * karakteri varsa: custom regex olu≈ütur.
        if (searchTerm.indexOf('*') > -1) {
          // √ñnce girilen arama ifadesindeki diƒüer regex √∂zel karakterlerini escape ediyoruz.
          var escaped = searchTerm.replace(/[-\/\\^$+?.()|[\]{}]/g, '\\$&');
          // * karakterlerini regex wild card'ƒ± olarak kullanmak i√ßin .*
          var pattern = '^' + escaped.replace(/\*/g, '.*') + '$';
          var regex = new RegExp(pattern, 'i');  // case insensitive
          if (regex.test(data.text)) {
            return data;
          }
          return null;
        } else {
          // Eƒüer wild card kullanƒ±lmamƒ±≈üsa, normal "contains" kontrol√º yap.
          if (data.text.toLowerCase().indexOf(searchTerm.toLowerCase()) > -1) {
            return data;
          }
          return null;
        }
      }
    });
    
    // Se√ßim deƒüi≈ütiƒüinde success √ßaƒürƒ±larak update i≈ülemi tetikleniyor.
    $(select).on("change", function(){
      success(select.value);
    });
    
    // Dropdown kapanƒ±nca update i≈ülemi √ßalƒ±≈üsƒ±n.
    $(select).on("select2:close", function(){
      success(select.value);
    });
    
    // ESC tu≈üu ile edit iptal
    $(select).on("keydown", function(e){
      if(e.key === "Escape"){
        cancel();
      }
    });
  });
  
  return editorDiv;
};


  </script>

  <script>
// SKART verilerini API'den √ßeken fonksiyon
function loadSkartData(callback) {
  $.getJSON('/api/skart', function(response) {
    if(response.success) {
      callback(response.data);
    } else {
      alert("SKART verileri alƒ±namadƒ±: " + response.message);
    }
  });
}

// Lookup verilerini API'den √ßeken fonksiyon (√∂rneƒüin, TIP=71 i√ßin)
function loadLookupData(tip, callback) {
  $.getJSON('/api/lookups', { tip: tip }, function(response) {
    if(response.success) {
      callback(response.data);
    } else {
      callback([]);
    }
  });
}

// Lookup Basamak verilerini API'den √ßeken fonksiyon (√∂rneƒüin, TIP=0 (altƒ±d) i√ßin)
function loadLookupDataBasamak(tip, callback) {
  $.getJSON('/api/lookups-basamak', { tip: tip }, function(response) {
    if(response.success) {
      callback(response.data);
    } else {
      callback([]);
    }
  });
}
//kolon sƒ±ralamasƒ±nƒ± √ßeken fonksiyon
async function loadUserPreferences(userId, tableName){
  const resp   = await fetch(
    `/api/user-preferences/${encodeURIComponent(userId)}/${encodeURIComponent(tableName)}`
  );
  const result = await resp.json();
  return result.success ? result.data : [];
}

//kolon sƒ±ralamasƒ±nƒ± kaydeden fonksiyon
async function saveUserPreferences(userId, tableName, preferences){
  await fetch('/api/user-preferences', {
    method: 'POST',
    headers: {'Content-Type':'application/json'},
    body: JSON.stringify({ userId, tableName, preferences })
  });
}

		
// Global deƒüi≈ükenler: OZEL2 i√ßin modelOptions (lookup se√ßenekleri) ve modelLookupMap (KOD ‚Üí ADI e≈ülemesi)
var modelOptions = [];
var modelLookupMap = {};

// "Stok Kartƒ±" grid'ini y√ºkleyen fonksiyon (√∂rneƒüin, bir men√º √∂ƒüesi tƒ±klanarak √ßalƒ±≈ütƒ±rƒ±labilir)
function showStokKartiContainer(){
	// ‚ö†Ô∏è Header menu‚Äô√º hemen en ba≈üta tanƒ±mlƒ±yoruz:
	  const headerMenu = function(){
		const menu = [];
		const cols = this.getColumns();

		cols.forEach(col => {
		  const icon = document.createElement("i");
		  icon.classList.add("fas", col.isVisible() ? "fa-check-square" : "fa-square");

		  const label = document.createElement("span");
		  label.style.display = "inline-flex";
		  label.style.alignItems = "center";

		  const title = document.createElement("span");
		  title.textContent = " " + col.getDefinition().title;

		  label.appendChild(icon);
		  label.appendChild(title);

		  menu.push({
			label: label,
			action: function(e){
			  e.stopPropagation();
			  col.toggle();
			  icon.classList.replace(
				col.isVisible() ? "fa-square" : "fa-check-square",
				col.isVisible() ? "fa-check-square" : "fa-square"
			  );
			}
		  });
		});

		return menu;
	  };
	  
	  
   // Admin panel aktif mi kontrol ediyoruz:
  const activeTab = document.querySelector('.tab-pane.active');
  if (!activeTab || activeTab.id !== "adminPanel") {
    alert("Stok Kartƒ± Y√∂netimi yalnƒ±zca Admin Panel'de kullanƒ±labilir.");
    // ƒ∞≈ülem kesilsin, daha fazla ilerlemesin:
    return;
  }
  // Eƒüer varsa, ana ekrandaki fotoƒürafƒ± gizle
    const productContainer = document.getElementById("product-container");
    if (productContainer) productContainer.style.display = "none";
    const initialImageContainer = document.getElementById("initialImageContainer");
    if (initialImageContainer) initialImageContainer.style.display = "none";
	const conceptContainer = document.getElementById("conceptContainer");
    if (conceptContainer) conceptContainer.style.display = "none";
	
	const conceptProductContainer = document.getElementById("concept-products-container");
	if(conceptProductContainer) conceptProductContainer.style.display = "none";
	
	const priceUpdateContainer = document.getElementById("priceUpdateContainer");
	if(priceUpdateContainer) priceUpdateContainer.style.display = "none";
	
  
  // Stok Kartƒ± container'ƒ±nƒ± g√∂r√ºn√ºr yap
  $('#stokKartiContainer').show();

  // SKART verilerini √ßek
  loadSkartData(async function(skartData){
	  const userId    = localStorage.getItem('username');       // oturumdan
	  const tableName = 'SKART';

	  // 2) DB‚Äôden tercihler (hen√ºz bo≈ü olsa bile bo≈ü dizi)
	  const prefs = await loadUserPreferences(userId, tableName);
	  // 3) √ñnce prefMap‚Äôi olu≈ütur:
	  const prefMap = {};
	  prefs.forEach(p => {
      prefMap[p.ColumnName] = { 
        ColumnOrder: p.ColumnOrder, 
        IsVisible:   p.IsVisible 
      };
    });
		// 1) Ba≈üta, sayfanƒ±n en √ºst√ºnde veya tabloyu olu≈üturduƒüunuz script‚Äôin ba≈üƒ±nda ekleyin:

		// headerMenu tanƒ±mƒ± (her s√ºtunun ba≈ülƒ±ƒüƒ±na bu men√ºy√º eklemek i√ßin)
		const headerMenu = function(){
			  const menu = [];
			  // this = Tabulator s√ºtun objesinin olduƒüu columnContext
			  const columns = this.getColumns();

			  for (let col of columns) {
				// ikon olu≈ütur
				const icon = document.createElement("i");
				icon.classList.add("fas", col.isVisible() ? "fa-check-square" : "fa-square");

				// etiket olu≈ütur
				const label = document.createElement("span");
				label.style.display = "inline-flex";
				label.style.alignItems = "center";

				const title = document.createElement("span");
				title.textContent = " " + col.getDefinition().title;

				label.appendChild(icon);
				label.appendChild(title);

				// men√º √∂ƒüesi
				menu.push({
				  label: label,
				  action: function(e) {
					e.stopPropagation();   // men√ºn√ºn kapanmasƒ±nƒ± engelle
					col.toggle();          // g√∂r√ºn√ºrl√ºƒü√º deƒüi≈ütir
					// ikonu g√ºncelle
					if (col.isVisible()) {
					  icon.classList.replace("fa-square", "fa-check-square");
					} else {
					  icon.classList.replace("fa-check-square", "fa-square");
					}
				  }
				});
			  }

			  return menu;
			};

    // CINS i√ßin lookup verilerini (GRUP tablosu, TIP=70) √ßek
    loadLookupData(70, function(lookup70){
      // Lookup verilerinden cinsOptions ve cinsLookupMap olu≈üturuluyor.
      window.cinsOptions = [];
      window.cinsLookupMap = {};
      lookup70.forEach(function(item){
        cinsLookupMap[item.KOD] = item.ADI;
        cinsOptions.push({ value: item.KOD, label: item.ADI });
        
      });
      
      // Cƒ∞NS s√ºtunu i√ßin editor ve header filter deƒüerlerini olu≈üturacak mapping nesnesi
     window.cinsMapping = {};
      cinsOptions.forEach(function(opt){
        cinsMapping[opt.value] = opt.label;
      });
      
	// MODEL i√ßin lookup verilerini (GRUP tablosu, TIP=71) √ßek
    loadLookupData(71, function(lookup71){
      // Lookup verilerinden modelOptions ve modelLookupMap olu≈üturuluyor.
      window.modelOptions = [];
      window.modelLookupMap = {};
      lookup71.forEach(function(item){
        modelLookupMap[item.KOD] = item.ADI;
        modelOptions.push({ value: item.KOD, label: item.ADI });
        
      });
      
      // MODEL s√ºtunu i√ßin editor ve header filter deƒüerlerini olu≈üturacak mapping nesnesi
      window.modelMapping = {};
      modelOptions.forEach(function(opt){
      modelMapping[opt.value] = opt.label;
      });
      
      //--------------------------------
      // Materyal Dropdown i√ßin
      loadLookupData(72, function(lookup72){
        window.materyalOptions = [];
        window.materyalLookupMap = {};
        lookup72.forEach(function(item){
          materyalLookupMap[item.KOD] = item.ADI;
          materyalOptions.push({ value: item.KOD, label: item.ADI });
          
        });
        
        // MATERYAL s√ºtunu i√ßin editor ve header filter deƒüerlerini olu≈üturacak mapping nesnesi
        window.materyalMapping = {};
        materyalOptions.forEach(function(opt){
          materyalMapping[opt.value] = opt.label;
        });
        
        //--------------------------------
        // DESEN Dropdown i√ßin
        loadLookupData(73, function(lookup73){
          window.desenOptions = [];
          window.desenLookupMap = {};
          lookup73.forEach(function(item){
            desenLookupMap[item.KOD] = item.ADI;
            desenOptions.push({ value: item.KOD, label: item.ADI });
            
          });
          
          // DESEN s√ºtunu i√ßin editor ve header filter deƒüerlerini olu≈üturacak mapping nesnesi
          window.desenMapping = {};
          desenOptions.forEach(function(opt){
            desenMapping[opt.value] = opt.label;
          });
          //--------------------------------
		  
		  //--------------------------------
        // LAMINE Dropdown i√ßin
        loadLookupData(74, function(lookup74){
          window.lamineOptions = [];
          window.lamineLookupMap = {};
          lookup74.forEach(function(item){
            lamineLookupMap[item.KOD] = item.ADI;
            lamineOptions.push({ value: item.KOD, label: item.ADI });
          });
          
          // LAMINE s√ºtunu i√ßin editor ve header filter deƒüerlerini olu≈üturacak mapping nesnesi
          window.lamineMapping = {};
          lamineOptions.forEach(function(opt){
            lamineMapping[opt.value] = opt.label;
          });
          //--------------------------------
		  // AKSESUAR Dropdownlarƒ± i√ßin
        loadLookupData(75, function(lookup75){
          window.aksesuarOptions = [];
          window.aksesuarLookupMap = {};
          lookup75.forEach(function(item){
            aksesuarLookupMap[item.KOD] = item.ADI;
            aksesuarOptions.push({ value: item.KOD, label: item.ADI });
          });
          
          // AKSESUAR s√ºtunu i√ßin editor ve header filter deƒüerlerini olu≈üturacak mapping nesnesi
          window.aksesuarMapping = {};
          aksesuarOptions.forEach(function(opt){
            aksesuarMapping[opt.value] = opt.label;
          });
          //--------------------------------
		
		  // KALITE Dropdownlarƒ± i√ßin
        loadLookupData(77, function(lookup77){
          window.kaliteOptions = [];
          window.kaliteLookupMap = {};
          lookup77.forEach(function(item){
            kaliteLookupMap[item.KOD] = item.ADI;
            kaliteOptions.push({ value: item.KOD, label: item.ADI });
          });
          
          // KALITE s√ºtunu i√ßin editor ve header filter deƒüerlerini olu≈üturacak mapping nesnesi
          window.kaliteMapping = {};
          kaliteOptions.forEach(function(opt){
            kaliteMapping[opt.value] = opt.label;
          });
          //--------------------------------
		  // EBAT Dropdownlarƒ± i√ßin
        loadLookupData(78, function(lookup78){
          window.ebatOptions = [];
          window.ebatLookupMap = {};
          lookup78.forEach(function(item){
            ebatLookupMap[item.KOD] = item.ADI;
            ebatOptions.push({ value: item.KOD, label: item.ADI });
          });
          
          // EBAT s√ºtunu i√ßin editor ve header filter deƒüerlerini olu≈üturacak mapping nesnesi
          window.ebatMapping = {};
          ebatOptions.forEach(function(opt){
            ebatMapping[opt.value] = opt.label;
          });
          //--------------------------------
		   // RENK Dropdownlarƒ± i√ßin
        loadLookupData(79, function(lookup79){
          window.renkLookupMap = {};
          window.renkOptions = [];
          lookup79.forEach(function(item){
            renkLookupMap[item.KOD] = item.ADI;
            renkOptions.push({ value: item.KOD, label: item.ADI });
          });
          
          // RENK s√ºtunu i√ßin editor ve header filter deƒüerlerini olu≈üturacak mapping nesnesi
          window.renkMapping = {};
          renkOptions.forEach(function(opt){
            renkMapping[opt.value] = opt.label;
          });
          //--------------------------------
		   // GENƒ∞≈û KOLEKSIYON Dropdownƒ± i√ßin
			loadLookupData(250, function(lookup250){
			  window.koleksiyonOptions = [];
			  window.koleksiyonLookupMap = {};
			  lookup250.forEach(function(item){
				koleksiyonLookupMap[item.KOD] = item.ADI;
				koleksiyonOptions.push({ value: item.KOD, label: item.ADI });
			  });
			  
			  		  
			  // GENƒ∞≈û KOLEKSIYON s√ºtunu i√ßin editor ve header filter deƒüerlerini olu≈üturacak mapping nesnesi
			  window.koleksiyonMapping = {};
			  koleksiyonOptions.forEach(function(opt){
				koleksiyonMapping[opt.value] = opt.label;
			  });
			  //--------------------------------   
		  // TEDARIKYONTEMI Dropdownƒ± i√ßin
			loadLookupData(253, function(lookup253){
			  window.tedarikyontemiOptions = [];
			  window.tedarikyontemiLookupMap = {};
			  lookup253.forEach(function(item){
				tedarikyontemiLookupMap[item.KOD] = item.ADI;
				tedarikyontemiOptions.push({ value: item.KOD, label: item.ADI });
			  });
			  
			  		  
			  // TEDARIKYONTEMI s√ºtunu i√ßin editor ve header filter deƒüerlerini olu≈üturacak mapping nesnesi
			  window.tedarikyontemiMapping = {};
			  tedarikyontemiOptions.forEach(function(opt){
				tedarikyontemiMapping[opt.value] = opt.label;
			  });
			  //--------------------------------  
		 // Basamak Dropdown i√ßin
		  loadLookupDataBasamak(0, function(lookup0){
			window.basamak1Options = [];
			window.basamak1LookupMap = {};
			lookup0.forEach(function(item){
			  basamak1LookupMap[item.KOD] = item.ADI;
			  basamak1Options.push({ value: item.KOD, label: item.ADI });
			  
			});
			
			// Basamak s√ºtunu i√ßin editor ve header filter deƒüerlerini olu≈üturacak mapping nesnesi
			window.basamak1Mapping = {};
			basamak1Options.forEach(function(opt){
			  basamak1Mapping[opt.value] = opt.label;
			});
			
			//--------------------------------
          
          // SKART verilerindeki her satƒ±rda OZEL2 alanƒ± tanƒ±mlƒ± olsun
          skartData.forEach(function(row){
            if(!row.OZEL2) row.OZEL2 = "";
          });
          
		  //FOTOƒûRAFSIZLARI BO≈û FOTOYA Y√ñNLENDƒ∞RME
		  function fallbackImageFormatter(cell, formatterParams, onRendered) {
			  var value = cell.getValue();   // Bu √∂rnekte value, KOD olacak.
			  var imgUrl = formatterParams.urlPrefix + value + formatterParams.urlSuffix;
			  // onerror attribute sayesinde, resim y√ºklenemezse fallbackImage URL'sine y√∂nlendiriyoruz.
			  return "<img src='" + imgUrl + "' onerror=\"this.onerror=null;this.src='" + formatterParams.fallbackImage + "';\" style='max-width:" + formatterParams.width + ";height:" + formatterParams.height + ";' />";
			}
			
		
          // Tabulator grid kolon tanƒ±mlarƒ±
          var columns = [
            {
			  title: "Fotoƒüraf",
			  // artƒ±k filtre field'ƒ± FOTODURUM, header filter ger√ßekten bu alana bakacak
			  field: "FOTODURUM",
			  frozen: true,
			  vertAlign: "center",

			  // Hepsi/Var/Yok se√ßenekleri
			  headerFilter: "select",
			  headerFilterParams: {
				values: {
				  "VAR": "Var",
				  "YOK": "Yok"
				}
			  },
			  headerFilterPlaceholder: "Hepsi",
			  headerFilterFunc: function(headerValue, rowValue, rowData) {
				// headerValue = se√ßilen FOTODURUM deƒüeridir ("VAR"/"YOK"), bo≈üsa Hepsi
				if (!headerValue) return true;        // Hepsi se√ßiliyse t√ºm satƒ±rlar
				return rowValue === headerValue;      // aksi halde direkt kar≈üƒ±la≈ütƒ±r
			  },

			  // Formatter h√¢l√¢ fallbackImageFormatter ile birebir √ßalƒ±≈ümayacaƒüƒ± i√ßin:
			  // kendi ufak formatter‚Äôƒ±mƒ±zƒ± kullanƒ±yoruz:
			  formatter: function(cell, formatterParams) {
				const data = cell.getData();  // t√ºm row verisi
				// FotoDurum VAR ise ger√ßek foto, YOK ise sabit YOK.jpg
				const src = data.FOTODURUM === "VAR"
				  ? formatterParams.urlPrefix + data.KOD + formatterParams.urlSuffix
				  : formatterParams.fallbackImage;

				return `<img
				  src="${src}"
				  onerror="this.onerror=null;this.src='${formatterParams.fallbackImage}';"
				  style="max-width:${formatterParams.width};max-height:${formatterParams.height};object-fit:cover;"
				/>`;
			  },

			  // fallbackImageFormatter ile aynƒ± parametreler:
			  formatterParams: {
				width:        "70px",
				height:       "70px",
				urlPrefix:    "/resim/",
				urlSuffix:    ".jpg",
				fallbackImage: "/resim/YOK.jpg"
			  },

			  width: 90
			},


            { 
			  title: "KOD", 
			  field: "KOD", 
			  headerFilter: "input",
			  headerFilterFunc: function(headerValue, rowValue, rowData, filterParams){
				if($.trim(headerValue) === ""){
				  return true;
				}
				
				var regexStr;
				// Eƒüer headerValue i√ßerisinde "*" yoksa, contains mantƒ±ƒüƒ±yla filtrele: "*headerValue*"
				if (headerValue.indexOf("*") === -1) {
				  regexStr = ".*" + headerValue + ".*";
				} else {
				  // Eƒüer "*" karakteri varsa, kullanƒ±cƒ± tarafƒ±ndan girilen deƒüeri regex'e √ßevir
				  regexStr = "^" + headerValue.replace(/\*/g, ".*") + "$";
				}
				
				var regex = new RegExp(regexStr, "i");
				
				if(typeof rowValue !== "string"){
				  return false;
				}
				
				return regex.test(rowValue);
			  },
			  // sadece bu s√ºtunda headerMenu'u a√ß
			  headerMenu: headerMenu,
			  editor: false, 
			  frozen: true, 
			  // √ßift tƒ±klama tetikleyeni:
			  rowDblClick: function(e, row){
				const data = row.getData();
				document.getElementById("modalStockCode").textContent = data.KOD;
				document.getElementById("stockCode").value    = data.KOD;
				document.getElementById("stockName").value    = data.ADI;
				document.getElementById("stockGroup").value   = data.GRUP;
				document.getElementById("stockUnit").value    = data.BIRIM;
				document.getElementById("stockBarcode").value = data.BARKOD;
				document.getElementById("stockKDV").value     = data.KDV;
				$('#stockCardModal').modal('show');
			  },
			  vertAlign:"center",
			  width: 130 
			},

            { 
			  title: "ADI", 
			  field: "ADI", 
			  headerFilter: "input", 
			  headerFilterFunc: function(headerValue, rowValue, rowData, filterParams){
				if($.trim(headerValue) === ""){
				  return true;
				}
				
				var regexStr;
				// Eƒüer headerValue i√ßerisinde "*" yoksa, contains mantƒ±ƒüƒ±yla filtrele: "*headerValue*"
				if (headerValue.indexOf("*") === -1) {
				  regexStr = ".*" + headerValue + ".*";
				} else {
				  // Eƒüer "*" karakteri varsa, kullanƒ±cƒ± tarafƒ±ndan girilen deƒüeri regex'e √ßevir
				  regexStr = "^" + headerValue.replace(/\*/g, ".*") + "$";
				}
				
				var regex = new RegExp(regexStr, "i");
				
				if(typeof rowValue !== "string"){
				  return false;
				}
				
				return regex.test(rowValue);
			  },
			  editor: "input", 
			  editable: true, 
			  frozen: true,
			  width: 375,
			  vertAlign:"center",
			  cellClick: function(e, cell){
				cell.edit();
				console.log("ADI h√ºcresine tƒ±klandƒ±. Deƒüer:", cell.getValue());
			  },
			  cellEdited: function(cell){
				console.log("ADI s√ºtunu d√ºzenlendi. Yeni deƒüer:", cell.getValue());
				triggerUpdate(cell);
			  }
			},
			{ 
			  title: "BIRIM", 
			  field: "BIRIM", 
			  headerFilter: "input",
			  headerFilterFunc: function(headerValue, rowValue, rowData, filterParams){
				if($.trim(headerValue) === ""){
				  return true;
				}
				
				var regexStr;
				// Eƒüer headerValue i√ßerisinde "*" yoksa, contains mantƒ±ƒüƒ±yla filtrele: "*headerValue*"
				if (headerValue.indexOf("*") === -1) {
				  regexStr = ".*" + headerValue + ".*";
				} else {
				  // Eƒüer "*" karakteri varsa, kullanƒ±cƒ± tarafƒ±ndan girilen deƒüeri regex'e √ßevir
				  regexStr = "^" + headerValue.replace(/\*/g, ".*") + "$";
				}
				
				var regex = new RegExp(regexStr, "i");
				
				if(typeof rowValue !== "string"){
				  return false;
				}
				
				return regex.test(rowValue);
			  },
			  editor: false,  
			  vertAlign:"center",
			  width: 130 
			},
			{ 
              title: "BASAMAK 1", 
              field: "BASAMAK1", 
              headerFilter: "list",
              width: 180,
			  vertAlign:"center",
              headerFilterParams: { values: basamak1Mapping },
			  headerFilterFunc: function(headerValue, rowValue, rowData, filterParams){
				  headerValue = $.trim(headerValue);
				  if(headerValue === ""){
					return true;
				  }
				  
				  let regexStr;
				  // Eƒüer headerValue i√ßinde "*" yoksa tam e≈üle≈üme i√ßin ba≈üƒ±na ^ ve sonuna $ ekleyelim.
				  if(headerValue.indexOf("*") === -1){
					regexStr = "^" + headerValue + "$";
				  } else {
					// Eƒüer "*" varsa, wildcard mantƒ±ƒüƒ± ile e≈üle
					regexStr = "^" + headerValue.replace(/\*/g, ".*") + "$";
				  }
				  
				  var regex = new RegExp(regexStr, "i");
				  
				  if(typeof rowValue !== "string"){
					return false;
				  }
				  
				  return regex.test(rowValue);
				},

			  editor: false, 
              editable: false         
              
            },
			{ 
			  title: "BASAMAK 2", 
			  field: "BASAMAK2", 
			  headerFilter: "input",
			  headerFilterFunc: function(headerValue, rowValue, rowData, filterParams){
				if($.trim(headerValue) === ""){
				  return true;
				}
				
				var regexStr;
				// Eƒüer headerValue i√ßerisinde "*" yoksa, contains mantƒ±ƒüƒ±yla filtrele: "*headerValue*"
				if (headerValue.indexOf("*") === -1) {
				  regexStr = ".*" + headerValue + ".*";
				} else {
				  // Eƒüer "*" karakteri varsa, kullanƒ±cƒ± tarafƒ±ndan girilen deƒüeri regex'e √ßevir
				  regexStr = "^" + headerValue.replace(/\*/g, ".*") + "$";
				}
				
				var regex = new RegExp(regexStr, "i");
				
				if(typeof rowValue !== "string"){
				  return false;
				}
				
				return regex.test(rowValue);
			  },
			  editor: false, 
			  vertAlign:"center",
			  width: 130 
			},
			{ 
			  title: "BASAMAK 3", 
			  field: "BASAMAK3", 
			  headerFilter: "input",
			  headerFilterFunc: function(headerValue, rowValue, rowData, filterParams){
				if($.trim(headerValue) === ""){
				  return true;
				}
				
				var regexStr;
				// Eƒüer headerValue i√ßerisinde "*" yoksa, contains mantƒ±ƒüƒ±yla filtrele: "*headerValue*"
				if (headerValue.indexOf("*") === -1) {
				  regexStr = ".*" + headerValue + ".*";
				} else {
				  // Eƒüer "*" karakteri varsa, kullanƒ±cƒ± tarafƒ±ndan girilen deƒüeri regex'e √ßevir
				  regexStr = "^" + headerValue.replace(/\*/g, ".*") + "$";
				}
				
				var regex = new RegExp(regexStr, "i");
				
				if(typeof rowValue !== "string"){
				  return false;
				}
				
				return regex.test(rowValue);
			  },
			  editor: false, 
			  vertAlign:"center",
			  width: 130 
			},
			{ 
			  title: "BASAMAK 4", 
			  field: "BASAMAK4", 
			  headerFilter: "input",
			  headerFilterFunc: function(headerValue, rowValue, rowData, filterParams){
				if($.trim(headerValue) === ""){
				  return true;
				}
				
				var regexStr;
				// Eƒüer headerValue i√ßerisinde "*" yoksa, contains mantƒ±ƒüƒ±yla filtrele: "*headerValue*"
				if (headerValue.indexOf("*") === -1) {
				  regexStr = ".*" + headerValue + ".*";
				} else {
				  // Eƒüer "*" karakteri varsa, kullanƒ±cƒ± tarafƒ±ndan girilen deƒüeri regex'e √ßevir
				  regexStr = "^" + headerValue.replace(/\*/g, ".*") + "$";
				}
				
				var regex = new RegExp(regexStr, "i");
				
				if(typeof rowValue !== "string"){
				  return false;
				}
				
				return regex.test(rowValue);
			  },
			  editor: false,  
			  vertAlign:"center",
			  width: 130 
			},
			{ 
			  title: "BASAMAK 5", 
			  field: "BASAMAK5", 
			  headerFilter: "input",
			  headerFilterFunc: function(headerValue, rowValue, rowData, filterParams){
				if($.trim(headerValue) === ""){
				  return true;
				}
				
				var regexStr;
				// Eƒüer headerValue i√ßerisinde "*" yoksa, contains mantƒ±ƒüƒ±yla filtrele: "*headerValue*"
				if (headerValue.indexOf("*") === -1) {
				  regexStr = ".*" + headerValue + ".*";
				} else {
				  // Eƒüer "*" karakteri varsa, kullanƒ±cƒ± tarafƒ±ndan girilen deƒüeri regex'e √ßevir
				  regexStr = "^" + headerValue.replace(/\*/g, ".*") + "$";
				}
				
				var regex = new RegExp(regexStr, "i");
				
				if(typeof rowValue !== "string"){
				  return false;
				}
				
				return regex.test(rowValue);
			  },
			  editor: false, 
			  vertAlign:"center",
			  width: 130 
			},
            { 
              title: "CINS", 
              field: "OZEL1", 
              headerFilter: "list",
              width: 180,
			  vertAlign:"center",
              headerFilterParams: { values: cinsMapping },
              editor: select2Editor,           // select2Editor kullanƒ±lƒ±yor
              editorParams: { values: cinsMapping },
              formatter: function(cell){
                var value = cell.getValue();
                return cinsLookupMap[value] || value;
              },
              cellEdited: function(cell){
                console.log("Cƒ∞NS s√ºtunu d√ºzenlendi. Yeni deƒüer:", cell.getValue());
                triggerUpdate(cell);
              }
            },
			{ 
              title: "MODEL", 
              field: "OZEL2", 
              headerFilter: "list",
              width: 180,
			  vertAlign:"center",
              headerFilterParams: { values: modelMapping },
              editor: select2Editor,           // select2Editor kullanƒ±lƒ±yor
              editorParams: { values: modelMapping },
              formatter: function(cell){
                var value = cell.getValue();
                return modelLookupMap[value] || value;
              },
              cellEdited: function(cell){
                console.log("MODEL s√ºtunu d√ºzenlendi. Yeni deƒüer:", cell.getValue());
                triggerUpdate(cell);
              }
            },
            { 
              title: "MATERYAL", 
              field: "OZEL3", 
              headerFilter: "list",
              width: 180,
			  vertAlign:"center",
              headerFilterParams: { values: materyalMapping },
              editor: select2Editor,           // select2Editor kullanƒ±mƒ±
              editorParams: { values: materyalMapping },
              formatter: function(cell){
                var value = cell.getValue();
                return materyalLookupMap[value] || value;
              },
              cellEdited: function(cell){
                console.log("MATERYAL s√ºtunu d√ºzenlendi. Yeni deƒüer:", cell.getValue());
                triggerUpdate(cell);
              }
            },
			{ 
              title: "EBAT", 
              field: "OZEL9",
              headerFilter: "list",
              width: 180,
			  vertAlign:"center",
              headerFilterParams: { values: ebatMapping },
              editor: select2Editor,           // select2Editor kullanƒ±mƒ±
              editorParams: { values: ebatMapping },
              formatter: function(cell){
                var value = cell.getValue();
                return ebatLookupMap[value] || value;
              },
              cellEdited: function(cell){
                console.log("EBAT s√ºtunu d√ºzenlendi. Yeni deƒüer:", cell.getValue());
                triggerUpdate(cell);
              }
            },
			{ 
              title: "RENK", 
              field: "OZEL10",
              headerFilter: "list",
              width: 180,
			  vertAlign:"center",
              headerFilterParams: { values: renkMapping },
              editor: select2Editor,           // select2Editor kullanƒ±mƒ±
              editorParams: { values: renkMapping },
              formatter: function(cell){
                var value = cell.getValue();
                return renkLookupMap[value] || value;
              },
              cellEdited: function(cell){
                console.log("RENK s√ºtunu d√ºzenlendi. Yeni deƒüer:", cell.getValue());
                triggerUpdate(cell);
              }
            },
            { 
              title: "DESEN", 
              field: "OZEL4",
              headerFilter: "list",
              width: 150,
			  vertAlign:"center",
              headerFilterParams: { values: desenMapping },
              editor: select2Editor,           // select2Editor kullanƒ±mƒ±
              editorParams: { values: desenMapping },
              formatter: function(cell){
                var value = cell.getValue();
                return desenLookupMap[value] || value;
              },
              cellEdited: function(cell){
                console.log("DESEN s√ºtunu d√ºzenlendi. Yeni deƒüer:", cell.getValue());
                triggerUpdate(cell);
              }
            },
			{ 
              title: "LAMINE", 
              field: "OZEL5",
              headerFilter: "list",
              width: 150,
			  vertAlign:"center",
              headerFilterParams: { values: lamineMapping },
              editor: select2Editor,           // select2Editor kullanƒ±mƒ±
              editorParams: { values: lamineMapping },
              formatter: function(cell){
                var value = cell.getValue();
                return lamineLookupMap[value] || value;
              },
              cellEdited: function(cell){
                console.log("LAMINE s√ºtunu d√ºzenlendi. Yeni deƒüer:", cell.getValue());
                triggerUpdate(cell);
              }
            },
			{ 
              title: "AKSESUAR", 
              field: "OZEL6",
              headerFilter: "list",
              width: 150,
			  vertAlign:"center",
              headerFilterParams: { values: aksesuarMapping },
              editor: select2Editor,           // select2Editor kullanƒ±mƒ±
              editorParams: { values: aksesuarMapping },
              formatter: function(cell){
                var value = cell.getValue();
                return aksesuarLookupMap[value] || value;
              },
              cellEdited: function(cell){
                console.log("AKSESUAR1 s√ºtunu d√ºzenlendi. Yeni deƒüer:", cell.getValue());
                triggerUpdate(cell);
              }
            },
			{ 
              title: "AKSESUAR 2", 
              field: "AKSESUAR2",
              headerFilter: "list",
              width: 150,
			  vertAlign:"center",
              headerFilterParams: { values: aksesuarMapping },
              editor: select2Editor,           // select2Editor kullanƒ±mƒ±
              editorParams: { values: aksesuarMapping },
              formatter: function(cell){
                var value = cell.getValue();
                return aksesuarLookupMap[value] || value;
              },
              cellEdited: function(cell){
                console.log("AKSESUAR1 s√ºtunu d√ºzenlendi. Yeni deƒüer:", cell.getValue());
                triggerUpdate(cell);
              }
            },
            { 
              title: "AKSESUAR 3", 
              field: "AKSESUAR3",
              headerFilter: "list",
              width: 150,
			  vertAlign:"center",
              headerFilterParams: { values: aksesuarMapping },
              editor: select2Editor,           // select2Editor kullanƒ±mƒ±
              editorParams: { values: aksesuarMapping },
              formatter: function(cell){
                var value = cell.getValue();
                return aksesuarLookupMap[value] || value;
              },
              cellEdited: function(cell){
                console.log("AKSESUAR1 s√ºtunu d√ºzenlendi. Yeni deƒüer:", cell.getValue());
                triggerUpdate(cell);
              }
            },
			{ 
              title: "KALƒ∞TE", 
              field: "OZEL8",
              headerFilter: "list",
              width: 150,
			  vertAlign:"center",
              headerFilterParams: { values: kaliteMapping },
              editor: select2Editor,           // select2Editor kullanƒ±mƒ±
              editorParams: { values: kaliteMapping },
              formatter: function(cell){
                var value = cell.getValue();
                return kaliteLookupMap[value] || value;
              },
              cellEdited: function(cell){
                console.log("KALƒ∞TE s√ºtunu d√ºzenlendi. Yeni deƒüer:", cell.getValue());
                triggerUpdate(cell);
              }
            },
			{ 
              title: "GENƒ∞≈û KOLEKSIYON", 
              field: "KOLEKSIYON",
              headerFilter: "list",
              width: 150,
              headerFilterParams: { values: koleksiyonMapping },
			  headerFilterFunc: function(headerValue, rowValue, rowData, filterParams) {
				  // Filtre kutusu bo≈üsa, satƒ±rƒ± g√∂ster.
				  if($.trim(headerValue) === ""){
					return true;
				  }
				  
				  // Eƒüer rowValue null ise, onu bo≈ü string olarak deƒüerlendir.
				  var cellValue = (rowValue === null || rowValue === undefined) ? "" : rowValue.toString();
				  
				  // Ardƒ±ndan, normal regex tabanlƒ± e≈üle≈ütirme i≈ülemini uygulayabilirsiniz.
				  var regexStr;
				  if (headerValue.indexOf("*") === -1) {
					regexStr = ".*" + headerValue + ".*";
				  } else {
					regexStr = "^" + headerValue.replace(/\*/g, ".*") + "$";
				  }
				  var regex = new RegExp(regexStr, "i");
				  return regex.test(cellValue);
				},

              editor: select2Editor,           // select2Editor kullanƒ±mƒ±
              editorParams: { values: koleksiyonMapping },
              formatter: function(cell){
                var value = cell.getValue();
                return koleksiyonLookupMap[value] || value;
              },
              cellEdited: function(cell){
                console.log("KOLEKSIYON s√ºtunu d√ºzenlendi. Yeni deƒüer:", cell.getValue());
                triggerUpdate(cell);
              }
            },
			{ 
			  title: "ISIM", 
			  field: "NAME", 
			  headerFilter: "input", 
			  headerFilterFunc: function(headerValue, rowValue, rowData, filterParams){
				if($.trim(headerValue) === ""){
				  return true;
				}
				
				var regexStr;
				// Eƒüer headerValue i√ßerisinde "*" yoksa, contains mantƒ±ƒüƒ±yla filtrele: "*headerValue*"
				if (headerValue.indexOf("*") === -1) {
				  regexStr = ".*" + headerValue + ".*";
				} else {
				  // Eƒüer "*" karakteri varsa, kullanƒ±cƒ± tarafƒ±ndan girilen deƒüeri regex'e √ßevir
				  regexStr = "^" + headerValue.replace(/\*/g, ".*") + "$";
				}
				
				var regex = new RegExp(regexStr, "i");
				
				if(typeof rowValue !== "string"){
				  return false;
				}
				
				return regex.test(rowValue);
			  },
			  editor: "input", 
			  editable: true, 
			  width: 130,
			  vertAlign:"center",
			  cellClick: function(e, cell){
				cell.edit();
				console.log("ISIM h√ºcresine tƒ±klandƒ±. Deƒüer:", cell.getValue());
			  },
			  cellEdited: function(cell){
				console.log("ISIM s√ºtunu d√ºzenlendi. Yeni deƒüer:", cell.getValue());
				triggerUpdate(cell);
			  }
			},
			{ 
			  title: "DERI TIPI", 
			  field: "DERITIPI", 
			  headerFilter: "input", 
			  headerFilterFunc: function(headerValue, rowValue, rowData, filterParams){
				if($.trim(headerValue) === ""){
				  return true;
				}
				
				var regexStr;
				// Eƒüer headerValue i√ßerisinde "*" yoksa, contains mantƒ±ƒüƒ±yla filtrele: "*headerValue*"
				if (headerValue.indexOf("*") === -1) {
				  regexStr = ".*" + headerValue + ".*";
				} else {
				  // Eƒüer "*" karakteri varsa, kullanƒ±cƒ± tarafƒ±ndan girilen deƒüeri regex'e √ßevir
				  regexStr = "^" + headerValue.replace(/\*/g, ".*") + "$";
				}
				
				var regex = new RegExp(regexStr, "i");
				
				if(typeof rowValue !== "string"){
				  return false;
				}
				
				return regex.test(rowValue);
			  },
			  editor: "input", 
			  editable: true,
			  width: 130,
			  vertAlign:"center",
			  cellClick: function(e, cell){
				cell.edit();
				console.log("DERI TIPI h√ºcresine tƒ±klandƒ±. Deƒüer:", cell.getValue());
			  },
			  cellEdited: function(cell){
				console.log("DERI TIPI s√ºtunu d√ºzenlendi. Yeni deƒüer:", cell.getValue());
				triggerUpdate(cell);
			  }
			},
			{ 
			  title: "ISLENTI 1", 
			  field: "ISLENTI1", 
			  headerFilter: "input", 
			  headerFilterFunc: function(headerValue, rowValue, rowData, filterParams){
				if($.trim(headerValue) === ""){
				  return true;
				}
				
				var regexStr;
				// Eƒüer headerValue i√ßerisinde "*" yoksa, contains mantƒ±ƒüƒ±yla filtrele: "*headerValue*"
				if (headerValue.indexOf("*") === -1) {
				  regexStr = ".*" + headerValue + ".*";
				} else {
				  // Eƒüer "*" karakteri varsa, kullanƒ±cƒ± tarafƒ±ndan girilen deƒüeri regex'e √ßevir
				  regexStr = "^" + headerValue.replace(/\*/g, ".*") + "$";
				}
				
				var regex = new RegExp(regexStr, "i");
				
				if(typeof rowValue !== "string"){
				  return false;
				}
				
				return regex.test(rowValue);
			  },
			  editor: "input", 
			  editable: true, 
			  width: 130,
			  vertAlign:"center",
			  cellClick: function(e, cell){
				cell.edit();
				console.log("ISLENTI 1 h√ºcresine tƒ±klandƒ±. Deƒüer:", cell.getValue());
			  },
			  cellEdited: function(cell){
				console.log("ISLENTI 1 s√ºtunu d√ºzenlendi. Yeni deƒüer:", cell.getValue());
				triggerUpdate(cell);
			  }
			},
			{ 
			  title: "ISLENTI 2", 
			  field: "ISLENTI2", 
			  headerFilter: "input", 
			  headerFilterFunc: function(headerValue, rowValue, rowData, filterParams){
				if($.trim(headerValue) === ""){
				  return true;
				}
				
				var regexStr;
				// Eƒüer headerValue i√ßerisinde "*" yoksa, contains mantƒ±ƒüƒ±yla filtrele: "*headerValue*"
				if (headerValue.indexOf("*") === -1) {
				  regexStr = ".*" + headerValue + ".*";
				} else {
				  // Eƒüer "*" karakteri varsa, kullanƒ±cƒ± tarafƒ±ndan girilen deƒüeri regex'e √ßevir
				  regexStr = "^" + headerValue.replace(/\*/g, ".*") + "$";
				}
				
				var regex = new RegExp(regexStr, "i");
				
				if(typeof rowValue !== "string"){
				  return false;
				}
				
				return regex.test(rowValue);
			  },
			  editor: "input", 
			  editable: true, 
			  width: 130,
			  vertAlign:"center",
			  cellClick: function(e, cell){
				cell.edit();
				console.log("ISLENTI 2 h√ºcresine tƒ±klandƒ±. Deƒüer:", cell.getValue());
			  },
			  cellEdited: function(cell){
				console.log("ISLENTI 2 s√ºtunu d√ºzenlendi. Yeni deƒüer:", cell.getValue());
				triggerUpdate(cell);
			  }
			},
			{ 
			  title: "HOM STOK", 
			  field: "HOM", 
			  headerFilter: "input",
			  headerFilterFunc: function(headerValue, rowValue, rowData, filterParams) {
				// Filtre kutusu bo≈üsa, satƒ±rƒ± g√∂ster.
				if ($.trim(headerValue) === "") {
				  return true;
				}
				
				// Satƒ±rdaki deƒüeri sayƒ± tipine √ßeviriyoruz.
				var num = parseFloat(rowValue);
				if (isNaN(num)) {
				  return false;
				}
				
				headerValue = headerValue.trim();
				
				// NOT EQUAL (e≈üit deƒüil) kontrol√º: Eƒüer headerValue "<>" ile ba≈ülƒ±yorsa
				if (headerValue.startsWith("<>")) {
				  var threshold = parseFloat(headerValue.substring(2).trim());
				  if (isNaN(threshold)) {
					return false;
				  }
				  return num !== threshold;
				}
				
				// Eƒüer headerValue ">" ile ba≈ülƒ±yorsa:
				if (headerValue.startsWith(">")) {
				  var threshold = parseFloat(headerValue.substring(1).trim());
				  if (isNaN(threshold)) {
					return false;
				  }
				  return num > threshold;
				}
				
				// Eƒüer headerValue "<" ile ba≈ülƒ±yorsa:
				if (headerValue.startsWith("<")) {
				  var threshold = parseFloat(headerValue.substring(1).trim());
				  if (isNaN(threshold)) {
					return false;
				  }
				  return num < threshold;
				}
				
				// Eƒüer aralƒ±k belirtimi varsa ("DEƒûER - DEƒûER")
				if (headerValue.indexOf("-") !== -1) {
				  var parts = headerValue.split("-");
				  if (parts.length !== 2) {
					return false;
				  }
				  var min = parseFloat(parts[0].trim());
				  var max = parseFloat(parts[1].trim());
				  if (isNaN(min) || isNaN(max)) {
					return false;
				  }
				  return num >= min && num <= max;
				}
				
				// Aksi durumda: girilen deƒüere tam e≈üle≈üme kontrol√º
				var threshold = parseFloat(headerValue);
				if (isNaN(threshold)) {
				  return false;
				}
				return num === threshold;
			  },
			  editor: false, 
			  frozen: false, 
			  vertAlign: "center",
			  width: 130 
			},
			{ 
			  title: "MERKEZ STOK", 
			  field: "MRKZ", 
			  headerFilter: "input",
			  headerFilterFunc: function(headerValue, rowValue, rowData, filterParams) {
				// Filtre kutusu bo≈üsa, satƒ±rƒ± g√∂ster.
				if ($.trim(headerValue) === "") {
				  return true;
				}
				
				// Satƒ±rdaki deƒüeri sayƒ± tipine √ßeviriyoruz.
				var num = parseFloat(rowValue);
				if (isNaN(num)) {
				  return false;
				}
				
				headerValue = headerValue.trim();
				
				// NOT EQUAL (e≈üit deƒüil) kontrol√º: Eƒüer headerValue "<>" ile ba≈ülƒ±yorsa
				if (headerValue.startsWith("<>")) {
				  var threshold = parseFloat(headerValue.substring(2).trim());
				  if (isNaN(threshold)) {
					return false;
				  }
				  return num !== threshold;
				}
				
				// Eƒüer headerValue ">" ile ba≈ülƒ±yorsa:
				if (headerValue.startsWith(">")) {
				  var threshold = parseFloat(headerValue.substring(1).trim());
				  if (isNaN(threshold)) {
					return false;
				  }
				  return num > threshold;
				}
				
				// Eƒüer headerValue "<" ile ba≈ülƒ±yorsa:
				if (headerValue.startsWith("<")) {
				  var threshold = parseFloat(headerValue.substring(1).trim());
				  if (isNaN(threshold)) {
					return false;
				  }
				  return num < threshold;
				}
				
				// Eƒüer aralƒ±k belirtimi varsa ("DEƒûER - DEƒûER")
				if (headerValue.indexOf("-") !== -1) {
				  var parts = headerValue.split("-");
				  if (parts.length !== 2) {
					return false;
				  }
				  var min = parseFloat(parts[0].trim());
				  var max = parseFloat(parts[1].trim());
				  if (isNaN(min) || isNaN(max)) {
					return false;
				  }
				  return num >= min && num <= max;
				}
				
				// Aksi durumda: girilen deƒüere tam e≈üle≈üme kontrol√º
				var threshold = parseFloat(headerValue);
				if (isNaN(threshold)) {
				  return false;
				}
				return num === threshold;
			  },
			  editor: false, 
			  frozen: false, 
			  vertAlign: "center",
			  width: 130 
			},
			{ 
			  title: "SHW STOK", 
			  field: "SHWR", 
			  headerFilter: "input",
			  headerFilterFunc: function(headerValue, rowValue, rowData, filterParams) {
				// Filtre kutusu bo≈üsa, satƒ±rƒ± g√∂ster.
				if ($.trim(headerValue) === "") {
				  return true;
				}
				
				// Satƒ±rdaki deƒüeri sayƒ± tipine √ßeviriyoruz.
				var num = parseFloat(rowValue);
				if (isNaN(num)) {
				  return false;
				}
				
				headerValue = headerValue.trim();
				
				// NOT EQUAL (e≈üit deƒüil) kontrol√º: Eƒüer headerValue "<>" ile ba≈ülƒ±yorsa
				if (headerValue.startsWith("<>")) {
				  var threshold = parseFloat(headerValue.substring(2).trim());
				  if (isNaN(threshold)) {
					return false;
				  }
				  return num !== threshold;
				}
				
				// Eƒüer headerValue ">" ile ba≈ülƒ±yorsa:
				if (headerValue.startsWith(">")) {
				  var threshold = parseFloat(headerValue.substring(1).trim());
				  if (isNaN(threshold)) {
					return false;
				  }
				  return num > threshold;
				}
				
				// Eƒüer headerValue "<" ile ba≈ülƒ±yorsa:
				if (headerValue.startsWith("<")) {
				  var threshold = parseFloat(headerValue.substring(1).trim());
				  if (isNaN(threshold)) {
					return false;
				  }
				  return num < threshold;
				}
				
				// Eƒüer aralƒ±k belirtimi varsa ("DEƒûER - DEƒûER")
				if (headerValue.indexOf("-") !== -1) {
				  var parts = headerValue.split("-");
				  if (parts.length !== 2) {
					return false;
				  }
				  var min = parseFloat(parts[0].trim());
				  var max = parseFloat(parts[1].trim());
				  if (isNaN(min) || isNaN(max)) {
					return false;
				  }
				  return num >= min && num <= max;
				}
				
				// Aksi durumda: girilen deƒüere tam e≈üle≈üme kontrol√º
				var threshold = parseFloat(headerValue);
				if (isNaN(threshold)) {
				  return false;
				}
				return num === threshold;
			  },
			  editor: false, 
			  frozen: false, 
			  vertAlign: "center",
			  width: 130 
			},
			{ 
			  title: "SHWAKS STOK", 
			  field: "SHWAKS", 
			  headerFilter: "input",
			  headerFilterFunc: function(headerValue, rowValue, rowData, filterParams) {
				// Filtre kutusu bo≈üsa, satƒ±rƒ± g√∂ster.
				if ($.trim(headerValue) === "") {
				  return true;
				}
				
				// Satƒ±rdaki deƒüeri sayƒ± tipine √ßeviriyoruz.
				var num = parseFloat(rowValue);
				if (isNaN(num)) {
				  return false;
				}
				
				headerValue = headerValue.trim();
				
				// NOT EQUAL (e≈üit deƒüil) kontrol√º: Eƒüer headerValue "<>" ile ba≈ülƒ±yorsa
				if (headerValue.startsWith("<>")) {
				  var threshold = parseFloat(headerValue.substring(2).trim());
				  if (isNaN(threshold)) {
					return false;
				  }
				  return num !== threshold;
				}
				
				// Eƒüer headerValue ">" ile ba≈ülƒ±yorsa:
				if (headerValue.startsWith(">")) {
				  var threshold = parseFloat(headerValue.substring(1).trim());
				  if (isNaN(threshold)) {
					return false;
				  }
				  return num > threshold;
				}
				
				// Eƒüer headerValue "<" ile ba≈ülƒ±yorsa:
				if (headerValue.startsWith("<")) {
				  var threshold = parseFloat(headerValue.substring(1).trim());
				  if (isNaN(threshold)) {
					return false;
				  }
				  return num < threshold;
				}
				
				// Eƒüer aralƒ±k belirtimi varsa ("DEƒûER - DEƒûER")
				if (headerValue.indexOf("-") !== -1) {
				  var parts = headerValue.split("-");
				  if (parts.length !== 2) {
					return false;
				  }
				  var min = parseFloat(parts[0].trim());
				  var max = parseFloat(parts[1].trim());
				  if (isNaN(min) || isNaN(max)) {
					return false;
				  }
				  return num >= min && num <= max;
				}
				
				// Aksi durumda: girilen deƒüere tam e≈üle≈üme kontrol√º
				var threshold = parseFloat(headerValue);
				if (isNaN(threshold)) {
				  return false;
				}
				return num === threshold;
			  },
			  editor: false, 
			  frozen: false, 
			  vertAlign: "center",
			  width: 130 
			},
			{ 
			  title: "CUMBA STOK", 
			  field: "CUMBA", 
			  headerFilter: "input",
			  headerFilterFunc: function(headerValue, rowValue, rowData, filterParams) {
				// Filtre kutusu bo≈üsa, satƒ±rƒ± g√∂ster.
				if ($.trim(headerValue) === "") {
				  return true;
				}
				
				// Satƒ±rdaki deƒüeri sayƒ± tipine √ßeviriyoruz.
				var num = parseFloat(rowValue);
				if (isNaN(num)) {
				  return false;
				}
				
				headerValue = headerValue.trim();
				
				// NOT EQUAL (e≈üit deƒüil) kontrol√º: Eƒüer headerValue "<>" ile ba≈ülƒ±yorsa
				if (headerValue.startsWith("<>")) {
				  var threshold = parseFloat(headerValue.substring(2).trim());
				  if (isNaN(threshold)) {
					return false;
				  }
				  return num !== threshold;
				}
				
				// Eƒüer headerValue ">" ile ba≈ülƒ±yorsa:
				if (headerValue.startsWith(">")) {
				  var threshold = parseFloat(headerValue.substring(1).trim());
				  if (isNaN(threshold)) {
					return false;
				  }
				  return num > threshold;
				}
				
				// Eƒüer headerValue "<" ile ba≈ülƒ±yorsa:
				if (headerValue.startsWith("<")) {
				  var threshold = parseFloat(headerValue.substring(1).trim());
				  if (isNaN(threshold)) {
					return false;
				  }
				  return num < threshold;
				}
				
				// Eƒüer aralƒ±k belirtimi varsa ("DEƒûER - DEƒûER")
				if (headerValue.indexOf("-") !== -1) {
				  var parts = headerValue.split("-");
				  if (parts.length !== 2) {
					return false;
				  }
				  var min = parseFloat(parts[0].trim());
				  var max = parseFloat(parts[1].trim());
				  if (isNaN(min) || isNaN(max)) {
					return false;
				  }
				  return num >= min && num <= max;
				}
				
				// Aksi durumda: girilen deƒüere tam e≈üle≈üme kontrol√º
				var threshold = parseFloat(headerValue);
				if (isNaN(threshold)) {
				  return false;
				}
				return num === threshold;
			  },
			  editor: false, 
			  frozen: false, 
			  vertAlign: "center",
			  width: 130 
			},
			{
			  title: "ISLENMIS DEPO",
			  field: "ISD",
			  headerFilter: "input",
			  headerFilterFunc: function(headerValue, rowValue, rowData, filterParams) {
				// Filtre kutusu bo≈üsa, satƒ±rƒ± g√∂ster.
				if ($.trim(headerValue) === "") {
				  return true;
				}
				
				// Satƒ±rdaki deƒüeri sayƒ± tipine √ßeviriyoruz.
				var num = parseFloat(rowValue);
				if (isNaN(num)) {
				  return false;
				}
				
				headerValue = headerValue.trim();
				
				// NOT EQUAL (e≈üit deƒüil) kontrol√º: Eƒüer headerValue "<>" ile ba≈ülƒ±yorsa
				if (headerValue.startsWith("<>")) {
				  var threshold = parseFloat(headerValue.substring(2).trim());
				  if (isNaN(threshold)) {
					return false;
				  }
				  return num !== threshold;
				}
				
				// Eƒüer headerValue ">" ile ba≈ülƒ±yorsa:
				if (headerValue.startsWith(">")) {
				  var threshold = parseFloat(headerValue.substring(1).trim());
				  if (isNaN(threshold)) {
					return false;
				  }
				  return num > threshold;
				}
				
				// Eƒüer headerValue "<" ile ba≈ülƒ±yorsa:
				if (headerValue.startsWith("<")) {
				  var threshold = parseFloat(headerValue.substring(1).trim());
				  if (isNaN(threshold)) {
					return false;
				  }
				  return num < threshold;
				}
				
				// Eƒüer aralƒ±k belirtimi varsa ("DEƒûER - DEƒûER")
				if (headerValue.indexOf("-") !== -1) {
				  var parts = headerValue.split("-");
				  if (parts.length !== 2) {
					return false;
				  }
				  var min = parseFloat(parts[0].trim());
				  var max = parseFloat(parts[1].trim());
				  if (isNaN(min) || isNaN(max)) {
					return false;
				  }
				  return num >= min && num <= max;
				}
				
				// Aksi durumda: girilen deƒüere tam e≈üle≈üme kontrol√º
				var threshold = parseFloat(headerValue);
				if (isNaN(threshold)) {
				  return false;
				}
				return num === threshold;
			  },
			  editor: false,
			  frozen: false,
			  vertAlign: "center",
			  width: 130 
			},
			{ 
			  title: "UK STOK", 
			  field: "UK", 
			  headerFilter: "input",
			  headerFilterFunc: function(headerValue, rowValue, rowData, filterParams) {
				// Filtre kutusu bo≈üsa, satƒ±rƒ± g√∂ster.
				if ($.trim(headerValue) === "") {
				  return true;
				}
				
				// Satƒ±rdaki deƒüeri sayƒ± tipine √ßeviriyoruz.
				var num = parseFloat(rowValue);
				if (isNaN(num)) {
				  return false;
				}
				
				headerValue = headerValue.trim();
				
				// NOT EQUAL (e≈üit deƒüil) kontrol√º: Eƒüer headerValue "<>" ile ba≈ülƒ±yorsa
				if (headerValue.startsWith("<>")) {
				  var threshold = parseFloat(headerValue.substring(2).trim());
				  if (isNaN(threshold)) {
					return false;
				  }
				  return num !== threshold;
				}
				
				// Eƒüer headerValue ">" ile ba≈ülƒ±yorsa:
				if (headerValue.startsWith(">")) {
				  var threshold = parseFloat(headerValue.substring(1).trim());
				  if (isNaN(threshold)) {
					return false;
				  }
				  return num > threshold;
				}
				
				// Eƒüer headerValue "<" ile ba≈ülƒ±yorsa:
				if (headerValue.startsWith("<")) {
				  var threshold = parseFloat(headerValue.substring(1).trim());
				  if (isNaN(threshold)) {
					return false;
				  }
				  return num < threshold;
				}
				
				// Eƒüer aralƒ±k belirtimi varsa ("DEƒûER - DEƒûER")
				if (headerValue.indexOf("-") !== -1) {
				  var parts = headerValue.split("-");
				  if (parts.length !== 2) {
					return false;
				  }
				  var min = parseFloat(parts[0].trim());
				  var max = parseFloat(parts[1].trim());
				  if (isNaN(min) || isNaN(max)) {
					return false;
				  }
				  return num >= min && num <= max;
				}
				
				// Aksi durumda: girilen deƒüere tam e≈üle≈üme kontrol√º
				var threshold = parseFloat(headerValue);
				if (isNaN(threshold)) {
				  return false;
				}
				return num === threshold;
			  },
			  editor: false, 
			  frozen: false, 
			  vertAlign: "center",
			  width: 130 
			},
			{ 
			  title: "ANADEPO STOK", 
			  field: "AN", 
			  headerFilter: "input",
			  headerFilterFunc: function(headerValue, rowValue, rowData, filterParams) {
				// Filtre kutusu bo≈üsa, satƒ±rƒ± g√∂ster.
				if ($.trim(headerValue) === "") {
				  return true;
				}
				
				// Satƒ±rdaki deƒüeri sayƒ± tipine √ßeviriyoruz.
				var num = parseFloat(rowValue);
				if (isNaN(num)) {
				  return false;
				}
				
				headerValue = headerValue.trim();
				
				// NOT EQUAL (e≈üit deƒüil) kontrol√º: Eƒüer headerValue "<>" ile ba≈ülƒ±yorsa
				if (headerValue.startsWith("<>")) {
				  var threshold = parseFloat(headerValue.substring(2).trim());
				  if (isNaN(threshold)) {
					return false;
				  }
				  return num !== threshold;
				}
				
				// Eƒüer headerValue ">" ile ba≈ülƒ±yorsa:
				if (headerValue.startsWith(">")) {
				  var threshold = parseFloat(headerValue.substring(1).trim());
				  if (isNaN(threshold)) {
					return false;
				  }
				  return num > threshold;
				}
				
				// Eƒüer headerValue "<" ile ba≈ülƒ±yorsa:
				if (headerValue.startsWith("<")) {
				  var threshold = parseFloat(headerValue.substring(1).trim());
				  if (isNaN(threshold)) {
					return false;
				  }
				  return num < threshold;
				}
				
				// Eƒüer aralƒ±k belirtimi varsa ("DEƒûER - DEƒûER")
				if (headerValue.indexOf("-") !== -1) {
				  var parts = headerValue.split("-");
				  if (parts.length !== 2) {
					return false;
				  }
				  var min = parseFloat(parts[0].trim());
				  var max = parseFloat(parts[1].trim());
				  if (isNaN(min) || isNaN(max)) {
					return false;
				  }
				  return num >= min && num <= max;
				}
				
				// Aksi durumda: girilen deƒüere tam e≈üle≈üme kontrol√º
				var threshold = parseFloat(headerValue);
				if (isNaN(threshold)) {
				  return false;
				}
				return num === threshold;
			  },
			  editor: false, 
			  frozen: false, 
			  vertAlign: "center",
			  width: 130 
			},
			{ 
			  title: "SV STOK", 
			  field: "SV", 
			  headerFilter: "input",
			  headerFilterFunc: function(headerValue, rowValue, rowData, filterParams) {
				// Filtre kutusu bo≈üsa, satƒ±rƒ± g√∂ster.
				if ($.trim(headerValue) === "") {
				  return true;
				}
				
				// Satƒ±rdaki deƒüeri sayƒ± tipine √ßeviriyoruz.
				var num = parseFloat(rowValue);
				if (isNaN(num)) {
				  return false;
				}
				
				headerValue = headerValue.trim();
				
				// NOT EQUAL (e≈üit deƒüil) kontrol√º: Eƒüer headerValue "<>" ile ba≈ülƒ±yorsa
				if (headerValue.startsWith("<>")) {
				  var threshold = parseFloat(headerValue.substring(2).trim());
				  if (isNaN(threshold)) {
					return false;
				  }
				  return num !== threshold;
				}
				
				// Eƒüer headerValue ">" ile ba≈ülƒ±yorsa:
				if (headerValue.startsWith(">")) {
				  var threshold = parseFloat(headerValue.substring(1).trim());
				  if (isNaN(threshold)) {
					return false;
				  }
				  return num > threshold;
				}
				
				// Eƒüer headerValue "<" ile ba≈ülƒ±yorsa:
				if (headerValue.startsWith("<")) {
				  var threshold = parseFloat(headerValue.substring(1).trim());
				  if (isNaN(threshold)) {
					return false;
				  }
				  return num < threshold;
				}
				
				// Eƒüer aralƒ±k belirtimi varsa ("DEƒûER - DEƒûER")
				if (headerValue.indexOf("-") !== -1) {
				  var parts = headerValue.split("-");
				  if (parts.length !== 2) {
					return false;
				  }
				  var min = parseFloat(parts[0].trim());
				  var max = parseFloat(parts[1].trim());
				  if (isNaN(min) || isNaN(max)) {
					return false;
				  }
				  return num >= min && num <= max;
				}
				
				// Aksi durumda: girilen deƒüere tam e≈üle≈üme kontrol√º
				var threshold = parseFloat(headerValue);
				if (isNaN(threshold)) {
				  return false;
				}
				return num === threshold;
			  },
			  editor: false, 
			  frozen: false, 
			  vertAlign: "center",
			  width: 130 
			},
            { 
			  title: "PRK TL", 
			  field: "SFIYAT1", 
			  headerFilter: "input",
			  headerFilterFunc: function(headerValue, rowValue, rowData, filterParams){
				// Filtre kutusu bo≈üsa, satƒ±rƒ± g√∂ster.
				if($.trim(headerValue) === ""){
				  return true;
				}
				
				// Satƒ±rdaki deƒüeri sayƒ± tipine √ßeviriyoruz.
				var num = parseFloat(rowValue);
				if(isNaN(num)){
				  return false;
				}
				
				headerValue = headerValue.trim();
				
				// Eƒüer headerValue ">" ile ba≈ülƒ±yorsa:
				if(headerValue.startsWith(">")){
				  var threshold = parseFloat(headerValue.substring(1).trim());
				  if(isNaN(threshold)){
					return false;
				  }
				  return num > threshold;
				}
				
				// Eƒüer headerValue "<" ile ba≈ülƒ±yorsa:
				if(headerValue.startsWith("<")){
				  var threshold = parseFloat(headerValue.substring(1).trim());
				  if(isNaN(threshold)){
					return false;
				  }
				  return num < threshold;
				}
				
				// Eƒüer aralƒ±k belirtimi varsa ("DEƒûER - DEƒûER")
				if(headerValue.indexOf("-") !== -1){
				  var parts = headerValue.split("-");
				  if(parts.length !== 2) {
					return false;
				  }
				  var min = parseFloat(parts[0].trim());
				  var max = parseFloat(parts[1].trim());
				  if(isNaN(min) || isNaN(max)){
					return false;
				  }
				  return num >= min && num <= max;
				}
				
				// Aksi durumda: girmi≈ü olunan deƒüere e≈üitlik kontrol√º (tam e≈üle≈üme)
				var threshold = parseFloat(headerValue);
				if(isNaN(threshold)){
				  return false;
				}
				return num === threshold;
			  },
			  editor: false, 
			  frozen: false, 
			  vertAlign: "center",
			  width: 130 
			},
			{ 
			  title: "PRK USD", 
			  field: "SFIYAT4", 
			  headerFilter: "input",
			  headerFilterFunc: function(headerValue, rowValue, rowData, filterParams){
				// Filtre kutusu bo≈üsa, satƒ±rƒ± g√∂ster.
				if($.trim(headerValue) === ""){
				  return true;
				}
				
				// Satƒ±rdaki deƒüeri sayƒ± tipine √ßeviriyoruz.
				var num = parseFloat(rowValue);
				if(isNaN(num)){
				  return false;
				}
				
				headerValue = headerValue.trim();
				
				// Eƒüer headerValue ">" ile ba≈ülƒ±yorsa:
				if(headerValue.startsWith(">")){
				  var threshold = parseFloat(headerValue.substring(1).trim());
				  if(isNaN(threshold)){
					return false;
				  }
				  return num > threshold;
				}
				
				// Eƒüer headerValue "<" ile ba≈ülƒ±yorsa:
				if(headerValue.startsWith("<")){
				  var threshold = parseFloat(headerValue.substring(1).trim());
				  if(isNaN(threshold)){
					return false;
				  }
				  return num < threshold;
				}
				
				// Eƒüer aralƒ±k belirtimi varsa ("DEƒûER - DEƒûER")
				if(headerValue.indexOf("-") !== -1){
				  var parts = headerValue.split("-");
				  if(parts.length !== 2) {
					return false;
				  }
				  var min = parseFloat(parts[0].trim());
				  var max = parseFloat(parts[1].trim());
				  if(isNaN(min) || isNaN(max)){
					return false;
				  }
				  return num >= min && num <= max;
				}
				
				// Aksi durumda: girmi≈ü olunan deƒüere e≈üitlik kontrol√º (tam e≈üle≈üme)
				var threshold = parseFloat(headerValue);
				if(isNaN(threshold)){
				  return false;
				}
				return num === threshold;
			  },
			  editor: false, 
			  frozen: false, 
			  vertAlign: "center",
			  width: 130 
			},
            { 
			  title: "PRK EUR", 
			  field: "SFIYAT5", 
			  headerFilter: "input",
			  headerFilterFunc: function(headerValue, rowValue, rowData, filterParams){
				// Filtre kutusu bo≈üsa, satƒ±rƒ± g√∂ster.
				if($.trim(headerValue) === ""){
				  return true;
				}
				
				// Satƒ±rdaki deƒüeri sayƒ± tipine √ßeviriyoruz.
				var num = parseFloat(rowValue);
				if(isNaN(num)){
				  return false;
				}
				
				headerValue = headerValue.trim();
				
				// Eƒüer headerValue ">" ile ba≈ülƒ±yorsa:
				if(headerValue.startsWith(">")){
				  var threshold = parseFloat(headerValue.substring(1).trim());
				  if(isNaN(threshold)){
					return false;
				  }
				  return num > threshold;
				}
				
				// Eƒüer headerValue "<" ile ba≈ülƒ±yorsa:
				if(headerValue.startsWith("<")){
				  var threshold = parseFloat(headerValue.substring(1).trim());
				  if(isNaN(threshold)){
					return false;
				  }
				  return num < threshold;
				}
				
				// Eƒüer aralƒ±k belirtimi varsa ("DEƒûER - DEƒûER")
				if(headerValue.indexOf("-") !== -1){
				  var parts = headerValue.split("-");
				  if(parts.length !== 2) {
					return false;
				  }
				  var min = parseFloat(parts[0].trim());
				  var max = parseFloat(parts[1].trim());
				  if(isNaN(min) || isNaN(max)){
					return false;
				  }
				  return num >= min && num <= max;
				}
				
				// Aksi durumda: girmi≈ü olunan deƒüere e≈üitlik kontrol√º (tam e≈üle≈üme)
				var threshold = parseFloat(headerValue);
				if(isNaN(threshold)){
				  return false;
				}
				return num === threshold;
			  },
			  editor: false, 
			  frozen: false, 
			  vertAlign: "center",
			  width: 130 
			},
			{ 
			  title: "MLYT USD", 
			  field: "HSP_MALIYET_USD", 
			  headerFilter: "input",
			  headerFilterFunc: function(headerValue, rowValue, rowData, filterParams){
				// Filtre kutusu bo≈üsa, satƒ±rƒ± g√∂ster.
				if($.trim(headerValue) === ""){
				  return true;
				}
				
				// Satƒ±rdaki deƒüeri sayƒ± tipine √ßeviriyoruz.
				var num = parseFloat(rowValue);
				if(isNaN(num)){
				  return false;
				}
				
				headerValue = headerValue.trim();
				
				// Eƒüer headerValue ">" ile ba≈ülƒ±yorsa:
				if(headerValue.startsWith(">")){
				  var threshold = parseFloat(headerValue.substring(1).trim());
				  if(isNaN(threshold)){
					return false;
				  }
				  return num > threshold;
				}
				
				// Eƒüer headerValue "<" ile ba≈ülƒ±yorsa:
				if(headerValue.startsWith("<")){
				  var threshold = parseFloat(headerValue.substring(1).trim());
				  if(isNaN(threshold)){
					return false;
				  }
				  return num < threshold;
				}
				
				// Eƒüer aralƒ±k belirtimi varsa ("DEƒûER - DEƒûER")
				if(headerValue.indexOf("-") !== -1){
				  var parts = headerValue.split("-");
				  if(parts.length !== 2) {
					return false;
				  }
				  var min = parseFloat(parts[0].trim());
				  var max = parseFloat(parts[1].trim());
				  if(isNaN(min) || isNaN(max)){
					return false;
				  }
				  return num >= min && num <= max;
				}
				
				// Aksi durumda: girmi≈ü olunan deƒüere e≈üitlik kontrol√º (tam e≈üle≈üme)
				var threshold = parseFloat(headerValue);
				if(isNaN(threshold)){
				  return false;
				}
				return num === threshold;
			  },
			  editor: false, 
			  frozen: false, 
			  vertAlign: "center",
			  width: 130 
			},
			{
			  title: "Tedarik Y√∂ntemi",
			  field: "TEDARIK_YONTEMI",
			  headerFilter: "select",
			  headerFilterParams: { values: tedarikyontemiMapping },

			  editable: true,                    // h√ºcre d√ºzenlenebilir olsun
			  editor: select2Editor,             // select2Editor kullan
			  editorParams: { values: tedarikyontemiMapping },
			  cellClick: function(e, cell) {     // tƒ±klayƒ±nca edit moduna ge√ß
				cell.edit();
			  },

			  formatter: "lookup",               // h√ºcrede label g√∂ster
			  formatterParams: { lookup: tedarikyontemiLookupMap },

			  cellEdited: function(cell) {       // deƒüer deƒüi≈ütiƒüinde
				// yeni ham deƒüer cell.getValue() ile 0 veya 1 olarak gelecek
				triggerUpdate(cell);             // kendi g√ºncelleme fonksiyonunu √ßaƒüƒ±r
			  }
			},

			
			{
			  title: "G√ºncel Koleksiyon",
			  field: "KOLEKSIYON25",
			  hozAlign: "center",
			  align: "center",
			  // √ñzel formatter: Gelen deƒüere g√∂re checkbox i≈üaretleme
			  formatter: function(cell, formatterParams, onRendered){
				var value = cell.getValue();
				return `<input type="checkbox" ${value == 1 ? "checked" : ""} />`;
			  },
			  // √ñzel editor: D√ºzenleme moduna ge√ßtiƒüinde checkbox g√∂sterip, deƒüi≈üiklikte deƒüeri g√ºncelliyor
			  editor: function(cell, onRendered, success, cancel){
				var input = document.createElement("input");
				input.setAttribute("type", "checkbox");
				// Ba≈ülangƒ±√ß deƒüerini ata
				input.checked = cell.getValue() == 1;
				// Deƒüi≈üiklik olduƒüunda deƒüeri g√ºncelle ve kaydet
				input.addEventListener("change", function(){
				  success(input.checked ? 1 : 0);
				});
				onRendered(function(){
				  input.focus();
				});
				return input;
			  },
			  cellEdited: function(cell){
				// Deƒüer deƒüi≈ütiƒüinde update i≈ülemini tetikle
				triggerUpdate(cell);
			  },
			  // ƒ∞steƒüe baƒülƒ±: headerFilter olarak da checkbox filter kullanmak istersen
			  headerFilter: "input",
			  headerFilterPlaceholder: "1 veya 0"
			},

            { title: "ƒ∞ngilizce A√ßƒ±klama", field: "ACIKLAMA", headerFilter: "input",
			vertAlign:"center",
			headerFilterFunc: function(headerValue, rowValue, rowData, filterParams){
				if($.trim(headerValue) === ""){
				  return true;
				}
				
				var regexStr;
				// Eƒüer headerValue i√ßerisinde "*" yoksa, contains mantƒ±ƒüƒ±yla filtrele: "*headerValue*"
				if (headerValue.indexOf("*") === -1) {
				  regexStr = ".*" + headerValue + ".*";
				} else {
				  // Eƒüer "*" karakteri varsa, kullanƒ±cƒ± tarafƒ±ndan girilen deƒüeri regex'e √ßevir
				  regexStr = "^" + headerValue.replace(/\*/g, ".*") + "$";
				}
				
				var regex = new RegExp(regexStr, "i");
				
				if(typeof rowValue !== "string"){
				  return false;
				}
				
				return regex.test(rowValue);
			  },
			editor: "input", width: 375 }
          ];
          
          // 3) Tercihlere g√∂re sƒ±ralayƒ±p g√∂r√ºn√ºrl√ºƒü√º ayarla
			columns.sort((a,b)=>{
			  const oa = prefMap[a.field]?.ColumnOrder ?? 0;
			  const ob = prefMap[b.field]?.ColumnOrder ?? 0;
			  return oa - ob;
			});
			columns.forEach(col=>{
			  if(prefMap[col.field] !== undefined){
				col.visible = prefMap[col.field].IsVisible;
			  }
			});

			// 2) Tabulator instantiation
			var table = new Tabulator("#hotContainer", {
			  height: "800px",
			  layout: "fitDataTable",
			  data: skartData,
			  movableColumns: true,             // s√ºtun s√ºr√ºkle bƒ±rak
			  persistenceMode: "local",         // localStorage‚Äôda sakla
			  persistenceID:   "stokKartiTbl",  // localStorage anahtarƒ±
			  persistence: {
				columns: true                   // s√ºtun sƒ±rasƒ±/g√∂r√ºn√ºrl√ºƒü√º/geni≈üliƒüi
			  },
			  
			  renderComplete: function(){
				// ƒ∞lk y√ºklemede restore et
				this.restorePersistence();
				// Ardƒ±ndan manuel olarak bir kez de persist() √ßaƒüƒ±r
				this.persist();
			  },

			  columns: columns,  // sizin daha √∂nce tanƒ±mladƒ±ƒüƒ±nƒ±z columns dizisi

			  // 4) (Opsiyonel) H√ºcre d√ºzenleme callback‚Äôleri
			  cellEditing: function(cell){ /* ... */ },
			  cellEdited:  function(cell){ /* ... */ },
			});
			// 5) Her hareket/g√∂r√ºn√ºrl√ºk deƒüi≈üiminde kaydet
				const persist = () => {
					const newPrefs = table.getColumns().map((col, idx)=>({
					  columnName:  col.getField(),
					  columnOrder: idx,
					  isVisible:   col.isVisible()
					}));
					saveUserPreferences(userId, tableName, newPrefs);
				  };
			  table.on('columnMoved', persist);
			  table.on('columnVisibilityChanged', persist);

			  // 7) refresh butonu
			  document.getElementById('refreshTable').addEventListener('click', ()=>{
				loadSkartData(d=> table.replaceData(d));
			  });

          // G√ºncelleme i≈ülemini tetikleyen fonksiyon
          function triggerUpdate(cell) {
            var rowData = cell.getRow().getData();
            console.log("G√ºncelleme tetiklendi. Row verisi:", rowData);
            var recordToUpdate = {
              kod: rowData.KOD,
              ad: rowData.ADI,
			  ozel1: rowData.OZEL1,
              ozel2: rowData.OZEL2,
              ozel3: rowData.OZEL3,
              ozel4: rowData.OZEL4,
              ozel5: rowData.OZEL5,
              ozel6: rowData.OZEL6,
              aksesuar2: rowData.AKSESUAR2,
              aksesuar3: rowData.AKSESUAR3,
              ozel8: rowData.OZEL8,
              ozel9: rowData.OZEL9,
              ozel10: rowData.OZEL10,
              koleksiyon: rowData.KOLEKSIYON,              
              koleksiyon25: rowData.KOLEKSIYON25,
			  aciklama: rowData.ACIKLAMA,
			  name: rowData.NAME,
			  deritipi: rowData.DERITIPI,
			  islenti1: rowData.ISLENTI1,
			  islenti2: rowData.ISLENTI2,
			  tedarikyontemi: rowData.TEDARIK_YONTEMI
            };

            $.ajax({
              url: '/api/skart/update',
              method: 'POST',
              contentType: 'application/json',
              data: JSON.stringify(recordToUpdate),
              success: function(resp){
                if(resp.success) {
                  console.log("Satƒ±r g√ºncellendi: " + rowData.KOD );
                } else {
                  console.error("G√ºncelleme hatasƒ±: " + resp.message);
                }
              },
              error: function(err){
                console.error("AJAX hatasƒ±:", err);
              }
            });
          } // triggerUpdate sonu
		  }); // loadLookupData(basamak1mapping) kapanƒ±≈üƒ± 
		  }); // loadLookupData(253-TEDARIKYONTEMI) kapanƒ±≈üƒ± 
		  }); // loadLookupData(250-KOLEKSIYON) kapanƒ±≈üƒ± 
		  }); // loadLookupData(79) kapanƒ±≈üƒ± 
		  }); // loadLookupData(78) kapanƒ±≈üƒ± 
		  }); // loadLookupData(77) kapanƒ±≈üƒ± 
		  }); // loadLookupData(75) kapanƒ±≈üƒ± 
         }); // loadLookupData(74) kapanƒ±≈üƒ± 
        }); // loadLookupData(73) kapanƒ±≈üƒ±
      }); // loadLookupData(72) kapanƒ±≈üƒ±
    }); // loadLookupData(71) kapanƒ±≈üƒ±
	}); // loadLookupData(70) kapanƒ±≈üƒ±
  }); // loadSkartData kapanƒ±≈üƒ±
}


  </script>

<script>
async function showKodPopup(kod, x, y) {
  console.log("showKodPopup √ßaƒürƒ±ldƒ±. KOD:", kod, "Koordinatlar:", x, y);
  try {
    const response = await fetch(`/api/kod-konsept-detay?kod=${encodeURIComponent(kod)}`);
    console.log("fetch sonucu:", response);
    if (!response.ok) {
      console.error("Detay verisi alƒ±namadƒ±, status:", response.status);
      throw new Error("Detay verisi alƒ±namadƒ±.");
    }
    const result = await response.json();
    console.log("Endpoint'ten d√∂nen sonu√ß:", result);
    if (!result.success) {
      console.error("Endpoint success false d√∂nd√º:", result.message);
      throw new Error(result.message);
    }
    const data = result.data;
    let conceptContent = "";
    if (data.length === 0) {
      conceptContent = "<em>Konsept bulunamadƒ±.</em>";
    } else {
      conceptContent = "<strong>Konseptler:</strong><br>" + data.map(item => item.CUSTOMER_NAME).join("<br>");
    }
    
    // √úr√ºn fotoƒürafƒ±nƒ± g√∂steren <img> etiketi; 
    // Eƒüer fotoƒüraf bulunamazsa, onerror devreye girip dƒ±≈üarƒ±da "Fotoƒürafsƒ±z √úr√ºn" mesajƒ± i√ßeren bir div olu≈üturur.
    const imgTag = `<img src="/resim/${kod}.jpg" style="max-width:100%; height:auto; margin-bottom:5px;" onerror="this.onerror=null; this.outerHTML='<div style=&quot;max-width:100%; height:auto; margin-bottom:5px; text-align:center; font-weight:bold; color:red;&quot;>Fotoƒürafsƒ±z √úr√ºn</div>';">`;
    
    // Popup i√ßeriƒüi; fotoƒüraf (veya mesaj) + konsept detaylarƒ± alt alta.
    const content = `${imgTag}<br>${conceptContent}`;

    const popup = document.getElementById("kodPopup");
    if (popup) {
      popup.innerHTML = content;
      popup.style.left = x + "px";
      popup.style.top = y + "px";
      popup.style.display = "block";
      console.log("Popup g√∂sterildi:", popup);
    } else {
      console.error("Popup elementi bulunamadƒ± (id='kodPopup').");
    }
  } catch (err) {
    console.error("showKodPopup i√ßerisinde hata:", err);
  }
}

function hideKodPopup() {
  console.log("hideKodPopup √ßaƒürƒ±ldƒ±.");
  const popup = document.getElementById("kodPopup");
  if (popup) {
    popup.style.display = "none";
    console.log("Popup gizlendi.");
  } else {
    console.error("Popup elementi bulunamadƒ± (id='kodPopup').");
  }
}


//Stok Kartƒ± Excel Export
// Dikkat: Bu fonksiyon ExcelJS k√ºt√ºphanesinin sayfada y√ºkl√º olduƒüunu varsayar.
async function exportFilteredDataToExcel() {
  try {
    // Yeni bir Excel workbook ve worksheet olu≈üturuluyor:
    const workbook = new ExcelJS.Workbook();
    const worksheet = workbook.addWorksheet("Stok Kartƒ±");

    // Excel s√ºtun ba≈ülƒ±klarƒ± (ilk s√ºtun "Fotoƒüraf" resim i√ßin kullanƒ±lacak)
    const headers = [
      "Fotoƒüraf", "KOD", "ADI", "BIRIM", "BASAMAK 1", "BASAMAK 2", "BASAMAK 3", "BASAMAK 4", "BASAMAK 5", 
      "CINS", "MODEL", "MATERYAL", "EBAT", "RENK", "DESEN", "LAMINE", "AKSESUAR", "AKSESUAR 2", 
      "AKSESUAR 3", "KALƒ∞TE", "GENƒ∞≈û KOLEKSIYON", "ISIM", "DERI TIPI", "ISLENTI 1", "ISLENTI 2", "HOM STOK", "MERKEZ STOK", "SHW STOK", "SHWAKS STOK", 
      "CUMBA STOK", "ISLENMIS DEPO", "UK STOK", "ANADEPO STOK", "SV STOK", "PRK TL", "PRK USD", "PRK EUR", "MLYT USD", "Tedarik Y√∂ntemi", 
      "ƒ∞ngilizce A√ßƒ±klama"
    ];
    // Ba≈ülƒ±k satƒ±rƒ±nƒ± ekliyoruz:
    worksheet.addRow(headers);

    // Tabulator grid‚Äôin filtrelenmi≈ü (aktif) verilerini alƒ±yoruz:
    const data = table.getData("active");  // "table" deƒüi≈ükeni global Tabulator instance'ƒ±nƒ±z

    // Her satƒ±r i√ßin i≈ülemler:
    for (let i = 0; i < data.length; i++) {
      const rowData = data[i];
      
      // Fotoƒüraf URL'si olu≈üturuluyor:
      let imageUrl = "/resim/" + rowData.KOD + ".jpg";
      // Resim √ßekilemezse fallback olarak:
      let response = await fetch(imageUrl).catch(() => null);
      if (!response || !response.ok) {
        imageUrl = "/resim/YOK.jpg";
        response = await fetch(imageUrl);
      }
      
      // Blob olarak resmi elde ediyoruz:
      const blob = await response.blob();
      // Blob'u base64 string'e d√∂n√º≈üt√ºrme (ExcelJS, base64 veriyi kullanarak resim ekliyor):
      const base64 = await new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onloadend = () => {
          // Data URL bi√ßiminde d√∂nen deƒüerden base64 kƒ±smƒ±nƒ± alƒ±yoruz:
          resolve(reader.result.split(',')[1]);
        };
        reader.onerror = reject;
        reader.readAsDataURL(blob);
      });
      
      // Resmi workbook‚Äôa ekliyoruz:
      const imageId = workbook.addImage({
        base64: base64,
        extension: 'jpeg'
      });
      
      // Diƒüer s√ºtunlarƒ±n verisini hazƒ±rlƒ±yoruz.
      // Sƒ±ralama, tabulator grid‚Äôin kolon sƒ±rasƒ± ile aynƒ± olacak ≈üekilde:
      const rowValues = [
        "",  // Fotoƒüraf s√ºtunu placeholder, resmi ayrƒ± ekleyeceƒüiz.
        rowData.KOD || "",
        rowData.ADI || "",
		rowData.BIRIM || "",
        rowData.BASAMAK1 || "",
        rowData.BASAMAK2 || "",
        rowData.BASAMAK3 || "",
        rowData.BASAMAK4 || "",
        rowData.BASAMAK5 || "",
         // CINS: G√∂r√ºnen deƒüeri ekliyoruz:
		  (typeof cinsLookupMap !== "undefined" && cinsLookupMap[rowData.OZEL1]) ? cinsLookupMap[rowData.OZEL1] : (rowData.OZEL1 || ""),
		  // MODEL:
		  (typeof modelLookupMap !== "undefined" && modelLookupMap[rowData.OZEL2]) ? modelLookupMap[rowData.OZEL2] : (rowData.OZEL2 || ""),
		  // MATERYAL:
		  (typeof materyalLookupMap !== "undefined" && materyalLookupMap[rowData.OZEL3]) ? materyalLookupMap[rowData.OZEL3] : (rowData.OZEL3 || ""),
		  // EBAT:
		  (typeof ebatLookupMap !== "undefined" && ebatLookupMap[rowData.OZEL9]) ? ebatLookupMap[rowData.OZEL9] : (rowData.OZEL9 || ""),
		  // RENK:
		  (typeof renkLookupMap !== "undefined" && renkLookupMap[rowData.OZEL10]) ? renkLookupMap[rowData.OZEL10] : (rowData.OZEL10 || ""),
		  // DESEN:
		  (typeof desenLookupMap !== "undefined" && desenLookupMap[rowData.OZEL4]) ? desenLookupMap[rowData.OZEL4] : (rowData.OZEL4 || ""),
		  // LAMINE:
		  (typeof lamineLookupMap !== "undefined" && lamineLookupMap[rowData.OZEL5]) ? lamineLookupMap[rowData.OZEL5] : (rowData.OZEL5 || ""),
		  // AKSESUAR:
		  (typeof aksesuarLookupMap !== "undefined" && aksesuarLookupMap[rowData.OZEL6]) ? aksesuarLookupMap[rowData.OZEL6] : (rowData.OZEL6 || ""),
		  // AKSESUAR 2:
		  (typeof aksesuarLookupMap !== "undefined" && aksesuarLookupMap[rowData.AKSESUAR2]) ? aksesuarLookupMap[rowData.AKSESUAR2] : (rowData.AKSESUAR2 || ""),
		  // AKSESUAR 3:
		  (typeof aksesuarLookupMap !== "undefined" && aksesuarLookupMap[rowData.AKSESUAR3]) ? aksesuarLookupMap[rowData.AKSESUAR3] : (rowData.AKSESUAR3 || ""),
		  // KALƒ∞TE:
		  (typeof kaliteLookupMap !== "undefined" && kaliteLookupMap[rowData.OZEL8]) ? kaliteLookupMap[rowData.OZEL8] : (rowData.OZEL8 || ""),
		  // GENƒ∞≈û KOLEKSIYON:
		  (typeof koleksiyonLookupMap !== "undefined" && koleksiyonLookupMap[rowData.KOLEKSIYON]) ? koleksiyonLookupMap[rowData.KOLEKSIYON] : (rowData.KOLEKSIYON || ""),
		rowData.ISIM || "",
		rowData.DERITIPI || "",
		rowData.ISLENTI1 || "",
		rowData.ISLENTI2 || "",		
        rowData.HOM || "",
        rowData.MRKZ || "",
        rowData.SHWR || "",        // SHW STOK (grid‚Äôde "SHWR" alanƒ±)
        rowData.SHWAKS || "",
        rowData.CUMBA || "",
        rowData.ISD || "",
        rowData.UK || "",
        rowData.AN || "",
        rowData.SV || "",
        rowData.SFIYAT1 || "",
        rowData.SFIYAT4 || "",
        rowData.SFIYAT5 || "",
		rowData.HSP_MALIYET_USD || "",
		rowData.TEDARIK_YONTEMI || "",
        rowData.ACIKLAMA || ""
      ];
      
      // Yeni satƒ±r ekleniyor:
      const excelRow = worksheet.addRow(rowValues);
      const excelRowNum = excelRow.number;  // Bu satƒ±rƒ±n sƒ±ra numarasƒ±

      // Resmi ilk s√ºtun ("Fotoƒüraf") h√ºcresine 50px x 50px √∂l√ß√ºlerinde ekliyoruz:
      worksheet.addImage(imageId, {
        tl: { col: 0, row: excelRowNum - 1 },
        ext: { width: 50, height: 50 }
      });
      
      // Satƒ±r y√ºksekliƒüini ayarlƒ±yoruz (yakla≈üƒ±k d√∂n√º≈ü√ºm: 1 px ‚âà 0.75 point):
      worksheet.getRow(excelRowNum).height = 50 * 0.75;
    }

    // √áalƒ±≈üma kitabƒ±nƒ± buffer olarak yazƒ±p indirme i≈ülemini tetikleyelim:
    const buffer = await workbook.xlsx.writeBuffer();
    const blob = new Blob([buffer], { type: "application/vnd.openxmlformats-officedocument.spreadsheetml.sheet" });
    const url = window.URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = "StokKarti.xlsx";
    a.click();
    window.URL.revokeObjectURL(url);

  } catch (error) {
    console.error("Excel export hatasƒ±:", error);
    alert("Excel dƒ±≈üa aktarƒ±mƒ±nda bir hata olu≈ütu.");
  }
}

</script>
<script>

document.addEventListener('DOMContentLoaded', function() {
  const campaignForm = document.getElementById('campaignForm');
  
  campaignForm.addEventListener('submit', async function(e) {
  e.preventDefault();

  // Diƒüer form alanlarƒ±nƒ± toplayƒ±n...
  const selectedProducts = [];
  const rows = document.querySelectorAll('#selectedProductsTable tbody tr');
  rows.forEach(row => {
    const prodCode = row.getAttribute('data-code');
    if (prodCode) {
      selectedProducts.push(prodCode);
    }
  });

  const campaignData = {
    campaignName: document.getElementById('campaignName').value,
    campaignType: document.getElementById('campaignType').value,
    campaignDescription: document.getElementById('campaignDescription').value,
    startDate: document.getElementById('startDate').value,
    endDate: document.getElementById('endDate').value,
    includeSubCategories: document.getElementById('includeSubCategories').checked || false,
    discountValue: parseFloat(document.getElementById('discountValue').value || "0"),
    discountType: document.getElementById('discountType').value,
    isCombinable: document.querySelector('input[name="isCombinable"]:checked').value === "true",
    // Kategori se√ßimi daha √∂nce toplanƒ±yor (jstree ile)
    selectedCategories: document.getElementById('selectedCategories').value.split(',').filter(Boolean),
    // Yeni eklenen alan: Se√ßilen √ºr√ºnlerin (√ºzerinde i≈ülemler yapmak i√ßin)
    selectedProducts: selectedProducts  // √ñrneƒüin, √ºr√ºn KODlarƒ±nƒ± i√ßeren diziniz
  };
 console.log("G√∂nderilen kampanya verisi:", campaignData); // Debug i√ßin
  try {
    const response = await fetch('/api/campaigns', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(campaignData)
    });
    
    if (!response.ok) {
      alert('Kampanya kaydedilemedi!');
      return;
    }
    const result = await response.json();
    if (result.success) {
      alert('Kampanya ba≈üarƒ±yla kaydedildi!');
      campaignForm.reset();
      // Se√ßilen √ºr√ºnler tablosunu temizleyin
      document.querySelector('#selectedProductsTable tbody').innerHTML = '';
      loadCampaigns();
    } else {
      alert('Kampanya kaydedilemedi: ' + (result.message || 'Bilinmeyen hata'));
    }
  } catch (error) {
    console.error(error);
    alert('Sunucuya baƒülanƒ±rken hata olu≈ütu.');
  }
});


  // Kategori aƒüacƒ± jstree y√ºkleme fonksiyonu: (√∂nceki √∂rnekteki gibi)
  loadCategoryTree();  
  //Mevcut Kampanyalarƒ± Y√ºkleme Fonksiyonu
  loadCampaigns();
});

// jstree ile kategori se√ßiminde gizli input g√ºncellemesi:
$('#campaignCategoriesTree').on("changed.jstree", function (e, data) {
  const selectedNodes = data.selected; 
  document.getElementById('selectedCategories').value = selectedNodes.join(',');
});



// Kampanya t√ºrleri i√ßin mapping s√∂zl√ºƒü√ºn√ºz
const campaignTypeMap = {
  "PRODUCT": "√úr√ºn ƒ∞ndirimi",
  "CART": "Sepet ƒ∞ndirimi",
  "BUY_X_GET_Y": "X Al Y √ñde / Bedava",
  "Nth_Product_Discount": "X. √úr√ºne ƒ∞ndirim",
  "CATEGORY_CART": "Kategori Bazlƒ± ƒ∞ndirim"
};

function loadCampaigns() {
  fetch('/api/campaigns')
    .then(response => response.json())
    .then(result => {
      if (!result.success) {
        console.error("Kampanyalar alƒ±namadƒ±:", result.message);
        return;
      }
      const campaigns = result.data;
      const tbody = document.querySelector('#campaignsTable tbody');
      tbody.innerHTML = ''; // √ñnce tabloyu temizle

      if (campaigns.length === 0) {
        tbody.innerHTML = '<tr><td colspan="7" class="text-center">Hi√ß kampanya kaydƒ± bulunamadƒ±.</td></tr>';
      } else {
        campaigns.forEach(campaign => {
          const displayType = campaignTypeMap[campaign.CampaignType] || campaign.CampaignType;
          const startDateTr = formatDateTrLocal(campaign.StartDate); // T√ºrk√ße format
          const endDateTr = formatDateTrLocal(campaign.EndDate);     // T√ºrk√ße format

          // Alt kategoriler (eƒüer backend'den geliyorsa) ya da bo≈ü
          const categories = campaign.categories || "";

          const row = `
            <tr>
              <td>${campaign.CampaignID}</td>
              <td>${campaign.CampaignName}</td>
              <td>${displayType}</td>
              <td>${startDateTr}</td>
              <td>${endDateTr}</td>
              <td>${categories}</td>
              <td>
                <button class="btn btn-sm btn-info" onclick="editCampaign(${campaign.CampaignID})">D√ºzenle</button>
                <button class="btn btn-sm btn-danger" onclick="deleteCampaign(${campaign.CampaignID})">Sil</button>
              </td>
            </tr>
          `;
          tbody.insertAdjacentHTML('beforeend', row);
        });
      }
    })
    .catch(error => {
      console.error("Kampanyalar y√ºklenirken hata olu≈ütu:", error);
    });
}

// Yardƒ±mcƒ± tarih format fonksiyonu
// Yardƒ±mcƒ±: UTC tarih string‚Äôini ƒ∞stanbul saatiyle formatlayan fonksiyon
function formatDateTrLocal(dateString) {
  if (!dateString) return "";
  const dateObj = new Date(dateString);  // "2025-04-18T05:00:00.000Z" gibi ISO
  return dateObj.toLocaleString("tr-TR", {
    timeZone: "Europe/Istanbul",
    day:   "2-digit",
    month: "2-digit",
    year:  "numeric",
    hour:  "2-digit",
    minute:"2-digit"
  });
}

//Kampanya D√ºzenleme Fonksiyonu
async function editCampaign(campaignID) {
  try {
    const response = await fetch(`/api/campaigns/${campaignID}`);
    if (!response.ok) {
      alert("Kampanya bilgileri alƒ±nƒ±rken hata olu≈ütu!");
      return;
    }
    const result = await response.json();
    if (!result.success) {
      alert(result.message || "Kampanya bilgileri alƒ±namadƒ±!");
      return;
    }
    // Yanƒ±t yapƒ±sƒ±na g√∂re; eƒüer veriler result.data i√ßindeyse:
    const campaign = result.data || result;
    
    // Form alanlarƒ±nƒ± dolduruyoruz
    document.getElementById('campaignId').value = campaign.CampaignID; // Gizli alan
    document.getElementById('campaignName').value = campaign.CampaignName || "";
    document.getElementById('campaignType').value = campaign.CampaignType || "";
    document.getElementById('campaignDescription').value = campaign.Description || "";
    document.getElementById('startDate').value = campaign.StartDate;
    document.getElementById('endDate').value = campaign.EndDate;
    document.getElementById('includeSubCategories').checked = campaign.IncludeSubCategories ? true : false;
    document.getElementById('discountValue').value = campaign.DiscountValue || "";
    document.getElementById('discountType').value = campaign.DiscountType || "PERCENT";
    
    if (campaign.IsCombinable) {
      document.getElementById('combinableYes').checked = true;
    } else {
      document.getElementById('combinableNo').checked = true;
    }
    
    // Kategori veya √úr√ºn se√ßim alanlarƒ±: Kampanya t√ºr√ºne baƒülƒ± olarak
    if (campaign.CampaignType === "CATEGORY_CART" && campaign.categories) {
      // jstree ile kategori aƒüa√ß: se√ßili kategorileri (kampanya.categories beklediƒüimiz gibi array ise)
      $('#campaignCategoriesTree').jstree('deselect_all');
      campaign.categories.forEach(function(catId) {
        $('#campaignCategoriesTree').jstree('select_node', catId.toString());
      });
      document.getElementById('selectedCategories').value = campaign.categories.join(',');
      // G√∂ster kategori se√ßim alanƒ±nƒ±
      document.getElementById('categorySelectionSection').style.display = 'block';
      document.getElementById('productSelectionSection').style.display = 'none';
    } else if (campaign.CampaignType === "PRODUCT" && campaign.selectedProducts) {
      // √úr√ºn ƒ∞ndirimi i√ßin se√ßili √ºr√ºnler: campaign.selectedProducts beklediƒüimiz gibi array ise
      // Mevcut √ºr√ºnler tablosunu temizleyin
      const tbody = document.querySelector('#selectedProductsTable tbody');
      tbody.innerHTML = "";
      campaign.selectedProducts.forEach(productId => {
        // Frontend tarafƒ±nda √ºr√ºn√º listelemek i√ßin ilgili bilgileri de backend'den almanƒ±z gerekir.
        // √ñrneƒüin, product verilerini i√ßeren bir mapping ya da ekstra endpoint varsa onu kullanƒ±n.
        // Burada basit√ße productId, √∂rneƒüin; √ºr√ºn bilgilerini doldurun:
        const imageUrl = `/resim/YOK.jpg`;  // Ger√ßek √ºr√ºn resmi URL'sini almak i√ßin kodunuzu uyarlayƒ±n.
        // √ñrneƒüin, eƒüer product bilgileri campaign.selectedProducts i√ßindeyse:
        const product = campaign.selectedProductsInfo ? campaign.selectedProductsInfo.find(p => p.ID == productId) : {};
        const kod = product.KOD || productId;
        const adi = product.ADI || "";
        const ebat = product.EBAT || "";
        const model = product.OZEL2 || "";
        
        const rowHTML = `
          <tr data-code="${productId}">
            <td><img src="/resim/${kod}.jpg" class="product-thumb" onerror="this.onerror=null;this.src='/resim/YOK.jpg';"></td>
            <td>${kod}</td>
            <td>${adi}</td>
            <td>${ebat}</td>
            <td>${model}</td>
            <td><button class="btn btn-sm btn-danger" onclick="removeProductFromCampaign('${productId}', this)">Sil</button></td>
          </tr>
        `;
        tbody.insertAdjacentHTML('beforeend', rowHTML);
      });
      // G√∂ster √ºr√ºn se√ßim alanƒ±nƒ±
      document.getElementById('productSelectionSection').style.display = 'block';
      document.getElementById('categorySelectionSection').style.display = 'none';
    } else {
      // Diƒüer t√ºrlerde se√ßim alanlarƒ±nƒ± gizleyin
      document.getElementById('productSelectionSection').style.display = 'none';
      document.getElementById('categorySelectionSection').style.display = 'none';
    }
    
    // ƒ∞lgili alanlar doldurulduktan sonra, sayfa (veya panel) kullanƒ±cƒ±ya g√ºncel haliyle g√∂sterilebilir.
    // (Eƒüer form aynƒ± sayfada g√∂r√ºn√ºyorsa ek bir modal a√ßmaya gerek yok)
    
  } catch (error) {
    console.error("editCampaign hata:", error);
    alert("Kampanya bilgilerini alƒ±rken hata olu≈ütu.");
  }
}

 // Kampanya t√ºr√º "√úr√ºn ƒ∞ndirimi" se√ßilmi≈üse √ºr√ºn se√ßimi alanƒ±nƒ± g√∂ster
    document.getElementById('campaignType').addEventListener('change', function() {
      const type = this.value;
    // Kampanya t√ºr√ºne baƒülƒ± olarak alanlarƒ± g√∂ster/gizle:
    if (type === 'PRODUCT') {
      // √úr√ºn ƒ∞ndirimi se√ßilmi≈ü: G√∂ster √ºr√ºn se√ßimi, gizle kategori se√ßim alanƒ±
      document.getElementById('productSelectionSection').style.display = 'block';
      document.getElementById('categorySelectionSection').style.display = 'none';
      loadDiscountedProducts(); // √úr√ºn listesini y√ºkle
    } else if (type === 'CATEGORY_CART') {
      // Kategori Bazlƒ± ƒ∞ndirim: G√∂ster kategori aƒüa√ß yapƒ±sƒ±nƒ±, gizle √ºr√ºn se√ßimi
      document.getElementById('categorySelectionSection').style.display = 'block';
      document.getElementById('productSelectionSection').style.display = 'none';
      loadCategoryTree(); // Kategori aƒüacƒ± y√ºkle
    } else {
      // Diƒüer kampanya t√ºrleri i√ßin, her iki alanƒ± gizleyebilirsiniz.
      document.getElementById('productSelectionSection').style.display = 'none';
      document.getElementById('categorySelectionSection').style.display = 'none';
    }
    });
//g√ºncelleme i≈ülemi i√ßin (updateCampaign) form submit olayƒ±nƒ± yakalayƒ±p backend‚Äôe PUT isteƒüi g√∂nderecek
document.getElementById('editCampaignForm').addEventListener('submit', async function(e) {
  e.preventDefault();
  
  const campaignID = document.getElementById('editCampaignId').value;
  const updatedData = {
    campaignName: document.getElementById('campaignNameEdit').value,
    // Diƒüer alanlarƒ± doldurun, √∂rneƒüin:
    // campaignType, campaignDescription, startDate, endDate, includeSubCategories, discountValue, discountType, isCombinable, selectedCategories vs.
  };

  try {
    const response = await fetch(`/api/campaigns/${campaignID}`, {
      method: 'PUT',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(updatedData)
    });
    
    if (!response.ok) {
      alert('Kampanya g√ºncellenirken hata olu≈ütu!');
      return;
    }
    const result = await response.json();
    if (result.success) {
      alert('Kampanya ba≈üarƒ±yla g√ºncellendi!');
      $('#editCampaignModal').modal('hide');
      loadCampaigns();  // Listeyi yenile
    } else {
      alert('G√ºncelleme ba≈üarƒ±sƒ±z: ' + result.message);
    }
  } catch (error) {
    console.error("UpdateCampaign hata:", error);
    alert('G√ºncelleme sƒ±rasƒ±nda beklenmeyen bir hata olu≈ütu.');
  }
});
// jstree se√ßimi deƒüi≈ütiƒüinde gizli input g√ºncelleniyor
    $('#campaignCategoriesTree').on("changed.jstree", function (e, data) {
      const selectedNodes = data.selected;
      document.getElementById('selectedCategories').value = selectedNodes.join(',');
    });
// Kampanya √úr√ºnleri /api/skart endpoint'inden √ßekip, select picker'ƒ± dolduran fonksiyon
 // /api/skart'tan √ºr√ºnleri √ßekip, selectpicker'ƒ± dolduran fonksiyon
    async function loadDiscountedProducts() {
	  try {
		const response = await fetch('/api/skart');
		const result = await response.json();
		if (!result.success) {
		  console.error("SKART verileri alƒ±namadƒ±:", result.message);
		  return;
		}
		const products = result.data;
		const select = document.getElementById('discountedProducts');
		select.innerHTML = '<option value="">√úr√ºn Se√ßiniz...</option>';
		products.forEach(product => {
		  // √úr√ºn resim URL'sini olu≈üturuyoruz
		  const imageUrl = `/resim/${product.KOD}.jpg`;
		  // Display i√ßeriƒüini olu≈üturuyoruz; burada KOD, ADI, EBAT, MODEL verilerini g√∂sterelim.
		  const displayContent = `<div class="option-content">
			  <img src="${imageUrl}" style="width:30px; height:30px; margin-right:5px; border-radius:3px;" onerror="this.onerror=null;this.src='/resim/YOK.jpg';">
			  <span><strong>${product.KOD}</strong> - ${product.ADI} - ${product.EBAT || ''} - ${product.OZEL2 || ''}</span>
			</div>`;
		  // Burada option'un value'sunu product.ID olarak belirleyin
		  const option = document.createElement('option');
		  option.value = product.ID;  // Dikkat: product.ID alanƒ±, Campaign_Products tablosunda ProductID s√ºtunu i√ßin kullanƒ±lacak.
		  option.setAttribute('data-content', displayContent);
		  // Ek olarak, diƒüer verileri de attribute olarak saklayabiliriz:
		  option.setAttribute('data-kod', product.KOD);
		  option.setAttribute('data-adi', product.ADI);
		  option.setAttribute('data-ebat', product.EBAT || '');
		  option.setAttribute('data-model', product.OZEL2 || '');
		  select.appendChild(option);
		});
		$('.selectpicker').selectpicker('refresh');
	  } catch (error) {
		console.error("√úr√ºn verileri y√ºklenirken hata:", error);
	  }
	}


 // Se√ßilen √ºr√ºn√º "Se√ßilen √úr√ºnler" tablosuna ekleyen fonksiyon
    function addProductToCampaign() {
	  const select = document.getElementById('discountedProducts');
	  const selectedValue = select.value; // Bu artƒ±k product.ID olacak
	  if (!selectedValue) return;
	  
	  // Se√ßilen option'u elde edip, diƒüer detaylarƒ± custom data attribute'lerinden okuyun
	  const selectedOption = select.options[select.selectedIndex];
	  const kod = selectedOption.getAttribute('data-kod') || "";
	  const adi = selectedOption.getAttribute('data-adi') || "";
	  const ebat = selectedOption.getAttribute('data-ebat') || "";
	  const model = selectedOption.getAttribute('data-model') || "";
	  // Fotoƒüraf URL'si yine KOD tabanlƒ± da olabilir, isteƒüe g√∂re d√ºzenleyin
	  const imageUrl = `/resim/${kod}.jpg`;
	  
	  const tbody = document.querySelector('#selectedProductsTable tbody');
	  if (tbody.querySelector(`tr[data-code="${selectedValue}"]`)) {
		alert("Bu √ºr√ºn zaten se√ßilmi≈ü.");
		return;
	  }
	  
	  const row = document.createElement('tr');
	  row.setAttribute('data-code', selectedValue);
	  row.innerHTML = `
		<td><img src="${imageUrl}" class="product-thumb" onerror="this.onerror=null;this.src='/resim/YOK.jpg';"></td>
		<td>${kod}</td>
		<td>${adi}</td>
		<td>${ebat}</td>
		<td>${model}</td>
		<td><button class="btn btn-sm btn-danger" onclick="removeProductFromCampaign('${selectedValue}', this)">Sil</button></td>
	  `;
	  tbody.appendChild(row);
	}



    // Se√ßilen √ºr√ºn√º tablodan kaldƒ±ran fonksiyon
    function removeProductFromCampaign(productCode, btnElement) {
      // ƒ∞lgili satƒ±rƒ± silmek i√ßin:
      const row = btnElement.closest('tr');
      row.parentNode.removeChild(row);
    }

// DOM y√ºklendiƒüinde √ºr√ºnleri √ßekmek i√ßin:
document.addEventListener('DOMContentLoaded', function() {
  loadDiscountedProducts();
});

//Kampanya Silme ƒ∞≈ülevi
async function deleteCampaign(campaignID) {
  if (!confirm("Bu kampanyayƒ± silmek istediƒüinize emin misiniz?")) {
    return;
  }
  
  try {
    // DELETE metodu kullanarak kampanyayƒ± silen endpoint'e istek g√∂nderiyoruz.
    const response = await fetch(`/api/campaigns/${campaignID}`, {
      method: 'DELETE'
    });
    
    if (!response.ok) {
      alert("Kampanya silinirken hata olu≈ütu!");
      console.error("Delete error:", response.status, response.statusText);
      return;
    }
    
    const result = await response.json();
    if (result.success) {
      alert("Kampanya ba≈üarƒ±lƒ± ≈üekilde silindi.");
      // Listeyi yenilemek i√ßin kampanyalarƒ± yeniden y√ºkleyin:
      loadCampaigns();
    } else {
      alert("Kampanya silinemedi: " + result.message);
    }
  } catch (error) {
    console.error("DeleteCampaign hata:", error);
    alert("Kampanya silme sƒ±rasƒ±nda beklenmeyen bir hata olu≈ütu.");
  }
}


</script>
<script>
//Stok Durum Raporu
// 1) Men√º tƒ±klamasƒ± / panel g√∂sterme
document.addEventListener('DOMContentLoaded', () => {
  const stockMenu = document.getElementById('stock-depo-status');
  stockMenu.addEventListener('click', function(e) {
    e.preventDefault();
    showStockDepoStatus();
  });
  
  // "Getir" butonuna tƒ±klandƒ±ƒüƒ±nda rapor y√ºkle
  document.getElementById('loadStockBtn')
          .addEventListener('click', loadStockInventoryReport);
});

let depoList = [];

// 2) Depo dropdown'unu dolduran fonksiyon
async function fetchDepolar() {
  try {
    const res = await fetch('/api/depos');
    const json = await res.json();
    if (!json.success) throw new Error(json.message);
    depoList = json.data;
  } catch (err) {
    console.error('Depo y√ºkleme hatasƒ±', err);
  }
}

// 3) Paneli g√∂ster / diƒüer panelleri gizle
// ‚Ä¶ (aynƒ± ba≈ütaki fetchDepolar ve DOMContentLoaded kodlarƒ±)

// ‚Ä¶ DOMContentLoaded vs. aynƒ±

async function showStockDepoStatus() {
  // üîí Sadece Admin Panel‚Äôdeysek devam et
  const activeTab = document.querySelector('.tab-pane.active');
  if (!activeTab || activeTab.id !== "adminPanel") {
    alert("Stok Depo Durum raporu yalnƒ±zca Admin Panel'de kullanƒ±labilir.");
    return;
  }

  // a) Diƒüer t√ºm ana panelleri gizle
  ['barcodeContainer','conceptLabelContainer','initialImageContainer','product-container']
    .forEach(id => {
      const el = document.getElementById(id);
      if (el) el.style.display = 'none';
    });

  // b) Tarih‚Äëdepo formunu g√∂ster
  document.getElementById('stockInventoryContainer').style.display = 'block';

  // c) Bug√ºn√ºn tarihini ata
  document.getElementById('dateInput').value = new Date().toISOString().substr(0,10);

  // d) Depo listesini y√ºkle ve dropdown'u doldur
  if (depoList.length === 0) {
    await fetchDepolar();
  }
  const ddl = document.getElementById('depoDropdown');
  ddl.innerHTML = '<option value="">Se√ßiniz</option>';
  depoList.forEach(d => {
    const opt = document.createElement('option');
    opt.value = d.KOD;
    opt.textContent = `${d.KOD} - ${d.ADI}`;
    ddl.appendChild(opt);
  });

  // e) √ñnceki raporu temizle
  document.getElementById('stockReportContainer').innerHTML = '';
}


let lastStockData = [];
let lastDate, lastDepo;

document.addEventListener('DOMContentLoaded', () => {
  document.getElementById('stock-depo-status')
          .addEventListener('click', showStockDepoStatus);

  document.getElementById('loadStockBtn')
          .addEventListener('click', loadStockInventoryReport);

  document.getElementById('exportStockBtn')
          .addEventListener('click', exportStockToExcel);
});

async function loadStockInventoryReport() {
  const date = document.getElementById('dateInput').value;
  const depo = document.getElementById('depoDropdown').value;
  if (!date || !depo) return alert('L√ºtfen hem tarih hem depo se√ßiniz.');

  // kaydet
  lastDate = date;
  lastDepo = depo;
  const formatNumber = (value) => {
    const parts = Number(value).toFixed(2).split(".");
    parts[0] = parts[0].replace(/\B(?=(\d{3})+(?!\d))/g, ".");
    return parts.join(",");
  };	
  try {
    const res = await fetch(
      `/api/stock-inventory?date=${encodeURIComponent(date)}&depo=${encodeURIComponent(depo)}`
    );
    const json = await res.json();
    if (!json.success) {
      return alert('Rapor alƒ±namadƒ±: ' + json.message);
    }

    const data = json.data;
    lastStockData = data;

    // toplam miktar
    const total = data.reduce((sum, r) => sum + (r.MIKTAR||0), 0);

    // tabloyu in≈üa et
    let html = `
      <table class="table table-sm table-bordered mt-3" style="font-size:10px">
        <thead class="thead-light">
          <tr>
            <th>BASAMAK1</th><th>BASAMAK2</th><th>BASAMAK3</th><th>BASAMAK4</th><th>BASAMAK5</th>
            <th>KOD</th><th>ADI</th><th>Bƒ∞Rƒ∞M</th>
            <th style="text-align:right">MIKTAR</th>
			<th style="text-align:right">PRK USD</th>
			<th style="text-align:right">MLYT USD</th>
			<th style="text-align:right">√áarpan</th>
          </tr>
        </thead>
        <tbody>
    `;

    data.forEach(r => {
      html += `
        <tr>
          <td>${r.BASAMAK1||''}</td>
          <td>${r.BASAMAK2||''}</td>
          <td>${r.BASAMAK3||''}</td>
          <td>${r.BASAMAK4||''}</td>
          <td>${r.BASAMAK5||''}</td>
          <td>${r.KOD}</td>
          <td>${r.ADI}</td>
          <td>${r.BRM}</td>
          <td style="text-align:right">${formatNumber(r.MIKTAR)}</td>
		  <td style="text-align:right">${formatNumber(r.PRK_USD)}</td>
		  <td style="text-align:right">${formatNumber(r.HSP_MALIYET_USD)}</td>
		  <td style="text-align:right">
		  ${ formatNumber(
			  Number.isFinite(r.PRK_USD / r.HSP_MALIYET_USD)
				? r.PRK_USD / r.HSP_MALIYET_USD
				: 0
			)
		  }
		</td>

        </tr>
      `;
    });

    html += `
        </tbody>
        <tfoot>
          <tr>
            <td colspan="8" style="text-align:right;font-weight:bold">Toplam:</td>
            <td style="text-align:right;font-weight:bold">${formatNumber(total)}</td>
          </tr>
        </tfoot>
      </table>
    `;

    // sadece kendi konteyner'ƒ±na
    const rpt = document.getElementById('stockReportContainer');
    rpt.style.display = 'block';
    rpt.innerHTML = html;

    // ana √ºr√ºn-container'ƒ± gizle
    document.getElementById('product-container').style.display = 'none';
  } catch (err) {
    console.error(err);
    alert('Rapor y√ºklenirken hata olu≈ütu.');
  }
}

function exportStockToExcel() {
  if (!lastStockData.length) {
    return alert('√ñnce ‚ÄúGetir‚Äù ile raporu y√ºkleyin.');
  }
  // ba≈ülƒ±k + filtre bilgisi
  const aoa = [];
  aoa.push(['Tarih', lastDate, '', 'Depo', lastDepo]);
  aoa.push([]);

  // s√ºtun ba≈ülƒ±klarƒ±
  aoa.push([
    'BASAMAK1','BASAMAK2','BASAMAK3','BASAMAK4','BASAMAK5',
    'KOD','ADI','Bƒ∞Rƒ∞M','MIKTAR'
  ]);

  // veri satƒ±rlarƒ±
  lastStockData.forEach(r => {
    aoa.push([
      r.BASAMAK1||'', r.BASAMAK2||'', r.BASAMAK3||'', r.BASAMAK4||'', r.BASAMAK5||'',
      r.KOD, r.ADI, r.BRM, r.MIKTAR
    ]);
  });

  // alt toplam
  const total = lastStockData.reduce((s,r) => s + (r.MIKTAR||0), 0);
  aoa.push([]);
  aoa.push(['','','','','','','','Toplam', total]);

  // Sheet + Workbook
  const ws = XLSX.utils.aoa_to_sheet(aoa);
  const wb = XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(wb, ws, 'StokDepoDurum');
  XLSX.writeFile(wb, `StokDepoDurum_${lastDepo}_${lastDate}.xlsx`);
}




</script>

<!-- Kar≈üƒ±la≈ütƒ±rma Butonu (Sabit Ekran Altƒ±nda) -->
<div id="compareFooter" style="display: none; position: fixed; bottom: 0; width: 100%; background: #333; color: white; padding: 10px; text-align: center; z-index: 1000;">
    <button class="btn btn-warning" onclick="openCompareModal()">
        <i class="fas fa-exchange-alt"></i> √úr√ºnleri Kar≈üƒ±la≈ütƒ±r (<span id="compareCount">0</span>)
    </button>
</div>

<!-- Sayfanƒ±n Footer B√∂l√ºm√º 
<footer style="text-align: center; padding: 10px; background: #222; color: white; margin-top: -35px;">
    <p>¬© 2025 T√ºm Haklarƒ± Saklƒ±dƒ±r.</p>
</footer>-->

	</body>
	</html>