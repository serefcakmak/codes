	<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Estetik Decor - Intranet</title>
    
    <!-- Handsontable CSS -->
	 <link href="https://unpkg.com/tabulator-tables@5.4.4/dist/css/tabulator.min.css" rel="stylesheet">
	
	<!-- Bootstrap CSS -->
	
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-select/1.13.18/css/bootstrap-select.min.css">

    <!-- Font Awesome -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css" rel="stylesheet">
    
    <!-- Diğer CSS -->
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500&display=swap" rel="stylesheet">
	<link rel="stylesheet" href="/css/style.css">
	<!--  jstree Kütüphanesi -->
	<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/jstree/3.3.12/themes/default/style.min.css" />
	
  
		
	</head>
	<body>
		<div id="initialImageContainer" style="display: flex; flex-direction: column; justify-content: center; align-items: center; height: calc(100vh - 50px); width: 100%;">
			<img src="/resim/EDLogo.jpg" alt="Logo" id="initialImage">
			<p style="margin-top: 15px; font-size: 14px; color: #727476;">© Copyright Kadir Çakmak 2025</p>
		</div>
		<div class="filter-container">
			<div class="form-group filter-dropdowns">
				<select id="basamak2" class="filter selectpicker" data-live-search="true">
					<option value="">BASAMAK2</option>
				</select>
				<select id="basamak4" class="filter selectpicker" data-live-search="true">
					<option value="">BASAMAK4</option>
				</select>
				<select id="anamodel" class="filter selectpicker" data-live-search="true">
					<option value="">ANAMODEL</option>
				</select>
				<select id="model" class="filter selectpicker" data-live-search="true">
					<option value="">MODEL</option>
				</select>
				<select id="ebat" class="filter selectpicker" data-live-search="true">
					<option value="">EBAT</option>
				</select>
				<select id="kod" class="filter selectpicker" data-live-search="true">
					<option value="">KOD</option>
				</select>
			</div>

					<!-- Yeni fiyat aralığı filtreleme alanı -->
			<div class="price-filter">
				<label>
					Min Fiyat: <span id="minPriceLabel">0</span>
					<input type="range" id="minPrice" min="0" max="600000" step="1000" value="0">
				</label>
				<label>
					Max Fiyat: <span id="maxPriceLabel">600000</span>
					<input type="range" id="maxPrice" min="0" max="600000" step="1000" value="600000">
				</label>
			</div>
			<!-- Diğer filtrelerden ayırmak için çizgi 
			<hr style="border-top: 2px solid #ddd; margin: 10px 0;">-->
			<!-- Arama alanı ekleniyor -->
				<input type="text" id="searchInput" placeholder="Ürün Ara..." class="filter" style="margin-top: 5px; width: 100%;">
			<!-- Fotoğraf Filtreleri için Başlık -->
			<div class="filter-section">

				<span class="filter-title">📷 Görsel Filtreleri</span>
				<label class="filter">
					<input type="checkbox" id="toggleNoImage"> Fotoğraflı
				</label>
				<label>  </label>
				<label class="filter">
					<input type="checkbox" id="onlyNoImage"> Fotoğrafsız
				</label>
			</div>
			
			
			<!-- Stok Filtreleri Bölümü -->
			<div class="filter-section">
				<span class="filter-title">📦 Stok Filtreleri</span>
				<label class="filter">
					<input type="checkbox" id="hideNoStockToggle"> Stoklular
				</label>

				<label class="filter">
					<input type="checkbox" id="showStockAbove5"> Stok >=5
				</label>

				<label class="filter">
					<input type="checkbox" id="showHmStock"> HM > 0
				</label>

				<label class="filter">
					<input type="checkbox" id="showHmZeroStock"> HM = 0
				</label>
			</div>
			<!-- Diğer filtrelerden ayırmak için çizgi -->
			<div class="collection-filter-container">
				<span class="filter-title">🔖 Koleksiyon</span>
				<div class="collection-checkboxes">
					<label class="custom-checkbox">
						<input type="checkbox" id="koleksiyon25">
						<span class="checkmark"></span>
						<span class="label-text">Güncel Koleksiyon ✅</span>
					</label>
					<label class="custom-checkbox">
						<input type="checkbox" id="excludeKoleksiyon25">
						<span class="checkmark"></span>
						<span class="label-text">Güncel Koleksiyon ❌</span>
					</label>
				</div>
			</div>
			<!-- Diğer filtrelerden ayırmak için çizgi -->
			<div class="collection-filter-container">
				<span class="filter-title">🔖 Proje</span>
				<div class="collection-checkboxes">
					<label class="custom-checkbox">
						<input type="checkbox" id="kurumsalListeToggle">
						<span class="checkmark"></span>
						<span class="label-text">Proje ✅</span>
					</label>
					<label class="custom-checkbox">
						<input type="checkbox" id="excludekurumsalListeToggle">
						<span class="checkmark"></span>
						<span class="label-text">Proje ❌</span>
					</label>
				</div>
			</div>
			<!-- Diğer filtrelerden ayırmak için çizgi -->
			<div class="collection-filter-container">
				<span class="filter-title">🔖 Koleksiyon & Proje</span>
				<div class="collection-checkboxes">
					<label class="custom-checkbox">
						<input type="checkbox" id="excludeListeToggle">
						<span class="checkmark"></span>
						<span class="label-text">Koleksiyon & Proje ❌</span>
					</label>
				</div>
			</div>

			<div class="filter-section">
				<span class="filter-title">📌 Diğer Filtreler</span>
				<label class="filter">
					<input type="checkbox" id="indirimListeToggle"> İndirim
				</label>
			<label class="filter">
				<input type="checkbox" id="fuar2025Toggle"> Fuar 2025
			</label>
			<label>  </label>
			<label class="filter">
				<input type="checkbox" id="fkontrolToggle"> Fiyat Kontrol
			</label>
			</div>
			
			<div class="filter-buttons">
				<button id="applyFilters" class="filter">🛠️ Filtrele</button>
				<button id="clearFilters" class="filter">❌ Temizle</button>
				<button id="exportExcelButton">📊 Excel'e Aktar</button>
			</div>
			
		</div>
		<div id="loadingMessage" style="display: none;">
			<div class="spinner-border text-light" role="status" style="width: 3rem; height: 3rem;">
				<span class="sr-only">Loading...</span>
			</div>
			<p id="loadingText">Ürünler Yükleniyor...</p>
		</div>
		<!-- **İçerik Alanları (Sekmeler İçin Container)** -->
		<div class="tab-content">
			<!-- 🏠 Ana Sayfa - Mevcut Ürün Listesi -->
			<div class="tab-pane fade show active" id="home">
				<div class="product-container" id="product-container">
					<!-- Ürünler burada yüklenecek -->
				</div>
				<div id="concept-products-container" style="display: none;">
					<h3>Seçili Konseptin Ürünleri</h3>
					<div class="product-grid">
						<!-- Ürünler buraya yüklenecek -->
					</div>
				</div>

			</div>
			<!-- 🔧 Admin Paneli -->
			<div class="tab-pane fade" id="adminPanel">
				<div class="product-container" id="admin-product-container">
					<!-- Ürünler burada yüklenecek -->
				</div>
			</div>
			<!-- 📊 Raporlar -->
			<div class="tab-pane fade" id="reports">
				<h3 style="text-align: center; font-size: 22px; color: #333;">📊 Sipariş ve Teklif Raporları</h3>
				
				<table class="charts-table">
					<tr>
						<td>
							<h4>📈 Günlük SİPARİŞLER </h4>
							<canvas id="dailyOrdersChart"></canvas>
						</td>
						<td>
							<h4>📊 Günlük TEKLİFLER </h4>
							<canvas id="dailyOffersChart"></canvas>
						</td>
					</tr>
				</table>

				<!-- 📌 3 Sütunlu Yapı -->
				<table class="summary-container">
					<tr>
						
						<td class="summary-wrapper">
							<!-- 📌 Özet Tablo -->
							<h4 class="summary-title">📊 Haftalık Özet Sipariş/Teklif</h4>
							<table class="summary-table">
								<thead>
									<tr>
										<th>GÜN</th>
										<th>SİPARİŞ (USD)</th>
										<th>TEKLİF (USD)</th>
									</tr>
								</thead>
								<tbody id="summaryTableBody">
									<!-- JavaScript ile doldurulacak -->
								</tbody>
								<tfoot>
									<tr>
										<th>Toplam</th>
										<th id="totalSiparis">0</th>
										<th id="totalTeklif">0</th>
									</tr>
								</tfoot>
							</table>
						</td>
						 <!-- Yeni Aylık Özet Tablosu -->
						<td class="summary-wrapper">
							<h4 class="summary-title">Aylık Sipariş Performans Özeti</h4>
							<table class="summary-table" id="monthlySummaryTable">
							  <thead>
								<tr>
								  <th>AY</th>
								  <th>DEKOR</th>
								  <th>DERI</th>
								  <th>DIGER</th>
								  <th>TOPLAM</th>
								  <th>Değişim</th>
								</tr>
							  </thead>
							  <tbody id="monthlySummaryTableBody">
								<!-- JavaScript ile doldurulacak -->
							  </tbody>
        
							</table>
						</td>

					</tr>
				</table>
				<table class="summary-container">
					<tr>
					
					<td class="topsummary-wrapper">
						  <h3>Top 10 Müşteri Performansı - Sipariş</h3>
						  <table id="top10CustomerPerformanceTable" class="montlysummary-table">
							<!-- <thead>
							  <tr>
								<th>Satış Grubu</th>
								<th> Müşteri Adı</th>
								<th>Önceki Yıl Toplam</th>
								<th>Önceki Yıl Ortalama</th>
								<th>Bu Yıl Toplam</th>
								<th>Bu Yıl Ortalama</th>
								<th>Oran</th>
							  </tr>
							</thead>-->
							<tbody id="top10CustomerPerformanceTableBody">
							  <!-- Veriler JS ile buraya eklenecek -->
							</tbody>
						  </table>
						</td>
						
					</tr>
				</table>	
			</div>
			
		<div class="modal fade" id="imageModal" tabindex="-1" role="dialog" aria-labelledby="imageModalLabel" aria-hidden="true">
			<div class="modal-dialog modal-lg modal-dialog-centered" role="document">
				<div class="modal-content">
					<div class="modal-header">
						<h5 class="modal-title" id="imageModalLabel">Büyük Görsel</h5>
						
						<button type="button" class="close" data-dismiss="modal" aria-label="Close">
							<span aria-hidden="true">&times;</span>
						</button>
					</div>
					<div class="modal-body">
						<div id="modalCarousel" class="carousel slide" data-ride="carousel">
							<!-- Fotoğraf Sayısını Gösteren Noktalar -->
							<ol class="carousel-indicators" id="modalCarouselIndicators">
								<!-- Dinamik olarak buraya eklenecek -->
							</ol>
							<div class="carousel-inner" id="modalCarouselInner">
								<!-- Görseller buraya eklenecek -->
							</div>
							<a class="carousel-control-prev" href="#modalCarousel" role="button" data-slide="prev">
								<span class="carousel-control-prev-icon" aria-hidden="true"></span>
								<span class="sr-only">Previous</span>
							</a>
							<a class="carousel-control-next" href="#modalCarousel" role="button" data-slide="next">
								<span class="carousel-control-next-icon" aria-hidden="true"></span>
								<span class="sr-only">Next</span>
							</a>
						</div>
					</div>
				</div>
			</div>
		</div>
 
<!-- Stok Depo Durum Raporu -->
<div id="stockInventoryContainer" style="display:none; padding:15px; margin-left:15%">
<h4>Stok Depo Durum</h4>
  <div class="form-row">
    <div class="col-md-3">
      <label for="dateInput">Tarih</label>
      <input type="date" id="dateInput" class="form-control"/>
    </div>
    <div class="col-md-3">
      <label for="depoDropdown">Depo</label>
      <select id="depoDropdown" class="form-control"></select>
    </div>
    <div class="col-md-3 align-self-end">
      <button id="loadStockBtn" class="btn btn-primary">Getir</button>
	  <button id="exportStockBtn" class="btn btn-success ml-2">Excele Aktar</button>
    </div>
  </div>
  <hr>
</div>
<!-- **YENİ**: Rapor bu alanda gösterilecek -->
<div id="stockReportContainer" style="display:none;  padding:0 5px; margin-left: 15%; margin-right: 5%; font-size: 10px; height: 75vh; overflow-y: auto; ">
  <!-- loadStockInventoryReport() ile doldurulacak -->
</div>		
<!-- Kampanya -->
<!-- Kampanya Yönetim Paneli Sekmesi (Admin Paneli) -->
<div class="tab-pane fade" id="campaignPanel">
  <div class="container mt-4">
    <h3 class="mb-3">Kampanya Yönetimi</h3>
    <!-- Kampanya Oluşturma Formu -->
    <form id="campaignForm">
	  <!-- Gizli kampanya ID alanı: Eğer dolu ise, düzenleme yapılacak -->
	  <input type="hidden" id="campaignId" name="campaignId" value="">
	  <div class="form-row">
		<div class="form-group col-md-6">
		  <label for="campaignName">Kampanya Adı</label>
		  <input type="text" class="form-control" id="campaignName" placeholder="Kampanya adını giriniz" required>
		</div>
		<div class="form-group col-md-3">
		  <label for="campaignType">Kampanya Türü</label>
		  <select class="form-control" id="campaignType" required>
			<!-- Varsayılan seçenek: boş ve disabled -->
			<option value="" disabled selected>Kampanya Türü Seçiniz</option>
			<option value="PRODUCT">Ürün İndirimi</option>
			<!-- <option value="CART">Sepet İndirimi</option>
			<option value="BUY_X_GET_Y">X Al Y Öde / Bedava</option>
			<option value="Nth_Product_Discount">X. Ürüne İndirim</option> -->
			<option value="CATEGORY_CART">Kategori Bazlı İndirim</option>
		  </select>
		</div>
	  </div>
	  
	  <div class="form-group col-md-9">
		<label for="campaignDescription">Açıklama</label>
		<textarea class="form-control" id="campaignDescription" rows="2" placeholder="Kampanyanın açıklamasını giriniz"></textarea>
	  </div>
	  
	  <div class="form-row">
		<div class="form-group col-md-3">
		  <label for="startDate">Başlangıç Tarihi</label>
		  <input type="datetime-local" class="form-control" id="startDate" required>
		</div>
		<div class="form-group col-md-3">
		  <label for="endDate">Bitiş Tarihi</label>
		  <input type="datetime-local" class="form-control" id="endDate" required>
		</div>
		<div class="form-group col-md-3 align-self-end">
		  <div class="form-check">
			<input class="form-check-input" type="checkbox" id="includeSubCategories">
			<label class="form-check-label" for="includeSubCategories">
			  Alt Kategorileri Dahil Et
			</label>
		  </div>
		</div>
	  </div>
	  
	  <!-- İndirim Değeri ve Türü -->
	  <div class="form-row">
		<div class="form-group col-md-2">
		  <label for="discountType">İndirim Tipi</label>
		  <select class="form-control" id="discountType">
			<option value="PERCENT">Yüzde (%)</option>
			<option value="FIXED">Sabit Tutar (TL)</option>
		  </select>
		</div>
		<div class="form-group col-md-4">
		  <label for="discountValue">İndirim Değeri</label>
		  <input type="number" class="form-control" id="discountValue" step="any" placeholder="Lütfen bir sayı giriniz (% işareti kullanmayınız.)" required>
		</div>
	  </div>
	  
	  <!-- Diğer Kampanyalarla Birleştirilebilirlik -->
	  <div class="form-group">
		<label>Diğer Kampanyalarla Birleştirilebilir Mi?</label>
		<div class="form-check">
		  <input class="form-check-input" type="radio" name="isCombinable" id="combinableYes" value="true" checked>
		  <label class="form-check-label" for="combinableYes">Evet</label>
		</div>
		<div class="form-check">
		  <input class="form-check-input" type="radio" name="isCombinable" id="combinableNo" value="false">
		  <label class="form-check-label" for="combinableNo">Hayır</label>
		</div>
	  </div>
	  
	  <!-- Kampanya Türüne Göre Seçim Alanları -->
	  <!-- Kategori Seçimi Alanı: Sadece Kategori Bazlı İndirim için gösterilecek -->
	  <div class="form-group" id="categorySelectionSection" style="display: none;">
		<label for="campaignCategories">Kategori Seçimi</label>
		<div id="campaignCategoriesTree"></div>
		<input type="hidden" id="selectedCategories" name="selectedCategories">
	  </div>
	  
	  <!-- Ürün Bazında Kampanya Alanı: Sadece Ürün İndirimi için gösterilecek -->
	  <div id="productSelectionSection" style="display: none;">
		<div class="form-group">
		  <label for="discountedProducts">İndirimli Ürün Seçimi</label>
		  <select id="discountedProducts" class="selectpicker" data-live-search="true" data-size="10">
			<option value="">Ürün Seçiniz...</option>
		  </select>
		</div>
		<!-- "Ürünü Ekle" butonu -->
		<button type="button" id="addProductBtn" class="btn btn-secondary mb-3" onclick="addProductToCampaign()">Ürünü Ekle</button>
		<!-- Seçilen Ürünler Listesi -->
		<div class="mt-3">
		  <h5>Seçilen Ürünler</h5>
		  <table class="table table-bordered" id="selectedProductsTable">
			<thead>
			  <tr>
				<th>Fotoğraf</th>
				<th>KOD</th>
				<th>ADI</th>
				<th>EBAT</th>
				<th>MODEL</th>
				<th>İşlem</th>
			  </tr>
			</thead>
			<tbody>
			  <!-- Seçilen ürünler buraya eklenecek -->
			</tbody>
		  </table>
		</div>
	  </div>
	  
	  <button type="submit" class="btn btn-primary">Kampanyayı Kaydet</button>
	</form>

    
    <hr>
    <!-- Mevcut Kampanyaların Listelendiği Bölüm -->
    <h4>Mevcut Kampanyalar</h4>
    <table class="table table-bordered" id="campaignsTable">
      <thead>
        <tr>
          <th>ID</th>
          <th>Ad</th>
          <th>Tür</th>
          <th>Başlangıç Tarihi</th>
          <th>Bitiş Tarihi</th>
          <th>Alt Kategoriler</th>
          <th>İşlemler</th>
        </tr>
      </thead>
      <tbody>
        <!-- Kampanya kayıtları JavaScript ile yüklenecek -->
      </tbody>
    </table>
  </div>

</div>

<!-- Kampanya Düzenleme Modalı -->
<div class="modal fade" id="editCampaignModal" tabindex="-1" aria-labelledby="editCampaignModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="editCampaignModalLabel">Kampanya Düzenle</h5>
        <button type="button" class="close" data-dismiss="modal" aria-label="Kapat">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body">
        <form id="editCampaignForm">
          <!-- Gizli ID alanı -->
          <input type="hidden" id="editCampaignId">
          <!-- Diğer form alanlarını, düzenleme formunun kampanya formu ile benzer şekilde ekleyin -->
          <div class="form-group">
            <label for="campaignNameEdit">Kampanya Adı</label>
            <input type="text" class="form-control" id="campaignNameEdit" required>
          </div>
          <!-- Örnek: Kampanya Türü, Açıklama, Tarihler, İndirim bilgileri... -->
          <!-- ... -->
          <button type="submit" class="btn btn-primary">Güncelle</button>
        </form>
      </div>
    </div>
  </div>
</div>

<!-- 📌 Fiyat Güncelleme Onay Modali -->
<div class="modal fade" id="priceUpdateModal" tabindex="-1" aria-labelledby="priceUpdateModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="priceUpdateModalLabel">📊 Sepet Fiyat Güncellemesi</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Kapat">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <p><strong>⚠️ Yeni fiyatlar ile eski fiyatlar arasında fark tespit edildi!</strong></p>
                <table class="table table-bordered">
                    <thead>
                        <tr>
                            <th>Ürün ID</th>
                            <th>Eski Fiyat</th>
                            <th>Yeni Fiyat</th>
                            <th>Fark</th>
                        </tr>
                    </thead>
                    <tbody id="priceUpdateTableBody">
                        <!-- 📌 JavaScript ile doldurulacak -->
                    </tbody>
                    <tfoot>
                        <tr>
                            <th colspan="3">Toplam Değişim:</th>
                            <th id="totalPriceDifference">0</th>
                        </tr>
                    </tfoot>
                </table>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">İptal</button>
                <button type="button" class="btn btn-primary" id="confirmPriceUpdate">Fiyatları Güncelle</button>
            </div>
        </div>
    </div>
</div>
<!-- Öneri Modalı -->
<div class="modal fade" id="suggestionModal" tabindex="-1" role="dialog" aria-labelledby="suggestionModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg modal-dialog-centered modal-dialog-scrollable" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="suggestionModalLabel">Önerilen Ürünler</h5>
        <button type="button" class="close" data-dismiss="modal" aria-label="Kapat">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body" id="suggestionModalBody">
        <!-- Öneri listesi buraya yüklenecek -->
      </div>
    </div>
  </div>
</div>

<!-- Karşılaştırma Modalı -->
<div id="compareModal" class="modal fade" tabindex="-1" role="dialog">
    <div class="modal-dialog modal-lg" role="document">
        <div class="modal-content">
            <div class="modal-header d-flex justify-content-between align-items-center">
                <h5 class="modal-title">Ürün Karşılaştırma</h5>
                <div>
                    <button class="btn btn-danger btn-sm me-2" onclick="clearCompareList()">
                        <i class="fas fa-trash-alt"></i> Tümünü Kaldır
                    </button>
                    <button class="btn btn-secondary btn-sm" data-dismiss="modal">
                        <i class="fas fa-times"></i> Kapat
                    </button>
                </div>
            </div>
            <div class="modal-body">
                <div class="row" id="compareProductsContainer">
                    <!-- Ürünler buraya gelecek -->
                </div>
            </div>
        </div>
    </div>
</div>


<!-- Karşılaştırma Butonu (Footer) -->
<div id="compareFooter" style="display: none; position: fixed; bottom: 0; width: 100%; background: #333; color: white; padding: 10px; text-align: center;">
    <button class="btn btn-secondary" onclick="openCompareModal()">
        <i class="fas fa-exchange-alt"></i> Ürünleri Karşılaştır
    </button>
</div>

<!-- Konfigürasyon Modalı -->
<div class="modal fade" id="configureModal" tabindex="-1" aria-labelledby="configureModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="configureModalLabel">Ürün Özelleştirme</h5>
        <button type="button" class="close" data-dismiss="modal" aria-label="Kapat">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body">
        <form id="configForm">
          <!-- Hidden Field for Cart Item ID -->
          <input type="hidden" id="configCartItemId" />

          <!-- Reference Code (Read-Only) -->
          
			<div class="form-row">
				<div class="form-group col-md-2">
					<label for="referenceCodeInput" style="font-weight: bold;">Referans Kod</label>
					<input type="text" class="form-control" id="referenceCodeInput" placeholder="Referans kod" readonly />
			  </div>
			  <!-- Custom Code -->
			  <div class="form-group col-md-2">
				<label for="customCodeInput" style="font-weight: bold;">Özel Kod</label>
				<input type="text" class="form-control" id="customCodeInput" placeholder="Örneğin özel kod girin" />
			  </div>

			  <!-- Custom Name -->
			  <div class="form-group col-md-6">
				<label for="customNameInput" style="font-weight: bold;">Ürün Adı</label>
				<input type="text" class="form-control" id="customNameInput" placeholder="Serbest yazılabilir ürün adı" />
			  </div>
			</div>
          <div class="form-row">
            <!-- MODEL -->
            <div class="form-group col-md-2">
              <label for="modelSelect" style="font-weight: bold;">MODEL</label>
              <select id="modelSelect" class="form-control selectpicker" data-live-search="true">
                <option value="">Seçiniz</option>
                <!-- Model seçenekleri dinamik olarak doldurulacak -->
              </select>
            </div>
			<!-- EBAT -->
            <div class="form-group col-md-2">
              <label for="ebatSelect" style="font-weight: bold;">EBAT</label>
			  <select id="ebatSelect" class="form-control selectpicker" data-live-search="true">
                <option value="">Seçiniz</option>
                <!-- Ebat seçenekleri dinamik olarak doldurulacak -->
              </select>
            </div>

            <!-- RENK -->
            <div class="form-group col-md-2">
              <label for="renkSelect" style="font-weight: bold;">RENK</label>
			  <select id="renkSelect" class="form-control selectpicker" data-live-search="true">
                <option value="">Seçiniz</option>
                <!-- Renk seçenekleri dinamik olarak doldurulacak -->
              </select>
            </div>
            <!-- MATERYAL -->
            <div class="form-group col-md-2">
              <label for="materyalSelect" style="font-weight: bold;">MATERYAL</label>
			  <select id="materyalSelect" class="form-control selectpicker" data-live-search="true">            
                <option value="">Seçiniz</option>
                <!-- Materyal seçenekleri dinamik olarak doldurulacak -->
              </select>
            </div>
                   
            <!-- DESEN -->
            <div class="form-group col-md-2">
              <label for="desenSelect" style="font-weight: bold;">DESEN</label>
			  <select id="desenSelect" class="form-control selectpicker" data-live-search="true">
                <option value="">Seçiniz</option>
                <!-- Desen seçenekleri dinamik olarak doldurulacak -->
              </select>
            </div>

            <!-- LAMINE -->
            <div class="form-group col-md-2">
              <label for="lamineSelect" style="font-weight: bold;">LAMINE</label>
			  <select id="lamineSelect" class="form-control selectpicker" data-live-search="true">
                <option value="">Seçiniz</option>
                <!-- Lamine seçenekleri dinamik olarak doldurulacak -->
              </select>
            </div>
          </div>

          <div class="form-row">
            <!-- AKSESUAR1 -->
            <div class="form-group col-md-2">
              <label for="aksesuar1Select" style="font-weight: bold;">AKSESUAR 1</label>
			  <select id="aksesuar1Select" class="form-control selectpicker" data-live-search="true">
                <option value="">Seçiniz</option>
                <!-- Aksesuar1 seçenekleri dinamik olarak doldurulacak -->
              </select>
            </div>

            <!-- AKSESUAR2 -->
            <div class="form-group col-md-2">
              <label for="aksesuar2Select" style="font-weight: bold;">AKSESUAR 2</label>
			  <select id="aksesuar2Select" class="form-control selectpicker" data-live-search="true">
                <option value="">Seçiniz</option>
                <!-- Aksesuar2 seçenekleri dinamik olarak doldurulacak -->
              </select>
            </div>

            <!-- AKSESUAR3 -->
            <div class="form-group col-md-2">
              <label for="aksesuar3Select" style="font-weight: bold;">AKSESUAR 3</label>
			  <select id="aksesuar3Select" class="form-control selectpicker" data-live-search="true">
                <option value="">Seçiniz</option>
                <!-- Aksesuar3 seçenekleri dinamik olarak doldurulacak -->
              </select>
            </div>
			<!-- AYAK -->
            <div class="form-group col-md-2">
              <label for="aksesuar3Select"  style="font-weight: bold;">AYAK</label>
			  <select id="ayakSelect" class="form-control selectpicker" data-live-search="true">
                <option value="">Seçiniz</option>
                <!-- Aksesuar3 seçenekleri dinamik olarak doldurulacak -->
              </select>
            </div>
          </div>
        

          <!-- Diğer Alanlar (Gerekirse Ekleyebilirsiniz) -->
          <!-- Örneğin: AKSESUAR4, AKSESUAR5 vb. -->
        </form>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-dismiss="modal">Kapat</button>
        <button type="button" class="btn btn-primary" onclick="saveConfig()">Kaydet</button>
      </div>
    </div>
  </div>
</div>



	<!-- Sepet Oluşturma Modalı -->
<div class="modal fade" id="cartFormModal" tabindex="-1" role="dialog" aria-labelledby="cartFormModalLabel" aria-hidden="true">
  <div class="modal-dialog" role="document">
    <div class="modal-content">
      <!-- Modal Başlığı -->
      <div class="modal-header">
        <h5 class="modal-title" id="cartFormModalLabel">Yeni Sepet Oluştur</h5>
        <button type="button" class="close" onclick="closeCartFormModal()" aria-label="Kapat">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <!-- Modal İçeriği -->
      <div class="modal-body">
        <form id="cartForm">
          <!-- Müşteri Tipi ve Satış Bölgesi (aynı satırda) -->
          <div class="form-row">
            <!-- Müşteri Tipi -->
            <div class="form-group col-md-6">
              <label for="customerType">Müşteri Tipi</label>
              <select id="customerType" class="form-control" onchange="updatePriceTypeOptions()">
                <option value="perakende">Perakende</option>
                <option value="kurumsal">Kurumsal</option>
                <option value="toptan">Toptan</option>
              </select>
            </div>
            <!-- Satış Bölgesi -->
            <div class="form-group col-md-6">
              <label for="salesArea">Satış Bölgesi</label>
              <select id="salesArea" class="form-control">
                <option value="yurtici">Yurtiçi</option>
                <option value="yurtdisi">Yurtdışı</option>
              </select>
            </div>
          </div>
          <!-- Müşteri Adı -->
          <div class="form-group">
            <label for="cartName">Müşteri Adı</label>
            <input type="text" id="cartName" class="form-control" placeholder="Sepet Adı" required>
          </div>
          <!-- Fiyat Tipi ve KDV Dahil/Hariç aynı satırda -->
          <div class="form-row">
            <!-- Fiyat Tipi -->
            <div class="form-group col-md-6">
              <label for="priceType">Fiyat Tipi</label>
              <select id="priceType" class="form-control">
                <!-- Varsayılan olarak Perakende/Kurumsal seçenekleri -->
                <option value="1">PRK TL</option>
                <option value="4">PRK USD</option>
                <option value="5">PRK EUR</option>
              </select>
            </div>
            <!-- KDV Dahil/Hariç -->
            <div class="form-group col-md-6">
              <label for="vatIncluded">KDV Dahil/Hariç</label>
              <select id="vatIncluded" class="form-control">
                <option value="1">Dahil</option>
                <option value="0">Hariç</option>
              </select>
            </div>
          </div>
          <!-- İndirim Oranı -->
          <div class="form-group">
            <label for="discountRate">İndirim Oranı</label>
            <input type="number" id="discountRate" class="form-control" placeholder="İndirim Oranı" min="0" max="100" step="1">
          </div>
        </form>
      </div>
      <!-- Modal Alt Bilgi -->
      <div class="modal-footer">
        <button type="button" class="btn btn-primary" onclick="closeCartFormModal()">Kapat</button>
        <button type="button" class="btn btn-primary" onclick="createCart()">Sepet Oluştur</button>
      </div>
    </div>
  </div>
</div>

<!-- Sepet Modalı -->
<div class="modal fade" id="cartModal" tabindex="-1" role="dialog" aria-labelledby="cartModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg modal-dialog-scrollable" role="document">
    <div class="modal-content">
      <!-- Modal Başlığı -->
      <div class="modal-header">
        <h5 class="modal-title" id="cartModalLabel">Sepet İçeriği</h5>
        <button type="button" class="close" onclick="closeCartModal()" aria-label="Kapat">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>

      <!-- Modal İçeriği -->
      <div class="modal-body">
        <!-- Sepet Detayları -->
        <div id="cartDetails" class="mb-3">
          <!-- 1. Satır: Müşteri Adı (Sol 50%) ve Müşteri Tipi + Satış Bölgesi (Sağ 50%) -->
          <div class="row">
		

			<div class="col-md-2">
			  <strong>Cari Kodu:</strong>
			  <select id="ckartSelect" class="form-control" data-live-search="true">
				<option value="">Seçiniz</option>
			  </select>
			</div>

            <!-- Müşteri Adı -->
            <div class="col-md-2">
              <strong>Müşteri Adı:</strong> <span id="cartNameDisplay"></span>
            </div>
            <!-- Müşteri Tipi ve Satış Bölgesi -->
            <div class="col-md-8">
              <div class="row">
				<div class="col-md-2">
                  <strong>Konsept Alanı:</strong> <span id="conceptarea"></span>
                </div>
                <div class="col-md-2">
                  <strong>Müşteri Tipi:</strong> <span id="customerTypeDisplay"></span>
                </div>
                <div class="col-md-2">
                  <strong>Satış Bölgesi:</strong> <span id="salesAreaDisplay"></span>
                </div>
				<div class="col-md-4">
                  <strong>Ödeme Şartları:</strong> <span id="paymentTermsDisplay"></span>
                </div>
				<div class="col-md-2">
                  <strong>Termin Süresi:</strong> <span id="deliveryTimeDisplay"></span>
                </div>              
			  
            </div>
            </div>
          </div>
          <!-- 2. Satır: Fiyat Tipi, KDV Dahil/Hariç ve İndirim Oranı -->
          <div class="row mt-2">
            <div class="col-md-2">
              <strong>Fiyat Tipi:</strong> <span id="priceTypeDisplay"></span>
            </div>
            <div class="col-md-2">
              <strong>KDV Dahil/Hariç:</strong> <span id="vatIncludedDisplay"></span>
            </div>
            <div class="col-md-1">
              <strong>İndirim Oranı:</strong><br>
              <span id="discountRateDisplay"></span>
            </div>
			<div class="col-md-2">
				<strong>Banka:</strong> <span id="bankDisplay"></span>
			</div>
          </div>
          <!-- Konsept Banner Alanı -->
          <div id="conceptBannerContainer" style="display: none; text-align: center;">
            <img id="conceptBannerImg" src="/resim/banner/default-banner.jpg" style="max-width: 100%; height: auto;">
            <div id="selectBannerButtonContainer"></div>
          </div>
        </div>

        <!-- Sepet Ürünleri İçeriği -->
        <div id="modalCartContent">
          <!-- Sepet ürünleri dinamik olarak buraya yüklenecek -->
          <p class="text-center text-muted">Sepetiniz boş.</p>
        </div>
		 
			  
		</div>

      <!-- Modal Alt Bilgi -->
      <div class="modal-footer d-flex justify-content-between">
	  <!-- Yeni eklenen Navlun ve Sigorta giriş satırı -->
	 
        <div>
          <button type="button" class="btn btn-secondary" onclick="$('#cartListModal').modal('show')">Sepetleri Görüntüle</button>
          <button type="button" class="btn btn-success" onclick="$('#cartFormModal').modal('show')">Sepet Oluştur</button>
		  
        </div>
		<div>
		<button type="button" class="btn btn-danger" onclick="clearCart()">Sepeti Temizle</button>
        </div>
		<div>
          <button class="btn btn-warning" onclick="checkCartPriceChanges(activeCartId)">🔄 Fiyatları Güncelle</button>
        </div>
        <div>
          <button type="button" class="btn btn-primary" onclick="closeCartModal()">Kapat</button>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- 📌 Detay Raporda Açılan KOD popup - Hangi Konseptlerde var -->
<div id="kodPopup" class="kod-popup"></div>

	<!-- 📌 Banner Seçim Modalı -->
<div class="modal fade" id="bannerSelectionModal" tabindex="-1" aria-labelledby="bannerSelectionModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Konsept Banner Seç</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Kapat">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <div id="bannerImagesContainer" class="d-flex flex-wrap justify-content-center">
                    <!-- Fotoğraflar buraya yüklenecek -->
                </div>
            </div>
        </div>
    </div>
</div>


	
	<!-- Sepetler Listesi Modal -->
	<div class="modal fade" id="cartListModal" tabindex="-1" role="dialog" aria-labelledby="cartListModalLabel" aria-hidden="true">
		<div class="modal-dialog modal-dialog-centered" style="max-width: 70%;" role="document">
			<div class="modal-content">
				<div class="modal-header">
					<h5 class="modal-title" id="cartListModalLabel">Sepetler</h5>
					<button type="button" class="close" onclick="closeCartListModal()" aria-label="Kapat">
						<span aria-hidden="true">&times;</span>
					</button>
				</div>
				<div class="modal-body" id="cartListModalBody">
					<!-- Sepetler burada listelenecek -->
				</div>
				<div class="modal-footer">
				  <!-- Yenileme butonu -->
				  <button class="btn btn-secondary" onclick="showCartList()">
					<i class="fas fa-sync-alt"></i> Yenile
				  </button>
				  <!-- Konsept sepetlerini göster/gizle butonu -->
				  <button class="btn btn-info" id="toggleConceptCartsBtn" onclick="toggleConceptCarts()">
					<i class="fas fa-eye"></i> Konseptleri Göster
				  </button>
				  <button type="button" class="btn btn-success" onclick="$('#cartFormModal').modal('show')">
					Sepet Oluştur
				  </button>
				  <button type="button" class="btn btn-primary" onclick="closeCartListModal()">
					Kapat
				  </button>
				</div>

				
			</div>
		</div>
		

	</div>
<!-- Excel Dosyası Seçimi ve Güncelleme Modalı -->
	<div id="priceUpdateContainer" style="display: none; margin: 15px; border: 1px solid #ccc; padding: 15px; background: #f9f9f9;">
	  <h5>Fiyat Güncelleme</h5>
	  <div class="form-group">
		<label for="excelFileInput">Excel Dosyası Seçiniz:</label>
		<input type="file" id="excelFileInput" accept=".xlsx, .xls" class="form-control">
	  </div>
	  <button class="btn btn-primary" onclick="updatePrices()">Uygula</button>
	</div>

	
<!-- **NAVBAR** -->
<nav class="navbar navbar-expand-lg navbar-light bg-light">
    <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
        <span class="navbar-toggler-icon"></span>
    </button>
    <div class="collapse navbar-collapse" id="navbarNav">
        <!-- **Sol Menü** -->
        <ul class="navbar-nav mr-auto">
            <li class="nav-item dropdown">
                <a class="nav-link dropdown-toggle" href="#" id="urunlerMenu" role="button" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                    Ürünler
                </a>
                <ul class="dropdown-menu" aria-labelledby="urunlerMenu" id="urunlerDropdown"></ul>
            </li>
			<!-- Konseptler Menüsü -->
            <li class="nav-item dropdown">
				<a class="nav-link dropdown-toggle" href="#" id="conceptsDropdownToggle" role="button" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
					Konseptler
				</a>
				<div class="dropdown-menu" id="conceptsDropdown" aria-labelledby="conceptsDropdownToggle">
					<!-- Konseptler buraya dinamik olarak eklenecek -->
				</div>
			
			<li class="nav-item dropdown">
			  <a class="nav-link dropdown-toggle" href="#" id="islevlerMenu" role="button" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
				İşlevler
			  </a>
			  <div class="dropdown-menu" aria-labelledby="islevlerMenu">
			  <div class="dropdown-submenu">
				  <a class="dropdown-item dropdown-toggle" href="#">Stok</a>
				  <ul class="dropdown-menu">
					<li>
					  <a class="dropdown-item" href="#" id="stokKartiMenuItem" onclick="showStokKartiContainer()">Stok Kartı</a>
					</li>
					<li>
						<a class="dropdown-item" href="#" id="stock-depo-status">Stok Depo Durum</a>
					  </li>
					<li>
					  <a class="dropdown-item" href="#" id="priceUpdateMenuItem" onclick="showPriceUpdateContainer()">Fiyat Güncelleme</a>
					</li>
				  </ul>
				  
				</div>
			  
				<!-- Etiket Alt Menüsü -->
				<div class="dropdown-submenu">
				  <a class="dropdown-item dropdown-toggle" href="#">Etiket</a>
				  <ul class="dropdown-menu">
					<li>
					  <a class="dropdown-item" href="#" onclick="showBarcodeContainer()">Barkod Basımı</a>
					</li>
					<li>
					  <a class="dropdown-item" href="#" onclick="showconceptLabelContainer()">Konsept Etiketi</a>
					</li>
				  </ul>
				  
				</div>
				 <!-- Yeni: Kampanya Öğesi -->
					<div class="dropdown-submenu" id="campaignMenu">
					  <a class="dropdown-item" href="#" onclick="showCampaignPanel()">Kampanya Yönetim Paneli</a>
					</div>
			  </div>
			</li>


        </ul>
       

        <!-- **Ortalanmış veya Admin'e Göre Yerleştirilen Logo** -->
        <div id="logoContainer" class="navbar-center">
            <img src="/resim/EDLogo.png" alt="EDLOGO" class="navbar-logo">
        </div>

        <!-- **Admin Sekmeleri (Sadece Adminler Görür)** -->
        <ul class="nav nav-tabs custom-tabs admin-tabs" id="adminTabs" style="display: none;">
            <li class="nav-item">
                <a class="nav-link active" id="tab-home" data-toggle="tab" href="#home">
                    <i class="fas fa-home"></i> Ana Sayfa
                </a>
            </li>
            <li class="nav-item">
                <a class="nav-link" id="tab-admin" data-toggle="tab" href="#adminPanel">
                    <i class="fas fa-user-shield"></i> Admin Panel
                </a>
            </li>
            <li class="nav-item">
                <a class="nav-link" id="tab-reports" data-toggle="tab" href="#reports">
                    <i class="fas fa-chart-line"></i> Raporlar
                </a>
            </li>
        </ul>

        <!-- **Sağ Taraf: Kullanıcı ve Sepet Butonları** -->
        <ul class="navbar-nav ml-auto">
            <li class="nav-item" id="welcomeMessage" style="display: none; margin-right: 10px; margin-top: 3px; font-size: 14px; font-weight: bold; color: #727476;">
                Hoş geldin, <span id="usernameDisplay"></span>
            </li>
            <li class="nav-item">
                <button class="btn nav-link" id="threeProdBtn" title="Satırda Daha Az Ürün">
                    <i class="fas fa-th-large"></i>
                </button>
            </li>
            <li class="nav-item">
                <button class="btn nav-link active" id="fourProdBtn" title="Satırda Daha Çok Ürün">
                    <i class="fas fa-th"></i>
                </button>
            </li>
            <li class="nav-item">
                <button id="authButton" class="btn btn-primary">
                    <i id="authIcon" class="fa fa-sign-in"></i>
                </button>
            </li>
            <li class="nav-item ml-2">
                <button class="btn nav-link" onclick="loadCart()">
                    <i class="fas fa-shopping-cart"></i>
                </button>
            </li>
        </ul>
    </div>
</nav>

<!-- Admin Paneli içerisinde Stok Kartı container'ı -->
<div id="stokKartiContainer" style="display:none; padding:2px; max-width:87%; margin-left:2%; margin-top:2%">
  <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
    <h3 style="margin:0 0 0 10%;">Stok Kartı Yönetimi</h3>
		<div style="display:flex; align-items:center; gap:10px;">
	   <button class="btn btn-secondary" id="refreshTable" style="height: 35px;"><i class="fas fa-sync-alt"></i>Yenile</button>
	   <!-- Yeni Export Butonu -->
       <button id="exportFilteredButton" onclick="exportFilteredDataToExcel()" class="btn btn-secondary" style="height: 35px;">
		  <i class="fas fa-file-excel"></i> Excele Aktar
		</button>
	</div>
  </div>
  <!-- Tabulator grid için container -->
  <div id="hotContainer"></div>
</div>


	<!-- Kullanıcı Girişi Modal -->
	
	<div class="modal fade" id="loginModal" tabindex="-1" role="dialog" aria-labelledby="loginModalLabel" aria-hidden="true">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="loginModalLabel">Kullanıcı Girişi</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Kapat"></button>
            </div>
            <div class="modal-body">
                <form id="loginForm">
                    <div class="form-group">
                        <label for="username">Kullanıcı Adı</label>
                        <input type="text" id="username" class="form-control" placeholder="Kullanıcı Adı" required>
                    </div>
                    <div class="form-group">
                        <label for="password">Şifre</label>
                        <input type="password" id="password" class="form-control" placeholder="Şifre" required>
                    </div>
                    <button type="submit" class="btn btn-primary btn-block">Giriş Yap</button>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- Stok Kartı Detayı -->
<!-- Modal -->
<div class="modal fade" id="stockCardModal" tabindex="-1" role="dialog" aria-hidden="true">
  <div class="modal-dialog modal-lg" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">
          Stok Kartı — <span id="modalStockCode"></span>
        </h5>
        <button type="button" class="close" data-dismiss="modal">&times;</button>
      </div>
      <div class="modal-body">
        <div id="stockCardAccordion">
          <!-- Genel bölümü -->
          <div class="card">
            <div class="card-header" id="headingGenel">
              <h5 class="mb-0">
                <button class="btn btn-link" data-toggle="collapse" data-target="#collapseGenel"
                        aria-expanded="true" aria-controls="collapseGenel">
                  Genel
                </button>
              </h5>
            </div>
            <div id="collapseGenel" class="collapse show" aria-labelledby="headingGenel"
                 data-parent="#stockCardAccordion">
              <div class="card-body">
                <form>
                  <div class="form-row">
                    <div class="form-group col-md-4">
                      <label>KOD</label>
                      <input type="text" class="form-control" id="stockCode" disabled>
                    </div>
                    <div class="form-group col-md-4">
                      <label>ADI</label>
                      <input type="text" class="form-control" id="stockName" disabled>
                    </div>
                    <div class="form-group col-md-4">
                      <label>GRUP</label>
                      <input type="text" class="form-control" id="stockGroup" disabled>
                    </div>
                    <div class="form-group col-md-4">
                      <label>BİRİM</label>
                      <select id="stockUnit" class="form-control">
                        <option>Adet</option>
                        <option>Ft2</option>
                        <option>Dsm2</option>
                        <option>M2</option>
                        <option>Metre Kg</option>
                        <option>Set</option>
                      </select>
                    </div>
                    <div class="form-group col-md-4">
                      <label>BARKOD</label>
                      <input type="text" class="form-control" id="stockBarcode" disabled>
                    </div>
                    <div class="form-group col-md-4">
                      <label>KDV</label>
                      <input type="text" class="form-control" id="stockKDV" disabled>
                    </div>
                  </div>
                </form>
              </div>
            </div>
          </div>
          <!-- Diğer kart bölümleri burada -->
        </div>
      </div>
    </div>
  </div>
</div>


<!-- 3d Modal yapınızda bir canvas ekleyin, örneğin: -->
<div id="threeModal" class="modal fade" tabindex="-1" role="dialog">
  <div class="modal-dialog modal-lg modal-dialog-centered" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">3D Fotoğraf Görüntüleme</h5>
        <button type="button" class="close" data-dismiss="modal" aria-label="Kapat">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body">
        <canvas id="threeCanvas" style="width: 100%; height: 500px;"></canvas>
      </div>
    </div>
  </div>
</div>

<!-- Barkod Basımı Konteynerı -->
<div id="barcodeContainer" style="display:none; padding:15px;">
  <h4>Barkod Basımı</h4>
  <div class="filter-container">
    <div class="form-group">
      <label for="barcodeBasamak2">Basamak 2:</label>
      <select id="barcodeBasamak2" class="form-control selectpicker" data-live-search="true">
        <!-- Dinamik doldurulacak -->
      </select>
    </div>
    <div class="form-group">
      <label for="barcodeBasamak4">Basamak 4:</label>
      <select id="barcodeBasamak4" class="form-control selectpicker" data-live-search="true">
        <!-- Basamak2 seçimine göre doldurulacak -->
      </select>
    </div>
	<div class="form-group">
      <label for="barcodeKod">Kod</label>
      <select id="barcodeKod" class="form-control selectpicker" data-live-search="true">
        <!-- Basamak2 seçimine göre doldurulacak -->
      </select>
    </div>
    <div class="form-group">
      <label>
        <input type="checkbox" id="filterStoklu"> Stoklu (HM > 0)
      </label>
    </div>
    <div class="form-group">
      <label>Fiyat Gösterimi:</label>
      <label>
        <input type="radio" name="priceOption" value="with" checked> Fiyatlı
      </label>
      <label>
        <input type="radio" name="priceOption" value="without"> Fiyatsız
      </label>
    </div>
    <div class="form-group">
      <label>Etiket Tipi:</label>
      <label>
        <input type="radio" name="labelType" value="large" checked> Büyük Etiket
      </label>
      <label>
        <input type="radio" name="labelType" value="small"> Küçük Etiket
      </label>
    </div class="form-group">
    <button class="btn btn-primary" onclick="loadBarcodeProducts()">Barkod Oluştur</button>
	<!-- Yazdır butonu, Ürünleri Getir butonunun hemen altında -->
    
	<button style="margin-top: 5px" class="btn btn-success" onclick="printBarcodes()">Yazdır</button>
	
	<button style="margin-top: 5px" class="btn btn-danger" onclick="showfiltercontainer()">Çıkış</button>
	
  </div>
  <hr>
  <div id="barcodeLabelsContainer">
    <!-- Barkod etiketleri burada oluşturulacak -->
  </div>
  
</div>

<!-- Konsept Etiket Basımı -->
<div id="conceptLabelContainer" style="display:none; padding:15px;">
  <h4>Barkod Basımı</h4>
  <div class="filter-container">
    <!-- Mevcut filtre alanları ve dropdown’lar -->
    <!-- … -->

    <!-- Yeni: Konsept Türü Seçimi -->
    <div class="form-group">
      <label for="conceptTypeFilter">Ürün Tipi</label>
      <select id="conceptTypeFilter" class="form-control">
        <option value="ANA" selected>Ana Ürünler</option>
        <option value="EK">Ek Ürünler</option>
      </select>
    </div>

    <!-- Yeni: Konsept Etiketi dropdown -->
    <div class="form-group">
      <label for="conceptLabelDropdown">Konsept Etiketi Seçiniz</label>
      <select id="conceptLabelDropdown" class="form-control selectpicker" data-live-search="true">
        <option value="">Seçiniz</option>
        <!-- Burayı API’den dolduruyorsunuz -->
      </select>
    </div>

    <!-- Yeni: Etiket Dili Seçimi -->
    <div class="form-group">
      <label>Etiket Dili:</label><br>
      <label class="custom-checkbox-inline">
        <input type="checkbox" id="turkceEtiket" checked> Türkçe
      </label>
      <label class="custom-checkbox-inline" style="margin-left:10px;">
        <input type="checkbox" id="ingilizceEtiket"> İngilizce
      </label>
    </div>

    <!-- Butonlar -->
    <button class="btn btn-primary" onclick="loadConceptLabelPrint()">Etiket Oluştur</button>
    <button style="margin-top: 5px" class="btn btn-success" onclick="printConceptLabels()">Yazdır</button>
    <button style="margin-top: 5px" class="btn btn-danger" onclick="showfiltercontainer()">Çıkış</button>
  </div>
  <hr>
  <div id="conceptLabelsContainer">
    <!-- Barkod etiketleri burada oluşturulacak -->
  </div>
</div>



<!-- Hoş Geldiniz Modal -->
<div class="modal fade" id="welcomeModal" tabindex="-1" role="dialog" aria-labelledby="welcomeModalLabel" aria-hidden="true">
    <div class="modal-dialog welcome-modal" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="welcomeModalLabel">Hoş Geldiniz</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Kapat"></button>
            </div>
            <div class="modal-body text-center">
                <p>Giriş başarılı! Hoş geldiniz.</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-primary" id="closeWelcomeModal">Tamam</button>
            </div>
        </div>
    </div>
</div>

<!-- jQuery -->
    <script src="https://code.jquery.com/jquery-3.6.0.js"></script>
	<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
    
	<!-- Popper.js -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.16.1/umd/popper.min.js"></script>
	
    <!-- Bootstrap JS -->
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>
	
	<!-- Select2 CSS -->
	<link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />

	<!-- Select2 JS -->
	<script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
  
    <!-- Diğer JS Dosyaları -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.17.0/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/exceljs@4.3.0/dist/exceljs.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.4.0/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>
	  <!-- Bootstrap Select JS -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-select/1.13.18/js/bootstrap-select.min.js"></script>
	<!-- 📊 Chart.js Kütüphanesi -->
	<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
	<script src="https://cdn.jsdelivr.net/npm/jsbarcode@3.11.5/dist/JsBarcode.all.min.js"></script>
	
	  <!-- Tabulator JS -->
	 <script src="https://unpkg.com/tabulator-tables@5.4.4/dist/js/tabulator.min.js"></script>
	 <!-- jstree Kütüphanesi -->
	 <script src="https://cdnjs.cloudflare.com/ajax/libs/jstree/3.3.12/jstree.min.js"></script>
	
	<script>
		
		let currentPage = 1;
		const pageSize = 24; 
		let isFetching = false;
		let columns = 4; 
		let hasMoreProducts = true; 
		const loadedProductCodes = new Set();
		let abortController = new AbortController(); 
	    window.selectedCurrency = "TL"; // Varsayılan değer
		
		const container = document.getElementById('product-container');
		const admincontainer = document.getElementById('admin-product-container');
		const basamak2Select = document.getElementById('basamak2');
		const basamak4Select = document.getElementById('basamak4');
		const anamodelSelect = document.getElementById('anamodel');
		const modelSelect = document.getElementById('model');
		const ebatSelect = document.getElementById('ebat');
		const kodSelect = document.getElementById('kod');
		const applyFiltersButton = document.getElementById('applyFilters');
		const clearFiltersButton = document.getElementById('clearFilters');
		const threeProdBtn = document.getElementById('threeProdBtn');
		const fourProdBtn = document.getElementById('fourProdBtn');

		const updateColumns = (colCount) => {
			columns = colCount;
			document.documentElement.style.setProperty('--column-count', colCount);
			document.querySelectorAll('.product').forEach(product => {
				product.style.flex = `1 1 calc(100% / ${columns} - 20px)`;
			});
			threeProdBtn.classList.toggle('active', columns === 3);
			fourProdBtn.classList.toggle('active', columns === 4);
		};

		// Para birimi formatlama
	const formatCurrency = (value, priceType) => {
		// Para birimi türünü belirleme
		let currency;
		switch (priceType) {
			case 1:
				currency = 'TRY'; // Türk Lirası
				break;
			case 2:
				currency = 'TRY'; // Türk Lirası
				break;
			case 3:
				currency = 'USD'; // Amerikan Doları
				break;
			case 4:
				currency = 'USD'; // Amerikan Doları
				break;
			case 5:
				currency = 'EUR'; // Euro
				break;
			case 6:
				currency = 'EUR'; // Euro
				break;
			default:
				currency = 'TRY'; // Varsayılan olarak Türk Lirası
		}

		// Para birimini formatlama
		return new Intl.NumberFormat('tr-TR', {
			style: 'currency',
			currency: currency
		}).format(value);
	};

		// 📌 **Varsayılan container belirle**
            let targetContainerId = "product-container"; // 🌟 Varsayılan olarak ana sayfaya yükle
            const activeTab = document.querySelector(".nav-tabs .nav-link.active");
            if (activeTab) {
                const targetTab = activeTab.getAttribute("href").substring(1);
                if (targetTab === "adminPanel") {
                    targetContainerId = "admin-product-container";
                } else if (targetTab === "reports") {
                    targetContainerId = "report-product-container";
                }
            }
		const clearFilters = async () => {

			// 📌 **Dropdownları sıfırla**
			basamak2Select.value = '';
			basamak4Select.value = '';
			anamodelSelect.value = '';
			modelSelect.value = '';
			ebatSelect.value = '';
			kodSelect.value = '';

			// 📌 **Sayfa numarasını sıfırla**
			currentPage = 1;

			// 📌 **Boş filtre değerleri ile yükleme**
			await loadFilters({
				basamak2: '',
				basamak4: '',
				anamodel: '',
				model: '',
				ebat: ''
			});

			// 📌 **Selectpicker'ı güncelle**
			$(".selectpicker").selectpicker("refresh");

		};

		
		
		//filtreleri doldurma fonksiyonu.
		
		const loadFilters = async (selectedValues = {}) => {
			const response = await fetch(`http://192.168.30.4:3000/filter-options`);
			if (!response.ok) {
				console.error("Filtre API hatası:", response.status, response.statusText);
				return;
			}

			const filters = await response.json();
			
			const allBasamak2Set = new Set();
			const allBasamak4Set = new Set();
			const allAnamodelSet = new Set();
			const allModelSet = new Set();
			const allEbatSet = new Set();
			const allKodSet = new Set();

			const basamak4FilteredSet = new Set();
			const anamodelFilteredSet = new Set();
			const modelFilteredSet = new Set();
			const ebatFilteredSet = new Set();
			const kodFilteredSet = new Set();

			filters.forEach(filter => {
				if (filter.BASAMAK2) allBasamak2Set.add(filter.BASAMAK2);
				if (filter.BASAMAK4) allBasamak4Set.add(filter.BASAMAK4);
				if (filter.ANAMODEL) allAnamodelSet.add(filter.ANAMODEL);
				if (filter.MODEL) allModelSet.add(filter.MODEL);
				if (filter.EBAT) allEbatSet.add(filter.EBAT);
				if (filter.KOD) allKodSet.add(filter.KOD);

				if (filter.BASAMAK2 === selectedValues.basamak2) {
					if (filter.BASAMAK4) basamak4FilteredSet.add(filter.BASAMAK4);
					if (filter.ANAMODEL) anamodelFilteredSet.add(filter.ANAMODEL);
					if (filter.MODEL) modelFilteredSet.add(filter.MODEL);
					if (filter.EBAT) ebatFilteredSet.add(filter.EBAT);
					if (filter.KOD) kodFilteredSet.add(filter.KOD);
				}
				if (filter.BASAMAK4 === selectedValues.basamak4) {
					if (filter.ANAMODEL) anamodelFilteredSet.add(filter.ANAMODEL);
					if (filter.MODEL) modelFilteredSet.add(filter.MODEL);
					if (filter.EBAT) ebatFilteredSet.add(filter.EBAT);
					if (filter.KOD) kodFilteredSet.add(filter.KOD);
				}

				// 🔹 ANAMODEL seçildiğinde MODEL ve EBAT değerlerini filtrele
				if (selectedValues.anamodel) {
					modelFilteredSet.clear(); // 🔹 MODEL listesini sıfırla
					ebatFilteredSet.clear();  // 🔹 EBAT listesini sıfırla
					kodFilteredSet.clear();  // 🔹 KOD listesini sıfırla

					filters.forEach(filter => {
						const anamodelTrimmed = filter.ANAMODEL ? filter.ANAMODEL.trim().toLowerCase() : "";
						const selectedAnamodelTrimmed = selectedValues.anamodel.trim().toLowerCase();

						if (anamodelTrimmed === selectedAnamodelTrimmed) {
							if (filter.MODEL) modelFilteredSet.add(filter.MODEL.trim());
							if (filter.EBAT) ebatFilteredSet.add(filter.EBAT.trim());
							if (filter.KOD) kodFilteredSet.add(filter.KOD.trim());
						}
					});

					// 🔹 Eğer hiç MODEL veya EBAT bulunamadıysa tamamen temizle
					if (modelFilteredSet.size === 0) {
						modelFilteredSet.add("Model bulunamadı");
					}
					if (ebatFilteredSet.size === 0) {
						ebatFilteredSet.add("Ebat bulunamadı");
					}
					if (kodFilteredSet.size === 0) {
						kodFilteredSet.add("Kod bulunamadı");
					}

				}


				// 🔹 MODEL seçildiğinde EBAT değerlerini filtrele
				if (selectedValues.model) {
					filters.forEach(filter => {
						if (filter.MODEL === selectedValues.model) {
							if (filter.EBAT) ebatFilteredSet.add(filter.EBAT);
							if (filter.KOD) kodFilteredSet.add(filter.KOD);
						}
					});
				}

			});

			updateDropdown(basamak2Select, Array.from(allBasamak2Set), selectedValues.basamak2, "BASAMAK2");
			updateDropdown(
				basamak4Select,
				selectedValues.basamak2 ? Array.from(basamak4FilteredSet) : Array.from(allBasamak4Set),
				selectedValues.basamak4,
				"BASAMAK4"
			);
			updateDropdown(
				anamodelSelect,
				selectedValues.basamak4 || selectedValues.basamak2
					? Array.from(anamodelFilteredSet)
					: Array.from(allAnamodelSet),
				selectedValues.anamodel,
				"ANAMODEL"
			);
			updateDropdown(
				modelSelect,
				selectedValues.anamodel || selectedValues.basamak4
					? Array.from(modelFilteredSet)
					: Array.from(allModelSet),
				selectedValues.model,
				"MODEL"
			);
			updateDropdown(
				ebatSelect,
				selectedValues.model ? Array.from(ebatFilteredSet) : Array.from(allEbatSet),
				selectedValues.ebat,
				"EBAT"
			);
			updateDropdown(
				kodSelect,
				selectedValues.ebat ? Array.from(kodFilteredSet) : Array.from(allKodSet),
				selectedValues.kod,
				"KOD"
			);


			// 📌 **Tüm Selectpicker Elemanlarını Yenile**
			$(".selectpicker").selectpicker("refresh");
		};



		// Dropdown güncelleme fonksiyonu
		const updateDropdown = (dropdown, items, selectedValue, placeholder) => {
			dropdown.innerHTML = `<option value="">${placeholder}</option>`;

			// 📌 **Alfabetik sıralama**
			const sortedItems = items.sort((a, b) => a.localeCompare(b, 'tr', { sensitivity: 'base' }));

			sortedItems.forEach(item => {
				const option = document.createElement('option');
				option.value = item;
				option.textContent = item;
				if (item === selectedValue) {
					option.selected = true;
				}
				dropdown.appendChild(option);
			});

			// 📌 **Selectpicker'ı Güncelle**
			$(dropdown).selectpicker("refresh");
			
		};
		// Her dropdown değişikliğinde filtreleri yeniden yükle
		const selectElements = [
			{ element: basamak2Select, key: 'basamak2' },
			{ element: basamak4Select, key: 'basamak4' },
			{ element: anamodelSelect, key: 'anamodel' },
			{ element: modelSelect, key: 'model' },
			{ element: ebatSelect, key: 'ebat' },
			{ element: kodSelect, key: 'kod' }
		];

		const handleFilterChange = () => {
			const selectedValues = {
				basamak2: basamak2Select.value,
				basamak4: basamak4Select.value,
				anamodel: anamodelSelect.value,
				model: modelSelect.value,
				ebat: ebatSelect.value,
				kod: kodSelect.value
			};

			loadFilters(selectedValues);

			// 🔹 **ANAMODEL değişirse MODEL dropdown'unu sıfırla ve yeniden yükle**
		if (event.target.id === "anamodelSelect") {
			updateDropdown(modelSelect, [], "", "MODEL");
			loadFilters(selectedValues);
		}

		// 🔹 **MODEL değişirse EBAT dropdown'unu sıfırla ve yeniden yükle**
		if (event.target.id === "modelSelect") {
			updateDropdown(ebatSelect, [], "", "EBAT");
			updateDropdown(kodSelect, [], "", "KOD");
			loadFilters(selectedValues);
		}
		};


		// Tüm dropdown'lara olay dinleyicileri ekle
		selectElements.forEach(({ element }) => {
			element.addEventListener('change', handleFilterChange);
		});

		// Sayfa yüklendiğinde tüm filtreleri yükle
		document.addEventListener('DOMContentLoaded', () => {
			loadFilters();
			//Sayfa Yenilendiğinde Kullanıcı Adını Göster
			const username = localStorage.getItem('username');
			const isCampaignAdmin = localStorage.getItem('isCampaignAdmin');
	        document.getElementById('usernameDisplay').textContent = localStorage.getItem('username');
			document.getElementById('welcomeMessage').style.display = 'inline';
			// Oturum açma sonrası, backend'den alınan kullanıcı bilgisine göre:
			

		});

		
		$(document).ready(function () {
            // Tüm dropdown'ları selectpicker ile başlat
            $('.selectpicker').selectpicker();

            
        });


	// Müşteri Tipine göre Fiyat Tipi seçeneklerini güncelleyen fonksiyon
	function updatePriceTypeOptions() {
	  var customerType = document.getElementById('customerType').value;
	  var priceTypeSelect = document.getElementById('priceType');
	  var vatSelect = document.getElementById('vatIncluded');

	  // Fiyat Tipi seçeneklerini güncelle
	  priceTypeSelect.innerHTML = '';
	  if (customerType === 'toptan') {
		priceTypeSelect.add(new Option('TOP TL', '2'));
		priceTypeSelect.add(new Option('TOP USD', '3'));
		priceTypeSelect.add(new Option('TOP EUR', '6'));
	  } else {
		priceTypeSelect.add(new Option('PRK TL', '1'));
		priceTypeSelect.add(new Option('PRK USD', '4'));
		priceTypeSelect.add(new Option('PRK EUR', '5'));
	  }

	  // KDV Dahil/Hariç alanını müşteri tipine göre güncelle
	  if (customerType === 'perakende') {
		// Perakende: her zaman Dahil, değiştirilemez
		vatSelect.innerHTML = '';
		vatSelect.add(new Option('Dahil', '1'));
		vatSelect.value = '1';
		vatSelect.disabled = true;
	  } else if (customerType === 'toptan') {
		// Toptan: her zaman Hariç, değiştirilemez
		vatSelect.innerHTML = '';
		vatSelect.add(new Option('Hariç', '0'));
		vatSelect.value = '0';
		vatSelect.disabled = true;
	  } else {
		// Kurumsal: Kullanıcı değiştirebilir
		vatSelect.innerHTML = '';
		vatSelect.add(new Option('Dahil', '1'));
		vatSelect.add(new Option('Hariç', '0'));
		vatSelect.disabled = false;
		// Varsayılan değeri istediğiniz şekilde ayarlayabilirsiniz (örneğin 'Dahil')
		vatSelect.value = '1';
	  }
	}





// 📌 **Global filterProducts Fonksiyonu**
function filterProducts() {
    const excludeListeCheckbox = document.getElementById("excludeListeToggle");
	const excludekurumsalCheckbox = document.getElementById("excludekurumsalListeToggle");
	const kurumsalCheckbox = document.getElementById("kurumsalListeToggle");
    const indirimCheckbox = document.getElementById("indirimListeToggle");
    const hideStockCheckbox = document.getElementById("hideNoStockToggle");
    const showStockAbove5Checkbox = document.getElementById("showStockAbove5");
    const showHmStockCheckbox = document.getElementById("showHmStock");
    const showHmZeroStockCheckbox = document.getElementById("showHmZeroStock");
    const koleksiyon25Checkbox = document.getElementById("koleksiyon25");
    const excludeKoleksiyon25Checkbox = document.getElementById("excludeKoleksiyon25");
    const toggleNoImageCheckbox = document.getElementById("toggleNoImage");
    const onlyNoImageCheckbox = document.getElementById("onlyNoImage");
    const fuar25Checkbox = document.getElementById("fuar2025Toggle");
    const fkontrolCheckbox = document.getElementById("fkontrolToggle");

    // **Fiyat Aralığını Al**
    const minPrice = parseFloat(document.getElementById("minPrice").value) || 0;
    const maxPrice = parseFloat(document.getElementById("maxPrice").value) || Infinity;

    // **Seçili Filtreleri Al**
    const showexcludeliste = excludeListeCheckbox.checked;
	const showexcludeKurumsal = excludekurumsalCheckbox.checked;
	const showKurumsal = kurumsalCheckbox.checked;
    const showIndirim = indirimCheckbox.checked;
    const hideNoStock = hideStockCheckbox.checked;
    const showStockAbove5 = showStockAbove5Checkbox.checked;
    const showHmStock = showHmStockCheckbox.checked;
    const showHmZeroStock = showHmZeroStockCheckbox.checked;
    const showKoleksiyon25 = koleksiyon25Checkbox.checked;
    const excludeKoleksiyon25 = excludeKoleksiyon25Checkbox.checked;
    const hideNoImage = toggleNoImageCheckbox.checked;
    const showOnlyNoImage = onlyNoImageCheckbox.checked;
    const showFuar2025 = fuar25Checkbox.checked;
    const showFkontrol = fkontrolCheckbox.checked;

    // **Arama girişini al ve ayrıştır**
    const rawInput = document.getElementById("searchInput").value.trim();
    const { operator, terms } = parseSearchInput(rawInput); // Arama mantığını çözümle

    document.querySelectorAll(".product").forEach(productDiv => {
        const isKurumsal = productDiv.getAttribute("data-kurumsal") === "1";
        const isIndirim = productDiv.getAttribute("data-indirim") === "1";
        const stock = parseInt(productDiv.getAttribute("data-stock") || "0");
        const hmStock = parseInt(productDiv.getAttribute("data-hm-stock") || "0");
        const isKoleksiyon25 = productDiv.getAttribute("data-koleksiyon25") === "1";
        const isFuar2025 = productDiv.getAttribute("data-fuar25") === "1";
        const isFkontrol = productDiv.getAttribute("data-fkontrol") === "1";
        const productPrice = parseFloat(productDiv.getAttribute("data-price") || "0");

        // **Fotoğraf kontrolü**
        const image = productDiv.querySelector("img");
        const imageUrl = image ? image.getAttribute("src") : "";
        const isNoImage = imageUrl.includes('/resim/YOK.jpg');

        // **Ürünün metinsel bilgilerini al (Arama İçin)**
        const productCategory = (productDiv.querySelector('tr:nth-child(1) td:nth-child(2)')?.textContent || '').toLowerCase();
        const productSubCategory = (productDiv.querySelector('tr:nth-child(2) td:nth-child(2)')?.textContent || '').toLowerCase();
        const productCode = (productDiv.querySelector('tr:nth-child(3) td:nth-child(2)')?.textContent || '').toLowerCase();
        const productModel = (productDiv.querySelector('tr:nth-child(4) td:nth-child(2)')?.textContent || '').toLowerCase();
        const productEbat = (productDiv.querySelector('tr:nth-child(5) td:nth-child(2)')?.textContent || '').toLowerCase();
        const productColor = (productDiv.querySelector('tr:nth-child(6) td:nth-child(2)')?.textContent || '').toLowerCase();
        const productDesenLamine = (productDiv.querySelector('tr:nth-child(7) td:nth-child(2)')?.textContent || '').toLowerCase();
        const productMateryal = (productDiv.querySelector('tr:nth-child(8) td:nth-child(2)')?.textContent || '').toLowerCase();
        const productAyak = (productDiv.querySelector('tr:nth-child(9) td:nth-child(2)')?.textContent || '').toLowerCase();

        // **Filtreleme mantığı**
        let shouldShow = true;
		// 🔹 Eğer hiddenGroups boşsa, grup kontrolü yapılmasın


        // **Fotoğraf Filtreleri**
        if (showOnlyNoImage) {
            shouldShow = isNoImage; // Sadece fotoğrafsız ürünleri göster
        } else if (hideNoImage) {
            shouldShow = !isNoImage; // Fotoğrafsızları gizle
        }

        // **İndirim Liste Filtresi**
        if (showIndirim && !isIndirim) shouldShow = false;

        // **Stok Filtreleri**
        if (hideNoStock && stock <= 0) shouldShow = false;
        if (showStockAbove5 && stock < 5) shouldShow = false;
        if (showHmStock && hmStock <= 0) shouldShow = false;
        if (showHmZeroStock && hmStock > 0) shouldShow = false;

        // **Koleksiyon Filtreleri**
        if (showKoleksiyon25 && !isKoleksiyon25) shouldShow = false;
        if (excludeKoleksiyon25 && isKoleksiyon25) shouldShow = false;
		
		// **Proje Liste Filtresi**
        if (showKurumsal && !isKurumsal) shouldShow = false;
		if (showexcludeKurumsal && isKurumsal) shouldShow = false;
		
		// **Güncel Koleksiyon ve Projede Olmayan Liste Filtresi**
        if (showexcludeliste && (isKurumsal || isKoleksiyon25)) shouldShow = false;
		
        // **Fuar 2025 Filtre**
        if (showFuar2025 && !isFuar2025) shouldShow = false;

        // **Fiyat Kontrol Filtre**
        if (showFkontrol && !isFkontrol) shouldShow = false;

        // **Fiyat Filtresi**
        if (productPrice < minPrice || productPrice > maxPrice) shouldShow = false;

        // **Arama Filtresi (Eğer giriş yapılmışsa)**
        if (rawInput) {
            const fields = [
                productCategory, productSubCategory, productCode, productModel,
                productEbat, productColor, productDesenLamine, productMateryal, productAyak
            ];
            shouldShow = checkProductMatches({ operator, terms, fields }) && shouldShow;
        }
		 // 📌 **Ürün gizli bir gruba ait mi? Kontrol edelim**
        if (productDiv.getAttribute("data-hidden-group") === "true") {
            shouldShow = false; // Ne olursa olsun, gizlenmiş gruptaki ürünler görünmeyecek.
        }

        // **Sonuç olarak ürünü göster/gizle**
        productDiv.style.display = shouldShow ? "inline-block" : "none";
    });

    // **Boş grup başlıklarını kontrol et**
    hideEmptyGroupTitles();

    // **Satırdaki eksik ürünleri placeholder ile tamamla**
    removeAllPlaceholders();
    fixRowsWithPlaceholders();
}

//Fiyat Sliderları
document.addEventListener("DOMContentLoaded", function () {
    const minPrice = document.getElementById("minPrice");
    const maxPrice = document.getElementById("maxPrice");

    function updateSliderBackground(slider) {
        const value = ((slider.value - slider.min) / (slider.max - slider.min)) * 100;
        slider.style.background = `linear-gradient(to right, #747576 ${value}%, #ffffff ${value}%)`;
    }

    // Başlangıçta güncelle
    updateSliderBackground(minPrice);
    updateSliderBackground(maxPrice);

    // Kullanıcı kaydırdığında güncelle
    minPrice.addEventListener("input", function () {
        updateSliderBackground(this);
    });

    maxPrice.addEventListener("input", function () {
        updateSliderBackground(this);
    });
});


// 📌 **DOMContentLoaded İçinde Event Listener'ları Tanımla**
document.addEventListener("DOMContentLoaded", function () {
    const filterCheckboxes = [
        document.getElementById("excludeListeToggle"),
		document.getElementById("excludekurumsalListeToggle"),
		document.getElementById("kurumsalListeToggle"),
        document.getElementById("indirimListeToggle"),
        document.getElementById("hideNoStockToggle"),
        document.getElementById("showStockAbove5"),
        document.getElementById("showHmStock"),
        document.getElementById("showHmZeroStock"),
        document.getElementById("koleksiyon25"),
        document.getElementById("excludeKoleksiyon25"),
        document.getElementById("toggleNoImage"),
        document.getElementById("onlyNoImage"),
		document.getElementById("fkontrolToggle"),
		document.getElementById("fuar2025Toggle"),
		
    ];

    // **Filtre Değiştikçe filterProducts'ı Çalıştır**
    filterCheckboxes.forEach(checkbox => {
        if (checkbox) checkbox.addEventListener("change", filterProducts);
    });
	// 📌 **Çakışan Filtre Seçeneklerini Engelle**
    document.getElementById("toggleNoImage").addEventListener("change", function () {
        if (this.checked) {
            document.getElementById("onlyNoImage").checked = false; // Fotoğrafsızları göster seçeneğini kaldır
        }
        filterProducts(); // ✅ Değişiklik sonrası filtreleri uygula
    });

    document.getElementById("onlyNoImage").addEventListener("change", function () {
        if (this.checked) {
            document.getElementById("toggleNoImage").checked = false; // Fotoğraflı seçeneğini kaldır
        }
        filterProducts(); // ✅ Değişiklik sonrası filtreleri uygula
    });

    document.getElementById("koleksiyon25").addEventListener("change", function () {
        if (this.checked) {
            document.getElementById("excludeKoleksiyon25").checked = false; // 25 Seçilmeyenler seçeneğini kaldır
        }
        filterProducts(); // ✅ Değişiklik sonrası filtreleri uygula
    });

    document.getElementById("excludeKoleksiyon25").addEventListener("change", function () {
        if (this.checked) {
            document.getElementById("koleksiyon25").checked = false; // Koleksiyon 25 seçeneğini kaldır
        }
        filterProducts(); // ✅ Değişiklik sonrası filtreleri uygula
    });
	document.getElementById("kurumsalListeToggle").addEventListener("change", function () {
        if (this.checked) {
            document.getElementById("excludekurumsalListeToggle").checked = false; // Kurumsal Seçilmeyenler seçeneğini kaldır
        }
        filterProducts(); // ✅ Değişiklik sonrası filtreleri uygula
    });

    document.getElementById("excludekurumsalListeToggle").addEventListener("change", function () {
        if (this.checked) {
            document.getElementById("kurumsalListeToggle").checked = false; // Kurumsal seçeneğini kaldır
        }
        filterProducts(); // ✅ Değişiklik sonrası filtreleri uygula
    });
	
	document.getElementById("excludeListeToggle").addEventListener("change", function () {
        if (this.checked) {
			document.getElementById("koleksiyon25").checked = false; // Koleksiyon 25 seçeneğini kaldır
            document.getElementById("kurumsalListeToggle").checked = false; // Kurumsal seçeneğini kaldır
			
        }
        filterProducts(); // ✅ Değişiklik sonrası filtreleri uygula
    });
	// **Fiyat Slider'ları Değiştikçe filterProducts'ı Çalıştır**
    const minPriceSlider = document.getElementById("minPrice");
    const maxPriceSlider = document.getElementById("maxPrice");
	
	const minPriceLabel = document.getElementById('minPriceLabel');
	const maxPriceLabel = document.getElementById('maxPriceLabel');

	// Min slider için olay dinleyici
	minPriceSlider.addEventListener('input', () => {
		minPriceLabel.textContent = minPriceSlider.value;
		if (parseInt(minPriceSlider.value) > parseInt(maxPriceSlider.value)) {
			maxPriceSlider.value = minPriceSlider.value;
			maxPriceLabel.textContent = maxPriceSlider.value;
		}
	});

	// Max slider için olay dinleyici
	maxPriceSlider.addEventListener('input', () => {
		maxPriceLabel.textContent = maxPriceSlider.value;
		if (parseInt(maxPriceSlider.value) < parseInt(minPriceSlider.value)) {
			minPriceSlider.value = maxPriceSlider.value;
			minPriceLabel.textContent = minPriceSlider.value;
		}
	});
	

    if (minPriceSlider && maxPriceSlider) {
        minPriceSlider.addEventListener("input", filterProducts);
        maxPriceSlider.addEventListener("input", filterProducts);
    }

    // **Arama Kutusu İçin filterProducts Çalıştır**
    const searchInput = document.getElementById("searchInput");
    if (searchInput) {
        searchInput.addEventListener("input", filterProducts);
    }
});




function fixRowsWithPlaceholders() {
    const columns = 4; // Satır başına kaç ürün olması gerektiği
    let productRows = [];
    let currentRow = [];

    document.querySelectorAll(".product").forEach(productDiv => {
        if (productDiv.style.display !== "none") {
            currentRow.push(productDiv);
            if (currentRow.length === columns) {
                productRows.push(currentRow);
                currentRow = [];
            }
        }
    });

    // Eğer satır tamamlanmadıysa eksik olanları doldur
    if (currentRow.length > 0 && currentRow.length < columns) {
        const missingCount = columns - currentRow.length;
        for (let i = 0; i < missingCount; i++) {
            let placeholder = document.createElement("div");
            placeholder.className = "product-placeholder";
            currentRow.push(placeholder);
        }
        productRows.push(currentRow);
    }

    // Eski placeholderları temizle
    removeAllPlaceholders();

    // Yeni satır düzenini uygula
    productRows.forEach(row => {
        row.forEach(item => {
            item.parentElement.appendChild(item);
        });
    });
}





//Girdi Ayrıştırma (parse) Fonksiyonu
function parseSearchInput(input) {
    // Hem & hem | varsa gelişmiş bir mantık kurmak gerekir;
    // basit yaklaşım: önce & kontrolü, yoksa | kontrolü
    // ya da sadece bir tanesi varsa o kullanılır
    if (input.includes('&')) {
        // "AND" durumu
        const terms = input.split('&').map(t => t.trim().toLowerCase()).filter(Boolean);
        return { operator: 'AND', terms };
    } else if (input.includes('|')) {
        // "OR" durumu
        const terms = input.split('|').map(t => t.trim().toLowerCase()).filter(Boolean);
        return { operator: 'OR', terms };
    } else {
        // Tek terim: Varsayılan olarak OR gibi davranabilirsiniz.
        // Veya "NONE" diyebilirsiniz.
        return { operator: 'SINGLE', terms: [input.toLowerCase()] };
    }
}

//Tek Üründe Eşleşme Kontrol Fonksiyonu
function checkProductMatches({ operator, terms, fields }) {
    if (operator === 'AND') {
        // Tüm terms ifadesi EŞZAMANLI olarak fields içinde bulunmalı
        // Her terimin en az 1 field’da geçmesi yeterlidir ama hepsi bulunmalı => every
        return terms.every(term => 
            fields.some(field => field.includes(term))
        );
    } else if (operator === 'OR') {
        // Terimlerden herhangi biri fields içinde bulunsa yeter => some
        return terms.some(term => 
            fields.some(field => field.includes(term))
        );
    } else if (operator === 'SINGLE') {
        // Tek terim => OR gibi davranabilirsiniz
        const singleTerm = terms[0];
        return fields.some(field => field.includes(singleTerm));
    }
    return false;
}


//Placeholder Temizleme Fonksiyonu
function removeAllPlaceholders() {
    const placeholders = document.querySelectorAll('.product-placeholder');
    placeholders.forEach(ph => ph.remove());
}

//Satırları Placeholder’larla Tamamlama Fonksiyonu
function fixRowsWithPlaceholders() {
    const groupTitles = document.querySelectorAll('.group-title');
    const totalProductsInRow = columns; // columns globalden geliyor

    groupTitles.forEach(title => {
        let productCountInGroup = 0;

        let currentElem = title.nextElementSibling;
        // Bir sonraki group-title veya null gelene kadar döngü
        while (currentElem && !currentElem.classList.contains('group-title')) {
            if (currentElem.classList.contains('product') && currentElem.style.display !== 'none') {
                productCountInGroup++;
            }
            currentElem = currentElem.nextElementSibling;
        }

        // Eğer grupta eksik varsa placeholder ekleyelim
        if (productCountInGroup > 0) {
            const remainder = productCountInGroup % totalProductsInRow;
            if (remainder !== 0) {
                const needed = totalProductsInRow - remainder;
                // Son ürünün hemen sonrasına placeholder'ları ekleyeceğiz
                let insertionPoint = title.nextElementSibling; 
                // insertionPoint'i gruptaki son "görünür product"un sonrasına götürelim
                while (insertionPoint && !insertionPoint.classList.contains('group-title')) {
                    if (insertionPoint.classList.contains('product') && insertionPoint.style.display !== 'none') {
                        // muhtemel "son görünür product"
                    }
                    // Yine de en sona gelene kadar ilerleyelim
                    insertionPoint = insertionPoint.nextElementSibling;
                    // insertionPoint null veya next group-title olabilir
                    if (insertionPoint && insertionPoint.classList.contains('group-title')) {
                        // Bir sonraki grup başlığına ulaştık, dur
                        break;
                    }
                }
                
                // insertionPoint şimdi bir sonraki group-title veya null
                // placeholder'ı eklememiz gereken yer tam "insertionPoint" öncesi
                // Tabi bu biraz karmaşık, isterseniz "insertionParent" mantığıyla ekleyebilirsiniz.

                for (let i = 0; i < needed; i++) {
                    const placeholderDiv = document.createElement('div');
                    placeholderDiv.className = 'product-placeholder';
                    placeholderDiv.style.flex = `1 1 calc(100% / ${columns} - 20px)`;
                    // Ekleyeceğimiz yeri bulmak için "title" ile "insertionPoint" arasına ekleyebiliriz
                    // Örneğin insertionPoint yoksa, title.parentNode.appendChild() ile ekleriz
                    if (insertionPoint && insertionPoint.parentNode) {
                        insertionPoint.parentNode.insertBefore(placeholderDiv, insertionPoint);
                    } else {
                        // Sonraki group-title yoksa sayfa sonuna ekle
                        title.parentNode.appendChild(placeholderDiv);
                    }
                }
            }
        }
    });
}

//Boş Grup Başlıklarını Gizleme Fonksiyonu
function hideEmptyGroupTitles() {
    const groupTitles = document.querySelectorAll('.group-title');

    groupTitles.forEach(title => {
        let nextElem = title.nextElementSibling;
        let visibleProductCount = 0;

        while (nextElem && !nextElem.classList.contains('group-title')) {
            // "product-placeholder" da bir product değil. Bu sayımı bozmaması gerekir
            // O yüzden 'product' sınıfını arıyoruz
            if (nextElem.classList.contains('product') && nextElem.style.display !== 'none') {
                visibleProductCount++;
            }
            nextElem = nextElem.nextElementSibling;
        }
        if (visibleProductCount === 0) {
            title.style.display = "none";
        } else {
            title.style.display = "block";
        }
    });
}



// Ürün resimlerini sunucudan çekmek için fonksiyon
async function fetchProductImages(productKod) {
    try {
        const response = await fetch(`/api/intrafoto/${productKod}`);
        if (response.ok) {
            const data = await response.json();
            return data.imageUrls;
        }
    } catch (error) {
        console.error("Error fetching images:", error);
    }
    // Hata durumunda varsayılan resim
    return ['/resim/YOK.jpg'];
}

// Ürün Çağırma Fonksiyonu
const loadProducts = async (page = 1, targetContainerId) => {
    if (!targetContainerId) {
        console.warn("Hedef container tanımlı değil! Varsayılan olarak 'product-container' kullanılıyor.");
        targetContainerId = "product-container"; // **Varsayılan container**
    }

    let container = document.getElementById(targetContainerId);
    if (!container) {
        console.warn(`Hedef container (${targetContainerId}) bulunamadı. Varsayılan olarak 'product-container' kullanılıyor.`);
        targetContainerId = "product-container"; // **Varsayılan container**
        container = document.getElementById(targetContainerId);
        
        // Eğer hala container yoksa işlemi iptal et
        if (!container) {
            console.error("Varsayılan container olan 'product-container' da bulunamadı! İşlem iptal edildi.");
            return;
        }
    }
	
	// 🔽 Kampanya mappingleri yüklü değilse yükle
	if (Object.keys(categoryCampaignMap).length === 0) {
		await loadCategoryCampaignMapping();
	}
	if (Object.keys(productCampaignMap).length === 0) {
		await loadProductCampaignMapping();
	}


    const basamak2 = basamak2Select.value;
    const basamak4 = basamak4Select.value;
    const anamodel = anamodelSelect.value;
    const model = modelSelect.value;
    const ebat = ebatSelect.value;
    const kod = kodSelect.value;
    
    // Yükleme mesajını güncelleme için değişkenler
    let totalProducts = 0;
    let loadedProducts = 0;
    const updateLoadingMessage = () => {
        loadingMessage.innerText = `Yüklenen: ${loadedProducts} / ${totalProducts}`;
    };

    // Devam eden yüklemeyi iptal et ve yeni bir abortController başlat
    if (abortController) abortController.abort();
    abortController = new AbortController();

    // Toplam ürün sayısını almak için API isteği
    try {
        const queryParams = new URLSearchParams({
            basamak2,
            basamak4,
            anamodel,
            model,
            ebat,
            kod,
        });

        const countResponse = await fetch(`http://192.168.30.4:3000/products/count?${queryParams.toString()}`, { signal: abortController.signal });
        if (countResponse.ok) {
            const countData = await countResponse.json();
            totalProducts = countData.total;
        }
    } catch (error) {
        console.error("Toplam ürün sayısı alınamadı:", error);
    }

    let url = `http://192.168.30.4:3000/products?page=${page}&pageSize=${pageSize}`;
    const params = [];
    if (basamak2) params.push(`basamak2=${basamak2}`);
    if (basamak4) params.push(`basamak4=${basamak4}`);
    if (anamodel) params.push(`anamodel=${anamodel}`);
    if (model) params.push(`model=${model}`);
    if (ebat) params.push(`ebat=${ebat}`);
    if (kod) params.push(`kod=${kod}`);
    if (params.length > 0) url += `&${params.join('&')}`;

    try {
        const response = await fetch(url, { signal: abortController.signal });
        const products = await response.json(); // products dizisini global değişkene atıyoruz.

        if (!response.ok) {
            console.error("API Hatası:", response.status, response.statusText);
            return;
        }

        if (products.length === 0) {
            hasMoreProducts = false;
            alert('Filtrene uygun ürün bulunamadı.');
            return;
        }

        // İlk sayfa ise ürünleri temizle
        if (page === 1) {
            container.innerHTML = '';
            loadedProductCodes.clear(); // Yüklenen ürünleri sıfırla
        }

        let currentGroup = '';
        let productCountInGroup = 0;

        for (const product of products) {
            if (loadedProductCodes.has(product.KOD)) continue;

            loadedProductCodes.add(product.KOD);
            loadedProducts++;
            updateLoadingMessage();

            const group = `${product.BASAMAK2 || ''} - ${product.BASAMAK4 || ''}`;
            if (group !== currentGroup) {
                if (currentGroup !== '') {
                    const totalProductsInRow = columns;
                    if (productCountInGroup % totalProductsInRow !== 0) {
                        const placeholdersNeeded = totalProductsInRow - (productCountInGroup % totalProductsInRow);
                        for (let i = 0; i < placeholdersNeeded; i++) {
                            let placeholderDiv = document.createElement('div');
                            placeholderDiv.className = 'product-placeholder';
                            container.appendChild(placeholderDiv);
                        }
                    }
                }
                currentGroup = group;
                productCountInGroup = 0;
                
                // **Grup başlığı için özel bir div oluştur**
                let groupDiv = document.createElement('div');
                groupDiv.className = 'group-title';
				const [catMain, catSub] = group.split(" - ");
				const categoryBadge = getCategoryCampaignLabel(catSub);
                groupDiv.innerHTML = `
                    <span>${group}</span>
					${categoryBadge}
                    <button class="hide-group-btn" onclick="toggleGroupVisibility('${group}')">Grubu Gizle</button>
                `;
                container.appendChild(groupDiv);
            }

            productCountInGroup++;
            let productDiv = document.createElement('div');
            productDiv.className = 'product';
            productDiv.style.flex = `1 1 calc(100% / ${columns} - 20px)`;
            
            // **Filtre İçin Ürün Bilgilerini Attribute Olarak Ekle**
            productDiv.setAttribute("data-kurumsal", product.KURUMSALLIST ? "1" : "0");
            productDiv.setAttribute("data-indirim", product.INDIRIMLIST ? "1" : "0");
            productDiv.setAttribute("data-stock", product.STOK);
            productDiv.setAttribute("data-kod", product.KOD);
            productDiv.setAttribute("data-hm-stock", product.HOM);
            productDiv.setAttribute("data-koleksiyon25", product.KOLEKSIYON25 ? "1" : "0");
            productDiv.setAttribute("data-price", product.SFIYAT1);
            productDiv.setAttribute("data-fkontrol", product.FKONTROL ? "1" : "0");
            productDiv.setAttribute("data-fuar25", product.FUAR25 ? "1" : "0");

            // Yeni: Resimleri sunucudaki /api/intrafoto endpoint'inden çekiyoruz.
            const imageUrls = await fetchProductImages(product.KOD);
			const imageUrl = (imageUrls && imageUrls.length > 0) ? imageUrls[0] : '/resim/YOK.jpg';

            // **Indicators (Noktalar)**
            const indicators = imageUrls.map((_, index) => `
                <li data-target="#carousel-${product.KOD}" data-slide-to="${index}" ${index === 0 ? 'class="active"' : ''}></li>
            `).join('');

            // **Carousel Items (Resimler)**
            const carouselItems = imageUrls.map((url, index) => `
                <div class="carousel-item ${index === 0 ? 'active' : ''}" style="position: relative;">
				${getProductCampaignLabel(product.KOD)}
                    <img src="${url}" alt="${product.ADI}" class="d-block w-100" 
                        data-urls='${JSON.stringify(imageUrls)}' onclick="openImageModal('${product.KOD}')">
                </div>
            `).join('');

            const formatNumber = (value) => {
                value = parseFloat(value) || 0;
                return value.toFixed(2).replace(/\B(?=(\d{3})+(?!\d))/g, ".").replace(".", ",");
            };

            // **Body'deki Ürün Carousel Yapısı**
            if (targetContainerId === "product-container") {
                productDiv.innerHTML = `
                    <div id="carousel${product.KOD}" class="carousel slide" data-ride="carousel">
                        <!-- Fotoğraf Sayısını Gösteren Noktalar -->
                        <ol class="carousel-indicators">
                            ${indicators}
                        </ol>
                        <div class="carousel-inner">
                            ${carouselItems}
                        </div>
                        <a class="carousel-control-prev" href="#carousel${product.KOD}" role="button" data-slide="prev">
                            <span class="carousel-control-prev-icon" aria-hidden="true"></span>
                            <span class="sr-only">Previous</span>
                        </a>
                        <a class="carousel-control-next" href="#carousel${product.KOD}" role="button" data-slide="next">
                            <span class="carousel-control-next-icon" aria-hidden="true"></span>
                            <span class="sr-only">Next</span>
                        </a>
                    </div>
                    <div style="cursor: pointer;" onclick="openImageModal('${product.KOD}')"></div>
                    <table style="width: 100%; text-align: left;">
                        <tbody>
                            <tr>
                                <td><strong>KATEGORİ:</strong></td>
                                <td><strong>${product.BASAMAK2}</strong></td>
                            </tr>
                            <tr>
                                <td><strong>ALT KATEGORI:</strong></td>
                                <td><strong>${product.BASAMAK4}</strong></td>
                            </tr>
                            <tr>
                                <td><strong>KOD:</strong></td>
                                <td><strong>${product.KOD}</strong></td>
                            </tr>
                            <tr>
                                <td><strong>MODEL:</strong></td>
                                <td><strong>${product.MODEL}</strong></td>
                            </tr>
                            <tr>
                                <td>EBAT:</td>
                                <td>${product.EBAT}</td>
                            </tr>
                            <tr>
                                <td>RENK:</td>
                                <td>${product.RENK}</td>
                            </tr>
                            <tr>
                                <td>DESEN & LAMINE:</td>
                                <td>${product.DESEN ? product.DESEN : '-'} / ${product.LAMINE ? product.LAMINE : '-'}</td>
                            </tr>
                            <tr>
                                <td>MATERYAL:</td>
                                <td>${product.MATERYAL}</td>
                            </tr>
                            <tr>
                                <td>AYAK:</td>
                                <td>${product.LEG ? product.LEG : '-'}</td>
                            </tr>
                            <tr>
                                <td>PRK TL & USD:</td>
                                <td>${formatCurrency(product.SFIYAT1, 1)} / ${formatCurrency(product.SFIYAT4, 4)}</td>
                            </tr>
                            <tr>
                                <td>STOK / HM:</td>
                                <td>${product.STOK} / ${product.HOM}</td>
                            </tr>
                            <tr>
							<td>GÜNCEL KOLEKSİYON:</td>
                                <td>
                                     <input type="checkbox" ${product.KOLEKSIYON25 ? 'checked' : ''} onchange="updateKoleksiyon('${product.KOD}', 'KOLEKSIYON25', this.checked)">
								</td>
							</tr>
							<tr>
							<td>PROJE:</td>
								<td>
                                  <input type="checkbox" ${product.KURUMSALLIST ? 'checked' : ''} onchange="updateKoleksiyon('${product.KOD}', 'KURUMSALLIST', this.checked)"></label>  
                                </td>
                            </tr>
                            <tr>
                                <td>Fiyat Kontrol:</td>
                                <td>
                                    <input
                                        type="checkbox"
                                        id="fkontrol-${product.KOD}"
                                        ${product.FKONTROL ? 'checked' : ''}
                                        onchange="updateFkontrol('${product.KOD}', this.checked)"
                                    >
                                    <input
                                        type="text"
                                        id="fkontrolnotes-${product.KOD}"
                                        value="${product.FKONTROLNOTES || ''}"
                                        style="display: ${product.FKONTROL ? 'inline-block' : 'none'};"
                                        onblur="updateFkontrolNotes('${product.KOD}', this.value)"
                                    >
                                </td>
                            </tr>
                            <tr>
                                <td>Fuar 2025:</td>
                                <td>${product.FUAR25 ? '✅ Evet' : '❌ Hayır'}</td>
                            </tr>
                            <tr>
                                <td>Karşılaştır:</td>
                                <td>
                                    <label class="compare-checkbox">
                                        <input type="checkbox" data-product-code="${product.KOD}" onclick="toggleCompare('${product.KOD}', this)"> 
                                    </label>
                                </td>
                            </tr>
                            <tr style="padding: 0;">
                                <td>NOTLAR:</td>
                                <td><textarea onblur="updateNotes('${product.KOD}', this.value)">${product.NOTES || ''}</textarea></td>
                            </tr>
                            <tr>
								<td style="text-align: center;">
									${ imageUrl !== '/resim/YOK.jpg' ? `<button class="btn btn-sm" style="background-color: #d8f0f2; color: black; border: none;" onclick="openSuggestionModal('${product.KOD}')">Öneriler</button>` : '' }
								</td>
                                <td  style="text-align: center;">
                                    <button class="btn btn-sm" style="background-color: #727476; color: white; border: none;" onclick="addToCart('${product.KOD}')">Teklif Sepetine Ekle</button>
                                </td>
								
								
								</td>
                            </tr>
                        </tbody>
                    </table>
                `;
            } else if (targetContainerId === "admin-product-container") {
                // Admin paneli için benzer yapı, farklı ID'ler ve içerik düzeni uygulanıyor.
                productDiv.innerHTML = `
                    <div id="carousel${product.KOD}-admin" class="carousel slide" data-ride="carousel">
                        <ol class="carousel-indicators">
                            ${indicators}
                        </ol>
                        <div class="carousel-inner">
                            ${carouselItems}
                        </div>
                        <a class="carousel-control-prev" href="#carousel${product.KOD}-admin" role="button" data-slide="prev">
                            <span class="carousel-control-prev-icon" aria-hidden="true"></span>
                            <span class="sr-only">Previous</span>
                        </a>
                        <a class="carousel-control-next" href="#carousel${product.KOD}-admin" role="button" data-slide="next">
                            <span class="carousel-control-next-icon" aria-hidden="true"></span>
                            <span class="sr-only">Next</span>
                        </a>
                    </div>
                    <div style="cursor: pointer;" onclick="openImageModal('${product.KOD}')"></div>
                    <table style="width: 100%; text-align: left;">
                        <tbody>
                            <tr>
                                <td><strong>KATEGORİ:</strong></td>
                                <td><strong>${product.BASAMAK2}</strong></td>
                            </tr>
                            <tr>
                                <td><strong>ALT KATEGORI:</strong></td>
                                <td><strong>${product.BASAMAK4}</strong></td>
                            </tr>
                            <tr>
                                <td><strong>KOD:</strong></td>
                                <td><strong>${product.KOD}</strong></td>
                            </tr>
                            <tr>
                                <td><strong>MODEL:</strong></td>
                                <td><strong>${product.MODEL}</strong></td>
                            </tr>
                            <tr>
                                <td>EBAT:</td>
                                <td>${product.EBAT}</td>
                            </tr>
                            <tr>
                                <td>RENK:</td>
                                <td>${product.RENK}</td>
                            </tr>
                            <tr>
                                <td>DESEN & LAMINE:</td>
                                <td>${product.DESEN ? product.DESEN : '-'} / ${product.LAMINE ? product.LAMINE : '-'}</td>
                            </tr>
                            <tr>
                                <td>MATERYAL:</td>
                                <td>${product.MATERYAL}</td>
                            </tr>
                            <tr>
                                <td>AYAK:</td>
                                <td>${product.LEG ? product.LEG : '-'}</td>
                            </tr>
                            <tr>
                                <td>PRK TL & USD:</td>
                                <td>${formatCurrency(product.SFIYAT1, 1)} / ${formatCurrency(product.SFIYAT4, 4)}</td>
                            </tr>
                            <tr>
                                <td>MALİYET TL & USD:</td>
                                <td>${formatCurrency(product.HSP_MALIYET_TL, 1)} / ${formatCurrency(product.HSP_MALIYET_USD, 4)}</td>
                            </tr>
                            <tr>
                                <td>ÇARPAN TL & USD:</td>
                                <td>${formatNumber(product.CARPANTL)} / ${formatNumber(product.CARPANUSD)}</td>
                            </tr>
                            <tr>
                                <td>REÇETE KONTROL:</td>
                                <td>
                                    <input type="checkbox" id="receteKontrol-${product.KOD}" onchange="updateReceteKontrol('${product.KOD}', this.checked)" ${product.RECETEKONTROL ? 'checked' : ''} /> / 
                                    ${product.RECETEKONTROLTARIH ? formatDate(product.RECETEKONTROLTARIH) : '-'}
                                </td>
                            </tr>
                            <tr>
                                <td style="width: 50%;"><strong>Malzeme & İşçilik USD</strong></td>
                                <td style="width: 50%;">${formatCurrency(product.MALZEMEUSD, 4)} + ${formatCurrency(product.ISCILIKUSD, 4)} = ${formatCurrency(product.RECETE_MALIYET_USD, 4)}</td>
                            </tr>
                            <tr>
                                <td>STOK / HM:</td>
                                <td>${product.STOK} / ${product.HOM}</td>
                            </tr>
                            <tr>
                                <td colspan="2">
                                    <div class="koleksiyon-checkboxes">
                                        <label style="margin: 0; padding: 0;">25: <input type="checkbox" ${product.KOLEKSIYON25 ? 'checked' : ''} onchange="updateKoleksiyon('${product.KOD}', 'KOLEKSIYON25', this.checked)"></label>
                                    </div>
                                </td>
                            </tr>
                            <tr>
                                <td>Fiyat Kontrol:</td>
                                <td>
                                    <input type="checkbox" id="fkontrol-${product.KOD}" ${product.FKONTROL ? 'checked' : ''} onchange="updateFkontrol('${product.KOD}', this.checked)">
                                    <input type="text" id="fkontrolnotes-${product.KOD}" value="${product.FKONTROLNOTES || ''}" style="display: ${product.FKONTROL ? 'inline-block' : 'none'};" onblur="updateFkontrolNotes('${product.KOD}', this.value)">
                                </td>
                            </tr>
                            <tr>
                                <td>Fuar 2025:</td>
                                <td>${product.FUAR25 ? '✅ Evet' : '❌ Hayır'}</td>
                            </tr>
                            <tr>
                                <td>Karşılaştır:</td>
                                <td>
                                    <label class="compare-checkbox">
                                        <input type="checkbox" data-product-code="${product.KOD}" onclick="toggleCompare('${product.KOD}', this)">
                                    </label>
                                </td>
                            </tr>
                            <tr style="padding: 0;">
                                <td>NOTLAR:</td>
                                <td><textarea onblur="updateNotes('${product.KOD}', this.value)">${product.NOTES || ''}</textarea></td>
                            </tr>
                            <tr>
								<td style="text-align: center;">
									${ imageUrl !== '/resim/YOK.jpg' ? `<button class="btn btn-sm" style="background-color: #d8f0f2; color: black; border: none;" onclick="openSuggestionModal('${product.KOD}')">Öneriler</button>` : '' }
								</td>
                                <td colspan="2" style="text-align: center;">
                                    <button class="btn btn-sm" style="background-color: #727476; color: white; border: none;" onclick="addToCart('${product.KOD}')">Teklif Sepetine Ekle</button>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                `;
            }
            container.appendChild(productDiv);
        }
		filterProducts()
        const totalProductsInRow = columns;
        if (productCountInGroup % totalProductsInRow !== 0) {
            const placeholdersNeeded = totalProductsInRow - (productCountInGroup % totalProductsInRow);
            for (let i = 0; i < placeholdersNeeded; i++) {
                let placeholderDiv = document.createElement('div');
                placeholderDiv.className = 'product-placeholder';
                container.appendChild(placeholderDiv);
            }
        }
    } catch (error) {
        if (error.name === 'AbortError') {
            // İptal edildiği durumlarda işlem yapmayın
        } else {
            console.error("Ürün yükleme hatası:", error);
        }
    }
};

//Tarih Formatlama
function formatDate(dateString) {
  const date = new Date(dateString);
  if (isNaN(date)) return '-';
  const day = String(date.getDate()).padStart(2, '0');
  const month = String(date.getMonth() + 1).padStart(2, '0');
  const year = date.getFullYear();
  return `${day}.${month}.${year}`;
}
//Ürün Reçete Kontrol Güncelleme
async function updateReceteKontrol(kod, isChecked) {
    try {
         const response = await fetch('/update-details', {
             method: 'POST',
             headers: { 'Content-Type': 'application/json' },
             body: JSON.stringify({ KOD: kod, RECETEKONTROL: isChecked })
         });
         const result = await response.json();
         
         // Gerekirse kullanıcıya bilgi verin veya sayfayı güncelleyin.
         // Örneğin:
         // await showCartContents();
    } catch (error) {
         console.error('Reçete kontrol güncelleme hatası:', error);
         alert('Reçete kontrol güncellenirken bir hata oluştu.');
    }
}

//Sepet Fiyatları Kontrol Eden Fonksiyon
async function checkCartPriceChanges(cartId) {
    try {
        const response = await fetch(`/api/cart/update-prices?cartId=${cartId}`);
        const data = await response.json();

        if (!data.success) {
            alert("Fiyat güncellenirken hata oluştu.");
            return;
        }

        const priceChanges = data.priceChanges;
        if (priceChanges.length === 0) {
            alert("⚡ Tüm fiyatlar güncel, değişiklik yok!");
            return;
        }

        // 📌 Modal içeriğini güncelle
        const priceUpdateTableBody = document.getElementById("priceUpdateTableBody");
        const totalPriceDifferenceElement = document.getElementById("totalPriceDifference");
        let totalPriceDifference = 0;

        priceUpdateTableBody.innerHTML = "";
        priceChanges.forEach(change => {
            const row = `
                <tr>
                    <td>${change.PRODUCT_ID}</td>
                    <td>${formatCurrency(change.OLD_PRICE, change.PRICE_TYPE)}</td>
                    <td>${formatCurrency(change.NEW_PRICE, change.PRICE_TYPE)}</td>
                    <td>${formatCurrency(change.PRICE_DIFFERENCE, change.PRICE_TYPE)}</td>
                </tr>
            `;
            priceUpdateTableBody.innerHTML += row;
            totalPriceDifference += parseFloat(change.PRICE_DIFFERENCE);
        });

        totalPriceDifferenceElement.innerText = formatCurrency(totalPriceDifference, priceChanges[0]?.PRICE_TYPE || 1);

        // 📌 Modalı aç
        $('#priceUpdateModal').modal('show');

        // 📌 Güncelleme butonuna event ekleyelim
        document.getElementById("confirmPriceUpdate").onclick = () => {
			updateCartPrices(cartId);
			totalPriceDifferenceElement.innerText = formatCurrency(0, priceChanges[0]?.PRICE_TYPE || 1); // 🔥 Güncellemeden sonra farkı sıfırla
		};

    } catch (error) {
        console.error("Fiyat değişiklikleri kontrol edilirken hata:", error);
    }
}
// Kullanıcı Onay Verdiğinde Sepet Fiyatlarında Güncelleme Yapan Fonksiyon
async function updateCartPrices(cartId) {
    try {
        const response = await fetch("/api/cart/update-prices", {
			method: "POST",
			headers: { "Content-Type": "application/json" },
			body: JSON.stringify({ cartId, confirmUpdate: true }) // 🔥 Kullanıcı onayını ekledik!
		});

		$('#cartModal').modal('hide');
		const data = await response.json();
        if (data.success) {
            alert("✔️ Sepet fiyatları başarıyla güncellendi!");
            // 🔥 Güncelleme sonrası farkları temizle
			priceUpdateTableBody.innerHTML = "";  
			totalPriceDifferenceElement.innerText = formatCurrency(0, priceChanges[0]?.PRICE_TYPE || 1);  
			$('#priceUpdateModal').modal('hide');
			$('#cartModal').modal('show');
			showCartContents();
			updateCartSummary();			
        } else {
            alert("⚠️ Fiyat güncellemesi başarısız: " + data.message);
        }
    } catch (error) {
        console.error("Fiyat güncellenirken hata oluştu:", error);
    }
}

//grubu gizle butonu işlevi
function toggleGroupVisibility(groupName) {
    const groupTitle = [...document.querySelectorAll(".group-title")].find(title => title.innerText.includes(groupName));
    if (!groupTitle) return;

    // 📌 **Grup adını parçalara ayırarak kategori ve alt kategoriyi alalım**
    const [category, subCategory] = groupName.split(" - ").map(text => text.trim().toLowerCase());

    // 📌 **Tüm ürünleri tarayalım ve eşleşenleri bulalım**
    const groupElements = [...document.querySelectorAll(".product")].filter(productDiv => {
        const productCategory = (productDiv.querySelector('tr:nth-child(1) td:nth-child(2)')?.textContent || '').toLowerCase();
        const productSubCategory = (productDiv.querySelector('tr:nth-child(2) td:nth-child(2)')?.textContent || '').toLowerCase();
        return productCategory === category && productSubCategory === subCategory;
    });

    // 📌 **Eğer bu kategoride ürün varsa, onları gizle/göster**
    const isCurrentlyHidden = groupElements.length > 0 && groupElements[0].getAttribute("data-hidden-group") === "true";

    groupElements.forEach(el => {
        if (isCurrentlyHidden) {
            el.style.display = "inline-block";
            el.removeAttribute("data-hidden-group"); // 📌 Gizli özelliği kaldır
        } else {
            el.style.display = "none";
            el.setAttribute("data-hidden-group", "true"); // 📌 Ürünü gizli olarak işaretle
        }
    });

    // 📌 **Grup başlığını da aynı şekilde gizle/göster**
    if (isCurrentlyHidden) {
        groupTitle.style.display = "flex";
    } else {
        groupTitle.style.display = "none";
    }

    removeAllPlaceholders();
    fixRowsWithPlaceholders();
}


//Karşılaştırma
let compareList = [];
let products = []; // Ürünleri tutacak global dizi

const MAX_COMPARE_ITEMS = 4; // Maksimum karşılaştırma sayısı

function toggleCompare(productCode, checkbox) {
    const product = getProductByCode(productCode); // Ürün bilgisini al
    if (!product) {
        console.warn("Ürün bilgisi bulunamadı:", productCode);
        return;
    }

    if (checkbox.checked) {
        if (compareList.length >= MAX_COMPARE_ITEMS) {
            alert(`En fazla ${MAX_COMPARE_ITEMS} ürün karşılaştırabilirsiniz!`);
            checkbox.checked = false; // Maksimum aşıldığında checkbox'ı kaldır
            return;
        }

        // Eğer ürün zaten ekliyse ekleme yapılmıyor
        if (!compareList.some(item => item.KOD === product.KOD)) {
            compareList.push(product);
        }
    } else {
        removeFromCompare(product.KOD); // Ürünü listeden çıkar
    }

    updateCompareFooter(); // Footer'ı güncelle
}

function getProductByCode(productCode) {
    return products.find(product => product.KOD === productCode);
}

function updateCompareFooter() {
    const compareFooter = document.getElementById("compareFooter");
    const compareCount = document.getElementById("compareCount");

    if (compareList.length >= 2) {
        compareFooter.style.display = "block"; // Karşılaştırma butonunu göster
        compareCount.textContent = compareList.length; // Sayacı güncelle
    } else {
        compareFooter.style.display = "none"; // 2'den az ürün varsa butonu gizle
    }
}


function removeFromCompare(productCode) {
    // 1️⃣ **Ürünü karşılaştırma listesinden çıkar**
    compareList = compareList.filter(item => item.KOD !== productCode);

    // 2️⃣ **Checkbox güncelleme (Body'deki ürün checkbox'ını temizle)**
    const productCheckbox = document.querySelector(`input[data-product-code="${productCode}"]`);
    if (productCheckbox) {
        productCheckbox.checked = false;
    }

    // 3️⃣ **Eğer sadece 1 ürün kaldıysa modalı kapat ve çık**
    if (compareList.length < 2) {
        $("#compareModal").modal("hide"); // Bootstrap 4 için modal kapatma
        updateCompareFooter(); // Butonu güncelle
        return; // Fonksiyonu burada bitiriyoruz
    }

    // 4️⃣ **Footer butonunu güncelle**
    updateCompareFooter();

    // 5️⃣ **Modal içeriğini tekrar oluştur ve hizalamayı düzelt**
    openCompareModal();
}

function clearCompareList() {
    // 1️⃣ **Karşılaştırma listesini temizle**
    compareList = [];

    // 2️⃣ **Tüm checkbox'ların işaretini kaldır**
    document.querySelectorAll('input[data-product-code]').forEach(checkbox => {
        checkbox.checked = false;
    });

    // 3️⃣ **Footer'daki butonu gizle**
    updateCompareFooter();

    // 4️⃣ **Modalı kapat**
    $("#compareModal").modal("hide");

    
}
//Öneri Fonksiyonu
async function openSuggestionModal(productId) {
  try {
    // 1. /api/similar endpoint'inden benzer ürünleri çekiyoruz.
    const similarResponse = await fetch(`http://192.168.30.4:3000/api/similar?code=${productId}`);
    if (!similarResponse.ok) throw new Error("Benzer ürünler alınamadı.");
    const similarData = await similarResponse.json();
    
    // Benzer ürün kodlarını al ve konsola yazdır.
    const similarCodes = similarData.topSimilar.map(item => item.KOD);
    console.log("Benzer Ürün Kodları:", similarCodes);
    
    // 2. Tıklanan (mevcut) ürün detaylarını /products endpoint'inden çekiyoruz.
    let currentProduct = null;
    const currentResponse = await fetch(`http://192.168.30.4:3000/products?kod=${encodeURIComponent(productId)}`);
    if (currentResponse.ok) {
      const currentData = await currentResponse.json();
      // Tam eşleşme kontrolü:
      const filtered = currentData.filter(prod => prod.KOD === productId);
      currentProduct = filtered.length > 0 ? filtered[0] : (currentData.length > 0 ? currentData[0] : null);
    } else {
      console.warn("Mevcut ürün detayları alınamadı.");
    }
    
    // Eğer benzer kodlar boşsa, uyarı verelim (currentProduct varsa yine devam edelim).
    if (similarCodes.length === 0 && !currentProduct) {
      alert("Önerilen ürün bulunamadı.");
      return;
    }
    
    // Eğer mevcut ürünün fotoğrafı yoksa, öneri yapılamayacağını bildir ve fonksiyonu sonlandır.
    if (currentProduct) {
      const currentImageUrls = await fetchProductImages(currentProduct.KOD);
      const currentImageUrl = (currentImageUrls && currentImageUrls.length > 0) ? currentImageUrls[0] : '/resim/YOK.jpg';
      if (currentImageUrl === '/resim/YOK.jpg') {
        alert("Fotoğrafsız ürünler için öneri yapılamaz.");
        return;
      }
    }
    
    let uniqueProducts = [];
    
    // 3. Her benzer ürün kodu için /products endpoint’ine sıralı olarak istek gönderiyoruz.
    for (const code of similarCodes) {
      const res = await fetch(`http://192.168.30.4:3000/products?kod=${encodeURIComponent(code)}`);
      if (!res.ok) {
        console.warn(`Kod ${code} için ürün verisi alınamadı.`);
        continue;
      }
      const data = await res.json();
      console.log(`Kod ${code} için ürünler:`, data);
      
      // Gelen veride tam eşleşme varsa kullanın.
      const exactProducts = data.filter(prod => prod.KOD === code);
      if (exactProducts.length > 0) {
        uniqueProducts = uniqueProducts.concat(exactProducts);
      } else if (data.length > 0) {
        uniqueProducts.push(data[0]);
      }
    }
    
    console.log("Toplanan Ürünler:", uniqueProducts);
    
    // 4. Modal içeriğini oluşturuyoruz.
    let modalHtml = "";
    
    // Bölüm 1: Mevcut Ürün
    if (currentProduct) {
      modalHtml += `<h5>Mevcut Ürün</h5>`;
      modalHtml += `<div class="d-flex flex-row" style="flex-wrap: nowrap; width: 20%; margin-bottom: 20px;">`;
      const currentImageUrls = await fetchProductImages(currentProduct.KOD);
      const currentImageUrl = (currentImageUrls && currentImageUrls.length > 0) ? currentImageUrls[0] : '/resim/YOK.jpg';
      modalHtml += `
        <div class="text-center" style="flex: 0 0 25%; max-width: 25%;">
          <img src="${currentImageUrl}" alt="${currentProduct.KOD}" style="width: 100%; height: auto; cursor:pointer;" onclick="openImageModal('${currentProduct.KOD}')">
          <p style="margin-top:5px;">${currentProduct.KOD}<br><small>(Mevcut Ürün)</small></p>
        </div>
      `;
      modalHtml += `</div>`;
    }
    
    // Bölüm 2: Önerilen Ürünler
    if (uniqueProducts.length > 0) {
      modalHtml += `<h5>Önerilen Ürünler</h5>`;
      // Ürünler arasında boşluk bırakmak için gap özelliğini ekleyin.
      modalHtml += `<div class="d-flex flex-row" style="flex-wrap: nowrap; width: 100%; overflow-x: auto; gap: 10px;">`;
      for (const product of uniqueProducts) {
        const imageUrls = await fetchProductImages(product.KOD);
        const imageUrl = (imageUrls && imageUrls.length > 0) ? imageUrls[0] : '/resim/YOK.jpg';
        
        // Eğer önerilen ürünün fotoğrafı yoksa mesaj gösterip fonksiyonu sonlandır.
        if (imageUrl === '/resim/YOK.jpg') {
          alert("Fotoğrafsız ürünler için öneri yapılamaz.");
          return;
        }
        
        modalHtml += `
          <div class="text-center" style="flex: 0 0 20%; max-width: 20%; margin-bottom: 10px;">
            <img src="${imageUrl}" alt="${product.KOD}" style="width: 100%; height: auto; cursor:pointer;" onclick="openImageModal('${product.KOD}')">
            <table style="width: 100%; text-align: left; font-size: 0.9em; display: inline-table;">
              <tbody>
                <tr>
                  <td><strong>KATEGORİ:</strong></td>
                  <td><strong>${product.BASAMAK2}</strong></td>
                </tr>
                <tr>
                  <td><strong>ALT KATEGORI:</strong></td>
                  <td><strong>${product.BASAMAK4}</strong></td>
                </tr>
                <tr>
                  <td><strong>KOD:</strong></td>
                  <td><strong>${product.KOD}</strong></td>
                </tr>
                <tr>
                  <td><strong>MODEL:</strong></td>
                  <td><strong>${product.MODEL}</strong></td>
                </tr>
                <tr>
                  <td>EBAT:</td>
                  <td>${product.EBAT}</td>
                </tr>
                <tr>
                  <td>RENK:</td>
                  <td>${product.RENK}</td>
                </tr>
                <tr>
                  <td>DESEN & LAMINE:</td>
                  <td>${product.DESEN ? product.DESEN : '-'} / ${product.LAMINE ? product.LAMINE : '-'}</td>
                </tr>
                <tr>
                  <td>MATERYAL:</td>
                  <td>${product.MATERYAL}</td>
                </tr>
                <tr>
                  <td>AYAK:</td>
                  <td>${product.LEG ? product.LEG : '-'}</td>
                </tr>
                <tr>
                  <td>PRK TL & USD:</td>
                  <td>${formatCurrency(product.SFIYAT1, 1)} / ${formatCurrency(product.SFIYAT4, 4)}</td>
                </tr>
                <tr>
                  <td>STOK / HM:</td>
                  <td>${product.STOK} / ${product.HOM}</td>
                </tr>
                <tr>
                  <td>GÜNCEL KOLEKSİYON:</td>
                  <td>
                    <input type="checkbox" ${product.KOLEKSIYON25 ? 'checked' : ''} onchange="updateKoleksiyon('${product.KOD}', 'KOLEKSIYON25', this.checked)">
                  </td>
                </tr>
                <tr>
                  <td>PROJE:</td>
                  <td>
                    <input type="checkbox" ${product.KURUMSALLIST ? 'checked' : ''} onchange="updateKoleksiyon('${product.KOD}', 'KURUMSALLIST', this.checked)">
                  </td>
                </tr>
                <tr>
                  <td>Fiyat Kontrol:</td>
                  <td>
                    <input
                      type="checkbox"
                      id="fkontrol-${product.KOD}"
                      ${product.FKONTROL ? 'checked' : ''}
                      onchange="updateFkontrol('${product.KOD}', this.checked)"
                    >
                    <input
                      type="text"
                      id="fkontrolnotes-${product.KOD}"
                      value="${product.FKONTROLNOTES || ''}"
                      style="display: ${product.FKONTROL ? 'inline-block' : 'none'};"
                      onblur="updateFkontrolNotes('${product.KOD}', this.value)"
                    >
                  </td>
                </tr>
                <tr>
                  <td>Fuar 2025:</td>
                  <td>${product.FUAR25 ? '✅ Evet' : '❌ Hayır'}</td>
                </tr>
                <tr>
                  <td>Karşılaştır:</td>
                  <td>
                    <label class="compare-checkbox">
                      <input type="checkbox" data-product-code="${product.KOD}" onclick="toggleCompare('${product.KOD}', this)"> 
                    </label>
                  </td>
                </tr>
                <tr style="padding: 0;">
                  <td>NOTLAR:</td>
                  <td><textarea onblur="updateNotes('${product.KOD}', this.value)">${product.NOTES || ''}</textarea></td>
                </tr>
                <tr>
                  <td colspan="2" style="text-align: center;">
                    <button class="btn btn-sm" style="background-color: #727476; color: white; border: none;" onclick="addToCart('${product.KOD}')">Teklif Sepetine Ekle</button>
                  </td>
                </tr>
              </tbody>
            </table>
          </div>
        `;
      }
      modalHtml += `</div>`;
    }
    
    // 5. Modal body'yi güncelleyin ve modalı açın.
    document.getElementById("suggestionModalBody").innerHTML = modalHtml;
    $('#suggestionModal').modal('show');
  } catch (error) {
    console.error("Öneri modal hatası:", error);
    alert("Öneriler yüklenirken bir hata oluştu: " + error.message);
  }
}




function openCompareModal() {
    const modalBody = document.getElementById("compareProductsContainer");

    if (compareList.length < 2) {
        alert("Karşılaştırma yapmak için en az 2 ürün seçmelisiniz!");
        return;
    }

    modalBody.innerHTML = ""; // Önce içeriği temizle

    compareList.forEach(product => {
        const productDiv = document.createElement("div");
        productDiv.className = "compare-product";

        productDiv.innerHTML = `
            <div id="carousel${product.KOD}" class="carousel slide" data-ride="carousel">
                <ol class="carousel-indicators">
                    <li data-target="#carousel-${product.KOD}" data-slide-to="0" class="active"></li>
                </ol>
                <div class="carousel-inner">
                    <div class="carousel-item active">
                        <img src="/resim/${product.KOD}.jpg" class="d-block w-100" alt="${product.ADI}">
                    </div>
                </div>
            </div>
            <table class="table table-bordered">
                <tr><td><strong>KATEGORİ:</strong></td><td>${product.BASAMAK2}</td></tr>
                <tr><td><strong>ALT KATEGORI:</strong></td><td>${product.BASAMAK4}</td></tr>
                <tr><td><strong>KOD:</strong></td><td>${product.KOD}</td></tr>
                <tr><td><strong>MODEL:</strong></td><td>${product.MODEL}</td></tr>
                <tr><td>EBAT:</td><td>${product.EBAT}</td></tr>
                <tr><td>RENK:</td><td>${product.RENK}</td></tr>
                <tr><td>DESEN & LAMINE:</td><td>${product.DESEN ? product.DESEN : '-'} / ${product.LAMINE ? product.LAMINE : '-'}</td></tr>
                <tr><td>MATERYAL:</td><td>${product.MATERYAL}</td></tr>
                <tr><td>PRK TL & USD:</td><td>${formatCurrency(product.SFIYAT1, 1)} / ${formatCurrency(product.SFIYAT4, 4)}</td></tr>
                <tr><td>STOK / HM:</td><td>${product.STOK} / ${product.HOM}</td></tr>
            </table>
            <button class="btn btn-danger btn-sm" onclick="removeFromCompare('${product.KOD}')">Listeden Kaldır</button>
        `;

        modalBody.appendChild(productDiv);
    });

    // **Ürün sayısına göre dizilim güncelleme**
    if (compareList.length === 3) {
        modalBody.style.justifyContent = "space-around";
    } else if (compareList.length === 2) {
        modalBody.style.justifyContent = "center";
    } else {
        modalBody.style.justifyContent = "space-between";
    }

    $("#compareModal").modal("show");
}


function addToCompare(product) {
    
    if (compareList.length >= MAX_COMPARE_ITEMS) {
        alert(`En fazla ${MAX_COMPARE_ITEMS} ürün karşılaştırabilirsiniz!`);
        return;
    }

    // Eğer ürün zaten ekliyse ekleme
    if (compareList.some(item => item.KOD === product.KOD)) {
        alert("Bu ürün zaten karşılaştırma listesinde!");
        return;
    }

    compareList.push(product);
    updateCompareFooter(); // Butonun görünürlüğünü güncelle
    
    
}




// Menü tıklama olayını dinleyip sadece basamak2 ve basamak4 dropdownlarını güncelleme
document.addEventListener('DOMContentLoaded', () => {
    
	const menu = document.getElementById('urunlerDropdown');
    const basamak2Select = document.getElementById("basamak2");
    const basamak4Select = document.getElementById("basamak4");

    if (!menu || !basamak2Select || !basamak4Select) {
        console.error("Gerekli elementler bulunamadı. Lütfen HTML yapısını kontrol edin.");
        return;
    }



    // Menü öğesine tıklama dinleyicisi
    menu.addEventListener('click', async (event) => {
        event.preventDefault(); // Varsayılan tıklama davranışını engelle

        const target = event.target.closest('a'); // En yakın <a> öğesini bul
        if (target) {
            const basamak2 = target.dataset.basamak2?.trim() || ""; // Ana kategori (BASAMAK2)
            const basamak4 = target.dataset.basamak4?.trim() || ""; // Alt kategori (BASAMAK4)

            // BASAMAK2 Dropdown Güncelleme
            try {
                const options = Array.from(basamak2Select.options);
                const optionExists = options.some((option) => option.value.trim() === basamak2);

                if (optionExists) {
                    basamak2Select.value = basamak2;
                } else if (basamak2) {
                    const newOption = new Option(basamak2, basamak2, false, true);
                    basamak2Select.add(newOption);
                    basamak2Select.value = basamak2;
                } else {
                    console.warn("BASAMAK2 değeri boş, işlem yapılmadı.");
                }
            } catch (error) {
                console.error("BASAMAK2 Dropdown Güncelleme Hatası:", error);
            }

            // BASAMAK4 Dropdown Güncelleme
            try {
                if (basamak4) {
                    basamak4Select.value = basamak4;
                } else {
                    basamak4Select.value = ""; // Temizle
                }
            } catch (error) {
                console.error("BASAMAK4 Dropdown Güncelleme Hatası:", error);
            }

            // Sonuçları Konsolda Göster
            
			// **Ana ürün konteynerini gizle, konsept ürün konteynerini göster**
			document.getElementById("product-container").style.display = "flex";
			document.getElementById("concept-products-container").style.display = "none";
			// 📌 **Varsayılan container belirle ve LoadProducts çağır**
            let targetContainerId = "product-container"; // 🌟 Varsayılan olarak ana sayfaya yükle
            const activeTab = document.querySelector(".nav-tabs .nav-link.active");
            if (activeTab) {
                const targetTab = activeTab.getAttribute("href").substring(1);
                if (targetTab === "adminPanel") {
                    targetContainerId = "admin-product-container";
                } else if (targetTab === "reports") {
                    targetContainerId = "report-product-container";
					
                }
            }
			
			if (initialImageContainer) {
				initialImageContainer.style.display = 'none';
			}

			currentPage = 1;
            showLoadingMessage();
            await loadProducts(currentPage, targetContainerId); // 📌 **Doğru container ile çağır!**
            hideLoadingMessage();
        } else {
            console.warn("Tıklanan öğe bir <a> etiketi değil.");
        }
    });
});

// Checkbox güncelleme fonksiyonu
const updateFkontrol = async (kod, isChecked) => {
    try {
        // Backend'e FKONTROL değerini gönder
        await fetch('http://192.168.30.4:3000/update-details', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                KOD: kod,
                FKONTROL: isChecked ? 1 : 0,
                FKONTROLNOTES: isChecked ? undefined : '', // Tiki kaldırılırsa notları sil
            }),
        });

        // İlgili notlar alanını kontrol et
        const notesInput = document.getElementById(`fkontrolnotes-${kod}`);
        if (!isChecked) {
            notesInput.value = ''; // Not alanını temizle
        }
        notesInput.style.display = isChecked ? 'inline-block' : 'none';
    } catch (error) {
        console.error('Checkbox güncelleme hatası:', error);
    }
};

// Notlar güncelleme fonksiyonu
const updateFkontrolNotes = async (kod, notes) => {
    try {
        await fetch('http://192.168.30.4:3000/update-details', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                KOD: kod,
                FKONTROLNOTES: notes,
            }),
        });
    } catch (error) {
        console.error('Notlar güncelleme hatası:', error);
    }
};



	const updateKoleksiyon = async (kod, field, value) => {
		const response = await fetch(`http://192.168.30.4:3000/update-details`, {
			method: 'POST',
			headers: {
				'Content-Type': 'application/json'
			},
			body: JSON.stringify({ KOD: kod, [field]: value ? 1 : 0 })
		});
		const result = await response.json();
	};

	const updateNotes = async (kod, notes) => {
		const response = await fetch(`http://192.168.30.4:3000/update-details`, {
			method: 'POST',
			headers: {
				'Content-Type': 'application/json'
			},
			body: JSON.stringify({ KOD: kod, NOTES: notes })
		});
		const result = await response.json();
	};

	document.getElementById('threeProdBtn').addEventListener('click', () => {
		updateColumns(3);
		document.getElementById('threeProdBtn').classList.add('active');
		document.getElementById('fourProdBtn').classList.remove('active');
	});

	document.getElementById('fourProdBtn').addEventListener('click', () => {
		updateColumns(4);
		document.getElementById('fourProdBtn').classList.add('active');
		document.getElementById('threeProdBtn').classList.remove('active');
	});


	applyFiltersButton.addEventListener('click', async () => {
    const initialImageContainer = document.getElementById('initialImageContainer');
    const productContainer = document.getElementById('product-container');
    const adminProductContainer = document.getElementById('admin-product-container');
    
    // Aktif sekmeyi kontrol et (örneğin, href değeri)
    const activeTab = document.querySelector(".nav-tabs .nav-link.active");
    let targetContainer;
    if (activeTab && activeTab.getAttribute("href").substring(1) === "adminPanel") {
        targetContainer = adminProductContainer;
    } else {
        targetContainer = productContainer;
    }
    
    // Filtrelerin boş olup olmadığını kontrol et
    const isAnyFilterSelected =
        basamak2Select.value ||
        basamak4Select.value ||
        anamodelSelect.value ||
        modelSelect.value ||
		kodSelect.value ||
        ebatSelect.value;

    // Eğer filtre seçilmediyse mesaj göster
    //if (!isAnyFilterSelected) {
    //    alert('Ürün listelemek için en az bir filtre seçmelisiniz.');
    //    return;
    //}
    
    if (initialImageContainer) {
        initialImageContainer.style.display = 'none';
    }
    targetContainer.style.display = 'flex';
    
    currentPage = 1;
    // Yükleme mesajını göster
    showLoadingMessage();
    
    
    // loadProducts fonksiyonunu, hedef container id'sini parametre olarak verin.
    await loadProducts(currentPage, targetContainer.id);
    
    // İşlem tamamlandıktan sonra yükleme mesajını gizle
    hideLoadingMessage();
});


	clearFiltersButton.addEventListener('click', clearFilters);
	


	updateColumns(columns);
	</script>
	<script>
	//Slider’ların Dinamik Değerlerini Güncelleyin
	
	
	
        // Fotoğraf kontrolü için yardımcı fonksiyon
        const checkImageExists = async (url) => {
            return new Promise((resolve) => {
                const img = new Image();
                img.onload = () => resolve(true);
                img.onerror = () => resolve(false);
                img.src = url;
            });
        };

        // Modal'ı açan ve fotoğrafları yükleyen fonksiyon
window.openImageModal = async (productCode) => {
    const modalCarouselInner = document.querySelector('#modalCarouselInner');
    const modalCarouselIndicators = document.querySelector('#modalCarouselIndicators');
    const modalLabel = document.querySelector('#imageModalLabel');

    if (!modalCarouselInner || !modalLabel || !modalCarouselIndicators) {
        console.error('Modal carousel içeriği, indicator veya başlık bulunamadı.');
        return;
    }

    // Ürün kodunu modal başlığına ata
    modalLabel.textContent = productCode;

    // Endpoint üzerinden resim URL'lerini al (UNC yolları burada dönüştürülmüş oluyor)
    let imageUrls = [];
    try {
        const response = await fetch(`/api/intrafoto/${productCode}`);
        if (response.ok) {
            const data = await response.json();
            imageUrls = data.imageUrls;
        }
    } catch (error) {
        console.error("Resim bilgileri alınırken hata:", error);
    }
    // Eğer hiçbir görsel bulunamazsa, varsayılan görseli ekle
    if (!imageUrls || imageUrls.length === 0) {
        imageUrls = ['/resim/YOK.jpg'];
    }

    // Önceki içerikleri temizle
    modalCarouselInner.innerHTML = '';
    modalCarouselIndicators.innerHTML = '';

    // Resim URL'lerine göre carousel öğelerini ve indicator'ları oluştur
    imageUrls.forEach((url, index) => {
        const carouselItem = document.createElement('div');
        carouselItem.className = `carousel-item ${index === 0 ? 'active' : ''}`;
        carouselItem.innerHTML = `<img src="${url}" alt="Ürün Görseli" class="d-block w-100">`;
        modalCarouselInner.appendChild(carouselItem);

        const indicator = document.createElement('li');
        indicator.setAttribute('data-target', '#modalCarousel');
        indicator.setAttribute('data-slide-to', index);
        if (index === 0) indicator.classList.add('active');
        modalCarouselIndicators.appendChild(indicator);
    });

    // İlk öğeyi aktif yap ve modalı göster
    $('#modalCarousel').carousel(0);
    $('#imageModal').modal('show');
};


	const deleteCart = async (cartId) => {
		const confirmation = confirm("Bu sepeti ve tüm içeriğini silmek istediğinizden emin misiniz?");
		if (!confirmation) return;

		try {
			// Sepet silme API çağrısı
			const response = await fetch(`http://192.168.30.4:3000/delete-cart/${cartId}`, {
				method: "DELETE",
			});

			if (!response.ok) throw new Error("Sepet silinemedi.");

			const result = await response.json();
			if (result.success) {
				alert("Sepet ve içeriği başarıyla silindi!");
				showCartList(); // Listeyi güncelle
			} else {
				alert(result.message || "Sepet silinirken bir hata oluştu.");
			}
		} catch (error) {
			console.error("Sepet silme hatası:", error);
			alert("Sepet silinemedi. Lütfen tekrar deneyin.");
		}
	};
	
	document.addEventListener("DOMContentLoaded", () => {
    const adminTabs = document.getElementById("adminTabs");
    const logoContainer = document.getElementById("logoContainer");

    // **Admin olup olmadığını localStorage'dan kontrol et**
    const isAdmin = localStorage.getItem("isAdmin") === "true"; // Admin kontrolü

    if (isAdmin) {
        adminTabs.style.display = "flex"; // **Admin sekmelerini aç**
        logoContainer.classList.add("admin-active"); // **Logoyu sekmelerin hizasına getir**
    } else {
        adminTabs.style.display = "none"; // **Normal kullanıcı ise sekmeler görünmesin**
        logoContainer.classList.remove("admin-active"); // **Logo ortada kalsın**
    }
});

// 📊 Günlük Sipariş ve Teklif Grafiğini Yükle ve Güncelle
let dailyOrdersChart, dailyOffersChart;
const updateSummaryTable = (ordersData) => {
    const weekDays = ["PAZARTESİ", "SALI", "ÇARŞAMBA", "PERŞEMBE", "CUMA", "CUMARTESİ", "PAZAR"];
    const summaryTableBody = document.getElementById("summaryTableBody");
    const totalSiparisEl = document.getElementById("totalSiparis");
    const totalTeklifEl = document.getElementById("totalTeklif");

    let totalSiparis = 0;
    let totalTeklif = 0;

    // 📌 Önce tabloyu temizleyelim
    summaryTableBody.innerHTML = "";

    weekDays.forEach(day => {
        const siparisTotal = ordersData
            .filter(order => order.GUN === day && order.TIP === "SIPARIS")
            .reduce((sum, order) => sum + order.TOPLAM_SIPARIS, 0);

        const teklifTotal = ordersData
            .filter(order => order.GUN === day && order.TIP === "TEKLIF")
            .reduce((sum, order) => sum + order.TOPLAM_SIPARIS, 0);

        totalSiparis += siparisTotal;
        totalTeklif += teklifTotal;

        const row = `
            <tr>
                <td>${day}</td>
                <td>${siparisTotal.toLocaleString('tr-TR', { style: 'currency', currency: 'USD' })}</td>
                <td>${teklifTotal.toLocaleString('tr-TR', { style: 'currency', currency: 'USD' })}</td>
            </tr>
        `;
        summaryTableBody.innerHTML += row;
    });

    // 📌 Alt toplamları güncelle
    totalSiparisEl.innerText = totalSiparis.toLocaleString('tr-TR', { style: 'currency', currency: 'USD' });
    totalTeklifEl.innerText = totalTeklif.toLocaleString('tr-TR', { style: 'currency', currency: 'USD' });
};

//Aylık Özet Tablosunu Dinamik Olarak Doldurma
const updateMonthlySummaryTable = async () => {
  try {
    const response = await fetch('/api/monthly-summary?year=' + new Date().getFullYear());
    if (!response.ok) throw new Error("Aylık veriler alınamadı.");
    const result = await response.json();
    if (!result.success) {
      throw new Error("Aylık veriler alınamadı.");
    }
    const monthlyData = result.data; // Yeni endpoint, { success, data } şeklinde döner.
    const tbody = document.getElementById('monthlySummaryTableBody');
    tbody.innerHTML = "";
    
    // Toplamları tutacak değişkenler
    let sumDekor = 0, sumDeri = 0, sumDiger = 0, sumToplam = 0;
    
    // Her bir ay için satır oluşturup toplamları güncelleyelim
    monthlyData.forEach(item => {
      // Önceki aya göre değişim hesaplaması (yüzde)
      let change = "N/A";
      if (item.ONCEKI_TOPLAM && Number(item.ONCEKI_TOPLAM) !== 0) {
        change = (((Number(item.TOPLAM) - Number(item.ONCEKI_TOPLAM)) / Number(item.ONCEKI_TOPLAM)) * 100).toFixed(1) + "%";
      }
      
      // Artış veya azalışa göre stil uygulaması (artış yeşil, azalış kırmızı)
      let changeStyle = "";
      if (item.ONCEKI_TOPLAM && Number(item.TOPLAM) > Number(item.ONCEKI_TOPLAM)) {
        changeStyle = 'style="color:green;"';
      } else if (item.ONCEKI_TOPLAM && Number(item.TOPLAM) < Number(item.ONCEKI_TOPLAM)) {
        changeStyle = 'style="color:red;"';
      }
      
      // Sayıların doğru hesaplanabilmesi için Number() kullanıyoruz.
      sumDekor += Number(item.DEKOR) || 0;
      sumDeri += Number(item.DERI) || 0;
      sumDiger += Number(item.DIGER) || 0;
      sumToplam += Number(item.TOPLAM) || 0;
      
      const row = `
        <tr>
          <td>${item.AY}</td>
          <td>${Number(item.DEKOR).toLocaleString('tr-TR', { style: 'currency', currency: 'USD' })}</td>
          <td>${Number(item.DERI).toLocaleString('tr-TR', { style: 'currency', currency: 'USD' })}</td>
          <td>${Number(item.DIGER).toLocaleString('tr-TR', { style: 'currency', currency: 'USD' })}</td>
          <td>${Number(item.TOPLAM).toLocaleString('tr-TR', { style: 'currency', currency: 'USD' })}</td>
          <td ${changeStyle}>${change}</td>
        </tr>
      `;
      tbody.innerHTML += row;
    });
    
    // Alt toplam satırını ekleyelim
    const totalRow = `
      <tr>
        <td><strong>Toplam</strong></td>
        <td><strong>${sumDekor.toLocaleString('tr-TR', { style: 'currency', currency: 'USD' })}</strong></td>
        <td><strong>${sumDeri.toLocaleString('tr-TR', { style: 'currency', currency: 'USD' })}</strong></td>
        <td><strong>${sumDiger.toLocaleString('tr-TR', { style: 'currency', currency: 'USD' })}</strong></td>
        <td><strong>${sumToplam.toLocaleString('tr-TR', { style: 'currency', currency: 'USD' })}</strong></td>
        <td></td>
      </tr>
    `;
    tbody.innerHTML += totalRow;
    
  } catch (error) {
    console.error("Aylık özet güncelleme hatası:", error);
  }
};

updateMonthlySummaryTable();

//Top10 Müşteri Performans Raporu
const loadTop10CustomerPerformance = async () => {
  try {
    const response = await fetch('/api/top10-customer-performance');
    if (!response.ok) {
      throw new Error('Top 10 müşteri performansı verileri alınamadı.');
    }
    const result = await response.json();
    if (!result.success) {
      throw new Error('Veriler çekilirken bir hata oluştu.');
    }
    const data = result.data;

    // Para birimi formatlaması için yardımcı fonksiyon (USD örneği)
    const formatCurrency = (value) => {
      return Number(value).toLocaleString('tr-TR', { style: 'currency', currency: 'USD' });
    };

    const tbody = document.getElementById('top10CustomerPerformanceTableBody');
    tbody.innerHTML = ""; // Tabloyu temizle

    // Verileri SATISGRUP alanına göre grupluyoruz
    const groupedData = data.reduce((groups, item) => {
      const group = item.SATISGRUP || "Bilinmiyor";
      if (!groups[group]) {
        groups[group] = [];
      }
      groups[group].push(item);
      return groups;
    }, {});

    // Her grup için: önce grup başlığı, ardından satırları ve alt toplam satırını ekleyelim
    Object.keys(groupedData).forEach(groupKey => {
      const groupRows = groupedData[groupKey];

      // Grup başlığı satırı
      const groupHeaderRow = document.createElement('tr');
      groupHeaderRow.innerHTML = `<tr><th>Satış Grubu</th><th> Müşteri Adı</th><th>Önceki Yıl Toplam</th><th>Önceki Yıl Ortalama</th><th>Bu Yıl Toplam</th><th>Bu Yıl Ortalama</th><th>Oran</th></tr>`;
      tbody.appendChild(groupHeaderRow);
							  
		
      // Önce grubun toplam CurrentYearTotal'ını hesaplayalım
      const groupTotalCurrentYear = groupRows.reduce((sum, item) => sum + Number(item.CurrentYearTotal), 0);

      // Diğer alt toplamları da hesaplayabiliriz
      const subtotalPrevYearTotal = groupRows.reduce((sum, item) => sum + Number(item.PrevYearTotal), 0);
      const subtotalPrevYearAvg = groupRows.reduce((sum, item) => sum + Number(item.PrevYearAvg), 0);
      const subtotalCurrentYearAvg = groupRows.reduce((sum, item) => sum + Number(item.CurrentYearAvg), 0);

      // Her satır için: oran = (item.CurrentYearTotal / groupTotalCurrentYear) * 100
      groupRows.forEach(item => {
        const ratio = groupTotalCurrentYear > 0 
          ? ((Number(item.CurrentYearTotal) / groupTotalCurrentYear) * 100)
          : 0;
        const ratioFormatted = groupTotalCurrentYear > 0 ? ratio.toFixed(1) + "%" : "N/A";

        const row = document.createElement('tr');
        row.innerHTML = `
          <td>${item.SATISGRUP}</td>
          <td style="text-align: left;">${item.ADI}</td>
          <td>${formatCurrency(item.PrevYearTotal)}</td>
          <td>${formatCurrency(item.PrevYearAvg)}</td>
          <td>${formatCurrency(item.CurrentYearTotal)}</td>
          <td>${formatCurrency(item.CurrentYearAvg)}</td>
          <td>${ratioFormatted}</td>
        `;
        tbody.appendChild(row);
      });

      // Grup alt toplam satırı
      const subtotalRow = document.createElement('tr');
      subtotalRow.style.fontWeight = "bold";
      subtotalRow.style.backgroundColor = "#f2f2f2";
      subtotalRow.innerHTML = `
        <td colspan="2">Toplam (${groupKey})</td>
        <td>${formatCurrency(subtotalPrevYearTotal)}</td>
        <td>${formatCurrency(subtotalPrevYearAvg)}</td>
        <td>${formatCurrency(groupTotalCurrentYear)}</td>
        <td>${formatCurrency(subtotalCurrentYearAvg)}</td>
        <td>${groupTotalCurrentYear !== 0 ? "100%" : "N/A"}</td>
		
      `;
      tbody.appendChild(subtotalRow);
	  
	  const bosRow = document.createElement('tr');
      bosRow.style.fontWeight = "bold";
      bosRow.style.backgroundColor = "#f2f2f2";
      bosRow.innerHTML = `
	  <td colspan="2"></td>
        <td></td>
        <td></td>
        <td></td>
        <td></td>
        <td></td>
		
      `;
      tbody.appendChild(bosRow);
	  
    });
  } catch (error) {
    console.error("Top 10 müşteri performansı güncelleme hatası:", error);
  }
};

// Sayfa yüklendiğinde çalıştır
loadTop10CustomerPerformance();


// 📌 Grafikleri yükledikten sonra tabloyu güncelle
const loadDailyOrdersChart = async () => {
    try {
        if (typeof Chart === "undefined") {
            console.error("Chart.js yüklenmedi! Lütfen kütüphaneyi eklediğinizden emin olun.");
            return;
        }

        const response = await fetch("http://192.168.30.4:3000/api/orders-daily");
        if (!response.ok) throw new Error("Günlük sipariş verileri alınamadı.");

        const ordersData = await response.json();

        if (ordersData.length === 0) {
            console.warn("Bu hafta için sipariş verisi bulunamadı.");
            return;
        }

        // 📌 Özet tabloyu güncelle
        updateSummaryTable(ordersData);

        const weekDays = ["PAZARTESİ", "SALI", "ÇARŞAMBA", "PERŞEMBE", "CUMA", "CUMARTESİ", "PAZAR"];
        const groupNames = [...new Set(ordersData.map(order => order.SATISGRUP))];
		// 📌 Daha Sof Pastel Renkler
		const pastelColors = [
			"rgba(75, 192, 192, 0.6)",  // Soft Mavi-Yeşil
			"rgba(153, 102, 255, 0.6)", // Soft Mor
			"rgba(255, 159, 64, 0.6)",  // Soft Turuncu
			"rgba(54, 162, 235, 0.6)",  // Soft Mavi
			"rgba(201, 203, 207, 0.6)", // Soft Gri
			"rgba(255, 205, 86, 0.6)",  // Soft Sarı
			"rgba(233, 150, 122, 0.6)", // Soft Mercan
		];

		// 📌 Daha Hafif Kenarlık Renkleri
		const pastelBorders = [
			"rgba(75, 192, 192, 1)",
			"rgba(153, 102, 255, 1)",
			"rgba(255, 159, 64, 1)",
			"rgba(54, 162, 235, 1)",
			"rgba(201, 203, 207, 1)",
			"rgba(255, 205, 86, 1)",
			"rgba(233, 150, 122, 1)"
		];

        const createDataset = (tip) => {
			return groupNames.map((group, index) => {
				return {
					label: `${group} (${tip === 'SIPARIS' ? "SİPARİŞ" : "TEKLİF"})`,
					data: weekDays.map(day => {
						const order = ordersData.find(o => o.GUN === day && o.SATISGRUP === group && o.TIP === tip);
						return order ? order.TOPLAM_SIPARIS : 0;
					}),
					backgroundColor: pastelColors[index % pastelColors.length],  // 📌 Sof Renkler Kullanıldı
					borderColor: pastelBorders[index % pastelBorders.length],   // 📌 Hafif Kenarlıklar
					borderWidth: 1
				};
			});
		};


        const ctxOrders = document.getElementById("dailyOrdersChart")?.getContext("2d");
        const ctxOffers = document.getElementById("dailyOffersChart")?.getContext("2d");

        if (!ctxOrders || !ctxOffers) {
            console.error("Grafik canvasları bulunamadı!");
            return;
        }

        if (dailyOrdersChart) dailyOrdersChart.destroy();
        if (dailyOffersChart) dailyOffersChart.destroy();

        const commonOptions = {
            responsive: true,
            plugins: {
                tooltip: {
                    callbacks: {
                        label: function(tooltipItem) {
                            return tooltipItem.raw.toLocaleString('tr-TR', { style: 'currency', currency: 'USD' });
                        }
                    }
                },
                legend: {
                    position: "top"
                }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    title: { display: true, text: "Tutar (USD)" }
                },
                x: {
                    title: { display: true, text: "Haftanın Günleri" }
                }
            }
        };

        dailyOrdersChart = new Chart(ctxOrders, {
            type: "bar",
            data: { labels: weekDays, datasets: createDataset('SIPARIS') },
            options: commonOptions
        });

        dailyOffersChart = new Chart(ctxOffers, {
            type: "bar",
            data: { labels: weekDays, datasets: createDataset('TEKLIF') },
            options: commonOptions
        });

    } catch (error) {
        console.error("Günlük grafik yüklenirken hata oluştu:", error);
    }
};

loadDailyOrdersChart();
//2 dakikada bir raporları yenile
setInterval(() => {
  loadDailyOrdersChart();
  updateMonthlySummaryTable();
  loadTop10CustomerPerformance();
}, 2 * 60 * 1000);



//Tab tıklama dinleyicisi
document.querySelectorAll(".nav-tabs .nav-link").forEach(tab => {
    tab.addEventListener("click", function () {
        const targetTab = this.getAttribute("href").substring(1); // Aktif sekmeyi al
		const filterContainer = document.getElementById('filter-container'); // Global element her seferinde seçiliyor

        let targetContainerId = "";
        if (targetTab === "home") {
            targetContainerId = "product-container";
			//product-container.style.display = "block";

        } else if (targetTab === "adminPanel") {
            targetContainerId = "admin-product-container";
        }

        // 📌 **Eğer raporlar sekmesi seçildiyse, grafiği yükle ve image container'ı gizle**
        if (targetTab === "reports") {
            if (initialImageContainer) {
                initialImageContainer.style.display = "none";
            }
			if (filterContainer) {
				filterContainer.style.display = 'none';
			}
            loadDailyOrdersChart(); // 📊 Haftalık grafik verisini yükle
            return; // 📌 **Fonksiyondan çık, loadProducts çağrılmasın**
			
        }

        // 📌 **Eğer diğer sekmeler seçildiyse, ürünleri yükle**
        if (targetContainerId) {
            filterContainer.style.display = 'block';
			//loadProducts(1, targetContainerId);
        }
    });
});
//Banner Modalını Açan Fonksiyon
function openBannerSelection(cartId) {
    fetch('/api/get-banner-images')
        .then(response => response.json())
        .then(images => {
            const modalBody = document.getElementById("bannerImagesContainer"); // 📌 Doğru ID

            // 📌 Eğer modal bulunamazsa, hata ver ve çık
            if (!modalBody) {
                console.error("📌 HATA: Modal body bulunamadı! 'bannerImagesContainer' id'sini kontrol edin.");
                return;
            }

            modalBody.innerHTML = ""; // Önce temizleyelim

            images.forEach(image => {
                const imageName = image.replace(".jpg", "").replace(".png", ""); // 📌 .jpg ve .png uzantısını kaldır

                // 📌 **Container Oluştur**
                const imageContainer = document.createElement("div");
                imageContainer.className = "banner-item";
                imageContainer.style.textAlign = "center";
                imageContainer.style.margin = "10px";

                // 📌 **Görseli Oluştur**
                const imgElement = document.createElement("img");
                imgElement.src = `/resim/banner/${image}`;
                imgElement.className = "banner-thumbnail"; // CSS Sınıfı (Gerekirse ekleyin)
                imgElement.style.cursor = "pointer";
                imgElement.style.border = "1px solid #ddd";
                imgElement.style.padding = "5px";
                imgElement.style.borderRadius = "8px";
                imgElement.style.maxWidth = "150px";
                imgElement.onclick = () => updateCartBanner(cartId, image);

                // 📌 **İsmi Yazdır**
                const nameElement = document.createElement("div");
                nameElement.textContent = imageName;
                nameElement.style.fontSize = "14px";
                nameElement.style.marginTop = "5px";
                nameElement.style.color = "#333";
                nameElement.style.fontWeight = "bold";

                // 📌 **Container’a Ekleyelim**
                imageContainer.appendChild(imgElement);
                imageContainer.appendChild(nameElement);
                modalBody.appendChild(imageContainer);
            });

            $('#bannerSelectionModal').modal('show'); // 📌 Modalı Aç
        })
        .catch(error => console.error("Banner yüklenirken hata oluştu:", error));
}

//Seçilen Banner'ı Güncelleme Fonksiyonu
function updateCartBanner(cartId, bannerFileName) {
    fetch(`/api/update-cart-banner`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
            cartId,
            bannerPath: `/resim/banner/${bannerFileName}`
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            document.getElementById("conceptBannerImg").src = `/resim/banner/${bannerFileName}`;
            $('#bannerSelectionModal').modal('hide'); // Modalı kapat
        } else {
            alert("Banner güncellenemedi!");
        }
    })
    .catch(error => console.error("Banner güncellenirken hata oluştu:", error));
}


//Seçilen Banner’ı Güncelleyen Fonksiyon
function selectBannerImage(cartId, imageName) {
    const bannerPath = `/resim/banner/${imageName}`;
    document.getElementById("conceptBannerImage").src = bannerPath;

    // 📌 Seçimi kaydet (CART tablosuna güncelleme gönderiyoruz)
    fetch('/api/update-cart-banner', {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ cartId, banner: bannerPath })
    }).then(() => {
        $('#bannerSelectionModal').modal('hide'); // Modalı kapat
    });
}

//// 📌 Dropdown'un açılma yönünü kontrol et
$('.selectpicker').on('show.bs.select', function () {
    const $menu = $(this).next('.dropdown-menu');
    const windowHeight = $(window).height();
    const dropdownTop = $(this).offset().top;
    const dropdownHeight = $menu.outerHeight();

    // Eğer dropdown ekranın altına taşıyorsa üste aç
    if (dropdownTop + dropdownHeight > windowHeight) {
        $menu.css({ top: 'auto', bottom: '100%', transform: 'translateY(-5px)' });
    } else {
        $menu.css({ top: '100%', bottom: 'auto', transform: 'translateY(5px)' });
    }
});

</script>
<script>
//Yükleme animasyonunu göster
const showLoadingMessage = () => {
    const loadingMessage = document.getElementById("loadingMessage");
    if (loadingMessage) {
        loadingMessage.style.display = "flex";
        loadingMessage.style.opacity = "1";
    }
};
//Yükleme animasyonunu gizle
const hideLoadingMessage = () => {
    const loadingMessage = document.getElementById("loadingMessage");
    if (loadingMessage) {
        loadingMessage.style.opacity = "0"; // Görünmezlik için animasyon
        setTimeout(() => {
            loadingMessage.style.display = "none"; // Tamamen kaldır
        }, 300); // Opaklık sıfırlandıktan sonra 300ms bekle
    }
};

</script>

	
	<script>
		document.addEventListener('DOMContentLoaded', () => {
    const exportExcelButton = document.getElementById('exportExcelButton');
    
    if (exportExcelButton) {
        exportExcelButton.addEventListener('click', async () => {

            // 📌 **Yalnızca görünen ürünleri al (`display !== none`)**
            const productDivs = document.querySelectorAll('.product');
            const visibleProducts = Array.from(productDivs).filter(div => div.style.display !== 'none');

            const products = visibleProducts.map(div => {
                const tdElements = div.querySelectorAll('td');
                let BASAMAK2, BASAMAK4, KOD, MODEL, EBAT, RENK, DESEN, LAMINE, LEG, SFIYAT1, SFIYAT4, STOK, HM, KOLEKSIYON, NOTES;

                tdElements.forEach(td => {
                    const nextTd = td.nextElementSibling;
                    const nextText = nextTd ? nextTd.textContent.trim() : "";

                    if (td.textContent.includes('KATEGORİ')) BASAMAK2 = nextText;
                    if (td.textContent.includes('ALT KATEGORI')) BASAMAK4 = nextText;
                    if (td.textContent.includes('KOD')) KOD = nextText;
                    if (td.textContent.includes('MODEL')) MODEL = nextText;
                    if (td.textContent.includes('EBAT')) EBAT = nextText;
                    if (td.textContent.includes('RENK')) RENK = nextText;
                    if (td.textContent.includes('DESEN')) DESEN = nextText;
                    if (td.textContent.includes('LAMINE')) LAMINE = nextText;
                    if (td.textContent.includes('AYAK')) LEG = nextText;
                    if (td.textContent.includes('PRK TL')) {
						const priceMatch = nextText.match(/(\d{1,3}(\.\d{3})*,\d{2})/); // TL fiyatını bul (örn: 36.600,00)
						SFIYAT1 = priceMatch ? priceMatch[0].replace(/\./g, '').replace('.', ',') : "0"; // Noktaları kaldır, virgülü noktaya çevir
					}
					if (td.textContent.includes('USD')) {
						const usdMatch = nextText.match(/\$(\d+,\d{2})/); // USD fiyatını bul (örn: $990,00)
						SFIYAT4 = usdMatch ? usdMatch[1].replace('.', ',') : "0"; // Sadece rakam kısmını al
					}
                    if (td.textContent.includes('STOK')) STOK = nextText.split(' ')[0];
                    if (td.textContent.includes('HM')) HM = nextText.split(' ')[2] || "";
                    if (td.textContent.includes('KOLEKSIYON')) KOLEKSIYON = nextText;
                });

                NOTES = div.querySelector('textarea')?.value?.trim() || '';

                return {
                    BASAMAK2, BASAMAK4, KOD, MODEL, EBAT, RENK, DESEN, LAMINE, LEG,
                    SFIYAT1, SFIYAT4, STOK, HM, KOLEKSIYON, NOTES
                };
            });

            if (products.length > 0) {
                await exportToExcelWithImages(products);
            } else {
                
            }
        });
    }
});

// 📌 **Excel'e aktarma fonksiyonu**
const exportToExcelWithImages = async (products) => {
    const workbook = new ExcelJS.Workbook();
    const worksheet = workbook.addWorksheet('Ürünler');

    worksheet.columns = [
        { header: 'Ürün Foto', key: 'image', width: 17 },
        { header: 'KATEGORİ', key: 'BASAMAK2', width: 15 },
        { header: 'ALT KATEGORİ', key: 'BASAMAK4', width: 15 },
        { header: 'KOD', key: 'KOD', width: 15 },
        { header: 'MODEL', key: 'MODEL', width: 15 },
        { header: 'EBAT', key: 'EBAT', width: 15 },
        { header: 'RENK', key: 'RENK', width: 15 },
        { header: 'DESEN', key: 'DESEN', width: 15 },
        { header: 'LAMINE', key: 'LAMINE', width: 15 },
        { header: 'AYAK', key: 'LEG', width: 15 },
        { header: 'PRK TL', key: 'SFIYAT1', width: 15 },
        { header: 'PRK USD', key: 'SFIYAT4', width: 15 },
        { header: 'STOK', key: 'STOK', width: 15 },
        { header: 'HM', key: 'HM', width: 15 },
        { header: 'KOLEKSIYON', key: 'KOLEKSIYON', width: 15 },
        { header: 'NOTLAR', key: 'NOTES', width: 30 }
    ];

    for (const [index, product] of products.entries()) {
        const rowNumber = index + 2; // İlk satır başlık için kullanıldığı için 2'den başlar
        const row = worksheet.addRow({
            BASAMAK2: product.BASAMAK2,
            BASAMAK4: product.BASAMAK4,
            KOD: product.KOD,
            MODEL: product.MODEL,
            EBAT: product.EBAT,
            RENK: product.RENK,
            DESEN: product.DESEN,
            LAMINE: product.LAMINE,
            LEG: product.LEG,
            SFIYAT1: product.SFIYAT1,
            SFIYAT4: product.SFIYAT4,
            STOK: product.STOK,
            HM: product.HM,
            KOLEKSIYON: product.KOLEKSIYON,
            NOTES: product.NOTES
        });

        // 📌 **Resmi Carousel'den Al**
        const imgElement = document.querySelector(`#carousel${product.KOD} .carousel-item:first-child img`);
        const imgSrc = imgElement ? imgElement.getAttribute('src') : '/resim/YOK.jpg';

        try {
            const imageBuffer = await fetch(imgSrc).then(res => res.arrayBuffer());

            const imageId = workbook.addImage({
                buffer: imageBuffer,
                extension: 'jpeg'
            });

            worksheet.addImage(imageId, {
                tl: { col: 0, row: rowNumber - 1, rowOffset: 5 },
                ext: { width: 100, height: 100 }
            });

            worksheet.getRow(rowNumber).height = 102;
        } catch (error) {
            console.error(`Resim yüklenemedi: ${imgSrc}`);
        }
    }

    workbook.xlsx.writeBuffer().then(buffer => {
        const blob = new Blob([buffer], { type: 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet' });
        const link = document.createElement('a');
        link.href = URL.createObjectURL(blob);
        link.download = 'urunler.xlsx';
        link.click();
    });
};



	</script>
	<script>
	let activeCartId = null; // Şu anda aktif olan sepet kimliği

	const updateCartButtonState = () => {
		const viewCartButton = document.querySelector('#viewCartButton');
		if (!viewCartButton) {
			
			return;
		}
		// Butonu her zaman etkin bırak
		viewCartButton.disabled = false;
		viewCartButton.title = '';
	};

	// Sepet Oluşturma Fonksiyonu
const createCart = async () => {
  const userId = localStorage.getItem('userId');
  if (!userId) {
    alert('Lütfen önce giriş yapın.');
    return;
  }

  // Form alanlarından verileri alıyoruz:
  const customerType = document.getElementById('customerType').value || 'perakende';
  const salesArea = document.getElementById('salesArea').value || 'yurtici';
  const customerName = document.getElementById('cartName').value.trim() || 'Anonim Müşteri';
  const priceType = document.getElementById('priceType').value || '1';
  const discountRate = parseFloat(document.getElementById('discountRate').value) || 0;
  const vatIncluded = document.getElementById('vatIncluded').value || '1';

  try {
    const response = await fetch('http://192.168.30.4:3000/create-cart', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ userId, customerType, salesArea, customerName, priceType, discountRate, vatIncluded }),
    });

    const data = await response.json();

    if (response.ok && data.success) {
      alert('Sepet başarıyla oluşturuldu!');
      activeCartId = data.cartId; // Aktif sepet kimliğini güncelle

      // Sepet oluşturulduktan sonra formu kapatma
      $('#cartFormModal').modal('hide');

      // Sepetler listesini güncelleme
      showCartList();
    } else {
      alert(data.message || 'Sepet oluşturulamadı.');
    }
  } catch (error) {
    console.error('Sepet oluşturma hatası:', error);
    alert('Bir hata oluştu. Lütfen tekrar deneyin.');
  }
};


	// Sayfa ilk yüklendiğinde butonun durumunu kontrol et
	document.addEventListener('DOMContentLoaded', () => {
		updateCartButtonState();
	});

	// Sepete ürün ekleme
	const addToCart = async (productId) => {
		try {
			// Aktif bir sepet yoksa kullanıcıyı uyar ve modalı göster
			if (!activeCartId) {
				alert('Lütfen önce bir sepet oluşturun veya bir sepet seçin.');
				$('#cartModal').modal('show');
				return;
			}

			// Sepete ürün ekleme için veri oluşturma
			const cartData = {
				cartId: activeCartId,
				productId,
				quantity: 1 // Varsayılan miktar
			};

			// Sepete ürün ekleme API çağrısı
			const response = await fetch('http://192.168.30.4:3000/cart/item', {
				method: 'POST',
				headers: { 'Content-Type': 'application/json' },
				body: JSON.stringify(cartData)
			});

			// Yanıt doğrulama
			if (!response.ok) {
				const errorText = await response.text();
				throw new Error(`Hata: ${response.status} - ${errorText}`);
			}

			const result = await response.json();

			if (result.success) {
				alert('Ürün sepete başarıyla eklendi!');
				await showCartContents(); // Sepeti yeniden yükle
				updateCartSummary(); // Yeni eklenen özet güncelleme çağrısı
				updateCartFreightInsurance;
				
			} else {
				throw new Error(result.message || 'Ürün sepete eklenemedi.');
			}
		} catch (error) {
			console.error('Sepete ekleme hatası:', error);
			alert(`Bir hata oluştu: ${error.message}`);
		}
	};





	// Aktif sepeti belirleme
	const setActiveCart = async (cartId) => {
		activeCartId = cartId;
		$('#cartListModal').modal('hide');
		await showCartContents();
	};



	// Sepeti temizleme
const clearCart = async () => {
  if (!activeCartId) {
    alert('Aktif bir sepet bulunamadı.');
    return;
  }
  
  // Temizleyen kullanıcı ID'sini localStorage'dan alıyoruz (veya başka bir yerden)
  const clearedBy = localStorage.getItem('userId');
  
  try {
    const response = await fetch(`http://192.168.30.4:3000/clear-cart/${activeCartId}`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ cleared_by: clearedBy })
    });
    
    if (!response.ok) throw new Error('Sepet temizlenemedi.');
    
    alert('Sepet temizlendi!');
    showCartContents(); // Sepeti güncel haliyle göster
  } catch (error) {
    console.error('Sepet temizleme hatası:', error);
    alert('Sepet temizlenemedi.');
  }
};



	// Ürünü sepetten kaldırma
	const removeFromCart = async (cartItemId) => {
		try {
			const response = await fetch(`http://192.168.30.4:3000/remove-from-cart/${cartItemId}`, {
				method: 'DELETE'
			});

			if (!response.ok) throw new Error('Ürün kaldırılamadı.');

			const result = await response.json();

			if (result.success) {
				alert('Ürün başarıyla kaldırıldı.');
				showCartContents(); // Sepeti yeniden yükle
				updateCartSummary(); // Yeni eklenen özet güncelleme çağrısı
				
			} else {
				throw new Error(result.message || 'Ürün kaldırma sırasında bir hata oluştu.');
			}
		} catch (error) {
			console.error('Ürün kaldırma hatası:', error);
			alert(`Bir hata oluştu: ${error.message}`);
		}
	};
// Toggle butonuna tıklandığında:
function toggleConceptCarts() {
  // Modal içerisindeki tüm konsept sepet satırlarını seç
  const conceptRows = document.querySelectorAll('#cartListModalBody tr.concept-cart');
  
  // Eğer en az bir satır görünürse, hepsini gizle; aksi halde hepsini göster.
  let anyVisible = false;
  conceptRows.forEach(row => {
    if (row.style.display !== "none") {
      anyVisible = true;
    }
  });

  conceptRows.forEach(row => {
    row.style.display = anyVisible ? "none" : "";
  });
  
  // Buton metnini güncelle (isteğe bağlı)
  const btn = document.getElementById('toggleConceptCartsBtn');
  btn.innerHTML = anyVisible 
    ? `<i class="fas fa-eye"></i> Konseptleri Göster`
    : `<i class="fas fa-eye-slash"></i> Konseptleri Gizle`;
}


	</script>
	<script>
	// Sepeti yükleme ve ürünleri listeleme

		// loadCart fonksiyonunu global alana taşıyoruz
	// Sepeti yükleme ve senaryoları kontrol etme
	window.loadCart = async () => {
    try {
        const userId = localStorage.getItem('userId'); // Kullanıcı kimliğini alın

        // Kullanıcı giriş yapmamışsa giriş modalını göster
        if (!userId) {
            alert('Sepetleri görüntülemek için önce giriş yapmalısınız.');
            $('#loginModal').modal('show');
            return;
        }

        // Kullanıcının sepetlerini API'den al
        const response = await fetch(`http://192.168.30.4:3000/carts/${userId}`);
        if (!response.ok) {
            throw new Error('Sepet listesi alınamadı.');
        }

        const carts = await response.json();

        // Eğer kullanıcıya ait sepet yoksa
        if (carts.length === 0) {
            alert('Henüz bir sepetiniz yok. Şimdi bir sepet oluşturun.');
            $('#cartFormModal').modal('show'); // Sepet oluşturma modalını aç
            return;
        }

        // Eğer aktif bir sepet varsa, sepet içerik modalını aç
        if (activeCartId) {
            await showCartContents(); // Aktif sepet içeriğini göster
            return;
        }

        // Aktif sepet yoksa, sepetler listesini göster
        showCartList(carts);
    } catch (error) {
        console.error('Sepet yükleme hatası:', error);
        alert('Bir hata oluştu. Lütfen tekrar deneyin.');
    }
};

const generatePDF = async (language = "tr") => {
  const { jsPDF } = window.jspdf;
  const doc = new jsPDF({
    orientation: "portrait",
    unit: "mm",
    format: "a4",
  });

  const margin = 3; // Kenar boşluğu
  const pageWidth = 210; // A4 genişliği
  const pageHeight = 297; // A4 yüksekliği

  // Header, tablo ve footer parametreleri
  const headerHeight = 34; // Header yüksekliği (mm)
  const tableStartY = headerHeight + 5; // Tablo header’dan 5mm aşağıdan başlasın
  const footerHeight = 20; // Footer yüksekliği (mm)

  // Yardımcı: ArrayBuffer'dan Base64'e dönüştürme fonksiyonu
  const arrayBufferToBase64 = (buffer) => {
    let binary = "";
    const bytes = new Uint8Array(buffer);
    for (let i = 0; i < bytes.byteLength; i++) {
      binary += String.fromCharCode(bytes[i]);
    }
    return btoa(binary);
  };

  // Türkçe karakter desteği için font yükle
  const loadFont = async () => {
    const fontUrl = "/fonts/Roboto-Regular.ttf";
    const fontResponse = await fetch(fontUrl);
    if (!fontResponse.ok) throw new Error("Font yüklenemedi.");
    const fontData = await fontResponse.arrayBuffer();
    const fontBase64 = arrayBufferToBase64(fontData);
    doc.addFileToVFS("Roboto-Regular.ttf", fontBase64);
    doc.addFont("Roboto-Regular.ttf", "Roboto", "normal");
    doc.setFont("Roboto");
  };
  await loadFont();

  // Logo yükleme yardımcı fonksiyonu
  const fetchBlobImage = async (url) => {
    const response = await fetch(url);
    if (!response.ok) throw new Error(`Fotoğraf yüklenemedi: ${url}`);
    const blob = await response.blob();
    return new Promise((resolve) => {
      const reader = new FileReader();
      reader.onload = () => resolve(reader.result);
      reader.readAsDataURL(blob);
    });
  };

  let logoBase64 = "";
  try {
    logoBase64 = await fetchBlobImage("/resim/EDLogo.png");
  } catch (error) {
    console.error("Logo yüklenemedi:", error);
  }

  // Sepet bilgilerini al
  const cartInfoResponse = await fetch(`http://192.168.30.4:3000/cart-info/${activeCartId}`);
  if (!cartInfoResponse.ok) throw new Error("Sepet bilgileri alınamadı.");
  const cartInfo = await cartInfoResponse.json();
  window.currentCartInfo = cartInfo;

  // Döviz kontrolünü güncelleyelim:
  let currency = "TL";
  if (cartInfo.PRICE_TYPE === "4" || cartInfo.PRICE_TYPE === "3") {
    currency = "USD";
  } else if (cartInfo.PRICE_TYPE === "5" || cartInfo.PRICE_TYPE === "6") {
    currency = "EUR";
  }

  // Header ekleme fonksiyonu
  const addHeader = (pageNumber, totalPages) => {
    const headerY = margin;
    // Logo: Sağ üstte
    if (logoBase64) {
      doc.addImage(logoBase64, "JPEG", pageWidth - margin - 50, headerY, 50, 10);
    }
    // Başlık (merkeze hizalı)
    doc.setFontSize(22);
    doc.text(language === "tr" ? "Teklif Formu" : "Quotation Form", pageWidth / 2, headerY + 22, { align: "center" });
    // Müşteri Adı (sol alt header)
    doc.setFontSize(10);
    const customerNameLabel = language === "tr" ? "Müşteri Adı:" : "Customer Name:";
    const unknownText = language === "tr" ? "Bilinmiyor" : "Unknown";
    doc.text(`${customerNameLabel} ${cartInfo.CUSTOMER_NAME || unknownText}`, margin, headerY + 28);
    // Tarih ve Döviz (sağ üst header)
    doc.setFontSize(8);
    const today = new Date().toLocaleDateString("tr-TR");
    const dateLabel = language === "tr" ? "Tarih:" : "Date:";
    const currencyLabel = language === "tr" ? "Döviz Cinsi:" : "Currency:";
    doc.text(`${dateLabel} ${today}`, pageWidth - margin, headerY + 22, { align: "right" });
    doc.text(`${currencyLabel} ${currency}`, pageWidth - margin, headerY + 27, { align: "right" });
    // Sayfa numarası
    const pageNumText = language === "tr" ? `Sayfa: ${pageNumber} / ${totalPages}` : `Page: ${pageNumber} / ${totalPages}`;
    doc.text(pageNumText, pageWidth - margin, headerY + 32, { align: "right" });
  };

  // Türkçe karakterleri İngilizce karakterlere dönüştüren yardımcı fonksiyon
  const replaceTurkishChars = (text) => {
    if (!text) return "";
    return text
      .replace(/Ş/g, 'S')
      .replace(/ş/g, 's')
      .replace(/İ/g, 'I')
      .replace(/ı/g, 'i')
      .replace(/Ç/g, 'C')
      .replace(/ç/g, 'c')
      .replace(/Ü/g, 'U')
      .replace(/ü/g, 'u')
      .replace(/Ö/g, 'O')
      .replace(/ö/g, 'o')
      .replace(/Ğ/g, 'G')
      .replace(/ğ/g, 'g');
  };

  // Footer ekleme fonksiyonu
  const addFooter = () => {
    const footerLine1 = "Estetik Decor - Istanbul - Turkey";
    const footerLine2 = "Tel: +90 216 394 03 06 - info@estetikdecor.com";
    doc.setFontSize(8);
    doc.text(footerLine1, pageWidth / 2, pageHeight - 15, { align: "center" });
    doc.text(footerLine2, pageWidth / 2, pageHeight - 10, { align: "center" });
  };

  // Tablo verileri için hazırlık
  const headers = [
    language === "tr"
      ? ["Fotograf", "Ürün Kodu", "Açiklama", "Miktar", "Fiyat", "Ind. %", "Ind. Fiyat", "Tutar"]
      : ["Photo", "Product Code", "Description", "Quantity", "Price", "Disc %", "Disc. Price", "Amount"],
  ];
  const tableImages = [];
  const rows = [];
  let totalQuantity = 0;
  let totalAmount = 0;
  const formatNumber = (value) => {
    const parts = value.toFixed(2).split('.');
    parts[0] = parts[0].replace(/\B(?=(\d{3})+(?!\d))/g, ".");
    return parts.join(",");
  };

  // Sepet verisini PDF için çekiyoruz
  const fetchCartData = async (cartId, language = "tr") => {
    const endpoint = language === "en"
      ? `/api/cart/${cartId}/pdf-data-en`
      : `/api/cart/${cartId}/pdf-data`;
    const response = await fetch(endpoint);
    if (!response.ok) throw new Error("Sepet verisi alınamadı.");
    const result = await response.json();
    if (!result.success) throw new Error(result.message);
    return result.data;
  };

  const cartData = await fetchCartData(activeCartId, language);
  cartData.sort((a, b) => a.PRODUCT_ID.localeCompare(b.PRODUCT_ID));

  // Örnekte, eğer ürün özelleştirilmişse CUSTOM_PRICE ve CUSTOM_DISCOUNT_RATE kullanılacak şekilde "effective" değerleri belirleyelim:
  const getEffectivePrice = (item) => {
    if (item.CUSTOM_CODE) {
      return item.CUSTOM_PRICE || item.PRICE;
    }
    return item.PRICE;
  };
  const getEffectiveDiscountRate = (item) => {
    if (item.CUSTOM_CODE) {
      return item.CUSTOM_DISCOUNT_RATE || item.DISCOUNT_RATE;
    }
    return item.DISCOUNT_RATE;
  };

  for (const item of cartData) {
    const imageUrl = `/resim/${item.PRODUCT_ID}.jpg`;
    let base64Image = "";
    try {
      base64Image = await fetchBlobImage(imageUrl);
    } catch (error) {
      console.error("Fotoğraf yüklenemedi:", error);
    }
    if (!base64Image) {
      try {
        base64Image = await fetchBlobImage("/resim/YOK.jpg");
      } catch (error) {
        console.error("Varsayılan fotoğraf yüklenemedi:", error);
      }
    }
    tableImages.push({ base64: base64Image, width: 30, height: 30 });
    
    const effectivePrice = item.EFFECTIVE_PRICE || item.PRICE || 0;
    const effectiveDiscountRate = item.EFFECTIVE_DISCOUNT_RATE !== undefined ? item.EFFECTIVE_DISCOUNT_RATE : (item.DISCOUNT_RATE || 0);
    const effectiveDiscPrice = effectivePrice * (1 - effectiveDiscountRate / 100);
    const effectiveTotal = item.EFFECTIVE_TOTAL || (item.QUANTITY * effectivePrice * (1 - effectiveDiscountRate / 100));
    const customValueControl = (item.CUSTOM_CODE || item.CUSTOM_NAME) || "";
    const customValue = (item.CUSTOM_CODE) || "-";
    const productCodeCell = customValueControl !== ""
      ? `${customValue}\n\n${language === "tr" ? "Referans Kod:" : "Reference Code:"} ${item.PRODUCT_ID}`
      : item.PRODUCT_ID;
    rows.push([
      "", // Fotoğraf alanı, didDrawCell ile eklenecek
      productCodeCell,
      replaceTurkishChars(item.CUSTOM_NAME ? item.CUSTOM_NAME : item.PRODUCT_NAME),
      item.QUANTITY.toString(),
      formatNumber(effectivePrice),
      `${effectiveDiscountRate}%`,
      formatNumber(effectiveDiscPrice),
      formatNumber(effectiveTotal),
    ]);
    totalQuantity += item.QUANTITY;
    totalAmount += effectiveTotal;
  }

  // jsPDF-AutoTable: Ürün tablosunu ekleyip sola hizalıyoruz.
  doc.autoTable({
    head: headers,
    body: rows,
    startY: tableStartY,
    margin: { top: tableStartY, bottom: footerHeight, left: margin },
    theme: "striped",
    styles: {
      cellPadding: 3,
      fontSize: 8,
      overflow: "linebreak",
      valign: "middle",
      halign: "center",
      minCellHeight: 32,
    },
    headStyles: {
      fillColor: [220, 220, 220],
      fontSize: 8,
      fontStyle: "bold",
      textColor: [102, 102, 102],
      minCellHeight: 10,
    },
    columnStyles: {
      0: { cellWidth: 30 },
      1: { cellWidth: 25, halign: 'left' },
      2: { cellWidth: 45, halign: 'left' },
      3: { cellWidth: 18 },
      4: { cellWidth: 25 },
      5: { cellWidth: 15 },
      6: { cellWidth: 25 },
      7: { cellWidth: 24 },
    },
    didDrawCell: (data) => {
	  if (data.column.index === 0 && data.row.section === "body") {
		const { base64 } = tableImages[data.row.index] || {};
		if (base64) {
		  const totalPages = doc.internal.getNumberOfPages();
		  const currentPage = doc.internal.getCurrentPageInfo().pageNumber;
		  const isLastPage = currentPage === totalPages;
		  const imageSize = isLastPage ? 27 : 30;
		  const x = data.cell.x + 2;
		  const y = data.cell.y + 2;
		  const adjustedHeight = data.cell.height - 4;
		  doc.addImage(base64, "JPEG", x, y, imageSize, adjustedHeight, null, "FAST");
		}
	  }
	},
    didDrawPage: (data) => {
      if (data.pageNumber > 1) {
        doc.autoTable.previous.finalY = tableStartY;
      }
    },
  });

  // finalY yalnızca bir kere hesaplanıyor:
  const finalY = doc.lastAutoTable ? doc.lastAutoTable.finalY + 5 : tableStartY + 5;

  // Toplam sayfa sayısını hesaplayıp, tüm sayfalara header ve footer ekleyelim.
  const totalPages = doc.internal.getNumberOfPages();
  for (let i = 1; i <= totalPages; i++) {
    doc.setPage(i);
    addHeader(i, totalPages);
    addFooter();
  }

  // Alt özet ekle: tablo sonundan 5mm aşağıda, sağa hizalı
  try {
    const summaryResponse = await fetch(`http://192.168.30.4:3000/cart-summary/${activeCartId}`);
    if (summaryResponse.ok) {
      const summaryData = await summaryResponse.json();
      if (summaryData.success) {
        const xRight = pageWidth - margin;
        doc.setFontSize(8);
        if (cartInfo.SALES_AREA.toLowerCase() === "yurtici") {
          const grossTotal = summaryData.grossTotal;
          const discountTotal = summaryData.discountTotal;
          const netTotal = summaryData.subtotal;
          const vatTotal = summaryData.vatTotal;
          const finalTotal = summaryData.total;
          if (language === "tr") {
            doc.text(`İskontosuz Toplam: ${formatNumber(grossTotal)}`, xRight - 3, finalY, { align: "right" });
            doc.text(`Toplam İndirim: ${formatNumber(discountTotal)}`, xRight - 3, finalY + 5, { align: "right" });
            doc.text(`KDV'siz Toplam: ${formatNumber(netTotal)}`, xRight - 3, finalY + 10, { align: "right" });
            doc.text(`KDV: ${formatNumber(vatTotal)}`, xRight - 3, finalY + 15, { align: "right" });
            doc.text(`Toplam: ${formatNumber(finalTotal)}`, xRight - 3, finalY + 20, { align: "right" });
          } else {
            doc.text(`Gross Total: ${formatNumber(grossTotal)}`, xRight - 3, finalY, { align: "right" });
            doc.text(`Total Discount: ${formatNumber(discountTotal)}`, xRight - 3, finalY + 5, { align: "right" });
            doc.text(`Net Total: ${formatNumber(netTotal)}`, xRight - 3, finalY + 10, { align: "right" });
            doc.text(`VAT: ${formatNumber(vatTotal)}`, xRight - 3, finalY + 15, { align: "right" });
            doc.text(`Total: ${formatNumber(finalTotal)}`, xRight - 3, finalY + 20, { align: "right" });
          }
        } else if (cartInfo.SALES_AREA.toLowerCase() === "yurtdisi") {
          const grossTotal = summaryData.grossTotal;
          const discountTotal = summaryData.discountTotal;
          const netTotal = summaryData.subtotal;
          const insurance = summaryData.insurance;
          const freight = summaryData.freight;
          const finalTotal = summaryData.total;
          if (language === "tr") {
            doc.text(`İskontosuz Toplam: ${formatNumber(grossTotal)}`, xRight - 3, finalY, { align: "right" });
            doc.text(`Toplam İndirim: ${formatNumber(discountTotal)}`, xRight - 3, finalY + 5, { align: "right" });
            doc.text(`Ara Toplam: ${formatNumber(netTotal)}`, xRight - 3, finalY + 10, { align: "right" });
            doc.text(`Sigorta: ${formatNumber(insurance)}`, xRight - 3, finalY + 15, { align: "right" });
            doc.text(`Navlun: ${formatNumber(freight)}`, xRight - 3, finalY + 20, { align: "right" });
            doc.text(`Toplam: ${formatNumber(finalTotal)}`, xRight - 3, finalY + 25, { align: "right" });
          } else {
            doc.text(`Gross Total: ${formatNumber(grossTotal)}`, xRight - 3, finalY, { align: "right" });
            doc.text(`Total Discount: ${formatNumber(discountTotal)}`, xRight - 3, finalY + 5, { align: "right" });
            doc.text(`Sub-total: ${formatNumber(netTotal)}`, xRight - 3, finalY + 10, { align: "right" });
            doc.text(`Insurance: ${formatNumber(insurance)}`, xRight - 3, finalY + 15, { align: "right" });
            doc.text(`Freight: ${formatNumber(freight)}`, xRight - 3, finalY + 20, { align: "right" });
            doc.text(`Total: ${formatNumber(finalTotal)}`, xRight - 3, finalY + 25, { align: "right" });
          }
        }
      }
    } else {
      console.error("Cart summary fetch failed");
    }
  } catch (error) {
    console.error("Sepet özeti eklenirken hata:", error);
  }

  // ---------- Sipariş Özel Şartları Bölümü ----------
  const specialConditionsY = doc.lastAutoTable ? doc.lastAutoTable.finalY + 10 : tableStartY + 10;
  doc.setFontSize(8);
  if (language === "tr") {
    doc.text("Özel Şartlar:", margin, specialConditionsY);
    doc.text("1. Estetik Decor, taşıma/teslimat sırasında oluşabilecek hasarları sigorta kapsamına almaz.", margin, specialConditionsY + 5);
    doc.text("2. Estetik Decor, gümrük, vergiler ve benzeri yerel masrafları karşılamaz.", margin, specialConditionsY + 10);
  } else {
    doc.text("Special Conditions:", margin, specialConditionsY);
    doc.text("1. Estetik Decor does not insure any damage during transport/delivery.", margin, specialConditionsY + 5);
    doc.text("2. Estetik Decor does not cover any local costs, such as customs, taxes, etc.", margin, specialConditionsY + 10);
  }

  // ---------- Ödeme Şartları ve Termin Süresi Bölümü ----------
  const extraInfoY = specialConditionsY + 20;
  let paymentTerms = "-";
  try {
    const ptResponse = await fetch(`/api/paymentterms`);
    if (ptResponse.ok) {
      const ptResult = await ptResponse.json();
      if (ptResult.success && ptResult.data && ptResult.data.length > 0) {
        const selectedPT = ptResult.data.find(pt => pt.KOD === cartInfo.PAYMENTTERMS);
        if (selectedPT) {
          paymentTerms = language === "tr" ? selectedPT.TR : selectedPT.EN;
        } else {
          paymentTerms = language === "tr" ? ptResult.data[0].TR : ptResult.data[0].EN;
        }
      }
    } else {
      console.error("Payment terms fetch failed");
    }
  } catch (e) {
    console.error("Payment terms fetch error:", e);
  }

  doc.setFontSize(8);
  if (language === "tr") {
    doc.text(`Ödeme Şartları: ${paymentTerms}`, margin, extraInfoY);
    doc.text(`Termin Süresi: ${cartInfo.DELIVERYTIME ? cartInfo.DELIVERYTIME + " hafta" : "-"}`, margin, extraInfoY + 5);
    doc.text(`Teslim Şekli: Fabrika Teslim`, margin, extraInfoY + 10);
  } else {
    doc.text(`Payment Terms: ${paymentTerms}`, margin, extraInfoY);
    doc.text(`Delivery Time: ${cartInfo.DELIVERYTIME ? cartInfo.DELIVERYTIME + " weeks" : "-"}`, margin, extraInfoY + 5);
    doc.text(`Delivery Method: Exworks`, margin, extraInfoY + 10);
  }

  // ---------- Banka Bilgileri Bölümü ----------
  const bankSectionY = extraInfoY + 15;
  let bankInfo = null;
  try {
    const bankResponse = await fetch(`/api/banks`);
    if (bankResponse.ok) {
      const bankResult = await bankResponse.json();
      if (bankResult.success && bankResult.data && bankResult.data.length > 0) {
        bankInfo = bankResult.data.find(b => b.KOD === cartInfo.BANK);
      }
    } else {
      console.error("Bank info fetch failed");
    }
  } catch (e) {
    console.error("Bank info fetch error:", e);
  }
  if (bankInfo) {
    doc.setDrawColor(0, 0, 0);
    doc.setLineWidth(0.5);
    doc.setLineDash([2, 2], 0);
    const bankRectX = margin;
    const bankRectY = bankSectionY;
    let currentY = bankRectY + 4;
    const lineSpacing = 5;
    doc.setFontSize(8);
    if (language === "tr") {
      const bankRectHeight = 5 * 5;
      const bankRectWidth = 80;
      doc.rect(bankRectX, bankRectY, bankRectWidth, bankRectHeight, 'D');
      doc.setLineDash([]);
      const text = "Banka Detaylarımız: ";
      const x = bankRectX + 2;
      const y = currentY;
      doc.text(text, x, y);
      const textWidth = doc.getTextWidth(text);
      doc.setLineWidth(0.5);
      doc.line(x, y + 0.5, x + textWidth, y + 0.5);
      currentY += lineSpacing;
      doc.text(`HESAP ADI: ${bankInfo.HESAPADI || '-'}`, bankRectX + 2, currentY);
      currentY += lineSpacing;
      doc.text(`BANKA ADI: ${bankInfo.BANKAADI || '-'}`, bankRectX + 2, currentY);
      currentY += lineSpacing;
      doc.text(`IBAN: ${bankInfo.IBAN || '-'}`, bankRectX + 2, currentY);
    } else {
      const bankRectHeight = 8 * 5;
      const bankRectWidth = 85;
      doc.rect(bankRectX, bankRectY, bankRectWidth, bankRectHeight, 'D');
      doc.setLineDash([]);
      const text = "Our Bank Details: ";
      const x = bankRectX + 2;
      const y = currentY;
      doc.text(text, x, y);
      const textWidth = doc.getTextWidth(text);
      doc.setLineWidth(0.5);
      doc.line(x, y + 0.5, x + textWidth, y + 0.5);
      currentY += lineSpacing;
      doc.text(`ACCOUNT NAME: ${bankInfo.HESAPADI || '-'}`, bankRectX + 2, currentY);
      currentY += lineSpacing;
      doc.text(`BANK NAME: ${bankInfo.BANKAADI || '-'}`, bankRectX + 2, currentY);
      currentY += lineSpacing;
      doc.text(`BRANCH: ${bankInfo.SUBEKODU} - ${bankInfo.SUBE || '-'}`, bankRectX + 2, currentY);
      currentY += lineSpacing;
      doc.text(`ACCOUNT NO: ${bankInfo.HESAP || '-'} - ${bankInfo.DOVIZ || '-'}`, bankRectX + 2, currentY);
      currentY += lineSpacing;
      doc.text(`IBAN: ${bankInfo.IBAN || '-'}`, bankRectX + 2, currentY);
      currentY += lineSpacing;
      doc.text(`SWIFTCODE: ${bankInfo.SWIFTCODE || '-'}`, bankRectX + 2, currentY);
    }
  }

  // PDF kaydet
  const customerName = cartInfo.CUSTOMER_NAME || "N/A";
  const fileName =
    language === "tr"
      ? `Teklif-Formu - ${customerName}.pdf`
      : `Quotation-Form - ${customerName}.pdf`;
  doc.save(fileName);
};

const generateConceptPDF = async (language = "tr") => {
  const { jsPDF } = window.jspdf;
  // A4 landscape: 297 x 210 mm
  const doc = new jsPDF({
    orientation: "landscape",
    unit: "mm",
    format: "a4",
  });

  const margin = 5;
  const pageWidth = 297; // Landscape A4 genişliği
  const pageHeight = 210; // Landscape A4 yüksekliği

  // ---------------- Yardımcı Fonksiyonlar ----------------
  const arrayBufferToBase64 = (buffer) => {
    let binary = "";
    const bytes = new Uint8Array(buffer);
    for (let i = 0; i < bytes.byteLength; i++) {
      binary += String.fromCharCode(bytes[i]);
    }
    return btoa(binary);
  };

  const formatNumber = (value) => {
    const parts = Number(value).toFixed(2).split(".");
    parts[0] = parts[0].replace(/\B(?=(\d{3})+(?!\d))/g, ".");
    return parts.join(",");
  };

  const loadFont = async () => {
    const fontUrl = "/fonts/Roboto-Regular.ttf";
    const fontResponse = await fetch(fontUrl);
    if (!fontResponse.ok) throw new Error("Font yüklenemedi.");
    const fontData = await fontResponse.arrayBuffer();
    const fontBase64 = arrayBufferToBase64(fontData);
    doc.addFileToVFS("Roboto-Regular.ttf", fontBase64);
    doc.addFont("Roboto-Regular.ttf", "Roboto", "normal");
    doc.setFont("Roboto");
  };
  await loadFont();

  const fetchBlobImage = async (url) => {
    const response = await fetch(url);
    if (!response.ok) throw new Error(`Fotoğraf yüklenemedi: ${url}`);
    const blob = await response.blob();
    return new Promise((resolve) => {
      const reader = new FileReader();
      reader.onload = () => resolve(reader.result);
      reader.readAsDataURL(blob);
    });
  };

  const replaceTurkishChars = (text) => {
    if (!text) return "";
    return text
      .replace(/Ş/g, "S")
      .replace(/ş/g, "s")
      .replace(/İ/g, "I")
      .replace(/ı/g, "i")
      .replace(/Ç/g, "C")
      .replace(/ç/g, "c")
      .replace(/Ü/g, "U")
      .replace(/ü/g, "u")
      .replace(/Ö/g, "O")
      .replace(/ö/g, "o")
      .replace(/Ğ/g, "G")
      .replace(/ğ/g, "g");
  };

  // ---------------- Sepet Bilgilerini Çekme ----------------
  const cartInfoResponse = await fetch(`http://192.168.30.4:3000/cart-info/${activeCartId}`);
  if (!cartInfoResponse.ok) throw new Error("Sepet bilgileri alınamadı.");
  const cartInfo = await cartInfoResponse.json();
  window.currentCartInfo = cartInfo;
  let globalCurrency = "TL";
  if (cartInfo.PRICE_TYPE === "1" || cartInfo.PRICE_TYPE === "2") globalCurrency = "TRY";
  if (cartInfo.PRICE_TYPE === "3" || cartInfo.PRICE_TYPE === "4") globalCurrency = "USD";
  if (cartInfo.PRICE_TYPE === "5" || cartInfo.PRICE_TYPE === "6") globalCurrency = "EUR";

  // ---------------- Header & Footer ----------------
  const addHeader = () => {
    const headerY = margin;
    const title = cartInfo.CUSTOMER_NAME || (language === "tr" ? "KONSEPT" : "CONCEPT");
    doc.setFontSize(18);
    doc.text(title, pageWidth / 2, headerY + 10, { align: "center" });
  };

  const addFooter = async () => {
    let logoBase64 = "";
    try {
      logoBase64 = await fetchBlobImage("/resim/EDLogo.png");
    } catch (error) {
      console.error("Logo yüklenemedi:", error);
      return;
    }
    const logoWidth = 35;
    const logoHeight = 7.5;
    const x = (pageWidth - logoWidth) / 2;
    const y = pageHeight - margin - logoHeight;
    doc.addImage(logoBase64, "PNG", x, y, logoWidth, logoHeight);
  };

  // ---------------- Ürün Verilerini Çekme ----------------
  const fetchCartData = async (cartId, language = "tr") => {
    const endpoint = language === "en"
      ? `/api/cart/${cartId}/pdf-data-en`
      : `/api/cart/${cartId}/pdf-data`;
    const response = await fetch(endpoint);
    if (!response.ok) throw new Error("Sepet verisi alınamadı.");
    const result = await response.json();
    if (!result.success) throw new Error(result.message);
    return result.data;
  };

  let cartData = await fetchCartData(activeCartId, language);

  // ---------------- Ürün Sıralaması (Global Toplamlar için) ----------------
  const groupOrder =
    language === "en"
      ? ["MAIN CONCEPT", "ADDITIONAL ITEMS", "ADDITIONAL ACCESSORIES", "ACCESSORIES", "SUPPLEMENTARY", "OTHER"]
      : ["ANA KONSEPT", "TAMAMLAYICI URUNLER", "TAMAMLAYICI AKSESUARLAR", "EK AKSESUARLAR", "EK URUNLER", "DİĞER"];
  const defaultGroup = language === "en" ? "OTHER" : "DİĞER";
  
  // Global toplam hesaplamalarında EK URUNLER (SUPPLEMENTARY) hariç tutuluyor.
  let totalQuantity = 0;
  let totalAmount = 0;
  cartData.forEach((item) => {
    const groupKey = (item.CONCEPTGRUP || defaultGroup).toUpperCase();
    if (groupKey !== (language === "en" ? "SUPPLEMENTARY" : "EK URUNLER")) {
      const quantity = Number(item.QUANTITY);
      const price = item.CUSTOM_CODE ? (item.CUSTOM_PRICE || 0) : (item.PRICE || 0);
      const discountRate = item.CUSTOM_CODE ? (item.CUSTOM_DISCOUNT_RATE || 0) : (item.DISCOUNT_RATE || 0);
      const discountedPrice = price * (1 - discountRate / 100);
      totalQuantity += quantity;
      totalAmount += discountedPrice * quantity;
    }
  });
    // Global döviz mapping
  const currencyMapping = {
    "1": "TRY",
    "2": "TL",
    "3": "USD",
    "4": "USD",
    "5": "EUR",
    "6": "EUR",
  };

  // ---------------- İlk Bölüm: Grid Görünümü (Fotoğraflar ve Bilgiler) ----------------
  const imgWidth = 40, imgHeight = 40;
  const infoHeight = 10;
  const cellHeight = imgHeight + infoHeight;
  const gapX = 5, gapY = 5;
  const gridStartY = margin + 20; // Grid başlangıç Y değeri
  const availableHeight = pageHeight - margin - 20 - 10;
  const maxRowsPerColumn = Math.floor(availableHeight / (cellHeight + gapY));
  const cellWidth = imgWidth;
  const availableWidth = pageWidth - 2 * margin;
  const maxColsPerPage = Math.floor(availableWidth / (cellWidth + gapX));

  // Grid alanını gruplara ayırıyoruz:
  // İlk grup: ANA KONSEPT ve TAMAMLAYICI URUNLER
  // İkinci grup: AKSESUARLAR, EK URUNLER ve varsa DİĞER
  const firstGroupNames = language === "en" 
    ? ["MAIN CONCEPT", "ADDITIONAL ITEMS", "ADDITIONAL ACCESSORIES"] 
    : ["ANA KONSEPT", "TAMAMLAYICI URUNLER", "TAMAMLAYICI AKSESUARLAR"];
  const secondGroupNames = language === "en" 
    ? ["ACCESSORIES", "SUPPLEMENTARY", "OTHER"] 
    : ["EK AKSESUARLAR", "EK URUNLER", "DİĞER"];

  const getGroupKey = (item) => (item.CONCEPTGRUP || defaultGroup).toUpperCase();
  const firstGroupItems = cartData.filter(item => firstGroupNames.includes(getGroupKey(item)));
  const secondGroupItems = cartData.filter(item => secondGroupNames.includes(getGroupKey(item)));

  // Her iki grup içerisindeki ürünleri, fiyata göre (azalan) sıralayalım.
  const sortByPriceDescending = (a, b) => {
    const priceA = Number(a.CUSTOM_CODE ? (a.CUSTOM_PRICE || 0) : (a.PRICE || 0));
    const priceB = Number(b.CUSTOM_CODE ? (b.CUSTOM_PRICE || 0) : (b.PRICE || 0));
    return priceB - priceA;
  };

  firstGroupItems.sort(sortByPriceDescending);
  secondGroupItems.sort(sortByPriceDescending);

  // Grid görünümünü oluşturmak için yardımcı fonksiyon
  const renderGridItems = async (items) => {
    let currentCol = 0, currentRow = 0;
    let gridX = margin, gridY = gridStartY;
    for (let i = 0; i < items.length; i++) {
      const item = items[i];
      let productImg = "";
      const imageUrl = `/resim/${item.PRODUCT_ID}.jpg`;
      try {
        productImg = await fetchBlobImage(imageUrl);
      } catch (error) {
        try {
          productImg = await fetchBlobImage("/resim/YOK.jpg");
        } catch (e) {
          console.error("Varsayılan fotoğraf alınamadı:", e);
        }
      }
      // Sayfa sınırını aşıyorsa yeni sayfaya geç
      if (gridY + cellHeight > pageHeight - margin) {
        await addFooter();
        doc.addPage();
        addHeader();
        currentCol = 0;
        currentRow = 0;
        gridX = margin;
        gridY = gridStartY;
      }
      if (productImg) {
        doc.addImage(productImg, "JPEG", gridX, gridY, imgWidth, imgHeight);
      }
      // Fotoğraf altındaki bilgi kısmı: Güncel düzenlemeniz uygulanıyor.
      const labels = language === "en"
        ? { model: "Model", code: "Code", size: "Size", inch: "Inch", price: "Price" }
        : { model: "Model", code: "Kod", size: "Ebat", inch: "İnç", price: "Fiyat" };
      const infoText = `${labels.model}: ${item.MODEL || "N/A"}\n${labels.code}: ${item.CUSTOM_CODE || item.PRODUCT_ID}\n${labels.size}: ${item.EBAT || "N/A"}\n${labels.inch}: ${item.EBATINCH || "N/A"}\n${labels.price}: ${formatNumber(item.PRICE) || "N/A"} ${currencyMapping[cartInfo.PRICE_TYPE] || "TRY"}`;
      doc.setFontSize(7);
      doc.text(infoText, gridX, gridY + imgHeight + 3);
      currentRow++;
      if (currentRow >= maxRowsPerColumn) {
        currentRow = 0;
        currentCol++;
        gridX = margin + currentCol * (cellWidth + gapX);
        gridY = gridStartY;
      } else {
        gridY += cellHeight + gapY;
      }
      if (gridX + cellWidth > pageWidth - margin) {
        await addFooter();
        doc.addPage();
        addHeader();
        currentCol = 0;
        currentRow = 0;
        gridX = margin;
        gridY = gridStartY;
      }
    }
  };

  // İlk gruptaki (ANA KONSEPT & TAMAMLAYICI URUNLER) ürünleri render et
  addHeader();
  await renderGridItems(firstGroupItems);
  await addFooter();

  // İlk grup bittikten sonra yeni sayfada ikinci grubu (AKSESUARLAR, EK URUNLER, DİĞER) render et
  if (secondGroupItems.length > 0) {
    doc.addPage();
    addHeader();
    await renderGridItems(secondGroupItems);
    await addFooter();
  }

  // ---------------- İkinci Bölüm: Ürün Listesi Tablosu (Fotoğraflar olmadan) ----------------
  doc.addPage();
  addHeader();

  // Tablo başlıkları ("No" sütunu ekleniyor)
  const headersTableArr =
    language === "tr"
      ? ["No", "Ürün Kodu", "Kategori", "Model", "Ölçü cm", "Ölçü inch", "Fiyat", "Miktar", "Tutar", "Döviz"]
      : ["No", "Product Code", "Category", "Model", "Size cm", "Size inch", "Price", "Quantity", "Amount", "Currency"];

  // Gruplama: Tüm ürünler grup anahtarına göre toplanıyor
  const groupedData = cartData.reduce((groups, item) => {
    const groupKeyCandidate = (item.CONCEPTGRUP || defaultGroup).toUpperCase();
    const groupKey = groupOrder.includes(groupKeyCandidate) ? groupKeyCandidate : defaultGroup;
    if (!groups[groupKey]) {
      groups[groupKey] = [];
    }
    groups[groupKey].push(item);
    return groups;
  }, {});

  // Ayırıyoruz: Ana gruplar (EK URUNLER hariç) ve EK URUNLER grubu
  const nonSuppOrderedGroups = groupOrder
  .filter((key) =>
    key !== (language === "en" ? "SUPPLEMENTARY" : "EK URUNLER") &&
    key !== (language === "en" ? "ACCESSORIES" : "EK AKSESUARLAR") &&
    groupedData[key]
  )
  .concat(
    Object.keys(groupedData).filter((key) =>
      key !== (language === "en" ? "SUPPLEMENTARY" : "EK URUNLER") &&
      key !== (language === "en" ? "ACCESSORIES" : "EK AKSESUARLAR") &&
      !groupOrder.includes(key)
    )
  );

  


  // Grup isimleri (dil parametresine göre)
  const mainConceptKey = language === "en" ? "MAIN CONCEPT" : "ANA KONSEPT";
  const additionalItemsKey = language === "en" ? "ADDITIONAL ITEMS" : "TAMAMLAYICI URUNLER";
  const additionalItemsAksKey = language === "en" ? "ADDITIONAL ACCESSORIES" : "TAMAMLAYICI AKSESUARLAR";
  const accessoriesKey = language === "en" ? "ACCESSORIES" : "EK AKSESUARLAR";
  const supplementaryKey = language === "en" ? "SUPPLEMENTARY" : "EK URUNLER";

  let tableRows = [];
  let mainConceptTotals = { qty: 0, amount: 0 };
  let additionalTotals = { qty: 0, amount: 0 };
  let additionalAksTotals = { qty: 0, amount: 0 };

  // Ana gruplar için tablo satırlarını oluşturuyoruz (EK URUNLER hariç)
  nonSuppOrderedGroups.forEach((groupKey, idx) => {
    let groupItems = groupedData[groupKey];

    // Kategori toplamlarını hesaplayalım
    const categoryTotals = {};
    groupItems.forEach(item => {
      const cat = item.BASAMAK4 || "";
      const price = item.CUSTOM_CODE ? (item.CUSTOM_PRICE || 0) : (item.PRICE || 0);
      const discountRate = item.CUSTOM_CODE ? (item.CUSTOM_DISCOUNT_RATE || 0) : (item.DISCOUNT_RATE || 0);
      const discountedPrice = price * (1 - discountRate / 100);
      const amount = discountedPrice * Number(item.QUANTITY);
      if (!categoryTotals[cat]) categoryTotals[cat] = 0;
      categoryTotals[cat] += amount;
    });

    // Grup içindeki ürünleri önce kategori toplamı, sonra ürün tutarına göre azalan sıralıyoruz
    groupItems.sort((a, b) => {
      const catA = a.BASAMAK4 || "";
      const catB = b.BASAMAK4 || "";
      const totalA = categoryTotals[catA] || 0;
      const totalB = categoryTotals[catB] || 0;
      if (totalB !== totalA) return totalB - totalA;
      const priceA = a.CUSTOM_CODE ? (a.CUSTOM_PRICE || 0) : (a.PRICE || 0);
      const discountRateA = a.CUSTOM_CODE ? (a.CUSTOM_DISCOUNT_RATE || 0) : (a.DISCOUNT_RATE || 0);
      const amountA = priceA * (1 - discountRateA / 100) * Number(a.QUANTITY);
      const priceB = b.CUSTOM_CODE ? (b.CUSTOM_PRICE || 0) : (b.PRICE || 0);
      const discountRateB = b.CUSTOM_CODE ? (b.CUSTOM_DISCOUNT_RATE || 0) : (b.DISCOUNT_RATE || 0);
      const amountB = priceB * (1 - discountRateB / 100) * Number(b.QUANTITY);
      return amountB - amountA;
    });

    // Grup başlığı
    tableRows.push([
      {
        content: groupKey,
        colSpan: 10,
        styles: {
          halign: "left",
          fillColor: [230, 230, 230],
          fontStyle: "bold",
          overflow: "linebreak",
        },
      },
    ]);
    // Sütun başlıkları
    tableRows.push(headersTableArr);
    
    let rowNum = 0;
    let groupTotals = { qty: 0, amount: 0 };
    groupItems.forEach((item) => {
      rowNum++;
      const productCode = item.CUSTOM_CODE
        ? `${item.CUSTOM_CODE}\nReferans Kod: ${item.PRODUCT_ID}`
        : item.PRODUCT_ID;
      const category = replaceTurkishChars(item.BASAMAK4 || "");
      const model = replaceTurkishChars(item.MODEL || "");
      const sizeCm = replaceTurkishChars(item.EBAT || "");
      const sizeInch = replaceTurkishChars(item.EBATINCH || "");
      const price = item.CUSTOM_CODE ? (item.CUSTOM_PRICE || 0) : (item.PRICE || 0);
      const quantity = Number(item.QUANTITY);
      const discountRate = item.CUSTOM_CODE ? (item.CUSTOM_DISCOUNT_RATE || 0) : (item.DISCOUNT_RATE || 0);
      const discountedPrice = price * (1 - discountRate / 100);
      const amount = discountedPrice * quantity;
      groupTotals.qty += quantity;
      groupTotals.amount += amount;
      tableRows.push([
        rowNum.toString(),
        productCode,
        category,
        model,
        sizeCm,
        sizeInch,
        formatNumber(price),
        quantity.toString(),
        formatNumber(amount),
        currencyMapping[cartInfo.PRICE_TYPE] || "TRY",
      ]);
    });

    // Grup alt toplam satırı
    tableRows.push([
      {
        content:
          language === "en"
            ? `Sub Total (${groupKey})`
            : `Alt Toplam (${groupKey})`,
        colSpan: 7,
        styles: {
          fontStyle: "bold",
          fillColor: [230, 230, 230],
          overflow: "linebreak",
        },
      },
      { content: groupTotals.qty.toString(), styles: { fillColor: [230, 230, 230] } },
      { content: formatNumber(groupTotals.amount), styles: { fillColor: [230, 230, 230] } },
      { content: currencyMapping[cartInfo.PRICE_TYPE] || "TRY", styles: { fillColor: [230, 230, 230] } },
    ]);

    if (groupKey === mainConceptKey) {
	  mainConceptTotals = groupTotals;
	} else if (groupKey === additionalItemsKey) {
	  additionalTotals = groupTotals;
	  const nextGroup = nonSuppOrderedGroups[idx + 1];
	  if (nextGroup && nextGroup === accessoriesKey  || nextGroup === supplementaryKey) {
		const combinedQty = mainConceptTotals.qty + additionalTotals.qty;
		const combinedAmount = mainConceptTotals.amount + additionalTotals.amount;
		tableRows.push([
		  {
			content:
			  language === "en"
				? `Sub Total (MAIN CONCEPT + ADDITIONAL ITEMS)`
				: `Alt Toplam (ANA KONSEPT + TAMAMLAYICI URUNLER)`,
			colSpan: 7,
			styles: { fontStyle: "bold", fillColor: [207, 207, 207], overflow: "linebreak" },
		  },
		  { content: combinedQty.toString(), styles: { fillColor: [207, 207, 207] } },
		  { content: formatNumber(combinedAmount), styles: { fillColor: [207, 207, 207] } },
		  { content: currencyMapping[cartInfo.PRICE_TYPE] || "TRY", styles: { fillColor: [207, 207, 207] } },
		]);
	  }
	} else if (groupKey === additionalItemsAksKey && (nextGroup === accessoriesKey || nextGroup === supplementaryKey) ) {
	  additionalAksTotals = groupTotals;
	  // Artık sonraki grup kontrolüne gerek kalmadan alt toplam ekleniyor:
	  
	  const combinedQty = mainConceptTotals.qty + additionalTotals.qty + additionalAksTotals.qty;
	  const combinedAmount = mainConceptTotals.amount + additionalTotals.amount + additionalAksTotals.amount;
	  tableRows.push([
		{
		  content:
			language === "en"
			  ? `Sub Total (MAIN CONCEPT + ADDITIONAL ITEMS + ADDITIONAL ACCESSORIES)`
			  : `Alt Toplam (ANA KONSEPT + TAMAMLAYICI URUNLER + TAMAMLAYICI AKSESUARLAR)`,
		  colSpan: 7,
		  styles: { fontStyle: "bold", fillColor: [207, 207, 207], overflow: "linebreak" },
		},
		{ content: combinedQty.toString(), styles: { fillColor: [207, 207, 207] } },
		{ content: formatNumber(combinedAmount), styles: { fillColor: [207, 207, 207] } },
		{ content: currencyMapping[cartInfo.PRICE_TYPE] || "TRY", styles: { fillColor: [207, 207, 207] } },
	  ]);
	  
	}

	if (groupKey !== accessoriesKey) {
	  tableRows.push(
		Array.from({ length: 10 }, () => ({
		  content: "",
		  styles: { fillColor: [255, 255, 255] },
		}))
	  );
	}

  });

  // Ana tablo AutoTable
  doc.autoTable({
    head: false,
    body: tableRows,
    foot: [
      [{
          content:
            language === "en"
              ? `Total `
              : `Toplam `,
          colSpan: 7,
          styles: { fontStyle: "bold", fillColor: [207, 207, 207], overflow: "linebreak" },
        },
        { content: totalQuantity.toString(), styles: { halign: "right" } },
        { content: formatNumber(totalAmount), styles: { halign: "right" } },
        { content: globalCurrency.toString(), styles: { halign: "center" } },
      ],
    ],
    footStyles: {
      fillColor: [207, 207, 207],
      fontStyle: "bold",
      textColor: [0, 0, 0],
    },
    showFoot: "lastPage",
    startY: margin + 20,
    margin: { left: margin, right: margin },
    theme: "striped",
    styles: {
      cellPadding: 2,
      fontSize: 8,
      overflow: "ellipsize",
      valign: "middle",
      halign: "left",
      minCellHeight: 6,
    },
    headStyles: {
      fillColor: [220, 220, 220],
      fontSize: 8,
      fontStyle: "bold",
      textColor: [102, 102, 102],
      minCellHeight: 6,
    },
    columnStyles: {
      0: { cellWidth: 10, halign: "center" },
      1: { cellWidth: 30, halign: "left" },
      2: { cellWidth: 50, halign: "left" },
      3: { cellWidth: 40, halign: "left" },
      4: { cellWidth: 30, halign: "left" },
      5: { cellWidth: 30, halign: "left" },
      6: { cellWidth: 25, halign: "right" },
      7: { cellWidth: 25, halign: "right" },
      8: { cellWidth: 25, halign: "right" },
      9: { cellWidth: 20, halign: "center" },
    },
    didDrawPage: (data) => {
      if (data.pageNumber > 1) {
        doc.autoTable.previous.finalY = margin + 10;
      }
    },
  });
  
  // ---------------- EK URUNLER Grubunu Aynı Sayfada, Boş Bir Satır Sonrası Ekle ----------------
  if (groupedData[supplementaryKey] && groupedData[supplementaryKey].length > 0) {
    // Yeni sayfa eklemiyoruz; mevcut sayfadaki autotable'ın finalY'sinden 6 mm aşağıdan başlıyoruz.
    const startYSupp = doc.lastAutoTable.finalY + 6;
    let suppItems = groupedData[supplementaryKey];

    // Kategori toplamlarını hesaplayalım
    const suppCategoryTotals = {};
    suppItems.forEach(item => {
      const cat = item.BASAMAK4 || "";
      const price = item.CUSTOM_CODE ? (item.CUSTOM_PRICE || 0) : (item.PRICE || 0);
      const discountRate = item.CUSTOM_CODE ? (item.CUSTOM_DISCOUNT_RATE || 0) : (item.DISCOUNT_RATE || 0);
      const discountedPrice = price * (1 - discountRate / 100);
      const amount = discountedPrice * Number(item.QUANTITY);
      if (!suppCategoryTotals[cat]) suppCategoryTotals[cat] = 0;
      suppCategoryTotals[cat] += amount;
    });

    // EK URUNLER grubunu sıralıyoruz (önce kategori toplamı, sonra ürün tutarı azalan)
    suppItems.sort((a, b) => {
      const catA = a.BASAMAK4 || "";
      const catB = b.BASAMAK4 || "";
      const totalA = suppCategoryTotals[catA] || 0;
      const totalB = suppCategoryTotals[catB] || 0;
      if (totalB !== totalA) return totalB - totalA;
      const priceA = a.CUSTOM_CODE ? (a.CUSTOM_PRICE || 0) : (a.PRICE || 0);
      const discountRateA = a.CUSTOM_CODE ? (a.CUSTOM_DISCOUNT_RATE || 0) : (a.DISCOUNT_RATE || 0);
      const amountA = priceA * (1 - discountRateA / 100) * Number(a.QUANTITY);
      const priceB = b.CUSTOM_CODE ? (b.CUSTOM_PRICE || 0) : (b.PRICE || 0);
      const discountRateB = b.CUSTOM_CODE ? (b.CUSTOM_DISCOUNT_RATE || 0) : (b.DISCOUNT_RATE || 0);
      const amountB = priceB * (1 - discountRateB / 100) * Number(b.QUANTITY);
      return amountB - amountA;
    });

    // EK URUNLER için tablo satırlarını oluşturalım
    let suppTableRows = [];
    suppTableRows.push([
      {
        content: supplementaryKey,
        colSpan: 10,
        styles: {
          halign: "left",
          fillColor: [230, 230, 230],
          fontStyle: "bold",
          overflow: "linebreak",
        },
      },
    ]);
    suppTableRows.push(headersTableArr);
    let rowNum = 0;
    let suppTotals = { qty: 0, amount: 0 };
    suppItems.forEach((item) => {
      rowNum++;
      const productCode = item.CUSTOM_CODE
        ? `${item.CUSTOM_CODE}\nReferans Kod: ${item.PRODUCT_ID}`
        : item.PRODUCT_ID;
      const category = replaceTurkishChars(item.BASAMAK4 || "");
      const model = replaceTurkishChars(item.MODEL || "");
      const sizeCm = replaceTurkishChars(item.EBAT || "");
      const sizeInch = replaceTurkishChars(item.EBATINCH || "");
      const price = item.CUSTOM_CODE ? (item.CUSTOM_PRICE || 0) : (item.PRICE || 0);
      const quantity = Number(item.QUANTITY);
      const discountRate = item.CUSTOM_CODE ? (item.CUSTOM_DISCOUNT_RATE || 0) : (item.DISCOUNT_RATE || 0);
      const discountedPrice = price * (1 - discountRate / 100);
      const amount = discountedPrice * quantity;
      suppTotals.qty += quantity;
      suppTotals.amount += amount;
      suppTableRows.push([
        rowNum.toString(),
        productCode,
        replaceTurkishChars(item.BASAMAK4 || ""),
        replaceTurkishChars(item.MODEL || ""),
        replaceTurkishChars(item.EBAT || ""),
        replaceTurkishChars(item.EBATINCH || ""),
        formatNumber(price),
        quantity.toString(),
        formatNumber(amount),
        currencyMapping[cartInfo.PRICE_TYPE] || "TRY",
      ]);
    });
    suppTableRows.push([
      {
        content:
          language === "en"
            ? `Sub Total (${supplementaryKey})`
            : `Alt Toplam (${supplementaryKey})`,
        colSpan: 7,
        styles: {
          fontStyle: "bold",
          fillColor: [230, 230, 230],
          overflow: "linebreak",
        },
      },
      { content: suppTotals.qty.toString(), styles: { fillColor: [230, 230, 230] } },
      { content: formatNumber(suppTotals.amount), styles: { fillColor: [230, 230, 230] } },
      { content: currencyMapping[cartInfo.PRICE_TYPE] || "TRY", styles: { fillColor: [230, 230, 230] } },
    ]);

    doc.autoTable({
      head: false,
      body: suppTableRows,
      startY: startYSupp,
      margin: { left: margin, right: margin },
      theme: "striped",
      styles: {
        cellPadding: 2,
        fontSize: 8,
        overflow: "ellipsize",
        valign: "middle",
        halign: "left",
        minCellHeight: 6,
      },
      headStyles: {
        fillColor: [220, 220, 220],
        fontSize: 8,
        fontStyle: "bold",
        textColor: [102, 102, 102],
        minCellHeight: 6,
      },
      columnStyles: {
        0: { cellWidth: 10, halign: "center" },
        1: { cellWidth: 30, halign: "left" },
        2: { cellWidth: 50, halign: "left" },
        3: { cellWidth: 40, halign: "left" },
        4: { cellWidth: 30, halign: "left" },
        5: { cellWidth: 30, halign: "left" },
        6: { cellWidth: 25, halign: "right" },
        7: { cellWidth: 25, halign: "right" },
        8: { cellWidth: 25, halign: "right" },
        9: { cellWidth: 20, halign: "center" },
      },
      didDrawPage: (data) => {
        if (data.pageNumber > 1) {
          doc.autoTable.previous.finalY = margin + 10;
        }
      },
    });
  }
  
  await addFooter();

  const fileName =
    language === "tr"
      ? `KONSEPT-Formu - ${cartInfo.CUSTOMER_NAME || "N/A"}.pdf`
      : `CONCEPT-Form - ${cartInfo.CUSTOMER_NAME || "N/A"}.pdf`;
  doc.save(fileName);
};



// Yardımcı Fonksiyon: ArrayBuffer'ı Base64'e dönüştür
const arrayBufferToBase64 = (buffer) => {
    let binary = "";
    const bytes = new Uint8Array(buffer);
    const len = bytes.byteLength;
    for (let i = 0; i < len; i++) {
        binary += String.fromCharCode(bytes[i]);
    }
    return btoa(binary);
};

	//pdf fetchcartdata
	const fetchCartData = async (cartId, language = "tr") => {
		const response = await fetch(`/api/cart/${cartId}/pdf-data?lang=${language}`);
		if (!response.ok) throw new Error("Sepet verisi alınamadı.");
		const result = await response.json();
		if (!result.success) throw new Error(result.message);
		return result.data;
	};


	// Görsel Yükleme Fonksiyonu
	const loadImage = (url) => {
		return new Promise((resolve, reject) => {
			const img = new Image();
			img.crossOrigin = "Anonymous"; // Farklı kaynaklardan görsel alımı için
			img.onload = () => {
				const canvas = document.createElement("canvas");
				canvas.width = img.width;
				canvas.height = img.height;
				const ctx = canvas.getContext("2d");
				ctx.drawImage(img, 0, 0);
				const dataUrl = canvas.toDataURL("image/jpeg");
				resolve(dataUrl);
			};
			img.onerror = (err) => reject(err);
			img.src = url;
		});
	};


//Sepet içeriğini göstermek için kullanılan fonksiyon
//Sepet içeriğini göstermek için kullanılan fonksiyon
const showCartContents = async () => {
    const modalCartContent = document.getElementById('modalCartContent');
    const cartNameDisplay = document.getElementById('cartNameDisplay');
    const customerTypeDisplay = document.getElementById('customerTypeDisplay');
    const salesAreaDisplay = document.getElementById('salesAreaDisplay');
    const priceTypeDisplay = document.getElementById('priceTypeDisplay');
    const vatIncludedDisplay = document.getElementById('vatIncludedDisplay');
    const discountRateDisplay = document.getElementById('discountRateDisplay');
    const paymentTermsDisplay = document.getElementById('paymentTermsDisplay');
    const bankDisplay = document.getElementById('bankDisplay');

    // DOM öğelerinin varlığını kontrol et
    if (!modalCartContent || !cartNameDisplay || !customerTypeDisplay || !salesAreaDisplay ||
        !priceTypeDisplay || !vatIncludedDisplay || !discountRateDisplay || !paymentTermsDisplay || !bankDisplay  || !ckartSelect) {
        console.error('Gerekli DOM öğelerinden biri eksik. Lütfen kontrol edin.');
        return;
    }

    try {
        if (!activeCartId) throw new Error('Aktif bir sepet bulunamadı.');
        
        //banner alanı tanımı
        const conceptBannerContainer = document.getElementById("conceptBannerContainer");
        const conceptBannerImg = document.getElementById("conceptBannerImg");

        // Sepet bilgilerini al
        const cartInfoResponse = await fetch(`http://192.168.30.4:3000/cart-info/${activeCartId}`);
        if (!cartInfoResponse.ok) throw new Error('Sepet bilgileri alınamadı.');
        const cartInfo = await cartInfoResponse.json();
        window.currentCartInfo = cartInfo; // Global değişken

        // 📌 Eğer **Sepet Konseptse**, banner alanını göster
        if (cartInfo.CONCEPT === 1) {
            conceptBannerContainer.style.display = "block"; // 📌 Banner alanını göster

            // Eğer CONCEPT_BANNER varsa, ilgili görseli kullan; yoksa varsayılan banner
            conceptBannerImg.src = cartInfo.CONCEPT_BANNER ? cartInfo.CONCEPT_BANNER : '/resim/YOK.jpg';
        } else {
            conceptBannerContainer.style.display = "none"; // 📌 Konsept değilse bannerı gizle
        }

        const showCategoryColumn = cartInfo.CONCEPT === 1; // **Kategori sütunu görünsün mü?**
        // Sepet bilgilerini aldıktan sonra (örneğin cartInfo nesnesi mevcut)
        if (cartInfo.CONCEPT === 1) {
            // Konsept sepet ise, "Konsept Alanı" bölümünü göster
            const conceptDiv = document.querySelector('#conceptarea').closest('.col-md-2');
            if (conceptDiv) {
                conceptDiv.style.display = "block";
            }
            // Ayrıca, isterseniz conceptarea span'ını da doldurabilirsiniz:
            document.getElementById("conceptarea").textContent = cartInfo.CONCEPT_AREA || ""; // eğer konsept alanı verisi varsa
        } else {
            // Konsept değilse, ilgili alanı gizle
            const conceptDiv = document.querySelector('#conceptarea').closest('.col-md-2');
            if (conceptDiv) {
                conceptDiv.style.display = "none";
            }
        }

        // ––– Alanları DOM’a yükle –––
        
        // Müşteri Adı (varsa kullanıcı değiştirip update edebilsin)
        cartNameDisplay.innerHTML = `
            <input type="text" id="customerNameInput" value="${cartInfo.CUSTOMER_NAME || ''}" placeholder="Müşteri Adı" 
              onblur="updateCustomerName(this.value)" style="width: 100%; padding: 5px;" />
        `;
        
        // **Müşteri Tipi** – Dropdown; onchange'da updateCartCustomerType() çağrılır
        customerTypeDisplay.innerHTML = `
            <select id="customerTypeSelector" class="form-control" onchange="updateCartCustomerType(this.value)">
                <option value="perakende" ${cartInfo.CUSTOMER_TYPE === 'perakende' ? 'selected' : ''}>Perakende</option>
                <option value="kurumsal" ${cartInfo.CUSTOMER_TYPE === 'kurumsal' ? 'selected' : ''}>Kurumsal</option>
                <option value="toptan" ${cartInfo.CUSTOMER_TYPE === 'toptan' ? 'selected' : ''}>Toptan</option>
            </select>
        `;
        
        // **Satış Bölgesi** – Dropdown; onchange'da updateCartSalesArea() çağrılır
        salesAreaDisplay.innerHTML = `
            <select id="salesAreaSelector" class="form-control" onchange="updateCartSalesArea(this.value)">
                <option value="yurtici" ${cartInfo.SALES_AREA === 'yurtici' ? 'selected' : ''}>Yurtiçi</option>
                <option value="yurtdisi" ${cartInfo.SALES_AREA === 'yurtdisi' ? 'selected' : ''}>Yurtdışı</option>
            </select>
        `;
        
        // **Fiyat Tipi** – Dropdown; seçenekler müşteri tipine göre ayarlanıyor
        priceTypeDisplay.innerHTML = `
            <select id="priceTypeSelector" class="form-control" onchange="updateCartPriceType(this.value)"></select>
        `;
        updateCartPriceTypeOptions(cartInfo.CUSTOMER_TYPE, cartInfo.PRICE_TYPE);
        
        // **KDV Dahil/Hariç** – Dropdown; müşteri tipine göre otomatik (Perakende: Dahil, Toptan: Hariç, Kurumsal: kullanıcı seçebilir)
        vatIncludedDisplay.innerHTML = `
            <select id="vatIncludedSelector" class="form-control" onchange="updateCartVatIncluded(this.value)"></select>
        `;
        updateCartVatIncludedOptions(cartInfo.CUSTOMER_TYPE, cartInfo.VATINCLUEDED);
        
        // **İndirim Oranı**
        discountRateDisplay.innerHTML = `
            <input type="number" id="cartDiscountRate" value="${cartInfo.DISCOUNT_RATE || 0}" min="0" max="100" step="5"
              onchange="updateCartDiscountRate(this.value)" style="width: 60px; text-align: center;" />%
        `;
        // Yeni: Ödeme Şartları dropdown'unu oluştur
        paymentTermsDisplay.innerHTML = `<select id="paymentTermsSelector" class="form-control"></select>`;
        loadPaymentTermsOptions(cartInfo.PAYMENTTERMS);
        // Yeni: Teslim Süresi dropdown'unu oluştur
        deliveryTimeDisplay.innerHTML = `<select id="deliveryTimeSelector" class="form-control"></select>`;
        loadDeliveryTimeOptions(cartInfo.DELIVERYTIME);
        // Yeni: Teslim Süresi dropdown'unu oluştur
        conceptarea.innerHTML = `<select id="conceptareaSelector" class="form-control"></select>`;
        conceptareaOptions(cartInfo.CONCEPT_AREA);
        // Yeni: Banka select alanı
        bankDisplay.innerHTML = `<select id="bankSelector" class="form-control" onchange="updateCartBank(this.value)"></select>`;
        loadBankOptions(cartInfo.BANK);

        // –––––––––––––––––––––––––––––––––––––––––––––––––––
        // Sepet Ürünleri İçeriği (mevcut kodunuzla devam ediyor)
        // –––––––––––––––––––––––––––––––––––––––––––––––––––
        
        // 📌 **Konsept Sepet için Banner Seçim Butonu Ekle**
        if (cartInfo.CONCEPT === 1) { // **Sepet Konseptse butonu ekle**
            document.getElementById("selectBannerButtonContainer").innerHTML = `
                <button class="btn btn-primary btn-sm" onclick="openBannerSelection(${activeCartId})">
                    📷 Banner Seç
                </button>
            `;
        } else {
            document.getElementById("selectBannerButtonContainer").innerHTML = ""; // **Konsept değilse butonu kaldır**
        }

        // Sepet içeriğini al
        const response = await fetch(`http://192.168.30.4:3000/get-cart/${activeCartId}`);
        if (!response.ok) throw new Error('Sepet içeriği alınamadı.');

        const { items } = await response.json();

        if (!items || items.length === 0) {
            modalCartContent.innerHTML = `
                <p class="text-center text-muted">Sepetiniz boş.</p>
            `;
            $('#cartModal').modal('show');
            return;
        }
        // Eğer sepet konseptse, ürünleri kategori sırasına göre sırala
        if (cartInfo.CONCEPT === 1) {
            const categoryOrder = [
                "ANA KONSEPT",
                "TAMAMLAYICI URUNLER",
                "TAMAMLAYICI AKSESUARLAR",
                "EK AKSESUARLAR",
                "EK URUNLER",
                "DIGER"
            ];
            // Yardımcı fonksiyon: Ürün için kategori belirleme
            const getItemCategory = (item) => {
                if (item.MAINCONCEPT) return "ANA KONSEPT";
                if (item.ADDITIONAL) return "TAMAMLAYICI URUNLER";
                if (item.ADDITIONALAKS) return "TAMAMLAYICI AKSESUARLAR";
                if (item.ACCESSORIES) return "EK AKSESUARLAR";
                if (item.SUPPLEMENTARY) return "EK URUNLER";
                return "DIGER";
            };

            items.sort((a, b) => {
                const catA = getItemCategory(a);
                const catB = getItemCategory(b);
                return categoryOrder.indexOf(catA) - categoryOrder.indexOf(catB);
            });
        }
        const formatCurrency = (value, priceType) => {
            const currencyMap = {
                1: 'TRY',
                2: 'TRY',
                3: 'USD',
                4: 'USD',
                5: 'EUR',
                6: 'EUR'
            };
            const currency = currencyMap[priceType] || 'TRY';
            return new Intl.NumberFormat('tr-TR', {
                style: 'currency',
                currency
            }).format(value);
        };

        const getImageUrl = (productId) => {
            const basePath = '/resim';
            return `${basePath}/${productId}.jpg`;
        };

        let totalQuantity = 0;
        let totalAmount = 0;
        let totalKdvsiz = 0;
        let totalKdv = 0;
        const rowsHtml = items.map(item => {
            const imageUrl = getImageUrl(item.PRODUCT_ID);
            const fallbackImage = '/resim/YOK.jpg';

            // Özelleştirilmiş ürün kontrolü
            const isCustomized = !!(item.CUSTOM_CODE || item.CUSTOM_NAME);
            const rowClass = isCustomized ? 'customized-row' : ''; // Eğer özelleştirilmişse özel CSS sınıfı
            const customPriceInputId = `customPrice-${item.cartItemId}`;

            // Toplam ve indirimli fiyat hesaplama
            const price = item.CUSTOM_PRICE || item.PRICE; // Öncelikli olarak özelleştirilmiş fiyatı kullan
            const discountRate = item.DISCOUNT_RATE || 0;
            const discountedPrice = item.DISCOUNTED_PRICE; // İndirimli fiyat
            const kdvsizTutar = item.AMOUNT_NOTINCLUDED_VAT; // Kdvsiz Tutar
            const kdvTutari = item.VAT_TOTAL; // KDV Tutarı
            const total = item.TOTAL_AMOUNT; // Tutar

            totalQuantity += item.QUANTITY;
            totalKdvsiz += kdvsizTutar;
            totalKdv += kdvTutari;
            totalAmount += total;

            // Fiyat değişim fonksiyonunu global hale getirin
            window.handleCustomPriceChange = async (cartItemId, isCustomized = false) => {
                const customPriceElement = document.getElementById(`customPrice-${cartItemId}`);
                const discountRateElement = document.getElementById(`discountRate-${cartItemId}`);
                const quantityElement = document.getElementById(`quantity-${cartItemId}`);

                // Fiyat ve indirim oranını al
                const customPrice = isCustomized
                    ? parseFloat(customPriceElement?.value || 0) // Özelleştirilmiş fiyat
                    : parseFloat(customPriceElement?.getAttribute("data-original-price") || 0); // Orijinal fiyat
                const discountRate = parseFloat(discountRateElement?.value || 0);
                const quantity = parseFloat(quantityElement?.value || 1);

                // Yeni indirimli fiyat ve toplam tutarı hesapla
                const discountedPrice = customPrice * (1 - discountRate / 100);
                const total = discountedPrice * quantity;

                // DOM güncellemesi: Satırdaki indirimli fiyat ve toplamı göster
                document.getElementById(`discountedPrice-${cartItemId}`).innerText = formatCurrency(discountedPrice, cartInfo.PRICE_TYPE);
                document.getElementById(`totalAmount-${cartItemId}`).innerText = formatCurrency(total, cartInfo.PRICE_TYPE);

                try {
                    // 1. Adım: Ürünün özelleştirilmiş/normal verilerini güncelleyen endpoint çağrısı
                    const endpoint = isCustomized
                        ? `/api/cart-items/${cartItemId}/update-custom-data`
                        : `/api/cart-items/${cartItemId}/update-original-data`;
                    const body = isCustomized
                        ? { customPrice, discountRate }
                        : { discountRate };
                    const response = await fetch(endpoint, {
                        method: "POST",
                        headers: { "Content-Type": "application/json" },
                        body: JSON.stringify(body)
                    });
                    const result = await response.json();
                    if (!result.success) {
                        console.error("Güncelleme başarısız:", result.message);
                        alert(result.message);
                        return;
                    }

                    // 2. Adım: Satırdaki VAT hesaplamalarını (Kdvsiz Tutar, KDV Tutarı, Toplam Tutar vb.) yeniden hesaplayan endpoint'i çağırın.
                    const vatResponse = await fetch(`http://192.168.30.4:3000/cart/item/${cartItemId}/update-discount-vat`, {
                        method: "PUT",
                        headers: { "Content-Type": "application/json" },
                        body: JSON.stringify({ discountRate })
                    });
                    if (!vatResponse.ok) {
                        const vatError = await vatResponse.json();
                        alert(`KDV hesaplamaları güncellenemedi: ${vatError.message}`);
                        return;
                    }

                    // 3. Adım: Güncel sepet içeriğini yeniden yükle
                    await showCartContents();
                    updateCartFreightInsurance();
                } catch (error) {
                    console.error("Güncelleme sırasında hata oluştu:", error);
                    alert("Güncelleme sırasında bir hata oluştu.");
                }
            };

            return `
                <tr class="${rowClass}">
                    <td>
                        <img src="${imageUrl}" onerror="this.onerror=null;this.src='${fallbackImage}';" alt="Ürün Fotoğrafı" style="width: 50px; height: 50px; object-fit: cover;">
                    </td>
                    <td>
                        ${isCustomized ? '<span style="font-weight: bold; color: #000;">Referans Kod:</span> ' : ''}
                        ${item.PRODUCT_ID}<br><br>
                        <span style="font-weight: bold; color: #0d285a;">${item.CUSTOM_CODE || ''}</span>
                    </td>
                    <td>${item.PRODUCT_NAME}<br><br><span style="font-weight: bold; color: #0d285a;">${item.CUSTOM_NAME || ''}</span></td>
                    
                    <!-- 📌 MAINCONCEPT, ADDITIONAL, ACCESSORIES Seçenekleri -->
                    ${showCategoryColumn ? `
                    <td>
                      <label>
                        <input type="checkbox" id="mainConcept-${item.cartItemId}" 
                          ${item.MAINCONCEPT ? 'checked' : ''} 
                          onchange="updateCartCategory(${item.cartItemId}, this)">
                        Ana Konsept
                      </label><br>

                      <label>
                        <input type="checkbox" id="additional-${item.cartItemId}" 
                          ${item.ADDITIONAL ? 'checked' : ''} 
                          onchange="updateCartCategory(${item.cartItemId}, this)">
                        Tam.Ürünler
                      </label><br>
                      <label>
                        <input type="checkbox" id="additionalaks-${item.cartItemId}" 
                          ${item.ADDITIONALAKS ? 'checked' : ''} 
                          onchange="updateCartCategory(${item.cartItemId}, this)">
                        Tam. Aks.
                      </label><br>

                      <label>
                        <input type="checkbox" id="accessories-${item.cartItemId}" 
                          ${item.ACCESSORIES ? 'checked' : ''} 
                          onchange="updateCartCategory(${item.cartItemId}, this)">
                        Ek Aksesuar
                      </label><br>
                      <label>
                        <input type="checkbox" id="supplementary-${item.cartItemId}" 
                          ${item.SUPPLEMENTARY ? 'checked' : ''} 
                          onchange="updateCartCategory(${item.cartItemId}, this)">
                        Ek Ürün
                      </label>
                    </td>

                    ` : ""}
                    <td>
                        <div class="quantity-controls">
                            <button class="quantity-btn" onclick="updateQuantity(${item.cartItemId}, -1)">-</button>
                            <input type="text" class="quantity-input" id="quantity-${item.cartItemId}" value="${item.QUANTITY}" readonly />
                            <button class="quantity-btn" onclick="updateQuantity(${item.cartItemId}, 1)">+</button>
                        </div>
                    </td>
                    <td>
                        ${isCustomized ? `
                            <input 
                                type="number" 
                                id="customPrice-${item.cartItemId}" 
                                value="${item.CUSTOM_PRICE || item.PRICE}" 
                                min="0" 
                                step="100"
                                onchange="handleCustomPriceChange(${item.cartItemId}, true)"
                                style="width: 80px; text-align: right;" 
                            />
                        ` : `
                             <span style="display: block; text-align: right;">${formatCurrency(item.PRICE, cartInfo.PRICE_TYPE)}</span>
                        `}
                    </td>
                    <td>
                        <input
                            type="number"
                            id="discountRate-${item.cartItemId}"
                            value="${item.CUSTOM_DISCOUNT_RATE !== undefined && item.CUSTOM_DISCOUNT_RATE !== null ? item.CUSTOM_DISCOUNT_RATE : (item.DISCOUNT_RATE || 0)}"
                            min="0"
                            max="100"
                            step="5"
                            onchange="handleCustomPriceChange(${item.cartItemId}, ${isCustomized})"
                            style="width: 60px; text-align: center;"
                        />

                    </td>

                    <td style="text-align: right;" id="discountedPrice-${item.cartItemId}">
                        ${formatCurrency(discountedPrice, cartInfo.PRICE_TYPE)}
                    </td>
                    <td style="text-align: right;" >
                        ${formatCurrency(kdvsizTutar, cartInfo.PRICE_TYPE)}
                    </td>
                    <td style="text-align: right;" >
                        ${formatCurrency(kdvTutari, cartInfo.PRICE_TYPE)}
                    </td style="text-align: right;" >
                    <td style="text-align: right;" id="totalAmount-${item.cartItemId}">
                        ${formatCurrency(total, cartInfo.PRICE_TYPE)}
                    </td>
                    <td>
                        <button class="btn btn-danger btn-sm" onclick="removeFromCart(${item.cartItemId})">
                            <i class="fa fa-trash"></i>
                        </button>
                    </td>
                    <td>
                        <!-- Özelleştir Butonu (Sadece simge) -->
                        <button class="btn btn-info btn-sm" title="Özelleştir" onclick="openConfigModal(${item.cartItemId})">
                            <i class="fa fa-cogs"></i>
                        </button>

                        <!-- Özelleştirmeyi Sil Butonu -->
                        <button class="btn btn-danger btn-sm" title="Özelleştirmeyi Sil" onclick="deleteCustomization(${item.cartItemId})">
                            <i class="fa fa-times"></i>
                        </button>
                        <!-- Öneri Butonu (Sadece simge) -->
                        <button class="btn btn-warning btn-sm" title="Öneri" onclick="openSuggestionModal('${item.PRODUCT_ID}')">
                            <i class="fa fa-lightbulb-o"></i>
                        </button>
                    </td>
                </tr>
            `;
        }).join("");

        // İlk footer satırı: Toplam değerler
        let footerRow = "";
        if (showCategoryColumn) {
            footerRow = `
                <tr>
                  <th colspan="4">Toplam</th>
                  <th align="center">${totalQuantity}</th>
                  <th colspan="3"></th>
                  <th>${formatCurrency(totalKdvsiz, cartInfo.PRICE_TYPE)}</th>
                  <th>${formatCurrency(totalKdv, cartInfo.PRICE_TYPE)}</th>
                  <th>${formatCurrency(totalAmount, cartInfo.PRICE_TYPE)}</th>
                  <th colspan="2"></th>
                </tr>
            `;
        } else {
            footerRow = `
                <tr>
                  <th colspan="3">Toplam</th>
                  <th style="text-align: center;">${totalQuantity}</th>
                  <th colspan="3"></th>
                  <th>${formatCurrency(totalKdvsiz, cartInfo.PRICE_TYPE)}</th>
                  <th>${formatCurrency(totalKdv, cartInfo.PRICE_TYPE)}</th>
                  <th>${formatCurrency(totalAmount, cartInfo.PRICE_TYPE)}</th>
                  <th colspan="2"></th>
                </tr>
            `;
        }

        // İkinci footer satırı: Sigorta ve Navlun değerleri (sunucudan alınan summaryData)
        let additionalRow = "";
        // summaryData'yı almak için:
        let summaryData = null;
        try {
            const summaryResponse = await fetch(`http://192.168.30.4:3000/cart-summary/${activeCartId}`);
            if (summaryResponse.ok) {
                summaryData = await summaryResponse.json();
            }
        } catch (error) {
            console.error("Sepet özeti fetch hatası:", error);
        }
        if (summaryData && summaryData.success) {
            if (showCategoryColumn) {
                additionalRow = `
                    <tr>
                      <th colspan="9"></th>
                      
                      <th>
                        <div style="text-align: center;">
                          <label style="font-size: 0.9em;">Sigorta:</label><br>
                          <input type="number" id="insuranceInput" value="${summaryData.insurance}" style="width: 80px; text-align: center;" onchange="updateCartFreightInsurance()" />
                        </div>
                      </th>
                      <th>
                        <div style="text-align: center;">
                          <label style="font-size: 0.9em;">Navlun:</label><br>
                          <input type="number" id="freightInput" value="${summaryData.freight}" style="width: 80px; text-align: center;" onchange="updateCartFreightInsurance()" />
                        </div>
                      </th>
                      <th colspan="2"></th>
                    </tr>
                `;
            } else {
                additionalRow = `
                    <tr>
                      <th colspan="8"></th>
                      <th>
                        <div style="text-align: center;">
                          <label style="font-size: 0.9em;">Sigorta:</label><br>
                          <input type="number" id="insuranceInput" value="${summaryData.insurance}" style="width: 80px; text-align: center;" onchange="updateCartFreightInsurance()" />
                        </div>
                      </th>
                      <th>
                        <div style="text-align: center;">
                          <label style="font-size: 0.9em;">Navlun:</label><br>
                          <input type="number" id="freightInput" value="${summaryData.freight}" style="width: 80px; text-align: center;" onchange="updateCartFreightInsurance()" />
                        </div>
                      </th>
                      <th colspan="2"></th>
                    </tr>
                `;
            }
        }

        // Üçüncü footer satırı: Genel Toplam
        let totalRow = "";
        if (showCategoryColumn) {
            totalRow = `
                <tr>
                  <th colspan="9"></th>
                  <th style="text-align: center;">Genel Toplam:</th>
                  <th style="text-align: center;">${summaryData ? formatCurrency(summaryData.total, cartInfo.PRICE_TYPE) : formatCurrency(totalAmount, cartInfo.PRICE_TYPE)}</th>
                  <th colspan="2"></th>
                </tr>
            `;
        } else {
            totalRow = `
                <tr>
                  <th colspan="8"></th>
                  <th style="text-align: center;">Genel Toplam:</th>
                  <th style="text-align: center;">${summaryData ? formatCurrency(summaryData.total, cartInfo.PRICE_TYPE) : formatCurrency(totalAmount, cartInfo.PRICE_TYPE)}</th>
                  <th colspan="2"></th>
                </tr>
            `;
        }
        // PDF butonlarını belirleyen değişken:
        const pdfButtons = cartInfo.CONCEPT === 1 
          ? `<button class="btn btn-primary" onclick="generateConceptPDF('tr')">Konsept PDF (Türkçe)</button>
             <button class="btn btn-primary" onclick="generateConceptPDF('en')">Konsept PDF (English)</button>`
          : `<button class="btn btn-primary" onclick="generatePDF('tr')">PDF (Türkçe)</button>
             <button class="btn btn-primary" onclick="generatePDF('en')">PDF (English)</button>`;

        modalCartContent.innerHTML = `
          <table class="table table-bordered">
            <thead>
              <tr>
                <th>Fotoğraf</th>
                <th class="sortable" data-sort-field="PRODUCT_ID">Ürün ID</th>
                <th>Ürün Adı</th>
                ${showCategoryColumn ? `<th>Kategori</th>` : ""}
                <th>Miktar</th>
                <th>Fiyat</th>
                <th>İnd.(%)</th>
                <th>İndirimli Fiyat</th>
                <th>Kdvsiz Tutar</th>
                <th>KDV Tutarı</th>
                <th>Tutar</th>
                <th>Sil</th>
                <th>Özelleştir</th>
              </tr>
            </thead>
            <tbody id="cartTableBody">
              ${rowsHtml}
            </tbody>
            <tfoot>
              ${footerRow}
              ${additionalRow}
              ${totalRow}
              <tr>
                <td colspan="6" class="text-left">
                  <button class="btn btn-secondary" onclick="generateExcelAndOpenEmail()">Kod Talebi</button>
                </td>
                <td colspan="4" class="text-right">
                  ${pdfButtons}
                </td>
              </tr>
            </tfoot>
          </table>
        `;

        // Yeni: Sepet özet bilgilerini (total, freight, insurance) sunucudan çek ve göster
        try {
            const summaryResponse = await fetch(`http://192.168.30.4:3000/cart-summary/${activeCartId}`);
            if (summaryResponse.ok) {
                const summaryData = await summaryResponse.json();
                if (summaryData.success) {
                    // Genel Toplamı formatlayarak gösterelim
                    document.getElementById('totalDisplayValue').innerText = formatCurrency(summaryData.total, window.currentCartInfo ? window.currentCartInfo.PRICE_TYPE : 1);
                    // Navlun ve Sigorta input alanlarını da sunucudan gelen değerlerle güncelleyelim (varsa)
                    const freightInput = document.getElementById('freightInput');
                    if (freightInput) freightInput.value = summaryData.freight;
                    const insuranceInput = document.getElementById('insuranceInput');
                    if (insuranceInput) insuranceInput.value = summaryData.insurance;
                    updateCartFreightInsurance();
                }
            } else {
                console.error("Cart summary fetch failed");
            }
        } catch (error) {
            console.error("Sepet özeti güncelleme hatası:", error);
        }
        $('#cartModal').modal('show');
    } catch (error) {
        console.error('Sepet içeriği yüklenemedi:', error);
        modalCartContent.innerHTML = `<p class="text-danger">Bir hata oluştu: ${error.message}</p>`;
        $('#cartModal').modal('show');
		
    }
    $('#cartModal').on('shown.bs.modal', () => {
        loadCkartList();
		
    });
	attachProductIdSorting();
};

// Eğer global olarak tanımlı değilse getImageUrl ve formatCurrency fonksiyonlarını ekleyin:
const getImageUrl = (productId) => {
  const basePath = '/resim';
  return `${basePath}/${productId}.jpg`;
};


const attachProductIdSorting = () => {
  // Ürün ID başlığı th elementini seçiyoruz
  const productIdHeader = document.querySelector('th.sortable[data-sort-field="PRODUCT_ID"]');
  
  if (productIdHeader) {
    if (!window.productIdSortDirection) {
      window.productIdSortDirection = 'asc';
    }
    productIdHeader.addEventListener('click', async function() {
      console.log("Ürün Id başlığı tıklandı");
      // Sıralama yönünü tersine çeviriyoruz
      window.productIdSortDirection = window.productIdSortDirection === 'asc' ? 'desc' : 'asc';
      
      // Sıralama parametreleriyle endpoint çağrısı yapıyoruz
      const sortUrl = `http://192.168.30.4:3000/get-cart/${activeCartId}?order=PRODUCT_ID&direction=${window.productIdSortDirection}`;
      try {
        const response = await fetch(sortUrl);
        if (!response.ok) throw new Error('Sıralı sepet verisi alınamadı.');
        const data = await response.json();
        if (data.success) {
          const items = data.items;
          let totalQuantity = 0, totalAmount = 0, totalKdvsiz = 0, totalKdv = 0;
          // Global olarak gösterilen cartInfo'yu kullanıyoruz (showCartContents içinde window.currentCartInfo atanıyor)
          const cartInfo = window.currentCartInfo;
          const showCategoryColumn = (cartInfo && cartInfo.CONCEPT === 1);
          
          // Satırların tamamını oluşturuyoruz
          const tbodyContent = items.map(item => {
            totalQuantity += item.QUANTITY;
            totalKdvsiz += item.AMOUNT_NOTINCLUDED_VAT;
            totalKdv += item.VAT_TOTAL;
            totalAmount += item.TOTAL_AMOUNT;
            
            const imageUrl = getImageUrl(item.PRODUCT_ID);
            const fallbackImage = '/resim/YOK.jpg';
            
            const isCustomized = !!(item.CUSTOM_CODE || item.CUSTOM_NAME);
            const rowClass = isCustomized ? 'customized-row' : '';
            const discountedPrice = item.DISCOUNTED_PRICE;
            const kdvsizTutar = item.AMOUNT_NOTINCLUDED_VAT;
            const kdvTutari = item.VAT_TOTAL;
            const total = item.TOTAL_AMOUNT;
            
            return `
              <tr class="${rowClass}">
                <td>
                  <img src="${imageUrl}" onerror="this.onerror=null;this.src='${fallbackImage}';" alt="Ürün Fotoğrafı" style="width: 50px; height: 50px; object-fit: cover;">
                </td>
                <td>
                  ${isCustomized ? '<span style="font-weight: bold; color: #000;">Referans Kod:</span> ' : ''}
                  ${item.PRODUCT_ID}<br><br>
                  <span style="font-weight: bold; color: #0d285a;">${item.CUSTOM_CODE || ''}</span>
                </td>
                <td>
                  ${item.PRODUCT_NAME}<br><br>
                  <span style="font-weight: bold; color: #0d285a;">${item.CUSTOM_NAME || ''}</span>
                </td>
                ${showCategoryColumn ? `
                <td>
                  <label>
                    <input type="checkbox" id="mainConcept-${item.cartItemId}" ${item.MAINCONCEPT ? 'checked' : ''} onchange="updateCartCategory(${item.cartItemId}, this)">
                    Ana Konsept
                  </label><br>
                  <label>
                    <input type="checkbox" id="additional-${item.cartItemId}" ${item.ADDITIONAL ? 'checked' : ''} onchange="updateCartCategory(${item.cartItemId}, this)">
                    Tam.Ürünler
                  </label><br>
                  <label>
                    <input type="checkbox" id="additionalaks-${item.cartItemId}" ${item.ADDITIONALAKS ? 'checked' : ''} onchange="updateCartCategory(${item.cartItemId}, this)">
                    Tam. Aks.
                  </label><br>
                  <label>
                    <input type="checkbox" id="accessories-${item.cartItemId}" ${item.ACCESSORIES ? 'checked' : ''} onchange="updateCartCategory(${item.cartItemId}, this)">
                    Ek Aksesuar
                  </label><br>
                  <label>
                    <input type="checkbox" id="supplementary-${item.cartItemId}" ${item.SUPPLEMENTARY ? 'checked' : ''} onchange="updateCartCategory(${item.cartItemId}, this)">
                    Ek Ürün
                  </label>
                </td>
                ` : ""}
                <td>
                  <div class="quantity-controls">
                    <button class="quantity-btn" onclick="updateQuantity(${item.cartItemId}, -1)">-</button>
                    <input type="text" class="quantity-input" id="quantity-${item.cartItemId}" value="${item.QUANTITY}" readonly />
                    <button class="quantity-btn" onclick="updateQuantity(${item.cartItemId}, 1)">+</button>
                  </div>
                </td>
                <td>
                  ${isCustomized ? `
                    <input type="number" id="customPrice-${item.cartItemId}" value="${item.CUSTOM_PRICE || item.PRICE}" min="0" step="100" onchange="handleCustomPriceChange(${item.cartItemId}, true)" style="width: 80px; text-align: right;" />
                  ` : `
                    <span style="display: block; text-align: right;">${formatCurrency(item.PRICE, cartInfo.PRICE_TYPE)}</span>
                  `}
                </td>
                <td>
                  <input type="number" id="discountRate-${item.cartItemId}" value="${(item.CUSTOM_DISCOUNT_RATE !== undefined && item.CUSTOM_DISCOUNT_RATE !== null) ? item.CUSTOM_DISCOUNT_RATE : (item.DISCOUNT_RATE || 0)}" min="0" max="100" step="5" onchange="handleCustomPriceChange(${item.cartItemId}, ${isCustomized})" style="width: 60px; text-align: center;" />
                </td>
                <td style="text-align: right;" id="discountedPrice-${item.cartItemId}">
                  ${formatCurrency(discountedPrice, cartInfo.PRICE_TYPE)}
                </td>
                <td style="text-align: right;">
                  ${formatCurrency(kdvsizTutar, cartInfo.PRICE_TYPE)}
                </td>
                <td style="text-align: right;">
                  ${formatCurrency(kdvTutari, cartInfo.PRICE_TYPE)}
                </td>
                <td style="text-align: right;" id="totalAmount-${item.cartItemId}">
                  ${formatCurrency(total, cartInfo.PRICE_TYPE)}
                </td>
                <td>
                  <button class="btn btn-danger btn-sm" onclick="removeFromCart(${item.cartItemId})">
                    <i class="fa fa-trash"></i>
                  </button>
                </td>
                <td>
                  <button class="btn btn-info btn-sm" title="Özelleştir" onclick="openConfigModal(${item.cartItemId})">
                    <i class="fa fa-cogs"></i>
                  </button>
                  <button class="btn btn-danger btn-sm" title="Özelleştirmeyi Sil" onclick="deleteCustomization(${item.cartItemId})">
                    <i class="fa fa-times"></i>
                  </button>
                  <button class="btn btn-warning btn-sm" title="Öneri" onclick="openSuggestionModal('${item.PRODUCT_ID}')">
                    <i class="fa fa-lightbulb-o"></i>
                  </button>
                </td>
              </tr>
            `;
          }).join("");
          
          const tbody = document.getElementById('cartTableBody');
          if (tbody) {
            tbody.innerHTML = tbodyContent;
            console.log("Yeni tbody içeriği güncellendi:", tbody.innerHTML);
          } else {
            console.error("cartTableBody id'li tbody bulunamadı.");
          }
          
        } else {
          console.error("Sıralı sepet verisi alınırken hata oluştu.");
        }
      } catch (error) {
        console.error("Sıralama fetch hatası:", error);
      }
    });
  } else {
    console.error("Ürün ID sütunu th elementi bulunamadı. Lütfen th etiketinin class ve data-sort-field özniteliklerini kontrol edin.");
  }
};


// Müşteri Tipi Güncelleme
async function updateCartCustomerType(newType) {
  try {
    const response = await fetch(`http://192.168.30.4:3000/cart/${activeCartId}/customer-type`, {
      method: 'PUT',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ customerType: newType })
    });
    if (!response.ok) {
      const errorData = await response.json();
      alert(`Müşteri tipi güncellenemedi: ${errorData.message}`);
    } else {
      
      // Müşteri tipi değiştiğinde, KDV alanı otomatik güncellendiği için bunu da veritabanına yollayalım.
      if (newType === 'perakende') {
        // Perakende için KDV Dahil: 1
        await updateCartVatIncluded('1', true);
      } else if (newType === 'toptan') {
        // Toptan için KDV Hariç: 0
        await updateCartVatIncluded('0', true);
      } 
      // Kurumsal için kullanıcı seçimi devam edeceğinden burada otomatik güncelleme yapmayız.
      showCartContents();
	  updateCartSummary(); // Yeni eklenen özet güncelleme çağrısı
    }
  } catch (error) {
    console.error("Müşteri tipi güncelleme hatası:", error);
    alert("Müşteri tipi güncellenirken bir hata oluştu.");
  }
}
//Banka Seçeneklerini Yükleyen Fonksiyon
async function loadBankOptions(selectedBank) {
  try {
    const response = await fetch('http://192.168.30.4:3000/api/banks');
    const result = await response.json();
    if (result.success) {
      let options = `<option value="">Seçiniz</option>`;
      result.data.forEach(bank => {
        // Seçili bankayı belirlemek için
        const selected = bank.KOD === selectedBank ? "selected" : "";
        options += `<option value="${bank.KOD}" ${selected}>${bank.ADI}</option>`;
      });
      document.getElementById('bankSelector').innerHTML = options;
    }
  } catch (error) {
    console.error("Error loading bank options:", error);
  }
}

//Cart’in Bankasını Güncelleyen Fonksiyon
async function updateCartBank(selectedBank) {
  try {
    const response = await fetch('http://192.168.30.4:3000/update-cart-bank', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ cartId: activeCartId, bank: selectedBank })
    });
    const result = await response.json();
    if (!result.success) {
      alert(result.message);
    }
  } catch (error) {
    console.error("Error updating cart bank:", error);
  }
}

// Satış Bölgesi Güncelleme
async function updateCartSalesArea(newSalesArea) {
    try {
        const response = await fetch(`http://192.168.30.4:3000/cart/${activeCartId}/sales-area`, {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ salesArea: newSalesArea })
        });
        if (!response.ok) {
            const errorData = await response.json();
            alert(`Satış bölgesi güncellenemedi: ${errorData.message}`);
        } else {
            
            // Yeni satış bölgesine göre VAT hesaplamalarını güncelle:
            await fetch(`http://192.168.30.4:3000/cart/${activeCartId}/update-vat`, { method: 'PUT' });
            showCartContents();
			updateCartSummary(); // Yeni eklenen özet güncelleme çağrısı
        }
    } catch (error) {
        console.error("Satış bölgesi güncelleme hatası:", error);
        alert("Satış bölgesi güncellenirken bir hata oluştu.");
    }
}
// Ödeme Şartları seçeneklerini yükleyen fonksiyon
const loadPaymentTermsOptions = async (currentValue) => {
  try {
    const response = await fetch('/api/paymentterms');
    if (!response.ok) throw new Error('Payment terms seçenekleri alınamadı.');
    const result = await response.json();
    if (result.success) {
      const selector = document.getElementById('paymentTermsSelector');
      selector.innerHTML = `<option value="">Ödeme Şartları Seçiniz</option>`;
      result.data.forEach(term => {
        // Dil ayarına göre etiket: Örneğin, "tr" için TR sütunu, "en" için EN sütunu.
        const label = (window.currentLanguage && window.currentLanguage === "en") ? term.EN : term.TR;
        const option = document.createElement('option');
        option.value = term.KOD;
        option.textContent = label;
        if (term.KOD === currentValue) {
          option.selected = true;
        }
        selector.appendChild(option);
      });
      selector.addEventListener('change', async function() {
        const selectedValue = this.value;
        updateCartPaymentTerms(selectedValue);
      });
    }
  } catch (error) {
    console.error('Ödeme şartları yüklenirken hata:', error);
  }
};

// Konsept Alanı seçeneklerini yükleyen fonksiyon
const conceptareaOptions = async (currentValue) => {
  try {
    const response = await fetch('/api/conceptarea');
    if (!response.ok) throw new Error('Payment terms seçenekleri alınamadı.');
    const result = await response.json();
    if (result.success) {
      const selector = document.getElementById('conceptareaSelector');
      selector.innerHTML = `<option value="">Konsept Alanını Seçiniz..</option>`;
      result.data.forEach(concept => {
        // Dil ayarına göre etiket: Örneğin, "tr" için TR sütunu, "en" için EN sütunu.
        const label = (window.currentLanguage && window.currentLanguage === "en") ? concept.EN : concept.TR;
        const option = document.createElement('option');
        option.value = concept.KOD;
        option.textContent = label;
        if (concept.KOD === currentValue) {
          option.selected = true;
        }
        selector.appendChild(option);
      });
      selector.addEventListener('change', async function() {
        const selectedValue = this.value;
        updateconceptarea(selectedValue);
      });
    }
  } catch (error) {
    console.error('Konsept alanları yüklenirken hata:', error);
  }
};

// CKART listesini yükleyen fonksiyon
async function loadCkartList() {
  try {
    const response = await fetch('/api/ckart');
    if (response.ok) {
      const data = await response.json();
      const ckartSelect = document.getElementById("ckartSelect");
      ckartSelect.innerHTML = `<option value="">Seçiniz</option>`;
      data.data.forEach(item => {
        const option = document.createElement("option");
        option.value = item.KOD;
        // Listede "ADI (KOD)" formatında görünsün
        option.textContent = `${item.ADI} (${item.KOD})`;
        // Arama için hem ADI hem de KOD'u dahil et
        option.setAttribute("data-tokens", `${item.ADI} ${item.KOD}`);
        ckartSelect.appendChild(option);
      });
      // Eğer Bootstrap Select kullanıyorsanız yenileyin
      $(ckartSelect).selectpicker("refresh");

      // Sepet bilgileri yüklendiğinde, eğer aktif sepetin CKOD değeri varsa bunu select'te seçin
      if (window.currentCartInfo && window.currentCartInfo.CKOD) {
        ckartSelect.value = window.currentCartInfo.CKOD;
        $(ckartSelect).selectpicker("refresh");
      }
    } else {
      console.error("CKART verileri alınamadı:", response.status, response.statusText);
    }
  } catch (error) {
    console.error("CKART listesi yüklenirken hata:", error);
  }
}


// CKART seçimi değiştiğinde güncelleme yapan event listener
document.getElementById("ckartSelect").addEventListener("change", async function() {
  const selectedCkod = this.value;
  if (!activeCartId) {
    alert("Önce sepet oluşturulmalı veya aktif sepet seçilmeli.");
    return;
  }
  
  // Seçili option'ın metnini alıp ADI kısmını çıkartıyoruz.
  const selectedOption = this.options[this.selectedIndex];
  // Eğer metin "ADI (KOD)" şeklindeyse, ADI'yı ayıklamak için:
  const optionText = selectedOption.textContent;
  const adValue = optionText.split(" (")[0];  // " (" karakterine göre bölüp ilk kısmı alıyoruz.
  
  try {
    const response = await fetch("http://192.168.30.4:3000/cart/update-ckod", {
      method: "PUT",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ cartId: activeCartId, ckod: selectedCkod })
    });
    if (response.ok) {
      // Backend'den dönen data.customerName yerine, seçili option'dan aldığımız adValue'yu kullanıyoruz.
      alert("Sepet bilgileri güncellendi.");
      document.getElementById("cartNameDisplay").innerHTML = `
        <input type="text" id="customerNameInput" value="${adValue}" placeholder="Müşteri Adı" 
          onblur="updateCustomerName(this.value)" style="width: 100%; padding: 5px;" />
      `;
    } else {
      alert("Güncelleme sırasında hata oluştu.");
    }
  } catch (error) {
    console.error("CKOD güncelleme hatası:", error);
  }
});




// Seçilen ödeme şartlarını CART tablosuna kaydeden fonksiyon
const updateCartPaymentTerms = async (newValue) => {
  try {
    const response = await fetch(`/cart/${activeCartId}/paymentterms`, {
      method: 'PUT',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ paymentTerms: newValue })
    });
    const result = await response.json();
    if (!result.success) {
      alert(result.message);
    } else {
      
    }
  } catch (error) {
    console.error('Ödeme şartları güncellenirken hata:', error);
  }
};

// Seçilen Konsept Alanını CART tablosuna kaydeden fonksiyon
const updateconceptarea = async (newValue) => {
  try {
    const response = await fetch(`/cart/${activeCartId}/conceptarea`, {
      method: 'PUT',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ conceptarea: newValue })
    });
    const result = await response.json();
    if (!result.success) {
      alert(result.message);
    } else {
      
    }
  } catch (error) {
    console.error('Konsept alanı güncellenirken hata:', error);
  }
};
// Teslim Süresi seçeneklerini yükleyen fonksiyon (sabit seçenekler)
const loadDeliveryTimeOptions = (currentValue) => {
  const options = [1, 2, 3, 4, 6, 8, 10, 12];
  const selector = document.getElementById('deliveryTimeSelector');
  selector.innerHTML = `<option value="">Teslim Süresi Seçiniz</option>`;
  options.forEach(option => {
    const opt = document.createElement('option');
    opt.value = option;
    opt.textContent = option; // İsteğe göre "gün" veya "hafta" ekleyebilirsiniz
    if (String(option) === String(currentValue)) {
      opt.selected = true;
    }
    selector.appendChild(opt);
  });
  selector.addEventListener('change', async function(){
      const selectedValue = this.value;
      updateCartDeliveryTime(selectedValue);
  });
};

// Seçilen teslim süresini güncelleyen fonksiyon
const updateCartDeliveryTime = async (newValue) => {
  try {
    const response = await fetch(`/cart/${activeCartId}/deliverytime`, {
      method: 'PUT',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ deliveryTime: newValue })
    });
    const result = await response.json();
    if (!result.success) {
      alert(result.message);
    } else {
      
    }
  } catch (error) {
    console.error('Teslim süresi güncellenirken hata:', error);
  }
};
// KDV Dahil/Hariç Güncelleme
async function updateCartVatIncluded(newVatIncluded, force = false) {
  try {
    // Eğer force parametresi true ise veya select öğesi enabled ise API çağrısı yap.
    if (force || !document.getElementById('vatIncludedSelector').disabled) {
      const response = await fetch(`http://192.168.30.4:3000/cart/${activeCartId}/vat-included`, {
        method: 'PUT',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ vatIncluded: newVatIncluded })
      });
      if (!response.ok) {
        const errorData = await response.json();
        alert(`KDV durumu güncellenemedi: ${errorData.message}`);
        return;
      } else {
        
        // Güncelleme başarılıysa, sepetteki ürünlerin hesaplamalarını güncellemek için update-vat endpoint'ini tetikleyin.
        await fetch(`http://192.168.30.4:3000/cart/${activeCartId}/update-vat`, { method: 'PUT' });
        showCartContents();
		updateCartSummary(); // Yeni eklenen özet güncelleme çağrısı
      }
    }
  } catch (error) {
    console.error("KDV güncelleme hatası:", error);
    alert("KDV durumu güncellenirken bir hata oluştu.");
  }
}


// Fiyat Tipi Seçeneklerini Güncelle (showCartContents içinde çağrılıyor)
function updateCartPriceTypeOptions(customerType, currentPriceType) {
    const priceTypeSelector = document.getElementById('priceTypeSelector');
    priceTypeSelector.innerHTML = '';
    if (customerType === 'toptan') {
        priceTypeSelector.add(new Option('TOP TL', '2'));
        priceTypeSelector.add(new Option('TOP USD', '3'));
        priceTypeSelector.add(new Option('TOP EUR', '6'));
    } else {
        priceTypeSelector.add(new Option('PRK TL', '1'));
        priceTypeSelector.add(new Option('PRK USD', '4'));
        priceTypeSelector.add(new Option('PRK EUR', '5'));
    }
    priceTypeSelector.value = currentPriceType || (customerType === 'toptan' ? '2' : '1');
}

// KDV Seçeneklerini Güncelle
function updateCartVatIncludedOptions(customerType, currentVatIncluded) {
    const vatIncludedSelector = document.getElementById('vatIncludedSelector');
    vatIncludedSelector.innerHTML = '';
    if (customerType === 'perakende') {
        vatIncludedSelector.add(new Option('Dahil', '1'));
        vatIncludedSelector.value = '1';
        vatIncludedSelector.disabled = true;
    } else if (customerType === 'toptan') {
        vatIncludedSelector.add(new Option('Hariç', '0'));
        vatIncludedSelector.value = '0';
        vatIncludedSelector.disabled = true;
    } else { // kurumsal
        vatIncludedSelector.add(new Option('Dahil', '1'));
        vatIncludedSelector.add(new Option('Hariç', '0'));
        vatIncludedSelector.disabled = false;
        // currentVatIncluded değeri 0 ise (ya da "0") onu kullan, aksi halde 1 değerini kullan.
        if (currentVatIncluded === 0 || currentVatIncluded === '0') {
            vatIncludedSelector.value = '0';
        } else {
            vatIncludedSelector.value = '1';
        }
    }
}
//Başlıktaki Fiyat Tipini Güncelleme Fonksiyonu
const updateCartPriceType = async (priceType) => {
    try {
        // 1. Adım: Fiyat tipi güncelleme isteğini gönderiyoruz.
        const response = await fetch(`http://192.168.30.4:3000/cart/${activeCartId}/price-type`, {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ priceType })
        });

        if (!response.ok) {
            const errorData = await response.json();
            alert(`Hata: ${errorData.message}`);
            return;
        }
        
        
        // 2. Adım: Fiyat tipi değişikliği, ürün hesaplamalarını etkileyebileceğinden, 
        // tüm satırlar için VAT hesaplamalarını yeniden güncellemek amacıyla update‑vat endpoint’ini çağırıyoruz.
        await fetch(`http://192.168.30.4:3000/cart/${activeCartId}/update-vat`, { method: 'PUT' });
        
        // 3. Adım: Güncel sepet içeriğini yükle
        showCartContents();
		updateCartSummary(); // Yeni eklenen özet güncelleme çağrısı
    } catch (error) {
        console.error('Fiyat tipi güncelleme hatası:', error);
        alert('Bir hata oluştu, lütfen tekrar deneyin.');
    }
};


//başlıktaki indirim oranını değiştiren fonksiyon
const updateCartDiscountRate = async (discountRate) => {
  try {
    // İndirim oranı güncelleme isteği
    const response = await fetch(`http://192.168.30.4:3000/cart/${activeCartId}/discount-rate`, {
      method: 'PUT',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ discountRate })
    });

    if (!response.ok) {
      const errorData = await response.json();
      alert(`Hata: ${errorData.message}`);
      return;
    }
    
    // İndirim oranı değiştiğinde, sepetteki ürünlerin hesaplamalarını yeniden yapabilmek için update‑vat endpoint'ini tetikleyin
    await fetch(`http://192.168.30.4:3000/cart/${activeCartId}/update-vat`, { method: 'PUT' });
    
    // Güncellenen sepet içeriğini ekrana yansıtın
    showCartContents();
	updateCartSummary(); // Yeni eklenen özet güncelleme çağrısı
  } catch (error) {
    console.error('Sepet indirimi güncelleme hatası:', error);
    alert('Bir hata oluştu, lütfen tekrar deneyin.');
  }
};
//indirim oranı değiştiğinde backend'e bir istek gönderir ve tabloyu yeniden yükler.
const updateDiscountRate = async (cartItemId, discountRate) => {
    try {
        const response = await fetch(`http://192.168.30.4:3000/cart/item/${cartItemId}/update-discount-vat`, {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ discountRate })
        });
        if (!response.ok) {
            const errorData = await response.json();
            alert(`Hata: ${errorData.message}`);
            return;
        }
        showCartContents();
		updateCartFreightInsurance();
		
    } catch (error) {
        console.error('Satır bazında güncelleme hatası:', error);
        alert('Bir hata oluştu, lütfen tekrar deneyin.');
    }
};
//Navlun ve Sigorta Güncelleme Fonksiyonu
const updateCartFreightInsurance = async () => {
  try {
    // Input alanlarından navlun ve sigorta değerlerini al
    const freightInput = document.getElementById('freightInput');
    const insuranceInput = document.getElementById('insuranceInput');
    const freight = parseFloat(freightInput.value) || 0;
    const insurance = parseFloat(insuranceInput.value) || 0;

    // Yeni sepet özet endpoint'ine PUT isteği gönder
    const response = await fetch(`http://192.168.30.4:3000/cart/${activeCartId}/update-summary`, {
      method: 'PUT',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ freight, insurance })
    });

    if (!response.ok) {
      const errorData = await response.json();
      alert(`Özet güncellemesi yapılamadı: ${errorData.message}`);
      return;
    }
    const result = await response.json();
    // Güncellenen sepet içeriğini yeniden yükle
    showCartContents();
	updateCartSummary(); // Yeni eklenen özet güncelleme çağrısı
  } catch (error) {
    console.error("Navlun/Sigorta güncelleme hatası:", error);
    alert("Navlun/Sigorta güncellenirken bir hata oluştu.");
  }
};

//Sepet GrandTotal yazdırma
const updateCartSummary = async () => {
  try {
    // Navlun ve Sigorta değerlerini al (input'larda tanımlıysa)
    const freightInput = document.getElementById('freightInput');
    const insuranceInput = document.getElementById('insuranceInput');
    const freight = freightInput ? parseFloat(freightInput.value) || 0 : 0;
    const insurance = insuranceInput ? parseFloat(insuranceInput.value) || 0 : 0;
    
    // Özet güncelleme endpoint'ine istek gönder
    const response = await fetch(`http://192.168.30.4:3000/cart/${activeCartId}/update-summary`, {
      method: 'PUT',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ freight, insurance })
    });
    
    if (!response.ok) {
      const errorData = await response.json();
      alert(`Sepet özeti güncellenemedi: ${errorData.message}`);
      return;
    }
    const result = await response.json();
    
    // total: SUBTOTAL + VATTOTAL + FREIGHT + INSURANCE
    // Bu değeri formatlayarak modalda gösterelim.
    document.getElementById('totalDisplayValue').innerText = formatCurrency(result.total, window.currentCartInfo ? window.currentCartInfo.PRICE_TYPE : 1);
  } catch (error) {
    console.error("Sepet özeti güncelleme hatası:", error);
    //alert("Sepet özeti güncellenirken bir hata oluştu.");
  }
};

//toplamları güncelle
const updateTotalAmount = (items, priceType) => {
    let totalQuantity = 0;
    let totalAmount = 0;

    items.forEach(item => {
        const customPriceElement = document.getElementById(`customPrice-${item.cartItemId}`);
        const discountRateElement = document.getElementById(`discountRate-${item.cartItemId}`);

        const customPrice = customPriceElement && customPriceElement.value !== ""
            ? parseFloat(customPriceElement.value)
            : item.PRICE; // Eğer özelleştirilmiş fiyat yoksa orijinal fiyatı kullan

        const discountRate = discountRateElement && discountRateElement.value !== ""
            ? parseFloat(discountRateElement.value)
            : item.DISCOUNT_RATE; // Eğer özelleştirilmiş indirim oranı yoksa orijinal oranı kullan

        const discountedPrice = customPrice * (1 - discountRate / 100);
        const rowTotal = discountedPrice * item.QUANTITY;

        totalQuantity += item.QUANTITY;
        totalAmount += rowTotal;
    });

    // Alt toplamları güncelle
    const totalQuantityElement = document.getElementById("totalQuantity");
    const totalAmountElement = document.getElementById("totalAmount");

    if (totalQuantityElement) totalQuantityElement.innerText = totalQuantity;
    if (totalAmountElement) totalAmountElement.innerText = formatCurrency(totalAmount, priceType);
};
//Özelleştirmeyi silen Fonksiyon
async function deleteCustomization(cartItemId) {
    try {
        const confirmation = confirm("Bu ürüne ait özelleştirmeyi silmek istediğinize emin misiniz?");
        if (!confirmation) return;

        const response = await fetch(`/api/cart-items/${cartItemId}/customization`, {
            method: 'DELETE'
        });

        const json = await response.json();

        if (json.success) {
            alert('Özelleştirme başarıyla silindi.');
            await showCartContents(); // Sepet içeriğini güncelle
        } else {
            alert(`Hata: ${json.message}`);
        }
    } catch (error) {
        console.error('Özelleştirme silinirken hata:', error);
        alert('Özelleştirme silinirken bir hata oluştu.');
    }
}

//Kod Talebi Fonksiyonu
async function generateExcelAndOpenEmail() {
    try {
        // Sepet içeriğini al
        const response = await fetch(`http://192.168.30.4:3000/get-cart/${activeCartId}`);
        if (!response.ok) throw new Error('Sepet içeriği alınamadı.');

        const { items } = await response.json();

        // Sepet bilgilerini al
        const cartInfoResponse = await fetch(`http://192.168.30.4:3000/cart-info/${activeCartId}`);
        if (!cartInfoResponse.ok) throw new Error('Sepet bilgileri alınamadı.');

        const cartInfo = await cartInfoResponse.json();
        const customerName = cartInfo.CUSTOMER_NAME || 'Bilinmiyor';
        const cartId = activeCartId || 'Bilinmiyor';

        // Sadece özelleştirilmiş ürünleri filtrele
        const customizedItems = items.filter(item => item.CUSTOM_CODE || item.CUSTOM_NAME);

        // Eğer özelleştirilmiş ürün yoksa uyarı ver ve çık
        if (customizedItems.length === 0) {
            alert('Sepette özelleştirilmiş ürün bulunamadı.');
            return;
        }

        // ExcelJS ile Excel dosyası oluşturma
        const ExcelJS = window.ExcelJS;
        const workbook = new ExcelJS.Workbook();
        const worksheet = workbook.addWorksheet('Kod Talebi');

        // Başlıklar
        worksheet.columns = [
            { header: 'Referans Kod', key: 'referenceCode', width: 20 },
            { header: 'Özelleştirilmiş Kod', key: 'customCode', width: 20 },
            { header: 'Özelleştirilmiş Ad', key: 'customName', width: 40 },
            { header: 'Model Kod', key: 'modelKod', width: 20 },
            { header: 'Model Adı', key: 'modelAdi', width: 30 },
            { header: 'Materyal Kod', key: 'materyalKod', width: 20 },
            { header: 'Materyal Adı', key: 'materyalAdi', width: 30 },
            { header: 'Desen Kod', key: 'desenKod', width: 20 },
            { header: 'Desen Adı', key: 'desenAdi', width: 30 },
            { header: 'Lamine Kod', key: 'lamineKod', width: 20 },
            { header: 'Lamine Adı', key: 'lamineAdi', width: 30 },
            { header: 'Aksesuar1 Kod', key: 'aksesuar1Kod', width: 20 },
            { header: 'Aksesuar1 Adı', key: 'aksesuar1Adi', width: 30 },
            { header: 'Aksesuar2 Kod', key: 'aksesuar2Kod', width: 20 },
            { header: 'Aksesuar2 Adı', key: 'aksesuar2Adi', width: 30 },
            { header: 'Aksesuar3 Kod', key: 'aksesuar3Kod', width: 20 },
            { header: 'Aksesuar3 Adı', key: 'aksesuar3Adi', width: 30 },
            { header: 'Ebat Kod', key: 'ebatKod', width: 20 },
            { header: 'Ebat Adı', key: 'ebatAdi', width: 30 },
            { header: 'Renk Kod', key: 'renkKod', width: 20 },
            { header: 'Renk Adı', key: 'renkAdi', width: 30 }
        ];

        // Özelleştirilmiş ürünleri ekleyin
        customizedItems.forEach(item => {
            worksheet.addRow({
                referenceCode: item.PRODUCT_ID,
                customCode: item.CUSTOM_CODE || '',
                customName: item.CUSTOM_NAME || '',
                modelKod: item.MODEL_KOD || '',
                modelAdi: item.MODEL_ADI || '',
                materyalKod: item.MATERYAL_KOD || '',
                materyalAdi: item.MATERYAL_ADI || '',
                desenKod: item.DESEN_KOD || '',
                desenAdi: item.DESEN_ADI || '',
                lamineKod: item.LAMINE_KOD || '',
                lamineAdi: item.LAMINE_ADI || '',
                aksesuar1Kod: item.AKSESUAR1_KOD || '',
                aksesuar1Adi: item.AKSESUAR1_ADI || '',
                aksesuar2Kod: item.AKSESUAR2_KOD || '',
                aksesuar2Adi: item.AKSESUAR2_ADI || '',
                aksesuar3Kod: item.AKSESUAR3_KOD || '',
                aksesuar3Adi: item.AKSESUAR3_ADI || '',
                ebatKod: item.EBAT_KOD || '',
                ebatAdi: item.EBAT_ADI || '',
                renkKod: item.RENK_KOD || '',
                renkAdi: item.RENK_ADI || ''
            });
        });

        // Excel dosyasını oluştur ve e-postayı gönder
        const buffer = await workbook.xlsx.writeBuffer();
        const blob = new Blob([buffer], { type: 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet' });
        const fileName = `Kod_Talebi_Sepet_${cartId}.xlsx`;

        // Mail ve indirme işlemleri
        const fileURL = URL.createObjectURL(blob);
        const email = 'planlama@estetikdecor.com';
        const subject = encodeURIComponent(`Kod Talebi - Sepet ${cartId}`);
        const body = encodeURIComponent(`
Merhaba,

Ekteki dosyada kod talebi detaylarını bulabilirsiniz.

Müşteri Adı: ${customerName}
Sepet No: ${cartId}
Talep Edilen Kod Sayısı: ${customizedItems.length}

Saygılar.
        `);

        const mailtoLink = `mailto:${email}?subject=${subject}&body=${body}`;
        const a = document.createElement('a');
        a.href = mailtoLink;
        a.click();

        const downloadLink = document.createElement('a');
        downloadLink.href = fileURL;
        downloadLink.download = fileName;
        downloadLink.click();
        URL.revokeObjectURL(fileURL);
    } catch (error) {
        console.error('Excel oluşturulurken veya mail gönderilirken hata:', error);
        alert('Excel oluşturulurken bir hata oluştu.');
    }
}


//başlıktaki müşteri ismini değiştiren Fonksiyon
const updateCustomerName = async (newName) => {
    try {
        const response = await fetch(`http://192.168.30.4:3000/update-customer-name`, {
            method: 'PUT',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                cartId: activeCartId,
                customerName: newName,
            }),
        });
        if (!response.ok) throw new Error('Müşteri adı güncellenemedi.');
    } catch (error) {
        console.error('Müşteri adı güncelleme hatası:', error);
    }
};

//Sepet Kategorilerini Güncelleme
const updateCartCategory = async (cartItemId, changedElem) => {
  // Eğer tıklanan checkbox seçiliyse, diğerlerinin seçimini kaldırıyoruz:
  if (changedElem.checked) {
    const mainConceptElem = document.querySelector(`#mainConcept-${cartItemId}`);
    const additionalElem = document.querySelector(`#additional-${cartItemId}`);
	const additionalAksElem = document.querySelector(`#additionalaks-${cartItemId}`);
    const accessoriesElem = document.querySelector(`#accessories-${cartItemId}`);
	const supplementaryElem = document.querySelector(`#supplementary-${cartItemId}`);
    
    if (changedElem !== mainConceptElem) {
      mainConceptElem.checked = false;
    }
    if (changedElem !== additionalElem) {
      additionalElem.checked = false;
    }
	if (changedElem !== additionalAksElem) {
      additionalAksElem.checked = false;
    }
    if (changedElem !== accessoriesElem) {
      accessoriesElem.checked = false;
    }
	if (changedElem !== supplementaryElem) {
      supplementaryElem.checked = false;
    }
  }
  
  // Her checkbox'ın durumunu alıyoruz:
  const mainConceptChecked = document.querySelector(`#mainConcept-${cartItemId}`).checked;
  const additionalChecked = document.querySelector(`#additional-${cartItemId}`).checked;
  const additionalAksChecked = document.querySelector(`#additionalaks-${cartItemId}`).checked;
  const accessoriesChecked = document.querySelector(`#accessories-${cartItemId}`).checked;
  const supplementaryChecked = document.querySelector(`#supplementary-${cartItemId}`).checked;

  try {
    const response = await fetch('http://192.168.30.4:3000/update-cart-category', {
      method: 'PUT',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        cartItemId: cartItemId, // Güncellenen sepet öğesi
        mainConcept: mainConceptChecked ? 1 : 0, 
        additional: additionalChecked ? 1 : 0,
		additionalaks: additionalAksChecked ? 1 : 0,
		supplementary: supplementaryChecked ? 1 : 0,
        accessories: accessoriesChecked ? 1 : 0
      })
    });

    if (!response.ok) throw new Error('Kategori güncellenemedi.');

    const result = await response.json();

    if (result.success) {
      await showCartContents(); // Sepet içeriğini yenile
    } else {
      throw new Error(result.message || 'Kategori güncellenirken hata oluştu.');
    }
  } catch (error) {
    console.error('⚠️ Kategori güncelleme hatası:', error);
    alert(`Bir hata oluştu: ${error.message}`);
  }
};


//Miktar Güncelleme Fonksiyonu 
const updateQuantity = async (cartItemId, change) => {
    try {
        // Input alanını bul ve mevcut miktarı al
        const quantityInput = document.getElementById(`quantity-${cartItemId}`);
        if (!quantityInput) {
            console.error(`Element not found: quantity-${cartItemId}`);
            throw new Error(`Miktar input elemanı bulunamadı: quantity-${cartItemId}`);
        }

        const currentQuantity = parseInt(quantityInput.value, 10);
        const newQuantity = currentQuantity + change;
        if (newQuantity < 1) {
            alert('Miktar 1\'den küçük olamaz.');
            return;
        }

        // Backend API'ye miktar güncelleme isteği gönder
        const response = await fetch('http://192.168.30.4:3000/update-cart-item', {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                cartItemId, // Cart item ID gönderiliyor
                quantity: newQuantity
            })
        });

        if (!response.ok) throw new Error('Miktar güncellenemedi.');
        const result = await response.json();

        if (result.success) {
            // Miktar input değerini güncelle
            quantityInput.value = newQuantity;

            // Satırdaki mevcut indirim oranını al (örneğin, discountRate input'undan)
            const discountRateElement = document.getElementById(`discountRate-${cartItemId}`);
            const discountRate = parseFloat(discountRateElement?.value || 0);

            // Miktar güncellendikten sonra, ilgili satırın VAT ve diğer hesaplama alanlarını yeniden hesaplamak için
            // update-discount-vat endpoint’ini çağırıyoruz (bu endpoint, satırdaki discountRate, quantity, VAT hesaplamalarını yapıyor)
            const vatResponse = await fetch(`http://192.168.30.4:3000/cart/item/${cartItemId}/update-discount-vat`, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ discountRate })
            });
            if (!vatResponse.ok) {
                const vatError = await vatResponse.json();
                alert(`KDV hesaplamaları güncellenemedi: ${vatError.message}`);
            } else {
            }

            // Sepet içeriğini yeniden yükle
            showCartContents();
			updateCartFreightInsurance()
        } else {
            throw new Error(result.message || 'Miktar güncellenirken bir hata oluştu.');
        }
    } catch (error) {
        console.error('Miktar güncelleme hatası:', error);
        alert(`Bir hata oluştu: ${error.message}`);
    }
};


	const addImageToPDF = async (doc, url, x, y, width, height) => {
		try {
			const response = await fetch(url);
			const blob = await response.blob();
			const reader = new FileReader();
			reader.onload = function (event) {
				const base64Image = event.target.result;
				doc.addImage(base64Image, 'JPEG', x, y, width, height);
			};
			reader.readAsDataURL(blob);
		} catch (error) {
			console.error(`Resim eklenemedi: ${url}`, error);
		}
	};

// Sepeti Gösterme
const showCartList = async () => {
  try {
    const userId = localStorage.getItem('userId');
    if (!userId) {
      alert('Sepetleri görüntülemek için önce giriş yapmalısınız.');
      $('#loginModal').modal('show');
      return;
    }

    // Kullanıcı bilgilerini çekelim ve CONCEPTADMIN ile CONCEPTUNLOCK değerlerini alalım.
    const userResponse = await fetch(`http://192.168.30.4:3000/api/user/${userId}`);
    if (!userResponse.ok) throw new Error('Kullanıcı bilgisi alınamadı.');
    const userData = await userResponse.json();
    const isAdmin = userData.CONCEPTADMIN === 1;
    // Kilidi kaldırma yetkisini belirleyelim: Eğer true ise kullanıcı kilidi açabilir, false ise sadece kilitleyebilir.
    const userConceptUnlock = userData.CONCEPTUNLOCK === 1;
    console.log("Kullanıcı Konsept Kilit Admin", userConceptUnlock);

    // Sepetleri backend'den çekelim
    const response = await fetch(`http://192.168.30.4:3000/carts/${userId}`);
    if (!response.ok) throw new Error('Sepet listesi alınamadı.');
    const carts = await response.json();

    // En az bir konsept sepet var mı kontrol edelim
    const hasConceptCart = carts.some(cart => cart.CONCEPT == 1);

    // Eğer konsept sepet varsa; sıralama önce CONCEPT_AREA'ya göre (tanımlı sıralama dizisi) sonra CUSTOMER_NAME'e göre yapılır.
    if (hasConceptCart) {
      const conceptAreaOrder = [
        "OTURMA ODASI - SECTIONAL",
        "OTURMA ODASI",
        "OTURMA ODASI - TV UNITESI",
        "OTURMA ODASI - TEA CORNER",
        "OTURMA ODASI - BAR",
        "YEMEK ODASI - MASA",
        "YEMEK ODASI - BÜFE/KONSOL",
        "YATAK ODASI",
        "YATAK ODASI - MAKYAJ",
        "YATAK ODASI - DOLAP",
        "YATAK ODASI - CEKMECE",
        "YATAK ODASI - JOSEFIN",
        "ANTRE",
        "GIYINME ODASI",
        "OFIS",
        "TERAS",
        "ARANJMAN - CICEK",
        "DİĞER"
      ];

      carts.sort((a, b) => {
        if (a.CONCEPT == 1 && b.CONCEPT == 1) {
          let indexA = conceptAreaOrder.indexOf(a.CONCEPT_AREA);
          let indexB = conceptAreaOrder.indexOf(b.CONCEPT_AREA);
          if (indexA === -1) indexA = conceptAreaOrder.length;
          if (indexB === -1) indexB = conceptAreaOrder.length;
          if (indexA !== indexB) return indexA - indexB;
          return a.CUSTOMER_NAME.localeCompare(b.CUSTOMER_NAME);
        } else if (a.CONCEPT == 1) {
          return -1;
        } else if (b.CONCEPT == 1) {
          return 1;
        } else {
          return a.CUSTOMER_NAME.localeCompare(b.CUSTOMER_NAME);
        }
      });
    } else {
      carts.sort((a, b) => a.CUSTOMER_NAME.localeCompare(b.CUSTOMER_NAME));
    }

    // Tablo başlığını oluşturuyoruz; (ilk render’da modal açıldığında konsept sepetler gizli, fakat sütunlar render ediliyor)
    let cartListHtml = `
      <table class="table table-bordered">
        <thead>
          <tr>
            <th>ID</th>
            ${hasConceptCart ? `<th>Konsept Alanı</th>` : ""}
            <th>Müşteri Adı</th>
            <th>Oluşturulma Tarihi</th>
            <th>Oluşturan Kullanıcı</th>
            ${hasConceptCart && isAdmin ? `<th>Konsept</th>` : ""}
            <th>Konsept Kilidi</th>
            <th>İşlemler</th>
          </tr>
        </thead>
        <tbody>
    `;

    carts.forEach(cart => {
      const isConcept = cart.CONCEPT == 1;
      // Eğer konsept sepet ise, satır ilk açılışta gizlensin.
      cartListHtml += `<tr class="${isConcept ? 'concept-cart' : ''}" ${isConcept ? 'style="display:none;"' : ''}>`;
      cartListHtml += `<td>${cart.ID}</td>`;
      if (hasConceptCart) {
        // Konsept alanı sütunu: Sadece konsept sepetlerde gösterilir.
        cartListHtml += `<td class="text-center">${isConcept ? (cart.CONCEPT_AREA || "") : ""}</td>`;
      }
      cartListHtml += `<td>${cart.CUSTOMER_NAME}</td>`;
      cartListHtml += `<td>${new Date(cart.CREATED_AT).toLocaleString()}</td>`;
      cartListHtml += `<td>${cart.USER_ID}</td>`;

      // Admin için "Konsept" checkbox sütunu:
      // Burada, checkbox her zaman aktif olsun (kilit durumuna bakılmaksızın) çünkü kilit kaldırma işlemi kullanıcı yetkisine bağlı.
      if (hasConceptCart && isAdmin) {
        cartListHtml += `
          <td class="text-center">
            <input type="checkbox" class="concept-checkbox" data-cart-id="${cart.ID}"
                   ${isConcept ? "checked" : ""} />
          </td>
        `;
      }

      // "Konsept Kilidi" sütunu: Eğer sepet kilitliyse (cart.CONCEPTLOCK == 1) ve kullanıcı yetkisi yoksa disable,
      // aksi halde (kilitli değilse) tüm kullanıcılar kilitleyebilir.
      cartListHtml += `
          <td class="text-center">
            <input type="checkbox" class="conceptlock-checkbox" data-cart-id="${cart.ID}"
                   ${cart.CONCEPTLOCK == 1 ? "checked" : ""}
                   ${(cart.CONCEPTLOCK == 1 && !userConceptUnlock) ? "disabled" : ""} />
          </td>
      `;

      // "İşlemler" sütunu: "Bu Sepeti Seç" ve "Sil" butonları, eğer sepet kilitliyse disable edilsin.
      cartListHtml += `
          <td class="text-center">
            <button class="btn btn-primary btn-sm me-2" onclick="setActiveCart(${cart.ID})" title="Bu Sepeti Seç" ${cart.CONCEPTLOCK == 1 ? "disabled" : ""}>
              <i class="fas fa-check-circle"></i>
            </button>
            <button class="btn btn-danger btn-sm" onclick="deleteCart(${cart.ID})" title="Sil" ${cart.CONCEPTLOCK == 1 ? "disabled" : ""}>
              <i class="fas fa-trash-alt"></i>
            </button>
          </td>
      `;
      cartListHtml += `</tr>`;
    });

    cartListHtml += `</tbody></table>`;
    document.getElementById('cartListModalBody').innerHTML = cartListHtml;

    // Admin için, "Konsept" checkbox'ları event listener'ı:
    if (isAdmin && hasConceptCart) {
      document.querySelectorAll('.concept-checkbox').forEach(checkbox => {
        checkbox.addEventListener('change', function () {
          const cartId = this.dataset.cartId;
          const conceptValue = this.checked ? 1 : 0;
          fetch("http://192.168.30.4:3000/api/cart/concept", {
            method: "PUT",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ cartId, conceptValue })
          })
          .then(response => response.json())
          .then(data => {
            console.log("Konsept güncellendi:", data);
            // Eğer konsept checkbox'ı unchecked yapıldıysa, otomatik olarak "Konsept Kilidi" checkbox'ını sıfırla
            if (!this.checked) {
              const lockCheckbox = document.querySelector(`.conceptlock-checkbox[data-cart-id="${cartId}"]`);
              if (lockCheckbox) {
                lockCheckbox.checked = false;
                // Backend'de de CONCEPTLOCK değeri 0 olarak güncellensin
                fetch("http://192.168.30.4:3000/api/cart/conceptlock", {
                  method: "PUT",
                  headers: { "Content-Type": "application/json" },
                  body: JSON.stringify({ cartId, conceptLockValue: 0 })
                })
                .then(response => response.json())
                .then(dataLock => {
                  console.log("Konsept kilidi güncellendi (otomatik):", dataLock);
                  // Butonları enable yapalım
                  const setCartBtn = document.querySelector(`button[onclick="setActiveCart(${cartId})"]`);
                  if (setCartBtn) {
                    setCartBtn.disabled = false;
                  }
                  const deleteCartBtn = document.querySelector(`button[onclick="deleteCart(${cartId})"]`);
                  if (deleteCartBtn) {
                    deleteCartBtn.disabled = false;
                  }
                })
                .catch(error => console.error("Konsept kilidi güncelleme hatası (otomatik):", error));
              }
            }
          })
          .catch(error => console.error("Güncelleme hatası:", error));
        });
      });
    }

    // "Konsept Kilidi" checkbox'ları için event listener:
    document.querySelectorAll('.conceptlock-checkbox').forEach(checkbox => {
      checkbox.addEventListener('change', function () {
        const cartId = this.dataset.cartId;
        const newLockValue = this.checked ? 1 : 0;
        // Eğer kullanıcı kilidi kaldırmaya (unlock) çalışıyor fakat yetkisi yoksa işlemi iptal et
        if (newLockValue === 0 && !userConceptUnlock) {
          alert("Kilidi kaldıramazsınız. Bu işlem için yetkiniz bulunmuyor.");
          this.checked = true;
          return;
        }
        fetch("http://192.168.30.4:3000/api/cart/conceptlock", {
          method: "PUT",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ cartId, conceptLockValue: newLockValue })
        })
        .then(response => response.json())
        .then(data => {
          console.log("Konsept kilidi güncellendi:", data);
          // Güncelleme sonrası, "Bu Sepeti Seç" ve "Sil" butonlarının durumunu güncelleyelim.
          const setCartBtn = document.querySelector(`button[onclick="setActiveCart(${cartId})"]`);
          if (setCartBtn) {
            setCartBtn.disabled = newLockValue == 1;
          }
          const deleteCartBtn = document.querySelector(`button[onclick="deleteCart(${cartId})"]`);
          if (deleteCartBtn) {
            deleteCartBtn.disabled = newLockValue == 1;
          }
          // Admin konsept checkbox'ı için de güncelleme yapalım (kilit kaldırma, yetki varsa aktif)
          const conceptCheckbox = document.querySelector(`.concept-checkbox[data-cart-id="${cartId}"]`);
          if (conceptCheckbox) {
            conceptCheckbox.disabled = newLockValue == 1 && !userConceptUnlock;
          }
        })
        .catch(error => console.error("Konsept kilidi güncelleme hatası:", error));
      });
    });

    $('#cartListModal').modal('show'); // Modalı göster

  } catch (error) {
    console.error('Sepet listesi hatası:', error);
    alert('Bir hata oluştu: ' + error.message);
  }
};


	// Fiyat tipi belirleme fonksiyonu
	const getPriceType = (priceType) => {
		switch (Number(priceType)) {
			case 1: return "PRK TL";
			case 2: return "TOP TL";
			case 3: return "TOP USD";
			case 4: return "PRK USD";
			case 5: return "PRK EUR";
			case 6: return "TOP EUR";
			default: return "Bilinmiyor";
		}
	};

	document.getElementById("cartModal").addEventListener("shown.bs.dropdown", function (e) {
		const dropdownMenu = e.target.querySelector(".dropdown-menu");
		if (dropdownMenu) {
			dropdownMenu.style.position = "absolute";
			dropdownMenu.style.transform = "translateY(-100%)";
			dropdownMenu.style.zIndex = "1060";
		}
	});

	// CartModal'ı kapatma işlevi
	const closeCartModal = () => {
		$('#cartModal').modal('hide'); // Bootstrap modalını gizler
	};
	// CartListModal'ı kapatma işlevi
	const closeCartListModal = () => {
		$('#cartListModal').modal('hide'); // Bootstrap modalını gizler
	};
	// CartFormModal'ı kapatma işlevi
	const closeCartFormModal = () => {
		$('#cartFormModal').modal('hide'); // Bootstrap modalını gizler
	};
	
// Konfigürasyon Modalını Açma Fonksiyonu
async function openConfigModal(cartItemId) {
    try {

        document.getElementById('configCartItemId').value = cartItemId;

        const lookupTypes = {
            model: 71,
            materyal: 72,
            desen: 73,
            lamine: 74,
            aksesuar1: 75,
            aksesuar2: 75,
            aksesuar3: 75,
            ebat: 78,
            renk: 79,
			ayak: 209
        };

        // Dropdown'ları doldur ve default değerleri ayarla
        for (const [key, type] of Object.entries(lookupTypes)) {
            await fillDropdown(`${key}Select`, type);
        }

        // Konfigürasyon verilerini sunucudan çek
        const response = await fetch(`/api/cart-items/${cartItemId}/config`);
        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }

        const json = await response.json();
        const data = json.success && json.data ? json.data : {};

        // Dropdown'lara default değerleri set et
        $('#modelSelect').val(data.MODEL_KOD || data.MODELKOD || '').selectpicker('refresh');
        $('#materyalSelect').val(data.MATERYAL_KOD || data.MATERYALKOD || '').selectpicker('refresh');
        $('#desenSelect').val(data.DESEN_KOD || data.DESENKOD || '').selectpicker('refresh');
        $('#lamineSelect').val(data.LAMINE_KOD || data.LAMINEKOD || '').selectpicker('refresh');
        $('#aksesuar1Select').val(data.AKSESUAR1_KOD || data.AKSESUAR1KOD || '').selectpicker('refresh');
        $('#aksesuar2Select').val(data.AKSESUAR2_KOD || data.AKSESUAR2KOD || '').selectpicker('refresh');
        $('#aksesuar3Select').val(data.AKSESUAR3_KOD || data.AKSESUAR3KOD || '').selectpicker('refresh');
        $('#ebatSelect').val(data.EBAT_KOD || data.EBATKOD || '').selectpicker('refresh');
        $('#renkSelect').val(data.RENK_KOD || data.RENKKOD || '').selectpicker('refresh');
		$('#ayakSelect').val(data.AYAK_KOD || data.AYAKKOD || '').selectpicker('refresh');

        // Referans kodu ve diğer alanlar
        document.getElementById('referenceCodeInput').value = data.REFERENCE_CODE || '';
        document.getElementById('customCodeInput').value = data.CUSTOM_CODE || '';
        document.getElementById('customNameInput').value = data.CUSTOM_NAME || '';

        // Modal işlemleri
        $('#cartModal').modal('hide');
        $('#configureModal').modal('show');
    } catch (error) {
        console.error('Konfigürasyon yüklenemedi:', error);
        alert('Konfigürasyon yüklenirken bir hata oluştu.');
    }
}

// Dropdown'ları doldurma fonksiyonu
async function fillDropdown(selectId, type) {
    try {

        const response = await fetch(`/api/lookups?tip=${type}`);
        if (!response.ok) throw new Error('Lookup verileri alınamadı.');

        const json = await response.json();
        if (!json.success) throw new Error('Lookup verileri başarılı bir şekilde alınamadı.');

        const selectElement = $(`#${selectId}`);
        if (selectElement.length === 0) {
            //console.error(`Dropdown element (${selectId}) bulunamadı.`);
            return;
        }

        // Mevcut seçenekleri temizle
        selectElement.empty();

        // Varsayılan seçeneği ekle
        selectElement.append('<option value="">Seçiniz</option>');

        // Yeni seçenekleri ekle
        json.data.forEach((item) => {
            selectElement.append(`<option value="${item.KOD}">${item.ADI}</option>`);
        });

        // Bootstrap Select'i yenile
        if (typeof selectElement.selectpicker === 'function') {
            selectElement.selectpicker('refresh');
        } else {
            console.error('selectpicker fonksiyonu mevcut değil.');
        }
    } catch (error) {
        console.error(`Dropdown (${selectId}) doldurulurken hata:`, error);
    }
}


async function saveConfig() {
	const referenceCode = document.getElementById('referenceCodeInput').value.trim();
    const cartItemId = document.getElementById('configCartItemId').value;
    const customCode = document.getElementById('customCodeInput').value.trim();
    const customName = document.getElementById('customNameInput').value.trim();
    const modelKod = document.getElementById('modelSelect').value;
    const materyalKod = document.getElementById('materyalSelect').value;
    const desenKod = document.getElementById('desenSelect').value;
    const lamineKod = document.getElementById('lamineSelect').value;
    const aksesuar1Kod = document.getElementById('aksesuar1Select').value;
    const aksesuar2Kod = document.getElementById('aksesuar2Select').value;
    const aksesuar3Kod = document.getElementById('aksesuar3Select').value;
    const ebatKod = document.getElementById('ebatSelect').value;
    const renkKod = document.getElementById('renkSelect').value;
	const ayakKod = document.getElementById('ayakSelect').value;

    const payload = {
		referenceCode,
        customCode,
        customName,
        modelKod: modelKod || null,
        materyalKod: materyalKod || null,
        desenKod: desenKod || null,
        lamineKod: lamineKod || null,
        aksesuar1Kod: aksesuar1Kod || null,
        aksesuar2Kod: aksesuar2Kod || null,
        aksesuar3Kod: aksesuar3Kod || null,
        ebatKod: ebatKod || null,
        renkKod: renkKod || null,
		ayakKod: ayakKod || null
		
    };

    try {
        const response = await fetch(`/api/cart-items/${cartItemId}/config`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload)
        });

        if (!response.ok) {
            throw new Error(`HTTP hata kodu: ${response.status}`);
        }

        const json = await response.json();

        if (json.success) {
            alert('Konfigürasyon başarıyla kaydedildi.');
            $('#configureModal').modal('hide');
            // Sepet içeriğini güncellemek için gerekirse yeniden yükleyebilirsiniz
            if (typeof showCartContents === 'function') {
                showCartContents();
            }
        } else {
            alert(`Hata: ${json.message}`);
        }
    } catch (error) {
        console.error('Konfigürasyon kaydedilirken hata:', error);
        alert(`Konfigürasyon kaydedilirken bir hata oluştu: ${error.message}`);
    }
}



	</script>
	<script>
document.getElementById('loginForm').addEventListener('submit', async (e) => {
  e.preventDefault();

  const username = document.getElementById('username').value.trim();
  const password = document.getElementById('password').value.trim();

  try {
    const res = await fetch('/auth/login', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ username, password })
    });
    const data = await res.json();

    if (!data.success) {
      return alert(data.message || 'Geçersiz kullanıcı adı veya şifre.');
    }

    // 1) LocalStorage’a oturum bilgisini kaydet
    localStorage.setItem('username',         data.user.username);
    localStorage.setItem('userId',           data.user.id);
    localStorage.setItem('isAdmin',          data.user.isAdmin ? "true" : "false");
    localStorage.setItem('isCampaignAdmin',  data.user.isCampaignAdmin ? "true" : "false");
    localStorage.setItem('token',            data.token);

    // 2) Modal’ı kapat
    $('#loginModal').modal('hide');

    // 3) Anında UI’ı güncelle
    updateAuthUI();

  } catch (err) {
    console.error('Login hatası:', err);
    alert('Sunucuya ulaşılamadı.');
  }
});


// Sayfa yüklendiğinde kullanıcı adı otomatik yazılsın
window.addEventListener('DOMContentLoaded', () => {
  const username = localStorage.getItem('username');
  if (username) {
    document.getElementById('usernameDisplay').textContent = username;
  }
});

function updateAuthUI() {
  const authButton      = document.getElementById("authButton");
  const authIcon        = document.getElementById("authIcon");
  const welcomeMessage  = document.getElementById("welcomeMessage");
  const usernameDisplay = document.getElementById("usernameDisplay");
  const adminTabs       = document.getElementById("adminTabs");
  const campaignMenu    = document.getElementById("campaignMenu");

  const username        = localStorage.getItem("username");
  const isAdmin         = localStorage.getItem("isAdmin") === "true";
  const isCampaignAdmin = localStorage.getItem("isCampaignAdmin") === "true";

  // Kampanya menüsü (inline display)
  campaignMenu.style.display = isCampaignAdmin ? "" : "none";

  if (username) {
    // — Oturum Açık —
    authIcon.className = "fas fa-sign-out-alt";
    authButton.title   = "Çıkış Yap";
    authButton.removeAttribute("data-toggle");
    authButton.removeAttribute("data-target");

    // Hoş geldin mesajını **inline** olarak göster (inline-stylde tanımlı margin vs. kalır)
    welcomeMessage.style.display = "";

    usernameDisplay.textContent = username;

    // Admin sekmelerini göster
		if (isAdmin) {
            adminTabs.style.display = "flex"; // Sekmeleri görünür yap
        } else {
            adminTabs.style.display = "none"; // Normal kullanıcı sekmeleri görmesin
        }

    authButton.onclick = () => {
      localStorage.clear();
      updateAuthUI();
	  
    };
  } else {
    // — Oturum Kapalı —
    authIcon.className = "fas fa-user";
    authButton.title   = "Giriş Yap";
    authButton.setAttribute("data-toggle", "modal");
    authButton.setAttribute("data-target", "#loginModal");

    // Tüm mesaj/tabları inline gizle
    welcomeMessage.style.display = "none";
    adminTabs.style.display      = "none";

    authButton.onclick = null;
  }
}

// Sayfa ilk yüklendiğinde ve login/logout sonrası çağırın
document.addEventListener("DOMContentLoaded", updateAuthUI);


document.addEventListener("DOMContentLoaded", () => {
    const authButton = document.getElementById("authButton");
    const authIcon = document.getElementById("authIcon");
    const usernameDisplay = document.getElementById("usernameDisplay");
    const welcomeMessage = document.getElementById("welcomeMessage");
	const adminTabs = document.getElementById("adminTabs"); // Admin sekmeleri

    const username = localStorage.getItem("username"); // Kullanıcı adını al
	const userId = localStorage.getItem("userId"); // Kullanıcı adını al
	const isAdmin = localStorage.getItem("isAdmin") === "true"; // Admin kontrolü
	const isCampaignAdmin = localStorage.getItem("isCampaignAdmin") === "true"; // Kampanya Admin kontrolü
    //Kampanya Yöneticisi kontrolü ile Kampanya Yönetim Paneli Menü Gösterimi"	
	if (isCampaignAdmin) {
	  document.getElementById('campaignMenu').style.display = 'block';
	} else {
	  document.getElementById('campaignMenu').style.display = 'none';
	}

    if (username) {
        // Kullanıcı giriş yapmış
        authIcon.className = "fas fa-sign-out-alt"; // Çıkış ikonu
        authButton.setAttribute("title", "Çıkış Yap"); // Çıkış için ipucu metni
        authButton.removeAttribute("data-toggle"); // Modal tetikleyici kaldırılır
        authButton.removeAttribute("data-target");

        // Hoş geldin mesajını göster
        welcomeMessage.style.display = "inline";
        usernameDisplay.textContent = username;
		
		// **Admin Kullanıcıysa Sekmeleri Aç**
        if (isAdmin) {
            adminTabs.style.display = "flex"; // Sekmeleri görünür yap
        } else {
            adminTabs.style.display = "none"; // Normal kullanıcı sekmeleri görmesin
        }

        // Çıkış işlemini bağla
        authButton.onclick = () => {
            localStorage.removeItem("username"); // Giriş bilgisini temizle
			localStorage.removeItem("userId"); // Kullanıcı kimliğini temizle
			localStorage.removeItem("isAdmin"); // Admin bilgisi de sıfırlansın
			localStorage.removeItem("isCampaignAdmin"); // Admin bilgisi de sıfırlansın
			localStorage.removeItem("activeCartId"); // Aktif sepet ID'sini temizle (Eğer sepet bu ID ile çağrılıyorsa)
			// Eğer başka bir kimlik bilgisi saklanıyorsa, bunları da sıfırlayın
			sessionStorage.clear(); // Tüm oturum bilgilerini temizle

            // Sayfayı yenileyerek her şeyi sıfırla
            location.reload(); // Sayfayı yenile
        };
    } else {
        // Kullanıcı giriş yapmamış
        authIcon.className = "fas fa-user"; // Giriş ikonu
        authButton.setAttribute("title", "Giriş Yap");
        authButton.setAttribute("data-toggle", "modal"); // Giriş modali tetikleyici
        authButton.setAttribute("data-target", "#loginModal");

        // Hoş geldin mesajını gizle
        welcomeMessage.style.display = "none";

        // Giriş için modal açma davranışını koru
        authButton.onclick = null; // Çıkış işlemini kaldır
    }
});




	</script>
	<script>
// Dinamik Menü Doldurma Fonksiyonu
const populateMenus = async () => {
  try {
    const response = await fetch('/api/menu-data'); // Menü verilerini çeken API
    if (!response.ok) throw new Error('Menü verisi alınamadı.');
    const menuData = await response.json();

    // Ürünler Menüsü
    const urunlerDropdown = document.getElementById('urunlerDropdown');
    if (urunlerDropdown) {
      urunlerDropdown.innerHTML = ""; // Eski içeriği temizle

      // RAPOR ana öğesi: dropdown-submenu olarak oluşturuluyor
      const raporLi = document.createElement("li");
      raporLi.className = "dropdown-submenu";
      
      const raporLink = document.createElement("a");
      raporLink.className = "dropdown-item";
      raporLink.href = "#";
      raporLink.textContent = "RAPORLAR";
      raporLi.appendChild(raporLink);
      
      // RAPOR alt menüsü: UL oluşturuyoruz
      const raporSubmenu = document.createElement("ul");
      raporSubmenu.className = "dropdown-menu";
      
      // "ÖZET" öğesi ekle
      const ozetLi = document.createElement("li");
      const ozetLink = document.createElement("a");
      ozetLink.className = "dropdown-item";
      ozetLink.href = "#";
      ozetLink.textContent = "ÖZET";
      // Tıklandığında yalnızca loadOzetReport çağrılacak, diğer eventler durdurulacak.
      ozetLink.addEventListener("click", (event) => {
          event.preventDefault();
          event.stopPropagation();
          loadOzetReport();
      });
      ozetLi.appendChild(ozetLink);
      raporSubmenu.appendChild(ozetLi);
      
      raporLi.appendChild(raporSubmenu);
      urunlerDropdown.appendChild(raporLi);
	  
	  // 🔥 YENİ: "ÖZET MODEL" öğesi
      const ozetModelLi = document.createElement("li");
      const ozetModelLink = document.createElement("a");
      ozetModelLink.className = "dropdown-item";
      ozetModelLink.href = "#";
      ozetModelLink.textContent = "ÖZET MODEL";
      ozetModelLink.addEventListener("click", (event) => {
        event.preventDefault();
        event.stopPropagation();
        loadOzetModelReport();
      });
      ozetModelLi.appendChild(ozetModelLink);
      raporSubmenu.appendChild(ozetModelLi);

      raporLi.appendChild(raporSubmenu);
      urunlerDropdown.appendChild(raporLi);

	  // 🔥 YENİ: "DETAY MODEL" öğesi
      const detayModelLi = document.createElement("li");
      const detayModelLink = document.createElement("a");
      detayModelLink.className = "dropdown-item";
      detayModelLink.href = "#";
      detayModelLink.textContent = "DETAY MODEL";
      detayModelLink.addEventListener("click", (event) => {
        event.preventDefault();
        event.stopPropagation();
        loadDetayModelReport();
      });
      detayModelLi.appendChild(detayModelLink);
      raporSubmenu.appendChild(detayModelLi);

      raporLi.appendChild(raporSubmenu);
      urunlerDropdown.appendChild(raporLi);



      // RAPOR grubundan sonra görsel ayırıcı ekle
      const divider = document.createElement("div");
      divider.className = "dropdown-divider";
      urunlerDropdown.appendChild(divider);

      // BASAMAK2 kategorilerini alfabetik sırayla al ve `null` değerleri filtrele
      const sortedBasamak2 = Object.keys(menuData)
          .filter(basamak2 => basamak2 && basamak2.trim() !== "")
          .sort((a, b) => a.localeCompare(b, 'tr'));

      // Alfabetik sıraya göre BASAMAK2 kategorilerini ekle
      sortedBasamak2.forEach(basamak2 => {
          // Ana kategori için bir menü başlığı oluştur
          const categoryLi = document.createElement('li');
          categoryLi.className = 'dropdown-submenu';

          // Ana kategoriye `data-basamak2` ekle
          categoryLi.innerHTML = `<a class="dropdown-item" href="#" data-basamak2="${basamak2}">${basamak2}</a>`;

          // BASAMAK4 alt kategorilerini alfabetik sırayla al ve `null` değerleri filtrele
          const sortedBasamak4List = (menuData[basamak2] || [])
              .filter(basamak4 => basamak4 && basamak4.trim() !== "")
              .sort((a, b) => a.localeCompare(b, 'tr'));

          // Alt kategori menüsünü oluştur
          if (sortedBasamak4List.length > 0) {
              const subMenuUl = document.createElement('ul');
              subMenuUl.className = 'dropdown-menu';

              sortedBasamak4List.forEach(basamak4 => {
                  const subMenuLi = document.createElement('li');
                  subMenuLi.innerHTML = `<a class="dropdown-item" href="#" data-basamak2="${basamak2}" data-basamak4="${basamak4}">${basamak4}</a>`;
                  subMenuUl.appendChild(subMenuLi);
              });

              categoryLi.appendChild(subMenuUl);
          }

          urunlerDropdown.appendChild(categoryLi);
      });
    }
  } catch (error) {
    console.error('Menü doldurma hatası:', error);
  }
};

//Konseptler Menüsünü Oluştur.
const loadConceptsMenu = async () => {
  try {
    const response = await fetch("http://192.168.30.4:3000/concepts");
    if (!response.ok) throw new Error("Konseptler alınamadı.");
    
    const concepts = await response.json();
    const menu = document.getElementById("conceptsDropdown");
    menu.innerHTML = ""; // Önce menüyü temizle

    // RAPOR ana öğesi: dropdown-submenu olarak oluşturuluyor
    const raporLi = document.createElement("li");
    raporLi.className = "dropdown-submenu";
    
    const raporLink = document.createElement("a");
    raporLink.className = "dropdown-item";
    raporLink.href = "#";
    raporLink.textContent = "RAPORLAR";
    raporLi.appendChild(raporLink);
    
    // RAPOR alt menüsü: UL oluşturuyoruz
    const raporSubmenu = document.createElement("ul");
    raporSubmenu.className = "dropdown-menu";
    
    // "ÖZET" öğesi ekle
    const ozetLi = document.createElement("li");
    const ozetLink = document.createElement("a");
    ozetLink.className = "dropdown-item";
    ozetLink.href = "#";
    ozetLink.textContent = "ÖZET";
    ozetLink.addEventListener("click", () => loadConceptSummaryReport());
    ozetLi.appendChild(ozetLink);
    raporSubmenu.appendChild(ozetLi);
    
        
    raporLi.appendChild(raporSubmenu);
    menu.appendChild(raporLi);

    // Menüde okunurluğu artırmak için görsel ayırıcı ekleyelim
    const divider = document.createElement("div");
    divider.className = "dropdown-divider"; // Bootstrap sınıfı, yatay çizgi oluşturur
    menu.appendChild(divider);

    // Devamında mevcut konsept alanları ekleniyor
    const conceptAreas = [...new Set(concepts.map(c => (c.CONCEPT_AREA || "Diğer").trim()))]
                          .sort((a, b) => a.localeCompare(b, 'tr', { sensitivity: 'base' }));
    
    conceptAreas.forEach(area => {
      const li = document.createElement("li");
      li.className = "dropdown-submenu";
      
      const areaLink = document.createElement("a");
      areaLink.className = "dropdown-item";
      areaLink.href = "#";
      areaLink.textContent = area;
      li.appendChild(areaLink);

      const subMenu = document.createElement("ul");
      subMenu.className = "dropdown-menu";
      
      const areaConcepts = concepts
        .filter(c => (c.CONCEPT_AREA || "Diğer").trim() === area)
        .sort((a, b) =>
          a.CUSTOMER_NAME.localeCompare(b.CUSTOMER_NAME, 'tr', { sensitivity: 'base' })
        );
      
      areaConcepts.forEach(concept => {
        const subLi = document.createElement("li");
        const conceptLink = document.createElement("a");
        conceptLink.className = "dropdown-item";
        conceptLink.href = "#";
        conceptLink.textContent = concept.CUSTOMER_NAME;
        conceptLink.addEventListener("click", () => loadProductsByConcept(concept.ID));
        subLi.appendChild(conceptLink);
        subMenu.appendChild(subLi);
      });

      li.appendChild(subMenu);
      menu.appendChild(li);
    });
  } catch (error) {
    console.error("Konseptler yüklenirken hata:", error);
  }
};





// Sayfa yüklendiğinde menüleri doldur
document.addEventListener('DOMContentLoaded', populateMenus);
document.addEventListener("DOMContentLoaded", loadConceptsMenu);

const loadOzetModelReport = async (language = "tr") => {
  try {
    const productContainer = document.getElementById("product-container");
    if (productContainer) productContainer.style.display = "none";

    const initialImageContainer = document.getElementById("initialImageContainer");
    if (initialImageContainer) initialImageContainer.style.display = "none";
	
	const stokKartiContainer = document.getElementById("stokKartiContainer");
    if (stokKartiContainer) stokKartiContainer.style.display = "none";

    const conceptContainer = document.getElementById("concept-products-container");
    if (conceptContainer) {
      conceptContainer.style.display = "flex";
      conceptContainer.innerHTML = "";
    }

    const response = await fetch("/api/ozet-model-report");
    if (!response.ok) throw new Error("Model bazlı özet raporu alınamadı.");
    const result = await response.json();
    if (!result.success) throw new Error(result.message);
    const data = result.data;

    const grouped = {};
    const seenB2 = new Set();
    const orderedB2 = [];

    data.forEach(item => {
      const b2 = item.BASAMAK2 || "DIGER";
      const b4 = item.BASAMAK4 || "DIGER";
      if (!grouped[b2]) {
        grouped[b2] = {};
        if (!seenB2.has(b2)) {
          orderedB2.push(b2);
          seenB2.add(b2);
        }
      }
      if (!grouped[b2][b4]) grouped[b2][b4] = [];
      grouped[b2][b4].push(item);
    });

    let finalHTML = `
      <style>
        @media print {
          @page { size: A4 portrait; margin: 5mm; }
          body { -webkit-print-color-adjust: exact; }
          #printButton, #exportButton, #toggle100Button { display: none; }
        }
        table { width: 95%; border-collapse: collapse; }
        th, td { padding: 5px; border: 1px solid #ccc; }
        .text-right { text-align: right; }
        .highlight-100 { color: red; font-weight: bold; }
        .hide-100 { display: none !important; }
      </style>
      <div style="max-width: 95%; margin-top: 20px; margin-left: auto; margin-right: auto; font-size: 12px;">
        <div style="display: flex; justify-content: space-between; align-items: center;">
          <h4 style="text-align: center; margin-bottom: 15px;">
            ${language === "tr" ? "Model Bazlı Ürün Özet Raporu" : "Model Summary Report"}
          </h4>
          <div>
            <button id="printButton" onclick="printConceptContainer()" class="btn btn-primary">
              <span style="margin-right: 5px;">🖨</span>Yazdır
            </button>
            <button id="exportButton" onclick="exportModelSummaryReportToExcel()" class="btn btn-success">
              <span style="margin-right: 5px;">📊</span>Excel'e Aktar
            </button>
            <button id="toggle100Button" onclick="toggleHundredRows()" class="btn btn-secondary" style="margin-left: 5px;">
              🔁 %100 Olanları Gizle
            </button>
          </div>
        </div>
        <table id="urunozetmodel" class="table table-bordered table-striped">
          <thead>
            <tr>
              <th>S</th>
              <th>BASAMAK4</th>
              <th>MODEL</th>
              <th>Toplam Ürün</th>
              <th>Konsept Ürün</th>
              <th>Konsept Dışı</th>
              <th>Oran (%)</th>
            </tr>
          </thead>
          <tbody>
    `;

    let grandHom = 0;
    let grandKonsept = 0;
    let rowCounter = 1;

    orderedB2.forEach(basamak2 => {
      const basamak4Map = grouped[basamak2];
      const basamak4Keys = Object.keys(basamak4Map).sort((a, b) =>
        a.localeCompare(b, 'tr', { sensitivity: 'base' })
      );

      let b2Rows = "";
      let b2TotalHom = 0;
      let b2TotalKonsept = 0;
      let isB2Fully100 = true;

      basamak4Keys.forEach(basamak4 => {
        const items = basamak4Map[basamak4].sort((a, b) =>
          (a.MODEL || "").localeCompare(b.MODEL || "", 'tr')
        );

        let b4Rows = "";
        let b4TotalHom = 0;
        let b4TotalKonsept = 0;
        let isB4Fully100 = true;

        items.forEach(item => {
          const ratioDisplay = item.Ratio ? item.Ratio.toString().replace('.', ',') : "0%";
          const is100 = ratioDisplay === "100%" || ratioDisplay === "100,00%";
          if (!is100) isB4Fully100 = false;

          b4Rows += `
            <tr class="${is100 ? 'ratio-100-row' : ''}">
              <td>${rowCounter++}</td>
              <td>${item.BASAMAK4}</td>
              <td>${item.MODEL || ""}</td>
              <td class="text-right">${item.HomKodSayisi}</td>
              <td class="text-right">${item.KonseptProductCount}</td>
              <td class="text-right">${item.HomKodSayisi - item.KonseptProductCount}</td>
              <td class="text-right ${is100 ? 'highlight-100' : ''}">${ratioDisplay}</td>
            </tr>
          `;

          b4TotalHom += Number(item.HomKodSayisi) || 0;
          b4TotalKonsept += Number(item.KonseptProductCount) || 0;
        });

        const b4Ratio = b4TotalHom > 0
          ? new Intl.NumberFormat('tr-TR', { minimumFractionDigits: 2, maximumFractionDigits: 2 }).format((b4TotalKonsept / b4TotalHom) * 100) + "%"
          : "0%";

        b2TotalHom += b4TotalHom;
        b2TotalKonsept += b4TotalKonsept;
        if (!isB4Fully100) isB2Fully100 = false;

        b2Rows += `
          <tr style="background-color:#f9f9f9;" class="${isB4Fully100 ? 'ratio-100-group' : ''}">
            <td colspan="7" style="font-weight:bold;">📂 ${basamak4}</td>
          </tr>
          ${b4Rows}
          <tr class="${isB4Fully100 ? 'ratio-100-group' : ''}" style="background-color:#f0f0f0; font-weight:bold;">
            <td colspan="3" class="text-right">Alt Toplam (${basamak4}):</td>
            <td class="text-right">${b4TotalHom}</td>
            <td class="text-right">${b4TotalKonsept}</td>
            <td class="text-right">${b4TotalHom - b4TotalKonsept}</td>
            <td class="text-right">${b4Ratio}</td>
          </tr>
        `;
      });

      const b2Ratio = b2TotalHom > 0
        ? new Intl.NumberFormat('tr-TR', { minimumFractionDigits: 2, maximumFractionDigits: 2 }).format((b2TotalKonsept / b2TotalHom) * 100) + "%"
        : "0%";

      finalHTML += `
        <tr class="${isB2Fully100 ? 'ratio-100-group' : ''}" style="background-color:#e6e6e6;">
          <td colspan="7" style="font-weight:bold; text-align:left;">${basamak2}</td>
        </tr>
        ${b2Rows}
        <tr class="${isB2Fully100 ? 'ratio-100-group' : ''}" style="background-color:#d9edf7; font-weight:bold;">
          <td colspan="3" class="text-right">Alt Toplam (${basamak2}):</td>
          <td class="text-right">${b2TotalHom}</td>
          <td class="text-right">${b2TotalKonsept}</td>
          <td class="text-right">${b2TotalHom - b2TotalKonsept}</td>
          <td class="text-right">${b2Ratio}</td>
        </tr>
      `;

      grandHom += b2TotalHom;
      grandKonsept += b2TotalKonsept;
    });

    const grandRatio = grandHom > 0
      ? new Intl.NumberFormat('tr-TR', { minimumFractionDigits: 2, maximumFractionDigits: 2 }).format((grandKonsept / grandHom) * 100) + "%"
      : "0%";

    finalHTML += `
      <tr style="font-weight:bold; background-color:#dcdcdc;">
        <td colspan="3" class="text-right">Genel Toplam:</td>
        <td class="text-right">${grandHom}</td>
        <td class="text-right">${grandKonsept}</td>
        <td class="text-right">${grandHom - grandKonsept}</td>
        <td class="text-right">${grandRatio}</td>
      </tr>
      </tbody>
      </table>
      </div>
    `;

    if (conceptContainer) {
      conceptContainer.innerHTML = finalHTML;
    }

    createStickyHeaderBarY();
  } catch (error) {
    console.error("Model özet raporu yüklenirken hata:", error);
    alert("Model özet raporu yüklenirken bir hata oluştu: " + error.message);
  }
};

// ✅ %100 Oranları Gizle/Göster Butonu
let hide100 = false;
function toggleHundredRows() {
  hide100 = !hide100;
  
  // Toggle buton metnini güncelleyelim:
  const btn = document.getElementById("toggle100Button");
  if (btn) {
    btn.textContent = hide100 ? "🔁 %100 Olanları Göster" : "🔁 %100 Olanları Gizle";
  }
  
  // 1. Veri satırlarını kontrol edelim: 
  // "data-row" sınıfına sahip satırlar arasında, eğer satır "ratio-100-row" sınıfına sahipse, toggle durumuna göre göster/gizle.
  const dataRows = document.querySelectorAll("#urundetaymodel tbody tr.data-row");
  dataRows.forEach(row => {
    if (row.classList.contains("ratio-100-row")) {
      row.style.display = hide100 ? "none" : "";
    }
  });
  
  // 2. Her grup için (group-header ve group-subtotal), o grupta görünür data satırı kalıp kalmadığını kontrol edelim.
  // Grup başlık satırları "group-header", alt toplam satırları "group-subtotal".
  const groupHeaders = document.querySelectorAll("#urundetaymodel tbody tr.group-header");
  groupHeaders.forEach(headerRow => {
    let visibleDataFound = false;
    let next = headerRow.nextElementSibling;
    let groupSubtotalRow = null;
    // Grup satırları, bir sonraki "group-header" gelene kadar devam eder.
    while (next && !next.classList.contains("group-header")) {
      if (next.classList.contains("group-subtotal")) {
        groupSubtotalRow = next;
        break;
      }
      if (next.classList.contains("data-row") && next.style.display !== "none") {
        visibleDataFound = true;
        break;
      }
      next = next.nextElementSibling;
    }
    // Eğer o grupta hiçbir veri satırı görünmüyorsa, grup başlığı ve alt toplam gizlensin.
    headerRow.style.display = visibleDataFound ? "" : "none";
    if (groupSubtotalRow) {
      groupSubtotalRow.style.display = visibleDataFound ? "" : "none";
    }
  });
}


//Özet model tablosunu excele Aktar
function exportModelSummaryReportToExcel() {
  const table = document.getElementById("urunozetmodel");
  if (!table) {
    alert("Tablo bulunamadı!");
    return;
  }

  const wb = XLSX.utils.book_new();
  const ws_data = [];

  // Başlık satırı
  ws_data.push([
    "S", "BASAMAK4", "MODEL", "Toplam Ürün", "Konsept Ürün", "Konsept Dışı", "Oran (%)"
  ]);

  let rowIndex = 1;
  let grandHom = 0;
  let grandKonsept = 0;

  const visibleRows = Array.from(table.querySelectorAll("tbody > tr")).filter(tr => {
    return tr.offsetParent !== null && !tr.classList.contains("hide-100");
  });

  for (const tr of visibleRows) {
    const tds = tr.querySelectorAll("td");
    if (tds.length === 7) {
      const b4 = tds[1].innerText.trim();
      const model = tds[2].innerText.trim();
      const hom = parseInt(tds[3].innerText.replace(/\./g, '')) || 0;
      const konsept = parseInt(tds[4].innerText.replace(/\./g, '')) || 0;
      const oran = tds[6].innerText.trim();

      ws_data.push([rowIndex++, b4, model, hom, konsept, hom - konsept, oran]);
      grandHom += hom;
      grandKonsept += konsept;
    }
  }

  // Genel Toplam
  const grandRatio = grandHom > 0 ? ((grandKonsept / grandHom) * 100).toFixed(2) + "%" : "0%";
  ws_data.push(["", "", "Genel Toplam", grandHom, grandKonsept, grandHom - grandKonsept, grandRatio]);

  const ws = XLSX.utils.aoa_to_sheet(ws_data);
  XLSX.utils.book_append_sheet(wb, ws, "Model Raporu");
  XLSX.writeFile(wb, "model-ozet-raporu.xlsx");
}
//Kategori Kampanyaları
// Global mapping nesnesi
let categoryCampaignMap = {};
let productCampaignMap  = {};


// Bu fonksiyon, /api/category-campaigns endpoint’inden kategori kampanya kayıtlarını çekip,
// geçerli tarih aralığında olan ve aynı kategori için en yüksek indirim oranına sahip kampanyayı mapping’e atar.
async function loadCategoryCampaignMapping() {
  try {
    const response = await fetch('/api/category-campaigns');
    const result = await response.json();
    if (result.success && result.data) {
      result.data.forEach(item => {
        const cat = item.categoryName; // Örneğin "AYDINLATMA"
        const currentDate = new Date();
        const campStart = new Date(item.StartDate);
        const campEnd = new Date(item.EndDate);
        // Sadece geçerli tarih aralığındaki kayıtları işleyelim.
        if (currentDate >= campStart && currentDate <= campEnd) {
          // Eğer kategori için zaten bir kayıt varsa, DiscountValue'ya göre karşılaştırıyoruz.
          if (categoryCampaignMap[cat]) {
            // Eski kaydın tam bilgilerini de saklıyoruz.
            let existing = categoryCampaignMap[cat + "_full"];
            if (!existing || (Number(item.DiscountValue) > Number(existing.DiscountValue))) {
              categoryCampaignMap[cat] = item.CampaignName;
              categoryCampaignMap[cat + "_full"] = item;
            }
          } else {
            categoryCampaignMap[cat] = item.CampaignName;
            categoryCampaignMap[cat + "_full"] = item;
          }
        }
      });
    }
    console.log("Kategori kampanya mapping:", categoryCampaignMap);
  } catch (error) {
    console.error("Mapping yüklenirken hata:", error);
  }
}

// --- Ürün bazlı kampanya mapping ---
async function loadProductCampaignMapping() {
  productCampaignMap = {};
  try {
    const resp = await fetch('/api/product-campaigns');
    const json = await resp.json();
    if (json.success && Array.isArray(json.data)) {
      json.data.forEach(item => {
        const kod = item.KOD?.trim();
        if (kod) productCampaignMap[kod] = Number(item.DiscountValue);
      });
    }
  } catch (e) {
    console.error("Ürün kampanya mapping yüklenirken hata:", e);
  }
}

function getCategoryCampaignLabel(categoryName) {
  const label = categoryCampaignMap?.[categoryName];
  return label ? `<span class="badge badge-warning ml-2">${label}</span>` : "";
}

function getProductCampaignLabel(kod) {
  const discount = productCampaignMap?.[kod];
  return discount ? `<div class="etiket-img">%${discount}</div>` : "";
}



// Ürün Detay Rapor
const loadDetayModelReport = async (language = "tr") => {
  try {
    // Container ayarları
    const productContainer = document.getElementById("product-container");
    if (productContainer) productContainer.style.display = "none";
    
    const initialImageContainer = document.getElementById("initialImageContainer");
    if (initialImageContainer) initialImageContainer.style.display = "none";
    
    const stokKartiContainer = document.getElementById("stokKartiContainer");
    if (stokKartiContainer) stokKartiContainer.style.display = "none";
    
    const conceptContainer = document.getElementById("concept-products-container");
    if (conceptContainer) {
      conceptContainer.style.display = "flex";
      conceptContainer.innerHTML = "";
    }
  
    // Sayı formatlama fonksiyonu (ondalık kısmı sıfır)
    const formatNumber = (value) => {
      const parts = Number(value).toFixed(0).split(".");
      parts[0] = parts[0].replace(/\B(?=(\d{3})+(?!\d))/g, ".");
      return parts.join(",");
    };

    // Önce kategori kampanya mapping’ini yükleyelim
    await loadCategoryCampaignMapping();
	await loadProductCampaignMapping();
    console.log("Kategori Mapping", categoryCampaignMap);

    // Model detay rapor verisini çekiyoruz
    const response = await fetch("/api/detay-model-report");
    if (!response.ok) throw new Error("Model bazlı özet raporu alınamadı.");
    const result = await response.json();
    if (!result.success) throw new Error(result.message);
    const data = result.data;

    // Veriyi BASAMAK2 ve BASAMAK4'ye göre grupluyoruz
    const grouped = {};
    const seenB2 = new Set();
    const orderedB2 = [];
    data.forEach(item => {
      const b2 = item.BASAMAK2 || "DIGER";
      const b4 = item.BASAMAK4 || "DIGER";
      if (!grouped[b2]) {
        grouped[b2] = {};
        if (!seenB2.has(b2)) {
          orderedB2.push(b2);
          seenB2.add(b2);
        }
      }
      if (!grouped[b2][b4]) grouped[b2][b4] = [];
      grouped[b2][b4].push(item);
    });

    let finalHTML = `
      <style>
        @media print {
          @page { size: A4 portrait; margin: 5mm; }
          body { -webkit-print-color-adjust: exact; }
          #printButton, #exportButton, #toggle100Button, #toggleZeroButton, #basamak2Filter, #basamak4Filter { display: none; }
        }
        table { width: 95%; border-collapse: collapse; }
        th, td { padding: 5px; border: 1px solid #ccc; }
        .text-right { text-align: right; }
        .highlight-100 { color: red; font-weight: bold; }
        .hide-100 { display: none !important; }
        .kod-popup {
          display: none;
          position: absolute;
          background-color: #fff;
          border: 1px solid #ccc;
          padding: 8px;
          box-shadow: 2px 2px 6px rgba(0,0,0,0.2);
          z-index: 1000;
          font-size: 12px;
          max-width: 250px;
        }
		.badge-info{background:#ff0000;color:#fff;padding:2px 4px;border-radius:3px;font-size:10px;align:right;}
      </style>
      <div style="max-width: 95%; margin: 20px auto; font-size: 12px;">
        <div style="display: flex; flex-direction: column; align-items: center; margin-bottom:15px;">
          <h4 style="text-align: center; margin-bottom: 15px;">
            ${language === "tr" ? "Model Bazlı Ürün Detay Raporu" : "Model Summary Report"}
          </h4>
          <!-- Filtre Dropdownları -->
          <div id="filterContainer" style="margin-bottom: 15px; text-align:center;">
            <select id="basamak2Filter" class="selectpicker" data-live-search="true" title="BASAMAK2 Seçiniz">
              <option value="">Seçiniz</option>
            </select>
            <select id="basamak4Filter" class="selectpicker" data-live-search="true" title="BASAMAK4 Seçiniz" style="margin-left: 10px;">
              <option value="">Seçiniz</option>
            </select>
          </div>
        </div>
        <div style="margin-bottom: 15px;">
          <button id="printButton" onclick="printConceptContainer()" class="btn btn-primary">
            <span style="margin-right: 5px;">🖨</span>Yazdır
          </button>
          <button id="exportButton" onclick="exportModelDetailReportToExcel()" class="btn btn-success">
            <span style="margin-right: 5px;">📊</span>Excel'e Aktar
          </button>
          <button id="toggle100Button" onclick="toggleHundredRows()" class="btn btn-secondary" style="margin-left: 5px;">
            🔁 %100 Olanları Gizle
          </button>
          <button id="toggleZeroButton" onclick="toggleZeroPriceRows()" class="btn btn-secondary" style="margin-left: 5px;">
            🔁 Sıfır Fiyatlıları Göster
          </button>
        </div>
        <table id="urundetaymodel" class="table table-bordered table-striped">
          <thead>
            <tr>
              <th>S</th>
              <th>BASAMAK4</th>
              <th>MODEL</th>
              <th>KOD</th>
              <th>FIYAT TL</th>
              <th>FIYAT USD</th>
              <th>Stok</th>
              <th>Konsept</th>
              <th>Konsept Dışı</th>
              <th>Oran (%)</th>
              <th>Sepet</th>
            </tr>
          </thead>`;
      
    let grandHom = 0;
    let grandKonsept = 0;
    let rowCounter = 1;
    
    orderedB2.forEach(b2 => {
      finalHTML += `<tbody class="basamak2-group" data-value="${b2}">
          <tr class="group-header group-header-b2" data-value="${b2}" style="background-color:#e6e6e6; font-weight:bold; text-align:left;">
              <td colspan="11">${b2}</td>
          </tr>`;
      const b2Groups = grouped[b2];
      const b2GroupKeys = Object.keys(b2Groups).sort((a, b) => a.localeCompare(b, 'tr', { sensitivity: 'base' }));
      let b2TotalHom = 0;
      let b2TotalKonsept = 0;
      b2Groups && b2GroupKeys.forEach(b4 => {
        let b4TotalHom = 0;
        let b4TotalKonsept = 0;
        let rowSection = "";
        b2Groups[b4].forEach(item => {
          const ratioDisplay = item.Ratio ? item.Ratio.toString().replace('.', ',') : "0%";
          const is100 = (ratioDisplay === "100%" || ratioDisplay === "100,00%");
          const priceStyle = Number(item.PRKTL) === 0 ? 'color:red; font-weight:bold;' : '';
          const usdStyle = Number(item.PRKUSD) === 0 ? 'color:red; font-weight:bold;' : '';
		  // Ürün kampanya badge
          const prodBadge = productCampaignMap[item.KOD]
            ? ` <span class="badge badge-info float-right">%
			${productCampaignMap[item.KOD]}</span>`
            : "";
          rowSection += `
            <tr class="data-row ${is100 ? 'ratio-100-row' : ''}" data-value="${b4}">
              <td>${rowCounter++}</td>
              <td>${item.BASAMAK4}</td>
              <td>${item.MODEL || ""}</td>
              <td class="kod-cell" data-kod="${item.KOD}">${item.KOD}${prodBadge}</td>
              <td class="text-right price-cell" data-price="${item.PRKTL}" style="${priceStyle}">${formatNumber(item.PRKTL)}</td>
              <td class="text-right" style="${usdStyle}">${formatNumber(item.PRKUSD)}</td>
              <td class="text-right">${item.HomKodSayisi}</td>
              <td class="text-right">${item.KonseptProductCount}</td>
              <td class="text-right">${item.HomKodSayisi - item.KonseptProductCount}</td>
              <td class="text-right ${is100 ? '' : 'highlight-100'}">${ratioDisplay}</td>
              <td class="text-center">
                  <button class="btn btn-sm btn-secondary" style="width:15px; height:15px;" onclick="addToCart('${item.KOD}')">
                    <i class="fas fa-shopping-basket"></i>
                  </button>
              </td>
            </tr>`;
          b4TotalHom += Number(item.HomKodSayisi) || 0;
          b4TotalKonsept += Number(item.KonseptProductCount) || 0;
        });
        const b4Ratio = b4TotalHom > 0 ? new Intl.NumberFormat('tr-TR', { minimumFractionDigits: 2, maximumFractionDigits: 2 }).format((b4TotalKonsept / b4TotalHom) * 100) + "%" : "0%";
        b2TotalHom += b4TotalHom;
        b2TotalKonsept += b4TotalKonsept;
        
        // Grup başlığı için kategori kampanya etiketi: BASAMAK4 değeri b4,
        // eğer mapping'te varsa (özellikle aktif kampanyalardan önce backend mapping'inde en iyi kampanya seçildiyse)
        let campaignTag = "";
        if (categoryCampaignMap && categoryCampaignMap[b4]) {
          campaignTag = `<span class="badge badge-warning" style="margin-left: 5px;">${categoryCampaignMap[b4]}</span>`;
        }
        
        finalHTML += `
          <tr class="group-header group-header-b4" data-value="${b4}" style="background-color:#f9f9f9; font-weight:bold;">
              <td colspan="11">📂 ${b4} ${campaignTag}</td>
          </tr>
          ${rowSection}
          <tr class="group-subtotal group-subtotal-b4" data-value="${b4}" style="background-color:#f0f0f0; font-weight:bold;">
              <td colspan="6" class="text-right">Alt Toplam (${b4}):</td>
              <td class="text-right">${b4TotalHom}</td>
              <td class="text-right">${b4TotalKonsept}</td>
              <td class="text-right">${b4TotalHom - b4TotalKonsept}</td>
              <td class="text-right">${b4Ratio}</td>
          </tr>
        `;
      });
      const b2Ratio = b2TotalHom > 0 ? new Intl.NumberFormat('tr-TR', { minimumFractionDigits: 2, maximumFractionDigits: 2 }).format((b2TotalKonsept / b2TotalHom) * 100) + "%" : "0%";
      finalHTML += `
          <tr class="group-subtotal group-subtotal-b2" data-value="${b2}" style="background-color:#d9edf7; font-weight:bold;">
              <td colspan="6" class="text-right">Alt Toplam (${b2}):</td>
              <td class="text-right">${b2TotalHom}</td>
              <td class="text-right">${b2TotalKonsept}</td>
              <td class="text-right">${b2TotalHom - b2TotalKonsept}</td>
              <td class="text-right">${b2Ratio}</td>
          </tr>
      </tbody>`;
      grandHom += b2TotalHom;
      grandKonsept += b2TotalKonsept;
    });
    
    const grandRatio = grandHom > 0 ? new Intl.NumberFormat('tr-TR', { minimumFractionDigits: 2, maximumFractionDigits: 2 }).format((grandKonsept / grandHom) * 100) + "%" : "0%";
    
    finalHTML += `
      <tbody>
        <tr style="font-weight:bold; background-color:#dcdcdc;">
            <td colspan="6" class="text-right">Genel Toplam:</td>
            <td class="text-right">${grandHom}</td>
            <td class="text-right">${grandKonsept}</td>
            <td class="text-right">${grandHom - grandKonsept}</td>
            <td class="text-right">${grandRatio}</td>
        </tr>
      </tbody>
      </table>
      </div>
      <!-- Popup container -->
      <div id="kodPopup" class="kod-popup"></div>
    `;
    
    if (conceptContainer) {
      conceptContainer.innerHTML = finalHTML;
    }
    
    createStickyHeaderBarY();
    
    // KOD hücresine tıklayınca popup açılması
    $(document).on("click", "#urundetaymodel .kod-cell", function(e) {
      try {
        const $target = $(this);
        const rect = this.getBoundingClientRect();
        const x = rect.right + window.scrollX + 10;
        const y = rect.top + window.scrollY;
        const kod = $target.data("kod");
        if (kod) {
          showKodPopup(kod, x, y);
        } else {
          console.warn("data-kod attribute boş veya tanımsız.");
        }
      } catch (err) {
        console.error("kod-cell tıklama eventinde hata:", err);
      }
    });
    
    $(document).on("click", function(e) {
      if (!$(e.target).closest(".kod-cell, #kodPopup").length) {
        hideKodPopup();
      }
    });
    
    // BASAMAK2 ve BASAMAK4 filtre dropdownları
    const $basamak2Filter = $("#basamak2Filter");
    $basamak2Filter.empty().append(`<option value="">Seçiniz</option>`);
    orderedB2.forEach(b2 => {
      $basamak2Filter.append(`<option value="${b2}">${b2}</option>`);
    });
    $basamak2Filter.selectpicker();
    
    const $basamak4Filter = $("#basamak4Filter");
    $basamak4Filter.empty().append(`<option value="">Seçiniz</option>`);
    $basamak4Filter.selectpicker();
    
    $basamak2Filter.on("changed.bs.select", function(e, clickedIndex, isSelected, previousValue) {
      const selectedB2 = $(this).val();
      if (!selectedB2) {
        $("tbody.basamak2-group").show();
      } else {
        $("tbody.basamak2-group").each(function() {
          const b2Value = $(this).data("value");
          $(this).toggle(b2Value === selectedB2);
        });
      }
      
      const basamak4Set = new Set();
      $("tbody.basamak2-group:visible").find("tr.group-header.group-header-b4").each(function() {
        basamak4Set.add($(this).data("value"));
      });
      $basamak4Filter.empty().append(`<option value="">Seçiniz</option>`);
      Array.from(basamak4Set).forEach(b4 => {
        $basamak4Filter.append(`<option value="${b4}">${b4}</option>`);
      });
      $basamak4Filter.selectpicker("refresh");
      $basamak4Filter.selectpicker("val", "");
    });
    
    $basamak4Filter.on("changed.bs.select", function(e, clickedIndex, isSelected, previousValue) {
      const selectedB4 = $(this).val();
      if (!selectedB4) {
        $("tbody.basamak2-group:visible").find("tr.group-header.group-header-b4").show();
        $("tbody.basamak2-group:visible").find("tr.group-subtotal.group-subtotal-b4").show();
        $("tbody.basamak2-group:visible").find("tr.data-row").show();
      } else {
        $("tbody.basamak2-group:visible").find("tr.group-header.group-header-b4").each(function() {
          const b4Value = $(this).data("value");
          $(this).toggle(b4Value === selectedB4);
        });
        $("tbody.basamak2-group:visible").find("tr.group-subtotal.group-subtotal-b4").each(function() {
          const b4Value = $(this).data("value");
          $(this).toggle(b4Value === selectedB4);
        });
        $("tbody.basamak2-group:visible").find("tr.data-row").each(function() {
          const b4Value = $(this).data("value");
          $(this).toggle(b4Value === selectedB4);
        });
      }
    });
    
    window.showZeroOnly = false;
    window.toggleZeroPriceRows = function() {
      showZeroOnly = !showZeroOnly;
      const btn = document.getElementById("toggleZeroButton");
      if (btn) {
        btn.textContent = showZeroOnly ? "🔁 Tümünü Göster" : "🔁 Sıfır Fiyatlıları Göster";
      }
      
      const dataRows = document.querySelectorAll("#urundetaymodel tbody tr.data-row");
      dataRows.forEach(row => {
        const priceCell = row.querySelector(".price-cell");
        if (priceCell) {
          const price = parseFloat(priceCell.getAttribute("data-price"));
          row.style.display = showZeroOnly ? (price === 0 ? "" : "none") : "";
        }
      });
      
      $("tbody.basamak2-group").each(function() {
        let groupVisible = false;
        $(this).find("tr.data-row").each(function() {
          if ($(this).css("display") !== "none") {
            groupVisible = true;
            return false;
          }
        });
        $(this).find("tr.group-header, tr.group-subtotal").toggle(groupVisible);
      });
    };
    
  } catch (error) {
    console.error("Model detay raporu yüklenirken hata:", error);
    alert("Model detay raporu yüklenirken bir hata oluştu: " + error.message);
  }
};



//Detay model tablosunu excele Aktar
function exportModelDetailReportToExcel() {
  const table = document.getElementById("urundetaymodel");
  if (!table) {
    alert("Tablo bulunamadı!");
    return;
  }

  const wb = XLSX.utils.book_new();
  const ws_data = [];

  // Başlık satırı
  ws_data.push([
    "S", "BASAMAK4", "MODEL", "KOD", "FIYAT TL", "FIYAT USD", "HOM STOK", "Konsept Ürün", "Konsept Dışı", "Oran (%)"
  ]);

  let rowIndex = 1;
  let grandHom = 0;
  let grandKonsept = 0;

  const visibleRows = Array.from(table.querySelectorAll("tbody > tr")).filter(tr => {
    return tr.offsetParent !== null && !tr.classList.contains("hide-100");
  });

  for (const tr of visibleRows) {
    const tds = tr.querySelectorAll("td");
    if (tds.length === 10) {
      const b4 = tds[1].innerText.trim();
      const model = tds[2].innerText.trim();
	  const kod = tds[3].innerText.trim();
      const fiyattl = parseInt(tds[4].innerText.replace(/\./g, '')) || 0;
	  const fiyatusd = parseInt(tds[5].innerText.replace(/\./g, '')) || 0;
	  const hom = parseInt(tds[6].innerText.replace(/\./g, '')) || 0;
      const konsept = parseInt(tds[7].innerText.replace(/\./g, '')) || 0;
	  const konseptdisi = parseInt(tds[8].innerText.replace(/\./g, '')) || 0;
      const oran = tds[9].innerText.trim();

      ws_data.push([rowIndex++, b4, model, kod, hom, konsept, hom - konsept, oran]);
      grandHom += hom;
      grandKonsept += konsept;
    }
  }

  // Genel Toplam
  const grandRatio = grandHom > 0 ? ((grandKonsept / grandHom) * 100).toFixed(2) + "%" : "0%";
  ws_data.push(["", "", "Genel Toplam", "","","", grandHom, grandKonsept, grandHom - grandKonsept, grandRatio]);

  const ws = XLSX.utils.aoa_to_sheet(ws_data);
  XLSX.utils.book_append_sheet(wb, ws, "Model Detay Raporu");
  XLSX.writeFile(wb, "model-detay-raporu.xlsx");
}



// Konsept Seçildiğinde product-container Gizle & Ürünleri Yükle
const loadProductsByConcept = async (conceptId) => {
    if (!conceptId) {
        console.warn("Konsept ID tanımlı değil!");
        return;
    }
    
    // Ana ürün konteynerini gizle, konsept ürün konteynerini göster
    document.getElementById("product-container").style.display = "none";
    if (initialImageContainer) {
        initialImageContainer.style.display = 'none';
    }
    document.getElementById("concept-products-container").style.display = "flex";

    const container = document.getElementById("concept-products-container");
    container.innerHTML = ''; // Önce temizle

    // Konsept bilgilerini getir
    const conceptResponse = await fetch(`http://192.168.30.4:3000/concept-info?conceptId=${conceptId}`);
    const conceptData = await conceptResponse.json();
    if (!conceptResponse.ok || !conceptData) {
        console.error("Konsept bilgileri yüklenemedi:", conceptResponse.status, conceptResponse.statusText);
        return;
    }

    const conceptBanner = conceptData.CONCEPT_BANNER || '/resim/banner/default-banner.jpg'; 
    const conceptTitle = conceptData.CUSTOMER_NAME || 'Konsept Adı Bulunamadı';

    // Konsept Banner Alanını Ekle
    const bannerDiv = document.createElement("div");
    bannerDiv.className = "concept-banner";
    bannerDiv.innerHTML = `
        <img src="${conceptBanner}" alt="Konsept Banner" class="concept-banner-image">
        <h2 class="concept-title">${conceptTitle}</h2>
    `;
    container.prepend(bannerDiv);

    // Konsept Ürünlerini Getir
    try {
        const response = await fetch(`http://192.168.30.4:3000/concept-products?conceptId=${conceptId}`);
        const products = await response.json();
        if (!response.ok) {
            console.error("Konsept API Hatası:", response.status, response.statusText);
            return;
        }
        if (products.length === 0) {
            alert('Bu konsepte ait ürün bulunamadı.');
            return;
        }

        let currentGroup = '';  // Mevcut grup başlığını saklamak için
        let productCountInGroup = 0; // Gruplama için sayaç
        let productCount = 0;
        const columns = 4; // Satır başına ürün sayısı

        // Ürünleri gruplandırarak sırala (örnek sıralama, ihtiyaca göre düzenleyebilirsiniz)
        products.sort((a, b) => {
            const order = { "ANA KONSEPT ÜRÜNLERİ": 1, "TAMAMLAYICI ÜRÜNLER": 2, "EK AKSESUARLAR": 3, "EK ÜRÜNLER": 4, "DİĞER": 5};
            let groupA = a.MAINCONCEPT ? "ANA KONSEPT ÜRÜNLERİ" : a.ADDITIONAL ? "TAMAMLAYICI ÜRÜNLER" :a.ADDITIONALAKS ? "TAMAMLAYICI AKSESUARLAR" : a.ACCESSORIES ? "EK AKSESUARLAR" : a.SUPPLEMENTARY ? "EK ÜRÜNLER" :  "DİĞER";
            let groupB = b.MAINCONCEPT ? "ANA KONSEPT ÜRÜNLERİ" : b.ADDITIONAL ? "TAMAMLAYICI ÜRÜNLER" : b.ADDITIONALAKS ? "TAMAMLAYICI AKSESUARLAR" : b.ACCESSORIES ? "EK AKSESUARLAR" : b.SUPPLEMENTARY ? "EK ÜRÜNLER" : "DİĞER";
            return order[groupA] - order[groupB];
        });

        for (const product of products) {
            if (initialImageContainer) {
                initialImageContainer.style.display = 'none';
            }
            
            // Ürün grubunu belirle
            let group = "DİĞER";
            if (product.MAINCONCEPT == 1) {
                group = "ANA KONSEPT ÜRÜNLERİ";
            } else if (product.ADDITIONAL == 1) {
                group = "TAMAMLAYICI ÜRÜNLER";
            } else if (product.ADDITIONALAKS == 1) {
                group = "TAMAMLAYICI AKSESUARLAR";
            } else if (product.ACCESSORIES == 1) {
                group = "EK AKSESUARLAR";
            } else if (product.SUPPLEMENTARY == 1) {
                group = "EK ÜRÜNLER";
            }
            
            // Grup başlığı gerekiyorsa ekle
            if (group !== currentGroup) {
                if (currentGroup !== '') {
                    const totalProductsInRow = columns;
                    if (productCountInGroup % totalProductsInRow !== 0) {
                        const placeholdersNeeded = totalProductsInRow - (productCountInGroup % totalProductsInRow);
                        for (let i = 0; i < placeholdersNeeded; i++) {
                            let placeholderDiv = document.createElement('div');
                            placeholderDiv.className = 'product-placeholder';
                            container.appendChild(placeholderDiv);
                        }
                    }
                }
                currentGroup = group;
                productCountInGroup = 0;
                
                // Grup Başlığı Ekle
                let groupDiv = document.createElement('div');
                groupDiv.className = 'group-title d-flex justify-content-between align-items-center';
                groupDiv.style.color = "#727476";
                let titleSpan = document.createElement("span");
                titleSpan.innerText = group;
                groupDiv.appendChild(titleSpan);
                let addAllButton = document.createElement("button");
                addAllButton.className = "btn btn-sm";
                addAllButton.style.backgroundColor = "#727476";
                addAllButton.style.color = "white";
                addAllButton.style.border = "none";
                addAllButton.style.padding = "8px 12px";
                addAllButton.style.borderRadius = "5px";
                addAllButton.innerText = "Tümünü Sepete Ekle";
                addAllButton.onclick = () => addGroupToCart(group, products);
                groupDiv.appendChild(addAllButton);
                container.appendChild(groupDiv);
            }
            
            productCountInGroup++;
            let productDiv = document.createElement('div');
            productDiv.className = 'product';
            productDiv.style.flex = `1 1 calc(100% / ${columns} - 20px)`;

            // Ürün bilgilerini attribute olarak ekle
            productDiv.setAttribute("data-kurumsal", product.KURUMSALLIST ? "1" : "0");
            productDiv.setAttribute("data-indirim", product.INDIRIMLIST ? "1" : "0");
            productDiv.setAttribute("data-stock", product.STOK);
            productDiv.setAttribute("data-hm-stock", product.HOM);
            productDiv.setAttribute("data-koleksiyon25", product.KOLEKSIYON25 ? "1" : "0");
            productDiv.setAttribute("data-price", product.SFIYAT1);
            productDiv.setAttribute("data-fkontrol", product.FKONTROL ? "1" : "0");
            productDiv.setAttribute("data-fuar25", product.FUAR25 ? "1" : "0");

            // Yeni: Resimleri endpoint'ten çekiyoruz (UNC yol dönüşümü ve sıralama, base image ilk sırada olacak)
            const imageUrls = await fetchProductImages(product.KOD);
            
            // Indicators (Noktalar)
            const indicators = imageUrls.map((_, index) => `
                <li data-target="#carousel-${product.KOD}" data-slide-to="${index}" ${index === 0 ? 'class="active"' : ''}></li>
            `).join('');
            
            // Carousel Items (Resimler)
            const carouselItems = imageUrls.map((url, index) => `
                <div class="carousel-item ${index === 0 ? 'active' : ''}">
                    <img src="${url}" alt="${product.ADI}" class="d-block w-100" 
                        data-urls='${JSON.stringify(imageUrls)}' onclick="openImageModal('${product.KOD}')">
                </div>
            `).join('');
            
            // Ürün İçeriğini Oluştur
            productDiv.innerHTML = `
                <div id="carousel${product.KOD}" class="carousel slide" data-ride="carousel">
                    <ol class="carousel-indicators">${indicators}</ol>
                    <div class="carousel-inner">${carouselItems}</div>
                    <a class="carousel-control-prev" href="#carousel${product.KOD}" role="button" data-slide="prev">
                        <span class="carousel-control-prev-icon" aria-hidden="true"></span>
                        <span class="sr-only">Previous</span>
                    </a>
                    <a class="carousel-control-next" href="#carousel${product.KOD}" role="button" data-slide="next">
                        <span class="carousel-control-next-icon" aria-hidden="true"></span>
                        <span class="sr-only">Next</span>
                    </a>
                </div>
                <table style="width: 100%; text-align: left;">
                    <tbody>
                        <tr>
                            <td><strong>KATEGORİ:</strong></td>
                            <td><strong>${product.BASAMAK2}</strong></td>
                        </tr>
                        <tr>
                            <td><strong>ALT KATEGORI:</strong></td>
                            <td><strong>${product.BASAMAK4}</strong></td>
                        </tr>
                        <tr>
                            <td><strong>KOD:</strong></td>
                            <td><strong>${product.KOD}</strong></td>
                        </tr>
                        <tr>
                            <td><strong>MODEL:</strong></td>
                            <td><strong>${product.MODEL}</strong></td>
                        </tr>
                        <tr>
                            <td>EBAT:</td>
                            <td>${product.EBAT}</td>
                        </tr>
                        <tr>
                            <td>RENK:</td>
                            <td>${product.RENK}</td>
                        </tr>
                        <tr>
                            <td>DESEN & LAMINE:</td>
                            <td>${product.DESEN ? product.DESEN : '-'} / ${product.LAMINE ? product.LAMINE : '-'}</td>
                        </tr>
                        <tr>
                            <td>MATERYAL:</td>
                            <td>${product.MATERYAL}</td>
                        </tr>
                        <tr>
                            <td>AYAK:</td>
                            <td>${product.LEG ? product.LEG : '-'}</td>
                        </tr>
                        <tr>
                            <td>PRK TL & USD:</td>
                            <td>${formatCurrency(product.SFIYAT1, 1)} / ${formatCurrency(product.SFIYAT4, 4)}</td>
                        </tr>
                        <tr>
                            <td>STOK / HM:</td>
                            <td>${product.STOK} / ${product.HOM}</td>
                        </tr>
						<tr>
                            <td>MIKTAR:</td>
                            <td>${product.MIKTAR}</td>
                        </tr>
                        <tr>
                            <td colspan="2">
                                <div class="koleksiyon-checkboxes">
                                    <label style="margin: 0; padding: 0;">25: <input type="checkbox" ${product.KOLEKSIYON25 ? 'checked' : ''} onchange="updateKoleksiyon('${product.KOD}', 'KOLEKSIYON25', this.checked)"></label>
                                    <label style="margin: 0; padding: 0;">24: <input type="checkbox" ${product.KOLEKSIYON24 ? 'checked' : ''} onchange="updateKoleksiyon('${product.KOD}', 'KOLEKSIYON24', this.checked)"></label>
                                </div>
                            </td>
                        </tr>
                        <tr>
                            <td>Fiyat Kontrol:</td>
                            <td>
                                <input
                                    type="checkbox"
                                    id="fkontrol-${product.KOD}"
                                    ${product.FKONTROL ? 'checked' : ''}
                                    onchange="updateFkontrol('${product.KOD}', this.checked)"
                                >
                                <input
                                    type="text"
                                    id="fkontrolnotes-${product.KOD}"
                                    value="${product.FKONTROLNOTES || ''}"
                                    style="display: ${product.FKONTROL ? 'inline-block' : 'none'};"
                                    onblur="updateFkontrolNotes('${product.KOD}', this.value)"
                                >
                            </td>
                        </tr>
						<tr>
							<td>Fuar 2025:</td>
							<td>${product.FUAR25 ? '✅ Evet' : '❌ Hayır'}</td>
						</tr>
						<tr>
                            <td>Karşılaştır:</td>
                            <td>	
                                <label class="compare-checkbox">
                                    <input type="checkbox" data-product-code="${product.KOD}" onclick="toggleCompare('${product.KOD}', this)"> 
                                </label>
                            </td>
                        </tr>
                        <tr style="padding: 0;">
                            <td>NOTLAR:</td>
                            <td><textarea onblur="updateNotes('${product.KOD}', this.value)">${product.NOTES || ''}</textarea></td>
                        </tr>
                        <tr>
                            <td colspan="2" style="text-align: center;">
                                <button class="btn btn-sm" style="background-color: #727476; color: white; border: none;" onclick="addToCart('${product.KOD}')">Teklif Sepetine Ekle</button>
                            </td>
                        </tr>
                    </tbody>
                </table>
            `;
            container.appendChild(productDiv);
            productCount++;
            // Satırın eksik kalan kısmını doldur
            if (productCount % columns !== 0 && productCount === products.length) {
                const placeholdersNeeded = columns - (productCount % columns);
                for (let i = 0; i < placeholdersNeeded; i++) {
                    let placeholderDiv = document.createElement('div');
                    placeholderDiv.className = 'product-placeholder';
                    container.appendChild(placeholderDiv);
                }
            }
        }
    } catch (error) {
        console.error("Konsept ürünleri yükleme hatası:", error);
    }
};

//Kampanya Panelini Gösteren Fonksiyon
function showCampaignPanel() {

    

    const initialImageContainer = document.getElementById("initialImageContainer");
    if (initialImageContainer) initialImageContainer.style.display = "none";
	
	
	const stokKartiContainer = document.getElementById("stokKartiContainer");
    if (stokKartiContainer) stokKartiContainer.style.display = "none";
	

    const conceptContainer = document.getElementById("concept-products-container");
    if (conceptContainer) 
      conceptContainer.style.display = "none";
	const productContainer = document.getElementById("product-container");
    if (productContainer) productContainer.style.display = "flex";
  // Eğer tab tabanlı bir yapı kullanıyorsanız: Tüm tab-pane'leri pasif hale getirin.
  $('.tab-pane').removeClass('show active');
  
  // Kampanya panelini aktif yapın.
  $('#campaignPanel').addClass('show active');
  
  // İlgili navigasyon butonlarına da aktif sınıfı ekleyin (örneğin, İşlevler menüsünde Kampanya öğesi)
  // Eğer özel bir aktif sınıfınız varsa buraya ekleyebilirsiniz.
  console.log("Kampanya paneli açıldı!");
  loadCategoryTree();
}

// Kategori verilerini ağaç şeklinde jstree’ye yükleyecek fonksiyon
function loadCategoryTree() {
  fetch('/api/categories')
    .then(response => response.json())
    .then(data => {
      // jstree'yi initialize ediyoruz
      $('#campaignCategoriesTree').jstree({
        'core': {
          'data': data,
          'themes': { 'responsive': true }
        },
        "checkbox": {
          "keep_selected_style": false
        },
        "plugins": ["checkbox", "wholerow"]
      });
    })
    .catch(error => console.error("Kategori verileri yüklenirken hata:", error));
}

// Seçili kategorileri güncelleyen jstree event listener'ı
$('#campaignCategoriesTree').on("changed.jstree", function (e, data) {
  const selectedNodes = data.selected;
  document.getElementById('selectedCategories').value = selectedNodes.join(',');
  console.log("Seçili kategoriler:", selectedNodes);
});



// Sadece concept-products-container içeriğini Excel'e aktaran global fonksiyon
function exportConceptToExcel() {
  const container = document.getElementById("concept-products-container");
  if (!container) return;
  const tableHTML = container.innerHTML;
  const dataType = 'application/vnd.ms-excel';
  const filename = 'KONSEPT_DISI_URUNLER_RAPORU.xls';
  const downloadLink = document.createElement("a");
  document.body.appendChild(downloadLink);
  downloadLink.href = 'data:' + dataType + ', ' + encodeURIComponent(tableHTML);
  downloadLink.download = filename;
  downloadLink.click();
  document.body.removeChild(downloadLink);
}


//Ürünler Özet Raporu
const loadOzetReport = async (language = "tr") => {
  try {
    const productContainer = document.getElementById("product-container");
    if (productContainer) productContainer.style.display = "none";

    const initialImageContainer = document.getElementById("initialImageContainer");
    if (initialImageContainer) initialImageContainer.style.display = "none";
	
	
	const stokKartiContainer = document.getElementById("stokKartiContainer");
    if (stokKartiContainer) stokKartiContainer.style.display = "none";
	

    const conceptContainer = document.getElementById("concept-products-container");
    if (conceptContainer) {
      conceptContainer.style.display = "flex";
      conceptContainer.innerHTML = "";
    }

    const formatCurrency = (value, priceType) => {
      let currency;
      switch (parseInt(priceType, 10)) {
        case 1:
        case 2:
          currency = 'TRY';
          break;
        case 3:
        case 4:
          currency = 'USD';
          break;
        case 5:
        case 6:
          currency = 'EUR';
          break;
        default:
          currency = 'TRY';
      }
      return new Intl.NumberFormat('tr-TR', {
        style: 'currency',
        currency: currency,
        minimumFractionDigits: 0,
        maximumFractionDigits: 0
      }).format(value);
    };

    const response = await fetch("http://192.168.30.4:3000/api/ozet-report");
    if (!response.ok) throw new Error("Özet raporu alınamadı.");
    const result = await response.json();
    if (!result.success) throw new Error(result.message);
    const data = result.data;

    const groups = {};
    data.forEach(record => {
      const key = record.BASAMAK2 ? record.BASAMAK2.toUpperCase() : "DIGER";
      if (!groups[key]) {
        groups[key] = [];
      }
      groups[key].push(record);
    });

    // Güvenli customOrder tanımı
    const customOrder = window.customOrderBasamak || [];

    let groupKeys = Object.keys(groups).sort((a, b) => {
      const aIndex = customOrder.indexOf(a);
      const bIndex = customOrder.indexOf(b);
      if (aIndex !== -1 && bIndex !== -1) return aIndex - bIndex;
      if (aIndex !== -1) return -1;
      if (bIndex !== -1) return 1;
      return a.localeCompare(b, 'tr', { sensitivity: 'base' });
    });

    let finalHTML = `
      <style>
        @media print {
          @page { size: A4 portrait; margin: 5mm; }
          body { -webkit-print-color-adjust: exact; }
          #printButton, #exportButton { display: none; }
        }
        table { width: 45%; border-collapse: collapse; }
        th, td { padding: 5px; border: 1px solid #ccc; }
        .text-right { text-align: right; }
      </style>
      <div style="max-width: 45%; margin-top: 20px; margin-left: 323px; font-size: 12px;">
        <div style="display: flex; justify-content: space-between; align-items: center;">
          <h4 style="text-align: center; margin-bottom: 15px;">
            ${language === "tr" ? "Ürün Özet Raporu" : "Summary Report"}
          </h4>
          <div>
            <button id="printButton" onclick="printConceptContainer()" class="btn btn-primary">
              <span style="margin-right: 5px;">🖨</span>Yazdır
            </button>
            <button id="exportButton" onclick="exportSummaryReportToExcel()" class="btn btn-success">
              <span style="margin-right: 5px;">📊</span>Excel'e Aktar
            </button>
          </div>
        </div>
        <table id="urunozet" class="table table-bordered table-striped">
          <thead>
            <tr>
              <th rowspan="2">S</th>
              <th rowspan="2">BASAMAK4</th>
              <th rowspan="2">Toplam Ürün (Adet)</th>
              <th rowspan="2">Konsept Ürün (Adet)</th>
              <th rowspan="2">Konsept Dışı (Adet)</th>
              <th rowspan="2">Oran (%)</th>
            </tr>
          </thead>
          <tbody>
    `;

    let grandHom = 0;
    let grandKonsept = 0;

    groupKeys.forEach(groupKey => {
      finalHTML += `
        <tr style="background-color:#e6e6e6; font-size: 14px;">
          <td colspan="6" style="font-weight:bold; text-align:left;">${groupKey}</td>
        </tr>
      `;
      let groupHom = 0;
      let groupKonsept = 0;

      groups[groupKey].sort((a, b) => a.BASAMAK4.localeCompare(b.BASAMAK4, 'tr', { sensitivity: 'base' }));
      groups[groupKey].forEach((record, index) => {
        let ratioDisplay = record.Ratio ? record.Ratio.toString().replace('.', ',') : '0%';
        finalHTML += `
          <tr>
            <td style="width:5%;">${index + 1}</td>
            <td style="width:20%;">${record.BASAMAK4 || ""}</td>
            <td class="text-right" style="width:20%;">${record.HomKodSayisi}</td>
            <td class="text-right" style="width:20%;">${record.KonseptProductCount}</td>
            <td class="text-right" style="width:20%;">${record.HomKodSayisi - record.KonseptProductCount}</td>
            <td class="text-right" style="width:15%;">${ratioDisplay}</td>
          </tr>
        `;
        groupHom += Number(record.HomKodSayisi) || 0;
        groupKonsept += Number(record.KonseptProductCount) || 0;
      });

      const groupRatio = groupHom > 0
        ? new Intl.NumberFormat('tr-TR', { minimumFractionDigits: 2, maximumFractionDigits: 2 }).format((groupKonsept / groupHom) * 100) + '%'
        : '0%';

      finalHTML += `
        <tr style="font-weight:bold; background-color:#f0f0f0;">
          <td colspan="2" class="text-right">Alt Toplam:</td>
          <td class="text-right">${groupHom}</td>
          <td class="text-right">${groupKonsept}</td>
          <td class="text-right">${groupHom - groupKonsept}</td>
          <td class="text-right">${groupRatio}</td>
        </tr>
      `;

      grandHom += groupHom;
      grandKonsept += groupKonsept;
    });

    const grandRatio = grandHom > 0
      ? new Intl.NumberFormat('tr-TR', { minimumFractionDigits: 2, maximumFractionDigits: 2 }).format((grandKonsept / grandHom) * 100) + '%'
      : '0%';

    finalHTML += `
      <tr style="font-weight:bold; background-color:#dcdcdc;">
        <td colspan="2" class="text-right">Genel Toplam:</td>
        <td class="text-right">${grandHom}</td>
        <td class="text-right">${grandKonsept}</td>
        <td class="text-right">${grandHom - grandKonsept}</td>
        <td class="text-right">${grandRatio}</td>
      </tr>
      </tbody>
      </table>
      </div>
    `;

    if (conceptContainer) {
      conceptContainer.innerHTML = finalHTML;
    }

    createStickyHeaderBarY();
  } catch (error) {
    console.error("Özet raporu yüklenirken hata:", error);
    alert("Özet raporu yüklenirken bir hata oluştu: " + error.message);
  }
};



// Sadece concept-products-container içeriğini Excel'e aktaran global fonksiyon
function exportSummaryReportToExcel() {
  const container = document.getElementById("concept-products-container");
  if (!container) return;
  
  // Konsept raporunun HTML tablosunun bir kopyasını oluşturuyoruz
  const clone = container.cloneNode(true);
  
  // Yazdır ve Excel'e Aktar butonlarını klon içerikten kaldırıyoruz
  const printBtn = clone.querySelector("#printButton");
  if (printBtn) printBtn.remove();
  const exportBtn = clone.querySelector("#exportButton");
  if (exportBtn) exportBtn.remove();
  
  // Tablonun HTML içeriğini string olarak alalım
  let tableHTML = clone.innerHTML;
  
  // <thead> ... </thead> kısmını tamamen kaldırıyoruz
  tableHTML = tableHTML.replace(/<thead>[\s\S]*?<\/thead>/i, "");
  
  // Sütun başlıklarını içeren header row'u manuel olarak oluşturup <tbody> nin başına ekleyelim.
  const headerRow = `
    <tr>
      <th>S</th>
      <th>BASAMAK4</th>
      <th>Toplam Urun (Adet)</th>
      <th>Konsept Urun (Adet)</th>
      <th>Konsept Disi (Adet)</th>
      <th>Oran (%)</th>
    </tr>
  `;
  // <tbody> açılış etiketinin hemen sonuna headerRow'u ekleyelim:
  tableHTML = tableHTML.replace(/<tbody>/i, `<tbody>${headerRow}`);
  
  // Oluşan HTML içeriğini UTF-8 meta etiketiyle sarmalayalım
  const htmlContent = `
    <html>
      <head>
        <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
      </head>
      <body>
        ${tableHTML}
      </body>
    </html>
  `;
  
  const dataType = 'application/vnd.ms-excel;charset=UTF-8';
  const filename = 'Özet Ürünler Raporu.xls';
  const downloadLink = document.createElement("a");
  document.body.appendChild(downloadLink);
  downloadLink.href = 'data:' + dataType + ', ' + encodeURIComponent(htmlContent);
  downloadLink.download = filename;
  downloadLink.click();
  document.body.removeChild(downloadLink);
}

function getSelectedCurrency() {
  return $('#currencySelect').selectpicker('val'); // selectpicker'ın güncel değerini döndürür.
}

// Konseptler Özet Raporu
const loadConceptSummaryReport = async (language = "tr", currency = "TL") => {
  try {
    // Yerel para birimi biçimlendirme fonksiyonu (seçilen döviz cinsine göre)
    const formatCurrencyLocal = (value, curr) => {
      let currencyCode;
      switch (curr) {
        case "TL":
          currencyCode = "TRY";
          break;
        case "USD":
          currencyCode = "USD";
          break;
        case "EUR":
          currencyCode = "EUR";
          break;
        default:
          currencyCode = "TRY";
      }
      return new Intl.NumberFormat("tr-TR", {
        style: "currency",
        currency: currencyCode,
        currencyDisplay: "symbol",
        minimumFractionDigits: 0,
        maximumFractionDigits: 0,
      }).format(value);
    };

    // Ürün ve resim konteynerlerini gizle, konsept konteynerini göster
    const productContainer = document.getElementById("product-container");
    if (productContainer) productContainer.style.display = "none";
	const stokKartiContainer = document.getElementById("stokKartiContainer");
    if (stokKartiContainer) stokKartiContainer.style.display = "none";
    const initialImageContainer = document.getElementById("initialImageContainer");
    if (initialImageContainer) initialImageContainer.style.display = "none";
    const conceptContainer = document.getElementById("concept-products-container");
    if (conceptContainer) {
      conceptContainer.style.display = "flex";
      // İçerik temizlensin
      conceptContainer.innerHTML = "";
    }

    // Seçilen para cinsine göre API çağrısı
    const response = await fetch(`http://192.168.30.4:3000/api/konsept-summary?currency=${currency}`);
    if (!response.ok) throw new Error("Özet raporu alınamadı.");
    const result = await response.json();
    if (!result.success) throw new Error(result.message);
    const data = result.data;

    // Eğer tüm kayıtlar için Others sütunundaki değerler 0 ise, diğer sütunları gizleyelim
    window.hideOthersColumns = data.every(record =>
      (record.Others_Miktar || 0) === 0 && (record.Others_Tutar || 0) === 0
    );
    // PDF sütunu eklediğimiz için toplam sütun sayısını belirleyelim:
    // Yeni "Kilitli" sütunu eklediğimizden dolayı totalColumns artacak.
    let totalColumns = hideOthersColumns ? 16 : 18;
    console.log("Konsept ID:", data.ID);

    // Genel HTML yapısını oluşturuyoruz: başlık, yazdır ve Excel'e Aktar butonları,
    // aynı satırda "Döviz Cinsi:" etiketli dropdown da yer alıyor.
    let finalHTML = `
      
	<style>
    @media print {
      @page { size: A4 portrait; margin: 5mm; }
      body { -webkit-print-color-adjust: exact; }
      #printButton, #exportButton, #currencySelect { display: none; }
    }
    table { width: 85%; border-collapse: collapse; }
    th, td { padding: 5px; border: 1px solid #ccc; }
    .text-right { text-align: right; }
    .sticky-header {
      position: sticky;
      top: 0;
      background-color: #fff;
      z-index: 100;
    }
    .sticky-toolbar {
      position: sticky;
      top: 0;
      background-color: #fff;
      z-index: 100;
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 10px 0;
    }
  </style>



      <div style="max-width: 85%px; margin: 5px auto; font-size: 15px;">
        <!-- Başlık ve Üst İşlemler -->
       <div class="sticky-toolbar">
            <h4>
              ${language === "tr" ? "Konseptler Kategori Detaylı Özet" : "Concept Summary Details by Categories"}
            </h4>
            <div>
              <button id="printButton" onclick="printConceptContainer()" class="btn btn-primary">
                <span style="margin-right: 5px;">🖨</span>Yazdır
              </button>
              <button id="exportButton" onclick="exportConceptOzetToExcel()" class="btn btn-success" style="margin-left: 5px;">
                <span style="margin-right: 5px;">📊</span>Excel'e Aktar
              </button>
              <label id="currencySelectLabel" for="currencySelect" style="margin-left: 10px; margin-right: 5px;">Döviz Cinsi:</label>
              <select id="currencySelect">
                <option value="TL" ${currency === "TL" ? "selected" : ""}>TL</option>
                <option value="USD" ${currency === "USD" ? "selected" : ""}>USD</option>
                <option value="EUR" ${currency === "EUR" ? "selected" : ""}>EUR</option>
              </select>
            </div>
          </div>
       <!-- Tablo Başlangıcı -->
    <table id="konseptozet" class="table table-bordered table-striped">
      <colgroup>
        <!-- İlk 3 sütun: S, Konsept Adı, Kilitli -->
        <col style="width:5%;">        
        <col style="width:20%;">       
        <col style="width:5%;">        
        <!-- Ana Konsept (2 sütun) -->
        <col style="width:10%;">       
        <col style="width:10%;">       
        <!-- Tamamlayıcı Ürünler (2 sütun) -->
        <col style="width:10%;">       
        <col style="width:10%;">       
        <!-- Tamamlayıcı Aksesuarlar (2 sütun) -->
        <col style="width:10%;">       
        <col style="width:10%;">       
        <!-- Genel Toplam (2 sütun) -->
        <col style="width:10%;">       
        <col style="width:10%;">       
        <!-- Ek Aksesuarlar (2 sütun) -->
        <col style="width:10%;">       
        <col style="width:10%;">       
        <!-- Ek Ürünler (2 sütun) -->
        <col style="width:10%;">       
        <col style="width:10%;">       
        ${!hideOthersColumns ? `
          <!-- Diğer Ürünler (2 sütun) -->
          <col style="width:10%;">
          <col style="width:10%;">  
        ` : ``}
        <!-- PDF sütunu -->
        <col style="width:5%;">        
      </colgroup>
      <thead>
        <tr>
          <th rowspan="2">S</th>
          <th rowspan="2">Konsept Adı</th>
          <th rowspan="2">Kilitli</th>
          <th colspan="2" class="text-center">Ana Konsept</th>
          <th colspan="2" class="text-center">Tamamlayıcı Ürünler</th>
          <th colspan="2" class="text-center">Tamamlayıcı Aksesuarlar</th>
          <th colspan="2" class="text-center" style="background-color: #bfc9ca;">Genel Toplam</th>
          <th colspan="2" class="text-center">Ek Aksesuarlar</th>
          <th colspan="2" class="text-center">Ek Ürünler</th>
          ${!hideOthersColumns ? `<th colspan="2">Diğer Ürünler</th>` : ""}
          <th rowspan="2" class="text-center">PDF</th>
        </tr>
        <tr>
          <th class="text-right">Miktar</th>
          <th class="text-right">Tutar</th>
          <th class="text-right">Miktar</th>
          <th class="text-right">Tutar</th>
          <th class="text-right">Miktar</th>
          <th class="text-right">Tutar</th>
          <th class="text-right">Miktar</th>
          <th class="text-right">Tutar</th>
          <th class="text-right">Miktar</th>
          <th class="text-right">Tutar</th>
          <th class="text-right">Miktar</th>
          <th class="text-right">Tutar</th>
          ${!hideOthersColumns ? `<th class="text-right">Miktar</th><th class="text-right">Tutar</th>` : ""}
        </tr>
      </thead>
      <tbody>
    `;

    // Verileri "Alan" değerine göre gruplandıralım
    const groups = {};
    data.forEach(record => {
      let group = (record.Alan || "Diğer").trim();
      if (!group) group = "Diğer";
      if (!groups[group]) groups[group] = [];
      groups[group].push(record);
    });

    // Grup sıralaması için sabit sıralama düzeni
    window.customOrder = [
      "OTURMA ODASI - SECTIONAL",
      "OTURMA ODASI",
      "OTURMA ODASI - TV UNITESI",
      "OTURMA ODASI - TEA CORNER",
      "OTURMA ODASI - BAR",
      "YEMEK ODASI - MASA",
      "YEMEK ODASI - BÜFE/KONSOL",
      "YATAK ODASI",
      "YATAK ODASI - MAKYAJ",
      "YATAK ODASI - DOLAP",
	  "YATAK ODASI - CEKMECE",
      "YATAK ODASI - JOSEFIN",
      "ANTRE",
      "GIYINME ODASI",
      "OFIS",
      "TERAS",
      "ARANJMAN - CICEK",
      "DİĞER"
    ];
    let groupKeys = Object.keys(groups).sort((a, b) => {
      const aUpper = a.toUpperCase();
      const bUpper = b.toUpperCase();
      const aIndex = window.customOrder.indexOf(aUpper);
      const bIndex = window.customOrder.indexOf(bUpper);
      if (aIndex !== -1 && bIndex !== -1) return aIndex - bIndex;
      if (aIndex !== -1) return -1;
      if (bIndex !== -1) return 1;
      return a.localeCompare(b, 'tr', { sensitivity: 'base' });
    });

    let grandTotal = 0;
    // Her grup için tablo satırlarını oluşturalım
    groupKeys.forEach((group, groupIndex) => {
      if (groupIndex > 0) {
        finalHTML += `<tr style="height:10px;"><td colspan="${totalColumns}"></td></tr>`;
      }
      finalHTML += `
        <tr style="background-color:#e6e6e6; font-size: 16px;">
          <td colspan="${totalColumns}" style="font-weight:bold; text-align:left;">${group}</td>
        </tr>
      `;
      // Grup içindeki kayıtları Ana Konsept Tutarına göre azalan sırada sıralayalım
      groups[group].sort((a, b) => {
        let aVal = 0, bVal = 0;
        if (typeof a.MainConcept_Tutar === "string") {
          let rawA = a.MainConcept_Tutar.substring(1).trim();
          rawA = rawA.replace(/\./g, "").replace(/,/g, ".");
          aVal = parseFloat(rawA) || 0;
        } else {
          aVal = a.MainConcept_Tutar || 0;
        }
        if (typeof b.MainConcept_Tutar === "string") {
          let rawB = b.MainConcept_Tutar.substring(1).trim();
          rawB = rawB.replace(/\./g, "").replace(/,/g, ".");
          bVal = parseFloat(rawB) || 0;
        } else {
          bVal = b.MainConcept_Tutar || 0;
        }
        return bVal - aVal; // Azalan sıralama
      });
      groups[group].forEach((record, index) => {
        // Ana konsept tutarını sayıya çevirme (gerekirse)
        let mainTutar = record.MainConcept_Tutar;
        if (typeof mainTutar === "string" && (mainTutar.startsWith("₺") || mainTutar.startsWith("$") || mainTutar.startsWith("€"))) {
          let raw = mainTutar.substring(1).trim();
          raw = raw.replace(/\./g, "").replace(/,/g, ".");
          const num = parseFloat(raw);
          if (!isNaN(num)) {
            mainTutar = num;
          }
        }
        
        finalHTML += `
          <tr data-concept-id="${record.ID}">
            <td style="width:5%;">${index + 1}</td>
            <td style="width:20%;">${record.KonseptAdi || ""}</td>
            <td style="width:5%; text-align: center;">
              ${record.CONCEPTLOCK == 1 ? '<i class="fas fa-check" style="color: green;"></i>' : '<i class="fas fa-times" style="color: red;"></i>'}
            </td>
            <td class="text-right" style="width:10%;">${record.MainConcept_Miktar || 0}</td>
            <td class="text-right" style="width:10%;">${formatCurrencyLocal(mainTutar || 0, currency)}</td>
            <td class="text-right" style="width:10%;">${record.Additional_Miktar || 0}</td>
            <td class="text-right" style="width:10%;">${formatCurrencyLocal(record.Additional_Tutar || 0, currency)}</td>
            <td class="text-right" style="width:10%;">${record.Additionalaks_Miktar || 0}</td>
            <td class="text-right" style="width:10%;">${formatCurrencyLocal(record.Additionalaks_Tutar || 0, currency)}</td>
            <td class="text-right" style="width:10%; background-color: #bfc9c9;">
              ${(record.MainConcept_Miktar || 0) + (record.Additional_Miktar || 0) + (record.Additionalaks_Miktar || 0)}
            </td>
            <td class="text-right" style="width:10%; background-color: #bfc9c9;">
              ${formatCurrencyLocal((record.MainConcept_Tutar || 0) + (record.Additional_Tutar || 0) + (record.Additionalaks_Tutar || 0), currency)}
            </td>
            <td class="text-right" style="width:10%;">${record.Accessories_Miktar || 0}</td>
            <td class="text-right" style="width:10%;">${formatCurrencyLocal(record.Accessories_Tutar || 0, currency)}</td>
            <td class="text-right" style="width:10%;">${record.Supplementary_Miktar || 0}</td>
            <td class="text-right" style="width:10%;">${formatCurrencyLocal(record.Supplementary_Tutar || 0, currency)}</td>
            ${!hideOthersColumns ? `
              <td class="text-right" style="width:10%; ${(record.Others_Miktar > 0) ? 'background-color: #c8e6c9;' : ''}">
                ${record.Others_Miktar || 0}
              </td>
              <td class="text-right" style="width:10%; ${(record.Others_Tutar > 0) ? 'background-color: #c8e6c9;' : ''}">
                ${formatCurrencyLocal(record.Others_Tutar || 0, currency)}
              </td>
            ` : ""}
            <td style="width:5%; text-align: center;">
              <button style="border: none; background: none; cursor: pointer;" 
                onclick="generateConceptTablePDF('tr', this.closest('tr').getAttribute('data-concept-id'))">
                📄 TR
              </button>
              <button style="border: none; background: none; cursor: pointer;" 
                onclick="generateConceptTablePDF('en', this.closest('tr').getAttribute('data-concept-id'))">
                📄 EN
              </button>
            </td>
          </tr>
        `;
      });
      grandTotal += groups[group].length;
      finalHTML += `
        <tr style="font-weight:bold; background-color:#f0f0f0;">
          <td colspan="${totalColumns}" class="text-left">${group} - ${groups[group].length} Adet Konsept</td>
        </tr>
      `;
    });

    finalHTML += `
      <tr style="font-weight:bold; background-color:#dcdcdc;">
        <td colspan="${totalColumns}" class="text-left">Toplam - ${grandTotal} Adet Konsept</td>
      </tr>
          </tbody>
        </table>
      </div>
    `;

    // Oluşturduğumuz HTML'i conceptContainer içerisine aktaralım
    if (conceptContainer) {
      conceptContainer.innerHTML = finalHTML;
    }
	 // Sticky header bar'ı oluşturacak fonksiyonu çağırın
    createStickyHeaderBar();

    // Render sonrası, dropdown için event listener ekleyelim
    const dropdown = document.getElementById("currencySelect");
    if (dropdown) {
      dropdown.addEventListener("change", () => {
        window.selectedCurrency = dropdown.value; // Global değeri güncelle
        console.log("Seçilen Para Birimi:", window.selectedCurrency);
        loadConceptSummaryReport(language, window.selectedCurrency);
      });
    }

  } catch (error) {
    console.error("Konsept özet raporu yüklenirken hata:", error);
    alert("Konsept özet raporu yüklenirken bir hata oluştu: " + error.message);
  }
};

//navbar altına sütun başlığı için bar
function createStickyHeaderBar() {
  // Eski sticky header varsa kaldır
  const existingBar = document.getElementById("stickyHeaderBar");
  if (existingBar) {
    existingBar.remove();
  }
  const existingBarY = document.getElementById("stickyHeaderBarY");
  if (existingBarY) {
    existingBarY.remove();
  }
  const existingBarZ = document.getElementById("stickyHeaderBarZ");
  if (existingBarZ) {
    existingBarZ.remove();
  }

  // "konseptozet" id'li tabloyu seçiyoruz
  const table = document.querySelector("table#konseptozet");
  if (!table) return;

  // Sticky header kapsayıcı div
  const stickyHeaderBar = document.createElement("div");
  stickyHeaderBar.id = "stickyHeaderBar";
  stickyHeaderBar.style.display = "none"; // Başlangıçta gizli
  stickyHeaderBar.style.position = "fixed";
  stickyHeaderBar.style.top = "50px";        // Nav bar yüksekliği (gerekirse ayarlayın)
  console.log("hideOthersColumns değeri", window.hideOthersColumns);
  // hideOthersColumns değerine göre left/right ayarları:
  if (window.hideOthersColumns) {
  //Diğer Sütunları Gizli ise
  stickyHeaderBar.style.left = "15.9%";
  stickyHeaderBar.style.right = "4.2%";
  } else {
  //Diğer Sütunları Gösteriliyor ise
  stickyHeaderBar.style.left = "12%";
  stickyHeaderBar.style.right = "0.35%";
  }
  stickyHeaderBar.style.overflow = "hidden";
  stickyHeaderBar.style.backgroundColor = "#fff";
  stickyHeaderBar.style.borderBottom = "1px solid #ccc";
  stickyHeaderBar.style.zIndex = "999";

  // Sticky header içindeki tabloyu oluşturuyoruz
  const stickyTable = document.createElement("table");
  stickyTable.style.width = "100%";
  stickyTable.style.borderCollapse = "collapse";
  stickyTable.style.tableLayout = "fixed";

  // Manuel <colgroup> – Konsept Özet Raporu sütun genişlikleri (örnek değerler)
  // hideOthersColumns değerine göre colgroup oluştur
  const colgroupHTML = getColgroupHTML(hideOthersColumns);
  stickyTable.innerHTML = colgroupHTML;

  // Ana tablodaki <thead>'i klonlayıp sticky tabloya ekliyoruz
  const originalThead = table.querySelector("thead");
  if (!originalThead) return;
  const clonedThead = originalThead.cloneNode(true);
  stickyTable.appendChild(clonedThead);

  // Sticky tabloyu kapsayıcı div'e ekleyip body'ye yerleştiriyoruz
  stickyHeaderBar.appendChild(stickyTable);
  document.body.appendChild(stickyHeaderBar);

  // Scroll event'i: Belirli eşik değeri aşıldığında sticky header görünür olsun
  window.addEventListener("scroll", function() {
    const headerHeight = originalThead.offsetHeight;
    const threshold = table.offsetTop + (headerHeight);
    if (window.scrollY > threshold) {
      stickyHeaderBar.style.display = "block";
    } else {
      stickyHeaderBar.style.display = "none";
    }
  });
}

//konsept özet tablosunda gizlenen kolonlara göre manuel başlık genişliği (steakyheaderbar için)
function getColgroupHTML(hideOthersColumns) {
  if (hideOthersColumns) {
    // Others sütunları gizlenecek; toplam sütun sayısı 16 olacak şekilde (örnek değerler)
    return `
      <colgroup>
        <col style="width: 2.77%;">   <!-- S -->
        <col style="width: 17.98443%;">  <!-- Konsept Adı -->
        <col style="width: 3.728479%;">   <!-- Kilitli -->
        <col style="width: 4.485141%;">  <!-- Ana Konsept Miktar -->
        <col style="width: 6.579669%;">     <!-- Ana Konsept Tutar -->
        <col style="width: 4.82509%;">   <!-- Tamamlayıcı Ürün Miktar -->
        <col style="width: 5.921702%;">   <!-- Tamamlayıcı Ürün Tutar -->
        <col style="width: 5.921702%;">   <!-- Tamamlayıcı Aksesuar Miktar -->
        <col style="width: 6.908652%;">   <!-- Tamamlayıcı Aksesuar Tutar -->
        <col style="width: 4.386446%;">     <!-- Genel Toplam Miktar -->
        <col style="width: 6.579669%;">     <!-- Genel Toplam Tutar -->
        <col style="width: 4.485141%;">  <!-- Ek Aksesuar Miktar -->
        <col style="width: 5.70238%;">   <!-- Ek Aksesuar Tutar -->
        <col style="width: 4.485141%;">  <!-- Ek Ürün Miktar -->
        <col style="width: 5.833973%;">  <!-- Ek Ürün Tutar -->
        <col style="width: 9.430859%;">   <!-- PDF -->
      </colgroup>
    `;
  } else {
    // Others sütunları dahil; toplam sütun sayısı 18 olacak şekilde (örnek değerler)
    return `
      <colgroup>
        <col style="width: 2.5%;">   <!-- S -->
        <col style="width: 16.4%;">  <!-- Konsept Adı -->
        <col style="width: 3.4%;">   <!-- Kilitli -->
        <col style="width: 4.09%;">  <!-- Ana Konsept Miktar -->
        <col style="width: 6%;">     <!-- Ana Konsept Tutar -->
        <col style="width: 4.4%;">   <!-- Tamamlayıcı Ürün Miktar -->
        <col style="width: 5.4%;">   <!-- Tamamlayıcı Ürün Tutar -->
        <col style="width: 5.4%;">   <!-- Tamamlayıcı Aksesuar Miktar -->
        <col style="width: 6.3%;">   <!-- Tamamlayıcı Aksesuar Tutar -->
        <col style="width: 4%;">     <!-- Genel Toplam Miktar -->
        <col style="width: 6%;">     <!-- Genel Toplam Tutar -->
        <col style="width: 4.09%;">  <!-- Ek Aksesuar Miktar -->
        <col style="width: 5.2%;">   <!-- Ek Aksesuar Tutar -->
        <col style="width: 4.09%;">  <!-- Ek Ürün Miktar -->
        <col style="width: 5.32%;">  <!-- Ek Ürün Tutar -->
        <col style="width: 4.09%;">  <!-- Diğer Ürünler Miktar -->
        <col style="width: 4.7%;">   <!-- Diğer Ürünler Tutar -->
        <col style="width: 8.6%;">   <!-- PDF -->
      </colgroup>
    `;
  }
}


//Ürün Özet Raporu için Scrooll başlığı oluşturma 
function createStickyHeaderBarY() {
  // Eski sticky header varsa kaldır
  const existingBarY = document.getElementById("stickyHeaderBarY");
  if (existingBarY) {
    existingBarY.remove();
  }
  const existingBar = document.getElementById("stickyHeaderBar");
  if (existingBar) {
    existingBar.remove();
  }
  const existingBarZ = document.getElementById("stickyHeaderBarZ");
  if (existingBarZ) {
    existingBarZ.remove();
  }
  

  // "urunozet" id'li tabloyu seçiyoruz
  const activeTable = document.querySelector("table#urunozet");
  if (!activeTable) return;

  // Sticky header kapsayıcı div
  const stickyHeaderBarY = document.createElement("div");
  stickyHeaderBarY.id = "stickyHeaderBarY";
  stickyHeaderBarY.style.display = "none"; // İlk çağrıda görünmemeli
  stickyHeaderBarY.style.position = "fixed";
  stickyHeaderBarY.style.top = "50px";          // Nav bar yüksekliği
  stickyHeaderBarY.style.left = "28.5%";         // Sol filtre alanı genişliği
  stickyHeaderBarY.style.right = "31.8%";         // Sol filtre alanı genişliği
  stickyHeaderBarY.style.fontSize = "12px";
  stickyHeaderBarY.style.overflow = "hidden";
  stickyHeaderBarY.style.backgroundColor = "#fff";
  stickyHeaderBarY.style.borderBottom = "1px solid #ccc";
  stickyHeaderBarY.style.zIndex = "999";

  // Sticky header içindeki tabloyu oluşturuyoruz
  const stickyTableY = document.createElement("table");
  stickyTableY.style.width = "100%";
  stickyTableY.style.font = "14px";
  stickyTableY.style.borderCollapse = "collapse";
  stickyTableY.style.tableLayout = "fixed";

  // Manuel <colgroup> – Ürün Özet Raporu sütun genişlikleri (örnek değerler)
  // S: %5, BASAMAK4: %20, Toplam Ürün: %20, Konsept Ürün: %20, Konsept Dışı: %20, Oran: %15
  const colgroupHTMLY = `
    <colgroup>
      <col style="width:5.52%;">
      <col style="width:33.20%;">
      <col style="width:17.02%;">
      <col style="width:18.12%;">
      <col style="width:17.1%;">
      <col style="width:9.04%;">
    </colgroup>
  `;
  stickyTableY.innerHTML = colgroupHTMLY;

  // Ana tablodaki <thead>'i klonlayıp sticky tabloya ekliyoruz
  const originalTheadY = activeTable.querySelector("thead");
  if (!originalTheadY) return;
  const clonedTheadY = originalTheadY.cloneNode(true);
  stickyTableY.appendChild(clonedTheadY);

  // Sticky tabloyu kapsayıcı div'e ekleyip body'ye yerleştiriyoruz
  stickyHeaderBarY.appendChild(stickyTableY);
  document.body.appendChild(stickyHeaderBarY);

  // Scroll event'i: Belirli eşik değeri aşıldığında sticky header görünür olsun
  window.addEventListener("scroll", function() {
    const headerHeight = originalTheadY.offsetHeight;
    const threshold = activeTable.offsetTop + (headerHeight * 2);
    if (window.scrollY > threshold) {
      stickyHeaderBarY.style.display = "block";
    } else {
      stickyHeaderBarY.style.display = "none";
    }
  });
}



// Konsept özeti için Konteyner içinde bulunan tablolardan, görüntüde olan (aktif) tabloyu tespit edip sticky header'ı oluşturur.
function updateStickyHeaderBar() {
  // Sadece tablo id'lerine göre kontrol yapıyoruz.
  const tableK = document.querySelector("table#konseptozet");
  const tableU = document.querySelector("table#urunozet");

  if (tableK) {
    // Eğer "konseptozet" tablosu varsa, konsept sticky header'ı çağır.
    createStickyHeaderBar();
    // "urunozet" sticky header varsa gizle
    const stickyY = document.getElementById("stickyHeaderBarY");
    if (stickyY) stickyY.style.display = "none";
	
  } else if (tableU) {
    // Eğer "urunozet" tablosu varsa, ürün sticky header'ı çağır.
    createStickyHeaderBarY();
    // "konseptozet" sticky header varsa gizle
    const stickyX = document.getElementById("stickyHeaderBar");
    if (stickyX) stickyX.style.display = "none";
	
  } else {
    // Hiçbiri yoksa, varsa her iki sticky header'ı da gizle.
    const stickyX = document.getElementById("stickyHeaderBar");
    if (stickyX) stickyX.style.display = "none";
    const stickyY = document.getElementById("stickyHeaderBarY");
    if (stickyY) stickyY.style.display = "none";
	
  }
}



// Sadece concept-products-container içeriğini yazdıran global yazdırma fonksiyonu
function printConceptContainer() {
  const container = document.getElementById("concept-products-container");
  if (!container) return;
  const printWindow = window.open("", "", "height=600,width=800");
  printWindow.document.write("<html><head><title>Konsept Raporu</title>");
  printWindow.document.write("<style>");
  // Kenar boşlukları minimuma indirilmiş yazdırma stili + .text-right kuralı ekleniyor
  printWindow.document.write("@media print { @page { size: A4 portrait; margin: 5mm; } body { -webkit-print-color-adjust: exact; } }");
  printWindow.document.write("table { width: 100%; border-collapse: collapse; } th, td { padding: 5px; border: 1px solid #ccc; }");
  printWindow.document.write(".text-right { text-align: right; }");
  printWindow.document.write("</style>");
  printWindow.document.write("</head><body>");
  printWindow.document.write(container.innerHTML);
  printWindow.document.write("</body></html>");
  printWindow.document.close();
  printWindow.focus();
  setTimeout(() => {
    printWindow.print();
    printWindow.close();
  }, 500);
}

// Sadece concept-products-container içeriğini Excel'e aktaran global fonksiyon
function exportConceptOzetToExcel() {
  const container = document.getElementById("concept-products-container");
  if (!container) return;
  
  // Konsept raporunun HTML tablosunun bir kopyasını oluşturuyoruz.
  const clone = container.cloneNode(true);
  
  // Yazdır ve Excel'e Aktar butonlarını klon içerikten kaldırıyoruz.
  const btns = clone.querySelectorAll("#printButton, #exportButton, #currencySelect, #currencySelectLabel");
  btns.forEach(btn => btn.remove());
  
  // --- Yeni: Header'da "Para Cinsi" sütunu ekleyelim ---
  // Burada, header yapınızın 2. satırında (birleşik "Konsept Adı" hücresinden sonra)
  let headerRows = [];
  if (clone.querySelector("thead") && clone.querySelector("thead").rows.length >= 2) {
    headerRows = Array.from(clone.querySelector("thead").rows);
  } else if (clone.querySelector("table").rows.length >= 2) {
    headerRows = [clone.querySelector("table").rows[0], clone.querySelector("table").rows[1]];
  }
  if (headerRows.length >= 2) {
    // "Konsept Adı" hücresinin indeksini bulalım (örneğin, header'da 2. sütun)
    const firstHeaderRow = headerRows[0];
    let konseptAdiIndex = -1;
    for (let i = 0; i < firstHeaderRow.cells.length; i++) {
      const txt = firstHeaderRow.cells[i].textContent.trim().toLowerCase();
      if (txt.includes("konsept adı")) {
        konseptAdiIndex = i;
        break;
      }
    }
    if (konseptAdiIndex !== -1) {
      // Yeni header hücresi: "Para Cinsi", rowspan="2"
      const newHeaderCell = document.createElement("th");
      newHeaderCell.textContent = "Para Cinsi";
      newHeaderCell.setAttribute("rowspan", "2");
      // Yeni hücreyi, "Konsept Adı" hücresinin hemen sonrasına ekleyelim.
      firstHeaderRow.insertBefore(newHeaderCell, firstHeaderRow.cells[konseptAdiIndex + 1]);
    }
  }
  
  // --- Veri satırlarında para cinsi sütunu ekleyelim ---
  // Varsayalım ki veri satırları <tbody> içinde yer alıyor.
  const tbody = clone.querySelector("table").tBodies[0];
  if (tbody) {
    for (let i = 0; i < tbody.rows.length; i++) {
      const row = tbody.rows[i];
      // Varsayılan yapı: 0: S, 1: Konsept Adı, 2: Ana Konsept Miktar, 3: Ana Konsept Tutar, ...
      // Yeni "Para Cinsi" sütunu, "Konsept Adı" sütunundan hemen sonra eklenmeli (yani index 2'e)
      const targetIndex = 3; // "Ana Konsept Tutar" hücresinin indeksi (örneğin)
      let currency = "";
      if (row.cells.length > targetIndex) {
        const cellText = row.cells[targetIndex].textContent.trim();
        if (cellText.startsWith("₺")) {
          currency = "TL";
        } else if (cellText.startsWith("$")) {
          currency = "USD";
        } else if (cellText.startsWith("€")) {
          currency = "EUR";
        }
      }
      const newCell = document.createElement("td");
      newCell.textContent = currency;
      newCell.className = "text-right";
      // "Konsept Adı" sütunu varsayılan olarak index 1 olduğundan, eklemek için index 2'ye ekliyoruz.
      row.insertBefore(newCell, row.cells[2]);
    }
  }
  
  // --- Tutar sütunlarındaki hücrelerdeki para birimi değerlerini düzenleyelim ---
  // Bu adımda, TUTAR hücrelerinde bulunan para birimi sembollerini kaldırıp, sadece sayı değeri olarak aktaracağız.
  // (Örneğin, "₺300.000" → "300000" sayısı)
  const cells = clone.querySelectorAll("td");
  cells.forEach(cell => {
    let text = cell.textContent.trim();
    if (text.startsWith("₺") || text.startsWith("$") || text.startsWith("€")) {
      // İlk karakterdeki para birimi sembolünü alıp kaldırıyoruz.
      const symbol = text.charAt(0);
      let raw = text.substring(1).trim();
      // Tüm noktaları (binlik ayracı) kaldır; virgülü ondalık ayracı temsil edecek şekilde nokta yap:
      raw = raw.replace(/\./g, "").replace(/,/g, ".");
      const num = parseFloat(raw);
      if (!isNaN(num)) {
        cell.textContent = num; // Hücreye sayısal değeri yazıyoruz.
        // Hücredeki sayı, Excel'e sistem bölgesine bağlı olarak biçimlendirilecek.
        // Excel'in Türkçe formatı kullanması için mso-number-format " #,##0" kullanılabilir.
        if (symbol === "₺") {
          cell.style.cssText += " mso-number-format:\"[$-tr-TR]#.##0\";";
        } else if (symbol === "$") {
          cell.style.cssText += " mso-number-format:\"[$-tr-TR]#.##0\";";
        } else if (symbol === "€") {
          cell.style.cssText += " mso-number-format:\"[$-tr-TR]#.##0\";";
        }
      }
    }
  });
  
  // Dışarı aktarılacak HTML içeriğini UTF-8 meta etiketi ve dahili stil kuralları ile sarmalıyoruz.
  const htmlContent = `
    <html>
      <head>
        <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
        <style>
          @media print {
            @page { size: A4 portrait; margin: 5mm; }
            body { -webkit-print-color-adjust: exact; }
            #printButton, #exportButton { display: none; }
          }
          table { width: 100%; border-collapse: collapse; }
          th, td { padding: 5px; border: 1px solid #ccc; }
          .text-right { text-align: right; }
        </style>
      </head>
      <body>
        ${clone.innerHTML}
      </body>
    </html>
  `;
  
  const dataType = 'application/vnd.ms-excel;charset=UTF-8';
  const filename = 'Konseptler Kategori Detaylı Özet.xls';
  const downloadLink = document.createElement("a");
  downloadLink.href = 'data:' + dataType + ', ' + encodeURIComponent(htmlContent);
  downloadLink.download = filename;
  document.body.appendChild(downloadLink);
  downloadLink.click();
  document.body.removeChild(downloadLink);
}



const updateConceptProductLayout = () => {
    const filterContainer = document.getElementById("filter-container");
    const conceptContainer = document.getElementById("concept-products-container");
    if (!conceptContainer) return;
    let filterWidth = filterContainer ? filterContainer.offsetWidth : 220;
    let availableWidth = window.innerWidth - filterWidth;
    let columnCount = 4;
    if (availableWidth < 1280) columnCount = 3;
    if (availableWidth < 1024) columnCount = 2;
    if (availableWidth < 768) columnCount = 1;
    document.documentElement.style.setProperty("--column-count", columnCount);
    document.querySelectorAll("#concept-products-container .product").forEach(product => {
        product.style.flex = `0 1 calc(${availableWidth / columnCount - 20}px)`;
        product.style.maxWidth = `calc(${availableWidth / columnCount - 20}px)`;
    });
};

window.addEventListener("resize", updateConceptProductLayout);
document.addEventListener("DOMContentLoaded", updateConceptProductLayout);

const addGroupToCart = async (groupName, allProducts) => {
    try {
        if (!activeCartId) {
            alert("Lütfen önce bir sepet seçin.");
            return;
        }
        const cartInfoResponse = await fetch(`http://192.168.30.4:3000/cart-info/${activeCartId}`);
        if (!cartInfoResponse.ok) throw new Error("Aktif sepet bilgileri alınamadı.");
        const cartInfo = await cartInfoResponse.json();
        if (cartInfo.CONCEPT === 1) {
            alert("Toplu Ürün Eklemede Seçili Sepet Konsept Sepeti Olamaz");
            return;
        }
        const groupProducts = allProducts.filter(product => {
            if (groupName === "ANA KONSEPT ÜRÜNLERİ") return product.MAINCONCEPT == 1;
            if (groupName === "TAMAMLAYICI ÜRÜNLER") return product.ADDITIONAL == 1;
			if (groupName === "TAMAMLAYICI AKSESUARLAR") return product.ADDITIONALAKS == 1;
            if (groupName === "EK AKSESUARLAR") return product.ACCESSORIES == 1;
			if (groupName === "EK ÜRÜNLER") return product.SUPPLEMENTARY == 1;
            return false;
        });
        if (groupProducts.length === 0) {
            alert("Bu gruba ait ürün bulunamadı.");
            return;
        }
        for (const product of groupProducts) {
            await fetch("http://192.168.30.4:3000/cart/item", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({
                    cartId: activeCartId,
                    productId: product.KOD,
                    quantity: product.MIKTAR || 1
                })
            });
        }
        alert(`${groupName} grubundaki tüm ürünler sepete eklendi.`);
        await showCartContents();
    } catch (error) {
        console.error("Grup ürünlerini sepete ekleme hatası:", error);
        alert("Ürünler sepete eklenirken bir hata oluştu.");
    }
};
//Menülerin ekranın dışına taşmasını engellemek için JavaScript
document.addEventListener('DOMContentLoaded', () => {
    const dropdownMenus = document.querySelectorAll('.dropdown');

    dropdownMenus.forEach((menu) => {
        menu.addEventListener('show.bs.dropdown', function () {
            const dropdownMenu = this.querySelector('.dropdown-menu');
            const navbar = document.querySelector('.navbar');
            const navbarHeight = navbar.offsetHeight;

            // Dropdown menü pozisyonunu ayarla
            dropdownMenu.style.top = `${navbarHeight}px`; // Navbarın altından başlar
            dropdownMenu.style.left = '0'; // Varsayılan sola hizalanır
            dropdownMenu.style.display = 'block'; // Görünür yap
        });
    });
});

//konsept pdfsini tablodan oluşturma
window.generateConceptTablePDF = async (language = "tr", conceptId) => {

	if (!conceptId) {
		alert("Konsept ID belirtilmedi.");
		return;
	  }
  const { jsPDF } = window.jspdf;
  // A4 landscape: 297 x 210 mm
  const doc = new jsPDF({
    orientation: "landscape",
    unit: "mm",
    format: "a4",
  });
  
  const margin = 5;
  const pageWidth = 297; // Landscape A4 genişliği
  const pageHeight = 210; // Landscape A4 yüksekliği

  // ---------------- Yardımcı Fonksiyonlar ----------------
  const arrayBufferToBase64 = (buffer) => {
    let binary = "";
    const bytes = new Uint8Array(buffer);
    for (let i = 0; i < bytes.byteLength; i++) {
      binary += String.fromCharCode(bytes[i]);
    }
    return btoa(binary);
  };

  const formatNumber = (value) => {
    const parts = Number(value).toFixed(2).split(".");
    parts[0] = parts[0].replace(/\B(?=(\d{3})+(?!\d))/g, ".");
    return parts.join(",");
  };

  const loadFont = async () => {
    const fontUrl = "/fonts/Roboto-Regular.ttf";
    const fontResponse = await fetch(fontUrl);
    if (!fontResponse.ok) throw new Error("Font yüklenemedi.");
    const fontData = await fontResponse.arrayBuffer();
    const fontBase64 = arrayBufferToBase64(fontData);
    doc.addFileToVFS("Roboto-Regular.ttf", fontBase64);
    doc.addFont("Roboto-Regular.ttf", "Roboto", "normal");
    doc.setFont("Roboto");
  };
  await loadFont();

  const fetchBlobImage = async (url) => {
    const response = await fetch(url);
    if (!response.ok) throw new Error(`Fotoğraf yüklenemedi: ${url}`);
    const blob = await response.blob();
    return new Promise((resolve) => {
      const reader = new FileReader();
      reader.onload = () => resolve(reader.result);
      reader.readAsDataURL(blob);
    });
  };

  const replaceTurkishChars = (text) => {
    if (!text) return "";
    return text
      .replace(/Ş/g, "S")
      .replace(/ş/g, "s")
      .replace(/İ/g, "I")
      .replace(/ı/g, "i")
      .replace(/Ç/g, "C")
      .replace(/ç/g, "c")
      .replace(/Ü/g, "U")
      .replace(/ü/g, "u")
      .replace(/Ö/g, "O")
      .replace(/ö/g, "o")
      .replace(/Ğ/g, "G")
      .replace(/ğ/g, "g");
  };

  // ---------------- Sepet Bilgilerini Çekme ----------------
  const cartInfoResponse = await fetch(`http://192.168.30.4:3000/cart-info/${conceptId}`);
  if (!cartInfoResponse.ok) throw new Error("Sepet bilgileri alınamadı.");
  const cartInfo = await cartInfoResponse.json();
  window.currentCartInfo = cartInfo;
  let globalCurrency = window.selectedCurrency;
  if (cartInfo.PRICE_TYPE === "1" || cartInfo.PRICE_TYPE === "2") globalCurrency = "TRY";
  if (cartInfo.PRICE_TYPE === "3" || cartInfo.PRICE_TYPE === "4") globalCurrency = "USD";
  if (cartInfo.PRICE_TYPE === "5" || cartInfo.PRICE_TYPE === "6") globalCurrency = "EUR";

  // ---------------- Header & Footer ----------------
  const addHeader = () => {
    const headerY = margin;
    const title = cartInfo.CUSTOMER_NAME || (language === "tr" ? "KONSEPT" : "CONCEPT");
    doc.setFontSize(18);
    doc.text(title, pageWidth / 2, headerY + 10, { align: "center" });
  };

  const addFooter = async () => {
    let logoBase64 = "";
    try {
      logoBase64 = await fetchBlobImage("/resim/EDLogo.png");
    } catch (error) {
      console.error("Logo yüklenemedi:", error);
      return;
    }
    const logoWidth = 35;
    const logoHeight = 7.5;
    const x = (pageWidth - logoWidth) / 2;
    const y = pageHeight - margin - logoHeight;
    doc.addImage(logoBase64, "PNG", x, y, logoWidth, logoHeight);
  };

  // ---------------- Ürün Verilerini Çekme ----------------
	 const fetchCartData = async (cartId, language = "tr", currency = "TL") => {
	 currency = window.selectedCurrency;
     console.log("GeneratePDF Başında:", currency);
	  const endpoint = language === "en"
		? `/api/cart/${cartId}/pdfdata-en?currency=${currency}`
		: `/api/cart/${cartId}/pdfdata?currency=${currency}`;
		 console.log("Fetching cart data with parameters:", { cartId, language, currency, endpoint })
	  const response = await fetch(endpoint);
	  if (!response.ok) throw new Error("Sepet verisi alınamadı.");
	  const result = await response.json();
	  if (!result.success) throw new Error(result.message);
	  return result.data;
	};


  let cartData = await fetchCartData(conceptId, language);

  // ---------------- Ürün Sıralaması (Global Toplamlar için) ----------------
  const groupOrder =
    language === "en"
      ? ["MAIN CONCEPT", "ADDITIONAL ITEMS", "ADDITIONAL ACCESSORIES", "ACCESSORIES", "SUPPLEMENTARY", "OTHER"]
      : ["ANA KONSEPT", "TAMAMLAYICI URUNLER", "TAMAMLAYICI AKSESUARLAR", "EK AKSESUARLAR", "EK URUNLER", "DIGER"];
  const defaultGroup = language === "en" ? "OTHER" : "DIGER";
  
  // Global toplam hesaplamalarında EK URUNLER (SUPPLEMENTARY) hariç tutuluyor.
  let totalQuantity = 0;
  let totalAmount = 0;
  cartData.forEach((item) => {
    const groupKey = (item.CONCEPTGRUP || defaultGroup).toUpperCase();
    if (
  (language === "en" && groupKey !== "SUPPLEMENTARY" && groupKey !== "ACCESSORIES") ||
  (language !== "en" && groupKey !== "EK URUNLER" && groupKey !== "EK AKSESUARLAR")
) {
      const quantity = Number(item.QUANTITY);
      const price = item.CUSTOM_CODE ? (item.CUSTOM_PRICE || 0) : (item.PRICE || 0);
      const discountRate = item.CUSTOM_CODE ? (item.CUSTOM_DISCOUNT_RATE || 0) : (item.DISCOUNT_RATE || 0);
      const discountedPrice = price * (1 - discountRate / 100);
      totalQuantity += quantity;
      totalAmount += discountedPrice * quantity;
    }
  });
    // Global döviz mapping
  const currencyMapping = {
    "1": "TRY",
    "2": "TL",
    "3": "USD",
    "4": "USD",
    "5": "EUR",
    "6": "EUR",
  };

  // ---------------- İlk Bölüm: Grid Görünümü (Fotoğraflar ve Bilgiler) ----------------
  const imgWidth = 40, imgHeight = 40;
  const infoHeight = 10;
  const cellHeight = imgHeight + infoHeight;
  const gapX = 5, gapY = 5;
  const gridStartY = margin + 20; // Grid başlangıç Y değeri
  const availableHeight = pageHeight - margin - 20 - 10;
  const maxRowsPerColumn = Math.floor(availableHeight / (cellHeight + gapY));
  const cellWidth = imgWidth;
  const availableWidth = pageWidth - 2 * margin;
  const maxColsPerPage = Math.floor(availableWidth / (cellWidth + gapX));

  // Grid alanını gruplara ayırıyoruz:
  // İlk grup: ANA KONSEPT ve TAMAMLAYICI URUNLER
  // İkinci grup: AKSESUARLAR, EK URUNLER ve varsa DİĞER
  const firstGroupNames = language === "en" 
    ? ["MAIN CONCEPT", "ADDITIONAL ITEMS", "ADDITIONAL ACCESSORIES"] 
    : ["ANA KONSEPT", "TAMAMLAYICI URUNLER", "TAMAMLAYICI AKSESUARLAR"];
  const secondGroupNames = language === "en" 
    ? ["ACCESSORIES", "SUPPLEMENTARY", "OTHER"] 
    : ["EK AKSESUARLAR", "EK URUNLER", "DIGER"];

  const getGroupKey = (item) => (item.CONCEPTGRUP || defaultGroup).toUpperCase();
  const firstGroupItems = cartData.filter(item => firstGroupNames.includes(getGroupKey(item)));
  const secondGroupItems = cartData.filter(item => secondGroupNames.includes(getGroupKey(item)));

  // Her iki grup içerisindeki ürünleri, fiyata göre (azalan) sıralayalım.
  const sortByPriceDescending = (a, b) => {
    const priceA = Number(a.CUSTOM_CODE ? (a.CUSTOM_PRICE || 0) : (a.PRICE || 0));
    const priceB = Number(b.CUSTOM_CODE ? (b.CUSTOM_PRICE || 0) : (b.PRICE || 0));
    return priceB - priceA;
  };

  firstGroupItems.sort(sortByPriceDescending);
  secondGroupItems.sort(sortByPriceDescending);

  // Grid görünümünü oluşturmak için yardımcı fonksiyon
  const renderGridItems = async (items) => {
    let currentCol = 0, currentRow = 0;
    let gridX = margin, gridY = gridStartY;
    for (let i = 0; i < items.length; i++) {
      const item = items[i];
      let productImg = "";
      const imageUrl = `/resim/${item.PRODUCT_ID}.jpg`;
      try {
        productImg = await fetchBlobImage(imageUrl);
      } catch (error) {
        try {
          productImg = await fetchBlobImage("/resim/YOK.jpg");
        } catch (e) {
          console.error("Varsayılan fotoğraf alınamadı:", e);
        }
      }
      // Sayfa sınırını aşıyorsa yeni sayfaya geç
      if (gridY + cellHeight > pageHeight - margin) {
        await addFooter();
        doc.addPage();
        addHeader();
        currentCol = 0;
        currentRow = 0;
        gridX = margin;
        gridY = gridStartY;
      }
      if (productImg) {
        doc.addImage(productImg, "JPEG", gridX, gridY, imgWidth, imgHeight);
      }
      // Fotoğraf altındaki bilgi kısmı: Güncel düzenlemeniz uygulanıyor.
      const labels = language === "en"
        ? { model: "Model", code: "Code", size: "Size", inch: "Inch", price: "Price" }
        : { model: "Model", code: "Kod", size: "Ebat", inch: "İnç", price: "Fiyat" };
      const infoText = `${labels.model}: ${item.MODEL || "N/A"}\n${labels.code}: ${item.CUSTOM_CODE || item.PRODUCT_ID}\n${labels.size}: ${item.EBAT || "N/A"}\n${labels.inch}: ${item.EBATINCH || "N/A"}\n${labels.price}: ${formatNumber(item.PRICE) || "N/A"} ${window.selectedCurrency || "TRY"}`;
      doc.setFontSize(7);
      doc.text(infoText, gridX, gridY + imgHeight + 3);
      currentRow++;
      if (currentRow >= maxRowsPerColumn) {
        currentRow = 0;
        currentCol++;
        gridX = margin + currentCol * (cellWidth + gapX);
        gridY = gridStartY;
      } else {
        gridY += cellHeight + gapY;
      }
      if (gridX + cellWidth > pageWidth - margin) {
        await addFooter();
        doc.addPage();
        addHeader();
        currentCol = 0;
        currentRow = 0;
        gridX = margin;
        gridY = gridStartY;
      }
    }
  };

  // İlk gruptaki (ANA KONSEPT & TAMAMLAYICI URUNLER) ürünleri render et
  addHeader();
  await renderGridItems(firstGroupItems);
  await addFooter();

  // İlk grup bittikten sonra yeni sayfada ikinci grubu (AKSESUARLAR, EK URUNLER, DİĞER) render et
  if (secondGroupItems.length > 0) {
    doc.addPage();
    addHeader();
    await renderGridItems(secondGroupItems);
    await addFooter();
  }

  // ---------------- İkinci Bölüm: Ürün Listesi Tablosu (Fotoğraflar olmadan) ----------------
  doc.addPage();
  addHeader();

  // Tablo başlıkları ("No" sütunu ekleniyor)
  const headersTableArr =
    language === "tr"
      ? ["No", "Ürün Kodu", "Kategori", "Model", "Ölçü cm", "Ölçü inch", "Fiyat", "Miktar", "Tutar", "Döviz"]
      : ["No", "Product Code", "Category", "Model", "Size cm", "Size inch", "Price", "Quantity", "Amount", "Currency"];

  // Gruplama: Tüm ürünler grup anahtarına göre toplanıyor
  const groupedData = cartData.reduce((groups, item) => {
    const groupKeyCandidate = (item.CONCEPTGRUP || defaultGroup).toUpperCase();
    const groupKey = groupOrder.includes(groupKeyCandidate) ? groupKeyCandidate : defaultGroup;
    if (!groups[groupKey]) {
      groups[groupKey] = [];
    }
    groups[groupKey].push(item);
    return groups;
  }, {});

  // Ayırıyoruz: Ana gruplar (EK URUNLER hariç) ve EK URUNLER grubu
  const nonSuppOrderedGroups = groupOrder
  .filter((key) =>
    key !== (language === "en" ? "SUPPLEMENTARY" : "EK URUNLER") &&
    key !== (language === "en" ? "ACCESSORIES" : "EK AKSESUARLAR") &&
    groupedData[key]
  )
  .concat(
    Object.keys(groupedData).filter((key) =>
      key !== (language === "en" ? "SUPPLEMENTARY" : "EK URUNLER") &&
      key !== (language === "en" ? "ACCESSORIES" : "EK AKSESUARLAR") &&
      !groupOrder.includes(key)
    )
  );


  // Grup isimleri (dil parametresine göre)
  const mainConceptKey = language === "en" ? "MAIN CONCEPT" : "ANA KONSEPT";
  const additionalItemsKey = language === "en" ? "ADDITIONAL ITEMS" : "TAMAMLAYICI URUNLER";
  const additionalItemsAksKey = language === "en" ? "ADDITIONAL ACCESSORIES" : "TAMAMLAYICI AKSESUARLAR";
  const accessoriesKey = language === "en" ? "ACCESSORIES" : "EK AKSESUARLAR";
  const supplementaryKey = language === "en" ? "SUPPLEMENTARY" : "EK URUNLER";

  let tableRows = [];
  let mainConceptTotals = { qty: 0, amount: 0 };
  let additionalTotals = { qty: 0, amount: 0 };
  let additionalAksTotals = { qty: 0, amount: 0 };

  // Ana gruplar için tablo satırlarını oluşturuyoruz (EK URUNLER hariç)
  nonSuppOrderedGroups.forEach((groupKey, idx) => {
    let groupItems = groupedData[groupKey];

    // Kategori toplamlarını hesaplayalım
    const categoryTotals = {};
    groupItems.forEach(item => {
      const cat = item.BASAMAK4 || "";
      const price = item.PRICE || 0;
      const discountRate = 0;
      const discountedPrice = price * (1 - discountRate / 100);
      const amount = discountedPrice * Number(item.QUANTITY);
      if (!categoryTotals[cat]) categoryTotals[cat] = 0;
      categoryTotals[cat] += amount;
    });

    // Grup içindeki ürünleri önce kategori toplamı, sonra ürün tutarına göre azalan sıralıyoruz
    groupItems.sort((a, b) => {
      const catA = a.BASAMAK4 || "";
      const catB = b.BASAMAK4 || "";
      const totalA = categoryTotals[catA] || 0;
      const totalB = categoryTotals[catB] || 0;
      if (totalB !== totalA) return totalB - totalA;
      const priceA = a.CUSTOM_CODE ? (a.CUSTOM_PRICE || 0) : (a.PRICE || 0);
      const discountRateA = 0;
      const amountA = priceA * (1 - discountRateA / 100) * Number(a.QUANTITY);
      const priceB = b.CUSTOM_CODE ? (b.CUSTOM_PRICE || 0) : (b.PRICE || 0);
      const discountRateB = b.CUSTOM_CODE ? (b.CUSTOM_DISCOUNT_RATE || 0) : (b.DISCOUNT_RATE || 0);
      const amountB = priceB * (1 - discountRateB / 100) * Number(b.QUANTITY);
      return amountB - amountA;
    });

    // Grup başlığı
    tableRows.push([
      {
        content: groupKey,
        colSpan: 10,
        styles: {
          halign: "left",
          fillColor: [230, 230, 230],
          fontStyle: "bold",
          overflow: "linebreak",
        },
      },
    ]);
    // Sütun başlıkları
    tableRows.push(headersTableArr);
    
    let rowNum = 0;
    let groupTotals = { qty: 0, amount: 0 };
    groupItems.forEach((item) => {
      rowNum++;
      const productCode = item.CUSTOM_CODE
        ? `${item.CUSTOM_CODE}\nReferans Kod: ${item.PRODUCT_ID}`
        : item.PRODUCT_ID;
      const category = replaceTurkishChars(item.BASAMAK4 || "");
      const model = replaceTurkishChars(item.MODEL || "");
      const sizeCm = replaceTurkishChars(item.EBAT || "");
      const sizeInch = replaceTurkishChars(item.EBATINCH || "");
      const price = item.PRICE || 0;
      const quantity = Number(item.QUANTITY);
      const discountRate = 0;
      const discountedPrice = price * (1 - discountRate / 100);
      const amount = discountedPrice * quantity;
	  const currencyuse = window.selectedCurrency;
      groupTotals.qty += quantity;
      groupTotals.amount += amount;
      tableRows.push([
        rowNum.toString(),
        productCode,
        category,
        model,
        sizeCm,
        sizeInch,
        formatNumber(price),
        quantity.toString(),
        formatNumber(amount),
        currencyuse || "TRY",
      ]);
    });

    // Grup alt toplam satırı
    tableRows.push([
      {
        content:
          language === "en"
            ? `Sub Total (${groupKey})`
            : `Alt Toplam (${groupKey})`,
        colSpan: 7,
        styles: {
          fontStyle: "bold",
          fillColor: [230, 230, 230],
          overflow: "linebreak",
        },
      },
      { content: groupTotals.qty.toString(), styles: { fillColor: [230, 230, 230] } },
      { content: formatNumber(groupTotals.amount), styles: { fillColor: [230, 230, 230] } },
      { content: window.selectedCurrency || "TRY", styles: { fillColor: [230, 230, 230] } },
    ]);

    if (groupKey === mainConceptKey) {
      mainConceptTotals = groupTotals;
    } else if (groupKey === additionalItemsKey) {
      additionalTotals = groupTotals;
      const nextGroup = nonSuppOrderedGroups[idx + 1];
      if (nextGroup && nextGroup === accessoriesKey || supplementaryKey) {
        const combinedQty = mainConceptTotals.qty + additionalTotals.qty;
        const combinedAmount = mainConceptTotals.amount + additionalTotals.amount;
        tableRows.push([
          {
            content:
              language === "en"
                ? `Sub Total (MAIN CONCEPT + ADDITIONAL ITEMS)`
                : `Alt Toplam (ANA KONSEPT + TAMAMLAYICI URUNLER)`,
            colSpan: 7,
            styles: { fontStyle: "bold", fillColor: [207, 207, 207], overflow: "linebreak" },
          },
          { content: combinedQty.toString(), styles: { fillColor: [207, 207, 207] } },
          { content: formatNumber(combinedAmount), styles: { fillColor: [207, 207, 207] } },
          { content: window.selectedCurrency || "TRY", styles: { fillColor: [207, 207, 207] } },
        ]);
      }
    } else if (groupKey === additionalItemsAksKey) {
	  additionalAksTotals = groupTotals;
	  const combinedQty = mainConceptTotals.qty + additionalTotals.qty + additionalAksTotals.qty;
	  const combinedAmount = mainConceptTotals.amount + additionalTotals.amount + additionalAksTotals.amount;
	  tableRows.push([
		{
		  content:
			language === "en"
			  ? `Sub Total (MAIN CONCEPT + ADDITIONAL ITEMS + ADDITIONAL ACCESSORIES)`
			  : `Alt Toplam (ANA KONSEPT + TAMAMLAYICI URUNLER + TAMAMLAYICI AKSESUARLAR)`,
		  colSpan: 7,
		  styles: { fontStyle: "bold", fillColor: [207, 207, 207], overflow: "linebreak" },
		},
		{ content: combinedQty.toString(), styles: { fillColor: [207, 207, 207] } },
		{ content: formatNumber(combinedAmount), styles: { fillColor: [207, 207, 207] } },
		{ content: currencyMapping[cartInfo.PRICE_TYPE] || "TRY", styles: { fillColor: [207, 207, 207] } },
	  ]);
	}

    if (groupKey !== accessoriesKey) {
      tableRows.push(
        Array.from({ length: 10 }, () => ({
          content: "",
          styles: { fillColor: [255, 255, 255] },
        }))
      );
    }
  });

  // Ana tablo AutoTable
  doc.autoTable({
    head: false,
    body: tableRows,
    foot: [
      [{
          content:
            language === "en"
              ? `Total `
              : `Toplam `,
          colSpan: 7,
          styles: { fontStyle: "bold", fillColor: [207, 207, 207], overflow: "linebreak" },
        },
        { content: totalQuantity.toString(), styles: { halign: "right" } },
        { content: formatNumber(totalAmount), styles: { halign: "right" } },
        { content: window.selectedCurrency || "TRY", styles: { halign: "center" } },
      ],
    ],
    footStyles: {
      fillColor: [207, 207, 207],
      fontStyle: "bold",
      textColor: [0, 0, 0],
    },
    showFoot: "lastpage", // global toplam none ile gizlenir. lastpage ile son sayfada gösterilir.
    startY: margin + 20,
    margin: { left: margin, right: margin },
    theme: "striped",
    styles: {
      cellPadding: 2,
      fontSize: 8,
      overflow: "ellipsize",
      valign: "middle",
      halign: "left",
      minCellHeight: 6,
    },
    headStyles: {
      fillColor: [220, 220, 220],
      fontSize: 8,
      fontStyle: "bold",
      textColor: [102, 102, 102],
      minCellHeight: 6,
    },
    columnStyles: {
      0: { cellWidth: 10, halign: "center" },
      1: { cellWidth: 30, halign: "left" },
      2: { cellWidth: 50, halign: "left" },
      3: { cellWidth: 40, halign: "left" },
      4: { cellWidth: 30, halign: "left" },
      5: { cellWidth: 30, halign: "left" },
      6: { cellWidth: 25, halign: "right" },
      7: { cellWidth: 25, halign: "right" },
      8: { cellWidth: 25, halign: "right" },
      9: { cellWidth: 20, halign: "center" },
    },
    didDrawPage: (data) => {
      if (data.pageNumber > 1) {
        doc.autoTable.previous.finalY = margin + 10;
      }
    },
  });
  
  // ---------------- EK URUNLER Grubunu Aynı Sayfada, Boş Bir Satır Sonrası Ekle ----------------
  if (groupedData[supplementaryKey] && groupedData[supplementaryKey].length > 0) {
    // Yeni sayfa eklemiyoruz; mevcut sayfadaki autotable'ın finalY'sinden 6 mm aşağıdan başlıyoruz.
    const startYSupp = doc.lastAutoTable.finalY + 6;
    let suppItems = groupedData[supplementaryKey];

    // Kategori toplamlarını hesaplayalım
    const suppCategoryTotals = {};
    suppItems.forEach(item => {
      const cat = item.BASAMAK4 || "";
      const price = item.CUSTOM_CODE ? (item.CUSTOM_PRICE || 0) : (item.PRICE || 0);
      const discountRate = item.CUSTOM_CODE ? (item.CUSTOM_DISCOUNT_RATE || 0) : (item.DISCOUNT_RATE || 0);
      const discountedPrice = price * (1 - discountRate / 100);
      const amount = discountedPrice * Number(item.QUANTITY);
      if (!suppCategoryTotals[cat]) suppCategoryTotals[cat] = 0;
      suppCategoryTotals[cat] += amount;
    });

    // EK URUNLER grubunu sıralıyoruz (önce kategori toplamı, sonra ürün tutarı azalan)
    suppItems.sort((a, b) => {
      const catA = a.BASAMAK4 || "";
      const catB = b.BASAMAK4 || "";
      const totalA = suppCategoryTotals[catA] || 0;
      const totalB = suppCategoryTotals[catB] || 0;
      if (totalB !== totalA) return totalB - totalA;
      const priceA = a.CUSTOM_CODE ? (a.CUSTOM_PRICE || 0) : (a.PRICE || 0);
      const discountRateA = a.CUSTOM_CODE ? (a.CUSTOM_DISCOUNT_RATE || 0) : (a.DISCOUNT_RATE || 0);
      const amountA = priceA * (1 - discountRateA / 100) * Number(a.QUANTITY);
      const priceB = b.CUSTOM_CODE ? (b.CUSTOM_PRICE || 0) : (b.PRICE || 0);
      const discountRateB = b.CUSTOM_CODE ? (b.CUSTOM_DISCOUNT_RATE || 0) : (b.DISCOUNT_RATE || 0);
      const amountB = priceB * (1 - discountRateB / 100) * Number(b.QUANTITY);
      return amountB - amountA;
    });

    // EK URUNLER için tablo satırlarını oluşturalım
    let suppTableRows = [];
    suppTableRows.push([
      {
        content: supplementaryKey,
        colSpan: 10,
        styles: {
          halign: "left",
          fillColor: [230, 230, 230],
          fontStyle: "bold",
          overflow: "linebreak",
        },
      },
    ]);
    suppTableRows.push(headersTableArr);
    let rowNum = 0;
    let suppTotals = { qty: 0, amount: 0 };
    suppItems.forEach((item) => {
      rowNum++;
      const productCode = item.CUSTOM_CODE
        ? `${item.CUSTOM_CODE}\nReferans Kod: ${item.PRODUCT_ID}`
        : item.PRODUCT_ID;
      const category = replaceTurkishChars(item.BASAMAK4 || "");
      const model = replaceTurkishChars(item.MODEL || "");
      const sizeCm = replaceTurkishChars(item.EBAT || "");
      const sizeInch = replaceTurkishChars(item.EBATINCH || "");
      const price = item.CUSTOM_CODE ? (item.CUSTOM_PRICE || 0) : (item.PRICE || 0);
      const quantity = Number(item.QUANTITY);
      const discountRate = item.CUSTOM_CODE ? (item.CUSTOM_DISCOUNT_RATE || 0) : (item.DISCOUNT_RATE || 0);
      const discountedPrice = price * (1 - discountRate / 100);
      const amount = discountedPrice * quantity;
	  const currencyuse = window.selectedCurrency;
      suppTotals.qty += quantity;
      suppTotals.amount += amount;
      suppTableRows.push([
        rowNum.toString(),
        productCode,
        replaceTurkishChars(item.BASAMAK4 || ""),
        replaceTurkishChars(item.MODEL || ""),
        replaceTurkishChars(item.EBAT || ""),
        replaceTurkishChars(item.EBATINCH || ""),
        formatNumber(price),
        quantity.toString(),
        formatNumber(amount),
        currencyuse || "TRY",
      ]);
    });
    suppTableRows.push([
      {
        content:
          language === "en"
            ? `Sub Total (${supplementaryKey})`
            : `Alt Toplam (${supplementaryKey})`,
        colSpan: 7,
        styles: {
          fontStyle: "bold",
          fillColor: [230, 230, 230],
          overflow: "linebreak",
        },
      },
      { content: suppTotals.qty.toString(), styles: { fillColor: [230, 230, 230] } },
      { content: formatNumber(suppTotals.amount), styles: { fillColor: [230, 230, 230] } },
      { content: window.selectedCurrency || "TRY", styles: { fillColor: [230, 230, 230] } },
    ]);

    doc.autoTable({
      head: false,
      body: suppTableRows,
      startY: startYSupp,
      margin: { left: margin, right: margin },
      theme: "striped",
      styles: {
        cellPadding: 2,
        fontSize: 8,
        overflow: "ellipsize",
        valign: "middle",
        halign: "left",
        minCellHeight: 6,
      },
      headStyles: {
        fillColor: [220, 220, 220],
        fontSize: 8,
        fontStyle: "bold",
        textColor: [102, 102, 102],
        minCellHeight: 6,
      },
      columnStyles: {
        0: { cellWidth: 10, halign: "center" },
        1: { cellWidth: 30, halign: "left" },
        2: { cellWidth: 50, halign: "left" },
        3: { cellWidth: 40, halign: "left" },
        4: { cellWidth: 30, halign: "left" },
        5: { cellWidth: 30, halign: "left" },
        6: { cellWidth: 25, halign: "right" },
        7: { cellWidth: 25, halign: "right" },
        8: { cellWidth: 25, halign: "right" },
        9: { cellWidth: 20, halign: "center" },
      },
      didDrawPage: (data) => {
        if (data.pageNumber > 1) {
          doc.autoTable.previous.finalY = margin + 10;
        }
      },
    });
  }
  
  await addFooter();

  const fileName =
    language === "tr"
      ? `KONSEPT-Formu - ${cartInfo.CUSTOMER_NAME || "N/A"}.pdf`
      : `CONCEPT-Form - ${cartInfo.CUSTOMER_NAME || "N/A"}.pdf`;
  doc.save(fileName);
};


// Basamak2 ve Basamak4 dropdownlarını yükleme örneği
async function loadBarcodeBasamakOptions() {
  const basamak2Select = document.getElementById("barcodeBasamak2");
  const basamak4Select = document.getElementById("barcodeBasamak4");
  const KodSelect = document.getElementById("barcodeKod");
  try {
    // Filter-options endpoint'inden tüm filtre verileri alınır
    const response = await fetch("http://192.168.30.4:3000/filter-options");
    if (!response.ok) throw new Error("Filter options alınamadı.");
    const filters = await response.json();
    
    // BASAMAK2 için benzersiz değerleri çıkaralım
    const basamak2Set = new Set();
    filters.forEach(item => {
      if (item.BASAMAK2) {
        basamak2Set.add(item.BASAMAK2);
      }
    });
    
    let optionsHtml = `<option value="">Seçiniz</option>`;
    basamak2Set.forEach(val => {
      optionsHtml += `<option value="${val}">${val}</option>`;
    });
    basamak2Select.innerHTML = optionsHtml;
    $(basamak2Select).selectpicker("refresh");

    // Basamak2 değiştiğinde, ilgili BASAMAK4 değerlerini filtreleyelim
    basamak2Select.addEventListener("change", function() {
      const selectedBasamak2 = this.value;
      const basamak4Set = new Set();
      filters.forEach(item => {
        if (item.BASAMAK2 === selectedBasamak2 && item.BASAMAK4) {
          basamak4Set.add(item.BASAMAK4);
        }
      });
      let options4 = `<option value="">Seçiniz</option>`;
      basamak4Set.forEach(val => {
        options4 += `<option value="${val}">${val}</option>`;
      });
      basamak4Select.innerHTML = options4;
      $(basamak4Select).selectpicker("refresh");
    });
    
    // Başlangıçta BASAMAK4 boş
    basamak4Select.innerHTML = `<option value="">Seçiniz</option>`;
    $(basamak4Select).selectpicker("refresh");
	
	// KOD için benzersiz değerleri çıkaralım
    const KodSet = new Set();
    filters.forEach(item => {
      if (item.KOD) {
        KodSet.add(item.KOD);
      }
    });
    
    let optionsKod = `<option value="">Seçiniz</option>`;
    KodSet.forEach(val => {
      optionsKod += `<option value="${val}">${val}</option>`;
    });
    KodSelect.innerHTML = optionsKod;
    $(KodSelect).selectpicker("refresh");
  } catch (err) {
    console.error(err);
  }
}


// Ürünleri getirme ve barkod etiketlerini oluşturma
async function loadBarcodeProducts() {
  const basamak2 = document.getElementById("barcodeBasamak2").value;
  const basamak4 = document.getElementById("barcodeBasamak4").value;
  const Kod = document.getElementById("barcodeKod").value;
  const stoklu = document.getElementById("filterStoklu").checked;
  const priceOption = document.querySelector('input[name="priceOption"]:checked').value; // "with" veya "without"
  const labelType = document.querySelector('input[name="labelType"]:checked').value; // "large" veya "small"

  let query = `?`;
  if (basamak2) query += `basamak2=${basamak2}&`;
  if (basamak4) query += `basamak4=${basamak4}&`;
  if (Kod) query += `kod=${Kod}&`;
  if (stoklu) query += `stoklu=true&`;

  try {
    const response = await fetch(`http://192.168.30.4:3000/api/skart-ozellik${query}`);
    
	if (!response.ok) throw new Error("Ürünler alınamadı.");
    const result = await response.json();
	
    if (!result.success) throw new Error(result.message);
    const products = result.data;
    renderBarcodeLabels(products, priceOption, labelType);
  } catch (err) {
    alert(err.message);
  }
}

function renderBarcodeLabels(products, priceOption, labelType) {
  // Ürün ve konsept konteynerlerini temizleyip, gizleyelim:
  document.getElementById('product-container').innerHTML = "";
  const conceptContainer = document.getElementById('concept-products-container');
  if (conceptContainer && conceptContainer.style.display !== "none") {
    conceptContainer.style.display = "none";
  }
  const initialImageContainer = document.getElementById("initialImageContainer");
  if (initialImageContainer) initialImageContainer.style.display = "none";
  
  const container = document.getElementById("barcodeLabelsContainer");
  container.innerHTML = "";
  
  products.forEach(prod => {
    const stock = prod.HM || 1; // Stok sayısı
    // Null değerleri boş string ile değiştirelim:
    const barkod = prod.BARKOD ? prod.BARKOD.toString() : "";
    const kod = prod.KOD || "";
    const model = prod.MODEL || "";
    const ebat = prod.EBAT || "";
    const renk = prod.RENK || "";
    const desen = prod.DESEN || "";
    const lamine = prod.LAMINE || "";
    const fiyat = prod.SFIYAT1; // TL fiyatı
    
    for (let i = 0; i < stock; i++) {
      let labelDiv = document.createElement("div");
      labelDiv.classList.add("barcode-label");
      labelDiv.style.boxSizing = "border-box";
      labelDiv.style.fontFamily = "Arial, sans-serif";
      labelDiv.style.textAlign = "center";
      labelDiv.style.position = "relative";
      labelDiv.style.margin = "2mm"; // ekran görünümü için
      labelDiv.style.pageBreakAfter = "always";
      labelDiv.style.pageBreakInside = "avoid";
      
      if (labelType === "large") {
        // Büyük etiket: 78mm genişlik, 27mm yükseklik
        labelDiv.style.width = "78mm";
        labelDiv.style.height = "26mm";
        labelDiv.style.border = "1px solid #000";
        labelDiv.style.padding = "1mm";
  
        // Barkod SVG: genişlik %117, yükseklik 9.6mm
        let svg = document.createElementNS("http://www.w3.org/2000/svg", "svg");
        svg.id = `barcode-${kod}-${i}`;
        svg.style.display = "block";
        svg.style.margin = "0 auto";
        svg.style.width = "117%";
        svg.style.height = "9.6mm";
        labelDiv.appendChild(svg);
  
        // "KOD - FİYAT" satırı (font 10px)
        let kodFiyatDiv = document.createElement("div");
        kodFiyatDiv.style.fontSize = "10px";
        kodFiyatDiv.style.marginTop = "1mm";
        let fiyatText = "";
        if (priceOption === "with" && fiyat != null) {
          fiyatText = new Intl.NumberFormat('tr-TR', { 
            style: 'currency', 
            currency: 'TRY', 
            minimumFractionDigits: 0 
          }).format(fiyat);
        }
        kodFiyatDiv.innerText = kod + (fiyatText ? " - " + fiyatText : "");
        labelDiv.appendChild(kodFiyatDiv);
  
        // "Model:" satırı: Sol hizalı, Model ve Ebat bilgileri
        let modelEbatDiv = document.createElement("div");
        modelEbatDiv.style.fontSize = "10px";
        modelEbatDiv.style.marginTop = "1mm";
        modelEbatDiv.style.textAlign = "left";
        let modelEbatText = "";
        if (model) modelEbatText += "Model: " + model;
        if (model && ebat) modelEbatText += "     " + "Ebat: " + ebat; // ilave 5 boşluk bırakıldı
        modelEbatDiv.innerText = modelEbatText;
        labelDiv.appendChild(modelEbatDiv);
  
        // "Renk/Desen/Lamine:" satırı: Sol hizalı, boş alanlar çıkarılarak
        let renkDiv = document.createElement("div");
        renkDiv.style.fontSize = "10px";
        renkDiv.style.marginTop = "1mm";
        renkDiv.style.textAlign = "left";
        let renkText = "";
        if (renk) renkText += renk;
        if (renk && desen) {
          renkText += " - " + desen;
        } else if (desen) {
          renkText += desen;
        }
        if ((renk || desen) && lamine) {
          renkText += " - " + lamine;
        } else if (lamine) {
          renkText += lamine;
        }
        // Birden fazla tireyi tek tireye indirgemek ve baştaki/sondaki tireyi kaldırmak:
        renkText = renkText.split('-')
                   .map(s => s.trim())
                   .filter(s => s !== "")
                   .join(" - ");
        if (renkText) {
          renkText = "Renk/Desen/Lamine: " + renkText;
        }
        renkDiv.innerText = renkText;
        labelDiv.appendChild(renkDiv);
  
        // Sağ alt köşede "03/25" (font 8px)
        let footerDiv = document.createElement("div");
        footerDiv.innerText = "03/25";
        footerDiv.style.fontSize = "8px";
        footerDiv.style.position = "absolute";
        footerDiv.style.bottom = "1mm";
        footerDiv.style.right = "1mm";
        labelDiv.appendChild(footerDiv);
  
        container.appendChild(labelDiv);
  
        // Barkodu oluştur: JsBarcode kullanılarak
        if (typeof JsBarcode !== "undefined") {
          JsBarcode(`#barcode-${kod}-${i}`, barkod, {
            format: "CODE128",
            displayValue: false,
            height: 9.6 * 3.78, // yaklaşık 36px
            margin: 0,
            width: 1
          });
        }
      } else {
        // Küçük etiket: 40mm genişlik, 18mm yükseklik
        labelDiv.style.width = "40mm";
        labelDiv.style.height = "18mm";
        labelDiv.style.border = "1px solid #000";
        labelDiv.style.padding = "1mm";
        labelDiv.style.position = "relative";
  
        // Sol alt köşeye logo ekleyelim: /resim/ED.png, genişliği 4mm
        let logoSmall = document.createElement("img");
        logoSmall.src = "/resim/ED.png";
        logoSmall.alt = "ED";
        logoSmall.style.width = "4mm";
        logoSmall.style.height = "auto";
        logoSmall.style.position = "absolute";
        logoSmall.style.bottom = "1mm";
        logoSmall.style.left = "1mm";
        labelDiv.appendChild(logoSmall);
  
        // Barkod SVG
        let svgSmall = document.createElementNS("http://www.w3.org/2000/svg", "svg");
        svgSmall.id = `barcode-small-${kod}-${i}`;
        svgSmall.style.display = "block";
        svgSmall.style.margin = "0 auto";
        svgSmall.style.width = "90%";
        svgSmall.style.height = "8mm";
        labelDiv.appendChild(svgSmall);
  
        // Üst satır: KOD (büyük font, sol hizalı)
        let kodDivSmall = document.createElement("div");
        kodDivSmall.style.fontSize = "9px";
        kodDivSmall.style.marginTop = "1mm";
        kodDivSmall.style.textAlign = "center";
        kodDivSmall.style.fontWeight = "bold";
        kodDivSmall.innerText = kod;
        labelDiv.appendChild(kodDivSmall);
  
        // Alt satır: Fiyat (büyük font, sol hizalı); fiyat seçeneğine göre
        let fiyatDivSmall = document.createElement("div");
        fiyatDivSmall.style.fontSize = "9px";
        fiyatDivSmall.style.marginTop = "1mm";
        fiyatDivSmall.style.textAlign = "center";
        let fiyatTextSmall = "";
        if (priceOption === "with" && fiyat != null) {
          fiyatTextSmall = new Intl.NumberFormat('tr-TR', { 
            style: 'currency', 
            currency: 'TRY', 
            minimumFractionDigits: 0 
          }).format(fiyat);
        }
        fiyatDivSmall.innerText = fiyatTextSmall;
        labelDiv.appendChild(fiyatDivSmall);
  
        // Sağ alt köşede "03/25" (font 8px)
        let footerDivSmall = document.createElement("div");
        footerDivSmall.innerText = "03/25";
        footerDivSmall.style.fontSize = "8px";
        footerDivSmall.style.position = "absolute";
        footerDivSmall.style.bottom = "1mm";
        footerDivSmall.style.right = "1mm";
        labelDiv.appendChild(footerDivSmall);
  
        container.appendChild(labelDiv);
  
        if (typeof JsBarcode !== "undefined") {
          JsBarcode(`#barcode-small-${kod}-${i}`, barkod, {
            format: "CODE128",
            displayValue: false,
            height: 8 * 3.78, // yaklaşık 30px
            margin: 0,
            width: 1
          });
        }
      }
    }
  });
}


//Barkod Yazdırma fonksiyonu
function printBarcodes() {
  const container = document.getElementById("barcodeLabelsContainer");
  if (!container) {
    alert("Barkod etiketleri bulunamadı.");
    return;
  }
  const printContents = container.innerHTML;
  if (!printContents.trim()) {
    alert("Barkod etiketleri henüz oluşturulmamış.");
    return;
  }
  
  // Yeni bir pencere açıp yazdırma içeriğini ekleyelim
  const printWindow = window.open("", "", "height=600,width=800");
  printWindow.document.write("<html><head><title>Barkod Etiketleri</title>");
  printWindow.document.write("<style>");
  // Yazdırma modunda tüm kenar boşluklarını sıfır yapacak CSS kuralları:
  printWindow.document.write("@page { margin: 0; }");
  printWindow.document.write("body { margin: 0; padding: 0; }");
  printWindow.document.write(".barcode-label { page-break-after: always; page-break-inside: avoid; border: none !important; }");
  printWindow.document.write("</style>");
  printWindow.document.write("</head><body>");
  printWindow.document.write(printContents);
  printWindow.document.write("</body></html>");
  printWindow.document.close();
  printWindow.focus();
  printWindow.print();
  // Not: Pencere otomatik kapatılmaz; böylece kullanıcı seçenekleri görebilir.
}

//Konsept Etiketleri için dropdown doldurma fonksiyonu
async function loadConceptLabelOptions() {
  try {
    const response = await fetch('http://192.168.30.4:3000/concept-label-options');
    if (!response.ok) {
      throw new Error('Konsept etiket seçenekleri alınamadı.');
    }
    const data = await response.json();

    // Verileri, önce CONCEPT_AREA, sonra CUSTOMER_NAME'ye göre sıralıyoruz.
    data.sort((a, b) => {
      const areaCompare = a.CONCEPT_AREA.localeCompare(b.CONCEPT_AREA, 'tr', { sensitivity: 'base' });
      if (areaCompare !== 0) return areaCompare;
      return a.CUSTOMER_NAME.localeCompare(b.CUSTOMER_NAME, 'tr', { sensitivity: 'base' });
    });

    const dropdown = document.getElementById('conceptLabelDropdown');
    dropdown.innerHTML = '<option value="">Seçiniz</option>';
    data.forEach(item => {
      const option = document.createElement('option');
      option.value = item.ID; // CART.ID saklanır
      option.textContent = `${item.CUSTOMER_NAME} // ${item.CONCEPT_AREA}`;
      dropdown.appendChild(option);
    });

    // Eğer Bootstrap Select kullanıyorsanız, selectpicker'ı yenileyin:
    if (window.jQuery && $(dropdown).selectpicker) {
      $(dropdown).selectpicker('refresh');
    }
  } catch (error) {
    console.error('Konsept etiket seçenekleri yüklenirken hata:', error);
  }
}

//showfiltercontainer
function showfiltercontainer (){
  // Barkod konteynerini gizle
  document.getElementById("barcodeContainer").style.display = "none";
  document.getElementById("conceptLabelContainer").style.display = "none";
  const initialImageContainer = document.getElementById("initialImageContainer");
  if (initialImageContainer) initialImageContainer.style.display = "none";
  // Diğer konteynerleri göster
  document.getElementById("product-container").style.display = "block"; 
}

// Göster butonuna tıklandığında ilgili konteyneri açan fonksiyon
function showBarcodeContainer() {
  // Diğer konteynerleri gizle
  const productContainer = document.getElementById("product-container");
    if (productContainer) productContainer.style.display = "none";
    const initialImageContainer = document.getElementById("initialImageContainer");
    if (initialImageContainer) initialImageContainer.style.display = "none";
    const conceptContainer = document.getElementById("concept-products-container");
    if (conceptContainer) {
      conceptContainer.style.display = "none";
      
    }
  // Barkod konteynerini göster
  document.getElementById("barcodeContainer").style.display = "block";
  // Basamak dropdownlarını yükleyelim
  loadBarcodeBasamakOptions();
}

// Konsept Etiket Menü Öğesi ile konteyneri açan fonksiyon
function showconceptLabelContainer() {
  // Diğer konteynerleri gizle
  const productContainer = document.getElementById("product-container");
    if (productContainer) productContainer.style.display = "none";
    const initialImageContainer = document.getElementById("initialImageContainer");
    if (initialImageContainer) initialImageContainer.style.display = "none";
    const conceptContainer = document.getElementById("concept-products-container");
    if (conceptContainer) {
      conceptContainer.style.display = "none";
      
    }
  // Barkod konteynerini göster
  document.getElementById("conceptLabelContainer").style.display = "block";
  // Basamak dropdownlarını yükleyelim
  loadConceptLabelOptions();
}

// Konsept Etiket konteyneri dil öğesi seçimi olay dinleyicileri
document.getElementById("turkceEtiket").addEventListener("change", function() {
  if (this.checked) {
    document.getElementById("ingilizceEtiket").checked = false;
  }
});

document.getElementById("ingilizceEtiket").addEventListener("change", function() {
  if (this.checked) {
    document.getElementById("turkceEtiket").checked = false;
  }
});
         
// Global sayaç: etiketlere sıra numarası vermek için
let labelIndexCounter = 1;

// Yaklaşık 148 mm yüksekliğe denk gelen eşik (148 mm ≈ 148 * 3.78 ≈ 560px)
const THRESHOLD_PX = 560; 

// Belirtilen verilerle (conceptNameDisplay, formattedDate) sabit ebatlı etiket (label) oluşturur.
// Artık labelPosition parametresi kullanılmıyor; her etiket oluşturulduğunda
// data-label-index atanıyor.
function createLabel(conceptNameDisplay, formattedDate) {
  const label = document.createElement("div");
  label.className = "print-label";
  label.style.width = "168mm";
  label.style.height = "148mm";
  label.style.boxSizing = "border-box";
  label.style.border = "1px solid #000";
  label.style.padding = "5mm";
  label.style.position = "relative";
  // Gizli sıra numarası ata ve sayaç artır
  label.setAttribute("data-label-index", labelIndexCounter);
  labelIndexCounter++;

  // Header: logo, konsept adı, tarih
  const header = document.createElement("div");
  header.className = "print-header";
  header.innerHTML = `
    <div style="display: flex; justify-content: space-between; align-items: center;">
      <img src="/resim/EDLogo2.jpg" style="width: 6cm;">
      <div style="display: flex; flex-direction: column; align-items: flex-end;">
        <div style="font-size: 16px;">${conceptNameDisplay}</div>
        <div style="font-size: 10px;">${formattedDate}</div>
      </div>
    </div>`;
  label.appendChild(header);
  
  // İçerik alanı: Header'dan sonra gelecek
  const content = document.createElement("div");
  content.className = "label-content";
  // Header için yaklaşık 15mm boşluk bırakıyoruz
  content.style.marginTop = "15mm";
  label.appendChild(content);
  
  return { label, content };
}
 
// Yeni A4 sayfası oluşturur. Her A4 sayfası 2 etiket (ilk ve ikinci) barındırır.
function createNewA4Page(conceptNameDisplay, formattedDate) {
  const page = document.createElement("div");
  page.className = "a4-page";
  // A4 ölçüsü: 210mm x 297mm (kenar boşlukları sıfır kabul ediliyor)
  page.style.width = "210mm";
  page.style.height = "297mm";
  page.style.margin = "0 auto";
  // Etiketleri dikey sıralamak için flex kullanıyoruz
  page.style.display = "flex";
  page.style.flexDirection = "column";
  
  // Üst etiket (ilk etiket)
  const topLabelObj = createLabel(conceptNameDisplay, formattedDate);
  // Alt etiket (ikinci etiket; döndürme daha sonra applyRotation ile yapılacak)
  const bottomLabelObj = createLabel(conceptNameDisplay, formattedDate);
  
  page.appendChild(topLabelObj.label);
  page.appendChild(bottomLabelObj.label);
  
  return { page, topLabel: topLabelObj.content, bottomLabel: bottomLabelObj.content };
}
 
// Tüm etiketler oluşturulduktan sonra, data-label-index değeri çift olanları (2,4,6,...) 180° döndürür.
function applyRotation() {
  const labels = document.querySelectorAll(".print-label");
  labels.forEach(label => {
    const idx = parseInt(label.getAttribute("data-label-index"), 10);
    if (idx % 2 === 0) {
      label.style.transform = "rotate(180deg)";
    } else {
      label.style.transform = "none";
    }
  });
}
 
// Dinamik olarak etiketleri oluşturan ana fonksiyon
async function loadConceptLabelPrint() {
  try {
    // ————————————————————————————————————————————
    // 1) Sayaç ve seçimleri al
    labelIndexCounter = 1; // global sayaç sıfırlansın

    const cartId = document.getElementById('conceptLabelDropdown').value;
    if (!cartId) {
      alert("Lütfen bir konsept etiketi seçiniz.");
      return;
    }

    const lang = document.getElementById('turkceEtiket').checked ? 'tr' : 'en';
    const type = document.getElementById('conceptTypeFilter').value; // 'ANA' veya 'EK'

    // ————————————————————————————————————————————
    // 2) API’den tüm grupları çek
    const resp = await fetch(`/api/print-concept-label?cartId=${cartId}&lang=${lang}`);
    if (!resp.ok) throw new Error("Etiket bilgileri alınamadı.");
    const groups = await resp.json();

    // ————————————————————————————————————————————
    // 3) Client‑side filtre: Ana vs Ek
    const anaSet = new Set([
      'ANA KONSEPT',
      'TAMAMLAYICI URUNLER',
      'TAMAMLAYICI AKSESUARLAR'
    ]);
    const ekSet = new Set([
      'AKSESUARLAR',
      'EK URUNLER'
    ]);

    const filtered = type === 'ANA'
      ? groups.filter(g => anaSet.has(g.group))
      : groups.filter(g => ekSet.has(g.group));

    // ————————————————————————————————————————————
    // 4) Etiket başlığı ve tarih
    let conceptNameDisplay = '';
    if (filtered.length && filtered[0].items.length) {
      conceptNameDisplay = filtered[0].items[0].CUSTOMER_NAME;
    }
    const formattedDate = new Date().toLocaleDateString('tr-TR');

    // ————————————————————————————————————————————
    // 5) Container’ı temizle, ilk A4 sayfasını oluştur
    const container = document.getElementById("conceptLabelsContainer");
    container.innerHTML = "";

    let { page, topLabel, bottomLabel } = createNewA4Page(conceptNameDisplay, formattedDate);
    container.appendChild(page);

    let currentLabelContent = topLabel;
    let labelSlot = 1; // 1 = üst, 2 = alt

    // ————————————————————————————————————————————
    // 6) Tablo başlıkları & sayı formatlayıcı
    const formatter = new Intl.NumberFormat('tr-TR',{ minimumFractionDigits:0, maximumFractionDigits:0 });
    const tableHeaders = lang === "tr"
      ? ["KATEGORI","MODEL","EBAT","KOD","MIKTAR","FIYAT","TUTAR"]
      : ["CATEGORY","MODEL","SIZE","CODE","QUANTITY","PRICE","AMOUNT"];

    // ————————————————————————————————————————————
    // 7) Grupları dolaş ve etiketlere ekle
    for (let groupData of filtered) {
      // 7.a) Grup bloğu oluştur
      const groupBlock = document.createElement("div");
      let html = `<h6 style="margin:1mm 0;font-size:14px;">
                    ${translateGroupName(groupData.group, lang)}
                  </h6>`;
      html += `<table style="width:100%;font-size:12px;border-collapse:collapse;" border="1">
                 <thead><tr>`;
      tableHeaders.forEach(h => html += `<th>${h}</th>`);
      html += `</tr></thead><tbody>`;
      groupData.items.forEach(item => {
        html += `<tr>
                   <td>${item.Kategori}</td>
                   <td>${item.MODEL}</td>
                   <td>${item.EBAT}</td>
                   <td>${item.KOD}</td>
                   <td style="text-align:right;">${item.QUANTITY}</td>
                   <td style="text-align:right;">${formatter.format(item.SFIYAT1)}</td>
                   <td style="text-align:right;">${formatter.format(item.Amount)}</td>
                 </tr>`;
      });
      html += `<tr style="font-weight:bold;">
                 <td colspan="4" style="text-align:right;">Grup Toplamı:</td>
                 <td style="text-align:right;">${groupData.totalQuantity}</td>
                 <td></td>
                 <td style="text-align:right;">${formatter.format(groupData.totalAmount)}</td>
               </tr>`;
      html += `</tbody></table><br>`;
      groupBlock.innerHTML = html;

      // 7.b) Eklemeye çalış, sonra sığmazsa alt/sonraki sayfaya al
      currentLabelContent.appendChild(groupBlock);

      // Yüksekliği ölç (alt etiket için transform’u geçici kaldır)
      let currentHeight;
      if (labelSlot === 2) {
        const orig = currentLabelContent.style.transform;
        currentLabelContent.style.transform = "none";
        currentHeight = currentLabelContent.getBoundingClientRect().height;
        currentLabelContent.style.transform = orig;
      } else {
        currentHeight = currentLabelContent.getBoundingClientRect().height;
      }

      if (currentHeight > THRESHOLD_PX) {
        currentLabelContent.removeChild(groupBlock);
        if (labelSlot === 1) {
          // alt etikete geç
          currentLabelContent = bottomLabel;
          labelSlot = 2;
          currentLabelContent.appendChild(groupBlock);
        } else {
          // yeni sayfa aç, üst etikete ekle
          ({ page, topLabel, bottomLabel } = createNewA4Page(conceptNameDisplay, formattedDate));
          container.appendChild(page);
          currentLabelContent = topLabel;
          labelSlot = 1;
          currentLabelContent.appendChild(groupBlock);
        }
      }
    }

    // ————————————————————————————————————————————
    // 8) Boş alt etiketleri temizle
    document.querySelectorAll(".a4-page").forEach(pg => {
      const bottom = pg.querySelector(".label-bottom");
      if (bottom && bottom.querySelector(".label-content").innerHTML.trim() === "") {
        bottom.remove();
      }
    });

    // ————————————————————————————————————————————
    // 9) İkinci etiketleri 180° çevir
    applyRotation();

  } catch (error) {
    console.error("Etiket oluşturma hatası:", error);
    alert("Etiket oluşturulurken hata oluştu.");
  }
}


 
// Yazdırma fonksiyonu: Oluşturulan A4 sayfalarını yeni pencerede açıp yazdırır.
function printConceptLabels() {
  const container = document.getElementById("conceptLabelsContainer");
  if (!container) {
    alert("Barkod etiketleri bulunamadı.");
    return;
  }
  const printContents = container.innerHTML;
  if (!printContents.trim()) {
    alert("Barkod etiketleri henüz oluşturulmamış.");
    return;
  }
  
  const printWindow = window.open("", "", "height=800,width=1000");
  printWindow.document.write("<html><head><title>Barkod Etiketleri</title>");
  printWindow.document.write("<style>");
  printWindow.document.write("@page { margin: 0; }");
  printWindow.document.write("body { margin: 0; padding: 0; }");
  printWindow.document.write(".a4-page { page-break-after: always; }");
  printWindow.document.write("</style>");
  printWindow.document.write("</head><body>");
  printWindow.document.write(printContents);
  printWindow.document.write("</body></html>");
  printWindow.document.close();
  printWindow.focus();
  printWindow.print();
}


function autoShrinkText() {
  const cells = document.querySelectorAll('.shrinkable');
  cells.forEach(cell => {
    // Başlangıçta computed font size alınır.
    let style = window.getComputedStyle(cell);
    let fontSize = parseFloat(style.fontSize);
    
    // Metin hücre genişliğini aşıyorsa, minimum 6px'e kadar azaltarak yeniden deniyoruz.
    while (cell.scrollWidth > cell.clientWidth && fontSize > 6) {
      fontSize -= 0.5;
      cell.style.fontSize = fontSize + 'px';
    }
  });
}

// Grup adlarını çevirmek için fonksiyon
	function translateGroupName(groupName, lang) {
	  const translations = {
		"ANA KONSEPT": { tr: "ANA KONSEPT", en: "MAIN CONCEPT" },
		"TAMAMLAYICI URUNLER": { tr: "TAMAMLAYICI URUNLER", en: "ADDITIONAL PRODUCTS" },
		"TAMAMLAYICI AKSESUARLAR": { tr: "TAMAMLAYICI AKSESUARLAR", en: "ADDITIONAL ACCESSORIES" },
		"OTHER": { tr: "OTHER", en: "OTHER" }
	  };
	  return translations[groupName] ? translations[groupName][lang] : groupName;
	}	

// Excelden Fiyat Güncelleme alanını gösteren fonksiyon
function showPriceUpdateContainer() {
  const activeTab = document.querySelector('.tab-pane.active');
  if (activeTab && activeTab.id === "adminPanel") {
    // Admin panelde admin-product-container'ı gizle
    document.getElementById("admin-product-container").style.display = "none";
	document.getElementById("initialImageContainer").style.display = "none";
	document.getElementById("stokKartiContainer").style.display = "none";
    // Fiyat Güncelleme konteynerini göster
    const priceUpdateContainer = document.getElementById("priceUpdateContainer");
    priceUpdateContainer.style.display = "block";
    priceUpdateContainer.style.marginLeft = "30%";
	priceUpdateContainer.style.marginRight = "30%";
	priceUpdateContainer.style.marginTop = "20%";
  } else {
    alert("Fiyat Güncelleme işlemi yalnızca Admin Panel'de kullanılabilir.");
    // Alternatif: Otomatik olarak adminPanel'e geçiş yapmak için:
    //$('#adminPanel').tab('show');
  }
}



// Excel dosyasını okuyup backend'e gönderen fonksiyon (güncelleme işlemi ilerlemesini gerçek zamanlı gösterir)
async function updatePrices() {
  const fileInput = document.getElementById("excelFileInput");
  if (!fileInput.files || fileInput.files.length === 0) {
    alert("Lütfen bir Excel dosyası seçiniz.");
    return;
  }
  const file = fileInput.files[0];
  const formData = new FormData();
  formData.append("excelFile", file);

  // Güncelleme durumunu göstermek için bir progress div'imiz olsun.
  let progressDiv = document.getElementById("updateProgress");
  if (!progressDiv) {
    progressDiv = document.createElement("div");
    progressDiv.id = "updateProgress";
    // Aşağıdaki stil ayarları div'in belirli bir yükseklikte kalmasını ve içerik taşarsa dikey kaydırma çubuğunun görünmesini sağlar.
    progressDiv.style.background = "#eef";
    progressDiv.style.padding = "10px";
    progressDiv.style.marginTop = "10px";
    progressDiv.style.marginLeft = "30%";
    progressDiv.style.marginRight = "20%";
    progressDiv.style.width = "40%"; // Genişliği ayarlayabilirsiniz
    progressDiv.style.maxHeight = "300px"; // Maksimum yükseklik
    progressDiv.style.overflowY = "auto"; // Dikey kaydırma çubuğu
    document.body.appendChild(progressDiv);
  }
  progressDiv.innerHTML = "Güncelleme başladı...<br>";
  progressDiv.style.display = "block";

  try {
    const response = await fetch("/api/update-prices", {
      method: "POST",
      headers: {
        "isadmin": localStorage.getItem("isAdmin"),
        "kullanici": localStorage.getItem("username") || "Bilinmiyor"
      },
      body: formData
    });
    const reader = response.body.getReader();
    const decoder = new TextDecoder("utf-8");

    function readChunk() {
      reader.read().then(({ done, value }) => {
        if (done) {
          progressDiv.innerHTML += "<br><strong>Güncelleme tamamlandı.</strong>";
          return;
        }
        const chunkText = decoder.decode(value);
        console.log(chunkText);
        progressDiv.innerHTML += chunkText.replace(/\n/g, "<br>");
        readChunk();
      }).catch(err => {
        progressDiv.innerHTML += "<br><span style='color:red;'>Hata: " + err.message + "</span>";
        console.error("Progress okuma hatası:", err);
      });
    }
    readChunk();
  } catch (error) {
    alert("Fiyat güncelleme sırasında hata oluştu: " + error.message);
  }
}


	
</script>
  <script>
// Custom editor: select2Editor
var select2Editor = function(cell, onRendered, success, cancel, editorParams) {
  var cellValue = cell.getValue();
  var editorDiv = document.createElement("div");
  editorDiv.style.width = "100%";
  
  var select = document.createElement("select");
  select.style.width = "100%";
  
  // Çoklu seçim kaldırıldı, tek seçim kullanılacak.
  // editorParams.values: Örneğin { "1": "Model A", "2": "Model B", ... }
  var values = editorParams.values;
  for (var key in values) {
    if (values.hasOwnProperty(key)) {
      var option = document.createElement("option");
      option.value = key;
      option.text = values[key];
      if (cellValue == key) {
        option.selected = true;
      }
      select.appendChild(option);
    }
  }
  
  editorDiv.appendChild(select);
  
  onRendered(function(){
    $(select).select2({
      dropdownParent: $("#hotContainer"),  // Grid container
      width: '100%',
      placeholder: "Seçim yapın...",
      // Wild card destekleyen matcher fonksiyonu:
      matcher: function(params, data) {
        // Arama kutusu boşsa, tüm seçenekleri döndür.
        if ($.trim(params.term) === '') {
          return data;
        }
        if (typeof data.text === 'undefined') {
          return null;
        }
        
        var searchTerm = params.term;
        // Eğer * karakteri varsa: custom regex oluştur.
        if (searchTerm.indexOf('*') > -1) {
          // Önce girilen arama ifadesindeki diğer regex özel karakterlerini escape ediyoruz.
          var escaped = searchTerm.replace(/[-\/\\^$+?.()|[\]{}]/g, '\\$&');
          // * karakterlerini regex wild card'ı olarak kullanmak için .*
          var pattern = '^' + escaped.replace(/\*/g, '.*') + '$';
          var regex = new RegExp(pattern, 'i');  // case insensitive
          if (regex.test(data.text)) {
            return data;
          }
          return null;
        } else {
          // Eğer wild card kullanılmamışsa, normal "contains" kontrolü yap.
          if (data.text.toLowerCase().indexOf(searchTerm.toLowerCase()) > -1) {
            return data;
          }
          return null;
        }
      }
    });
    
    // Seçim değiştiğinde success çağrılarak update işlemi tetikleniyor.
    $(select).on("change", function(){
      success(select.value);
    });
    
    // Dropdown kapanınca update işlemi çalışsın.
    $(select).on("select2:close", function(){
      success(select.value);
    });
    
    // ESC tuşu ile edit iptal
    $(select).on("keydown", function(e){
      if(e.key === "Escape"){
        cancel();
      }
    });
  });
  
  return editorDiv;
};


  </script>

  <script>
// SKART verilerini API'den çeken fonksiyon
function loadSkartData(callback) {
  $.getJSON('/api/skart', function(response) {
    if(response.success) {
      callback(response.data);
    } else {
      alert("SKART verileri alınamadı: " + response.message);
    }
  });
}

// Lookup verilerini API'den çeken fonksiyon (örneğin, TIP=71 için)
function loadLookupData(tip, callback) {
  $.getJSON('/api/lookups', { tip: tip }, function(response) {
    if(response.success) {
      callback(response.data);
    } else {
      callback([]);
    }
  });
}

// Lookup Basamak verilerini API'den çeken fonksiyon (örneğin, TIP=0 (altıd) için)
function loadLookupDataBasamak(tip, callback) {
  $.getJSON('/api/lookups-basamak', { tip: tip }, function(response) {
    if(response.success) {
      callback(response.data);
    } else {
      callback([]);
    }
  });
}
//kolon sıralamasını çeken fonksiyon
async function loadUserPreferences(userId, tableName){
  const resp   = await fetch(
    `/api/user-preferences/${encodeURIComponent(userId)}/${encodeURIComponent(tableName)}`
  );
  const result = await resp.json();
  return result.success ? result.data : [];
}

//kolon sıralamasını kaydeden fonksiyon
async function saveUserPreferences(userId, tableName, preferences){
  await fetch('/api/user-preferences', {
    method: 'POST',
    headers: {'Content-Type':'application/json'},
    body: JSON.stringify({ userId, tableName, preferences })
  });
}

		
// Global değişkenler: OZEL2 için modelOptions (lookup seçenekleri) ve modelLookupMap (KOD → ADI eşlemesi)
var modelOptions = [];
var modelLookupMap = {};

// "Stok Kartı" grid'ini yükleyen fonksiyon (örneğin, bir menü öğesi tıklanarak çalıştırılabilir)
function showStokKartiContainer(){
	// ⚠️ Header menu’ü hemen en başta tanımlıyoruz:
	  const headerMenu = function(){
		const menu = [];
		const cols = this.getColumns();

		cols.forEach(col => {
		  const icon = document.createElement("i");
		  icon.classList.add("fas", col.isVisible() ? "fa-check-square" : "fa-square");

		  const label = document.createElement("span");
		  label.style.display = "inline-flex";
		  label.style.alignItems = "center";

		  const title = document.createElement("span");
		  title.textContent = " " + col.getDefinition().title;

		  label.appendChild(icon);
		  label.appendChild(title);

		  menu.push({
			label: label,
			action: function(e){
			  e.stopPropagation();
			  col.toggle();
			  icon.classList.replace(
				col.isVisible() ? "fa-square" : "fa-check-square",
				col.isVisible() ? "fa-check-square" : "fa-square"
			  );
			}
		  });
		});

		return menu;
	  };
	  
	  
   // Admin panel aktif mi kontrol ediyoruz:
  const activeTab = document.querySelector('.tab-pane.active');
  if (!activeTab || activeTab.id !== "adminPanel") {
    alert("Stok Kartı Yönetimi yalnızca Admin Panel'de kullanılabilir.");
    // İşlem kesilsin, daha fazla ilerlemesin:
    return;
  }
  // Eğer varsa, ana ekrandaki fotoğrafı gizle
    const productContainer = document.getElementById("product-container");
    if (productContainer) productContainer.style.display = "none";
    const initialImageContainer = document.getElementById("initialImageContainer");
    if (initialImageContainer) initialImageContainer.style.display = "none";
	const conceptContainer = document.getElementById("conceptContainer");
    if (conceptContainer) conceptContainer.style.display = "none";
	
	const conceptProductContainer = document.getElementById("concept-products-container");
	if(conceptProductContainer) conceptProductContainer.style.display = "none";
	
	const priceUpdateContainer = document.getElementById("priceUpdateContainer");
	if(priceUpdateContainer) priceUpdateContainer.style.display = "none";
	
  
  // Stok Kartı container'ını görünür yap
  $('#stokKartiContainer').show();

  // SKART verilerini çek
  loadSkartData(async function(skartData){
	  const userId    = localStorage.getItem('username');       // oturumdan
	  const tableName = 'SKART';

	  // 2) DB’den tercihler (henüz boş olsa bile boş dizi)
	  const prefs = await loadUserPreferences(userId, tableName);
	  // 3) Önce prefMap’i oluştur:
	  const prefMap = {};
	  prefs.forEach(p => {
      prefMap[p.ColumnName] = { 
        ColumnOrder: p.ColumnOrder, 
        IsVisible:   p.IsVisible 
      };
    });
		// 1) Başta, sayfanın en üstünde veya tabloyu oluşturduğunuz script’in başında ekleyin:

		// headerMenu tanımı (her sütunun başlığına bu menüyü eklemek için)
		const headerMenu = function(){
			  const menu = [];
			  // this = Tabulator sütun objesinin olduğu columnContext
			  const columns = this.getColumns();

			  for (let col of columns) {
				// ikon oluştur
				const icon = document.createElement("i");
				icon.classList.add("fas", col.isVisible() ? "fa-check-square" : "fa-square");

				// etiket oluştur
				const label = document.createElement("span");
				label.style.display = "inline-flex";
				label.style.alignItems = "center";

				const title = document.createElement("span");
				title.textContent = " " + col.getDefinition().title;

				label.appendChild(icon);
				label.appendChild(title);

				// menü öğesi
				menu.push({
				  label: label,
				  action: function(e) {
					e.stopPropagation();   // menünün kapanmasını engelle
					col.toggle();          // görünürlüğü değiştir
					// ikonu güncelle
					if (col.isVisible()) {
					  icon.classList.replace("fa-square", "fa-check-square");
					} else {
					  icon.classList.replace("fa-check-square", "fa-square");
					}
				  }
				});
			  }

			  return menu;
			};

    // CINS için lookup verilerini (GRUP tablosu, TIP=70) çek
    loadLookupData(70, function(lookup70){
      // Lookup verilerinden cinsOptions ve cinsLookupMap oluşturuluyor.
      window.cinsOptions = [];
      window.cinsLookupMap = {};
      lookup70.forEach(function(item){
        cinsLookupMap[item.KOD] = item.ADI;
        cinsOptions.push({ value: item.KOD, label: item.ADI });
        
      });
      
      // CİNS sütunu için editor ve header filter değerlerini oluşturacak mapping nesnesi
     window.cinsMapping = {};
      cinsOptions.forEach(function(opt){
        cinsMapping[opt.value] = opt.label;
      });
      
	// MODEL için lookup verilerini (GRUP tablosu, TIP=71) çek
    loadLookupData(71, function(lookup71){
      // Lookup verilerinden modelOptions ve modelLookupMap oluşturuluyor.
      window.modelOptions = [];
      window.modelLookupMap = {};
      lookup71.forEach(function(item){
        modelLookupMap[item.KOD] = item.ADI;
        modelOptions.push({ value: item.KOD, label: item.ADI });
        
      });
      
      // MODEL sütunu için editor ve header filter değerlerini oluşturacak mapping nesnesi
      window.modelMapping = {};
      modelOptions.forEach(function(opt){
      modelMapping[opt.value] = opt.label;
      });
      
      //--------------------------------
      // Materyal Dropdown için
      loadLookupData(72, function(lookup72){
        window.materyalOptions = [];
        window.materyalLookupMap = {};
        lookup72.forEach(function(item){
          materyalLookupMap[item.KOD] = item.ADI;
          materyalOptions.push({ value: item.KOD, label: item.ADI });
          
        });
        
        // MATERYAL sütunu için editor ve header filter değerlerini oluşturacak mapping nesnesi
        window.materyalMapping = {};
        materyalOptions.forEach(function(opt){
          materyalMapping[opt.value] = opt.label;
        });
        
        //--------------------------------
        // DESEN Dropdown için
        loadLookupData(73, function(lookup73){
          window.desenOptions = [];
          window.desenLookupMap = {};
          lookup73.forEach(function(item){
            desenLookupMap[item.KOD] = item.ADI;
            desenOptions.push({ value: item.KOD, label: item.ADI });
            
          });
          
          // DESEN sütunu için editor ve header filter değerlerini oluşturacak mapping nesnesi
          window.desenMapping = {};
          desenOptions.forEach(function(opt){
            desenMapping[opt.value] = opt.label;
          });
          //--------------------------------
		  
		  //--------------------------------
        // LAMINE Dropdown için
        loadLookupData(74, function(lookup74){
          window.lamineOptions = [];
          window.lamineLookupMap = {};
          lookup74.forEach(function(item){
            lamineLookupMap[item.KOD] = item.ADI;
            lamineOptions.push({ value: item.KOD, label: item.ADI });
          });
          
          // LAMINE sütunu için editor ve header filter değerlerini oluşturacak mapping nesnesi
          window.lamineMapping = {};
          lamineOptions.forEach(function(opt){
            lamineMapping[opt.value] = opt.label;
          });
          //--------------------------------
		  // AKSESUAR Dropdownları için
        loadLookupData(75, function(lookup75){
          window.aksesuarOptions = [];
          window.aksesuarLookupMap = {};
          lookup75.forEach(function(item){
            aksesuarLookupMap[item.KOD] = item.ADI;
            aksesuarOptions.push({ value: item.KOD, label: item.ADI });
          });
          
          // AKSESUAR sütunu için editor ve header filter değerlerini oluşturacak mapping nesnesi
          window.aksesuarMapping = {};
          aksesuarOptions.forEach(function(opt){
            aksesuarMapping[opt.value] = opt.label;
          });
          //--------------------------------
		
		  // KALITE Dropdownları için
        loadLookupData(77, function(lookup77){
          window.kaliteOptions = [];
          window.kaliteLookupMap = {};
          lookup77.forEach(function(item){
            kaliteLookupMap[item.KOD] = item.ADI;
            kaliteOptions.push({ value: item.KOD, label: item.ADI });
          });
          
          // KALITE sütunu için editor ve header filter değerlerini oluşturacak mapping nesnesi
          window.kaliteMapping = {};
          kaliteOptions.forEach(function(opt){
            kaliteMapping[opt.value] = opt.label;
          });
          //--------------------------------
		  // EBAT Dropdownları için
        loadLookupData(78, function(lookup78){
          window.ebatOptions = [];
          window.ebatLookupMap = {};
          lookup78.forEach(function(item){
            ebatLookupMap[item.KOD] = item.ADI;
            ebatOptions.push({ value: item.KOD, label: item.ADI });
          });
          
          // EBAT sütunu için editor ve header filter değerlerini oluşturacak mapping nesnesi
          window.ebatMapping = {};
          ebatOptions.forEach(function(opt){
            ebatMapping[opt.value] = opt.label;
          });
          //--------------------------------
		   // RENK Dropdownları için
        loadLookupData(79, function(lookup79){
          window.renkLookupMap = {};
          window.renkOptions = [];
          lookup79.forEach(function(item){
            renkLookupMap[item.KOD] = item.ADI;
            renkOptions.push({ value: item.KOD, label: item.ADI });
          });
          
          // RENK sütunu için editor ve header filter değerlerini oluşturacak mapping nesnesi
          window.renkMapping = {};
          renkOptions.forEach(function(opt){
            renkMapping[opt.value] = opt.label;
          });
          //--------------------------------
		   // GENİŞ KOLEKSIYON Dropdownı için
			loadLookupData(250, function(lookup250){
			  window.koleksiyonOptions = [];
			  window.koleksiyonLookupMap = {};
			  lookup250.forEach(function(item){
				koleksiyonLookupMap[item.KOD] = item.ADI;
				koleksiyonOptions.push({ value: item.KOD, label: item.ADI });
			  });
			  
			  		  
			  // GENİŞ KOLEKSIYON sütunu için editor ve header filter değerlerini oluşturacak mapping nesnesi
			  window.koleksiyonMapping = {};
			  koleksiyonOptions.forEach(function(opt){
				koleksiyonMapping[opt.value] = opt.label;
			  });
			  //--------------------------------   
		  // TEDARIKYONTEMI Dropdownı için
			loadLookupData(253, function(lookup253){
			  window.tedarikyontemiOptions = [];
			  window.tedarikyontemiLookupMap = {};
			  lookup253.forEach(function(item){
				tedarikyontemiLookupMap[item.KOD] = item.ADI;
				tedarikyontemiOptions.push({ value: item.KOD, label: item.ADI });
			  });
			  
			  		  
			  // TEDARIKYONTEMI sütunu için editor ve header filter değerlerini oluşturacak mapping nesnesi
			  window.tedarikyontemiMapping = {};
			  tedarikyontemiOptions.forEach(function(opt){
				tedarikyontemiMapping[opt.value] = opt.label;
			  });
			  //--------------------------------  
		 // Basamak Dropdown için
		  loadLookupDataBasamak(0, function(lookup0){
			window.basamak1Options = [];
			window.basamak1LookupMap = {};
			lookup0.forEach(function(item){
			  basamak1LookupMap[item.KOD] = item.ADI;
			  basamak1Options.push({ value: item.KOD, label: item.ADI });
			  
			});
			
			// Basamak sütunu için editor ve header filter değerlerini oluşturacak mapping nesnesi
			window.basamak1Mapping = {};
			basamak1Options.forEach(function(opt){
			  basamak1Mapping[opt.value] = opt.label;
			});
			
			//--------------------------------
          
          // SKART verilerindeki her satırda OZEL2 alanı tanımlı olsun
          skartData.forEach(function(row){
            if(!row.OZEL2) row.OZEL2 = "";
          });
          
		  //FOTOĞRAFSIZLARI BOŞ FOTOYA YÖNLENDİRME
		  function fallbackImageFormatter(cell, formatterParams, onRendered) {
			  var value = cell.getValue();   // Bu örnekte value, KOD olacak.
			  var imgUrl = formatterParams.urlPrefix + value + formatterParams.urlSuffix;
			  // onerror attribute sayesinde, resim yüklenemezse fallbackImage URL'sine yönlendiriyoruz.
			  return "<img src='" + imgUrl + "' onerror=\"this.onerror=null;this.src='" + formatterParams.fallbackImage + "';\" style='max-width:" + formatterParams.width + ";height:" + formatterParams.height + ";' />";
			}
			
		
          // Tabulator grid kolon tanımları
          var columns = [
            {
			  title: "Fotoğraf",
			  // artık filtre field'ı FOTODURUM, header filter gerçekten bu alana bakacak
			  field: "FOTODURUM",
			  frozen: true,
			  vertAlign: "center",

			  // Hepsi/Var/Yok seçenekleri
			  headerFilter: "select",
			  headerFilterParams: {
				values: {
				  "VAR": "Var",
				  "YOK": "Yok"
				}
			  },
			  headerFilterPlaceholder: "Hepsi",
			  headerFilterFunc: function(headerValue, rowValue, rowData) {
				// headerValue = seçilen FOTODURUM değeridir ("VAR"/"YOK"), boşsa Hepsi
				if (!headerValue) return true;        // Hepsi seçiliyse tüm satırlar
				return rowValue === headerValue;      // aksi halde direkt karşılaştır
			  },

			  // Formatter hâlâ fallbackImageFormatter ile birebir çalışmayacağı için:
			  // kendi ufak formatter’ımızı kullanıyoruz:
			  formatter: function(cell, formatterParams) {
				const data = cell.getData();  // tüm row verisi
				// FotoDurum VAR ise gerçek foto, YOK ise sabit YOK.jpg
				const src = data.FOTODURUM === "VAR"
				  ? formatterParams.urlPrefix + data.KOD + formatterParams.urlSuffix
				  : formatterParams.fallbackImage;

				return `<img
				  src="${src}"
				  onerror="this.onerror=null;this.src='${formatterParams.fallbackImage}';"
				  style="max-width:${formatterParams.width};max-height:${formatterParams.height};object-fit:cover;"
				/>`;
			  },

			  // fallbackImageFormatter ile aynı parametreler:
			  formatterParams: {
				width:        "70px",
				height:       "70px",
				urlPrefix:    "/resim/",
				urlSuffix:    ".jpg",
				fallbackImage: "/resim/YOK.jpg"
			  },

			  width: 90
			},


            { 
			  title: "KOD", 
			  field: "KOD", 
			  headerFilter: "input",
			  headerFilterFunc: function(headerValue, rowValue, rowData, filterParams){
				if($.trim(headerValue) === ""){
				  return true;
				}
				
				var regexStr;
				// Eğer headerValue içerisinde "*" yoksa, contains mantığıyla filtrele: "*headerValue*"
				if (headerValue.indexOf("*") === -1) {
				  regexStr = ".*" + headerValue + ".*";
				} else {
				  // Eğer "*" karakteri varsa, kullanıcı tarafından girilen değeri regex'e çevir
				  regexStr = "^" + headerValue.replace(/\*/g, ".*") + "$";
				}
				
				var regex = new RegExp(regexStr, "i");
				
				if(typeof rowValue !== "string"){
				  return false;
				}
				
				return regex.test(rowValue);
			  },
			  // sadece bu sütunda headerMenu'u aç
			  headerMenu: headerMenu,
			  editor: false, 
			  frozen: true, 
			  // çift tıklama tetikleyeni:
			  rowDblClick: function(e, row){
				const data = row.getData();
				document.getElementById("modalStockCode").textContent = data.KOD;
				document.getElementById("stockCode").value    = data.KOD;
				document.getElementById("stockName").value    = data.ADI;
				document.getElementById("stockGroup").value   = data.GRUP;
				document.getElementById("stockUnit").value    = data.BIRIM;
				document.getElementById("stockBarcode").value = data.BARKOD;
				document.getElementById("stockKDV").value     = data.KDV;
				$('#stockCardModal').modal('show');
			  },
			  vertAlign:"center",
			  width: 130 
			},

            { 
			  title: "ADI", 
			  field: "ADI", 
			  headerFilter: "input", 
			  headerFilterFunc: function(headerValue, rowValue, rowData, filterParams){
				if($.trim(headerValue) === ""){
				  return true;
				}
				
				var regexStr;
				// Eğer headerValue içerisinde "*" yoksa, contains mantığıyla filtrele: "*headerValue*"
				if (headerValue.indexOf("*") === -1) {
				  regexStr = ".*" + headerValue + ".*";
				} else {
				  // Eğer "*" karakteri varsa, kullanıcı tarafından girilen değeri regex'e çevir
				  regexStr = "^" + headerValue.replace(/\*/g, ".*") + "$";
				}
				
				var regex = new RegExp(regexStr, "i");
				
				if(typeof rowValue !== "string"){
				  return false;
				}
				
				return regex.test(rowValue);
			  },
			  editor: "input", 
			  editable: true, 
			  frozen: true,
			  width: 375,
			  vertAlign:"center",
			  cellClick: function(e, cell){
				cell.edit();
				console.log("ADI hücresine tıklandı. Değer:", cell.getValue());
			  },
			  cellEdited: function(cell){
				console.log("ADI sütunu düzenlendi. Yeni değer:", cell.getValue());
				triggerUpdate(cell);
			  }
			},
			{ 
			  title: "BIRIM", 
			  field: "BIRIM", 
			  headerFilter: "input",
			  headerFilterFunc: function(headerValue, rowValue, rowData, filterParams){
				if($.trim(headerValue) === ""){
				  return true;
				}
				
				var regexStr;
				// Eğer headerValue içerisinde "*" yoksa, contains mantığıyla filtrele: "*headerValue*"
				if (headerValue.indexOf("*") === -1) {
				  regexStr = ".*" + headerValue + ".*";
				} else {
				  // Eğer "*" karakteri varsa, kullanıcı tarafından girilen değeri regex'e çevir
				  regexStr = "^" + headerValue.replace(/\*/g, ".*") + "$";
				}
				
				var regex = new RegExp(regexStr, "i");
				
				if(typeof rowValue !== "string"){
				  return false;
				}
				
				return regex.test(rowValue);
			  },
			  editor: false,  
			  vertAlign:"center",
			  width: 130 
			},
			{ 
              title: "BASAMAK 1", 
              field: "BASAMAK1", 
              headerFilter: "list",
              width: 180,
			  vertAlign:"center",
              headerFilterParams: { values: basamak1Mapping },
			  headerFilterFunc: function(headerValue, rowValue, rowData, filterParams){
				  headerValue = $.trim(headerValue);
				  if(headerValue === ""){
					return true;
				  }
				  
				  let regexStr;
				  // Eğer headerValue içinde "*" yoksa tam eşleşme için başına ^ ve sonuna $ ekleyelim.
				  if(headerValue.indexOf("*") === -1){
					regexStr = "^" + headerValue + "$";
				  } else {
					// Eğer "*" varsa, wildcard mantığı ile eşle
					regexStr = "^" + headerValue.replace(/\*/g, ".*") + "$";
				  }
				  
				  var regex = new RegExp(regexStr, "i");
				  
				  if(typeof rowValue !== "string"){
					return false;
				  }
				  
				  return regex.test(rowValue);
				},

			  editor: false, 
              editable: false         
              
            },
			{ 
			  title: "BASAMAK 2", 
			  field: "BASAMAK2", 
			  headerFilter: "input",
			  headerFilterFunc: function(headerValue, rowValue, rowData, filterParams){
				if($.trim(headerValue) === ""){
				  return true;
				}
				
				var regexStr;
				// Eğer headerValue içerisinde "*" yoksa, contains mantığıyla filtrele: "*headerValue*"
				if (headerValue.indexOf("*") === -1) {
				  regexStr = ".*" + headerValue + ".*";
				} else {
				  // Eğer "*" karakteri varsa, kullanıcı tarafından girilen değeri regex'e çevir
				  regexStr = "^" + headerValue.replace(/\*/g, ".*") + "$";
				}
				
				var regex = new RegExp(regexStr, "i");
				
				if(typeof rowValue !== "string"){
				  return false;
				}
				
				return regex.test(rowValue);
			  },
			  editor: false, 
			  vertAlign:"center",
			  width: 130 
			},
			{ 
			  title: "BASAMAK 3", 
			  field: "BASAMAK3", 
			  headerFilter: "input",
			  headerFilterFunc: function(headerValue, rowValue, rowData, filterParams){
				if($.trim(headerValue) === ""){
				  return true;
				}
				
				var regexStr;
				// Eğer headerValue içerisinde "*" yoksa, contains mantığıyla filtrele: "*headerValue*"
				if (headerValue.indexOf("*") === -1) {
				  regexStr = ".*" + headerValue + ".*";
				} else {
				  // Eğer "*" karakteri varsa, kullanıcı tarafından girilen değeri regex'e çevir
				  regexStr = "^" + headerValue.replace(/\*/g, ".*") + "$";
				}
				
				var regex = new RegExp(regexStr, "i");
				
				if(typeof rowValue !== "string"){
				  return false;
				}
				
				return regex.test(rowValue);
			  },
			  editor: false, 
			  vertAlign:"center",
			  width: 130 
			},
			{ 
			  title: "BASAMAK 4", 
			  field: "BASAMAK4", 
			  headerFilter: "input",
			  headerFilterFunc: function(headerValue, rowValue, rowData, filterParams){
				if($.trim(headerValue) === ""){
				  return true;
				}
				
				var regexStr;
				// Eğer headerValue içerisinde "*" yoksa, contains mantığıyla filtrele: "*headerValue*"
				if (headerValue.indexOf("*") === -1) {
				  regexStr = ".*" + headerValue + ".*";
				} else {
				  // Eğer "*" karakteri varsa, kullanıcı tarafından girilen değeri regex'e çevir
				  regexStr = "^" + headerValue.replace(/\*/g, ".*") + "$";
				}
				
				var regex = new RegExp(regexStr, "i");
				
				if(typeof rowValue !== "string"){
				  return false;
				}
				
				return regex.test(rowValue);
			  },
			  editor: false,  
			  vertAlign:"center",
			  width: 130 
			},
			{ 
			  title: "BASAMAK 5", 
			  field: "BASAMAK5", 
			  headerFilter: "input",
			  headerFilterFunc: function(headerValue, rowValue, rowData, filterParams){
				if($.trim(headerValue) === ""){
				  return true;
				}
				
				var regexStr;
				// Eğer headerValue içerisinde "*" yoksa, contains mantığıyla filtrele: "*headerValue*"
				if (headerValue.indexOf("*") === -1) {
				  regexStr = ".*" + headerValue + ".*";
				} else {
				  // Eğer "*" karakteri varsa, kullanıcı tarafından girilen değeri regex'e çevir
				  regexStr = "^" + headerValue.replace(/\*/g, ".*") + "$";
				}
				
				var regex = new RegExp(regexStr, "i");
				
				if(typeof rowValue !== "string"){
				  return false;
				}
				
				return regex.test(rowValue);
			  },
			  editor: false, 
			  vertAlign:"center",
			  width: 130 
			},
            { 
              title: "CINS", 
              field: "OZEL1", 
              headerFilter: "list",
              width: 180,
			  vertAlign:"center",
              headerFilterParams: { values: cinsMapping },
              editor: select2Editor,           // select2Editor kullanılıyor
              editorParams: { values: cinsMapping },
              formatter: function(cell){
                var value = cell.getValue();
                return cinsLookupMap[value] || value;
              },
              cellEdited: function(cell){
                console.log("CİNS sütunu düzenlendi. Yeni değer:", cell.getValue());
                triggerUpdate(cell);
              }
            },
			{ 
              title: "MODEL", 
              field: "OZEL2", 
              headerFilter: "list",
              width: 180,
			  vertAlign:"center",
              headerFilterParams: { values: modelMapping },
              editor: select2Editor,           // select2Editor kullanılıyor
              editorParams: { values: modelMapping },
              formatter: function(cell){
                var value = cell.getValue();
                return modelLookupMap[value] || value;
              },
              cellEdited: function(cell){
                console.log("MODEL sütunu düzenlendi. Yeni değer:", cell.getValue());
                triggerUpdate(cell);
              }
            },
            { 
              title: "MATERYAL", 
              field: "OZEL3", 
              headerFilter: "list",
              width: 180,
			  vertAlign:"center",
              headerFilterParams: { values: materyalMapping },
              editor: select2Editor,           // select2Editor kullanımı
              editorParams: { values: materyalMapping },
              formatter: function(cell){
                var value = cell.getValue();
                return materyalLookupMap[value] || value;
              },
              cellEdited: function(cell){
                console.log("MATERYAL sütunu düzenlendi. Yeni değer:", cell.getValue());
                triggerUpdate(cell);
              }
            },
			{ 
              title: "EBAT", 
              field: "OZEL9",
              headerFilter: "list",
              width: 180,
			  vertAlign:"center",
              headerFilterParams: { values: ebatMapping },
              editor: select2Editor,           // select2Editor kullanımı
              editorParams: { values: ebatMapping },
              formatter: function(cell){
                var value = cell.getValue();
                return ebatLookupMap[value] || value;
              },
              cellEdited: function(cell){
                console.log("EBAT sütunu düzenlendi. Yeni değer:", cell.getValue());
                triggerUpdate(cell);
              }
            },
			{ 
              title: "RENK", 
              field: "OZEL10",
              headerFilter: "list",
              width: 180,
			  vertAlign:"center",
              headerFilterParams: { values: renkMapping },
              editor: select2Editor,           // select2Editor kullanımı
              editorParams: { values: renkMapping },
              formatter: function(cell){
                var value = cell.getValue();
                return renkLookupMap[value] || value;
              },
              cellEdited: function(cell){
                console.log("RENK sütunu düzenlendi. Yeni değer:", cell.getValue());
                triggerUpdate(cell);
              }
            },
            { 
              title: "DESEN", 
              field: "OZEL4",
              headerFilter: "list",
              width: 150,
			  vertAlign:"center",
              headerFilterParams: { values: desenMapping },
              editor: select2Editor,           // select2Editor kullanımı
              editorParams: { values: desenMapping },
              formatter: function(cell){
                var value = cell.getValue();
                return desenLookupMap[value] || value;
              },
              cellEdited: function(cell){
                console.log("DESEN sütunu düzenlendi. Yeni değer:", cell.getValue());
                triggerUpdate(cell);
              }
            },
			{ 
              title: "LAMINE", 
              field: "OZEL5",
              headerFilter: "list",
              width: 150,
			  vertAlign:"center",
              headerFilterParams: { values: lamineMapping },
              editor: select2Editor,           // select2Editor kullanımı
              editorParams: { values: lamineMapping },
              formatter: function(cell){
                var value = cell.getValue();
                return lamineLookupMap[value] || value;
              },
              cellEdited: function(cell){
                console.log("LAMINE sütunu düzenlendi. Yeni değer:", cell.getValue());
                triggerUpdate(cell);
              }
            },
			{ 
              title: "AKSESUAR", 
              field: "OZEL6",
              headerFilter: "list",
              width: 150,
			  vertAlign:"center",
              headerFilterParams: { values: aksesuarMapping },
              editor: select2Editor,           // select2Editor kullanımı
              editorParams: { values: aksesuarMapping },
              formatter: function(cell){
                var value = cell.getValue();
                return aksesuarLookupMap[value] || value;
              },
              cellEdited: function(cell){
                console.log("AKSESUAR1 sütunu düzenlendi. Yeni değer:", cell.getValue());
                triggerUpdate(cell);
              }
            },
			{ 
              title: "AKSESUAR 2", 
              field: "AKSESUAR2",
              headerFilter: "list",
              width: 150,
			  vertAlign:"center",
              headerFilterParams: { values: aksesuarMapping },
              editor: select2Editor,           // select2Editor kullanımı
              editorParams: { values: aksesuarMapping },
              formatter: function(cell){
                var value = cell.getValue();
                return aksesuarLookupMap[value] || value;
              },
              cellEdited: function(cell){
                console.log("AKSESUAR1 sütunu düzenlendi. Yeni değer:", cell.getValue());
                triggerUpdate(cell);
              }
            },
            { 
              title: "AKSESUAR 3", 
              field: "AKSESUAR3",
              headerFilter: "list",
              width: 150,
			  vertAlign:"center",
              headerFilterParams: { values: aksesuarMapping },
              editor: select2Editor,           // select2Editor kullanımı
              editorParams: { values: aksesuarMapping },
              formatter: function(cell){
                var value = cell.getValue();
                return aksesuarLookupMap[value] || value;
              },
              cellEdited: function(cell){
                console.log("AKSESUAR1 sütunu düzenlendi. Yeni değer:", cell.getValue());
                triggerUpdate(cell);
              }
            },
			{ 
              title: "KALİTE", 
              field: "OZEL8",
              headerFilter: "list",
              width: 150,
			  vertAlign:"center",
              headerFilterParams: { values: kaliteMapping },
              editor: select2Editor,           // select2Editor kullanımı
              editorParams: { values: kaliteMapping },
              formatter: function(cell){
                var value = cell.getValue();
                return kaliteLookupMap[value] || value;
              },
              cellEdited: function(cell){
                console.log("KALİTE sütunu düzenlendi. Yeni değer:", cell.getValue());
                triggerUpdate(cell);
              }
            },
			{ 
              title: "GENİŞ KOLEKSIYON", 
              field: "KOLEKSIYON",
              headerFilter: "list",
              width: 150,
              headerFilterParams: { values: koleksiyonMapping },
			  headerFilterFunc: function(headerValue, rowValue, rowData, filterParams) {
				  // Filtre kutusu boşsa, satırı göster.
				  if($.trim(headerValue) === ""){
					return true;
				  }
				  
				  // Eğer rowValue null ise, onu boş string olarak değerlendir.
				  var cellValue = (rowValue === null || rowValue === undefined) ? "" : rowValue.toString();
				  
				  // Ardından, normal regex tabanlı eşleştirme işlemini uygulayabilirsiniz.
				  var regexStr;
				  if (headerValue.indexOf("*") === -1) {
					regexStr = ".*" + headerValue + ".*";
				  } else {
					regexStr = "^" + headerValue.replace(/\*/g, ".*") + "$";
				  }
				  var regex = new RegExp(regexStr, "i");
				  return regex.test(cellValue);
				},

              editor: select2Editor,           // select2Editor kullanımı
              editorParams: { values: koleksiyonMapping },
              formatter: function(cell){
                var value = cell.getValue();
                return koleksiyonLookupMap[value] || value;
              },
              cellEdited: function(cell){
                console.log("KOLEKSIYON sütunu düzenlendi. Yeni değer:", cell.getValue());
                triggerUpdate(cell);
              }
            },
			{ 
			  title: "ISIM", 
			  field: "NAME", 
			  headerFilter: "input", 
			  headerFilterFunc: function(headerValue, rowValue, rowData, filterParams){
				if($.trim(headerValue) === ""){
				  return true;
				}
				
				var regexStr;
				// Eğer headerValue içerisinde "*" yoksa, contains mantığıyla filtrele: "*headerValue*"
				if (headerValue.indexOf("*") === -1) {
				  regexStr = ".*" + headerValue + ".*";
				} else {
				  // Eğer "*" karakteri varsa, kullanıcı tarafından girilen değeri regex'e çevir
				  regexStr = "^" + headerValue.replace(/\*/g, ".*") + "$";
				}
				
				var regex = new RegExp(regexStr, "i");
				
				if(typeof rowValue !== "string"){
				  return false;
				}
				
				return regex.test(rowValue);
			  },
			  editor: "input", 
			  editable: true, 
			  width: 130,
			  vertAlign:"center",
			  cellClick: function(e, cell){
				cell.edit();
				console.log("ISIM hücresine tıklandı. Değer:", cell.getValue());
			  },
			  cellEdited: function(cell){
				console.log("ISIM sütunu düzenlendi. Yeni değer:", cell.getValue());
				triggerUpdate(cell);
			  }
			},
			{ 
			  title: "DERI TIPI", 
			  field: "DERITIPI", 
			  headerFilter: "input", 
			  headerFilterFunc: function(headerValue, rowValue, rowData, filterParams){
				if($.trim(headerValue) === ""){
				  return true;
				}
				
				var regexStr;
				// Eğer headerValue içerisinde "*" yoksa, contains mantığıyla filtrele: "*headerValue*"
				if (headerValue.indexOf("*") === -1) {
				  regexStr = ".*" + headerValue + ".*";
				} else {
				  // Eğer "*" karakteri varsa, kullanıcı tarafından girilen değeri regex'e çevir
				  regexStr = "^" + headerValue.replace(/\*/g, ".*") + "$";
				}
				
				var regex = new RegExp(regexStr, "i");
				
				if(typeof rowValue !== "string"){
				  return false;
				}
				
				return regex.test(rowValue);
			  },
			  editor: "input", 
			  editable: true,
			  width: 130,
			  vertAlign:"center",
			  cellClick: function(e, cell){
				cell.edit();
				console.log("DERI TIPI hücresine tıklandı. Değer:", cell.getValue());
			  },
			  cellEdited: function(cell){
				console.log("DERI TIPI sütunu düzenlendi. Yeni değer:", cell.getValue());
				triggerUpdate(cell);
			  }
			},
			{ 
			  title: "ISLENTI 1", 
			  field: "ISLENTI1", 
			  headerFilter: "input", 
			  headerFilterFunc: function(headerValue, rowValue, rowData, filterParams){
				if($.trim(headerValue) === ""){
				  return true;
				}
				
				var regexStr;
				// Eğer headerValue içerisinde "*" yoksa, contains mantığıyla filtrele: "*headerValue*"
				if (headerValue.indexOf("*") === -1) {
				  regexStr = ".*" + headerValue + ".*";
				} else {
				  // Eğer "*" karakteri varsa, kullanıcı tarafından girilen değeri regex'e çevir
				  regexStr = "^" + headerValue.replace(/\*/g, ".*") + "$";
				}
				
				var regex = new RegExp(regexStr, "i");
				
				if(typeof rowValue !== "string"){
				  return false;
				}
				
				return regex.test(rowValue);
			  },
			  editor: "input", 
			  editable: true, 
			  width: 130,
			  vertAlign:"center",
			  cellClick: function(e, cell){
				cell.edit();
				console.log("ISLENTI 1 hücresine tıklandı. Değer:", cell.getValue());
			  },
			  cellEdited: function(cell){
				console.log("ISLENTI 1 sütunu düzenlendi. Yeni değer:", cell.getValue());
				triggerUpdate(cell);
			  }
			},
			{ 
			  title: "ISLENTI 2", 
			  field: "ISLENTI2", 
			  headerFilter: "input", 
			  headerFilterFunc: function(headerValue, rowValue, rowData, filterParams){
				if($.trim(headerValue) === ""){
				  return true;
				}
				
				var regexStr;
				// Eğer headerValue içerisinde "*" yoksa, contains mantığıyla filtrele: "*headerValue*"
				if (headerValue.indexOf("*") === -1) {
				  regexStr = ".*" + headerValue + ".*";
				} else {
				  // Eğer "*" karakteri varsa, kullanıcı tarafından girilen değeri regex'e çevir
				  regexStr = "^" + headerValue.replace(/\*/g, ".*") + "$";
				}
				
				var regex = new RegExp(regexStr, "i");
				
				if(typeof rowValue !== "string"){
				  return false;
				}
				
				return regex.test(rowValue);
			  },
			  editor: "input", 
			  editable: true, 
			  width: 130,
			  vertAlign:"center",
			  cellClick: function(e, cell){
				cell.edit();
				console.log("ISLENTI 2 hücresine tıklandı. Değer:", cell.getValue());
			  },
			  cellEdited: function(cell){
				console.log("ISLENTI 2 sütunu düzenlendi. Yeni değer:", cell.getValue());
				triggerUpdate(cell);
			  }
			},
			{ 
			  title: "HOM STOK", 
			  field: "HOM", 
			  headerFilter: "input",
			  headerFilterFunc: function(headerValue, rowValue, rowData, filterParams) {
				// Filtre kutusu boşsa, satırı göster.
				if ($.trim(headerValue) === "") {
				  return true;
				}
				
				// Satırdaki değeri sayı tipine çeviriyoruz.
				var num = parseFloat(rowValue);
				if (isNaN(num)) {
				  return false;
				}
				
				headerValue = headerValue.trim();
				
				// NOT EQUAL (eşit değil) kontrolü: Eğer headerValue "<>" ile başlıyorsa
				if (headerValue.startsWith("<>")) {
				  var threshold = parseFloat(headerValue.substring(2).trim());
				  if (isNaN(threshold)) {
					return false;
				  }
				  return num !== threshold;
				}
				
				// Eğer headerValue ">" ile başlıyorsa:
				if (headerValue.startsWith(">")) {
				  var threshold = parseFloat(headerValue.substring(1).trim());
				  if (isNaN(threshold)) {
					return false;
				  }
				  return num > threshold;
				}
				
				// Eğer headerValue "<" ile başlıyorsa:
				if (headerValue.startsWith("<")) {
				  var threshold = parseFloat(headerValue.substring(1).trim());
				  if (isNaN(threshold)) {
					return false;
				  }
				  return num < threshold;
				}
				
				// Eğer aralık belirtimi varsa ("DEĞER - DEĞER")
				if (headerValue.indexOf("-") !== -1) {
				  var parts = headerValue.split("-");
				  if (parts.length !== 2) {
					return false;
				  }
				  var min = parseFloat(parts[0].trim());
				  var max = parseFloat(parts[1].trim());
				  if (isNaN(min) || isNaN(max)) {
					return false;
				  }
				  return num >= min && num <= max;
				}
				
				// Aksi durumda: girilen değere tam eşleşme kontrolü
				var threshold = parseFloat(headerValue);
				if (isNaN(threshold)) {
				  return false;
				}
				return num === threshold;
			  },
			  editor: false, 
			  frozen: false, 
			  vertAlign: "center",
			  width: 130 
			},
			{ 
			  title: "MERKEZ STOK", 
			  field: "MRKZ", 
			  headerFilter: "input",
			  headerFilterFunc: function(headerValue, rowValue, rowData, filterParams) {
				// Filtre kutusu boşsa, satırı göster.
				if ($.trim(headerValue) === "") {
				  return true;
				}
				
				// Satırdaki değeri sayı tipine çeviriyoruz.
				var num = parseFloat(rowValue);
				if (isNaN(num)) {
				  return false;
				}
				
				headerValue = headerValue.trim();
				
				// NOT EQUAL (eşit değil) kontrolü: Eğer headerValue "<>" ile başlıyorsa
				if (headerValue.startsWith("<>")) {
				  var threshold = parseFloat(headerValue.substring(2).trim());
				  if (isNaN(threshold)) {
					return false;
				  }
				  return num !== threshold;
				}
				
				// Eğer headerValue ">" ile başlıyorsa:
				if (headerValue.startsWith(">")) {
				  var threshold = parseFloat(headerValue.substring(1).trim());
				  if (isNaN(threshold)) {
					return false;
				  }
				  return num > threshold;
				}
				
				// Eğer headerValue "<" ile başlıyorsa:
				if (headerValue.startsWith("<")) {
				  var threshold = parseFloat(headerValue.substring(1).trim());
				  if (isNaN(threshold)) {
					return false;
				  }
				  return num < threshold;
				}
				
				// Eğer aralık belirtimi varsa ("DEĞER - DEĞER")
				if (headerValue.indexOf("-") !== -1) {
				  var parts = headerValue.split("-");
				  if (parts.length !== 2) {
					return false;
				  }
				  var min = parseFloat(parts[0].trim());
				  var max = parseFloat(parts[1].trim());
				  if (isNaN(min) || isNaN(max)) {
					return false;
				  }
				  return num >= min && num <= max;
				}
				
				// Aksi durumda: girilen değere tam eşleşme kontrolü
				var threshold = parseFloat(headerValue);
				if (isNaN(threshold)) {
				  return false;
				}
				return num === threshold;
			  },
			  editor: false, 
			  frozen: false, 
			  vertAlign: "center",
			  width: 130 
			},
			{ 
			  title: "SHW STOK", 
			  field: "SHWR", 
			  headerFilter: "input",
			  headerFilterFunc: function(headerValue, rowValue, rowData, filterParams) {
				// Filtre kutusu boşsa, satırı göster.
				if ($.trim(headerValue) === "") {
				  return true;
				}
				
				// Satırdaki değeri sayı tipine çeviriyoruz.
				var num = parseFloat(rowValue);
				if (isNaN(num)) {
				  return false;
				}
				
				headerValue = headerValue.trim();
				
				// NOT EQUAL (eşit değil) kontrolü: Eğer headerValue "<>" ile başlıyorsa
				if (headerValue.startsWith("<>")) {
				  var threshold = parseFloat(headerValue.substring(2).trim());
				  if (isNaN(threshold)) {
					return false;
				  }
				  return num !== threshold;
				}
				
				// Eğer headerValue ">" ile başlıyorsa:
				if (headerValue.startsWith(">")) {
				  var threshold = parseFloat(headerValue.substring(1).trim());
				  if (isNaN(threshold)) {
					return false;
				  }
				  return num > threshold;
				}
				
				// Eğer headerValue "<" ile başlıyorsa:
				if (headerValue.startsWith("<")) {
				  var threshold = parseFloat(headerValue.substring(1).trim());
				  if (isNaN(threshold)) {
					return false;
				  }
				  return num < threshold;
				}
				
				// Eğer aralık belirtimi varsa ("DEĞER - DEĞER")
				if (headerValue.indexOf("-") !== -1) {
				  var parts = headerValue.split("-");
				  if (parts.length !== 2) {
					return false;
				  }
				  var min = parseFloat(parts[0].trim());
				  var max = parseFloat(parts[1].trim());
				  if (isNaN(min) || isNaN(max)) {
					return false;
				  }
				  return num >= min && num <= max;
				}
				
				// Aksi durumda: girilen değere tam eşleşme kontrolü
				var threshold = parseFloat(headerValue);
				if (isNaN(threshold)) {
				  return false;
				}
				return num === threshold;
			  },
			  editor: false, 
			  frozen: false, 
			  vertAlign: "center",
			  width: 130 
			},
			{ 
			  title: "SHWAKS STOK", 
			  field: "SHWAKS", 
			  headerFilter: "input",
			  headerFilterFunc: function(headerValue, rowValue, rowData, filterParams) {
				// Filtre kutusu boşsa, satırı göster.
				if ($.trim(headerValue) === "") {
				  return true;
				}
				
				// Satırdaki değeri sayı tipine çeviriyoruz.
				var num = parseFloat(rowValue);
				if (isNaN(num)) {
				  return false;
				}
				
				headerValue = headerValue.trim();
				
				// NOT EQUAL (eşit değil) kontrolü: Eğer headerValue "<>" ile başlıyorsa
				if (headerValue.startsWith("<>")) {
				  var threshold = parseFloat(headerValue.substring(2).trim());
				  if (isNaN(threshold)) {
					return false;
				  }
				  return num !== threshold;
				}
				
				// Eğer headerValue ">" ile başlıyorsa:
				if (headerValue.startsWith(">")) {
				  var threshold = parseFloat(headerValue.substring(1).trim());
				  if (isNaN(threshold)) {
					return false;
				  }
				  return num > threshold;
				}
				
				// Eğer headerValue "<" ile başlıyorsa:
				if (headerValue.startsWith("<")) {
				  var threshold = parseFloat(headerValue.substring(1).trim());
				  if (isNaN(threshold)) {
					return false;
				  }
				  return num < threshold;
				}
				
				// Eğer aralık belirtimi varsa ("DEĞER - DEĞER")
				if (headerValue.indexOf("-") !== -1) {
				  var parts = headerValue.split("-");
				  if (parts.length !== 2) {
					return false;
				  }
				  var min = parseFloat(parts[0].trim());
				  var max = parseFloat(parts[1].trim());
				  if (isNaN(min) || isNaN(max)) {
					return false;
				  }
				  return num >= min && num <= max;
				}
				
				// Aksi durumda: girilen değere tam eşleşme kontrolü
				var threshold = parseFloat(headerValue);
				if (isNaN(threshold)) {
				  return false;
				}
				return num === threshold;
			  },
			  editor: false, 
			  frozen: false, 
			  vertAlign: "center",
			  width: 130 
			},
			{ 
			  title: "CUMBA STOK", 
			  field: "CUMBA", 
			  headerFilter: "input",
			  headerFilterFunc: function(headerValue, rowValue, rowData, filterParams) {
				// Filtre kutusu boşsa, satırı göster.
				if ($.trim(headerValue) === "") {
				  return true;
				}
				
				// Satırdaki değeri sayı tipine çeviriyoruz.
				var num = parseFloat(rowValue);
				if (isNaN(num)) {
				  return false;
				}
				
				headerValue = headerValue.trim();
				
				// NOT EQUAL (eşit değil) kontrolü: Eğer headerValue "<>" ile başlıyorsa
				if (headerValue.startsWith("<>")) {
				  var threshold = parseFloat(headerValue.substring(2).trim());
				  if (isNaN(threshold)) {
					return false;
				  }
				  return num !== threshold;
				}
				
				// Eğer headerValue ">" ile başlıyorsa:
				if (headerValue.startsWith(">")) {
				  var threshold = parseFloat(headerValue.substring(1).trim());
				  if (isNaN(threshold)) {
					return false;
				  }
				  return num > threshold;
				}
				
				// Eğer headerValue "<" ile başlıyorsa:
				if (headerValue.startsWith("<")) {
				  var threshold = parseFloat(headerValue.substring(1).trim());
				  if (isNaN(threshold)) {
					return false;
				  }
				  return num < threshold;
				}
				
				// Eğer aralık belirtimi varsa ("DEĞER - DEĞER")
				if (headerValue.indexOf("-") !== -1) {
				  var parts = headerValue.split("-");
				  if (parts.length !== 2) {
					return false;
				  }
				  var min = parseFloat(parts[0].trim());
				  var max = parseFloat(parts[1].trim());
				  if (isNaN(min) || isNaN(max)) {
					return false;
				  }
				  return num >= min && num <= max;
				}
				
				// Aksi durumda: girilen değere tam eşleşme kontrolü
				var threshold = parseFloat(headerValue);
				if (isNaN(threshold)) {
				  return false;
				}
				return num === threshold;
			  },
			  editor: false, 
			  frozen: false, 
			  vertAlign: "center",
			  width: 130 
			},
			{
			  title: "ISLENMIS DEPO",
			  field: "ISD",
			  headerFilter: "input",
			  headerFilterFunc: function(headerValue, rowValue, rowData, filterParams) {
				// Filtre kutusu boşsa, satırı göster.
				if ($.trim(headerValue) === "") {
				  return true;
				}
				
				// Satırdaki değeri sayı tipine çeviriyoruz.
				var num = parseFloat(rowValue);
				if (isNaN(num)) {
				  return false;
				}
				
				headerValue = headerValue.trim();
				
				// NOT EQUAL (eşit değil) kontrolü: Eğer headerValue "<>" ile başlıyorsa
				if (headerValue.startsWith("<>")) {
				  var threshold = parseFloat(headerValue.substring(2).trim());
				  if (isNaN(threshold)) {
					return false;
				  }
				  return num !== threshold;
				}
				
				// Eğer headerValue ">" ile başlıyorsa:
				if (headerValue.startsWith(">")) {
				  var threshold = parseFloat(headerValue.substring(1).trim());
				  if (isNaN(threshold)) {
					return false;
				  }
				  return num > threshold;
				}
				
				// Eğer headerValue "<" ile başlıyorsa:
				if (headerValue.startsWith("<")) {
				  var threshold = parseFloat(headerValue.substring(1).trim());
				  if (isNaN(threshold)) {
					return false;
				  }
				  return num < threshold;
				}
				
				// Eğer aralık belirtimi varsa ("DEĞER - DEĞER")
				if (headerValue.indexOf("-") !== -1) {
				  var parts = headerValue.split("-");
				  if (parts.length !== 2) {
					return false;
				  }
				  var min = parseFloat(parts[0].trim());
				  var max = parseFloat(parts[1].trim());
				  if (isNaN(min) || isNaN(max)) {
					return false;
				  }
				  return num >= min && num <= max;
				}
				
				// Aksi durumda: girilen değere tam eşleşme kontrolü
				var threshold = parseFloat(headerValue);
				if (isNaN(threshold)) {
				  return false;
				}
				return num === threshold;
			  },
			  editor: false,
			  frozen: false,
			  vertAlign: "center",
			  width: 130 
			},
			{ 
			  title: "UK STOK", 
			  field: "UK", 
			  headerFilter: "input",
			  headerFilterFunc: function(headerValue, rowValue, rowData, filterParams) {
				// Filtre kutusu boşsa, satırı göster.
				if ($.trim(headerValue) === "") {
				  return true;
				}
				
				// Satırdaki değeri sayı tipine çeviriyoruz.
				var num = parseFloat(rowValue);
				if (isNaN(num)) {
				  return false;
				}
				
				headerValue = headerValue.trim();
				
				// NOT EQUAL (eşit değil) kontrolü: Eğer headerValue "<>" ile başlıyorsa
				if (headerValue.startsWith("<>")) {
				  var threshold = parseFloat(headerValue.substring(2).trim());
				  if (isNaN(threshold)) {
					return false;
				  }
				  return num !== threshold;
				}
				
				// Eğer headerValue ">" ile başlıyorsa:
				if (headerValue.startsWith(">")) {
				  var threshold = parseFloat(headerValue.substring(1).trim());
				  if (isNaN(threshold)) {
					return false;
				  }
				  return num > threshold;
				}
				
				// Eğer headerValue "<" ile başlıyorsa:
				if (headerValue.startsWith("<")) {
				  var threshold = parseFloat(headerValue.substring(1).trim());
				  if (isNaN(threshold)) {
					return false;
				  }
				  return num < threshold;
				}
				
				// Eğer aralık belirtimi varsa ("DEĞER - DEĞER")
				if (headerValue.indexOf("-") !== -1) {
				  var parts = headerValue.split("-");
				  if (parts.length !== 2) {
					return false;
				  }
				  var min = parseFloat(parts[0].trim());
				  var max = parseFloat(parts[1].trim());
				  if (isNaN(min) || isNaN(max)) {
					return false;
				  }
				  return num >= min && num <= max;
				}
				
				// Aksi durumda: girilen değere tam eşleşme kontrolü
				var threshold = parseFloat(headerValue);
				if (isNaN(threshold)) {
				  return false;
				}
				return num === threshold;
			  },
			  editor: false, 
			  frozen: false, 
			  vertAlign: "center",
			  width: 130 
			},
			{ 
			  title: "ANADEPO STOK", 
			  field: "AN", 
			  headerFilter: "input",
			  headerFilterFunc: function(headerValue, rowValue, rowData, filterParams) {
				// Filtre kutusu boşsa, satırı göster.
				if ($.trim(headerValue) === "") {
				  return true;
				}
				
				// Satırdaki değeri sayı tipine çeviriyoruz.
				var num = parseFloat(rowValue);
				if (isNaN(num)) {
				  return false;
				}
				
				headerValue = headerValue.trim();
				
				// NOT EQUAL (eşit değil) kontrolü: Eğer headerValue "<>" ile başlıyorsa
				if (headerValue.startsWith("<>")) {
				  var threshold = parseFloat(headerValue.substring(2).trim());
				  if (isNaN(threshold)) {
					return false;
				  }
				  return num !== threshold;
				}
				
				// Eğer headerValue ">" ile başlıyorsa:
				if (headerValue.startsWith(">")) {
				  var threshold = parseFloat(headerValue.substring(1).trim());
				  if (isNaN(threshold)) {
					return false;
				  }
				  return num > threshold;
				}
				
				// Eğer headerValue "<" ile başlıyorsa:
				if (headerValue.startsWith("<")) {
				  var threshold = parseFloat(headerValue.substring(1).trim());
				  if (isNaN(threshold)) {
					return false;
				  }
				  return num < threshold;
				}
				
				// Eğer aralık belirtimi varsa ("DEĞER - DEĞER")
				if (headerValue.indexOf("-") !== -1) {
				  var parts = headerValue.split("-");
				  if (parts.length !== 2) {
					return false;
				  }
				  var min = parseFloat(parts[0].trim());
				  var max = parseFloat(parts[1].trim());
				  if (isNaN(min) || isNaN(max)) {
					return false;
				  }
				  return num >= min && num <= max;
				}
				
				// Aksi durumda: girilen değere tam eşleşme kontrolü
				var threshold = parseFloat(headerValue);
				if (isNaN(threshold)) {
				  return false;
				}
				return num === threshold;
			  },
			  editor: false, 
			  frozen: false, 
			  vertAlign: "center",
			  width: 130 
			},
			{ 
			  title: "SV STOK", 
			  field: "SV", 
			  headerFilter: "input",
			  headerFilterFunc: function(headerValue, rowValue, rowData, filterParams) {
				// Filtre kutusu boşsa, satırı göster.
				if ($.trim(headerValue) === "") {
				  return true;
				}
				
				// Satırdaki değeri sayı tipine çeviriyoruz.
				var num = parseFloat(rowValue);
				if (isNaN(num)) {
				  return false;
				}
				
				headerValue = headerValue.trim();
				
				// NOT EQUAL (eşit değil) kontrolü: Eğer headerValue "<>" ile başlıyorsa
				if (headerValue.startsWith("<>")) {
				  var threshold = parseFloat(headerValue.substring(2).trim());
				  if (isNaN(threshold)) {
					return false;
				  }
				  return num !== threshold;
				}
				
				// Eğer headerValue ">" ile başlıyorsa:
				if (headerValue.startsWith(">")) {
				  var threshold = parseFloat(headerValue.substring(1).trim());
				  if (isNaN(threshold)) {
					return false;
				  }
				  return num > threshold;
				}
				
				// Eğer headerValue "<" ile başlıyorsa:
				if (headerValue.startsWith("<")) {
				  var threshold = parseFloat(headerValue.substring(1).trim());
				  if (isNaN(threshold)) {
					return false;
				  }
				  return num < threshold;
				}
				
				// Eğer aralık belirtimi varsa ("DEĞER - DEĞER")
				if (headerValue.indexOf("-") !== -1) {
				  var parts = headerValue.split("-");
				  if (parts.length !== 2) {
					return false;
				  }
				  var min = parseFloat(parts[0].trim());
				  var max = parseFloat(parts[1].trim());
				  if (isNaN(min) || isNaN(max)) {
					return false;
				  }
				  return num >= min && num <= max;
				}
				
				// Aksi durumda: girilen değere tam eşleşme kontrolü
				var threshold = parseFloat(headerValue);
				if (isNaN(threshold)) {
				  return false;
				}
				return num === threshold;
			  },
			  editor: false, 
			  frozen: false, 
			  vertAlign: "center",
			  width: 130 
			},
            { 
			  title: "PRK TL", 
			  field: "SFIYAT1", 
			  headerFilter: "input",
			  headerFilterFunc: function(headerValue, rowValue, rowData, filterParams){
				// Filtre kutusu boşsa, satırı göster.
				if($.trim(headerValue) === ""){
				  return true;
				}
				
				// Satırdaki değeri sayı tipine çeviriyoruz.
				var num = parseFloat(rowValue);
				if(isNaN(num)){
				  return false;
				}
				
				headerValue = headerValue.trim();
				
				// Eğer headerValue ">" ile başlıyorsa:
				if(headerValue.startsWith(">")){
				  var threshold = parseFloat(headerValue.substring(1).trim());
				  if(isNaN(threshold)){
					return false;
				  }
				  return num > threshold;
				}
				
				// Eğer headerValue "<" ile başlıyorsa:
				if(headerValue.startsWith("<")){
				  var threshold = parseFloat(headerValue.substring(1).trim());
				  if(isNaN(threshold)){
					return false;
				  }
				  return num < threshold;
				}
				
				// Eğer aralık belirtimi varsa ("DEĞER - DEĞER")
				if(headerValue.indexOf("-") !== -1){
				  var parts = headerValue.split("-");
				  if(parts.length !== 2) {
					return false;
				  }
				  var min = parseFloat(parts[0].trim());
				  var max = parseFloat(parts[1].trim());
				  if(isNaN(min) || isNaN(max)){
					return false;
				  }
				  return num >= min && num <= max;
				}
				
				// Aksi durumda: girmiş olunan değere eşitlik kontrolü (tam eşleşme)
				var threshold = parseFloat(headerValue);
				if(isNaN(threshold)){
				  return false;
				}
				return num === threshold;
			  },
			  editor: false, 
			  frozen: false, 
			  vertAlign: "center",
			  width: 130 
			},
			{ 
			  title: "PRK USD", 
			  field: "SFIYAT4", 
			  headerFilter: "input",
			  headerFilterFunc: function(headerValue, rowValue, rowData, filterParams){
				// Filtre kutusu boşsa, satırı göster.
				if($.trim(headerValue) === ""){
				  return true;
				}
				
				// Satırdaki değeri sayı tipine çeviriyoruz.
				var num = parseFloat(rowValue);
				if(isNaN(num)){
				  return false;
				}
				
				headerValue = headerValue.trim();
				
				// Eğer headerValue ">" ile başlıyorsa:
				if(headerValue.startsWith(">")){
				  var threshold = parseFloat(headerValue.substring(1).trim());
				  if(isNaN(threshold)){
					return false;
				  }
				  return num > threshold;
				}
				
				// Eğer headerValue "<" ile başlıyorsa:
				if(headerValue.startsWith("<")){
				  var threshold = parseFloat(headerValue.substring(1).trim());
				  if(isNaN(threshold)){
					return false;
				  }
				  return num < threshold;
				}
				
				// Eğer aralık belirtimi varsa ("DEĞER - DEĞER")
				if(headerValue.indexOf("-") !== -1){
				  var parts = headerValue.split("-");
				  if(parts.length !== 2) {
					return false;
				  }
				  var min = parseFloat(parts[0].trim());
				  var max = parseFloat(parts[1].trim());
				  if(isNaN(min) || isNaN(max)){
					return false;
				  }
				  return num >= min && num <= max;
				}
				
				// Aksi durumda: girmiş olunan değere eşitlik kontrolü (tam eşleşme)
				var threshold = parseFloat(headerValue);
				if(isNaN(threshold)){
				  return false;
				}
				return num === threshold;
			  },
			  editor: false, 
			  frozen: false, 
			  vertAlign: "center",
			  width: 130 
			},
            { 
			  title: "PRK EUR", 
			  field: "SFIYAT5", 
			  headerFilter: "input",
			  headerFilterFunc: function(headerValue, rowValue, rowData, filterParams){
				// Filtre kutusu boşsa, satırı göster.
				if($.trim(headerValue) === ""){
				  return true;
				}
				
				// Satırdaki değeri sayı tipine çeviriyoruz.
				var num = parseFloat(rowValue);
				if(isNaN(num)){
				  return false;
				}
				
				headerValue = headerValue.trim();
				
				// Eğer headerValue ">" ile başlıyorsa:
				if(headerValue.startsWith(">")){
				  var threshold = parseFloat(headerValue.substring(1).trim());
				  if(isNaN(threshold)){
					return false;
				  }
				  return num > threshold;
				}
				
				// Eğer headerValue "<" ile başlıyorsa:
				if(headerValue.startsWith("<")){
				  var threshold = parseFloat(headerValue.substring(1).trim());
				  if(isNaN(threshold)){
					return false;
				  }
				  return num < threshold;
				}
				
				// Eğer aralık belirtimi varsa ("DEĞER - DEĞER")
				if(headerValue.indexOf("-") !== -1){
				  var parts = headerValue.split("-");
				  if(parts.length !== 2) {
					return false;
				  }
				  var min = parseFloat(parts[0].trim());
				  var max = parseFloat(parts[1].trim());
				  if(isNaN(min) || isNaN(max)){
					return false;
				  }
				  return num >= min && num <= max;
				}
				
				// Aksi durumda: girmiş olunan değere eşitlik kontrolü (tam eşleşme)
				var threshold = parseFloat(headerValue);
				if(isNaN(threshold)){
				  return false;
				}
				return num === threshold;
			  },
			  editor: false, 
			  frozen: false, 
			  vertAlign: "center",
			  width: 130 
			},
			{ 
			  title: "MLYT USD", 
			  field: "HSP_MALIYET_USD", 
			  headerFilter: "input",
			  headerFilterFunc: function(headerValue, rowValue, rowData, filterParams){
				// Filtre kutusu boşsa, satırı göster.
				if($.trim(headerValue) === ""){
				  return true;
				}
				
				// Satırdaki değeri sayı tipine çeviriyoruz.
				var num = parseFloat(rowValue);
				if(isNaN(num)){
				  return false;
				}
				
				headerValue = headerValue.trim();
				
				// Eğer headerValue ">" ile başlıyorsa:
				if(headerValue.startsWith(">")){
				  var threshold = parseFloat(headerValue.substring(1).trim());
				  if(isNaN(threshold)){
					return false;
				  }
				  return num > threshold;
				}
				
				// Eğer headerValue "<" ile başlıyorsa:
				if(headerValue.startsWith("<")){
				  var threshold = parseFloat(headerValue.substring(1).trim());
				  if(isNaN(threshold)){
					return false;
				  }
				  return num < threshold;
				}
				
				// Eğer aralık belirtimi varsa ("DEĞER - DEĞER")
				if(headerValue.indexOf("-") !== -1){
				  var parts = headerValue.split("-");
				  if(parts.length !== 2) {
					return false;
				  }
				  var min = parseFloat(parts[0].trim());
				  var max = parseFloat(parts[1].trim());
				  if(isNaN(min) || isNaN(max)){
					return false;
				  }
				  return num >= min && num <= max;
				}
				
				// Aksi durumda: girmiş olunan değere eşitlik kontrolü (tam eşleşme)
				var threshold = parseFloat(headerValue);
				if(isNaN(threshold)){
				  return false;
				}
				return num === threshold;
			  },
			  editor: false, 
			  frozen: false, 
			  vertAlign: "center",
			  width: 130 
			},
			{
			  title: "Tedarik Yöntemi",
			  field: "TEDARIK_YONTEMI",
			  headerFilter: "select",
			  headerFilterParams: { values: tedarikyontemiMapping },

			  editable: true,                    // hücre düzenlenebilir olsun
			  editor: select2Editor,             // select2Editor kullan
			  editorParams: { values: tedarikyontemiMapping },
			  cellClick: function(e, cell) {     // tıklayınca edit moduna geç
				cell.edit();
			  },

			  formatter: "lookup",               // hücrede label göster
			  formatterParams: { lookup: tedarikyontemiLookupMap },

			  cellEdited: function(cell) {       // değer değiştiğinde
				// yeni ham değer cell.getValue() ile 0 veya 1 olarak gelecek
				triggerUpdate(cell);             // kendi güncelleme fonksiyonunu çağır
			  }
			},

			
			{
			  title: "Güncel Koleksiyon",
			  field: "KOLEKSIYON25",
			  hozAlign: "center",
			  align: "center",
			  // Özel formatter: Gelen değere göre checkbox işaretleme
			  formatter: function(cell, formatterParams, onRendered){
				var value = cell.getValue();
				return `<input type="checkbox" ${value == 1 ? "checked" : ""} />`;
			  },
			  // Özel editor: Düzenleme moduna geçtiğinde checkbox gösterip, değişiklikte değeri güncelliyor
			  editor: function(cell, onRendered, success, cancel){
				var input = document.createElement("input");
				input.setAttribute("type", "checkbox");
				// Başlangıç değerini ata
				input.checked = cell.getValue() == 1;
				// Değişiklik olduğunda değeri güncelle ve kaydet
				input.addEventListener("change", function(){
				  success(input.checked ? 1 : 0);
				});
				onRendered(function(){
				  input.focus();
				});
				return input;
			  },
			  cellEdited: function(cell){
				// Değer değiştiğinde update işlemini tetikle
				triggerUpdate(cell);
			  },
			  // İsteğe bağlı: headerFilter olarak da checkbox filter kullanmak istersen
			  headerFilter: "input",
			  headerFilterPlaceholder: "1 veya 0"
			},

            { title: "İngilizce Açıklama", field: "ACIKLAMA", headerFilter: "input",
			vertAlign:"center",
			headerFilterFunc: function(headerValue, rowValue, rowData, filterParams){
				if($.trim(headerValue) === ""){
				  return true;
				}
				
				var regexStr;
				// Eğer headerValue içerisinde "*" yoksa, contains mantığıyla filtrele: "*headerValue*"
				if (headerValue.indexOf("*") === -1) {
				  regexStr = ".*" + headerValue + ".*";
				} else {
				  // Eğer "*" karakteri varsa, kullanıcı tarafından girilen değeri regex'e çevir
				  regexStr = "^" + headerValue.replace(/\*/g, ".*") + "$";
				}
				
				var regex = new RegExp(regexStr, "i");
				
				if(typeof rowValue !== "string"){
				  return false;
				}
				
				return regex.test(rowValue);
			  },
			editor: "input", width: 375 }
          ];
          
          // 3) Tercihlere göre sıralayıp görünürlüğü ayarla
			columns.sort((a,b)=>{
			  const oa = prefMap[a.field]?.ColumnOrder ?? 0;
			  const ob = prefMap[b.field]?.ColumnOrder ?? 0;
			  return oa - ob;
			});
			columns.forEach(col=>{
			  if(prefMap[col.field] !== undefined){
				col.visible = prefMap[col.field].IsVisible;
			  }
			});

			// 2) Tabulator instantiation
			var table = new Tabulator("#hotContainer", {
			  height: "800px",
			  layout: "fitDataTable",
			  data: skartData,
			  movableColumns: true,             // sütun sürükle bırak
			  persistenceMode: "local",         // localStorage’da sakla
			  persistenceID:   "stokKartiTbl",  // localStorage anahtarı
			  persistence: {
				columns: true                   // sütun sırası/görünürlüğü/genişliği
			  },
			  
			  renderComplete: function(){
				// İlk yüklemede restore et
				this.restorePersistence();
				// Ardından manuel olarak bir kez de persist() çağır
				this.persist();
			  },

			  columns: columns,  // sizin daha önce tanımladığınız columns dizisi

			  // 4) (Opsiyonel) Hücre düzenleme callback’leri
			  cellEditing: function(cell){ /* ... */ },
			  cellEdited:  function(cell){ /* ... */ },
			});
			// 5) Her hareket/görünürlük değişiminde kaydet
				const persist = () => {
					const newPrefs = table.getColumns().map((col, idx)=>({
					  columnName:  col.getField(),
					  columnOrder: idx,
					  isVisible:   col.isVisible()
					}));
					saveUserPreferences(userId, tableName, newPrefs);
				  };
			  table.on('columnMoved', persist);
			  table.on('columnVisibilityChanged', persist);

			  // 7) refresh butonu
			  document.getElementById('refreshTable').addEventListener('click', ()=>{
				loadSkartData(d=> table.replaceData(d));
			  });

          // Güncelleme işlemini tetikleyen fonksiyon
          function triggerUpdate(cell) {
            var rowData = cell.getRow().getData();
            console.log("Güncelleme tetiklendi. Row verisi:", rowData);
            var recordToUpdate = {
              kod: rowData.KOD,
              ad: rowData.ADI,
			  ozel1: rowData.OZEL1,
              ozel2: rowData.OZEL2,
              ozel3: rowData.OZEL3,
              ozel4: rowData.OZEL4,
              ozel5: rowData.OZEL5,
              ozel6: rowData.OZEL6,
              aksesuar2: rowData.AKSESUAR2,
              aksesuar3: rowData.AKSESUAR3,
              ozel8: rowData.OZEL8,
              ozel9: rowData.OZEL9,
              ozel10: rowData.OZEL10,
              koleksiyon: rowData.KOLEKSIYON,              
              koleksiyon25: rowData.KOLEKSIYON25,
			  aciklama: rowData.ACIKLAMA,
			  name: rowData.NAME,
			  deritipi: rowData.DERITIPI,
			  islenti1: rowData.ISLENTI1,
			  islenti2: rowData.ISLENTI2,
			  tedarikyontemi: rowData.TEDARIK_YONTEMI
            };

            $.ajax({
              url: '/api/skart/update',
              method: 'POST',
              contentType: 'application/json',
              data: JSON.stringify(recordToUpdate),
              success: function(resp){
                if(resp.success) {
                  console.log("Satır güncellendi: " + rowData.KOD );
                } else {
                  console.error("Güncelleme hatası: " + resp.message);
                }
              },
              error: function(err){
                console.error("AJAX hatası:", err);
              }
            });
          } // triggerUpdate sonu
		  }); // loadLookupData(basamak1mapping) kapanışı 
		  }); // loadLookupData(253-TEDARIKYONTEMI) kapanışı 
		  }); // loadLookupData(250-KOLEKSIYON) kapanışı 
		  }); // loadLookupData(79) kapanışı 
		  }); // loadLookupData(78) kapanışı 
		  }); // loadLookupData(77) kapanışı 
		  }); // loadLookupData(75) kapanışı 
         }); // loadLookupData(74) kapanışı 
        }); // loadLookupData(73) kapanışı
      }); // loadLookupData(72) kapanışı
    }); // loadLookupData(71) kapanışı
	}); // loadLookupData(70) kapanışı
  }); // loadSkartData kapanışı
}


  </script>

<script>
async function showKodPopup(kod, x, y) {
  console.log("showKodPopup çağrıldı. KOD:", kod, "Koordinatlar:", x, y);
  try {
    const response = await fetch(`/api/kod-konsept-detay?kod=${encodeURIComponent(kod)}`);
    console.log("fetch sonucu:", response);
    if (!response.ok) {
      console.error("Detay verisi alınamadı, status:", response.status);
      throw new Error("Detay verisi alınamadı.");
    }
    const result = await response.json();
    console.log("Endpoint'ten dönen sonuç:", result);
    if (!result.success) {
      console.error("Endpoint success false döndü:", result.message);
      throw new Error(result.message);
    }
    const data = result.data;
    let conceptContent = "";
    if (data.length === 0) {
      conceptContent = "<em>Konsept bulunamadı.</em>";
    } else {
      conceptContent = "<strong>Konseptler:</strong><br>" + data.map(item => item.CUSTOMER_NAME).join("<br>");
    }
    
    // Ürün fotoğrafını gösteren <img> etiketi; 
    // Eğer fotoğraf bulunamazsa, onerror devreye girip dışarıda "Fotoğrafsız Ürün" mesajı içeren bir div oluşturur.
    const imgTag = `<img src="/resim/${kod}.jpg" style="max-width:100%; height:auto; margin-bottom:5px;" onerror="this.onerror=null; this.outerHTML='<div style=&quot;max-width:100%; height:auto; margin-bottom:5px; text-align:center; font-weight:bold; color:red;&quot;>Fotoğrafsız Ürün</div>';">`;
    
    // Popup içeriği; fotoğraf (veya mesaj) + konsept detayları alt alta.
    const content = `${imgTag}<br>${conceptContent}`;

    const popup = document.getElementById("kodPopup");
    if (popup) {
      popup.innerHTML = content;
      popup.style.left = x + "px";
      popup.style.top = y + "px";
      popup.style.display = "block";
      console.log("Popup gösterildi:", popup);
    } else {
      console.error("Popup elementi bulunamadı (id='kodPopup').");
    }
  } catch (err) {
    console.error("showKodPopup içerisinde hata:", err);
  }
}

function hideKodPopup() {
  console.log("hideKodPopup çağrıldı.");
  const popup = document.getElementById("kodPopup");
  if (popup) {
    popup.style.display = "none";
    console.log("Popup gizlendi.");
  } else {
    console.error("Popup elementi bulunamadı (id='kodPopup').");
  }
}


//Stok Kartı Excel Export
// Dikkat: Bu fonksiyon ExcelJS kütüphanesinin sayfada yüklü olduğunu varsayar.
async function exportFilteredDataToExcel() {
  try {
    // Yeni bir Excel workbook ve worksheet oluşturuluyor:
    const workbook = new ExcelJS.Workbook();
    const worksheet = workbook.addWorksheet("Stok Kartı");

    // Excel sütun başlıkları (ilk sütun "Fotoğraf" resim için kullanılacak)
    const headers = [
      "Fotoğraf", "KOD", "ADI", "BIRIM", "BASAMAK 1", "BASAMAK 2", "BASAMAK 3", "BASAMAK 4", "BASAMAK 5", 
      "CINS", "MODEL", "MATERYAL", "EBAT", "RENK", "DESEN", "LAMINE", "AKSESUAR", "AKSESUAR 2", 
      "AKSESUAR 3", "KALİTE", "GENİŞ KOLEKSIYON", "ISIM", "DERI TIPI", "ISLENTI 1", "ISLENTI 2", "HOM STOK", "MERKEZ STOK", "SHW STOK", "SHWAKS STOK", 
      "CUMBA STOK", "ISLENMIS DEPO", "UK STOK", "ANADEPO STOK", "SV STOK", "PRK TL", "PRK USD", "PRK EUR", "MLYT USD", "Tedarik Yöntemi", 
      "İngilizce Açıklama"
    ];
    // Başlık satırını ekliyoruz:
    worksheet.addRow(headers);

    // Tabulator grid’in filtrelenmiş (aktif) verilerini alıyoruz:
    const data = table.getData("active");  // "table" değişkeni global Tabulator instance'ınız

    // Her satır için işlemler:
    for (let i = 0; i < data.length; i++) {
      const rowData = data[i];
      
      // Fotoğraf URL'si oluşturuluyor:
      let imageUrl = "/resim/" + rowData.KOD + ".jpg";
      // Resim çekilemezse fallback olarak:
      let response = await fetch(imageUrl).catch(() => null);
      if (!response || !response.ok) {
        imageUrl = "/resim/YOK.jpg";
        response = await fetch(imageUrl);
      }
      
      // Blob olarak resmi elde ediyoruz:
      const blob = await response.blob();
      // Blob'u base64 string'e dönüştürme (ExcelJS, base64 veriyi kullanarak resim ekliyor):
      const base64 = await new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onloadend = () => {
          // Data URL biçiminde dönen değerden base64 kısmını alıyoruz:
          resolve(reader.result.split(',')[1]);
        };
        reader.onerror = reject;
        reader.readAsDataURL(blob);
      });
      
      // Resmi workbook’a ekliyoruz:
      const imageId = workbook.addImage({
        base64: base64,
        extension: 'jpeg'
      });
      
      // Diğer sütunların verisini hazırlıyoruz.
      // Sıralama, tabulator grid’in kolon sırası ile aynı olacak şekilde:
      const rowValues = [
        "",  // Fotoğraf sütunu placeholder, resmi ayrı ekleyeceğiz.
        rowData.KOD || "",
        rowData.ADI || "",
		rowData.BIRIM || "",
        rowData.BASAMAK1 || "",
        rowData.BASAMAK2 || "",
        rowData.BASAMAK3 || "",
        rowData.BASAMAK4 || "",
        rowData.BASAMAK5 || "",
         // CINS: Görünen değeri ekliyoruz:
		  (typeof cinsLookupMap !== "undefined" && cinsLookupMap[rowData.OZEL1]) ? cinsLookupMap[rowData.OZEL1] : (rowData.OZEL1 || ""),
		  // MODEL:
		  (typeof modelLookupMap !== "undefined" && modelLookupMap[rowData.OZEL2]) ? modelLookupMap[rowData.OZEL2] : (rowData.OZEL2 || ""),
		  // MATERYAL:
		  (typeof materyalLookupMap !== "undefined" && materyalLookupMap[rowData.OZEL3]) ? materyalLookupMap[rowData.OZEL3] : (rowData.OZEL3 || ""),
		  // EBAT:
		  (typeof ebatLookupMap !== "undefined" && ebatLookupMap[rowData.OZEL9]) ? ebatLookupMap[rowData.OZEL9] : (rowData.OZEL9 || ""),
		  // RENK:
		  (typeof renkLookupMap !== "undefined" && renkLookupMap[rowData.OZEL10]) ? renkLookupMap[rowData.OZEL10] : (rowData.OZEL10 || ""),
		  // DESEN:
		  (typeof desenLookupMap !== "undefined" && desenLookupMap[rowData.OZEL4]) ? desenLookupMap[rowData.OZEL4] : (rowData.OZEL4 || ""),
		  // LAMINE:
		  (typeof lamineLookupMap !== "undefined" && lamineLookupMap[rowData.OZEL5]) ? lamineLookupMap[rowData.OZEL5] : (rowData.OZEL5 || ""),
		  // AKSESUAR:
		  (typeof aksesuarLookupMap !== "undefined" && aksesuarLookupMap[rowData.OZEL6]) ? aksesuarLookupMap[rowData.OZEL6] : (rowData.OZEL6 || ""),
		  // AKSESUAR 2:
		  (typeof aksesuarLookupMap !== "undefined" && aksesuarLookupMap[rowData.AKSESUAR2]) ? aksesuarLookupMap[rowData.AKSESUAR2] : (rowData.AKSESUAR2 || ""),
		  // AKSESUAR 3:
		  (typeof aksesuarLookupMap !== "undefined" && aksesuarLookupMap[rowData.AKSESUAR3]) ? aksesuarLookupMap[rowData.AKSESUAR3] : (rowData.AKSESUAR3 || ""),
		  // KALİTE:
		  (typeof kaliteLookupMap !== "undefined" && kaliteLookupMap[rowData.OZEL8]) ? kaliteLookupMap[rowData.OZEL8] : (rowData.OZEL8 || ""),
		  // GENİŞ KOLEKSIYON:
		  (typeof koleksiyonLookupMap !== "undefined" && koleksiyonLookupMap[rowData.KOLEKSIYON]) ? koleksiyonLookupMap[rowData.KOLEKSIYON] : (rowData.KOLEKSIYON || ""),
		rowData.ISIM || "",
		rowData.DERITIPI || "",
		rowData.ISLENTI1 || "",
		rowData.ISLENTI2 || "",		
        rowData.HOM || "",
        rowData.MRKZ || "",
        rowData.SHWR || "",        // SHW STOK (grid’de "SHWR" alanı)
        rowData.SHWAKS || "",
        rowData.CUMBA || "",
        rowData.ISD || "",
        rowData.UK || "",
        rowData.AN || "",
        rowData.SV || "",
        rowData.SFIYAT1 || "",
        rowData.SFIYAT4 || "",
        rowData.SFIYAT5 || "",
		rowData.HSP_MALIYET_USD || "",
		rowData.TEDARIK_YONTEMI || "",
        rowData.ACIKLAMA || ""
      ];
      
      // Yeni satır ekleniyor:
      const excelRow = worksheet.addRow(rowValues);
      const excelRowNum = excelRow.number;  // Bu satırın sıra numarası

      // Resmi ilk sütun ("Fotoğraf") hücresine 50px x 50px ölçülerinde ekliyoruz:
      worksheet.addImage(imageId, {
        tl: { col: 0, row: excelRowNum - 1 },
        ext: { width: 50, height: 50 }
      });
      
      // Satır yüksekliğini ayarlıyoruz (yaklaşık dönüşüm: 1 px ≈ 0.75 point):
      worksheet.getRow(excelRowNum).height = 50 * 0.75;
    }

    // Çalışma kitabını buffer olarak yazıp indirme işlemini tetikleyelim:
    const buffer = await workbook.xlsx.writeBuffer();
    const blob = new Blob([buffer], { type: "application/vnd.openxmlformats-officedocument.spreadsheetml.sheet" });
    const url = window.URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = "StokKarti.xlsx";
    a.click();
    window.URL.revokeObjectURL(url);

  } catch (error) {
    console.error("Excel export hatası:", error);
    alert("Excel dışa aktarımında bir hata oluştu.");
  }
}

</script>
<script>

document.addEventListener('DOMContentLoaded', function() {
  const campaignForm = document.getElementById('campaignForm');
  
  campaignForm.addEventListener('submit', async function(e) {
  e.preventDefault();

  // Diğer form alanlarını toplayın...
  const selectedProducts = [];
  const rows = document.querySelectorAll('#selectedProductsTable tbody tr');
  rows.forEach(row => {
    const prodCode = row.getAttribute('data-code');
    if (prodCode) {
      selectedProducts.push(prodCode);
    }
  });

  const campaignData = {
    campaignName: document.getElementById('campaignName').value,
    campaignType: document.getElementById('campaignType').value,
    campaignDescription: document.getElementById('campaignDescription').value,
    startDate: document.getElementById('startDate').value,
    endDate: document.getElementById('endDate').value,
    includeSubCategories: document.getElementById('includeSubCategories').checked || false,
    discountValue: parseFloat(document.getElementById('discountValue').value || "0"),
    discountType: document.getElementById('discountType').value,
    isCombinable: document.querySelector('input[name="isCombinable"]:checked').value === "true",
    // Kategori seçimi daha önce toplanıyor (jstree ile)
    selectedCategories: document.getElementById('selectedCategories').value.split(',').filter(Boolean),
    // Yeni eklenen alan: Seçilen ürünlerin (üzerinde işlemler yapmak için)
    selectedProducts: selectedProducts  // Örneğin, ürün KODlarını içeren diziniz
  };
 console.log("Gönderilen kampanya verisi:", campaignData); // Debug için
  try {
    const response = await fetch('/api/campaigns', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(campaignData)
    });
    
    if (!response.ok) {
      alert('Kampanya kaydedilemedi!');
      return;
    }
    const result = await response.json();
    if (result.success) {
      alert('Kampanya başarıyla kaydedildi!');
      campaignForm.reset();
      // Seçilen ürünler tablosunu temizleyin
      document.querySelector('#selectedProductsTable tbody').innerHTML = '';
      loadCampaigns();
    } else {
      alert('Kampanya kaydedilemedi: ' + (result.message || 'Bilinmeyen hata'));
    }
  } catch (error) {
    console.error(error);
    alert('Sunucuya bağlanırken hata oluştu.');
  }
});


  // Kategori ağacı jstree yükleme fonksiyonu: (önceki örnekteki gibi)
  loadCategoryTree();  
  //Mevcut Kampanyaları Yükleme Fonksiyonu
  loadCampaigns();
});

// jstree ile kategori seçiminde gizli input güncellemesi:
$('#campaignCategoriesTree').on("changed.jstree", function (e, data) {
  const selectedNodes = data.selected; 
  document.getElementById('selectedCategories').value = selectedNodes.join(',');
});



// Kampanya türleri için mapping sözlüğünüz
const campaignTypeMap = {
  "PRODUCT": "Ürün İndirimi",
  "CART": "Sepet İndirimi",
  "BUY_X_GET_Y": "X Al Y Öde / Bedava",
  "Nth_Product_Discount": "X. Ürüne İndirim",
  "CATEGORY_CART": "Kategori Bazlı İndirim"
};

function loadCampaigns() {
  fetch('/api/campaigns')
    .then(response => response.json())
    .then(result => {
      if (!result.success) {
        console.error("Kampanyalar alınamadı:", result.message);
        return;
      }
      const campaigns = result.data;
      const tbody = document.querySelector('#campaignsTable tbody');
      tbody.innerHTML = ''; // Önce tabloyu temizle

      if (campaigns.length === 0) {
        tbody.innerHTML = '<tr><td colspan="7" class="text-center">Hiç kampanya kaydı bulunamadı.</td></tr>';
      } else {
        campaigns.forEach(campaign => {
          const displayType = campaignTypeMap[campaign.CampaignType] || campaign.CampaignType;
          const startDateTr = formatDateTrLocal(campaign.StartDate); // Türkçe format
          const endDateTr = formatDateTrLocal(campaign.EndDate);     // Türkçe format

          // Alt kategoriler (eğer backend'den geliyorsa) ya da boş
          const categories = campaign.categories || "";

          const row = `
            <tr>
              <td>${campaign.CampaignID}</td>
              <td>${campaign.CampaignName}</td>
              <td>${displayType}</td>
              <td>${startDateTr}</td>
              <td>${endDateTr}</td>
              <td>${categories}</td>
              <td>
                <button class="btn btn-sm btn-info" onclick="editCampaign(${campaign.CampaignID})">Düzenle</button>
                <button class="btn btn-sm btn-danger" onclick="deleteCampaign(${campaign.CampaignID})">Sil</button>
              </td>
            </tr>
          `;
          tbody.insertAdjacentHTML('beforeend', row);
        });
      }
    })
    .catch(error => {
      console.error("Kampanyalar yüklenirken hata oluştu:", error);
    });
}

// Yardımcı tarih format fonksiyonu
// Yardımcı: UTC tarih string’ini İstanbul saatiyle formatlayan fonksiyon
function formatDateTrLocal(dateString) {
  if (!dateString) return "";
  const dateObj = new Date(dateString);  // "2025-04-18T05:00:00.000Z" gibi ISO
  return dateObj.toLocaleString("tr-TR", {
    timeZone: "Europe/Istanbul",
    day:   "2-digit",
    month: "2-digit",
    year:  "numeric",
    hour:  "2-digit",
    minute:"2-digit"
  });
}

//Kampanya Düzenleme Fonksiyonu
async function editCampaign(campaignID) {
  try {
    const response = await fetch(`/api/campaigns/${campaignID}`);
    if (!response.ok) {
      alert("Kampanya bilgileri alınırken hata oluştu!");
      return;
    }
    const result = await response.json();
    if (!result.success) {
      alert(result.message || "Kampanya bilgileri alınamadı!");
      return;
    }
    // Yanıt yapısına göre; eğer veriler result.data içindeyse:
    const campaign = result.data || result;
    
    // Form alanlarını dolduruyoruz
    document.getElementById('campaignId').value = campaign.CampaignID; // Gizli alan
    document.getElementById('campaignName').value = campaign.CampaignName || "";
    document.getElementById('campaignType').value = campaign.CampaignType || "";
    document.getElementById('campaignDescription').value = campaign.Description || "";
    document.getElementById('startDate').value = campaign.StartDate;
    document.getElementById('endDate').value = campaign.EndDate;
    document.getElementById('includeSubCategories').checked = campaign.IncludeSubCategories ? true : false;
    document.getElementById('discountValue').value = campaign.DiscountValue || "";
    document.getElementById('discountType').value = campaign.DiscountType || "PERCENT";
    
    if (campaign.IsCombinable) {
      document.getElementById('combinableYes').checked = true;
    } else {
      document.getElementById('combinableNo').checked = true;
    }
    
    // Kategori veya Ürün seçim alanları: Kampanya türüne bağlı olarak
    if (campaign.CampaignType === "CATEGORY_CART" && campaign.categories) {
      // jstree ile kategori ağaç: seçili kategorileri (kampanya.categories beklediğimiz gibi array ise)
      $('#campaignCategoriesTree').jstree('deselect_all');
      campaign.categories.forEach(function(catId) {
        $('#campaignCategoriesTree').jstree('select_node', catId.toString());
      });
      document.getElementById('selectedCategories').value = campaign.categories.join(',');
      // Göster kategori seçim alanını
      document.getElementById('categorySelectionSection').style.display = 'block';
      document.getElementById('productSelectionSection').style.display = 'none';
    } else if (campaign.CampaignType === "PRODUCT" && campaign.selectedProducts) {
      // Ürün İndirimi için seçili ürünler: campaign.selectedProducts beklediğimiz gibi array ise
      // Mevcut ürünler tablosunu temizleyin
      const tbody = document.querySelector('#selectedProductsTable tbody');
      tbody.innerHTML = "";
      campaign.selectedProducts.forEach(productId => {
        // Frontend tarafında ürünü listelemek için ilgili bilgileri de backend'den almanız gerekir.
        // Örneğin, product verilerini içeren bir mapping ya da ekstra endpoint varsa onu kullanın.
        // Burada basitçe productId, örneğin; ürün bilgilerini doldurun:
        const imageUrl = `/resim/YOK.jpg`;  // Gerçek ürün resmi URL'sini almak için kodunuzu uyarlayın.
        // Örneğin, eğer product bilgileri campaign.selectedProducts içindeyse:
        const product = campaign.selectedProductsInfo ? campaign.selectedProductsInfo.find(p => p.ID == productId) : {};
        const kod = product.KOD || productId;
        const adi = product.ADI || "";
        const ebat = product.EBAT || "";
        const model = product.OZEL2 || "";
        
        const rowHTML = `
          <tr data-code="${productId}">
            <td><img src="/resim/${kod}.jpg" class="product-thumb" onerror="this.onerror=null;this.src='/resim/YOK.jpg';"></td>
            <td>${kod}</td>
            <td>${adi}</td>
            <td>${ebat}</td>
            <td>${model}</td>
            <td><button class="btn btn-sm btn-danger" onclick="removeProductFromCampaign('${productId}', this)">Sil</button></td>
          </tr>
        `;
        tbody.insertAdjacentHTML('beforeend', rowHTML);
      });
      // Göster ürün seçim alanını
      document.getElementById('productSelectionSection').style.display = 'block';
      document.getElementById('categorySelectionSection').style.display = 'none';
    } else {
      // Diğer türlerde seçim alanlarını gizleyin
      document.getElementById('productSelectionSection').style.display = 'none';
      document.getElementById('categorySelectionSection').style.display = 'none';
    }
    
    // İlgili alanlar doldurulduktan sonra, sayfa (veya panel) kullanıcıya güncel haliyle gösterilebilir.
    // (Eğer form aynı sayfada görünüyorsa ek bir modal açmaya gerek yok)
    
  } catch (error) {
    console.error("editCampaign hata:", error);
    alert("Kampanya bilgilerini alırken hata oluştu.");
  }
}

 // Kampanya türü "Ürün İndirimi" seçilmişse ürün seçimi alanını göster
    document.getElementById('campaignType').addEventListener('change', function() {
      const type = this.value;
    // Kampanya türüne bağlı olarak alanları göster/gizle:
    if (type === 'PRODUCT') {
      // Ürün İndirimi seçilmiş: Göster ürün seçimi, gizle kategori seçim alanı
      document.getElementById('productSelectionSection').style.display = 'block';
      document.getElementById('categorySelectionSection').style.display = 'none';
      loadDiscountedProducts(); // Ürün listesini yükle
    } else if (type === 'CATEGORY_CART') {
      // Kategori Bazlı İndirim: Göster kategori ağaç yapısını, gizle ürün seçimi
      document.getElementById('categorySelectionSection').style.display = 'block';
      document.getElementById('productSelectionSection').style.display = 'none';
      loadCategoryTree(); // Kategori ağacı yükle
    } else {
      // Diğer kampanya türleri için, her iki alanı gizleyebilirsiniz.
      document.getElementById('productSelectionSection').style.display = 'none';
      document.getElementById('categorySelectionSection').style.display = 'none';
    }
    });
//güncelleme işlemi için (updateCampaign) form submit olayını yakalayıp backend’e PUT isteği gönderecek
document.getElementById('editCampaignForm').addEventListener('submit', async function(e) {
  e.preventDefault();
  
  const campaignID = document.getElementById('editCampaignId').value;
  const updatedData = {
    campaignName: document.getElementById('campaignNameEdit').value,
    // Diğer alanları doldurun, örneğin:
    // campaignType, campaignDescription, startDate, endDate, includeSubCategories, discountValue, discountType, isCombinable, selectedCategories vs.
  };

  try {
    const response = await fetch(`/api/campaigns/${campaignID}`, {
      method: 'PUT',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(updatedData)
    });
    
    if (!response.ok) {
      alert('Kampanya güncellenirken hata oluştu!');
      return;
    }
    const result = await response.json();
    if (result.success) {
      alert('Kampanya başarıyla güncellendi!');
      $('#editCampaignModal').modal('hide');
      loadCampaigns();  // Listeyi yenile
    } else {
      alert('Güncelleme başarısız: ' + result.message);
    }
  } catch (error) {
    console.error("UpdateCampaign hata:", error);
    alert('Güncelleme sırasında beklenmeyen bir hata oluştu.');
  }
});
// jstree seçimi değiştiğinde gizli input güncelleniyor
    $('#campaignCategoriesTree').on("changed.jstree", function (e, data) {
      const selectedNodes = data.selected;
      document.getElementById('selectedCategories').value = selectedNodes.join(',');
    });
// Kampanya Ürünleri /api/skart endpoint'inden çekip, select picker'ı dolduran fonksiyon
 // /api/skart'tan ürünleri çekip, selectpicker'ı dolduran fonksiyon
    async function loadDiscountedProducts() {
	  try {
		const response = await fetch('/api/skart');
		const result = await response.json();
		if (!result.success) {
		  console.error("SKART verileri alınamadı:", result.message);
		  return;
		}
		const products = result.data;
		const select = document.getElementById('discountedProducts');
		select.innerHTML = '<option value="">Ürün Seçiniz...</option>';
		products.forEach(product => {
		  // Ürün resim URL'sini oluşturuyoruz
		  const imageUrl = `/resim/${product.KOD}.jpg`;
		  // Display içeriğini oluşturuyoruz; burada KOD, ADI, EBAT, MODEL verilerini gösterelim.
		  const displayContent = `<div class="option-content">
			  <img src="${imageUrl}" style="width:30px; height:30px; margin-right:5px; border-radius:3px;" onerror="this.onerror=null;this.src='/resim/YOK.jpg';">
			  <span><strong>${product.KOD}</strong> - ${product.ADI} - ${product.EBAT || ''} - ${product.OZEL2 || ''}</span>
			</div>`;
		  // Burada option'un value'sunu product.ID olarak belirleyin
		  const option = document.createElement('option');
		  option.value = product.ID;  // Dikkat: product.ID alanı, Campaign_Products tablosunda ProductID sütunu için kullanılacak.
		  option.setAttribute('data-content', displayContent);
		  // Ek olarak, diğer verileri de attribute olarak saklayabiliriz:
		  option.setAttribute('data-kod', product.KOD);
		  option.setAttribute('data-adi', product.ADI);
		  option.setAttribute('data-ebat', product.EBAT || '');
		  option.setAttribute('data-model', product.OZEL2 || '');
		  select.appendChild(option);
		});
		$('.selectpicker').selectpicker('refresh');
	  } catch (error) {
		console.error("Ürün verileri yüklenirken hata:", error);
	  }
	}


 // Seçilen ürünü "Seçilen Ürünler" tablosuna ekleyen fonksiyon
    function addProductToCampaign() {
	  const select = document.getElementById('discountedProducts');
	  const selectedValue = select.value; // Bu artık product.ID olacak
	  if (!selectedValue) return;
	  
	  // Seçilen option'u elde edip, diğer detayları custom data attribute'lerinden okuyun
	  const selectedOption = select.options[select.selectedIndex];
	  const kod = selectedOption.getAttribute('data-kod') || "";
	  const adi = selectedOption.getAttribute('data-adi') || "";
	  const ebat = selectedOption.getAttribute('data-ebat') || "";
	  const model = selectedOption.getAttribute('data-model') || "";
	  // Fotoğraf URL'si yine KOD tabanlı da olabilir, isteğe göre düzenleyin
	  const imageUrl = `/resim/${kod}.jpg`;
	  
	  const tbody = document.querySelector('#selectedProductsTable tbody');
	  if (tbody.querySelector(`tr[data-code="${selectedValue}"]`)) {
		alert("Bu ürün zaten seçilmiş.");
		return;
	  }
	  
	  const row = document.createElement('tr');
	  row.setAttribute('data-code', selectedValue);
	  row.innerHTML = `
		<td><img src="${imageUrl}" class="product-thumb" onerror="this.onerror=null;this.src='/resim/YOK.jpg';"></td>
		<td>${kod}</td>
		<td>${adi}</td>
		<td>${ebat}</td>
		<td>${model}</td>
		<td><button class="btn btn-sm btn-danger" onclick="removeProductFromCampaign('${selectedValue}', this)">Sil</button></td>
	  `;
	  tbody.appendChild(row);
	}



    // Seçilen ürünü tablodan kaldıran fonksiyon
    function removeProductFromCampaign(productCode, btnElement) {
      // İlgili satırı silmek için:
      const row = btnElement.closest('tr');
      row.parentNode.removeChild(row);
    }

// DOM yüklendiğinde ürünleri çekmek için:
document.addEventListener('DOMContentLoaded', function() {
  loadDiscountedProducts();
});

//Kampanya Silme İşlevi
async function deleteCampaign(campaignID) {
  if (!confirm("Bu kampanyayı silmek istediğinize emin misiniz?")) {
    return;
  }
  
  try {
    // DELETE metodu kullanarak kampanyayı silen endpoint'e istek gönderiyoruz.
    const response = await fetch(`/api/campaigns/${campaignID}`, {
      method: 'DELETE'
    });
    
    if (!response.ok) {
      alert("Kampanya silinirken hata oluştu!");
      console.error("Delete error:", response.status, response.statusText);
      return;
    }
    
    const result = await response.json();
    if (result.success) {
      alert("Kampanya başarılı şekilde silindi.");
      // Listeyi yenilemek için kampanyaları yeniden yükleyin:
      loadCampaigns();
    } else {
      alert("Kampanya silinemedi: " + result.message);
    }
  } catch (error) {
    console.error("DeleteCampaign hata:", error);
    alert("Kampanya silme sırasında beklenmeyen bir hata oluştu.");
  }
}


</script>
<script>
//Stok Durum Raporu
// 1) Menü tıklaması / panel gösterme
document.addEventListener('DOMContentLoaded', () => {
  const stockMenu = document.getElementById('stock-depo-status');
  stockMenu.addEventListener('click', function(e) {
    e.preventDefault();
    showStockDepoStatus();
  });
  
  // "Getir" butonuna tıklandığında rapor yükle
  document.getElementById('loadStockBtn')
          .addEventListener('click', loadStockInventoryReport);
});

let depoList = [];

// 2) Depo dropdown'unu dolduran fonksiyon
async function fetchDepolar() {
  try {
    const res = await fetch('/api/depos');
    const json = await res.json();
    if (!json.success) throw new Error(json.message);
    depoList = json.data;
  } catch (err) {
    console.error('Depo yükleme hatası', err);
  }
}

// 3) Paneli göster / diğer panelleri gizle
// … (aynı baştaki fetchDepolar ve DOMContentLoaded kodları)

// … DOMContentLoaded vs. aynı

async function showStockDepoStatus() {
  // 🔒 Sadece Admin Panel’deysek devam et
  const activeTab = document.querySelector('.tab-pane.active');
  if (!activeTab || activeTab.id !== "adminPanel") {
    alert("Stok Depo Durum raporu yalnızca Admin Panel'de kullanılabilir.");
    return;
  }

  // a) Diğer tüm ana panelleri gizle
  ['barcodeContainer','conceptLabelContainer','initialImageContainer','product-container']
    .forEach(id => {
      const el = document.getElementById(id);
      if (el) el.style.display = 'none';
    });

  // b) Tarih‑depo formunu göster
  document.getElementById('stockInventoryContainer').style.display = 'block';

  // c) Bugünün tarihini ata
  document.getElementById('dateInput').value = new Date().toISOString().substr(0,10);

  // d) Depo listesini yükle ve dropdown'u doldur
  if (depoList.length === 0) {
    await fetchDepolar();
  }
  const ddl = document.getElementById('depoDropdown');
  ddl.innerHTML = '<option value="">Seçiniz</option>';
  depoList.forEach(d => {
    const opt = document.createElement('option');
    opt.value = d.KOD;
    opt.textContent = `${d.KOD} - ${d.ADI}`;
    ddl.appendChild(opt);
  });

  // e) Önceki raporu temizle
  document.getElementById('stockReportContainer').innerHTML = '';
}


let lastStockData = [];
let lastDate, lastDepo;

document.addEventListener('DOMContentLoaded', () => {
  document.getElementById('stock-depo-status')
          .addEventListener('click', showStockDepoStatus);

  document.getElementById('loadStockBtn')
          .addEventListener('click', loadStockInventoryReport);

  document.getElementById('exportStockBtn')
          .addEventListener('click', exportStockToExcel);
});

async function loadStockInventoryReport() {
  const date = document.getElementById('dateInput').value;
  const depo = document.getElementById('depoDropdown').value;
  if (!date || !depo) return alert('Lütfen hem tarih hem depo seçiniz.');

  // kaydet
  lastDate = date;
  lastDepo = depo;
  const formatNumber = (value) => {
    const parts = Number(value).toFixed(2).split(".");
    parts[0] = parts[0].replace(/\B(?=(\d{3})+(?!\d))/g, ".");
    return parts.join(",");
  };	
  try {
    const res = await fetch(
      `/api/stock-inventory?date=${encodeURIComponent(date)}&depo=${encodeURIComponent(depo)}`
    );
    const json = await res.json();
    if (!json.success) {
      return alert('Rapor alınamadı: ' + json.message);
    }

    const data = json.data;
    lastStockData = data;

    // toplam miktar
    const total = data.reduce((sum, r) => sum + (r.MIKTAR||0), 0);

    // tabloyu inşa et
    let html = `
      <table class="table table-sm table-bordered mt-3" style="font-size:10px">
        <thead class="thead-light">
          <tr>
            <th>BASAMAK1</th><th>BASAMAK2</th><th>BASAMAK3</th><th>BASAMAK4</th><th>BASAMAK5</th>
            <th>KOD</th><th>ADI</th><th>BİRİM</th>
            <th style="text-align:right">MIKTAR</th>
			<th style="text-align:right">PRK USD</th>
			<th style="text-align:right">MLYT USD</th>
			<th style="text-align:right">Çarpan</th>
          </tr>
        </thead>
        <tbody>
    `;

    data.forEach(r => {
      html += `
        <tr>
          <td>${r.BASAMAK1||''}</td>
          <td>${r.BASAMAK2||''}</td>
          <td>${r.BASAMAK3||''}</td>
          <td>${r.BASAMAK4||''}</td>
          <td>${r.BASAMAK5||''}</td>
          <td>${r.KOD}</td>
          <td>${r.ADI}</td>
          <td>${r.BRM}</td>
          <td style="text-align:right">${formatNumber(r.MIKTAR)}</td>
		  <td style="text-align:right">${formatNumber(r.PRK_USD)}</td>
		  <td style="text-align:right">${formatNumber(r.HSP_MALIYET_USD)}</td>
		  <td style="text-align:right">
		  ${ formatNumber(
			  Number.isFinite(r.PRK_USD / r.HSP_MALIYET_USD)
				? r.PRK_USD / r.HSP_MALIYET_USD
				: 0
			)
		  }
		</td>

        </tr>
      `;
    });

    html += `
        </tbody>
        <tfoot>
          <tr>
            <td colspan="8" style="text-align:right;font-weight:bold">Toplam:</td>
            <td style="text-align:right;font-weight:bold">${formatNumber(total)}</td>
          </tr>
        </tfoot>
      </table>
    `;

    // sadece kendi konteyner'ına
    const rpt = document.getElementById('stockReportContainer');
    rpt.style.display = 'block';
    rpt.innerHTML = html;

    // ana ürün-container'ı gizle
    document.getElementById('product-container').style.display = 'none';
  } catch (err) {
    console.error(err);
    alert('Rapor yüklenirken hata oluştu.');
  }
}

function exportStockToExcel() {
  if (!lastStockData.length) {
    return alert('Önce “Getir” ile raporu yükleyin.');
  }
  // başlık + filtre bilgisi
  const aoa = [];
  aoa.push(['Tarih', lastDate, '', 'Depo', lastDepo]);
  aoa.push([]);

  // sütun başlıkları
  aoa.push([
    'BASAMAK1','BASAMAK2','BASAMAK3','BASAMAK4','BASAMAK5',
    'KOD','ADI','BİRİM','MIKTAR'
  ]);

  // veri satırları
  lastStockData.forEach(r => {
    aoa.push([
      r.BASAMAK1||'', r.BASAMAK2||'', r.BASAMAK3||'', r.BASAMAK4||'', r.BASAMAK5||'',
      r.KOD, r.ADI, r.BRM, r.MIKTAR
    ]);
  });

  // alt toplam
  const total = lastStockData.reduce((s,r) => s + (r.MIKTAR||0), 0);
  aoa.push([]);
  aoa.push(['','','','','','','','Toplam', total]);

  // Sheet + Workbook
  const ws = XLSX.utils.aoa_to_sheet(aoa);
  const wb = XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(wb, ws, 'StokDepoDurum');
  XLSX.writeFile(wb, `StokDepoDurum_${lastDepo}_${lastDate}.xlsx`);
}




</script>

<!-- Karşılaştırma Butonu (Sabit Ekran Altında) -->
<div id="compareFooter" style="display: none; position: fixed; bottom: 0; width: 100%; background: #333; color: white; padding: 10px; text-align: center; z-index: 1000;">
    <button class="btn btn-warning" onclick="openCompareModal()">
        <i class="fas fa-exchange-alt"></i> Ürünleri Karşılaştır (<span id="compareCount">0</span>)
    </button>
</div>

<!-- Sayfanın Footer Bölümü 
<footer style="text-align: center; padding: 10px; background: #222; color: white; margin-top: -35px;">
    <p>© 2025 Tüm Hakları Saklıdır.</p>
</footer>-->

	</body>
	</html>